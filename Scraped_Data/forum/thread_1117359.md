---
title: Thread-1117359
url: https://forum.mikrotik.com/viewtopic.php?p=1117359&sid=49f92a630bc7970d8ca50523be880e8f#p1117359
thread_id: 1117359
section: RouterOS
post_count: 24
date_crawled: 2025-02-03T21:15:50.013773
---

### Post 1
Author: Unknown
Date: Unknown

helloI have an IPsec tunnel set between a Sophos XG and a mikrotikconnection is established but no data is passingBoth devices have public ipsfirewall rules set on both devices but still nothingSophos engineers checked their side - all is goodwhat am i missing ?Code:Select all/interfacebridgeaddname=bridge-LAN port-cost-mode=short/interfaceethernetset[finddefault-name=ether1]mac-address=74:4D:28:A6:86:06name=ether1-WAN-MAIN-DSL-MODEMset[finddefault-name=ether2]mac-address=74:4D:28:A6:86:07set[finddefault-name=ether3]mac-address=74:4D:28:A6:86:08set[finddefault-name=ether4]mac-address=74:4D:28:A6:86:09set[finddefault-name=ether5]advertise=100M-baseT-half,100M-baseT-full,1G-baseT-half,1G-baseT-full mac-address=74:4D:28:A6:86:0Aset[finddefault-name=ether10]mac-address=74:4D:28:A6:86:0Bname=ether6set[finddefault-name=ether9]mac-address=74:4D:28:A6:86:0Cname=ether7set[finddefault-name=ether8]mac-address=74:4D:28:A6:86:0Dset[finddefault-name=ether7]mac-address=74:4D:28:A6:86:0Ename=ether9set[finddefault-name=ether6]mac-address=74:4D:28:A6:86:0Fname=ether10/interfacewireguardaddlisten-port=13231mtu=1380name=Mikrotik-Leb/interfaceethernetswitchportset5default-vlan-id=0set6default-vlan-id=0set7default-vlan-id=0set8default-vlan-id=0set9default-vlan-id=0/interfacelistaddcomment=defconf name=WANaddcomment=defconf name=LAN/interfacelte apnset[finddefault=yes]ip-type=ipv4use-network-apn=no/ip ipsec profileset[finddefault=yes]dpd-interval=2mdpd-maximum-failures=5adddh-group=modp2048 enc-algorithm=aes-256hash-algorithm=sha256 name=socitrans nat-traversal=no/ip ipsec peeraddaddress=xxx.xxx.xxx.78/32exchange-mode=ike2 name=socitrans-peer profile=socitrans/ip ipsec proposaladdauth-algorithms=sha512,sha256 enc-algorithms=aes-256-cbc,aes-256-ctr,aes-256-gcm name=socitrans-proposal pfs-group=modp2048/ip pooladdname=dhcp_pool0 ranges=192.168.1.112-192.168.1.199addname=dhcp_poolVPN ranges=192.168.251.2-192.168.251.254/ip dhcp-serveraddaddress-pool=dhcp_pool0interface=bridge-LAN name=dhcp1/ip smb usersset[finddefault=yes]disabled=yes/portset0name=serial0/ppp profileset*0only-one=noadddns-server=192.168.1.1local-address=dhcp_pool0 name=profile1 only-one=noremote-address=dhcp_poolVPN/routing bgptemplatesetdefaultdisabled=nooutput.network=bgp-networks/routing ospf instanceadddisabled=noname=default-v2/routing ospf areaadddisabled=yes instance=default-v2 name=backbone-v2/system logging actionset0memory-lines=1111set1disk-lines-per-file=11111/interfacebridge portaddbridge=bridge-LANinterface=ether2addbridge=bridge-LANinterface=ether3addbridge=bridge-LANinterface=ether4addbridge=bridge-LANinterface=ether5addbridge=bridge-LANinterface=ether6addbridge=bridge-LANinterface=ether7addbridge=bridge-LANinterface=ether8addbridge=bridge-LANinterface=ether9addbridge=bridge-LANinterface=ether10addbridge=bridge-LANinterface=ether11addbridge=bridge-LANinterface=ether12addbridge=bridge-LANinterface=ether13/ip firewall connection trackingsetudp-timeout=10s/ip neighbor discovery-settingssetdiscover-interface-list=all/ip settingssetmax-neighbor-entries=8192/ipv6 settingssetforward=nomax-neighbor-entries=8192/interfacel2tp-server serversetdefault-profile=profile1 enabled=yes keepalive-timeout=60max-mru=1400max-mtu=1400mrru=1600use-ipsec=yes/interfacelist memberaddcomment=defconfinterface=bridge-LAN list=LANaddcomment=defconfinterface=ether1-WAN-MAIN-DSL-MODEM list=WAN/interfaceovpn-server serversetauth=sha1,md5/interfacewireguard peersaddallowed-address=192.168.120.0/24,10.125.100.0/24,192.168.1.0/24,192.168.130.0/24comment=DRC endpoint-address=xxx.xxx.xxx.186endpoint-port=13231interface=Mikrotik-Lebis-responder=yes name=peer1 persistent-keepalive=10spublic-key=\/ip addressaddaddress=192.168.1.111/24interface=bridge-LAN network=192.168.1.0addaddress=yyy.yyy.yyy174/29interface=ether1-WAN-MAIN-DSL-MODEM network=yyy.yyy.yyy168addaddress=10.125.100.101/24interface=Mikrotik-Lebnetwork=10.125.100.0/ip arpaddaddress=192.168.1.112interface=bridge-LAN mac-address=00:45:E2:F6:AB:D7/ip dhcp-clientadddisabled=yesinterface=bridge-LAN/ip dhcp-server networkaddaddress=192.168.1.0/24dns-server=192.168.1.1gateway=192.168.1.111/ip dnssetallow-remote-requests=yes servers=xxxxxxxx/ip dnsstaticaddaddress=192.168.88.1name=router.lan type=A/ip firefirewall filteraddaction=accept chain=forward dst-address=192.168.1.0/24src-address=192.168.120.0/24addaction=accept chain=forward dst-address=192.168.1.0/24src-address=192.168.140.0/24addaction=accept chain=forward dst-address=192.168.120.0/24src-address=192.168.1.0/24addaction=accept chain=forward dst-address=192.168.140.0/24src-address=192.168.1.0/24addaction=drop chain=forward comment="drop NVR "disabled=yes dst-address=192.168.1.10addaction=accept chain=input protocol=ipsec-espaddaction=accept chain=input protocol=udp src-port=4500/ip firewall nataddaction=src-nat chain=srcnatout-interface=ether1-WAN-MAIN-DSL-MODEM to-addresses=yyy.yyy.yyy174addaction=accept chain=srcnat disabled=yes dst-address=192.168.140.0/24log=yes src-address=192.168.1.0/24to-addresses=yyy.yyy.yyy174/ip ipsec identityaddpeer=socitrans-peer/ip ipsec policyadddst-address=192.168.140.0/24peer=socitrans-peer proposal=socitrans-proposal src-address=192.168.1.0/24tunnel=yes/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=yyy.yyy.yyy169adddisabled=nodst-address=192.168.120.0/24gateway=Mikrotik-Lebrouting-table=main suppress-hw-offload=no

---
### Post 2
Author: Unknown
Date: Unknown

Maybe it's the first NAT rule that is src-natting before a packet gets encrypted, after which it cannot be encrypted because the src-address mismatches that of the policy:/ip firewall natadd action=src-nat chain=srcnat out-interface=ether1-WAN-MAIN-DSL-MODEMipsec-policy=out,noneto-addresses=yyy.yyy.yyy.174

---
### Post 3
Author: Unknown
Date: Unknown

i removed everything from NAT and used only your commandsame issue no ping whatsoever

---
### Post 4
Author: Unknown
Date: Unknown

Perhaps also a policy template is advisable alongside the tunnel one you've created which would be added to the identity:Code:Select all/ip ipsec policygroupaddname=socitrans-policy-group/ip ipsec policyaddgroup=socitrans-policy-groupproposal=socitrans-proposaltemplate=yes/ip ipsec identitysetpolicy-template-group=socitrans-policy-group

---
### Post 5
Author: Unknown
Date: Unknown

/ip firefirewall filteradd action=accept chain=forward dst-address=192.168.1.0/24 src-address=192.168.120.0/24add action=accept chain=forward dst-address=192.168.1.0/24 src-address=192.168.140.0/24add action=accept chain=forward dst-address=192.168.120.0/24 src-address=192.168.1.0/24add action=accept chain=forward dst-address=192.168.140.0/24 src-address=192.168.1.0/24add action=drop chain=forward comment="drop NVR " disabled=yes dst-address=192.168.1.10add action=accept chain=input protocol=ipsec-espadd action=accept chain=input protocol=udp src-port=4500/ip firewall nat[/code]Hello. The problem is on the Mikrotik side, because the correct traffic flow is not defined. There is no correct Input and Forward section. You only have forward rules defined, there is no initial stage Input chain. Traffic will work incorrectly. Rules are executed from top to bottom and the order also matters. And all this also affects the security of the router.INPUT CHAIN --> To the Router or to Router Services. Directional flow is WAN to Router, and LAN to Router.FORWARD CHAIN --> Through the Router. Direction flow is LAN to LAN, LAN to WAN, WAN to LAN.OUTPUT CHAIN --> From the Router. Directional flow is Router to WAN.Overall it looks like this -Code:Select all/ip firewall filteraddaction=accept chain=input comment="Allow Established,Related"\
    connection-state=established,related,untrackedaddaction=drop chain=input comment="drop invalid packets"connection-state=\
    invalidaddaction=accept chain=input comment="ICMP"addaction=accept chain=input comment="Allow DNS to local"dst-port=53\in-interface-list=LAN protocol=udpaddaction=accept chain=input comment="Allow DNS to local"dst-port=53\in-interface-list=LAN protocol=tcpaddaction=accept chain=input comment=L2TP dst-port=500,1701,4500protocol=udpaddaction=accept chain=input comment="IKE IPSec"protocol=ipsec-espaddaction=accept chain=inputin-interface-list=LANaddaction=drop chain=input comment="Drop all else"addaction=accept chain=forward comment="defconf: accept in ipsec policy"\
    ipsec-policy=in,ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"\
    ipsec-policy=out,ipsecaddaction=fasttrack-connection chain=forward comment=Fatsttrack\
    connection-state=established,related hw-offload=yesaddaction=accept chain=forward comment="Allow Established,Related"\
    connection-state=established,related,untrackedaddaction=drop chain=forward comment="Drop Invalid Connections"\
    connection-state=invalidaddaction=accept chain=forward comment="Access Internet From LAN"\in-interface-list=LANout-interface-list=WANaddaction=accept chain=forward comment=VPN dst-address-list=Local-LAN \
    src-address-list=VPNaddaction=accept chain=forward comment="allow port forwarding"\
    connection-nat-state=dstnataddaction=drop chain=forward comment="Drop everything else""example address.."/ip firewall address-listaddaddress=192.168.88.0/24list=Local-LANaddaddress=192.168.99.0/24list=VPN

---
### Post 6
Author: Unknown
Date: Unknown

Perhaps also a policy template is advisable alongside the tunnel one you've created which would be added to the identity:Code:Select all/ip ipsec policygroupaddname=socitrans-policy-group/ip ipsec policyaddgroup=socitrans-policy-groupproposal=socitrans-proposaltemplate=yes/ip ipsec identitysetpolicy-template-group=socitrans-policy-groupthis was already done before and is crucial for the ipsec tunnel connection successmy problem is not ipsec , it is either firewall or routing

---
### Post 7
Author: Unknown
Date: Unknown

Perhaps also a policy template is advisable alongside the tunnel one you've created which would be added to the identity:this was already done before and is crucial for the ipsec tunnel connection successIf you had to set up a template (which is missing in your original configuration export, so how was @TheCat supposed to know that), it means that either your own static policy that was present in the export is incompatible with the settings on the Sophos side (the traffic selector, the proposal, or both) or that the Sophos expects your end to only behave as a responder.So:post thecurrentconfiguration exportstart pinging some address in 192.168.140.0/24, specifyingsrc-address=192.168.1.111in order to make the packets match the traffic selector of the policy (without specifying the source address, the router uses the one of the out-interface through which the gateway is reachable, i.e. the WAN one in your case)post the output of/ip ipsec policy print detailpost the output of/ip ipsec installed-sa print detailwhile the ping is still runningNo need to obfuscate the keys, they are short-lived, but of course don't forget to obfuscate the public addresses, just do it systematically so that each unique public address looks the same at all places and remains unique.Besides, you should take seriously what @johnson73 wrote - as the default action in firewall, which is taken if the packet did not match any rule, isaccept, your firewall rules as they look in the original export are useless - what they do not accept gets accepted anyway by default.my problem is not ipsec , it is either firewall or routingAt this stage, such a conclusion is premature.

---
### Post 8
Author: Unknown
Date: Unknown

/ip firefirewall filteradd action=accept chain=forward dst-address=192.168.1.0/24 src-address=192.168.120.0/24add action=accept chain=forward dst-address=192.168.1.0/24 src-address=192.168.140.0/24add action=accept chain=forward dst-address=192.168.120.0/24 src-address=192.168.1.0/24add action=accept chain=forward dst-address=192.168.140.0/24 src-address=192.168.1.0/24add action=drop chain=forward comment="drop NVR " disabled=yes dst-address=192.168.1.10add action=accept chain=input protocol=ipsec-espadd action=accept chain=input protocol=udp src-port=4500/ip firewall nat[/code]Hello. The problem is on the Mikrotik side, because the correct traffic flow is not defined. There is no correct Input and Forward section. You only have forward rules defined, there is no initial stage Input chain. Traffic will work incorrectly. Rules are executed from top to bottom and the order also matters. And all this also affects the security of the router.INPUT CHAIN --> To the Router or to Router Services. Directional flow is WAN to Router, and LAN to Router.FORWARD CHAIN --> Through the Router. Direction flow is LAN to LAN, LAN to WAN, WAN to LAN.OUTPUT CHAIN --> From the Router. Directional flow is Router to WAN.Overall it looks like this -Code:Select all/ip firewall filteraddaction=accept chain=input comment="Allow Established,Related"\
    connection-state=established,related,untrackedaddaction=drop chain=input comment="drop invalid packets"connection-state=\
    invalidaddaction=accept chain=input comment="ICMP"addaction=accept chain=input comment="Allow DNS to local"dst-port=53\in-interface-list=LAN protocol=udpaddaction=accept chain=input comment="Allow DNS to local"dst-port=53\in-interface-list=LAN protocol=tcpaddaction=accept chain=input comment=L2TP dst-port=500,1701,4500protocol=udpaddaction=accept chain=input comment="IKE IPSec"protocol=ipsec-espaddaction=accept chain=inputin-interface-list=LANaddaction=drop chain=input comment="Drop all else"addaction=accept chain=forward comment="defconf: accept in ipsec policy"\
    ipsec-policy=in,ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"\
    ipsec-policy=out,ipsecaddaction=fasttrack-connection chain=forward comment=Fatsttrack\
    connection-state=established,related hw-offload=yesaddaction=accept chain=forward comment="Allow Established,Related"\
    connection-state=established,related,untrackedaddaction=drop chain=forward comment="Drop Invalid Connections"\
    connection-state=invalidaddaction=accept chain=forward comment="Access Internet From LAN"\in-interface-list=LANout-interface-list=WANaddaction=accept chain=forward comment=VPN dst-address-list=Local-LAN \
    src-address-list=VPNaddaction=accept chain=forward comment="allow port forwarding"\
    connection-nat-state=dstnataddaction=drop chain=forward comment="Drop everything else""example address.."/ip firewall address-listaddaddress=192.168.88.0/24list=Local-LANaddaddress=192.168.99.0/24list=VPNdid not work - a tracert shows the ping arrives from a pc to the router (mikrotik) and then nothingthis is my current firewallCode:Select all/ip firewall address-listaddaddress=192.168.1.0/24list=LANaddaddress=192.168.140.0/24list=VPN/ip firewall connection trackingsetudp-timeout=10s/ip firewall filteraddaction=accept chain=forward dst-address=192.168.1.0/24src-address=192.168.120.0/24addaction=accept chain=forward dst-address=192.168.120.0/24src-address=192.168.1.0/24addaction=accept chain=input comment="Allow Established,Related"connection-state=established,related,untrackedaddaction=drop chain=input comment="drop invalid packets"connection-state=invalidaddaction=accept chain=input comment=ICMPaddaction=accept chain=input comment="Allow DNS to local"dst-port=53in-interface-list=LAN protocol=udpaddaction=accept chain=input comment="Allow DNS to local"dst-port=53in-interface-list=LAN protocol=tcpaddaction=accept chain=input comment=L2TP dst-port=500,1701,4500protocol=udpaddaction=accept chain=input comment="IKE IPSec"protocol=ipsec-espaddaction=accept chain=inputin-interface-list=LANaddaction=accept chain=forward comment="defconf: accept in ipsec policy"ipsec-policy=in,ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"ipsec-policy=out,ipsecaddaction=fasttrack-connection chain=forward comment=Fatsttrackconnection-state=established,related hw-offload=yesaddaction=accept chain=forward comment="Allow Established,Related"connection-state=established,related,untrackedaddaction=drop chain=forward comment="Drop Invalid Connections"connection-state=invalidaddaction=accept chain=forward comment=VPN dst-address-list=LAN src-address-list=VPNaddaction=accept chain=forward comment=VPN dst-address-list=VPN src-address-list=LANaddaction=accept chain=forward comment="allow port forwarding"connection-nat-state=dstnat/ip firewall nataddaction=src-nat chain=srcnat ipsec-policy=out,noneout-interface=ether1-WAN-MAIN-DSL-MODEM to-addresses=yyy.yyy.yyy.174

---
### Post 9
Author: Unknown
Date: Unknown

this was already done before and is crucial for the ipsec tunnel connection successIf you had to set up a template (which is missing in your original configuration export, so how was @TheCat supposed to know that), it means that either your own static policy that was present in the export is incompatible with the settings on the Sophos side (the traffic selector, the proposal, or both) or that the Sophos expects your end to only behave as a responder.So:post thecurrentconfiguration exportstart pinging some address in 192.168.140.0/24, specifyingsrc-address=192.168.1.111in order to make the packets match the traffic selector of the policy (without specifying the source address, the router uses the one of the out-interface through which the gateway is reachable, i.e. the WAN one in your case)post the output of/ip ipsec policy print detailpost the output of/ip ipsec installed-sa print detailwhile the ping is still runningNo need to obfuscate the keys, they are short-lived, but of course don't forget to obfuscate the public addresses, just do it systematically so that each unique public address looks the same at all places and remains unique.Besides, you should take seriously what @johnson73 wrote - as the default action in firewall, which is taken if the packet did not match any rule, isaccept, your firewall rules as they look in the original export are useless - what they do not accept gets accepted anyway by default.my problem is not ipsec , it is either firewall or routingAt this stage, such a conclusion is premature.it is the current config - i reposted the IPSEC section for better clarityipsec is active, maybe i need to route something ?!Code:Select all/ip ipsec policygroupaddname=socitrans/ip ipsec profileset[finddefault=yes]dpd-interval=2mdpd-maximum-failures=5adddh-group=modp2048 enc-algorithm=aes-256hash-algorithm=sha256 name=socitrans nat-traversal=no/ip ipsec peeraddaddress=xxx.xxx.xxx.78/32exchange-mode=ike2 name=socitrans-peer profile=socitrans/ip ipsec proposaladdauth-algorithms=sha512,sha256 enc-algorithms=aes-256-cbc,aes-256-ctr,aes-256-gcm name=socitrans-proposal pfs-group=modp2048/ip ipsec identityaddpeer=socitrans-peer/ip ipsec policyadddst-address=192.168.140.0/24peer=socitrans-peer proposal=socitrans-proposal src-address=192.168.1.0/24tunnel=yes

---
### Post 10
Author: Unknown
Date: Unknown

Where did you get the last rule in the forward section that drops everything? Drop?? And also input? That's not correct.First we need to have correct traffic rolls and then we can look further at the route and the rest. Was there a restart after the FW rule changes?

---
### Post 11
Author: Unknown
Date: Unknown

Where did you get the last rule in the forward section that drops everything? Drop?? And also input? That's not correct.rule 15 is drop invalid connectioni removed the last drop rule as i am working remotely , couldnt risk being disconnected tooi dont think drop will affect the ipsec connection no ?

---
### Post 12
Author: Unknown
Date: Unknown

The configuration in the original post does not configure the policytemplateyou declare to be present in response to the suggestion of @TheCat12. So one of those must be wrong - either you actually did not add the template and misunderstood @TheCat12's suggestion to add atemplatefor a plain static policy you already had, or the export in the OP is not the current one.If you came here for assistance, you have to cooperate - I gave you diagnostic step to perform.If you came to quarrel, I'm fine with that too, but I won't participate.

---
### Post 13
Author: Unknown
Date: Unknown

Where did you get the last rule in the forward section that drops everything? Drop?? And also input? That's not correct.rule 15 is drop invalid connectioni removed the last drop rule as i am working remotely , couldnt risk being disconnected tooi dont think drop will affect the ipsec connection no ?of course if you make changes, you will need to restart, there will be a disconnect.Firewall entries must be correct for everything to work stably. If you modify the entries, then it will affect the operation.For incoming traffic that is in the ''Input'' chain, the last entry will always be ''drop all'' and the ''forward'' chain the last entry will also be ''drop-all''. This means that all defined rules are executed and everything else that is not defined is ''dropped''. That is correct.If after all this it does not work for you, then you need to check whether you have defined the address-list entries correctly. Then the ipsec entries..

---
### Post 14
Author: Unknown
Date: Unknown

The configuration in the original post does not configure the policytemplateyou declare to be present in response to the suggestion of @TheCat12. So one of those must be wrong - either you actually did not add the template and misunderstood @TheCat12's suggestion to add atemplatefor a plain static policy you already had, or the export in the OP is not the current one.If you came here for assistance, you have to cooperate - I gave you diagnostic step to perform.If you came to quarrel, I'm fine with that too, but I won't participate.Happy new year , you seem to be in a bad moodi reposted the ipsec config - are these what u r talking about ? or am i still missing something else ?

---
### Post 15
Author: Unknown
Date: Unknown

you seem to be in a bad moodThat's the state of my mind most of the time, nothing to worry about.i reposted the ipsec config - are these what u r talking about ? or am i still missing something else ?I gave you an itemized list of the steps aimed to check what is actually going onhere. More may be needed depending on the outcome.exportshows the manually created configuration,printshows the actual outcome, including dynamically created objects thatexportcannot show by design.The export of IPsec you have added into the post above confirms that you did not actually use a template as @TheCat12 suggested - it may not be wrong as such, it just indicates you need to slow down and concentrate

---
### Post 16
Author: Unknown
Date: Unknown

rule 15 is drop invalid connectioni removed the last drop rule as i am working remotely , couldnt risk being disconnected tooi dont think drop will affect the ipsec connection no ?of course if you make changes, you will need to restart, there will be a disconnect.Firewall entries must be correct for everything to work stably. If you modify the entries, then it will affect the operation.For incoming traffic that is in the ''Input'' chain, the last entry will always be ''drop all'' and the ''forward'' chain the last entry will also be ''drop-all''. This means that all defined rules are executed and everything else that is not defined is ''dropped''. That is correct.If after all this it does not work for you, then you need to check whether you have defined the address-list entries correctly. Then the ipsec entries..i rebooted everything - still same thing .. according to the KB i just have to forward the lan subnets from remote to local and from local to remote

---
### Post 17
Author: Unknown
Date: Unknown

this was already done before and is crucial for the ipsec tunnel connection successIf you had to set up a template (which is missing in your original configuration export, so how was @TheCat supposed to know that), it means that either your own static policy that was present in the export is incompatible with the settings on the Sophos side (the traffic selector, the proposal, or both) or that the Sophos expects your end to only behave as a responder.So:post thecurrentconfiguration exportstart pinging some address in 192.168.140.0/24, specifyingsrc-address=192.168.1.111in order to make the packets match the traffic selector of the policy (without specifying the source address, the router uses the one of the out-interface through which the gateway is reachable, i.e. the WAN one in your case)post the output of/ip ipsec policy print detailpost the output of/ip ipsec installed-sa print detailwhile the ping is still runningNo need to obfuscate the keys, they are short-lived, but of course don't forget to obfuscate the public addresses, just do it systematically so that each unique public address looks the same at all places and remains unique.Besides, you should take seriously what @johnson73 wrote - as the default action in firewall, which is taken if the packet did not match any rule, isaccept, your firewall rules as they look in the original export are useless - what they do not accept gets accepted anyway by default.my problem is not ipsec , it is either firewall or routingAt this stage, such a conclusion is premature.while pinging as you advisedCode:Select all[admin@RB1100-Tradium]>/ip ipsec policyprintdetailFlags:T-template;B-backup;X-disabled,D-dynamic,I-invalid,A-active;*-default0A  peer=socitrans-peer tunnel=yes src-address=192.168.1.0/24src-port=any dst-address=192.168.140.0/24dst-port=any protocol=all action=encrypt level=requireipsec-protocols=esp sa-src-address=yyy.yyy.yyy.174sa-dst-address=xxx.xxx.xxx.78proposal=socitrans-proposal ph2-count=1ph2-state=established1T*group=defaultsrc-address=::/0 dst-address=::/0protocol=all proposal=defaulttemplate=yes[admin@RB1100-Tradium]>/ip ipsec installed-saprintdetailFlags:S-seen-traffic;H-hw-aead;A-AH,E-ESP0HE spi=0xAE15DFCsrc-address=xxx.xxx.xxx.78dst-address=yyy.yyy.yyy.174state=mature auth-algorithm=sha512 enc-algorithm=aes-cbc enc-key-size=256auth-key="593b6e816fc6049db7b8d2c19d974de71078cada165aa34086b837da46f404abbf35febce66210d6585e667b46811cdcc4297a0aeb3471e4a7f8bdcd8c5afae5"enc-key="d5a740114d7022467b7200deb59c9c561c08a3e150cc892d608253cf40dbddd6"add-lifetime=24m22s/30m28sreplay=1281SHE spi=0xC32C2CC7src-address=yyy.yyy.yyy.174dst-address=xxx.xxx.xxx.78state=mature auth-algorithm=sha512 enc-algorithm=aes-cbc enc-key-size=256auth-key="7c2d5a5535238e9933fea2a243247c9fb90f3609463ef046054e16cfc872caf60e4fe62329ede5be1605a3e4b96ae4e1a87ad5ff7dec453e83f3b7f1701d9efb"enc-key="45ae398837a52cc4d74631ef3f159d3e72f2f04a6bcc6788e4e85027c6c1e32e"addtime=2025-01-0214:55:43expires-in=19m50sadd-lifetime=24m22s/30m28scurrent-bytes=12176current-packets=161replay=128[admin@RB1100-Tradium]>

---
### Post 18
Author: Unknown
Date: Unknown

OK. According to your configuration export, xxx.xxx.xxx.78 is the Sophos and yyy.yyy.yyy.174 is your Tik. The/ip ipsec installed-sa print detailshows that the security association from the Tik to the Sophos does carry traffic (there is theSindicator in the leftmost column, and there are thecurrent-bytes=12176andcurrent-packets=161values), whereas the one in the opposite direction is totally silent. So the device you ping at the Sophos side may not be responding (Windows devices by default ignore ping requests that do not come from the local subnet), or the Sophos may even not accept the incoming encrypted pings, or the routing of the responses is wrong.So it may be a routing issue or a firewall one, but not on the Mikrotik side.The firewall needs to be sorted out as well - I understand your concerns regarding losing remote access, but leaving the management of the device accessible from the whole internet is not the way to go.

---
### Post 19
Author: Unknown
Date: Unknown

OK. According to your configuration export, xxx.xxx.xxx.78 is the Sophos and yyy.yyy.yyy.174 is your Tik. The/ip ipsec installed-sa print detailshows that the security association from the Tik to the Sophos does carry traffic (there is theSindicator in the leftmost column, and there are thecurrent-bytes=12176andcurrent-packets=161values), whereas the one in the opposite direction is totally silent. So the device you ping at the Sophos side may not be responding (Windows devices by default ignore ping requests that do not come from the local subnet), or the Sophos may even not accept the incoming encrypted pings, or the routing of the responses is wrong.So it may be a routing issue or a firewall one, but not on the Mikrotik side.The firewall needs to be sorted out as well - I understand your concerns regarding losing remote access, but leaving the management of the device accessible from the whole internet is not the way to go.i understand , time to recheck with sophos thenthe thing is i can ping from sophos to mikrotik

---
### Post 20
Author: Unknown
Date: Unknown

so i dont know what happenedi am now able to ping the sophos from behind the mikrotik and from the sophos itself to the mikrotik but not behind the sophosi think i need a route on the sophos end or another firewalll ruleyou guys are awesome

---
### Post 21
Author: Unknown
Date: Unknown

the thing is i can ping from sophos to mikrotikWhen you do that, you should see both the installed-sa to count packets and bytes; if the pings from the Sophos are the only traffic and you run/ip ipsec installed-sa print detailinterval=1s, you should see thepacketcounters in both directions to grow by one every second.The behavior where one side can ping the other but not vice versa is a normal one for stateful firewalls - whether the packet between two addresses will pass through or not depends on which party has initiated that connection. The typical behavior is that a firewall allows connections that an "inside" client establishes towards "outside" servers (aka outbound connections), but not inbound ones. It is also normal that a VPN tunnel from a business partner is considered an "external" domain too, hence firewall rules are still applied to policy where the partner is allowed to connect and where not.so i dont know what happenedi am now able to ping the sophos from behind the mikrotikThis suggests yet another possibility - since both the IPsec peers use public addresses, the SA transport packets are bare ESP ones. If all you need to make pings from Mikrotik side to Sophos side succeed is to ping from the Sophos side to the Mikrotik one first, it means that the firewall at Sophos side only accepts ESP from addresses to which it has itself sent an ESP packet before.As for your remote access to management of the Tik - am I right to assume you access the router via the Wireguard tunnel? Or do you connect directly to the yyy.yyy.yyy.174 address using Winbox?

---
### Post 22
Author: Unknown
Date: Unknown

so i dont know what happenedi am now able to ping the sophos from behind the mikrotik and from the sophos itself to the mikrotik but not behind the sophosi think i need a route on the sophos end or another firewalll ruleIf everything is ok with your firewall rules (as in my example), then look at what is happening with the NAT section.When creating a tunnel with a ''other'' router, we create a standard masquerade for our subnet and if necessary, create an additional masquerade for the other subnet (for example, video or other).Srcnat addresses must be above Masquarade, otherwise the rules policy will work incorrectly. Srcnat will be your IP subnets and Dstnat will be Sophos remote subnets.Then add the Sophos subnet to the ''Route list'' and specify the output (Wan). You need to pay attention to the ''DH Group''. In my case, the connection is to the Fortigate FW, yours will probably be similar. The DH on both sides must match.I have created many tunnels this way and have no problems. In my case, the Mikrotik version everywhere is 7.16.2 I don't know what version you have.Of course, there is always the possibility of running Wireguard

---
### Post 23
Author: Unknown
Date: Unknown

Sorry guys im in congo and power is not always present1 - yes i access the router via wireguard2- made the sophos initiate the connection and reduces all the encryption and authentication to AES256 and SHA256 and DH2048 only (i also removed all static routes from or to the mikrotik 192.168.1.0/24)3 - I only used these firewall rules - but disabling the nat didnt affect the networkCode:Select alladdaction=accept chain=forward connection-state=established,related dst-address=192.168.1.0/24src-address=192.168.140.0/24addaction=accept chain=forward connection-state=established,related dst-address=192.168.140.0/24src-address=192.168.1.0/24addaction=accept chain=srcnat dst-address=192.168.140.0/24src-address=192.168.1.0/24

---
### Post 24
Author: Unknown
Date: Unknown

The description below only deals with Wireguard and SSH/Winbox, and is aimed to illustrate how the firewall works. So you need to adjust it to your actual environment and add whatever additional accept rules are necessary for other things (like the IPsec) to work before applying the last steps. The best would be to experiment with this on a router that is on your table before using it on the one half a globe away, but it is designed in such a way that it was reasonably safe even in the latter case.If you manage the router using Wireguard, what you have to ensure is thatthe Wireguard transport packets are accepted inip firewall filterif they arrive to the public address and listen-port via the WAN interface (example:chain=input in-interface-list=WAN protocol=udp dst-port=13231 action=accept)the wireguard transport packets the router itself sends are accepted inip firewall filter(this is typically ahieved by doing nothing, as there are usually no rules in filter chainoutputthat handles them, I just mention it to make the picture complete)the management packets for the router itself that come in via the Wireguard tunnel from the proper sourec address are accepted (example:chain=input in-interface=wg-1 src-address=wireguard.address.of.your.laptop protocol=tcp dst-port=22,8291 action=accept- this will allow SSH and Winbox connections (if these services listen on their default ports)the response packets the router sends are accepted (again, unless you have some reasons to add rules to filter/output, ths is done by default)Once you add those rules, you can check that they actually work without losing access - if you look at them in Winbox/WebFig or you use/ip firewall filter print statswhile connected using Winbox via Wireguard, you must see the byte and packet counters of those rules to grow. If they do, it is time to add another rule,chain=input connection-state=established,related action=acceptto the very beginning (top) of theinputchain infilter. This rule will handle both the Wireguard transport packets and the Winbox/SSH ones that belong to already existing connections, so the "wireguard" one will only count a single packet when you re-connect Wireguard from a new address or after more than 3 minutes and the "winbox/ssh" one will only count a single packet when you initiate a new connection (you can have multiple Winbox connections at the same time). The actual purpose of that "accept established or related" rule is to accept answers to requests the router itself has sent, like DNS queries or time updates.Once that is done, you can add achain=input action=passthrough comment=abc123rule to the very end (bottom) of theinputchain infilter. Next, add a scheduler item:/system/scheduler/add start-time=hh:mm:ss name=recover on-event={/ip firewall filter disable [find comment=abc123]}, settinghh:mm:ssto 5 minutes in future. After those 5 minutes, you should see the run counter of the scheduler to show 1 and the rule to be disabled. If this the case, you can change thestart-timeagain to 10 minutes in future, change theactionof the rule frompassthroughtodrop, and disconnect Winbox and then Wireguard for 5 minutes. After 5 minutes, connect Wireguard and Wireshark again, it should go without issues. If not, wait another 5 minutes and the scheduler will disable the drop rule so you can start looking what is wrong.

---
