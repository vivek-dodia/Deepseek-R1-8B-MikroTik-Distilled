---
title: Untitled Thread
source_url: https://forum.mikrotik.com/viewtopic.php?f=2&t=213972&p=1119783&amp;sid=3b77a3334c914448dbbc02bfdff4c3aa#p1119783
crawled_date: 2025-02-02T21:56:38.542814
section: mikrotik_forum
type: forum_thread
keywords: script, firewall, nat, mangle, ppp, pppoe, dhcp, dns, routing, route, configuration, setup, routeros
---

### Author: Fri Jan 17, 2025 8:29 pm
Date: Unknown

```
/interfaceethernetset[finddefault-name=ether1]name=out1set[finddefault-name=ether2]name=out2set[finddefault-name=ether5]name=wan1set[finddefault-name=ether6]name=wan2/interfacelistaddname=LAN/interfacelist memberaddinterface=out1 list=LANaddinterface=out2 list=LAN/ip pooladdname=dhcp_pool0 ranges=172.16.0.2-172.16.0.254/ip dhcp-serveraddaddress-pool=dhcp_pool0interface=out2 name=dhcp1/routing tableaddfib name=to-wan1addfib name=to-wan2/ip addressaddaddress=172.16.0.1/24interface=out2 network=172.16.0.0/ip dhcp-server networkaddaddress=172.16.0.0/24dns-server=192.168.8.1gateway=172.16.0.1/ip dnssetcache-size=20480KiBmax-concurrent-queries=200\
    max-concurrent-tcp-sessions=50/ip firewall address-listaddaddress=192.168.0.0/16list=LOCAL-IPaddaddress=172.16.0.0/12list=LOCAL-IPaddaddress=10.0.0.0/8list=LOCAL-IP/ip firewall mangleaddaction=mark-connection chain=inputin-interface=wan1new-connection-mark=\
    cm-wan1 passthrough=yesaddaction=mark-connection chain=inputin-interface=wan2new-connection-mark=\
    cm-wan2 passthrough=yesaddaction=mark-connection chain=prerouting dst-address-type=!local\in-interface-list=LANnew-connection-mark=cm-wan1 passthrough=yes \
    per-connection-classifier=both-addresses-and-ports:2/0addaction=mark-connection chain=prerouting dst-address-type=!local\in-interface-list=LANnew-connection-mark=cm-wan2 passthrough=yes \
    per-connection-classifier=both-addresses-and-ports:2/1addaction=mark-routing chain=prerouting connection-mark=cm-wan1 \in-interface-list=LANnew-routing-mark=to-wan1 packet-mark=""\
    passthrough=yesaddaction=mark-routing chain=prerouting connection-mark=cm-wan2 \in-interface-list=LANnew-routing-mark=to-wan2 passthrough=yesaddaction=mark-routing chain=output connection-mark=cm-wan1 \new-routing-mark=to-wan1 passthrough=yesaddaction=mark-routing chain=output connection-mark=cm-wan2 \new-routing-mark=to-wan2 passthrough=yes/ip firewall nataddaction=masquerade chain=srcnatout-interface=pppoe-out1addaction=masquerade chain=srcnatout-interface=pppoe-out2/ip routeaddcheck-gateway=ping distance=1gateway=pppoe-out1 routing-table=to-wan1addcheck-gateway=ping distance=1gateway=pppoe-out2 routing-table=to-wan2
```

Hello dear all.. the Mikrtotik loversI've been using Mikrotik and RouterOS for quite some years now.I've always load-balanced 2 lines (ISPs) up to 5 lines together using almost same configurations, same script, both in RouterOS v6 and v7.Recently, I did setup a router with 2 (PPPoE), but the traffic keeps going to one line, ignoring the route-mark.Here is basic configurations export:Code:Select allHelp is more than appreciated..!!


---
### Author: [SOLVED]Fri Jan 17, 2025 10:09 pm
Date: Unknown

You have only posted the part of the configuration youassumeto be related. However, in most cases, the issue you cannot find is typically caused by some part of the configuration you don't expect to be related but it actually is.But even in this restricted configuration, I can see two mistakes:on the two /ip route rows you did post, thegatewayset to interface name (which is perfectly OK since the interfaces are L3 ones) andcheck-gatewayis set toping, which would be allright too if thegatewaywas set to an IP address but it is wrong in this case where thegatewayis an interface. Since RouterOS developers did not anticipate such a misconfiguration, thecheck-gatewayresult is "fail" and the routes are not eligible. As a consequence, the traffic falls back to routing tablemain, in which one of the routes probably has a higher priority (lower value ofdistance) so it gets all the traffic.you assign theconnection-markvaluses based onin-interface, but from the point of view of the firewall, the WAN interfaces arepppoe-out1andpppoe-out2, not the Ethernet ports they are attached to.


---
### Author: Sat Jan 18, 2025 1:48 am
Date: Unknown

You have only posted the part of the configuration youassumeto be related. However, in most cases, the issue you cannot find is typically caused by some part of the configuration you don't expect to be related but it actually is.Well, indeed.. that was all about it. I removed very other basic stuff like, router identity... etc!But even in this restricted configuration, I can see two mistakes:on the two /ip route rows you did post, thegatewayset to interface name (which is perfectly OK since the interfaces are L3 ones) andcheck-gatewayis set toping, which would be allright too if thegatewaywas set to an IP address but it is wrong in this case where thegatewayis an interface. Since RouterOS developers did not anticipate such a misconfiguration, thecheck-gatewayresult is "fail" and the routes are not eligible. As a consequence, the traffic falls back to routing tablemain, in which one of the routes probably has a higher priority (lower value ofdistance) so it gets all the traffic.you assign theconnection-markvaluses based onin-interface, but from the point of view of the firewall, the WAN interfaces arepppoe-out1andpppoe-out2, not the Ethernet ports they are attached to.Thanks a ton! really thank you!Point one, that was really the mistake.. I little-bit altered the configuration from balancing 2 lines coming from regular IP routers, to PPPoE lines.Hence this piece of glitch was not dropped. Well, mistakes happenOnce I removed the check part, all went as expected.By the way.. what's the right way to check in case of PPPoE or Interface gateway?!Regarding the other point, it was a typo I made during post touch-up for easier readability.. but it was set right in the router.I repeat my gratitude..


---
### Author: Sat Jan 18, 2025 11:20 am
Date: Unknown

what's the right way to check in case of PPPoE or Interface gateway?!It depends on the particular situation.Like all the other PPP-based tunneling protocols, PPPoE is a stateful tunnel that uses keepalive messages to verify availability of the remote endpoint if no payload traffic is present, so if the connection to your ISP fails for whatever reason (disconnected Ethernet cable at your end, DSL/optical line broken due to ground works in the street, power outage at the ISP, ...), the pppoe-client interface becomes inactive so any routes that use it become ineligible too. So if all your uplink connections are provided by the same RAS at the same ISP, there is no point in checking anything else, because the path from your router to the RAS is monitored by PPPoE itself and the path from that RAS to internet is common for both your uplinks.If your uplinks are provided by different ISPs operating their own hardware (in many countries, ISPs that are competitors on sales level actually share the infrastructure), or if you've got e.g. an LTE or satellite backup connection for critical traffic, it makes sense to verify the transparency of the path from the ISP to the internet, where "internet" is represented by some addresses that are known to be highly available, often called "canary" addresses (canaries are very sensitive to carbon monoxide so miners used them as biologic gas detectors before electronic ones got invented). You can use netwatch and scripts or the "recursive next hop search" approach to monitor those canary addresses and disable the default routes via affected uplinks. There are tons of topics about both these approaches here on the forum.

