---
title: Thread-1114823
url: https://forum.mikrotik.com/viewtopic.php?p=1114823#p1114823
thread_id: 1114823
section: RouterOS
post_count: 7
date_crawled: 2025-02-03T15:48:05.079507
---

### Post 1
Author: Unknown
Date: Unknown

I am trying to configure Hairpin NAT together with VLAN filtering but with no luck. Previousle without intervlan traffic I had "trusted" address list with all VLAN IP ranges added and it was working fine.Now I can't use the same approach because it will bypass intervlan traffic filtering. I've been trying to create a new address list and then a rule to allow the traffic from 192.168.10.2, 3, 4 IPs to domain.com:8006 and domainx.com:8007 pointing to external 217.x.x.x address (pppoe) forwarding to 192.168.20.11 and .20, but that didn't work either. What I am doing wrong?Code:Select all/interfacevlanaddinterface=bridge name=vlan10 vlan-id=10addinterface=bridge name=vlan20 vlan-id=20addinterface=bridge name=vlan30 vlan-id=30addinterface=bridge name=vlan40 vlan-id=40addinterface=bridge name=vlan50 vlan-id=50addinterface=bridge name=vlan60 vlan-id=60/interfacelistaddcomment=defconf name=WANaddcomment=defconf name=LAN/ip pooladdname=vlan10 ranges=192.168.10.10-192.168.10.254addname=vlan20 ranges=192.168.20.30-192.168.20.254addname=vlan30 ranges=192.168.30.50-192.168.30.254addname=vlan40 ranges=192.168.40.10-192.168.40.254addname=vlan50 ranges=192.168.50.10-192.168.50.254addname=vlan60 ranges=192.168.60.10-192.168.60.254/ip dhcp-serveraddaddress-pool=vlan60 authoritative=after-2sec-delayinterface=vlan60 lease-time=1dname=vlan60addaddress-pool=vlan50 authoritative=after-2sec-delayinterface=vlan50 lease-time=1dname=vlan50addaddress-pool=vlan40 authoritative=after-2sec-delayinterface=vlan40 lease-time=1dname=vlan40addaddress-pool=vlan30 authoritative=after-2sec-delayinterface=vlan30 lease-time=1dname=vlan30addaddress-pool=vlan20 authoritative=after-2sec-delayinterface=vlan20 lease-time=1dname=vlan20addaddress-pool=vlan10 authoritative=after-2sec-delayinterface=vlan10 lease-time=1dname=vlan10/interfacebridge portaddbridge=bridge comment=defconfinterface=ether2addbridge=bridge comment=defconfinterface=ether3addbridge=bridge comment=defconfinterface=ether4addbridge=bridge comment=defconfinterface=ether5addbridge=bridge comment=defconfinterface=sfp1/ip firewall connection trackingsetudp-timeout=10s/interfacebridge vlanaddbridge=bridge tagged=ether2,ether3,ether4,ether5,sfp1,bridge vlan-ids=10,20,30,40,50,60/interfacelist memberaddinterface=bridge list=LANaddinterface=ether1 list=WAN/ip addressaddaddress=172.16.0.1/24interface=wg-server network=172.16.0.0addaddress=192.168.102.2/24interface=wireguard-client-1network=192.168.102.0addaddress=10.0.1.2/24interface=wireguard-client-2network=10.0.1.0addaddress=10.159.50.3/24interface=wireguard-client-3network=10.159.50.0addaddress=217.x.x.x/29comment=publicinterface=vlan20 network=217.x.x.xaddaddress=192.168.10.1/24interface=vlan10 network=192.168.10.0addaddress=192.168.20.1/24interface=vlan20 network=192.168.20.0addaddress=192.168.30.1/24interface=vlan30 network=192.168.30.0addaddress=192.168.40.1/24interface=vlan40 network=192.168.40.0addaddress=192.168.50.1/24interface=vlan50 network=192.168.50.0addaddress=192.168.60.1/24interface=vlan60 network=192.168.60.0/ip dhcp-server networkaddaddress=192.168.10.0/24comment=vlan10 dns-server=192.168.20.15gateway=192.168.10.1addaddress=192.168.20.0/24comment=vlan20 dns-server=192.168.20.15gateway=192.168.20.1addaddress=192.168.30.0/24comment=vlan30 dns-server=192.168.20.15gateway=192.168.30.1addaddress=192.168.40.0/24comment=vlan40 dns-server=192.168.40.1gateway=192.168.40.1addaddress=192.168.50.0/24comment=vlan50 dns-server=192.168.50.1gateway=192.168.50.1addaddress=192.168.60.0/24comment=vlan60 dns-server=192.168.60.1gateway=192.168.60.1/ip firewall address-listaddaddress=46.x.x.x list=trustedaddaddress=46.x.x.x list=trustedaddaddress=193.x.x.x list=trustedaddaddress=31.x.x.x list=trustedaddaddress=46.x.x.x list=trustedaddaddress=192.168.10.0/24list=local-vlansaddaddress=192.168.20.0/24list=local-vlansaddaddress=192.168.30.0/24list=local-vlansaddaddress=192.168.40.0/24list=local-vlansaddaddress=192.168.50.0/24list=local-vlansaddaddress=192.168.60.0/24list=local-vlansaddaddress=192.168.20.15list=trusted-localaddaddress=192.168.30.13list=trusted-localaddaddress=192.168.10.2list=hairpin-accessaddaddress=192.168.10.3list=hairpin-accessaddaddress=192.168.10.4list=hairpin-accessaddaddress=192.168.13.15list=hairpin-access/ip firewall filteraddaction=accept chain=input comment="allow Wireguard server"dst-port=13231protocol=udpaddaction=accept chain=input comment="allow Wireguard server traffic"src-address=172.16.0.0/24addaction=accept chain=input comment="allow traffic from Wireguard vpn"dst-port=8443protocol=udpaddaction=fasttrack-connection chain=forward comment=fasttrack connection-state=established,related hw-offload=yesaddaction=accept chain=forward comment="accept established,related"connection-state=established,relatedaddaction=accept chain=input comment="echo reply"protocol=icmpaddaction=accept chain=input comment="accept established,related"connection-state=established,related,untrackedaddaction=drop chain=input comment="drop all not coming from LAN"disabled=yesin-interface-list=!LANaddaction=accept chain=forward comment="allow selected local resources to all VLANs"dst-address-list=local-vlans src-address-list=trusted-localaddaction=accept chain=forward comment="allow all VLANs to selected local resources"dst-address-list=trusted-localsrc-address-list=local-vlansaddaction=accept chain=forward comment="allow all traffic from VLAN10 to VLAN20"in-interface=vlan10out-interface=vlan20addaction=accept chain=forward comment="allow all traffic from VLAN20 to VLAN10"in-interface=vlan20out-interface=vlan10addaction=accept chain=forward comment="accept IN ipsec policy"ipsec-policy=in,ipsecaddaction=accept chain=forward comment="accept OUT ipsec policy"ipsec-policy=out,ipsecaddaction=drop chain=forward comment="drop interVLAN traffic"connection-state=""dst-address-list=local-vlans src-address-list=local-vlansaddaction=drop chain=forward comment="drop invalid - forward"connection-state=invalidaddaction=drop chain=forward comment="Drop all from WAN not DSTNATed"connection-nat-state=!dstnat connection-state=newin-interface=pppoe-out1addaction=drop chain=input comment="drop invalid - input"connection-state=""in-interface=pppoe-out1/ip firewall nataddaction=masquerade chain=srcnat comment="vlan10 masquerade"out-interface=pppoe-out1 src-address=192.168.10.0/24addaction=masquerade chain=srcnat comment="vlan20 masquerade"out-interface=pppoe-out1 src-address=192.168.20.0/24addaction=masquerade chain=srcnat comment="vlan30 masquerade"out-interface=pppoe-out1 src-address=192.168.30.0/24addaction=masquerade chain=srcnat comment="vlan40 masquerade"out-interface=pppoe-out1 src-address=192.168.40.0/24addaction=masquerade chain=srcnat comment="vlan50 masquerade"out-interface=pppoe-out1 src-address=192.168.50.0/24addaction=masquerade chain=srcnat comment="vlan60 masquerade"out-interface=pppoe-out1 src-address=192.168.60.0/24addaction=dst-nat chain=dstnat comment="Forward port 65000 to 192.168.20.4"disabled=yes dst-address=217.x.x.x dst-port=65000protocol=tcp src-address-list=trusted to-addresses=192.168.20.4to-ports=65000addaction=masquerade chain=srcnat comment="wg-server masquerade"out-interface=pppoe-out1 src-address=172.16.0.0/24addaction=masquerade chain=srcnat comment="wireguard client 1 masquerade"out-interface=wireguard-client-1addaction=masquerade chain=srcnat comment="wireguard client 3 masquerade"out-interface=wireguard-client-3addaction=masquerade chain=srcnat comment="wireguard client 2 masquerade"out-interface=wireguard-client-2addaction=dst-nat chain=dstnat comment="Forward port 443 to 192.168.20.16"dst-address=217.x.x.x dst-port=443protocol=tcp to-addresses=192.168.20.16to-ports=443addaction=dst-nat chain=dstnat comment="Forward port 8006 to 192.168.20.11"dst-address=217.x.x.x dst-port=8006protocol=tcp src-address-list=trusted to-addresses=192.168.20.11to-ports=8006addaction=dst-nat chain=dstnat comment="Forward port 8007 to 192.168.20.20"dst-address=217.x.x.x dst-port=8007protocol=tcp src-address-list=trusted to-addresses=192.168.20.20to-ports=8007addaction=masquerade chain=srcnat comment="HairpinNAT - 192.168.20.0/24"dst-address=192.168.20.0/24out-interface=vlan20 protocol=tcp src-address=192.168.20.0/24addaction=dst-nat chain=dstnat comment="HairpinNAT - 192.168.20.11 (pve)"dst-address=217.x.x.x dst-port=8006protocol=tcp src-address-list=trusted to-addresses=192.168.20.11to-ports=8006addaction=dst-nat chain=dstnat comment="HairpinNAT - 192.168.20.16 (Nginx)"dst-address=217.x.x.x dst-port=443protocol=tcp to-addresses=192.168.20.16to-ports=443addaction=dst-nat chain=dstnat comment="HairpinNAT - 192.168.20.20 (pbs)"dst-address=217.x.x.x dst-port=8007protocol=tcp src-address-list=trusted to-addresses=192.168.20.20to-ports=8007/ip routeadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=192.168.102.1routing-table=1suppress-hw-offload=yesadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=wireguard-client-1routing-table=1suppress-hw-offload=yesadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=wireguard-client-2routing-table=2suppress-hw-offload=yesadddisabled=yes distance=1dst-address=0.0.0.0/0gateway=10.0.1.1routing-table=2suppress-hw-offload=noadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=10.159.50.1routing-table=3suppress-hw-offload=yesadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=wireguard-client-3routing-table=3suppress-hw-offload=yes

---
### Post 2
Author: Unknown
Date: Unknown

/interface list memberadd interface=bridge list=LANadd interface=ether1 list=WANTO:/interface list memberadd interface=ether1 list=WANadd interface=vlan10 list=LANadd interface=vlan20 list=LANadd interface=vlan30 list=LANadd interface=vlan40 list=LANadd interface=vlan50 list=LANadd interface=vlan60 list=LANadd action=accept chain=input comment="allow Wireguard server" dst-port=13231protocol=udp{ missing space }T0:add action=accept chain=input comment="allow Wireguard server" dst-port=13231 protocol=udpWhy two handshake ports for VPN and yet four addresses for VPN?  It would appear that you have four,  but three are going out to third party vpn or something, so still begs the question why the second wg interface in input chain rules?Your two rules are very confusingyou allow one address on vlan20 and one address on vlan30 to access all local vlansthen you allow all local vlans to those two addresses??Why?  if the ideas is that those two addresses need that kind of access, fine,  but you should know that all the return traffic will be permitted.You do not need to make a firewall rule in the opposite direction.   The opposite rule is if traffic ORIGINATED on all local vlans to those two addresses, and my guess is that is NOT the case.No purpose to this rule......add action=drop chain=input comment="drop invalid - input" connection-state="" in-interface=pppoe-out1This rule is due to a backwards approach.....  get rid of it.add action=drop chain=forward comment="drop interVLAN traffic" connection-state="" dst-address-list=local-vlans src-address-list=local-vlansReplace the above rule, and this ruleadd action=drop chain=forward comment="Drop all from WAN not DSTNATed" connection-nat-state=!dstnat connection-state=new in-interface=pppoe-out1With the following;add action=accept chain=forward comment="internet traffic"  in-interface-list=LAN out-interface-list=WANadd action=accept chain=forward comment="port forwarding"  connection-nat-state=dstnatadd action=drop chain=forward comment="drop all else"Replace all masquerade rules with one!add action=masquerade chain=srcnat out-interface-list=WANWhat is the point of this rule?add action=masquerade chain=srcnat comment="wg-server masquerade" out-interface=pppoe-out1 src-address=172.16.0.0/24Edit: Okay so that remote users can use internet of router so they need to go out wan,  another option is allowingwg-serverto be a member of LAN list.No context, you have routes with routing table, but no defined mangles or routing rules, so its like 1/2 of an equation...........doesnt make sense???Also duplicate tables using interface name and gateway IP.....   why?

---
### Post 3
Author: Unknown
Date: Unknown

add action=accept chain=input comment="allow Wireguard server" dst-port=13231protocol=udp { missing space }copy/paste issue.Why two handshake ports for VPN and yet four addresses for VPN? It would appear that you have four, but three are going out to third party vpn or something, so still begs the question why the second wg interface in input chain rules?Not sure I am getting this right but I have WG server running on Mikrotik router and then three VPN site2site WG VPN links. All four togther using different address space and ports.Your two rules are very confusingyou allow one address on vlan20 and one address on vlan30 to access all local vlansthen you allow all local vlans to those two addresses??Why? if the ideas is that those two addresses need that kind of access, fine, but you should know that all the return traffic will be permitted.You do not need to make a firewall rule in the opposite direction. The opposite rule is if traffic ORIGINATED on all local vlans to those two addresses, and my guess is that is NOT the case.I allow all traffic between VLAN10 and VLAN20 on purpose and then all other VLANs to access 192.168.20.15 which is pi-hole in VLAN20 and 192.168.30.13 which is printer in VLAN30. Please see the images attached.add action=drop chain=input comment="drop invalid - input" connection-state="" in-interface=pppoe-out1Without that all Mikrotik services (api, winbox, ssh..) are open to the internet.add action=drop chain=forward comment="Drop all from WAN not DSTNATed" connection-nat-state=!dstnat connection-state=new in-interface=pppoe-out1I removed that earlier, it is blocking traffic to public IPs in LAN (I have /29 from my ISP and some hosts in VLAN20 using public IP directly)so how this:Replace the above rule, and this ruleadd action=drop chain=forward comment="Drop all from WAN not DSTNATed" connection-nat-state=!dstnat connection-state=new in-interface=pppoe-out1With the following;add action=accept chain=forward comment="internet traffic" in-interface-list=LAN out-interface-list=WANadd action=accept chain=forward comment="port forwarding" connection-nat-state=dstnatadd action=drop chain=forward comment="drop all else"is supposed to to fix Hairpin without breaking intervlan filteringhttps://ibb.co/JdJHjyzhttps://ibb.co/28BWg75https://ibb.co/5GmdPqB

---
### Post 4
Author: Unknown
Date: Unknown

I allow all traffic between VLAN10 and VLAN20 on purpose and then all other VLANs to access 192.168.20.15 which is pi-hole in VLAN20 and 192.168.30.13 which is printer in VLAN30. Please see the images attached.In this case, YOU ONLY need access from all devices to pi-hole and to printer not the other way around.The printer and pi-hole RESPOND to incoming, they dont originate traffic to devices........REMOVE:add action=accept chain=forward comment="allow selected local resources to all VLANs"dst-address-list=local-vlanssrc-address-list=trusted-localKEEP:add action=accept chain=forward comment="allow all VLANs to selected local resources"dst-address-list=trusted-localsrc-address-list=local-vlansYes this is weird, but its your config, if two vlans have full access to each other its a sign that you should combine them into one vlan, but as stated you probably have some logic.add action=accept chain=forward comment="allow all traffic from VLAN10 to VLAN20" in-interface=vlan10 out-interface=vlan20add action=accept chain=forward comment="allow all traffic from VLAN20 to VLAN10" in-interface=vlan20 out-interface=vlan10For wireguard understand, one wireguard for yourself ( remote admin to access config and subnets,  and maybe a few users to access lan )Three other wireguards connectiong to 3rd party VPN servers...........Therefore there should beFOUR wireguard interfaces established and only one input chain rule.These two input chain rules, the first one is needed for handshake, the second is for admin access to config, they are logical!!add action=accept chain=input comment="allow Wireguard server" dst-port=13231protocol=udpadd action=accept chain=input comment="allow Wireguard server traffic" src-address=172.16.0.0/24This is the rule that stands out toNOT BELONG!!  It makes no sense to me.add action=accept chain=input comment="allow traffic from Wireguard vpn" dst-port=8443 protocol=udp??????????Hairpin NAT has nothing to do with vlan to vlan traffic.Hairpin NAT is sourcenat finessing required WHEN  user are in the same subnet as the SERVER  and the admin wants the users to use dyndns URL, domain name aka WANIP vice  LANIP.If the server is in a different subnet then the users, then hairpin nat is not required.If you have servers and users of server (not using LANIP to access server) in the same subnet/vlan, the only rule you need is ( assuming vlan20 )add chain=srcnat action=masquerade  dst-address=192.168.20.0/24 src-address=192.168.20.0/24Then just focus on needed dstnat rules as per usual.THe forward chain rules cleaned up the confusion and lack of cohesion in rules.The same can be said for input chain which should look like this  ( proper order )/ip firewall filteradd action=accept chain=input comment=\"defconf: accept established,related,untracked" connection-state=\established,related,untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=\invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1add action=accept chain=input comment="wireguard handshake" dst-port=13231 protocol=udpadd action=accept chain=input comment="allow Admin remote WG"  in-interface=wg-server  src-address=172.16.0.0/24add action=accept chain=input comment="allow Admin local"  in-interface-list=LAN   src-address-list=LocalAdminadd action=accept chain=input comment="allow users to services"  in-interface-list=LAN dst-port=53 protocol=udpadd action=accept chain=input comment="allow users to services"  in-interface-list=LAN dst-port=53 protocol=tcpadd action=drop chain=input comment="drop all else"However, there are other IP addresses the admin will use aka from the trusted LAN for example and perhaps consider both wired and wifi.So I added another rule for local admin IPs.   Preferably, what I do, is  make one firewall address list for all admin IPs and thus one rule.++++++++++++++++++++++++++++++++++++++FIX all the items on the previous posts and POST the latest config.This time stop the nonsense of not posting everything.  AKA no mangles or routing rules anywhere?????/export file=anynameyouwish ( minus router serial number, any public WANIP information, vpn keys etc. )PS. I dont open up files from third party sites.

---
### Post 5
Author: Unknown
Date: Unknown

REMOVE: add action=accept chain=forward comment="allow selected local resources to all VLANs" dst-address-list=local-vlans src-address-list=trusted-localKEEP: add action=accept chain=forward comment="allow all VLANs to selected local resources" dst-address-list=trusted-local src-address-list=local-vlansIf I remove this, then it stops working. That's why I have both in place.This is the rule that stands out to NOT BELONG!! It makes no sense to me.add action=accept chain=input comment="allow traffic from Wireguard vpn" dst-port=8443 protocol=udpThis is one of the site2site VPNs (wireguard-client-1, 192.168.102.1/2), without this I can't ping other end which is useful for monitoring purposes.If you have servers and users of server (not using LANIP to access server) in the same subnet/vlan, the only rule you need is ( assuming vlan20 )add chain=srcnat action=masquerade dst-address=192.168.20.0/24 src-address=192.168.20.0/24it didn't make any difference. What I have are servers:192.168.20.11:8006 and 192.168.20.20:8007 with domain x.domain.com pointing to external IP 217.x.x.x and what I need is to be able to access them using domain (external IP) while being in VLAN, for example other than 20. his can be actually limited to few IPs in VLAN10 (or the whole VLAN10) and single IP in VLAN30 192.168.30.x./ip firewall filteradd action=accept chain=input comment=\"defconf: accept established,related,untracked" connection-state=\established,related,untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=\invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1add action=accept chain=input comment="wireguard handshake" dst-port=13231 protocol=udpadd action=accept chain=input comment="allow Admin remote WG" in-interface=wg-server src-address=172.16.0.0/24add action=accept chain=input comment="allow Admin local" in-interface-list=LAN src-address-list=LocalAdminadd action=accept chain=input comment="allow users to services" in-interface-list=LAN dst-port=53 protocol=udpadd action=accept chain=input comment="allow users to services" in-interface-list=LAN dst-port=53 protocol=tcpadd action=drop chain=input comment="drop all else"that broke almost everything (VPNs, interVLAN filtering)The only mangle rules I have are:Code:Select all[admin@RB760iGS]>/ip/firewall/mangle/printFlags:X-disabled,I-invalid;D-dynamic0D;;;special dummy rule to show fasttrack counters
      chain=prerouting action=passthrough1D;;;special dummy rule to show fasttrack counters
      chain=forward action=passthrough2D;;;special dummy rule to show fasttrack counters
      chain=postrouting action=passthroughand the routing rules:Code:Select all[admin@RB760iGS]>/ip/route/printFlags:D-DYNAMIC;I-INACTIVE,A-ACTIVE;c-CONNECT,s-STATIC,d-DHCP,v-VPN;H-HW-OFFLOADED;+-ECMPColumns:DST-ADDRESS,GATEWAY,DISTANCE#       DST-ADDRESS        GATEWAY                 DISTANCEDIdH0.0.0.0/0217.xxx.xxx.11DAv0.0.0.0/0pppoe-out11DAc10.0.1.0/24wireguard-client-20DAc10.159.50.0/24wireguard-client-30DAc172.16.0.0/24wg-server0DAc192.168.10.0/24vlan100DAc192.168.20.0/24vlan200DAc192.168.30.0/24vlan300DAc192.168.40.0/24vlan400DAc192.168.50.0/24vlan500DAc192.168.60.0/24vlan600DAc192.168.102.0/24wireguard-client-10DAc217.xxx.xx.120/32pppoe-out10DAc217.xxx.xxx.24/29vlan200### this is to use public IPs in LAN directly0As+0.0.0.0/0192.168.102.111As+0.0.0.0/0wireguard-client-112As+0.0.0.0/010.159.50.113As+0.0.0.0/0wireguard-client-314As+0.0.0.0/0wireguard-client-215As+0.0.0.0/010.0.1.11

---
### Post 6
Author: Unknown
Date: Unknown

So the simplest solution so far is to add selected local IPs 192.168.10.2,3,4 to trusted address list... no need for creating Hairpin rules at all in this case. My other last resort solution was placing it behind Nginx reverse proxy and limit IP can access it in vhost configuration. Anyway thanks for your help and please let me know if you have better idea I could test.

---
### Post 7
Author: Unknown
Date: Unknown

If any of the users are in the same subnet as a server, that subnet will need a hairpin nat rule.

---
