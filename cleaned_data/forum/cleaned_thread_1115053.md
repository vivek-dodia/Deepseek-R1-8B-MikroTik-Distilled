# Thread Information
Title: Thread-1115053
Section: RouterOS
Thread ID: 1115053

# Discussion

## Initial Question
Hy all. I have aworkingWireguard Mikrotik-to-Windows VPN.From Windows side I can ping and reach the Mikrotik on office side and I can also ping and reach 2 other devices. (one of those 2 is directly connected to ether3). I can also ping and reach the second LAN (ether5 10.10.10.1/24) which is connected to a switch (Switch B). Problem is on Switch A, with lan 192.168.1.254/24.However, I cannot ping and reach OTHER devices that are connected to the bridge (Port 2 - Switch A) that goes into a Tenda Network Switch. I've tried rebooting the switch but didn't help.Just want to make sure that MK's side is ok before I start operating on the switch.Thanks.Mikrotikether1 - Modemether2 - Switch A (all devices connected to it are not reachable via VPN)ether3 - Deviceether5 - Switch B (all devices connected to it are reachable)
```
/interfacebridgeaddadmin-mac=D4:01:C3:3C:D9:BAauto-mac=nocomment=defconf dhcp-snooping=yes \
    name=brLAN/interfaceethernetset[finddefault-name=ether1]name=e1-WAN/interfacewireguardaddlisten-port=14231mtu=1420name=wg_govoni/interfacelistaddcomment=defconf name=WANaddcomment=defconf name=LAN/interfacelte apnset[finddefault=yes]ip-type=ipv4use-network-apn=no/interfacewireless security-profilesset[finddefault=yes]supplicant-identity=MikroTik/ip hotspot profileset[finddefault=yes]html-directory=hotspot/ip pooladdname=dhcp_pool3 ranges=192.168.1.50-192.168.1.250addname=dhcp_pool4 ranges=10.10.10.200-10.10.10.254/ip dhcp-serveraddaddress-pool=dhcp_pool3interface=brLAN lease-time=10mname=dhcp1addaddress-pool=dhcp_pool4interface=ether5 lease-time=10mname=dhcp2/portset0name=serial0/ppp profileset*FFFFFFFElocal-address=VPNPOOL remote-address=VPNPOOL/interfacesstp-clientaddauthentication=mschap1,mschap2 connect-to=mk.estcom.online disabled=no\
    http-proxy=0.0.0.0name=ppp-govonimain profile=default-encryption user=\
    ppp-govonimain verify-server-address-from-certificate=no/snmp communityset[finddefault=yes]name=estcom/interfacebridge portaddbridge=brLAN comment=defconf ingress-filtering=nointerface=ether2addbridge=brLAN comment=defconf ingress-filtering=nointerface=ether3addbridge=brLAN comment=defconf ingress-filtering=nointerface=ether4/ip neighbor discovery-settingssetdiscover-interface-list=LAN/ipv6 settingssetdisable-ipv6=yes max-neighbor-entries=8192/interfacelist memberaddcomment=defconfinterface=brLAN list=LANaddcomment=defconfinterface=e1-WAN list=WANaddcomment=defconfinterface=ether5 list=LANaddinterface=wg_govoni list=LAN/interfaceovpn-server serversetauth=sha1,md5/interfacewireguard peersaddallowed-address=192.168.2.10/32comment=Robertointerface=wg_govoni \public-key="XX"addallowed-address=192.168.2.20/32comment=Fabiodisabled=yesinterface=\
    wg_govonipublic-key="XX"addallowed-address=192.168.2.90/32comment=Franzinterface=wg_govoni \public-key="XX"/ip addressaddaddress=192.168.1.254/24comment=defconfinterface=brLAN network=\192.168.1.0addaddress=10.10.10.1/24interface=ether5 network=10.10.10.0addaddress=192.168.9.2/24interface=e1-WAN network=192.168.9.0addaddress=192.168.2.1/24interface=wg_govoni network=192.168.2.0/ip cloudsetddns-enabled=yes/ip dhcp-server networkaddaddress=10.10.10.0/24dns-server=8.8.8.8,8.8.4.4gateway=10.10.10.1addaddress=192.168.1.0/24dns-server=8.8.8.8,8.8.4.4gateway=192.168.1.254/ip dnssetallow-remote-requests=yes cache-size=20480KiBmax-concurrent-queries=300\
    max-concurrent-tcp-sessions=60servers=8.8.8.8,8.8.4.4/ip firewall address-listaddaddress=XX list=ESTCOM-REMOTEaddaddress=XX list=ESTCOM-REMOTE/ip firewall filteraddaction=accept chain=input dst-port=14231protocol=udpaddaction=accept chain=input dst-address=192.168.1.0/24src-address=\192.168.2.0/24addaction=drop chain=forward dst-address=192.168.9.0/24src-address=\192.168.1.0/24addaction=drop chain=forward dst-address=192.168.1.0/24src-address=\192.168.9.0/24addaction=accept chain=input comment=VPN dst-port=8291in-interface=e1-WAN \
    protocol=tcp src-address-list=ESTCOMaddaction=accept chain=input src-address-list=ESTCOM-REMOTEaddaction=accept chain=input dst-port=4500,500in-interface=e1-WAN protocol=\
    tcpaddaction=accept chain=input dst-port=4500,500in-interface=e1-WAN protocol=\
    udpaddaction=accept chain=inputin-interface=e1-WAN protocol=ipsec-espaddaction=accept chain=inputin-interface=e1-WAN protocol=ipsec-ahaddaction=accept chain=inputin-interface=e1-WAN protocol=greaddaction=accept chain=input comment=\"defconf: accept established,related,untracked"connection-state=\
    established,related,untrackedaddaction=drop chain=input comment="defconf: drop invalid"connection-state=\
    invalidaddaction=accept chain=input comment="defconf: accept ICMP"protocol=icmpaddaction=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)"dst-address=127.0.0.1addaction=drop chain=input comment="defconf: drop all not coming from LAN"\in-interface-list=!LANaddaction=accept chain=forward comment="defconf: accept in ipsec policy"\
    ipsec-policy=in,ipsecaddaction=fasttrack-connection chain=forward comment="defconf: fasttrack"\
    connection-state=established,related hw-offload=yesaddaction=accept chain=forward comment=\"defconf: accept established,related, untracked"connection-state=\
    established,related,untrackedaddaction=drop chain=forward comment="defconf: drop invalid"\
    connection-state=invalidaddaction=drop chain=forward comment=\"defconf: drop all from WAN not DSTNATed"connection-nat-state=!dstnat \
    connection-state=newin-interface-list=WANaddaction=accept chain=input src-address-list=ESTCOM-REMOTE/ip firewall nataddaction=masquerade chain=srcnat comment="defconf: masquerade"\
    ipsec-policy=out,noneout-interface-list=WAN/ip firewall service-portsetftp disabled=yessettftp disabled=yesseth323 disabled=yessetsip sip-timeout=3msetpptp disabled=yessetudplite disabled=yessetdccp disabled=yessetsctp disabled=yes/ip servicesettelnet disabled=yessetftp disabled=yessetwww disabled=yessetssh disabled=yessetapi disabled=yessetapi-ssl disabled=yes/routing bfd configurationadddisabled=nointerfaces=all min-rx=200msmin-tx=200msmultiplier=5/snmpsetenabled=yes/system clocksettime-zone-name=Europe/Rome/system identitysetname=GovoniMain/system notesetshow-at-login=no/system ntp clientsetenabled=yes/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=192.168.9.254routing-table=\
    main suppress-hw-offload=no/system ntp client serversaddaddress=193.204.114.232addaddress=193.204.114.233addaddress=8.8.8.8/tool mac-serversetallowed-interface-list=LAN/tool mac-server mac-winboxsetallowed-interface-list=LAN

---
```

## Response 1
We are not in your head and thus the ramblings of devices is moot. A network diagram would have been far more helpful.Is the mikrotik being used as a wireguard server for handshake or are you connecting to a third part VPN etc..How many mikrotiks are involved?Where is the config of both MTs?If the other side is not MT, where is at least the wg config of the other side???From the config...........It would appear that you do not have a public IP, so have to assume its connected to an upstream router and are able to forward the wireguard port to the MT router.It all seems good until I hit the firewall rules.....and it gets messy and out of order etc...Also, no idea what estcom remote it. but I have removed it as my assumption is that its external WANIPs, and as such should never have access to the input chain.ESPECIALLY directly to winbox.SECURITYproblem!! Why go to the problem of having VPNs, and then go do something so unsafe???Apologies if these are just addresses from the private LAN on the ISP router where you also connect your PC and need access to the config..........but I have my doubts.Input chain rules is not the place to give local subnets access to each other.........Why TCP for ports 4500 and 500 ???? ( removed )/ip firewall address-list { static dhcp leases where applicable }add address=192.168.2.XY/32 list=AUTHORIZED comment=" remote admin laptop"add address=192.168.2.AB/32 list=AUTHORIZED comment=" remote admin smartphone"add address=192.168.1.DE list=AUTHORIZED comment="local admin pc"add address=192.168.1.FG list=AUTHORIZED comment="local admin wifi"ETC......./ip firewall filter{ default rules to keep }add action=accept chain=input comment=\"defconf: accept established, related, untracked" connection-state=\established, related, untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=\invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1(admin rules)add action=accept chain=input dst-port=14231 protocol=udp comment="wireguard handshake"add action=accept chain=input dst-port=4500, 500 protocol=udpadd action=accept chain=input protocol=ipsec-espadd action=accept chain=input protocol=ipsec-ahadd action=accept chain=input protocol=greadd action=accept chain=input comment="admin access" src-address-list=AUTHORIZEDadd action=accept chain=input comment="users to services" in-interface-list=LAN dst-port=53, 123 protocol=udpadd action=accept chain=input comment="users to services" in-interface-list=LAN dst-port=53 protocol=tcpadd action=drop chain=input comment="drop all else"{ add this rule last in order not to lock yourself out }++++++++++++++++++++++++++++++++++++++++++++++++++++{ default rules to keep }add action=fasttrack-connection chain=forward comment="defconf: fasttrack" \connection-state=established, related hw-offload=yesadd action=accept chain=forward comment=\"defconf: accept established, related, untracked" connection-state=\established, related, untrackedadd action=drop chain=forward comment="defconf: drop invalid" \connection-state=invalid( admin rules )add action=accept chain=forward comment="internet traffic" in-interface-list=LAN out-interface-list=WANadd action=accept chain=forward comment=" allow subnet .2 to .1 traffic" src-address=192.168.2.0/24 dst-address=192.168.1.0/24add action=accept chain=forward comment="port forwarding" connection-nat-state=dstnat disabled=yes { enable if required or remove }add action=drop chain=forward comment="drop all else" ---

## Response 2
We are not in your head and thus the ramblings of devices is moot. A network diagram would have been far more helpful.Is the mikrotik being used as a wireguard server for handshake or are you connecting to a third part VPN etc.I wrote Mikrotik-to-Windows, hence it's a Mikrotik to PC VPN using Wireguard windows client.How many mikrotiks are involved?1, as I said above..Where is the config of both MTs?Only 1, as I said above.If the other side is not MT, where is at least the wg config of the other side???Here it is:
```
[Interface]PrivateKey=XXXXAddress=192.168.2.90/32DNS=8.8.8.8[Peer]PublicKey=XXXXXAllowedIPs=0.0.0.0/0Endpoint=XXX:XXXFrom the config...........It would appear that you do not have a public IP, so have to assume its connected to an upstream router and are able to forward the wireguard port to the MT router.It all seems good until I hit the firewall rules.....and it gets messy and out of order etc...Also, no idea what estcom remote it. but I have removed it as my assumption is that its external WANIPs, and as such should never have access to the input chain.ESPECIALLY directly to winbox.SECURITYproblem!!   Why the phuck go to the problem of having VPNs, and then go do something so unsafe???Apologies if these are just addresses from the private LAN on the ISP router where you also connect your PC and need access to the config..........but I have my doubts.Input chain rules is not the place to give local subnets access to each other.........Why TCP for ports 4500 and 500 ???? ( removed )Estcom remote is my office's lan, so it is secure to have access to it from it. So no Security problem, but thanks for still pointing it out.As for TCP 4500, 500 are useless and I removed them, thanks.So do you think it's just the Switch A making problems if WG config is fine?

---
```

## Response 3
Understood, just wanted you to be safe, looks like all well in hand.Ensure on client peer windows device you have persistent keep alive set.Yes, the switch issue is weird. Its an un-managed switch right?? Check the cable from router to switch ???I would adjust slightly the rules I gave you thoughadd action=accept chain=forward comment="internet traffic" in-interface-list=LAN out-interface-list=WANadd action=accept chain=forward comment=" allow wg to subnet" in-interface=wg_govoni dst-address=192.168.1.0/24add action=accept chain=forward comment="port forwarding" connection-nat-state=dstnat disabled=yes { enable if required or remove }add action=drop chain=forward comment="drop all else" ---

## Response 4
Understood, just wanted you to be safe, looks like all well in hand.Ensure on client peer windows device you have persistent keep alive set.Yes, the switch issue is weird. Its an un-managed switch right?? Check the cable from router to switch ???I would adjust slightly the rules I gave you thoughadd action=accept chain=forward comment="internet traffic" in-interface-list=LAN out-interface-list=WANadd action=accept chain=forward comment=" allow wg to subnet" in-interface=wg_govoni dst-address=192.168.1.0/24add action=accept chain=forward comment="port forwarding" connection-nat-state=dstnat disabled=yes { enable if required or remove }add action=drop chain=forward comment="drop all else"I tried adding those rules, but no luck. ---

## Response 5
What private IP address does the Windows machine have?Can you post aroute print?Can you "see" the traffic to this subnet? ---

## Response 6
What private IP address does the Windows machine have?Can you post aroute print?Can you "see" the traffic to this subnet?Windows PC: 192.168.10.1/24 (Tried also different lans)Strange thing is that if I run an IP scan from the Windows PC, I can only see 2 devices out of 40 devices. 192.168.1.51 and .92 while if I run an IP scan on the second lan (10.10.10.1/24) I can see ALL hosts in that lan.I can clearly see the 2nd lan of the Mikrotik (10.10.10.1/24) but not the lan of the Bridge (192.168.1.1/24).0 As 0.0.0.0/0 192.168.9.254 1DAc 10.10.10.0/24 ether5 0DAc 10.64.1.1/32 ppp-govonimain 0DAc 192.168.1.0/24 brLAN 0DAc 192.168.2.0/24 wg_govoni 0DAc 192.168.9.0/24 e1-WAN 0 ---

## Response 7
What private IP address does the Windows machine have?Can you post aroute print?Can you "see" the traffic to this subnet?Windows PC: 192.168.10.1/24 (Tried also different lans)Strange thing is that if I run an IP scan from the Windows PC, I can only see 2 devices out of 40 devices. 192.168.1.51 and .92 while if I run an IP scan on the second lan (10.10.10.1/24) I can see ALL hosts in that lan.I can clearly see the 2nd lan of the Mikrotik (10.10.10.1/24) but not the lan of the Bridge (192.168.1.1/24).0 As 0.0.0.0/0 192.168.9.254 1DAc 10.10.10.0/24 ether5 0DAc 10.64.1.1/32 ppp-govonimain 0DAc 192.168.1.0/24 brLAN 0DAc 192.168.2.0/24 wg_govoni 0DAc 192.168.9.0/24 e1-WAN 0Problem seems to be on the Bridge, as I tried to move the 192.168.1.254/24 from the Bridge to ether2 (connected to Switch) and now works. I could just leave it like this, but I want to know what's causing this. ---

## Response 8
Resolved.Solution was changing Bridge's ARP to local-proxy-arp.Strange that ether5 which was working fine had ARP to enabled just as the bridge.Thanks. ---