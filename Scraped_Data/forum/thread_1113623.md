---
title: Thread-1113623
url: https://forum.mikrotik.com/viewtopic.php?p=1113623#p1113623
thread_id: 1113623
section: RouterOS
post_count: 4
date_crawled: 2025-02-03T16:48:16.734038
---

### Post 1
Author: Unknown
Date: Unknown

Hello everyone, I need your help. I am connecting two different ISP WAN connections to my MikroTik device, and my goal is to separate them based on LAN ports. For example, I want to use ISP1 when connected to port 1 and ISP2 when connected to port 2. I have prepared a configuration for this, but it's not working stably. Yes, it does what I want, but the IP addresses seem to mix up. I have a web server (10.0.2.100), and when I use the configuration I set up, sometimes I can't access it, and when I can, itâ€™s very slow. When I disable the other WAN interface, the server works normally. I think there are some errors in the firewall settings. I would appreciate your help.Code:Select all/interfaceethernetset[finddefault-name="ether1"]name=WAN-ISP1set[finddefault-name="ether2"]name=WAN-ISP2set[finddefault-name="ether3"]name=LAN-1set[finddefault-name="ether4"]name=LAN-2set[finddefault-name="ether5"]name=LAN-3set[finddefault-name="ether6"]name=LAN-4set[finddefault-name="ether7"]name=LAN-5set[finddefault-name="ether8"]name=LAN-6set[finddefault-name="ether9"]name=LAN-7set[finddefault-name="ether10"]name=LAN-8set[finddefault-name="ether11"]name=LAN-9set[finddefault-name="ether12"]name=LAN-10set[finddefault-name="ether13"]name=LAN-11set[finddefault-name="ether14"]name=LAN-12set[finddefault-name="ether15"]name=LAN-13set[finddefault-name="ether16"]name=LAN-14set[finddefault-name="ether17"]name=LAN-15set[finddefault-name="ether18"]name=LAN-16set[finddefault-name="ether19"]name=LAN-17set[finddefault-name="ether20"]name=LAN-18set[finddefault-name="ether21"]name=LAN-19set[finddefault-name="ether22"]name=LAN-20set[finddefault-name="ether23"]name=LAN-21set[finddefault-name="ether24"]name=LAN-22/interfacebridgeaddname=LAN-ISP1addname=LAN-ISP2/interfacebridge portaddbridge=LAN-ISP1interface=LAN-1addbridge=LAN-ISP1interface=LAN-3addbridge=LAN-ISP1interface=LAN-5addbridge=LAN-ISP1interface=LAN-7addbridge=LAN-ISP1interface=LAN-9addbridge=LAN-ISP1interface=LAN-11addbridge=LAN-ISP1interface=LAN-13addbridge=LAN-ISP1interface=LAN-15addbridge=LAN-ISP1interface=LAN-17addbridge=LAN-ISP1interface=LAN-19addbridge=LAN-ISP1interface=LAN-21addbridge=LAN-ISP2interface=LAN-2addbridge=LAN-ISP2interface=LAN-4addbridge=LAN-ISP2interface=LAN-6addbridge=LAN-ISP2interface=LAN-8addbridge=LAN-ISP2interface=LAN-10addbridge=LAN-ISP2interface=LAN-12addbridge=LAN-ISP2interface=LAN-14addbridge=LAN-ISP2interface=LAN-16addbridge=LAN-ISP2interface=LAN-18addbridge=LAN-ISP2interface=LAN-20addbridge=LAN-ISP2interface=LAN-22/ip addressaddaddress=10.0.2.1/24interface=LAN-ISP1addaddress=10.0.3.1/24interface=LAN-ISP2/ip dhcp-clientaddinterface=WAN-ISP1 disabled=noaddinterface=WAN-ISP2 disabled=no/ip firewall nataddchain=srcnatout-interface=WAN-ISP1 action=masqueradeaddchain=srcnatout-interface=WAN-ISP2 action=masquerade/ip firewall address-listaddlist=LAN-ISP1 address=10.0.2.0/24addlist=LAN-ISP2 address=10.0.3.0/24/ip dnssetservers=1.1.1.1,1.0.0.1/routing tableaddname=ISP1addname=ISP2/routing tablesetISP1 fibsetISP2 fib/ip routeaddgateway=WAN-ISP1 routing-table=ISP1 distance=1addgateway=WAN-ISP2 routing-table=ISP2 distance=1/ip firewall mangleaddchain=preroutingin-interface=LAN-1action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-3action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-5action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-7action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-9action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-11action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-13action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-15action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-17action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-19action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-21action=mark-routingnew-routing-mark=ISP1 passthrough=yesaddchain=preroutingin-interface=LAN-2action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-4action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-6action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-8action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-10action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-12action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-14action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-16action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-18action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-20action=mark-routingnew-routing-mark=ISP2 passthrough=yesaddchain=preroutingin-interface=LAN-22action=mark-routingnew-routing-mark=ISP2 passthrough=yes/ip pooladdname=IPPool-ISP1 ranges=10.0.2.2-10.0.2.254addname=IPPool-ISP2 ranges=10.0.3.2-10.0.3.254/ip dhcp-serveraddaddress-pool=IPPool-ISP1interface=LAN-ISP1 name=DHCPServer-ISP1addaddress-pool=IPPool-ISP2interface=LAN-ISP2 name=DHCPServer-ISP2/ip dhcp-server networkaddaddress=10.0.2.0/24gateway=10.0.2.1dns-server=1.1.1.1addaddress=10.0.3.0/24gateway=10.0.3.1dns-server=1.1.1.1/ip dhcp-server enableDHCPServer-ISP1/ip dhcp-server enableDHCPServer-ISP2/ip firewall nataddchain=dstnatin-interface=WAN-ISP1 action=dst-nat to-addresses=10.0.2.100/ip firewall
filteraddchain=forwardin-interface=WAN-ISP1 action=accept

---
### Post 2
Author: Unknown
Date: Unknown

In your configuration, LAN-1 to LAN-22 are not IP interfaces, they are just member ports of their respective bridges. If you look at the packet and byte counters of those mangle rules, you'll see that they stand at 0 because from the point of view of the IP firewall, there is no traffic that would matchin-interface=LAN-x. Instead, use just twoaction=mark-routingrules, one matching onin-interface=LAN-ISP1and the other one matching onin-interface=LAN-ISP2.Since both the dhcp clients attached to WAN interfaces add the default routes to tablemainwith the same distance of 1, packets without any routing mark assigned use a "random" WAN - the "random" is actually not that random as they actually use a hash of the source and destination address to choose the route.

---
### Post 3
Author: Unknown
Date: Unknown

Very confusing nomenclature,There is no need to change etherport names, but if  you must then at least have etherport3 name=LAN-3, and so forth.I would not have  thought of using bridges for grouping traffic like  you have.Now that its clear you are doing port forwarding, the mangle rules get more complex and I would now move from routing rules to mangles.......However, carrying that forward.One approach would be to mangle traffic coming from one bridge and another mangle traffic set of rules for the other bridge.NOTE  TRY ROUTING RULES ONLY, may be easier and if it works we can avoid mangling,See next post for how to!!1. FIRST we ensure that SERVER traffic goes out the correct WAN.   I assumed that you have multiple servers and they can be accessed by either WAN so:{mark the traffic connections}add chain=forward action=mark-connection  in-interface=WAN-ISP1  connection-mark=no-mark  \new-connection-mark=to-servers1  dst-address-list=SERVERS passthrough=yesadd chain=forward action=mark-connection  in-interface=WAN-ISP2 connection-mark=no-mark  \new-connection-mark=to-servers2  dst-address-list=SERVERS  passthrough=yes{route the marked traffic}add chain=prerouting action=mark-routing  connection-mark=to-servers1 \new-routing-mark=ISP1 passthrough=noadd chain=prerouting action=mark-routing  connection-mark=to-servers2 \new-routing-mark=ISP2 passthrough=no2.  Next we ensure the rest of the traffic goes out the appropriate WAN.{first mark connections}add chain=forward action=mark-connection  in-interface=LAN-ISP1 connection-mark=no-mark  \new-connection-mark=from-bridge1  dst-address-type=!local  passthrough=yesadd chain=forward action=mark-connection  in-interface=LAN-ISP connection-mark=no-mark  \new-connection-mark=from-bridge1  dst-address-type=!local  passthrough=yes{ then mark routes }add chain=prerouting action=mark-routing  connection-mark=from-bridge1 \new-routing-mark=ISP1 passthrough=noadd chain=prerouting action=mark-routing  connection-mark=from-bridge2 \new-routing-mark=ISP2 passthrough=no/ip routeadd check-gateway=ping dst-address=0.0.0.0/0 gateway=1.1.1.1  scope=10 target-scope=12 comment=WAN1add distance=2 check-gateway=ping dst-address=0.0.0.0/0 gateway=9.9.9.9  scope=10 target-scope=12 comment=WAN2add dst-address=1.1.1.1/32  gateway=WAN-ISP21 routing-table=main scope=10 target-scope=11add distance=2 dst-address=9.9.9.9/32  gateway=WAN-ISP2 routing-table=main scope=10 target-scope=11{special table routes}add dst-address=0.0.0.0/0 gateway=WAN-ISP1 routing-table=ISP1add dst-address=0.0.0.0/0 gateway=WAN-ISP2 routing-table=ISP2

---
### Post 4
Author: Unknown
Date: Unknown

Keeping with the routing rule theme sindy suggested..It would look like no mangling and the following routing rules....TRY THIS FIRST as its much easier./routing ruleadd action=lookup-only-in-table min-prefix=0 table=mainadd  action=lookup-only-in-table src-address=10.0.2.0/24  table=ISP1add  action=lookup-only-in-table src-address=10.0.3.0/24  table=ISP2Everything else the same./ip routeadd check-gateway=ping dst-address=0.0.0.0/0 gateway=1.1.1.1 scope=10 target-scope=12 comment=WAN1add distance=2 check-gateway=ping dst-address=0.0.0.0/0 gateway=9.9.9.9 scope=10 target-scope=12 comment=WAN2add dst-address=1.1.1.1/32 gateway=WAN-ISP21 routing-table=main scope=10 target-scope=11add distance=2 dst-address=9.9.9.9/32 gateway=WAN-ISP2 routing-table=main scope=10 target-scope=11{special table routes}add dst-address=0.0.0.0/0 gateway=WAN-ISP1 routing-table=ISP1add dst-address=0.0.0.0/0 gateway=WAN-ISP2 routing-table=ISP2

---
