---
title: Thread-194705
url: https://forum.mikrotik.com/viewtopic.php?t=194705&sid=49f92a630bc7970d8ca50523be880e8f
thread_id: 194705
section: RouterOS
post_count: 42
date_crawled: 2025-02-03T21:03:04.117588
---

### Post 1
Author: Unknown
Date: Unknown

Hello,I've already tried Mikrotik support, but they suggest to ask here...---I was trying to enable / add my WireGuard VPN provider AzireVPN, but is not working properly seems likeAfter finishing bellow steps, VPN is connected but devices working strange, some pages are not able to open - timeout , some are opening fine.WhatIsMyIP pages - some are showing im in Sweden (VPN locaion), some shows local country IPI assume it has something to do IPv4 vs IPv6 setting1. Could you please suggest what / where to setup to be working correctly?2. Next step i would like to WhiteList/select few devices / IPs to be on VPN (has PublicIP) and open few ports for those devices3. Rest devices should be under Local IP.Thanks!Here is what i did following multiple guides and wiki sources:Code:Select all# Adding interface with correct private key works well/interface/wireguard/addlisten-port=13231private-key="PrivateKey1"name=wg-az-se-sto comment="AzireVPN SE-STO interface"# Over here i've added IPs from az-se-sto.conf file, but not able to add IPv6 address or doing it wrongly/ip/addressaddaddress=10.0.15.53/32,2a0e:1c80:1337:1:10:0:15:53/128interface=wg-az-se-sto# it worked only without IPv6/ip/addressaddaddress=10.0.15.53/32interface=wg-az-se-sto# This was added fine/interface/wireguard/peers/addendpoint-address=se-sto.azirevpn.net endpoint-port=51820public-key="PublicKey1"allowed-address=0.0.0.0/0,::/0interface=wg-az-se-sto# here it surprisingly accepted also IPv6 DNS/ip dnssetservers=91.231.153.2,192.211.0.2,2a0e:1c80:1337:1:10:0:0:1allow-remote-requests=yes# both added fine/ip/routeadddst-address=0.0.0.0/0gateway=wg-az-se-sto# except " se-sto.azirevpn.net " can't be added seems like, even VPN provider strongy suggest to use hostname , as IP might change with the time. So i had to do "ping se-sto.azirevpn.net " to get IP 45.15.16.52/ip/routeadddst-address=45.15.16.52gateway=10.38.166.65# adding rule to FW/ip firewall nataddchain=srcnat action=masqueradeout-interface=wg-az-se-sto# adding rule to FW to allow WG traffic/ip firewall filteraddaction=accept chain=output comment="allow WireGuard"dst-address=45.15.16.52dst-port=51820protocol=udp place-before=1Code:Select all[Interface]PrivateKey=PrivateKey1Address=10.0.15.53/32,2a0e:1c80:1337:1:10:0:15:53/128DNS=91.231.153.2,192.211.0.2,2a0e:1c80:1337:1:10:0:0:1[Peer]PublicKey=PublicKey1AllowedIPs=0.0.0.0/0,::/0Endpoint=se-sto.azirevpn.net:51820se-sto.azirevpn.net = 45.15.16.52

---
### Post 2
Author: Unknown
Date: Unknown

Is your network ipv6?  if so cannot help as not fluent in such language.

---
### Post 3
Author: Unknown
Date: Unknown

Hi,No i have mostly IPv4, but IPv6 is not disabled (yet)

---
### Post 4
Author: Unknown
Date: Unknown

When ready to not use ipv6, as stated can help troubleshoot.In the meantime checkoutPARA7andPARA9(D)--viewtopic.php?t=182340

---
### Post 5
Author: Unknown
Date: Unknown

Hi, I went finally through the guide, but probably i have still something wrong.If someone would be that kind and check it, suggest what to change...over 2 month reading and not going any much furter1. Some pages stopped to load (eg. duckduckgo.com) , google.com loads fine, not sure if DNS, something cached or FW problems is causing it...2. After applying suggested settings, Can't connect to MT via IP now , only via MAC3. Soon as is working normally - I would like to WhiteList/select few devices / IPs to be on VPN (has PublicIP) and open few ports for those devicesRest devices should be under Local Provider IP.I'm using 3rd party VPN providerThis is the "former" code to add VPN WGCode:Select all# Adding interface with correct private key works well/interface/wireguard/addlisten-port=13231private-key="PrivateKey1"name=wg-az-se-sto comment="AzireVPN SE-STO interface"# Over here i've added IPs from az-se-sto.conf file, but not able to add IPv6 address or doing it wrongly/ip/addressaddaddress=10.0.15.53/32,2a0e:1c80:1337:1:10:0:15:53/128interface=wg-az-se-sto# it worked only without IPv6/ip/addressaddaddress=10.0.15.53/32interface=wg-az-se-sto# This was added fine/interface/wireguard/peers/addendpoint-address=se-sto.azirevpn.net endpoint-port=51820public-key="PublicKey1"allowed-address=0.0.0.0/0,::/0interface=wg-az-se-sto# here it surprisingly accepted also IPv6 DNS/ip dnssetservers=91.231.153.2,192.211.0.2,2a0e:1c80:1337:1:10:0:0:1allow-remote-requests=yes# both added fine/ip/routeadddst-address=0.0.0.0/0gateway=wg-az-se-sto# except " se-sto.azirevpn.net " can't be added seems like, even VPN provider strongy suggest to use hostname , as IP might change with the time. So i had to do "ping se-sto.azirevpn.net " to get IP 45.15.16.52/ip/routeadddst-address=45.15.16.52gateway=10.38.166.65# adding rule to FW/ip firewall nataddchain=srcnat action=masqueradeout-interface=wg-az-se-sto# adding rule to FW to allow WG traffic/ip firewall filteraddaction=accept chain=output comment="allow WireGuard"dst-address=45.15.16.52dst-port=51820protocol=udp place-before=1Config from VPN providerCode:Select all[Interface]PrivateKey=PrivateKey1Address=10.0.15.53/32,2a0e:1c80:1337:1:10:0:15:53/128DNS=91.231.153.2,192.211.0.2,2a0e:1c80:1337:1:10:0:0:1[Peer]PublicKey=PublicKey1AllowedIPs=0.0.0.0/0,::/0Endpoint=se-sto.azirevpn.net:51820#had to find real IP in order to use it in Mikrotikping se-sto.azirevpn.net=45.15.16.52Then i've addedCode:Select all/routing tableadddisabled=nofib name=useWG/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=se-sto.azirevpn.net \
    endpoint-port=51820interface=wg-az-se-sto persistent-keepalive=40s\public-key="PublicKey1"/ip addressaddaddress=10.0.15.53/24interface=wg-az-se-sto network=10.0.15.0/ip firewall filteraddaction=accept chain=forwardin-interface=bridgeout-interface=\
    wg-az-se-stoaddaction=accept chain=output comment="allow WireGuard"disabled=yes \
    dst-address=45.15.16.52dst-port=51820protocol=udp/routing ruleaddaction=lookup disabled=nosrc-address=192.168.10.0/24table=useWGadded also whole export "anonymized"Thanks

---
### Post 6
Author: Unknown
Date: Unknown

(1) REMOVE THIS RULE,  no need for it.add action=acceptchain=outputcomment="allow WireGuard" disabled=yes \dst-address=45.15.16.52 dst-port=51820 protocol=udp(2)  Add persistent keep alive to your peer settings lets say 35 seconds.  ( oops I see you have one already, all good )(3) For endpoint use se-sto.azirevpn.netGO TO FIREWALL ADDRESS LIST and create one call it 3rdPartyVPN,  so that you can see the resolve at any timeThe address may change so using a fixed IP is not the best solution.aka DO NOT USE the number!!  The config you posted seems fine as it uses the address....(4)   Modify your DNS rules .........From:/ip dhcp-server networkadd address=192.168.10.0/24 comment="VPN DNS Servers" dns-server=192.168.10.1 \gateway=192.168.10.1TO:/ip dnsset allow-remote-requests=yes servers=\1.1.1.1, 9.9.9.9{ or whatever public DNS you prefer }ANDFrom:/ip dhcp-server networkadd address=192.168.10.0/24 comment="VPN DNS Servers" dns-server=192.168.10.1 \gateway=192.168.10.1TO:/ip dhcp-server networkadd address=192.168.10.0/24 comment="VPN DNS Servers"dns-server= 91.231.153.2,192.211.0.2\gateway=192.168.10.1NOTE:  The router itself needs a proper DNS setting and we only need to ensure bridge entries use the DNS in  question.(5)  FIXED FIREWALL RULES.  Note,  ORDER is important within a chain!!!!INPUT CHAIN( got rid of output rule, not required , you had handshake input rule disabled??, block dns rules were redundant and removed, --> allow all traffic from LAN then drop all else!! )( your input rules for SSH and winbox weredangerousand removed,  and also not required as LAN access is already available.)FORWARD CHAIN( added bridge to wan access, a proper separated allow port forwarding rule and then drop all else rule)Code:Select all/ip firewall filteraddaction=accept chain=input comment=\"defconf: accept established,related,untracked"connection-state=\
    established,related,untrackedaddaction=drop chain=input comment="defconf: drop invalid"connection-state=\
    invalidaddaction=accept chain=input comment="defconf: accept ICMP"protocol=icmpaddaction=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)"dst-address=127.0.0.1addaction=accept chain=input disabled=nodst-port=51820in-interface=\
    ether1-WAN protocol=udpaddaction=accept chain=input comment="defconf: allow all coming from LAN"\in-interface-list=LANaddaction=drop chain=input comment="drop all else"addaction=accept chain=forward comment="defconf: accept in ipsec policy"\
    ipsec-policy=in,ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"\
    ipsec-policy=out,ipsecaddaction=fasttrack-connection chain=forward comment="defconf: fasttrack"\
    connection-state=established,related disabled=yes hw-offload=yesaddaction=accept chain=forward comment=\"defconf: accept established,related, untracked"connection-state=\
    established,related,untrackedaddaction=drop chain=forward comment="defconf: drop invalid"\
    connection-state=invalidaddaction=accept chain=forwardin-interface=bridgeout-interface=\
    WANaddaction=accept chain=forwardin-interface=bridgeout-interface=\
    wg-az-se-stoaddaction=accept chain=forward comment="port forwarding"connection-nat-state=dstnataddaction=drop  chain=forward comment="drop all else"...(6) NO MANGLING REQUIRED, remove all mangling rules concerning the connection,   it seems  like they are for other bogus reasons.In order to troubleshoot your wireguard, disable mangling rules for now !!(7)  CLEANING UP NAT ( remove rule in orange )/ip firewall natadd action=masquerade chain=srcnat comment="defconf: masquerade" \ipsec-policy=out,none out-interface-list=WANadd action=dst-nat chain=dstnat comment="Google DNS Force" disabled=yes \dst-port=53 protocol=udp to-addresses=8.8.8.8 to-ports=53add action=masquerade chain=srcnat out-interface=wg-az-se-stoOkay I see you do have the critical rule, put it at the top so its visible. aka for nothing else organize the view of your config!!(8) WHAT are these port forwarding rules for ????add action=dst-nat chain=dstnat comment=Lox dst-port=6789 in-interface=\ether1-WAN log=yes log-prefix=Lox protocol=tcp to-addresses=\192.168.10.100 to-ports=6789add action=dst-nat chain=dstnat comment="Transmission BT" dst-port=\6665 in-interface=ether1-WAN log=yes protocol=tcp to-addresses=\192.168.10.101 to-ports=9911Remember,  if you have incoming traffic on the WAN,  you are FORCING TRAFFIC into the TUNNEL.Thus how do you expect the return traffic from bridge devices will then go back out WAN ?????  See 12.(9)  WHERE IS WAN IP route.   It will not be visible if you have selected default route in IP DHCP Client. So will assume you have,  otherwise you need  a manual IP route.AND GET RID OF BOGUS ROUTE.add dst-address=45.15.16.52 gateway=10.38.166.65/ip routeadd dst-address=0.0.0.0/0  gwy=ISP_gwy_IP   routing-table=main  { ex of manual  route, probably not necessary if route already exists }add dst-address=0.0.0.0/0  gwy=wg-az-se-sto  routing-table=useWG(11 ) ROUTING RULE ISWRONGFrom:add action=lookup disabled=no src-address=192.168.20.0/24 table=useWGTO:add action=lookup disabled=no src-address=192.168.10.0/24 table=useWG(12)Need two additional routing rules for your port fowarding to work.......... ORDER is key./routing ruleadd action=lookup-only-in-table  src-address=192.168.10.100  table=mainadd action=lookup-only-in-table  src-address=192.168.10.101  table=mainadd action=lookup  src-address=192.168.10.0/24  table=useWG

---
### Post 7
Author: Unknown
Date: Unknown

Hello,Thanks for helping out, i tried to put all modifications as you suggested.duckduckgo.com, mail.proton.me still not loadingPortFWD doesnt work nowAll devices are on VPN Sweden location and most of pages working so far except fewHere are some details:1. removed2. 35s set3. used se-sto.azirevpn.net and seems like it's resolving it's IP , does it somehow read / add into the WG settings? As provider is using only "se-sto.azirevpn.net"This way i'll add later other LocationsCapture.JPG4. Done, used Google DNS for test 8.8.8.8 and 8.8.4.4Formerly i had VPN DNS servers as default for all traffic5. Used your FW rules, removed mine6. Mangling disabled - i guess i added them follow some guide to identify type of traffic7. removed8. Those are local servers which i want to access from Internet, those rules were working fine.Plan is to add few more with WG and it's WG Public IP , add few servers to be reachable via duckdns.org addressSo some stay on Provider Public IP and some will be on WG VPN Public IP9. Done10./ip routeadd dst-address=0.0.0.0/0 gwy=ISP_gwy_IP routing-table=main { ex of manual route, probably not necessary if route already exists }add dst-address=0.0.0.0/0 gwy=wg-az-se-sto routing-table=useWG[admin@MikroTik_Ax3] > /ip route[admin@MikroTik_Ax3] /ip/route> add dst-address=0.0.0.0/0 gateway=wg-az-se-sto routing-table=useWG[admin@MikroTik_Ax3] /ip/route>routes.png11. Yeah realized that later that day also12. Without WG VPN enabled PortFWD were working,but added them as suggested, seems like not working now, just tried

---
### Post 8
Author: Unknown
Date: Unknown

(1) Remove the static entry/ip dns staticadd address=192.168.10.1 comment=defconf name=router.lan(2)  Check out the copy job,, If I drop all traffic at the end how is any traffic going to out out your own WAN (aka the return traffic from external users).So using logic as well as attention to detail.Your config/ip firewall filteradd action=accept chain=input comment=\"defconf: accept established,related,untracked" connection-state=\established,related,untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=\invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1add action=accept chain=input dst-port=51820 in-interface=ether1-WAN \protocol=udpadd action=accept chain=input comment="defconf: allow all coming from LAN" \in-interface-list=LANadd action=drop chain=input comment="drop all else"add action=accept chain=forward comment="defconf: accept in ipsec policy" \ipsec-policy=in,ipsecadd action=accept chain=forward comment="defconf: accept out ipsec policy" \ipsec-policy=out,ipsecadd action=fasttrack-connection chain=forward comment="defconf: fasttrack" \connection-state=established,related disabled=yes hw-offload=yesadd action=accept chain=forward comment=\"defconf: accept established,related, untracked" connection-state=\established,related,untrackedadd action=drop chain=forward comment="defconf: drop invalid" \connection-state=invalidadd action=accept chain=forward in-interface=bridge out-interface=\wg-az-se-stoadd action=accept chain=forward comment="port forwarding" \connection-nat-state=dstnatadd action=drop chain=forward comment="drop all else"My CONFIG recommendation:/ip firewall filteradd action=accept chain=input comment=\"defconf: accept established,related,untracked" connection-state=\established,related,untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=\invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1add action=accept chain=input disabled=no dst-port=51820 in-interface=\ether1-WAN protocol=udpadd action=accept chain=input comment="defconf: allow all coming from LAN" \in-interface-list=LANadd action=drop chain=input comment="drop all else"add action=accept chain=forward comment="defconf: accept in ipsec policy" \ipsec-policy=in,ipsecadd action=accept chain=forward comment="defconf: accept out ipsec policy" \ipsec-policy=out,ipsecadd action=fasttrack-connection chain=forward comment="defconf: fasttrack" \connection-state=established,related disabled=yes hw-offload=yesadd action=accept chain=forward comment=\"defconf: accept established,related, untracked" connection-state=\established,related,untrackedadd action=drop chain=forward comment="defconf: drop invalid" \connection-state=invalidadd action=accept chain=forward in-interface=bridge out-interface=\WANadd action=accept chain=forward in-interface=bridge out-interface=\wg-az-se-stoadd action=accept chain=forward comment="port forwarding" connection-nat-state=dstnatadd action=drop  chain=forward comment="drop all else"(3)  I dont get it,   you clearly are not reading or thinking.  I stated that ORDER is critical in routing rules.I stated that for the return traffic from servers to reach back to the WAN they would need to be PRIOR to the rule forceing ALL bridge traffic out the WAN so what  did you do???/routing ruleadd action=lookup disabled=no src-address=192.168.10.0/24 table=useWGadd action=lookup-only-in-table src-address=192.168.10.100 table=main {WRONGthis will never be used all traffic goes out wg }add action=lookup-only-in-table src-address=192.168.10.101 table=main  {WRONGthis rule will never  be used all traffic goes out wg }What I had provided:/routing ruleadd action=lookup-only-in-table src-address=192.168.10.100 table=main  {server traffic gets out local WAN as required}add action=lookup-only-in-table src-address=192.168.10.101 table=main  {server traffic gets out local WAN as required}add action=lookup src-address=192.168.10.0/24 table=useWG{rest of bridge traffic goes out wg}

---
### Post 9
Author: Unknown
Date: Unknown

EDIT: PortFWD working agianJust some of the webpages are still issue1. removed completely2. Seems like this was mistake i had to modify:FROM:add action=accept chain=forward in-interface=bridge out-interface=WANTO:add action=accept chain=forward in-interface=bridge out-interface=ether1-WANHopefully now correct allFW2.JPG3. I entered those commands , but seem like the order is not right. How to change order? As in FW rules i'm able to change order in WinBox - mouse drag & dropOr i need to remove them a re-add in specific order?rules.JPGRemoved & re-added[admin@MikroTik_Ax3] > /routing rule[admin@MikroTik_Ax3] /routing/rule> add action=lookup-only-in-table src-address=192.168.10.100 table=main[admin@MikroTik_Ax3] /routing/rule> add action=lookup-only-in-table src-address=192.168.10.101 table=main[admin@MikroTik_Ax3] /routing/rule> add action=lookup src-address=192.168.10.0/24 table=useWGrul2.JPG

---
### Post 10
Author: Unknown
Date: Unknown

YOu are quite correct, the config I was supposed to type isadd chain=forward action=accept  in-interface=bridge  out-interface-list=WAN( your fix is equally as valid !! )The yolk is on my face for that one!!++++++++++++++++++++++++++++++++++Yes the second attempt worked, the clue is looking at the rule numbers at the left hand column  0,1,2  etc....OKAY,  so you are saying its about 98% there ??  Some webpage shenanigans...........If so trya.  changing MTU to 1500 if no joyb. return to default 1420 and try this  and then with MTU at 1500/ip firewall mangleadd action=change-mss chain=forward comment="Clamp MSS to PMTU for Outgoing packets" new-mss=clamp-to-pmtu out-interface=wg-az-se-sto passthrough=yes protocol=tcp tcp-flags=sync.  if no joy set MTU to 1420 and try  this one./ip firewall mangleadd action=change-mss chain=forward new-mss=1380 out-interface=wg-az-se-sto protocol=tcp tcp-flags=syn tcp-mss=1381-65535

---
### Post 11
Author: Unknown
Date: Unknown

1. Rule 12 can be removed now? as it was wrong and should be rule 13 ?fw3.JPG2. With adding the command , started to work, changing to MTU 1500 didnt worked out./ip firewall mangleadd action=change-mss chain=forward comment="Clamp MSS to PMTU for Outgoing packets" new-mss=clamp-to-pmtu out-interface=wg-az-se-sto passthrough=yes protocol=tcp tcp-flags=synRest of pages are working nowfw4.JPGMan thanks a lot!!! with the Mikrotik wiki and guides i went through i will be spending few months to accomplish this, really appreciate you time spend with this issue.-----3.Yes the second attempt worked, the clue is looking at the rule numbers at the left hand column 0,1,2 etc....I see those numbers , but no option to change it or reorder in WinBox UI. Bit strange to me how it works4. Just to confirm port fwd rulesIf i'm adding extra rules:add action=dst-nat chain=dstnat comment=Lox123 dst-port=6789 in-interface=ether1-WAN log=yes log-prefix=Lox protocol=tcp to-addresses=192.168.10.XXX to-ports=6789Need to also add the forwarded IP.XXX into here?/routing ruleadd action=lookup-only-in-table src-address=192.168.10.XXX table=main5. Final step how to pick / whitelist only few clients to use VPN and others stay on local IP ?Thanks!

---
### Post 12
Author: Unknown
Date: Unknown

5.  How many.............  a few just add them as you do the servers before the forcing out wireguard rule.

---
### Post 13
Author: Unknown
Date: Unknown

Thanks for all suggestions,1. Router via WinBox is not reachable via local IP, only via MAC...probably need to add some additional rule into Firewall2. I have around 50+ clients, on VPN will be 5.I tried to add ports for Transmission and it says is not openBT.JPGWhat i've analyzed so far - ports from my "regular" IP via "ether1-WAN" are reachable via FW rules, so i assume the rule is right.All ports via VPN "wg-az-se-sto" interface , seems NOT reachableThanks!

---
### Post 14
Author: Unknown
Date: Unknown

Not sure what  you mean not reachable LOL.Remember you are putting all traffic out wg tunnel.SO if you try and reach the router from your LANIP  192.168.10.XX  its going out the tunnel if IP based.MAC works around it and what  most people use anyway.If you want to retain IP access,  then take a port off the bridge, give it an IP address onlyand add the etheport to the LAN interface list and you will be able to access by IP address.You could also create another VLAN to access it++++++++++++++++++++++++++++++++++++++++++++++++++++I dont see the problem,  all your port forwardings from external users should come in the local WAN, hit the 192.168.100 or 101 and go back out the  local WAN.Isnt that what you wanted???  All other users are forced out wireguard for internet!

---
### Post 15
Author: Unknown
Date: Unknown

Not sure what you mean by port via VPN are not available.If you want to use servers through both VPNs that takes some more programming for sure.RIght now any traffic exiting the servers goes out the WAN........ not VPN.

---
### Post 16
Author: Unknown
Date: Unknown

Not reachable over VPN Public IP- i'm using duckdns.org in oder to use some own hosted servers and easy remember address and be reachable from Internet- in torrent for example you are not Active due to thathttp://bt.degreez.net/firewalled.htmlI' able to be in VPN tunnel -> data out, but i need also data IN <- via some portsAnother benefitAzireVPN gives me Public IP and i dont need to have additional paid Public IP from my provider.Hope it make sense----MAC for mikrotik is not easy to remember that's why i use Local IPVLAN - no experience with that yet...---I dont see the problem, all your port forwardings from external users should come in the local WAN, hit the 192.168.100 or 101 and go back out the local WAN.Isnt that what you wanted??? All other users are forced out wireguard for internet!Some services run over local WAN, some need to go over WG VPN interface as described above40 clients - Via regular WAN / Local Provider IP5 clients - Via VPN only / Azire IP - example some content on AndroidTV on netflix,iptv etc i can chose Country to unlock the view option

---
### Post 17
Author: Unknown
Date: Unknown

Okay,  as for mac, it shows automatically on neighbours on winbox,  no need to memorize just select it.Just for giggles try this to see if it works./routing rules.  ( in correct order of course )[1st]add action=lookup-only-in-tabledst-address=10.0.15.0/24src-address=192.168.10.100 table=useWG{ allow return traffic to wg server clients }  *****[2nd]  add action=lookup-only-in-table src-address=192.168.10.100 table=main  { allow return traffic out through local wan }[3rd]  add action=lookup-only-in-table  src-address=192.168.10.101 table=main  { allow return traffic out through local wan }[4th]  add action=lookup src-address=192.168.10.0/24 table=useWG     { last rule to force rest of bridge out wg tunnel }***** assumes you are sourcnatting the traffic from the WG server to your router.  In other words your internal server doesnt see other public IPs but sees a wireguard source address for this rule to work.+++++++++++++++++++++++++++

---
### Post 18
Author: Unknown
Date: Unknown

Tried, but still not PortFWD via VPNRemoved former rulesRouting1.JPGAdded suggested:Routing2.JPGTried those options:FW1.pngEven tried to disable working rules, if they dont interfere each otherFW2.png

---
### Post 19
Author: Unknown
Date: Unknown

Why are you trying to port forward the wg traffic coming in on the MT?The traffic coming in on WG is already on the LAN so to speak........The port forwarding or moving the traffic appropriately into the WG tunnel and towards the MT is done at the azure site.The only rule really needed at the MT end is a firewall rule.add action=forward chain=forward in-interface=wireguard   dst-address-list=serverlistwhere server list contains .100 and.101 for example.

---
### Post 20
Author: Unknown
Date: Unknown

ADD:What i've also noticed even whole traffic should be currently over WG VPN,My Duckdns docker (which is regularly updating IP) based on Server IP.101 is sharing PublicIP and NOT VPN IPeven i tried directly VPN IP:port doesnt work.More and more confusion for me

---
### Post 21
Author: Unknown
Date: Unknown

It is not clear what you are trying to accomplish or what you want to accomplish or provide in  terms of traffic.I thought the duckgo was an IP address for your azure link as you stated they give you a public IP and you use  duckgo to send users to that public IP.The question is what happens to users once they arrive at azure.......... That is the missing link  you do not understand nor I.+++++++++++++++++++++++++++++++++++++++++++++++Why are you using duckgo docker when you already have a domain name via IP cloud for the mikrotik????In any case, that doesnt explain how users find the public IP of the azure???

---
### Post 22
Author: Unknown
Date: Unknown

You really need toa. understand the requirements and articulate them for all users/devices based on traffic flow not on the  config or equipment.b. you need to provide a network diagram showing all the connectionsc.  you need to better explain what you are doing at azure site.  ( what services they provide, etc....)

---
### Post 23
Author: Unknown
Date: Unknown

DuckDNS i'm using for years, not aware of any other option in MikrotikDuckDNS run as docker on server, where the server was formerly on VPN, so it shared VPN IP to DuckDNS so i had always actual VPN IPTherefore some services were reachable via usernameX.duckdns.org:PORT---Currently even Server is on VPN IP, Duckdns is getting NON VPN Public IP - this i don't understand why...all current setting is all traffic over VPN tunel, isnt it?Here is the quick graph, not a network specialist, hopefully it's clear what i want to achievegraph.pngEDIT:Before i had Asus RT-88AX router, i was on OpenVPN, but Asus NAND chip weared out from some reason, so i moved to Mikrotik.  MT doesnt support UDP on OpenVPN.WG protocol is "newer better" so i've switched to thisComparing to Asus is really next level to setup here VPN and PortFWD.My setup on Asus was something like this:Code:Select alliptables-I FORWARD-i br0-o tun11-j ACCEPT
iptables-I FORWARD-i tun11-o br0-j ACCEPT
iptables-I FORWARD-i br0-o vlan1-j DROP
iptables-I INPUT-i tun11-j REJECT
iptables-t nat-A POSTROUTING-o tun11-j MASQUERADE# Service A(9977,55552,55553)iptables-I FORWARD-i tun11-p tcp-d192.168.10.101-m multiport--dports9977,55552,55553-j ACCEPT
iptables-I FORWARD-i tun11-p udp-d192.168.10.101-m multiport--dports55552,55553-j ACCEPT# Service B (9977,55552,55553)iptables-t nat-I PREROUTING-i tun11-p tcp-m multiport--dports9977,55552,55553-j DNAT--to-destination192.168.10.101iptables-t nat-I PREROUTING-i tun11-p udp-m multiport--dports55552,55553-j DNAT--to-destination192.168.10.101Didn't had to setup anything else on VPN Provider (Azire) site,basic steps login/passyou pick countrydownload the *.config file , load it up (in MT still not possible)Pick the local IP which you want to have on VPNSet above PortFwd rulesAll working...AzireVPN has PublicIP with no blocking ports, but I've asked them again to double check.As still no clue where is the problem to make it work

---
### Post 24
Author: Unknown
Date: Unknown

The part I dont get is duck.org on docker.Why do you have anything behind your router, it should be hosted at duck.org ???Trying to host something behind the router while also doing vpn and forcing traffic out various ways is problematic and needs careful attention.Duck DNSfree dynamic DNShosted on AWS

---
### Post 25
Author: Unknown
Date: Unknown

Aslo, Azire is just a VPN provider, they do not do any port forwarding there..............?????It seems to be this is your situation.One flat subnet at MT Router.a.  users local to router access server via LOCAL WANIP domain name   YES/ NO  ??b.  users local to router access server via server LANIP   YES/ NO ??c.  users EXTERNAL to router access server via LOCAL WANIP   Yes/No ??d.  users at c  use which domain name??e.  users EXTERNAL to router access server via WG IP  yes/no ??f.  users in e.  use duckdns name to access WG IP  yes/no ??g.  is there any reason you have to host duck dns on docker  ???h.  which IP is the docker use on the MT router LAN ???i.  Do you know what IP Cloud is ???

---
### Post 26
Author: Unknown
Date: Unknown

got reply from AzireVPN supportThey've changed PublicIP to SharedIP and no PortFWD optionwithout any noticeSo we are looking for problem on MT for nothing....F****----I formerly applied to AzireVPN due to PublicIP on some locations and no PortFWD limitationLocal Provider has sharedIP, with only 4 ports open which i already use for some servicesIf i would like to have PublicIP i would have to pay extra fee. Price for PublicIP = AzireVPN with PublicIPa. users local to router access server via LOCAL WANIP domain name - YESb. users local to router access server via server LANIP - YESc. users EXTERNAL to router access server via LOCAL WANIP - YES few ports open from provider , sharedIPd. users at c use which domain name?? - Dont understande. users EXTERNAL to router access server via WG IP - YES when was VPN PublicIP working, used few portsf. users in e. use duckdns name to access WG IP - YESg. is there any reason you have to host duck dns on docker - Wasnt working on former Router, so i add it as Docker on Serverh. which IP is the docker use on the MT router LAN ? - Yes LANi. Do you know what IP Cloud is ??? - No experience

---
### Post 27
Author: Unknown
Date: Unknown

Dont despair LOL.By the way we would have to ensure the docker LANIP goes out the normal WAN and not into the WG tunnel for that to work in sync with the public DYNDNS duck site.Why not juse use duck.dns in their AWS cloud  ??  Still dont understand why you need a docker to manage ????What do you use to give users your public WANIP for those coming in on the normal WAN.  which domain name service do you use??we can get this working for you.

---
### Post 28
Author: Unknown
Date: Unknown

So Azire suggested to use OpenVPN for "PublicIP" needs, from what i've read MT has many issues with OpenVPN and no support for UDP after 10y...This way i will have 3rd PublicIP from internet to my Router...One issue replace other...but luckily i have some support here - Thanks for that---duckdns in their AWS Cloud?This is what i use:https://hub.docker.com/r/linuxserver/duckdns/Only feature is takes my PublicIP and update/send (each 5min) it to "user.duckdns.org" domain in order to be reachable from Internet.I'm not running own Domain name server - if that was the question---What do you use to give users your public WANIP for those coming in on the normal WAN. which domain name service do you use??I have public domain from my provider "port.providerXY.net:PORT" to which i can open those few ports - this is temporary as VPN doesn't workIn the end if VPN PublicIP would be working properly, i wouldn't need to use  "port.providerXY.net:PORT"  anymore...just to unique domain at "user.duckdns.org"----Did quick google, so this might do the trick and i don't need to use Docker anymorehttps://github.com/beeyev/Mikrotik-Duck ... IP-Updaterviewtopic.php?p=421794&hilit=monitor+ip+address+duckdns

---
### Post 29
Author: Unknown
Date: Unknown

Okay I dont want to delve into temporary.Given that  you have now known limitations with your VPN provider and you dont need duckdns on dockerDraw a better network diagram to describe what is going on.Lots of choices here for drawing programs -viewtopic.php?p=908118Also provide a line by line statement for each group or individual user requirements for traffic flow without mention of config details.

---
### Post 30
Author: Unknown
Date: Unknown

Here are some suggestions that might help:You could try disabling IPv6 on your Mikrotik router and see if it resolves the issue. To do so, go to "IP" > "Settings" and uncheck the "Enable IPv6" option.To whitelist/select a few devices/IPs to be on VPN, you can create a firewall filter rule that matches the IP addresses of those devices and then apply the rule to the WireGuard interface. To open specific ports for those devices, you can also create a firewall rule that allows traffic on those ports.For the rest of the devices, you can configure your Mikrotik router to use NAT (Network Address Translation) to assign them local IP addresses.Hope this helps! If you have any further questions or need more specific guidance, feel free to ask.

---
### Post 31
Author: Unknown
Date: Unknown

@anav - will do hopefully within this week@VenoyaTasha - did that in my past tests , seems like Azire WigeGuard is using IPv6 as well and then VPN connection wasn't working. But i can try again...Anyway it won't solve the issue with port fwd - they confirmed that on Wireguard is no port FWD working at the moment.Only option to port fwd is using OpenVPN for "specific" IPs / Clients. So basically 2 VPN connections runningAs Mikrotik have issue with OpenVPN, also is not supporting UDP after like 10 years (what i've read). I need to try OpenVPN on TCP connectionGetting bit more complex vs my first idea of working concept on Asus RouterThanks guys

---
### Post 32
Author: Unknown
Date: Unknown

Before i prepare the diagram...Is there easy way how to have 2 groups1. group of IPs (clients) on Internet without VPN2. group of IPs (clients) on Internet with VPNAs some "local" services don't run on abroad IPs - like IPTV for example...Thanks

---
### Post 33
Author: Unknown
Date: Unknown

I always segment groups of user by way of VLANs.The only time this is problematic is for L2 type services  mDSN streaming be it music or whatever........Another method could be by SSID,  if only a wireless requirement where SSID ties into a VLAN.Finally the last ditch method is to create a firewall address list of all like users and then mangle/ mark their traffic.

---
### Post 34
Author: Unknown
Date: Unknown

If you are able to have two vlans, dont worry about some exceptions within the vlans, you stated 5 users may be unique,we can deal with those as well........

---
### Post 35
Author: Unknown
Date: Unknown

Hello,Is such graph enough? or need to be more detailed with client IP range etc?Thanks

---
### Post 36
Author: Unknown
Date: Unknown

Getting there....So the  hapax gets a private WANIP from the  lite beam correct?You basically have limited options due to using unmanaged switches.Below the AXE3, you can only host one flat subnetto the switch to the attached lan clients of the switches  to the cap acXL attached to the switch.The AXE can utilize other subnets to provide to the lan clients directly connected and of course to clients connecting by WIFI to the AX3.I hope you understand these limitations......Thus SOUTH of the axe 3,  lets give all those users VLAN10Thus NORTH of the axe 3,  lets give the directly connected LAN clients VLAN20The directly connected AX3 WIFI clients I assume will be a mix of  VLAN10, VLAN20 and lets add a third vlan  VLAN30 that only the AX3 provides.If this makes sense so far good.Now you have to attribute what traffic each  vlan needs (majority of users within a vlan).Then you have to discuss any exceptions........Or provide more clarity in what you would like to achieve especially if way off base...............

---
### Post 37
Author: Unknown
Date: Unknown

- So the hapax gets a private WANIP from the lite beam correct?lite beam has own IP from provider 10.x.x.x1, hAP AX3 has also IP from provider 10.x.x.x2I agreed with them to have 2 fixed IPs , to be able to manageOtherwise the LiteBeam would become Main router with DMZ to hap AX3I've added devices which i would like to have on VPN:1. WireGuard VPN - no PortFWD possible- Desktop- Mobile2. OpenVPN - due to PortFWD option- NAS3. NonVPN- AndroidTV - due to local country IPTV content (it blocks abroad IPs)- the rest clients ~40+Alternate is to stop using WG VPN protocol  and use only OpenVPN protocol for everything- it's bit slower vs WG- it might not work with Mikrotik - haven't test it yet+ PortFWD availableIn Asus Router was bit simplified i could pick any IPs to be on VPN, without VLAN needed, but i mentioned it alreadyThat's not that simple on Mikrotik, right?----If I understand the idea with VLAN right = seems like problem would be with the "client" location for VPN , basically each client is in some extra layer/VLAN this would lead that All Client (except LAN Clients 02) in that VLAN would be on VPN, so same as is it now - ALL client on VPN (without VLAN).MyNetwork2.jpg

---
### Post 38
Author: Unknown
Date: Unknown

I dont understand why you need port forwarding.Typically port forwarding is done via ones public IP and is required to get through NAT.If you give your user a WIREGUARD peer setting, why cannot they access your servers directly through wireguard?Assuming the reason is that you cannot forward the wireguard port from the ISP device to your device??

---
### Post 39
Author: Unknown
Date: Unknown

PortFWD is needed as i dont have PublicIP from my ProviderVPN over WireGuard doesn't have the PortFWD option, nor Public IP yet, even AzireVPN confirmed they are working on some solutionVPN over OpenVPN offers me PublicIP with PortFWD - confirmed with AzireVPN , that this option is still workingPortFWD is needed to access few Services/Servers hosted on my unRaid serverTorrent and DC++ to be "active" user

---
### Post 40
Author: Unknown
Date: Unknown

Hi,Got suggested that viahttps://help.mikrotik.com/docs/display/ ... ress-listsi might be able to create filter rule in Firewallhttps://help.mikrotik.com/docs/display/ROS/FilterWould that possibly work? for the scenario i need?As changing HW switches to be able to create VLAN just for few devices, is pricy solution which i would like to avoid.Thanks

---
### Post 41
Author: Unknown
Date: Unknown

If you have the right router arm/tile etc  you can use BTHVPN to connect to your network remotely from your smartphone or laptop etc...Looking at your diagram you should replace both switches with manageable switches, and then you can apply vlans throughout your network and isolate all the users/devices as required.

---
### Post 42
Author: Unknown
Date: Unknown

When ready to not use ipv6, as stated can help troubleshoot.In the meantime checkoutPARA7andPARA9(D)--viewtopic.php?t=182340What happened to this page? I often come back to it.

---
