# Thread Information
Title: Untitled Thread
Section: mikrotik_forum
Thread ID: 169518

# Discussion

## Initial Question
Author: Wed Nov 25, 2020 1:01 pm
``` #BlackListAlert:localblackIP;:localsystemName[system identitygetname];:localdateBlock[system clockgetdate];:localtimeBlock[system clockgettime];:localCreateTime;:localSendError0;#SMS-Info:localSmsUsername"MyPannelUser":localSmsPassword"MyPass":localSendMobileNum"5000000000000":localMyNum"+447911120000":localSmsText;:localSmsCount0;#Telegram-Info:localBotToken"720638877:AAFwcEy5n5TN130XXXXXXXXXX-XXXXXXXXX";:localMyID"136000000";:localTelMsg;#Email-Info:localemailAddress"MyMail@gmail.com":localEmailText;:foreachBListIDin=[ip firewall address-list find list="BlackList"]do={:setblackIP[ip firewall address-listget$BListID address];:if([ip firewall address-list findwherelist="BlackListAlert"address=$blackIP]="")do={:setCreateTime[ip firewall address-listget$BListID creation-time];:setTelMsg"$systemName%20Security%20Notice%20-%20$CreateTime%0AThis%20IP%20Address%20Has%20been%20added%20to%20the%20BlackList%20:%0A$blackIP%0A";:setEmailText($EmailText."IP [$blackIP] Has been added to the BlackList at $CreateTime\r\n");if($SmsCount<6)do={:setSmsText($SmsText."$blackIP%20Has%20been%20added%20to%20the%20BlackList%0A");:setSmsCount($SmsCount+1);}:do{tool fetch url="https://api.telegram.org/bot$BotToken/sendmessage?chat_id=$MyID&text=$TelMsg"mode=https keep-result=no;log warn("$systemName Security Notice : $blackIP Has been added to the BlackList at $CreateTime.");ip firewall address-listaddlist="BlackListAlert"address=$blackIP timeout="30d00:00:00";}on-error={log error"$systemName Security Notice : Telegram Alert was not sent.";:setSendError1;}}}:if(($SmsCount>0)&&($SendError=0))do={:do{:setSmsText"$systemName%20Security%20Notice%20:%0A[$dateBlock%20-%20$timeBlock%20]%0A%0A$SmsText"tool fetch ascii=yes mode=https keep-result=nourl="https://SMSPannel.com/SendMessageWithUrl.ashx?Username=$SmsUsername&Password=$SmsPassword&PhoneNumber=$SendMobileNum&MessageBody=$SmsText&RecNumber=$MyNum&Smsclass=1";}on-error={log error"$systemName Security Notice : SMS Alert was not sent.";}}:if([:len $EmailText]>0)do={:do{tool e-mail send to="$emailAddress"subject="$systemName Security Notice"body="$systemName Security Notice\r\nRuning Time: $dateBlock - $timeBlock\r\n\r\n$EmailText"}on-error={log error"$systemName Security Notice : Failed to send email.";}} ``` Hi, I wrote a script that notifies me once a new IP gets added to the router's blacklist, it also adds it into another address list ("BlackListAlert") to prevent repeating notices for the same address.This works fine until I get about 100 IPs in my blacklist and to about 5000 IPs in all my address lists, it then takes about 3-4 minutes to run a single time.Could you please help me optimize (or re-write) this script so the runtime could be reduced?
```
---
```

## Response 1
Author: [SOLVED]Thu Nov 26, 2020 5:03 pm
``` #BlackListAlert:localblackIP;:localsystemName[system identitygetname];:localdateBlock[system clockgetdate];:localtimeBlock[system clockgettime];:localCreateTime;:localSendError0;#SMS-Info:localSmsUsername"MyPannelUser":localSmsPassword"MyPass":localSendMobileNum"5000000000000":localMyNum"+447911120000":localSmsText;:localSmsCount0;#Telegram-Info:localBotToken"720638877:AAFwcEy5n5TN130XXXXXXXXXX-XXXXXXXXX";:localMyID"136000000";:localTelMsg;#Email-Info:localemailAddress"MyMail@gmail.com":localEmailText;:localBlackList[ip firewall address-list findwhere.id list="BlackList"];:localBlackListAlert[ip firewall address-list findwhere.id list="BlackListAlert"];:localAlertIPs;:foreachBListAlertIDin=$BlackListAlertdo={:setAlertIPs($AlertIPs.[ip firewall address-listget$BListAlertID address].";")}:foreachBListIDin=$BlackListdo={:setblackIP[ip firewall address-listget$BListID address];:if(!($AlertIPs~$blackIP))do={:setCreateTime[ip firewall address-listget$BListID creation-time];:setTelMsg"$systemName%20Security%20Notice%20-%20$CreateTime%0AThis%20IP%20Address%20Has%20been%20added%20to%20the%20BlackList%20:%0A$blackIP%0A";:setEmailText($EmailText."IP [$blackIP] Has been added to the BlackList at $CreateTime\r\n");if($SmsCount<6)do={:setSmsText($SmsText."$blackIP%20Has%20been%20added%20to%20the%20BlackList%0A");:setSmsCount($SmsCount+1);}:do{tool fetch url="https://api.telegram.org/bot$BotToken/sendmessage?chat_id=$MyID&text=$TelMsg"mode=https keep-result=no;log warn("$systemName Security Notice : $blackIP Has been added to the BlackList at $CreateTime.");ip firewall address-listaddlist="BlackListAlert"address=$blackIP timeout="30d00:00:00";}on-error={log error"$systemName Security Notice : Telegram Alert was not sent.";:setSendError1;}}}:if(($SmsCount>0)&&($SendError=0))do={:do{:setSmsText"$systemName%20Security%20Notice%20:%0A[$dateBlock%20-%20$timeBlock%20]%0A%0A$SmsText"tool fetch ascii=yes mode=https keep-result=nourl="https://SMSPannel.com/SendMessageWithUrl.ashx?Username=$SmsUsername&Password=$SmsPassword&PhoneNumber=$SendMobileNum&MessageBody=$SmsText&RecNumber=$MyNum&Smsclass=1";}on-error={log error"$systemName Security Notice : SMS Alert was not sent.";}}:if([:len $EmailText]>0)do={:do{tool e-mail send to="$emailAddress"subject="$systemName Security Notice"body="$systemName Security Notice\r\nRuning Time: $dateBlock - $timeBlock\r\n\r\n$EmailText"}on-error={log error"$systemName Security Notice : Failed to send email.";}} ``` Solved