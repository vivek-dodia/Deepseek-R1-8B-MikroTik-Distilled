# Thread Information
Title: Untitled Thread
Section: mikrotik_forum
Thread ID: 212253

# Discussion

## Initial Question
Author: Sun Nov 03, 2024 11:26 pm
``` :localversion"IP-Scanner-arp_v1.0":localnote"Compatible with RouterOS versions 6.45.9 & above":localscanTime"30":localdate[/system clockgetdate]:localname[/system identitygetname]:put"":put"### $version":put"### $note"{# Convert date and time for the file name, needed for ROS version 6:localsimplercurrdatetimestrdo={/system clock:localvdate[getdate]:localvtime[gettime]:localvdoff[:toarray"0, 4, 5, 7, 8, 10"]:localMM[:pick $vdate($vdoff->2)($vdoff->3)]:localM[:tonum $MM]:if($vdate~".../../....")do={:setvdoff[:toarray"7, 11, 1, 3, 4, 6"]:setM([:find"xxanebarprayunulugepctovecANEBARPRAYUNULUGEPCTOVEC"[:pick $vdate($vdoff->2)($vdoff->3)]-1]/2):if($M>12)do={:setM($M-12)}:setMM[:pick(100+$M)13]}:localyyyy[:pick $vdate($vdoff->0)($vdoff->1)]:localdd[:pick $vdate($vdoff->4)($vdoff->5)]:localHH[:pick $vtime02]:localmm[:pick $vtime35]:localss[:pick $vtime68]:return"$MM-$dd-$yyyy_$HH.$mm.$ss"}:localdateTime[$simplercurrdatetimestr]# Gather network address from user & find the interface:delay2s:put"":put"### Listing available address-list":put""/ip addressprint:put"":localrequestvaluedo={:put $1;:return}:localscanRange[$requestvalue"Enter the address of the interface to scan -- Example: 192.168.88.1/24"]:put"":localscanInterface[/ip addressget[findwhereaddress="$scanRange"]interface]:put"### Found interface: $scanInterface":localfileName"$name_IP-Scan_$scanInterface_$dateTime"/fileremove[findwherename=$"fileName".txt]:delay2s# Clear the arp table:put"### Clearing the arp table":localdumplist[/ip arp find]:foreachiin=$dumplistdo={/ip arpremove$i}# Scan the range, get macs, ip addresses, bridge host interface & ether name comments. Do a mac lookup for each item:localipScan"":localbuffer1"":localvendor:localarpCount0:delay2s:put"### Scanning $scanRange for $scanTime seconds. Standby...":put"":delay2s:set$ipScan($ipScan.[/tool ip-scan address-range="$scanRange"duration=$scanTime]):put"### Looking up OUI vendor info. Standby...\r\n"/ip arp:foreachitemin=[findinterface=$scanInterface]do={:localmac[get$item mac-address]:localarpIP[get$item address]:localipScanip"$ipScan$[get $item address]":localipScanmac"$ipScan$[get $item mac-address]":if([:len $mac]>0)do={:do{:localint[/interfacebridge hostget[findwheremac-address=$ipScanmac]interface]:localcomment[/interfaceethernetget[findwherename=$int]comment]:localsecBit[:pick"$ipScanmac"12]:if(($secBit="2")or($secBit="6")or($secBit="A")or($secBit="E"))do={:setvendor"* LOCAL PRIVATE *"}else={:localvendorResult[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 8]."/company/name") as-value output=user] :if (($vendorResult->"status")="finished") do={:set vendor ($vendorResult->"data")} :delay 0.5} :if ($vendor = "IEEERegistrationAuthority") do={ :local vendorResult2 [/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 10]."/company/name") as-value output=user]:if(($vendorResult2->"status")="finished")do={:setvendor($vendorResult2->"data")}:delay0.5}:if($vendor="IEEE Registration Authority")do={:localvendorResult3[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 13]."/company/name") as-value output=user] :if (($vendorResult3->"status")="finished") do={:set vendor ($vendorResult3->"data")} :delay 0.5} :set $buffer1 ($buffer1."IP:$ipScanip|MAC:$ipScanmac|Interface:$int|Comment:$comment|MLU:$vendor\r\n") :set arpCount ($arpCount + 1) } on-error={}; }} # ARP Clean-up /ip arp remove [find where !complete] # Messages :local title "Identity:$name|ScannedInterface:$scanInterface|ScannedRange:$scanRange|Date:$date|Version:$version\r\n" :local detected "### Total devices with an address detected on '$scanInterface': $arpCount"# List the results:put"$detected":put"$buffer1":delay1s# Put the results in a file:put"### Writing to file"/fileprintfile=$fileName:delay1s:execute[/fileset$fileName contents="$title\r\n$detected\r\n$buffer1"]# Instructions:put"### The file: '$fileName' is located in 'Files' (left sidebar menu)":put"### To download the file locally, right click on the file & select download":put"### Be sure to delete the file from this device once it's downloaded locally":put""} ``` Do you need this for ROS v6 or v7?Give this a try
```
---
```

## Response 1
Author: Mon Nov 04, 2024 1:56 am
Hmm, in a quick test it works on my test router using 7.17.It might be the /tool/fetch that does the MAC address lookup that's failing... since that requires policy and test permissions, so if /system/script didn't allow those that be one reason it fail.The on-error={} prevents errors from being shown, so hard to know... In newer V7, using the :onerror err in={} do={} syntax might be better since the script would get the error message.You might try it from the CLI. If type a {, then paste script, and add a close }... and see if runs from there. ---

## Response 2
Author: Mon Nov 04, 2024 2:02 am
``` 192.168.0.37F6:F5:AC:C6:61:E6169ms192.168.0.30E8:F4:08:E8:52:51 ``` 
```
I don't know what the issue is with 192.168.0.30 no time msIt could just be a timing issue (no pun), but the duration= is a hard cutoff, so it could be in the middle of getting the ARP from 192.168.0.30 when the duration= hits.


---
```

## Response 3
Author: Mon Nov 04, 2024 5:46 pm
``` :localversion"IP-Scanner-arp_v1.1.0":localnote"Compatible with RouterOS versions 6.45.9 & above":localscanTime"60":localdate[/system clockgetdate]:localname[/system identitygetname]:put"":put"### $version":put"### $note"{# Convert date and time for the file name, needed for ROS version 6:localsimplercurrdatetimestrdo={/system clock:localvdate[getdate]:localvtime[gettime]:localvdoff[:toarray"0, 4, 5, 7, 8, 10"]:localMM[:pick $vdate($vdoff->2)($vdoff->3)]:localM[:tonum $MM]:if($vdate~".../../....")do={:setvdoff[:toarray"7, 11, 1, 3, 4, 6"]:setM([:find"xxanebarprayunulugepctovecANEBARPRAYUNULUGEPCTOVEC"[:pick $vdate($vdoff->2)($vdoff->3)]-1]/2):if($M>12)do={:setM($M-12)}:setMM[:pick(100+$M)13]}:localyyyy[:pick $vdate($vdoff->0)($vdoff->1)]:localdd[:pick $vdate($vdoff->4)($vdoff->5)]:localHH[:pick $vtime02]:localmm[:pick $vtime35]:localss[:pick $vtime68]:return"$MM-$dd-$yyyy_$HH.$mm.$ss"}:localdateTime[$simplercurrdatetimestr]# Gather network address from user & find the interface:put"":put"### Listing available address-list":put""/ip addressprint:put"":localrequestvaluedo={:put $1;:return}:localscanRange[$requestvalue"Enter the address of the interface to scan -- Example: 192.168.88.1/24"]:put"":localinterface[/ip addressget[findwhereaddress="$scanRange"]interface]:put"### Found interface: $interface":localfileName"$name_IP-Scan_$interface_$dateTime"/fileremove[findwherename=$"fileName".txt]:delay2s# Grab bridge from bridge-host:localintMac[/interfaceget[findwherename=$interface]mac-address]:localscanInterface[/interfacebridge hostget[findwheremac-address=$intMac]bridge]:put"### Found bridge: $scanInterface"# Clear the arp table:put"### Clearing the arp table":localdumplist[/ip arp find]:foreachiin=$dumplistdo={/ip arpremove$i}# Scan the range, get macs, ip addresses, bridge host interface & ether name comments. Do a mac lookup for each item:localipScan"":localbuffer1"":localvendor:localarpCount0:delay2s:put"### Scanning $scanRange for $scanTime seconds. Standby...":put"":delay2s:set$ipScan($ipScan.[/tool ip-scan address-range="$scanRange"duration=$scanTime]):put"### Looking up OUI vendor info. Standby...\r\n"/ip arp:foreachitemin=[findinterface=$"scanInterface"]do={:localmac[get$item mac-address]:localarpIP[get$item address]:localipScanip"$ipScan$[get $item address]":localipScanmac"$ipScan$[get $item mac-address]":if([:len $mac]>0)do={:do{:localint[/interfacebridge hostget[findwheremac-address=$ipScanmac]interface]:localbridge[/interfacebridge hostget[findwheremac-address=$ipScanmac]bridge]:localcomment[/interfaceethernetget[findwherename=$int]comment]:localsecBit[:pick"$ipScanmac"12]:if(($secBit="2")or($secBit="6")or($secBit="A")or($secBit="E"))do={:setvendor"* LOCAL PRIVATE *"}else={:localvendorResult[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 8]."/company/name") as-value output=user] :if (($vendorResult->"status")="finished") do={:set vendor ($vendorResult->"data")} :delay 0.5} :if ($vendor = "IEEERegistrationAuthority") do={ :local vendorResult2 [/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 10]."/company/name") as-value output=user]:if(($vendorResult2->"status")="finished")do={:setvendor($vendorResult2->"data")}:delay0.5}:if($vendor="IEEE Registration Authority")do={:localvendorResult3[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $ipScanmac 0 13]."/company/name") as-value output=user] :if (($vendorResult3->"status")="finished") do={:set vendor ($vendorResult3->"data")} :delay 0.5} :set $buffer1 ($buffer1."IP:$ipScanip|MAC:$ipScanmac|Interface:$int|Comment:$comment|MLU:$vendor\r\n") :set arpCount ($arpCount + 1) } on-error={}; }} # ARP Clean-up /ip arp remove [find where !complete] # Messages :local title "Identity:$name|ScannedBridge:$scanInterface|ScannedRange:$scanRange|Date:$date|Version:$version\r\n" :local detected "### Total devices with an address detected on '$scanInterface': $arpCount"# List the results:put"$detected":put"$buffer1":delay1s# Put the results in a file:put"### Writing to file"/fileprintfile=$fileName:delay1s:execute[/fileset$fileName contents="$title\r\n$detected\r\n$buffer1"]# Instructions:put"### The file: '$fileName' is located in 'Files' (left sidebar menu)":put"### To download the file locally, right click on the file & select download":put"### Be sure to delete the file from this device once it's downloaded locally":put""} ``` Give this a try
```
---
```

## Response 4
Author: Tue Nov 05, 2024 3:12 pm
``` {:localint[/ip addressget[findwhereaddress="192.168.0.2/24"]interface]:localintMac[/interfaceget[findwherename=$int]mac-address]:localintBr[/interfacebridge hostget[findwheremac-address=$intMac]bridge]:localbrInt[/interfacebridge hostget[findwheremac-address=$intMac]interface]:put"$int":put"$intMac":put"$intBr":put"$brInt"} ``` Alright. Run the below. Copy/paste as is & provide the output
```
---
```

## Response 5
Author: Fri Nov 08, 2024 3:03 am
``` ---Leavetheseasis---:put[/tool ip-scan address-range="192.168.0.2/24" duration=50] :put [/ip address get [find where address="192.168.0.2/24"] interface] :put [/interface get [find where name=sfp-sfpplus1] comment] :put [/interface get [find where name=sfp-sfpplus1] mac-address] --- Use the MAC address from the above output for the 2 below --- :put [/interface bridge host get [find where mac-address=MAC FROM ABOVE] bridge] :put [/interface bridge host get [find where mac-address=MAC FROM ABOVE] interface] --- Leave this as is --- :put [ip arp get [find where mac-address=F8:E4:3B:7F:DF:63] interface] ``` Greetings wfburton.Try the below. We'll need to figure out what's failing
```
---
```

## Response 6
Author: Sat Nov 09, 2024 12:55 am
``` :localversion"IP-Scanner-arp_v1.1.3":localnote"Compatible with RouterOS versions 6.45.9 & above":localscanTime"40":localdate[/system clockgetdate]:localname[/system identitygetname]:put"":put"### $version":put"### $note"{# Convert date and time for the file name, needed for ROS version 6:localsimplercurrdatetimestrdo={/system clock:localvdate[getdate]:localvtime[gettime]:localvdoff[:toarray"0, 4, 5, 7, 8, 10"]:localMM[:pick $vdate($vdoff->2)($vdoff->3)]:localM[:tonum $MM]:if($vdate~".../../....")do={:setvdoff[:toarray"7, 11, 1, 3, 4, 6"]:setM([:find"xxanebarprayunulugepctovecANEBARPRAYUNULUGEPCTOVEC"[:pick $vdate($vdoff->2)($vdoff->3)]-1]/2):if($M>12)do={:setM($M-12)}:setMM[:pick(100+$M)13]}:localyyyy[:pick $vdate($vdoff->0)($vdoff->1)]:localdd[:pick $vdate($vdoff->4)($vdoff->5)]:localHH[:pick $vtime02]:localmm[:pick $vtime35]:localss[:pick $vtime68]:return"$MM-$dd-$yyyy_$HH.$mm.$ss"}:localdateTime[$simplercurrdatetimestr]# Gather network address from user & find the interface:put"":put"### Listing available address-list":put""/ip addressprint:put"":localrequestvaluedo={:put $1;:return}:localscanRange[$requestvalue"Enter the address of the interface to scan -- Example: 192.168.88.1/24"]:put"":localinterface[/ip addressget[findwhereaddress="$scanRange"]interface]:put"### Found interface: $interface":localfileName"$name_IP-Scan_$interface_$dateTime"/fileremove[findwherename=$"fileName".txt]:delay2s# Grab bridge from bridge-host:localintMac[/interfaceget[findwherename=$interface]mac-address]:localscanInterface[/interfacebridge hostget[findwheremac-address=$intMac]bridge]:put"### Found bridge: $scanInterface"# Clear the arp table:put"### Clearing the arp table":localdumplist[/ip arp find]:foreachiin=$dumplistdo={/ip arpremove$i}# Scan the range, get macs, ip addresses, bridge host interface & ether name comments. Do a mac lookup for each item:localipScan"":localbuffer1"":localvendor:localarpCount0:delay2s:put"### Scanning $scanRange for $scanTime seconds. Standby...":put"":delay2s:set$ipScan($ipScan.[/tool ip-scan address-range="$scanRange"duration=$scanTime]):put"### Looking up OUI vendor info. Standby...\r\n"/ip arp:foreachitemin=[findinterface=$"scanInterface"]do={:localmac[get$item mac-address]:localarpIP[get$item address]:localipScanip"$ipScan$[get $item address]":localipScanmac"$ipScan$[get $item mac-address]":if([:len $mac]>0)do={:do{:localint[/interfacebridge hostget[findwheremac-address=$mac]interface]:localcomment[/interfaceget[findwherename=$int]comment]:localsecBit[:pick"$mac"12]:if(($secBit="2")or($secBit="6")or($secBit="A")or($secBit="E"))do={:setvendor"* LOCAL PRIVATE *"}else={:localvendorResult[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $mac 0 8]."/company/name") as-value output=user] :if (($vendorResult->"status")="finished") do={:set vendor ($vendorResult->"data")} :delay 0.5} :if ($vendor = "IEEERegistrationAuthority") do={ :local vendorResult2 [/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $mac 0 10]."/company/name") as-value output=user]:if(($vendorResult2->"status")="finished")do={:setvendor($vendorResult2->"data")}:delay0.5}:if($vendor="IEEE Registration Authority")do={:localvendorResult3[/tool fetch url=("https://api.maclookup.app/v2/macs/".[:pick $mac 0 13]."/company/name") as-value output=user] :if (($vendorResult3->"status")="finished") do={:set vendor ($vendorResult3->"data")} :delay 0.5} :set $buffer1 ($buffer1."IP:$arpIP|MAC:$mac|Interface:$int|Comment:$comment|MLU:$vendor\r\n") :set arpCount ($arpCount + 1) } on-error={}; }} # ARP Clean-up /ip arp remove [find where !complete] # Messages :local title "Identity:$name|ScannedBridge:$scanInterface|ScannedRange:$scanRange|Date:$date|Version:$version\r\n" :local detected "### Total devices with an address detected on '$scanInterface': $arpCount"# List the results:put"$detected":put"$buffer1":delay1s# Put the results in a file:put"### Writing to file"/fileprintfile=$fileName:delay1s:execute[/fileset$fileName contents="$title\r\n$detected\r\n$buffer1"]# Instructions:put"### The file: '$fileName' is located in 'Files' (left sidebar menu)":put"### To download the file locally, right click on the file & select download":put"### Be sure to delete the file from this device once it's downloaded locally":put""} ``` According to the outputs that you provided, I'm not sure why it's failing. Those are what it needs to find & get it's data.Give this a try