# Thread Information
Title: Thread-213057
Section: RouterOS
Thread ID: 213057

# Discussion

## Initial Question
Hi guys!I'm having issue on a setup: I have a field machine that has a web server integrated in it. I have connected this machine to a SXT LTE6 to get it online, but thanks god Vodafone only gives me a private IP, hence my problem...I configured at my office a hAP ax3 with a public, but dynamic IP to be a WireGuard Server, probably I will have more clients in the future...So, right now:- I have my tunnel up and running;- I can ping from my machine the anything in my office LAN (PC and hAP ax3);- I can ping from any office PC the field LAN (machine and SXT LTE6);- I can access my office PC's web server from WAN by port forwarding it accordingly (XXXXXX.ns.mynetname.net:portnumber_chosen) - RIGHT NOW NOT SEEN IN THE EXPORT!- I can see the machine's website accessing it from the office LAN (192.168.1.1:80);I need to access from the WAN the web server of the machine but my brain right now (after 3 nights with no sleep) is refusing to function properly... On the map belowROADWARRIOR IS NAMED INCORRECTLY, as this random PC is not connected trough VPN, it's just a random PC or cellphone with a web browser...The two configs are of a clean installs, because I had to start from scratch...Any advise would be appreciated if it is with helping intentions, maybe appreciating my efforts until now...hAP ax3:
```
/userset[find name=admin]password=MyPassword/interfacewifiset[finddefault-name=wifi1]disabled=nochannel.skip-dfs-channels=10min-cac configuration.mode=ap.ssid=FedebX.country=Hungarysecurity.authentication-types=wpa2-psk,wpa3-psk.passphrase=MyPassword.ft=yes.ft-over-ds=yes/interfacewifiset[finddefault-name=wifi2]disabled=nochannel.skip-dfs-channels=10min-cac configuration.mode=ap.ssid=Fedeb.country=Hungarysecurity.authentication-types=wpa2-psk,wpa3-psk.passphrase=MyPassword.ft=yes.ft-over-ds=yes/interfacewifiaddconfiguration.mode=ap.ssid="FedebX guests"disabled=nomac-address=F6:1E:57:4E:E0:20master-interface=wifi1 name=wifi3 security.authentication-types=wpa2-psk,wpa3-psk.passphrase=MyPassword/interfacewifiaddconfiguration.mode=ap.ssid=Fedeb_IoTdisabled=nomac-address=F6:1E:57:4E:E0:21master-interface=wifi2 name=wifi4 security.authentication-types=wpa2-psk,wpa3-psk.passphrase=MyPassword/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether1 name=pppoe-out1use-peer-dns=yes user=MyUserpassword=MyPassword/ip dhcp-clientadddisabled=yesinterface=ether1/interfacebridgeaddadmin-mac=F4:1E:57:4E:E0:1Cauto-mac=noname=bridge/interfacebridge portaddbridge=bridgeinterface=ether2addbridge=bridgeinterface=ether3addbridge=bridgeinterface=ether4addbridge=bridgeinterface=ether5addbridge=bridgeinterface=wifi1addbridge=bridgeinterface=wifi2addbridge=bridgeinterface=wifi3addbridge=bridgeinterface=wifi4/interfacebridge filteraddaction=drop chain=forwardin-interface=wifi3addaction=drop chain=forwardout-interface=wifi3addaction=drop chain=forwardin-interface=wifi4addaction=drop chain=forwardout-interface=wifi4/interfacelistaddname=WANaddname=LAN/interfacelist memberaddinterface=bridge list=LANaddinterface=ether1 list=WANaddinterface=pppoe-out1 list=WAN/ip addressaddaddress=192.168.0.1/24interface=bridge network=192.168.0.0/ip pooladdname=dhcp ranges=192.168.0.2-192.168.0.54/ip dhcp-server networkaddaddress=192.168.0.0/24dns-server=192.168.0.1gateway=192.168.0.1netmask=24/ip dhcp-serveraddaddress-pool=dhcpinterface=bridge/ip dnssetallow-remote-requests=yes/ip dnsstaticaddaddress=192.168.0.1name=router.lan type=A/ip cloudsetddns-enabled=yes/ip firewall filteraddaction=accept chain=input dst-port=80protocol=tcpaddaction=accept chain=input dst-port=443protocol=tcpaddaction=accept chain=input connection-state=established,related,untrackedaddaction=accept chain=input protocol=icmpaddaction=drop chain=input connection-state=invalidaddaction=accept chain=input dst-address=127.0.0.1addaction=drop chain=inputin-interface-list=!LANaddaction=accept chain=forward ipsec-policy=in,ipsecaddaction=accept chain=forward ipsec-policy=out,ipsecaddaction=fasttrack-connection chain=forward connection-state=established,related hw-offload=yesaddaction=accept chain=forward connection-state=established,related,untrackedaddaction=drop chain=forward connection-state=invalidaddaction=drop chain=forward connection-nat-state=!dstnat connection-state=newin-interface-list=WAN/ip firewall nataddaction=masquerade chain=srcnat ipsec-policy=out,noneout-interface-list=WAN/ip firewall filteraddaction=accept chain=input dst-port=13231protocol=udp place-before=1/interfacewireguardaddlisten-port=13231mtu=1420name=WireGuard/interfacelist memberaddinterface=WireGuardlist=LAN/ip addressaddaddress=10.70.70.1/24interface=WireGuardnetwork=10.70.70.0/ip routeadddisabled=nodistance=1dst-address=192.168.1.0/24gateway=WireGuardrouting-table=main scope=30suppress-hw-offload=notarget-scope=10/interfacewireguard peersaddallowed-address=10.70.70.2/32,192.168.1.0/24interface=WireGuardname=Client_1persistent-keepalive=25spublic-key="public_key_from_client(from_SXT_LTE6)"/disk settingssetauto-media-interface=bridgeauto-media-sharing=yesauto-smb-sharing=yesSXT_LTE6:
```

```
/userset[find name=admin]password=MyPassword/interfacelte apnaddapn=standardnet.vodafone.netuse-network-apn=yes/interfacelteset[finddefault-name=lte1]allow-roaming=noapn-profiles=standardnet.vodafone.net band=""network-mode=lte sms-protocol=autosms-read=no/interfacebridgeaddadmin-mac=F4:1E:57:22:EC:D2auto-mac=noname=bridge/interfacebridge portaddbridge=bridgeinterface=ether1addbridge=bridgeinterface=ether2/interfacelistaddname=WANaddname=LAN/interfacelist memberaddinterface=bridge list=LANaddinterface=lte1 list=WAN/ip addressaddaddress=192.168.1.1/24interface=bridge network=192.168.1.0/ip pooladdname=dhcp ranges=192.168.1.2-192.168.1.54/ip dhcp-server networkaddaddress=192.168.1.0/24dns-server=192.168.1.1gateway=192.168.1.1netmask=24/ip dhcp-serveraddaddress-pool=dhcpinterface=bridge/ip dnssetallow-remote-requests=yes/ip dnsstaticaddaddress=192.168.1.1name=router.lan type=A/ip cloudsetddns-enabled=yes/ip firewall filteraddaction=accept chain=input connection-state=established,related,untrackedaddaction=accept chain=input protocol=icmpaddaction=drop chain=input connection-state=invalidaddaction=accept chain=input dst-address=127.0.0.1addaction=drop chain=inputin-interface-list=!LANaddaction=accept chain=forward ipsec-policy=in,ipsecaddaction=accept chain=forward ipsec-policy=out,ipsecaddaction=fasttrack-connection connection-state=established,related hw-offload=yesaddaction=accept chain=forward connection-state=established,related,untrackedaddaction=drop chain=forward connection-state=invalidaddaction=drop chain=forward connection-nat-state=!dstnat connection-state=newin-interface-list=WAN/ip firewall nataddaction=masquerade chain=srcnat ipsec-policy=out,noneout-interface-list=WAN/interfacewireguardaddlisten-port=13231mtu=1420name=WireGuard/interfacelist memberaddinterface=WireGuardlist=LAN/ip addressaddaddress=10.70.70.2/24interface=WireGuardnetwork=10.70.70.0/ip routeadddisabled=nodistance=1dst-address=192.168.0.0/24gateway=WireGuardrouting-table=main scope=30suppress-hw-offload=notarget-scope=10/interfacewireguard peersaddallowed-address=10.70.70.1/32,192.168.0.0/24endpoint-address=xxxxx.sn.mynetname.net endpoint-port=13231interface=WireGuardname=peer1 persistent-keepalive=25spublic-key="public_key_from_server(from_hAP_ax3)"

---
```

## Response 1
Good news. Public IP on main router allows many things.a. remote road warrior or you as admin to access Main router via wireguardb. remote machine behind private IP can reach wireguard (using LTE as wireguard client router)+++++++++++++++++++++via the main routerc. admin while remote can reach both LTE for config and machine on LAN and webserverd. any wg user can reach webserver firewall rules permitting.++++++++++++++++++++++Do not undertand the port forward request if you or assigned wg users on the main router or road warrior can reach the machine via LANIP after reaching the LTE via wireguard???Now, if you intent is for people to reach the WEBSERVER via the main router public IP, and port forward from there, that is also doable.The question to answer ........... does the webserver need to record the source IP of each user coming in, or doesnt matter as long as it processes the request properly.If not, then we simply sourcenat all the traffic coming from port forwarding to the IP address of the WG at the main router and thats all the LTE will see coming in heading for the webserver.Fairly simple to do!!They key is a port forwarding rule no the main router that forwards incoming port traffic for that server to the local lanip address of the server.Couple that with an ip route for that server IP with gateway of the wireguard interface and most is done. ---

## Response 2
Thanks for the quick answer!"or doesnt matter as long as it processes the request properly.If not, then we simply sourcenat all the traffic coming from port forwarding to the IP address of the WG at the main router and thats all the LTE will see coming in heading for the webserver.Fairly simple to do!!They key is a port forwarding rule no the main router that forwards incoming port traffic for that server to the local lanip address of the server.Couple that with an ip route for that server IP with gateway of the wireguard interface and most is done."This is the correct scenario, but I'm lost right now... ---

## Response 3
Step back one.Remember port forwarding is based upon a destination port.So I use the public IP of the connection as the destination address and the dst port/protocol.When that arrives at the main router, the router looks at the NAT rules and sees a corresponding dstnat (port forwarding) rule, then verifies if such traffic ( wan to lan ) is allowed.If so the router forwards the traffic to the TO-ADDRESS listed in the dstnat rule.The above describes any user wanting to reach a server you provide. All they know is the dst port/protoocl and public IP of the connection (IP CLOUD, dyndns url if your public IP is dynamic, or FIXED IP address if your public IP is static --> Even if the static or DYDNS url pointed to your ISP router, thats fine if you can forward ports on your ISP router to your MT router ).The user arrives at your router or ISP router and is sent to the server.We do the same thing, the only difference is that the to-address, to the LAN server is an address on a different router.At the same time we tell the router, (In IP ROUTES ) for that address, use the wireguard interface. Normally the server is on an existing LAN interface, that the router already knows about and already has a route for on the IP route printout ( check it for yourself, all the LAN subnets have a route ).Thus the traffic comes in on the WAN and sent via the tunnel to the remote router. The router receives that traffic basicallly at the LAN level.The router is well aware of the local interface the server is on and has a route for this. As long as your firewall rules allow incoming wiregurd to LAN server IP, the port forwarded traffic will flow to the server.Where it gets tricky is the return traffic, if the incoming source IP was sourcenatted to the wireguard IP address of the main router, then the remote router knows of this subnet ( as the remote router is on the same address subnet schema and thus knows to send the reply back through the tunnel ). However if we do not sourcenat that traffic it could be any public IP that reached the server. To handle the return traffic we would have to get into mangling and routing marks etc.......... ---

## Response 4
Hi Anav, Sorry of getting back so late...I read Your description, and it make logic to me, but I hope that my understanding was correct when I set up the following on my main router in addition to the previous:
```
addaction=accept chain=input dst-port=8081in-interface-list=WAN protocol=tcpaddaction=dst-nat chain=dstnat dst-port=8081protocol=tcp to-addresses=192.168.1.54to-ports=80Regarding mangling I have to read more, because that is absolutely new for me...All indications to what to focus on are welcome big time!!Thanks,Ede

---
```

## Response 5
@edepalos, So, right now:- I have my tunnel up and running;- I can ping from my machine the anything in my office LAN (PC and hAP ax3);- I can ping from any office PC the field LAN (machine and SXT LTE6);- I can access my office PC's web server from WAN by port forwarding it accordingly (XXXXXX.ns.mynetname.net:portnumber_chosen) - RIGHT NOW NOT SEEN IN THE EXPORT!- I can see the machine's website accessing it from the office LAN (192.168.1.1:80);ok.- office is ax3, wg server, internet, assuming internal 10.0/24.- field is sxt, wg client, machine webui, assuming internal 11.0/24.- office and field already connected.- you want to connect machine webui from the internet.solution1. the easy way, but probably not a good idea.have remote desktop at the office pc which opened from the internet. and open your machine webui from office pc.- srcnat masquerade to the internet as usual.- dstnat to the remote desktop pc.on the office router.2. dstnat from the internet directly to field machine webui. at office router. (this is also probably not a good idea)- make sure you can ping that field machine from office lan without difficulties (ie. no nat etc)- make sure the webui machine has 2 default route to the internet :1. via wireguard. set it with lower metric, and2. the non wireguard default route set it with higher metric.- do dstnat at office router, from the internet to machine webui.- don't forget to allow srcnat masquerade from field lan to the internet at office router.3. better solution is to have vpn to office router first from any machine from the internet.have a try and good luck ---