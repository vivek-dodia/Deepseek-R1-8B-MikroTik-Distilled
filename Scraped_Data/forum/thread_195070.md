---
title: Untitled Thread
source_url: https://forum.mikrotik.com/viewtopic.php?f=2&t=195070&p=994214#p994214
crawled_date: 2025-02-02T21:25:11.563588
section: mikrotik_forum
type: forum_thread
---

### Author: Mon Apr 03, 2023 12:30 pm
Date: Unknown

Dears,first message in this forum, so I introduce myself. I currently have one hAP AC2 as router (running ROS 7.8), behind a fiber ONT in Spain.I've sucessfully setup Surfshark Wireguard VPN, and now looking to implement akill switch(if VPN connection is lost, VPN traffic is blackholed). I only have one device in my LAN going through the VPN, rest is non-VPN.I've already gone throughviewtopic.php?p=915137&hilit=kill+switc ... rd#p915137... but I'm not getting it.See my configuration bellow for Mangle - NAT, as well as routing - rules - tables.I guess I'm missing something with rules?Mangle/ip firewall mangleadd action=mark-routing chain=prerouting disabled=yes new-routing-mark=\Surfshark_blackhole passthrough=yes src-address-list=Under_VPNadd action=change-mss chain=forward new-mss=clamp-to-pmtu out-interface=\WG-Surfshark passthrough=yes protocol=tcp tcp-flags=synadd action=set-priority chain=postrouting new-priority=4 out-interface=vlan3 \passthrough=yesadd action=set-priority chain=postrouting new-priority=1 out-interface=\pppoe-out1NAT/ip firewall natadd action=masquerade chain=srcnat comment="defconf: masquerade" \ipsec-policy=out,none out-interface-list=WANadd action=masquerade chain=srcnat comment=masquerade-ovpn src-address=\192.168.76.0/24add action=masquerade chain=srcnat comment="default configuration" \out-interface-list=Vlan2&3add action=masquerade chain=srcnat comment=masq-surfshark out-interface=\WG-SurfsharkROUTE/ip routeadd disabled=no distance=1 dst-address=0.0.0.0/0 gateway=WG-Surfshark \pref-src="" routing-table=Surfshark scope=30 suppress-hw-offload=no \target-scope=10TABLE/routing tableadd disabled=no fib name=SurfsharkRULES/routing ruleadd action=lookup-only-in-table disabled=no interface=bridge src-address=\192.168.87.241/32 table=SurfsharkThanks in advance for your support!Regards,


---
### Author: Wed Aug 09, 2023 3:51 pm
Date: Unknown

```
# RouterOS 7.10.2# model = RB5009UG+S+/interfacebridgeaddingress-filtering=noname=LAN-BRIDGE vlan-filtering=yes/interfacewireguardaddlisten-port=51820mtu=1420name=wireguard-surfshark/interfacevlanaddinterface=LAN-BRIDGE name=GEUST_VLAN vlan-id=30addinterface=LAN-BRIDGE name=TEST_VLAN vlan-id=20/interfacelistaddname=WANaddname=VLANaddname=GUEST_VLAN/interfacewifiwave2 channeladddisabled=nofrequency=2300-7300name=5GHzwidth=20/40/80mhzadddisabled=nofrequency=2300-7300name=2GHzwidth=20/40mhz/interfacewifiwave2 datapathaddbridge=LAN-BRIDGE disabled=noname=GUEST vlan-id=30/interfacewifiwave2 securityaddauthentication-types=wpa3-psk disabled=noname=WPA3 wps=disableaddauthentication-types=wpa2-psk disabled=noname=WPA2 wps=disableaddauthentication-types=wpa2-psk disabled=noname=GUEST wps=disable/interfacewifiwave2 configurationaddcountry="United States"disabled=noname=HOME-5GHzsecurity=WPA3 ssid=\
    HOME-5GHzaddcountry="United States"disabled=noname=HOME-2GHzsecurity=WPA2 ssid=\
    HOME-2GHzaddcountry="United States"datapath=GUEST disabled=noname=GUEST security=\
    GUEST ssid=GUEST/ip pooladdname=dhcp_pool0 ranges=192.168.1.2-192.168.1.254addname=dhcp_pool1 ranges=192.168.20.2-192.168.20.254addname=dhcp_pool2 ranges=192.168.30.2-192.168.30.254/ip dhcp-serveraddaddress-pool=dhcp_pool0interface=LAN-BRIDGE name=dhcp1addaddress-pool=dhcp_pool1interface=TEST_VLAN name=dhcp2addaddress-pool=dhcp_pool2interface=GEUST_VLAN name=dhcp3/routing tableadddisabled=nofib name=surfshark/interfacebridge portaddbridge=LAN-BRIDGEinterface=sfp-sfpplus1addbridge=LAN-BRIDGEinterface=ether2addbridge=LAN-BRIDGEinterface=ether3addbridge=LAN-BRIDGEinterface=ether4addbridge=LAN-BRIDGEinterface=ether5addbridge=LAN-BRIDGEinterface=ether6addbridge=LAN-BRIDGEinterface=ether7addbridge=LAN-BRIDGEinterface=ether8/interfacebridge vlanaddbridge=LAN-BRIDGE tagged=LAN-BRIDGE,ether3 vlan-ids=20addbridge=LAN-BRIDGE tagged=LAN-BRIDGE,ether3,ether8 vlan-ids=30/interfacelist memberaddinterface=ether1 list=WANaddinterface=GEUST_VLAN list=VLANaddinterface=LAN-BRIDGE list=VLANaddinterface=TEST_VLAN list=VLAN/interfacewifiwave2 capsmansetca-certificate=autoenabled=yespackage-path=""require-peer-certificate=\noupgrade-policy=none/interfacewifiwave2 provisioningaddaction=create-dynamic-enabled disabled=nomaster-configuration=HOME-5GHz\
    supported-bands=5ghz-axaddaction=create-dynamic-enabled disabled=nomaster-configuration=HOME-2GHz\
    slave-configurations=GUEST supported-bands=2ghz-n/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=us-chi.prod.surfshark.com \
    endpoint-port=51820interface=wireguard-surfsharkpublic-key=\"DpMfulanF/MVHmt3AX4dqLqcyE0dpPqYBjDlWMaUI00="/ip addressaddaddress=192.168.1.1/24interface=LAN-BRIDGE network=192.168.1.0addaddress=192.168.20.1/24interface=TEST_VLAN network=192.168.20.0addaddress=192.168.30.1/24interface=GEUST_VLAN network=192.168.30.0addaddress=10.14.0.2/16interface=wireguard-surfshark network=10.14.0.0/ip dhcp-clientaddinterface=ether1/ip dhcp-server leaseaddaddress=192.168.1.2client-id=1:48:a9:8a:8b:48:ef comment=AX-AP mac-address=\48:A9:8A:8B:48:EF server=dhcp1addaddress=192.168.30.11client-id=1:0:c:29:f8:91:1bcomment=TEST-CLIENT \
    mac-address=00:0C:29:F8:91:1Bserver=dhcp3/ip dhcp-server networkaddaddress=192.168.1.0/24dns-server=192.168.1.1gateway=192.168.1.1addaddress=192.168.20.0/24gateway=192.168.20.1addaddress=192.168.30.0/24dns-server=162.252.172.57gateway=192.168.30.1/ip dnssetallow-remote-requests=yes/ip firewall address-listaddaddress=192.168.30.11list=GUEST-DEVICE1/ip firewall filteraddaction=accept chain=input comment="ALLOW ESTABLISHED AND RELATED"\
    connection-state=established,relatedaddaction=accept chain=input comment="ALLOW VLAN ACCESS ROUTER SERVICES"\in-interface-list=VLANaddaction=drop chain=input comment=DROPaddaction=accept chain=forward comment="ALLOW ESTABLISHED AND RELATED"\
    connection-state=established,relatedaddaction=accept chain=forward comment="ALL VLANS INTERNET ACCESS ONLY"\
    connection-state=newin-interface-list=VLANout-interface-list=WANaddaction=accept chain=forward comment="ALLOW GUEST VLAN TO WIRESHARK ACCESS"\
    connection-state=newin-interface-list=VLANout-interface=\
    wireguard-surfsharkaddaction=drop chain=forward comment=DROP/ip firewall mangleaddaction=change-mss chain=forwardnew-mss=clamp-to-pmtu passthrough=yes \
    protocol=tcp tcp-flags=synaddaction=mark-routing chain=preroutingnew-routing-mark=surfshark \
    passthrough=nosrc-address-list=GUEST-DEVICE1/ip firewall nataddaction=masquerade chain=srcnatout-interface=ether1addaction=masquerade chain=srcnatout-interface=wireguard-surfshark/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=wireguard-surfshark \
    routing-table=surfshark suppress-hw-offload=no
```

Well I would have to see the context of the entire config, why are you mangling now?Here is my config:Code:Select allSo I use mangle for force traffic into WG tunnel, but If wireguard interface become disabled, it switches to ISP internet, so it isn't a leak or this scenario only possible if I disable the wireguard interface manually?Additional problem: I cannot add subnet (only specific machines ie: 192.168.30.11)Thank You so much


---
### Author: Sat Aug 12, 2023 11:25 am
Date: Unknown

```
# RouterOS 7.10.2# model = RB5009UG+S+/interfacebridgeaddingress-filtering=noname=LAN-BRIDGE vlan-filtering=yes/interfacewireguardaddlisten-port=51820mtu=1420name=wireguard-surfshark/interfacevlanaddinterface=LAN-BRIDGE name=GEUST_VLAN vlan-id=30addinterface=LAN-BRIDGE name=TEST_VLAN vlan-id=20/interfacelistaddname=WANaddname=VLANaddname=GUEST_VLAN/ip pooladdname=dhcp_pool0 ranges=192.168.1.2-192.168.1.254addname=dhcp_pool1 ranges=192.168.20.2-192.168.20.254addname=dhcp_pool2 ranges=192.168.30.2-192.168.30.254/ip dhcp-serveraddaddress-pool=dhcp_pool0interface=LAN-BRIDGE name=dhcp1addaddress-pool=dhcp_pool1interface=TEST_VLAN name=dhcp2addaddress-pool=dhcp_pool2interface=GEUST_VLAN name=dhcp3/routing tableadddisabled=nofib name=surfshark/interfacebridge portaddbridge=LAN-BRIDGEinterface=sfp-sfpplus1addbridge=LAN-BRIDGEinterface=ether2addbridge=LAN-BRIDGEinterface=ether3addbridge=LAN-BRIDGEinterface=ether4addbridge=LAN-BRIDGEinterface=ether5addbridge=LAN-BRIDGEinterface=ether6addbridge=LAN-BRIDGEinterface=ether7addbridge=LAN-BRIDGEinterface=ether8/interfacebridge vlanaddbridge=LAN-BRIDGE tagged=LAN-BRIDGE,ether3 vlan-ids=20addbridge=LAN-BRIDGE tagged=LAN-BRIDGE,ether3,ether8 vlan-ids=30/interfacelist memberaddinterface=ether1 list=WANaddinterface=GEUST_VLAN list=VLANaddinterface=LAN-BRIDGE list=VLANaddinterface=TEST_VLAN list=VLAN/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=us-chi.prod.surfshark.com \
    endpoint-port=51820interface=wireguard-surfsharkpublic-key=\"DpMfulanF/MVHmt3AX4dqLqcyE0dpPqYBjDlWMaUI00="/ip addressaddaddress=192.168.1.1/24interface=LAN-BRIDGE network=192.168.1.0addaddress=192.168.20.1/24interface=TEST_VLAN network=192.168.20.0addaddress=192.168.30.1/24interface=GEUST_VLAN network=192.168.30.0addaddress=10.14.0.2/16interface=wireguard-surfshark network=10.14.0.0/ip dhcp-clientaddinterface=ether1/ip dhcp-server leaseaddaddress=192.168.30.11client-id=1:0:c:29:f8:91:1bcomment=TEST-CLIENT \
    mac-address=00:0C:29:F8:91:1Bserver=dhcp3/ip dhcp-server networkaddaddress=192.168.1.0/24dns-server=192.168.1.1gateway=192.168.1.1addaddress=192.168.20.0/24gateway=192.168.20.1addaddress=192.168.30.0/24dns-server=162.252.172.57gateway=192.168.30.1/ip dnssetallow-remote-requests=yes/ip firewall address-listaddaddress=192.168.30.11list=GUEST-DEVICE1/ip firewall filteraddaction=accept chain=input comment="ALLOW ESTABLISHED AND RELATED"\
    connection-state=established,relatedaddaction=accept chain=input comment="ALLOW VLAN ACCESS ROUTER SERVICES"\in-interface-list=VLANaddaction=drop chain=input comment=DROPaddaction=accept chain=forward comment="ALLOW ESTABLISHED AND RELATED"\
    connection-state=established,relatedaddaction=accept chain=forward comment="ALL VLANS INTERNET ACCESS ONLY"\
    connection-state=newin-interface-list=VLANout-interface-list=WANaddaction=accept chain=forward comment="ALLOW GUEST VLAN TO WIRESHARK ACCESS"\
    connection-state=newin-interface-list=VLANout-interface=\
    wireguard-surfsharkaddaction=drop chain=forward comment=DROP/ip firewall mangleaddaction=change-mss chain=forwardnew-mss=clamp-to-pmtu passthrough=yes \
    protocol=tcp tcp-flags=synaddaction=mark-routing chain=preroutingnew-routing-mark=surfshark \
    passthrough=nosrc-address-list=GUEST-DEVICE1/ip firewall nataddaction=masquerade chain=srcnatout-interface=ether1addaction=masquerade chain=srcnatout-interface=wireguard-surfshark/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=wireguard-surfshark \
    routing-table=surfshark suppress-hw-offload=no
```

Hahah, no I just have a life LOL....I prefer the simpleton approach with  wifi settings that just deal in wifi....The only reason I ever fathomed to use capsman is that one needs to isolate wifi users from landline users in the same subnet, which is rare.Ok then I won't show your comment to my wife, it would ruin my excusesBut if you need to manage 20+ AP-s how you do that without capsman?Ok I turned off wifi settings, so here is my basic setup:Code:Select all


---
### Author: Sun Sep 10, 2023 4:21 pm
Date: Unknown

```
/routing ruleaddaction=lookup-only-in-table disabled=nodst-address=192.168.10.0/24src-address=192.168.9.0/24table=mainaddaction=lookup-only-in-table disabled=nodst-address=192.168.9.0/24src-address=192.168.10.0/24table=main
```

```
/interfacebridgeaddname=BRIDGE-LAN vlan-filtering=yes/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether1 name=ISP user=username533/interfacewireguardaddlisten-port=51820mtu=1420name=WG-NORDVPN/interfacevlanaddinterface=BRIDGE-LAN name=VLAN-LAN_VPN vlan-id=9addinterface=BRIDGE-LAN name=VLAN-TESTvlan-id=10addinterface=BRIDGE-LAN name=VLAN-GUEST vlan-id=100/interfacelistaddname=WANaddname=VLAN/ip pooladdname=POOL-LAN ranges=192.168.1.2-192.168.1.254addname=POOL-LAN_VPN ranges=192.168.9.2-192.168.9.254addname=POOL-TEST ranges=192.168.10.2-192.168.10.254addname=POOL-GUEST ranges=192.168.100.2-192.168.100.254/ip dhcp-serveraddaddress-pool=POOL-LANinterface=BRIDGE-LAN name=DHCP-LANaddaddress-pool=POOL-LAN_VPNinterface=VLAN-LAN_VPN name=DHCP-LAN_VPNaddaddress-pool=POOL-TESTinterface=VLAN-TEST name=DHCP-TESTaddaddress-pool=POOL-GUESTinterface=VLAN-GUEST name=DHCP-GUEST/routing tableadddisabled=nofib name=NORDVPN/interfacebridge portaddbridge=BRIDGE-LANinterface=sfp-sfpplus1addbridge=BRIDGE-LANinterface=ether2addbridge=BRIDGE-LANinterface=ether3 pvid=9addbridge=BRIDGE-LANinterface=ether4 pvid=10addbridge=BRIDGE-LANinterface=ether5addbridge=BRIDGE-LANinterface=ether6addbridge=BRIDGE-LANinterface=ether7 pvid=30addbridge=BRIDGE-LANinterface=ether8/interfacebridge vlanaddbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6 vlan-ids=9addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2 vlan-ids=10addbridge=BRIDGE-LAN tagged=BRIDGE-LAN vlan-ids=20addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether6 vlan-ids=30addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6 vlan-ids=100/interfacelist memberaddinterface=ISPlist=WANaddinterface=VLAN-LAN_VPN list=VLANaddinterface=VLAN-TEST list=VLANaddinterface=VLAN-TEST_SECURE list=VLANaddinterface=VLAN-GUEST list=VLAN/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=217.138.192.35endpoint-port=51820interface=WG-NORDVPNpublic-key="ksadnck34wrbwfjh34b"/ip addressaddaddress=192.168.1.1/24interface=sfp-sfpplus1 network=192.168.1.0addaddress=192.168.10.1/24interface=VLAN-TEST network=192.168.10.0addaddress=192.168.9.1/24interface=VLAN-LAN_VPN network=192.168.9.0addaddress=192.168.100.1/24interface=VLAN-GUEST network=192.168.100.0addaddress=10.5.0.2/24interface=WG-NORDVPN network=10.5.0.0/ip cloudsetddns-enabled=yes/ip dhcp-server networkaddaddress=192.168.1.0/24dns-server=192.168.1.1gateway=192.168.1.1addaddress=192.168.9.0/24dns-server=192.168.9.1gateway=192.168.9.1addaddress=192.168.10.0/24dns-server=192.168.10.1gateway=192.168.10.1addaddress=192.168.100.0/24dns-server=192.168.100.1gateway=192.168.100.1/ip dnssetallow-remote-requests=yes servers=103.86.96.100/ip firewall filteraddaction=drop chain=input comment="BLOCK WAN SIDE DNS REQUEST"dst-port=53in-interface=ISP protocol=tcpaddaction=accept chain=input comment="ALLOW LAN ACCESS ROUTER SERVICES"src-address=192.168.1.0/24addaction=accept chain=input comment="ALLOW ESTABLISHED AND RELATED CONNECTIONS"connection-state=established,relatedaddaction=accept chain=input comment="ALLOW VLANS ACCESS ROUTER SERVICES"in-interface-list=VLANaddaction=drop chain=input comment="DROP ANYTHING ELSE"disabled=yesaddaction=accept chain=forward comment="ALLOW LAN TRAFFIC TO EVERYWHERE"src-address=192.168.1.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM LAN_VPN TO LAN"dst-address=192.168.1.0/24src-address=192.168.9.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM LAN_VPN TO LAN_VPN"dst-address=192.168.10.0/24src-address=192.168.9.0/24addaction=accept chain=forward comment="ALLOW ESTABLISHED AND RELATED CONNECTIONS"connection-state=established,relatedaddaction=accept chain=forward comment="ALLOW VLANS NORDVPN ACCESS"connection-state=newin-interface-list=VLANout-interface=WG-NORDVPNaddaction=drop chain=forward comment="DROP ANYTHING ELSE"disabled=yes/ip firewall mangleaddaction=change-mss chain=forwardnew-mss=clamp-to-pmtu passthrough=yes protocol=tcp tcp-flags=syn/ip firewall nataddaction=masquerade chain=srcnat comment=NAT-ISPout-interface=ISPaddaction=masquerade chain=srcnat comment=NAT-VPNout-interface=WG-NORDVPN/ip routeadddisabled=nodistance=5dst-address=0.0.0.0/0gateway=WG-NORDVPN pref-src=""routing-table=NORDVPN scope=30suppress-hw-offload=notarget-scope=10/routing ruleaddaction=lookup-only-in-table comment="KEEPS LOCAL TRAFFIC POSSIBLE"disabled=nodst-address=192.168.0.0/16table=mainaddaction=lookup-only-in-table comment="REDIRECT VLAN-LAN_VPN TRAFFIC VIA NORDVPN"disabled=nosrc-address=192.168.9.0/24table=NORDVPNaddaction=lookup-only-in-table comment="REDIRECT VLAN-TEST TRAFFIC VIA NORDVPN"disabled=nosrc-address=192.168.10.0/24table=NORDVPNaddaction=lookup-only-in-table comment="REDIRECT VLAN-GUEST TRAFFIC TO NORDVPN"disabled=nosrc-address=192.168.100.0/24table=NORDVPN
```

Do  you have a forward chain rule allowing access to server??Typically if  you have vlans you need a rule.add chain=forward action=accept  in-interface-list=VLAN  dst-address=server_IPYou could narrow this down to just one subnet to the server or a list of allowed LANIPs to the server.Ok I give upIf I add these rules its works perfect (ping and can reach from 192.168.9.0/24 the 192.168.10.2), without it stops working:Code:Select allHere are my settings:Code:Select all


---
### Author: Tue Sep 12, 2023 10:11 am
Date: Unknown

```
/interfacebridgeaddname=BRIDGE-LAN vlan-filtering=yes/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether1 name=ISP user=username532/interfacewireguardaddlisten-port=51820mtu=1420name=WG-NORDVPN/interfacevlanaddinterface=BRIDGE-LAN name=VLAN-LAN_VPN vlan-id=9addinterface=BRIDGE-LAN name=VLAN-DEVICES vlan-id=10addinterface=BRIDGE-LAN name=VLAN-NO_INTERNET vlan-id=20addinterface=BRIDGE-LAN name=VLAN-TEST vlan-id=30addinterface=BRIDGE-LAN name=VLAN-GUEST vlan-id=100/interfacelistaddname=WANaddname=VLAN/ip pooladdname=POOL-LAN ranges=192.168.3.2-192.168.3.254addname=POOL-LAN_VPN ranges=192.168.9.2-192.168.9.254addname=POOL-DEVICES ranges=192.168.10.2-192.168.10.254addname=POOL-NO_INTERNET ranges=192.168.20.2-192.168.20.254addname=POOL-TEST ranges=192.168.30.2-192.168.30.254addname=POOL-GUEST ranges=192.168.100.2-192.168.100.254/ip dhcp-serveraddaddress-pool=POOL-LANinterface=BRIDGE-LAN name=DHCP-LANaddaddress-pool=POOL-LAN_VPNinterface=VLAN-LAN_VPN name=DHCP-LAN_VPNaddaddress-pool=POOL-DEVICESinterface=VLAN-DEVICES name=DHCP-DEVICESaddaddress-pool=POOL-NO_INTERNETinterface=VLAN-NO_INTERNET name=DHCP-NO_INTERNETaddaddress-pool=POOL-TESTinterface=VLAN-TEST name=DHCP-TESTaddaddress-pool=POOL-GUESTinterface=VLAN-GUEST name=DHCP-GUEST/routing tableadddisabled=nofib name=NORDVPN/interfacebridge portaddbridge=BRIDGE-LANinterface=sfp-sfpplus1addbridge=BRIDGE-LANinterface=ether2addbridge=BRIDGE-LANinterface=ether3 pvid=9addbridge=BRIDGE-LANinterface=ether4 pvid=10addbridge=BRIDGE-LANinterface=ether5addbridge=BRIDGE-LANinterface=ether6addbridge=BRIDGE-LANinterface=ether7 pvid=30addbridge=BRIDGE-LANinterface=ether8/interfacebridge vlanaddbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6 vlan-ids=9addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2 vlan-ids=10addbridge=BRIDGE-LAN tagged=BRIDGE-LAN vlan-ids=20addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether6 vlan-ids=30addbridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6 vlan-ids=100/interfacelist memberaddinterface=ISP list=WANaddinterface=VLAN-LAN_VPN list=VLANaddinterface=VLAN-DEVICES list=VLANaddinterface=VLAN-NO_INTERNET list=VLANaddinterface=VLAN-TEST list=VLANaddinterface=VLAN-GUEST list=VLAN/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=123.45.67.89endpoint-port=51820interface=WG-NORDVPNpublic-key="1a2b3c4d5e6f6g7h8i9j"/ip addressaddaddress=192.168.3.1/24interface=sfp-sfpplus1 network=192.168.3.0addaddress=192.168.30.1/24interface=VLAN-TEST network=192.168.30.0addaddress=192.168.10.1/24interface=VLAN-DEVICES network=192.168.10.0addaddress=192.168.20.1/24interface=VLAN-NO_INTERNET network=192.168.20.0addaddress=192.168.9.1/24interface=VLAN-LAN_VPN network=192.168.9.0addaddress=192.168.100.1/24interface=VLAN-GUEST network=192.168.100.0addaddress=10.5.0.2/24interface=WG-NORDVPN network=10.5.0.0/ip cloudsetddns-enabled=yes/ip dnssetallow-remote-requests=yes servers=103.86.96.100/ip firewall filteraddaction=drop chain=input comment="BLOCK WAN SIDE DNS REQUEST"dst-port=53in-interface=ISP protocol=tcpaddaction=accept chain=input comment="ALLOW LAN ACCESS ROUTER SERVICES"src-address=192.168.3.0/24addaction=accept chain=input comment="ALLOW ESTABLISHED AND RELATED CONNECTIONS"connection-state=established,relatedaddaction=accept chain=input comment="ALLOW VLANS ACCESS ROUTER SERVICES"in-interface-list=VLANaddaction=drop chain=input comment="DROP ANYTHING ELSE"addaction=accept chain=forward dst-address=192.168.10.2in-interface-list=VLANaddaction=accept chain=forward comment="ALLOW LAN TRAFFIC TO EVERYWHERE"src-address=192.168.3.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM LAN_VPN TO LAN"dst-address=192.168.3.0/24src-address=192.168.9.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM LAN_VPN TO DEVICES"dst-address=192.168.10.0/24src-address=192.168.9.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM LAN_VPN TO TEST"dst-address=192.168.30.0/24src-address=192.168.9.0/24addaction=accept chain=forward comment="ALLOW TRAFFIC FROM DEVICES TO LAN_VPN"dst-address=192.168.9.0/24src-address=192.168.10.0/24addaction=accept chain=forward comment="ALLOW ESTABLISHED AND RELATED CONNECTIONS"connection-state=established,relatedaddaction=accept chain=forward comment="ALLOW VLANS NORDVPN ACCESS"connection-state=newin-interface-list=VLANout-interface=WG-NORDVPNaddaction=drop chain=forward comment="DROP ANYTHING ELSE"/ip firewall mangleaddaction=change-mss chain=forwardnew-mss=clamp-to-pmtu passthrough=yes protocol=tcp tcp-flags=syn/ip firewall nataddaction=masquerade chain=srcnat comment=NAT-ISPout-interface=ISPaddaction=masquerade chain=srcnat comment=NAT-VPNout-interface=WG-NORDVPN/ip routeadddisabled=nodistance=5dst-address=0.0.0.0/0gateway=WG-NORDVPN pref-src=""routing-table=NORDVPN scope=30suppress-hw-offload=notarget-scope=10/ip servicesettelnet disabled=yessetftp disabled=yessetwww disabled=yessetssh disabled=yessetapi disabled=yessetapi-ssl disabled=yes/routing ruleaddaction=lookup-only-in-table comment="KEEPS LOCAL TRAFFIC POSSIBLE"disabled=nodst-address=192.168.0.0/16table=mainaddaction=lookup-only-in-table disabled=nodst-address=192.168.3.0/24table=mainaddaction=lookup-only-in-table disabled=nodst-address=192.168.9.0/24table=mainaddaction=lookup-only-in-table disabled=nodst-address=192.168.10.0/24table=mainaddaction=lookup-only-in-table disabled=nodst-address=192.168.30.0/24table=mainaddaction=lookup-only-in-table comment="REDIRECT VLAN-LAN_VPN TRAFFIC VIA NORDVPN"disabled=nosrc-address=192.168.9.0/24table=NORDVPNaddaction=lookup-only-in-table comment="REDIRECT VLAN-DEVICES TRAFFIC VIA NORDVPN"disabled=nosrc-address=192.168.10.0/24table=NORDVPNaddaction=lookup-only-in-table comment="REDIRECT VLAN-TEST TRAFFIC TO NORDVPN"disabled=nosrc-address=192.168.30.0/24table=NORDVPNaddaction=lookup-only-in-table comment="REDIRECT VLAN-GUEST TRAFFIC TO NORDVPN"disabled=nosrc-address=192.168.100.0/24table=NORDVPN
```

Post full config/export file=anynameyouwish ( minus router serial #,  any public WANIP information, keys etc.)Here are my latest settings:Code:Select all


---
### Author: Tue Sep 12, 2023 2:23 pm
Date: Unknown

(1)   Your sffplus setup is hosed and is the core of your issues.  Why do you NOT make it a vlan?You can elect to not do so, but then why do you have it on the bridge........ MAkes no sense........So either make 192.168.3.0/24 another vlan on the bridge orremove this line./interface bridge portadd bridge=BRIDGE-LAN interface=sfp-sfpplus1(2)   Personal preference to make /interface bridge vlan settings clearer so they match bridge ports and are shown on the config export!Also when doing this it became clear that you forgot to tag a port for vlan id 20??/interface bridge vlanadd bridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6untagged=ether3vlan-ids=9add bridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2untagged=ether4vlan-ids=10add bridge=BRIDGE-LAN tagged=BRIDGE-LAN,???????vlan-ids=20add bridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether6untagged=ether7vlan-ids=30add bridge=BRIDGE-LAN tagged=BRIDGE-LAN,ether2,ether6  vlan-ids=100(3) MISSINGpersistent keep aliveon MT peer settings for nordvpn(4)  The route for NORDVPN does not require distance setting of 5, default of 1 is fine.(5) DID NORDVPN give you any other information like DNS address ????(6) Why did you choose DNS server 103.86.96.100 ?(7)   Looking at firewall rules I am puzzled as the logic is missing.I understand allowing all to a specific server   OKAYI  understand allowing all from 192.168.3.0 vlan to all other vlans - I assume you are on that vlan and thus as admin want access to all vlans.(See option 2 in firewall rules below for better way to do this)WHAT I DONT UNDERSTAND is allow all of vlan9  to 192.168.3    IF FULL access goes both ways, then ONLY HAVE ONE SUBNET ???WHAT I DONT UNDERSTAND is allow all of vlan9 to vlan 10 and all of vlan10 to vlan9 ,  WHY NOT JUST HAVE ONE SUBNET ???(8) Firewall rules NEED WORK should look like./ip firewall address-listadd address=admin-IP1 list=Admincomment="admin desktop"add address=admin-IP2 list=Admin comment="admin laptop"add address=admin-IP2 list=Admin comment="admin smartphone"/ip firewall filter{Input Chain}add action=accept chain=input comment="defconf: accept established,related,untracked" connection-state=established,related,untrackedadd action=drop chain=input comment="defconf: drop invalid" connection-state=invalidadd action=accept chain=input comment="defconf: accept ICMP" protocol=icmpadd action=accept chain=input comment="defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1add action=accept chain=input  src-address-list=Adminadd action=accept chain=input comment="Allow LAN DNS queries-UDP" \dst-port=53 in-interface-list=VLAN protocol=udpadd action=accept chain=input comment="Allow LAN DNS queries - TCP" \dst-port=53 in-interface-list=VLAN protocol=tcpadd action=drop chain=input comment="drop all else"{forward chainadd action=fasttrack-connection chain=forward comment="defconf: fasttrack" connection-state=established,relatedadd action=accept chain=forward comment="defconf: accept established,related, untracked" connection-state=established,related,untrackedadd action=drop chain=forward comment="defconf: drop invalid" connection-state=invalidadd action=accept chain=forward comment="server traffic"  in-interface-list=VLAN  dst-address=192.168.10.2add action=accept chain=forward comment="admin-access"  src-address-list=Admin  out-interface-list=VLANadd action=accept chain=forward comment="internet traffic" in-interface-list=VLAN  out-interface-list=WANadd action=accept chain=forward comment="wireguard traffic" in-interface-list=VLAN  out-interface=WG-NORDVPNadd action=accept chain=forward comment="port forwarding" connection-nat-state=dstnatadd action=drop chain=forward comment="drop all else"


---
### Author: Tue Sep 12, 2023 5:24 pm
Date: Unknown

(1)   Your sffplus setup is hosed and is the core of your issues.  Why do you NOT make it a vlan?You can elect to not do so, but then why do you have it on the bridge........ MAkes no sense........So either make 192.168.3.0/24 another vlan on the bridge orremove this line./interface bridge portadd bridge=BRIDGE-LAN interface=sfp-sfpplus1I wanted to create a network outside from VLANS if I mess something and I lock out myself accidentally, but I doubt that specific interface causes the problem. Why would it? It just an iterface or am I missing something?I tried to delete it and nothing changed, still not works without extra route rules.(2)   Personal preference to make /interface bridge vlan settings clearer so they match bridge ports and are shown on the config export!Also when doing this it became clear that you forgot to tag a port for vlan id 20??VLAN20 is not in use yet so this is why I didn't set, at this point I stucked with routing issue.(3) MISSINGpersistent keep aliveon MT peer settings for nordvpnShould I set and why? I read the spec but I thought I need to leave unset.(4)  The route for NORDVPN does not require distance setting of 5, default of 1 is fine.You right, I set back to 1, that was only a previous setting when I tried several routing "type".(5) DID NORDVPN give you any other information like DNS address ????(6) Why did you choose DNS server 103.86.96.100 ?These setting is from NordVPN, I didn't wanted my ISP's nor google.If everything is ok with routing and testing, I think I'll set quad9 DoH.(7)   Looking at firewall rules I am puzzled as the logic is missing.(See option 2 in firewall rules below for better way to do this)I'll do as you adviced.WHAT I DONT UNDERSTAND is allow all of vlan9  to 192.168.3    IF FULL access goes both ways, then ONLY HAVE ONE SUBNET ???WHAT I DONT UNDERSTAND is allow all of vlan9 to vlan 10 and all of vlan10 to vlan9 ,  WHY NOT JUST HAVE ONE SUBNET ???Because I'm just testing why it doesn't working, and I didn't leased my IPs thats why I gave full access, at the end of my learning curve I'll set static IPs and I allow access between specific devices only not whole subnets.(8) Firewall rules NEED WORK should look like.Ok I see what is wrong my rules thank you for simplifying.


---
### Author: Tue Sep 12, 2023 6:27 pm
Date: Unknown

(1)Yes, you need persistent keep alive at the client which is MT(2)  Okay understood about getting locked out....but the concept is wrong, the problem is not vlans but the BRIDGE.......... Nothing wrong with dedicating a port to this effect but it then SHOULD NOT BE A PORT ON THE BRIDGE!!!what I do is take an unused port and simply give it an IP address nothing else, and then I can always log into the port by setting the ipv4 settings on my laptop and am in.Let me know which way you want to go.a. separate port for emergency access but not a LAN, and add another subnet/vlan to the bridge as your normal LAN subnet.b. separate port for LAN usage  BUT not on bridge.Then we can massage config appropriately.(3)  WHERE ARE YOUR  /ip dchp-server network config settings????Assuming that you failed to provided them vice missing, booooTry this:  For all subnets going out Wireguard./ip dhcp-server networkadd address=192.168.X.X/24dns-server=103.86.96.100gateway=192.168.X.1For rest of config use:add address=192.168.xx.y/24  dns-server=192.168.xx.1  gateway=192.168.xx.1//ip dnsset allow-remote-requests=yes servers=9.9.9.9Are there any vlans or subnets going out local WAN ever?? fall back position if wireguard not available etc.....

