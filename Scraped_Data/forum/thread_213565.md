---
title: Thread-213565
url: https://forum.mikrotik.com/viewtopic.php?t=213565&sid=49f92a630bc7970d8ca50523be880e8f
thread_id: 213565
section: RouterOS
post_count: 10
date_crawled: 2025-02-03T14:08:47.873815
---

### Post 1
Author: Unknown
Date: Unknown

Hi,I created a WireGuard interface, configured a peer, configured outgoing NAT (masquerade), added a new IP address (Mullvad) and bound it to the Wireguard interface created before. When adding a route with destination address 0.0.0.0/0 and gateway WireGuard interface, all traffic is routed through the tunnel, so the tunnel itself is working as expected.But I am unable to route only certain traffic through that tunnel with the help of mangle rules and routing marks.This is how I tried to do that:I created an address list INTERNAL_NET for the internal network to make sure it is not routed through the tunnelCode:Select all/ip/firewall/mangle/addchain=prerouting dst-address-list=INTERNAL_NET action=mark-connectionnew-connection-mark=no-vpn/ip/firewall/mangle/addchain=prerouting connection-mark=no-vpn action=acceptI created a routing table, routing rule, default route and mangling for a routing mark:Code:Select all/routing/table/addname=rout-mullvad fib/routing/rule/addaction=lookup-only-in-table table=rout-mullvad routing-mark=rout-mullvad/ip/route/addgateway=WIREGUARD-IF dst-address=0.0.0.0/0routing-table=rout-mullvad/ip/firewall/mangle/addchain=prerouting action=mark-routingnew-routing-mark=rout-mullvadAs soon as the mangle rule to for the routing mark is enabled, the host I use for testing is not able to access anything through the tunnel anymore. There is nothing dropped in the firewall filter rules. Logging shows that the mangle rule for the routing mark is actually marking the package.Does anybody know what I am doing wrong?Is there any logging I should enable to see what goes wrong during routing?Best regards,cyb

---
### Post 2
Author: Unknown
Date: Unknown

If I got your intention correctly and you want to send all traffic except that for the "internal networks" via the Wireguard tunnel, remove all the three mangle prerouting rules and use a single one instead:/ip/firewall/mangle/add chain=prerouting dst-address-list=!INTERNAL_NET action=mark-routing new-routing-mark=rout-mullvad. In addition, you also have to add the LAN subnet where the test client is located to the INTERNAL_NET list, otherwise the router would send the responses that just came through the Wireguard interface back to it.Also the routing rule that translates routing mark rout-mullvad to routing table name rout-mullvad is not necessary for IPv4, this mapping is automatic.The only tool that allows you to see the outcome of routing is/tool sniffer, but it only shows packets that got sent somewhere at all, i.e. if a packet gets routed via interface X but a firewall filter forbids it to leave through that interface, the sniffer will obviously not show it.

---
### Post 3
Author: Unknown
Date: Unknown

Suggest full config for review is optimal, not into guessing./file=anynameyouwish (minus router serial number, any public WANIP information, keys etc. )

---
### Post 4
Author: Unknown
Date: Unknown

@sindy: Thanks a lot for your comments and recommendations. I adjusted my config accordingly (replaced three mangle prerouting rules with a single rule, removed routing rule). But it did actually not change anything.This is my current config for the wireguard-handling (only the explicitly added configuration to the "normal" existing config used for several years now):Code:Select all/interfacewireguardaddlisten-port=37215mtu=1420name=WIREGUARD-IF/interfacewireguard peersaddallowed-address=0.0.0.0/0endpoint-address=removed endpoint-port=\3064interface=WIREGUARD-IF name=peer-WIREGUARD-IFpublic-key=\"removed"/interfacelistaddname=MULLVAD_VLANs/interfacelist memberaddinterface=vlan-clt list=MULLVAD_VLANs/ip addressaddaddress=removed(private-ip)comment="internal address for WIREGUARD-IF"\interface=WIREGUARD-IF network=removed(private-ip)/ip firewall address-listaddaddress=192.168.0.0/16comment=\"route traffic not through wg tunnel for internal nets"list=INTERNAL_NET/ip firewall filteraddaction=drop chain=input comment=\"input chain: drop incoming traffic from wg tunnel"in-interface=\
    WIREGUARD-IFaddaction=drop chain=forward comment=\"forward chain: drop incoming traffic from wg tunnel"\
    connection-nat-state=!dstnat connection-state=newin-interface=\
    WIREGUARD-IF/ip firewall mangleaddaction=mark-routing chain=prerouting comment=\"mark traffic to be routed through wg tunnel"disabled=no\
    dst-address-list=!INTERNAL_NETin-interface-list=MULLVAD_VLANs \
    log-prefix="mark routing:"new-routing-mark=rout-mullvad \
    passthrough=nosrc-address=192.168.2.11/ip firewall nataddaction=masquerade chain=srcnat comment=\"masquerade all outgoing communication to wg tunnel"out-interface=\
    WIREGUARD-IF/routing tableadddisabled=nofib name=rout-mullvad/ip routeaddcomment="rout marked traffic through wg tunnel"disabled=nodistance=1\
    dst-address=0.0.0.0/0gateway=WIREGUARD-IF routing-table=\
    rout-mullvad scope=30suppress-hw-offload=notarget-scope=10@anav: I don't think it makes sense to post the whole configuration (I did in the past:viewtopic.php?p=997349#p997349) - I appreciate if someone is trying to help me by understanding my configuration/problem, but I am sure no one is analyzing the complete configuration.I guess the configuration snippet posted above should be okay and working but actually it is not. As soon as I enable the mangle prerouting rule, the test client 192.168.2.11 (which belongs to INTERNAL_NET) is not able to open any webpage (port 443) anymore. Pinging any destination (outside internal net) is not working either. DNS is still working (because Mikrotik router forwards DNS requests to internal pi-hole).When removing the route described above and instead adding a manual route for the ip address resolving to whatismyip.uno with the gateway=WIREGUARD-IF the client is able to openhttps://whatismyip.uno/which shows an ip address of the country the wireguard tunnel terminates in. So the tunnel, NAT and firewall filters should actually be working fine.I want to have the flexibility to route only certain traffic through the tunnel by using that mangle prerouting rule. But I am not sure how to find the root cause for the problemBest regards,cyb

---
### Post 5
Author: Unknown
Date: Unknown

I don't think it makes sense to post the whole configuration(...)I am sure no one is analyzing the complete configuration.Both wrong, actually. Leaving aside very "beginner basic" issues, if something does not work as expected, it typically means that something else in the configuration prevents it from working, and you usually do not even suspect that said "something else" might be related. It's not just the fact that the order of firewall rules and other similar configuration items matters, but e.g. (using the most prominent example not relevant to your case) IPsec policies override the results of "normal" routing.So even if you hadn't changed a bit in the configuration you have posted previously except those items you have posted here, the position of those items is important and cannot be determined without seeing and analyzing the current configuration as a whole, with just the minimum changes required for obfuscation (private addresses need not be obfuscated, serial numbers, MAC addresses, public/global addresses, and any kind of credentials to external services obviously do).The singlemark-routingrule you have posted is now triple-protected against matching on undesired packets - by matching ondst-address-list,in-interface-list, andsrc-address, so we can be sure that assigning the routing mark to packets that should not get it is not the root cause of your issue. But nevertheless the configuration behaves different than you expect.To make things more complicated, in current RouterOS versions, some configuration items cannot be modified as the modifications do not make it from the "visible" configuration to the running one. So everything may be set correctly in the visible configuration but not in the running one. For some items, disabling and re-enabling them is enough, for other it is reportedly not and they have to be removed and re-created.

---
### Post 6
Author: Unknown
Date: Unknown

edit: duplicate removed

---
### Post 7
Author: Unknown
Date: Unknown

Sindy is extremely factual and kind.I am neither ( more like logical and blunt ),  it is plain arrogant of you to assume you know what or what shouldn't be presented ref the config.If you were so prescient there would be no need to come here and ask for help would there ??

---
### Post 8
Author: Unknown
Date: Unknown

@sindy: Thanks for your patience and your extensive answer.if something does not work as expected, it typically means that something else in the configuration prevents it from working, and you usually do not even suspect that said "something else" might be related.Agreed. I wanted to start the thread with a minimum of (from my point of view) relevant information to make it more probable that someone indeed even tries to help me. That's because of experiences in the past, where often people don't even read a thread if there is too much information.It's not just the fact that the order of firewall rules and other similar configuration items matters, ...The firewall rules didn't block anything, I enabled logging in all drop-rules and checked that.So even if you hadn't changed a bit in the configuration you have posted previously except those items you have posted here, the position of those items is important and cannot be determined without seeing and analyzing the current configuration as a whole, ...I agree again. As described before I was not expecting somebody investing so much time in analyzing my problem as you do.The single mark-routing rule you have posted is now triple-protected against matching on undesired packetsI do not want to influence other traffic in my network accidentally, therefore the triple-protection during testing.it is plain arrogant of you to assume you know what or what shouldn't be presented ref the config.Please see my explanation above. Of course I do not know every relevant snippet of the configuration which might cause the problem, I wanted to make it easier to help. I did not want to be/appear arrogant or omniscient, sorry.After some more testing today I meanwhile found the problem, which is (as you both predicted) caused by a configuration snippet I did not post: I have configuredrp-filtertostrict(I tried to harden the system in the past). When configuring it toloose, the routing is working as expected!Meanwhile themanualcontains an explicit warning, which I did not see in the past:strict mode does not work with routing tables. I technically do not really understand why it is not working with routing tables, but can live with setting it to loose I guess.Thanks again for your help!Best regards,cyb

---
### Post 9
Author: Unknown
Date: Unknown

A brief description along with a complete export between [code] and [/code] tags usually doesn't repel people who know what they are doing - at least this is my experience on this forum.I technically do not really understand why it is not working with routing tables, but can live with setting it to loose I guess.Withstrict, only the best route for a given source address is taken into account and compared to in-interface.Withloose, existence of any route towards the source address via in-interface is enough to let the packet in.Withno, no reverse path checks are made.However, if you think of it - for a home router, there's little point in changing the defaultnoto either of the two other possibilities. If you are an ISP and want to protect the rest of the world from your evil (or possessed) clients generating traffic with spoofed source addresses, activating an RP-filter is a resource-efficient way to do it; at home, you only need to take care of this kind of traffic if you have a public address on the router, and in such case, more selective means like firewall rules can be used.

---
### Post 10
Author: Unknown
Date: Unknown

Glad you found the issue and its resolved and also to re-affirm for the gazillionth time that the config is interrelated and relevant to review.

---
