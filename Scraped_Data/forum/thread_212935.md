---
title: Untitled Thread
source_url: https://forum.mikrotik.com/viewtopic.php?f=13&t=212935&p=1112030#p1112030
crawled_date: 2025-02-02T21:38:28.063690
section: mikrotik_forum
type: forum_thread
---

### Author: [SOLVED]Sat Nov 30, 2024 3:11 am
Date: Unknown

```
/ip firewall mangleaddchain=forward action=mark-connectionnew-connection-mark=fasttrack_conn passthrough=yesin-interface-list=LAN connection-state=established,relatedaddchain=forward connection-mark=fasttrack_conn action=mark-packetnew-packet-mark=fasttrack_packet passthrough=yesaddchain=prerouting action=mark-connectionnew-connection-mark=wan1_upload_conn passthrough=yesin-interface=ether1addchain=prerouting action=mark-packetnew-packet-mark=wan1_upload_packet passthrough=yes connection-mark=wan1_upload_connaddchain=postrouting action=mark-connectionnew-connection-mark=wan1_download_conn passthrough=yesout-interface=ether1addchain=postrouting action=mark-packetnew-packet-mark=wan1_download_packet passthrough=yes connection-mark=wan1_download_connaddchain=prerouting action=mark-connectionnew-connection-mark=wan2_upload_conn passthrough=yesin-interface=ether2addchain=prerouting action=mark-packetnew-packet-mark=wan2_upload_packet passthrough=yes connection-mark=wan2_upload_connaddchain=postrouting action=mark-connectionnew-connection-mark=wan2_download_conn passthrough=yesout-interface=ether2addchain=postrouting action=mark-packetnew-packet-mark=wan2_download_packet passthrough=yes connection-mark=wan2_download_conn/ip firewall filteraddchain=forward connection-mark=fasttrack_conn action=fasttrack-connectionin-interface-list=LANaddaction=accept chain=forward comment="defconf: accept established,related, untracked"connection-state=established,related,untracked/queue typeaddname=fq_codel kind=fq_codel/queue treeaddname=fq_codel_wan1_upload parent=globalpacket-mark=wan1_upload_packet queue=fq_codel max-limit=30Maddname=fq_codel_wan1_download parent=globalpacket-mark=wan1_download_packet queue=fq_codel max-limit=300Maddname=fq_codel_wan2_upload parent=globalpacket-mark=wan2_upload_packet queue=fq_codel max-limit=30Maddname=fq_codel_wan2_download parent=globalpacket-mark=wan2_download_packet queue=fq_codel max-limit=45M
```

```
/ip firewall filteraddchain=forward connection-mark=fasttrack_conn action=fasttrack-connectionin-interface-list=LANout-interface-list=LAN
```

Hi,I'm trying to set up fq_codel queue tree for (2) WAN ISPs on ether1 and ether2 while keeping fasttrack for bridge and vlan traffic. Basically any lan traffic but when I set this up, I can see the mangle rules have a lot more traffic but not all the traffic is hitting the queue tree queue and so when I run a bufferbloat test. I see the mangle rules transfer Bytes and Packets columns increase but the queue tree avg rate never ramps up and the packets are not increasing in the same rate as the mangle rules packets. The total packets that hit the queue tree is for every 500 packets, only 40 or so hit the queue tree. effectively there is nothing to queue. The queued bytes column is always 0. I must be overlooking something.In addition, I would expect the avg rate column in the queue tree to show the transfer rate of the interface, and it's always reading less than 1500kbps while the interface is at 55Mbps during a buffer bloat test.This is what I used to get set up.Code:Select allUpdate #1: After looking at it a bit longer, appears that the mangle rules are not marking all the ether1 and ether2 pre routing and post routing packets, effectively if they aren't all marked then they aren't sent to the queue. I'm trying to figure out why not all the packets are marked in the mangle rules.Update #2: After extensive additional testing. Disabling the fasttrack rule makes all this configuration work. To fix it, I set the In interface to be LAN and out interface list to be LAN as well. Like this config. I think I've set it up right, Lan traffic is unaffected by the queues and WAN traffic both on ether 1 and ether 2 are hitting their respective queues.End result: Fasttrack is a tricky thing lol. I hope I did this right.Code:Select all

