# Thread Information
Title: Untitled Thread
Section: mikrotik_forum
Thread ID: 190614

# Discussion

## Initial Question
Author: Thu Nov 03, 2022 4:29 pm
``` # RouterOS 7.6# model = RB750Gr3/interfacebridgeaddadmin-mac=xx:xx:xx:xx:xx:xxauto-mac=nocomment=defconf name=bridge/interfacepppoe-clientadddisabled=nointerface=ether1 name=pppoe-backupuse-peer-dns=yesadddisabled=nointerface=ether1 name=pppoe-vpnuse-peer-dns=yesadddisabled=nointerface=ether1 name=pppoe-wause-peer-dns=yes/interfacewireguardaddlisten-port=54321mtu=1420name=wireguard0/interfacelistaddcomment=defconf name=WANaddcomment=defconf name=LAN/interfacewireless security-profilesset[finddefault=yes]supplicant-identity=MikroTik/ip hotspot profileset[finddefault=yes]html-directory=hotspot/ip pooladdname=dhcp ranges=192.168.10.101-192.168.10.254/ip dhcp-serveraddaddress-pool=dhcpinterface=bridge lease-time=12hname=dhcp0/portset0name=serial0/routing tableadddisabled=nofib name=vpn/interfacebridge portaddbridge=bridge comment=defconfinterface=ether2addbridge=bridge comment=defconfinterface=ether3addbridge=bridge comment=defconfinterface=ether4addbridge=bridge comment=defconfinterface=ether5/ip neighbor discovery-settingssetdiscover-interface-list=LAN/ip settingssetrp-filter=loose/interfacelist memberaddcomment=defconfinterface=bridge list=LANaddcomment=defconfinterface=ether1 list=WANaddinterface=pppoe-vpn list=WAN/interfacewireguard peersaddallowed-address=192.168.9.3/32comment=macinterface=wireguard0 \ persistent-keepalive=25s/ip addressaddaddress=192.168.10.83/24comment=defconfinterface=bridge network=\192.168.10.0addaddress=192.168.9.83comment="wireguard interface local ip"interface=\ wireguard0 network=192.168.9.0/ip cloudsetddns-update-interval=15m/ip dhcp-clientaddcomment=defconf disabled=yesinterface=ether1/ip dhcp-server leaseaddaddress=192.168.10.93lease-time=23h59m59smac-address=yy:yy:yy:yy:yy:yy \ server=dhcp0use-src-mac=yes/ip dhcp-server networkaddaddress=192.168.10.0/24comment=defconf dns-server=192.168.10.83gateway=\192.168.10.83netmask=24/ip dnssetallow-remote-requests=yes/ip dnsstaticaddaddress=192.168.10.83comment=defconf name=router.lan/ip firewall filteraddaction=accept chain=input comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=input comment="defconf: drop invalid"connection-state=\ invalidaddaction=accept chain=input comment="defconf: accept ICMP"protocol=icmpaddaction=accept chain=input comment="accept wireguard"dst-port=54321\in-interface=pppoe-vpn protocol=udpaddaction=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)"dst-address=127.0.0.1addaction=drop chain=input comment="defconf: drop all not coming from LAN"\in-interface-list=!LANaddaction=accept chain=forward comment="defconf: accept in ipsec policy"\ disabled=yes ipsec-policy=in, ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"\ disabled=yes ipsec-policy=out, ipsecaddaction=fasttrack-connection chain=forward comment="defconf: fasttrack"\ connection-state=established, related disabled=yes hw-offload=yesaddaction=accept chain=forward comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=forward comment="defconf: drop invalid"\ connection-state=invalidaddaction=drop chain=forward comment=\"defconf: drop all from WAN not DSTNATed"connection-nat-state=!dstnat \ connection-state=newin-interface-list=WAN/ip firewall mangleaddaction=mark-routing chain=prerouting comment=\"mark wireguard connections - prerouting"dst-port=54321\new-routing-mark=vpn passthrough=noprotocol=udpaddaction=mark-routing chain=output comment=\"mark wireguard connections - prerouting"new-routing-mark=vpn \ passthrough=noprotocol=udp src-port=54321/ip firewall nataddaction=masquerade chain=srcnat comment="defconf: masquerade"\ ipsec-policy=out, noneout-interface=pppoe-vpnaddaction=masquerade chain=srcnat comment="defconf: masquerade"\ ipsec-policy=out, noneout-interface=pppoe-wa/ip routeadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=pppoe-wa pref-src=""\ routing-table=main scope=30suppress-hw-offload=notarget-scope=10adddisabled=nodistance=1dst-address=0.0.0.0/0gateway=pppoe-vpn \ routing-table=vpn scope=30suppress-hw-offload=notarget-scope=10/ipv6 firewall address-listaddaddress=::/128comment="defconf: unspecified address"list=bad_ipv6addaddress=::1/128comment="defconf: lo"list=bad_ipv6addaddress=fec0::/10comment="defconf: site-local"list=bad_ipv6addaddress=::ffff:0.0.0.0/96comment="defconf: ipv4-mapped"list=bad_ipv6addaddress=::/96comment="defconf: ipv4 compat"list=bad_ipv6addaddress=100::/64comment="defconf: discard only "list=bad_ipv6addaddress=2001:db8::/32comment="defconf: documentation"list=bad_ipv6addaddress=2001:10::/28comment="defconf: ORCHID"list=bad_ipv6addaddress=3ffe::/16comment="defconf: 6bone"list=bad_ipv6/ipv6 firewall filteraddaction=accept chain=input comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=input comment="defconf: drop invalid"connection-state=\ invalidaddaction=accept chain=input comment="defconf: accept ICMPv6"protocol=\ icmpv6addaction=accept chain=input comment="defconf: accept UDP traceroute"port=\33434-33534protocol=udpaddaction=accept chain=input comment=\"defconf: accept DHCPv6-Client prefix delegation."dst-port=546protocol=\ udp src-address=fe80::/10addaction=accept chain=input comment="defconf: accept IKE"dst-port=500, 4500\ protocol=udpaddaction=accept chain=input comment="defconf: accept ipsec AH"protocol=\ ipsec-ahaddaction=accept chain=input comment="defconf: accept ipsec ESP"protocol=\ ipsec-espaddaction=accept chain=input comment=\"defconf: accept all that matches ipsec policy"ipsec-policy=in, ipsecaddaction=drop chain=input comment=\"defconf: drop everything else not coming from LAN"in-interface-list=\!LANaddaction=accept chain=forward comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=forward comment="defconf: drop invalid"\ connection-state=invalidaddaction=drop chain=forward comment=\"defconf: drop packets with bad src ipv6"src-address-list=bad_ipv6addaction=drop chain=forward comment=\"defconf: drop packets with bad dst ipv6"dst-address-list=bad_ipv6addaction=drop chain=forward comment="defconf: rfc4890 drop hop-limit=1"\ hop-limit=equal:1protocol=icmpv6addaction=accept chain=forward comment="defconf: accept ICMPv6"protocol=\ icmpv6addaction=accept chain=forward comment="defconf: accept HIP"protocol=139addaction=accept chain=forward comment="defconf: accept IKE"dst-port=\500, 4500protocol=udpaddaction=accept chain=forward comment="defconf: accept ipsec AH"protocol=\ ipsec-ahaddaction=accept chain=forward comment="defconf: accept ipsec ESP"protocol=\ ipsec-espaddaction=accept chain=forward comment=\"defconf: accept all that matches ipsec policy"ipsec-policy=in, ipsecaddaction=drop chain=forward comment=\"defconf: drop everything else not coming from LAN"in-interface-list=\!LAN/system clocksettime-zone-name=Africa/Johannesburg/tool mac-serversetallowed-interface-list=LAN/tool mac-server mac-winboxsetallowed-interface-list=LAN/tool sniffersetfilter-interface=all filter-ip-protocol=udp filter-port=54321 ``` ``` /ip firewall mangleaddaction=mark-routing chain=prerouting comment=\"mark wireguard connections - prerouting"dst-port=54321\new-routing-mark=vpn passthrough=noprotocol=udpaddaction=mark-routing chain=output comment=\"mark wireguard connections - prerouting"new-routing-mark=vpn \ passthrough=noprotocol=udp src-port=54321 ``` We have a multi-WAN setup and want to route all Wireguard traffic through a specific WAN interface, pppoe-vpn, which is assigned a static IP at ISP level. Here's the network diagram:network-diagram.PNGAnd this is the config:
```
Disabling these 2 mangle rules...
```

```
...and attempting to connect a peer through the static IP yields the following via the packet sniffer (actual listening port redacted but let's pretend it's 54321 as per above config):sniffer-default.PNGThe packet is received through the pppoe-vpn interface but is responded to from the pppoe-wa interface - the default interface. As a result, no handshake takes place.Enabling the 2 mangle rules yields the following result:sniffer-3.PNGThe packets are being responded to on the correct interface but1. There is a big delay in the response.2. The response is not being sent through the same port it was requested from - the peer is connecting from port 24099 but the response is being sent to port 22505.As a result, no handshake takes place.Some info that may or may not be relevant:1. The static IP of interface pppoe-vpn is assigned at ISP level. On the router itself, we get assigned a dynamic NAT'ed (we beg pardon if this isn't the correct term) IP (10.230.68.216 in this case) and we don't see the actual static IP anywhere on the router.2. When using pppoe-vpn as the default gateway using the default routing table, the handshake takes place without issue.Please advise, oh wise Ones - what are we doing wrong?


---
```

## Response 1
Author: Thu Nov 03, 2022 4:53 pm
``` /ip addresses ``` To be clear, is your wireguard instance on the router acting as a server for handshake or is it connecting to something else as a client?The Wireguard instance on the router is indeed acting as a server for handshake (that's the intention, anyway).What is the purpose of the wireguard. So far it seems the requirement is for local users to go out a specific WAN but to what for example.The purpose is for peers to connect to the local network remotely, and access hosts within the local network, for remote work.Also you are missing an IP address for wireguard in the config.Noted and will add an IP address under
```
for the Wireguard interface - the plan was to sort that out after establishing a reliable handshake.


---
```

## Response 2
Author: Thu Nov 03, 2022 5:20 pm
``` src-address-type="" ``` Realised an error in the mangle rules -
```
After removing this condition, the packet sniffer now looks like this:sniffer-3.PNGThe packets are being responded to on the correct interface but1. There is a big delay in the response.2. The response is not being sent through the same port it was requested from - the peer is connecting from port 24099 but the response is being sent to port 22505.As a result, still no handshake takes place.Updating the OP with this info as well.


---
```

## Response 3
Author: Thu Nov 03, 2022 5:27 pm
(1) Why isnt the primary WAN pppoe not part of the wan list??In other words/interface list memberadd comment=defconf interface=bridge list=LANadd comment=defconf interface=ether1 list=WANadd interface=pppoe-vpn list=WANadd interface=pppoe-wa list=WAN(2) Persistent keep alive for the incoming remote user .3/32 makes no sense. Should be set at the client.(3) When you construct your IP address say 192.168.9.1/24 this will cause the router to auto generate a routing.<dac> dst-address=192.168.3.0/24 gwy=wireguard0 table=mainThis means that when the remote users access the LAN for traffic, the return traffic will be correctly routed through the tunnel that was established over the VPN WAN link.(4) Where more work would be required is if:a. you wanted remote users to go out your internet like out pppoe-wa for instance, ORb. you wanted local user to go out wireguard (lets say if you had another router as a client and there were remote subnets local users needed to reach).(5) Finally yes disable the mangle rules as their need is not clear yet but may be needed later or some variant of.Now looking at your current route rules for pppoe, wireguard handshake is not working, maybe due to the that fact that you don't have the standard route for pppoe-vpn so if you have multiple wans you at least need the standard routing for each WAN, for standard traffic to the router etc.FROM:/ip routeadd disabled=no distance=1 dst-address=0.0.0.0/0 gateway=pppoe-wa pref-src="" \routing-table=main scope=30 suppress-hw-offload=no target-scope=10add disabled=no distance=1 dst-address=0.0.0.0/0 gateway=pppoe-vpn pref-src=\"" routing-table=vpn scope=30 suppress-hw-offload=no target-scope=10TO:/ip routeadd disabled=no distance=1dst-address=0.0.0.0/0 gateway=pppoe-wa table=mainadd disabled=no distance=2dst-address=0.0.0.0/0 gateway=pppoe-vpn table=mainIn this regard normal traffic will flow and the handshake should work. Note I added a distance of 2, to your vpn network.This will ensure all users go out the pppoe-wa WAN connection for internet. ---

## Response 4
Author: Thu Nov 03, 2022 6:37 pm
``` # RouterOS 7.6# model = RB750Gr3/interfacebridgeaddadmin-mac=xx:xx:xx:xx:xx:xxauto-mac=nocomment=defconf name=bridge/interfacepppoe-clientadddisabled=nointerface=ether1 name=pppoe-backupuse-peer-dns=yesadddisabled=nointerface=ether1 name=pppoe-vpnuse-peer-dns=yesadddisabled=nointerface=ether1 name=pppoe-wause-peer-dns=yes/interfacewireguardaddlisten-port=54321mtu=1420name=wireguard0/interfacelistaddcomment=defconf name=WANaddcomment=defconf name=LAN/routing tableadddisabled=nofib name=vpn/interfacebridge portaddbridge=bridge comment=defconfinterface=ether2addbridge=bridge comment=defconfinterface=ether3addbridge=bridge comment=defconfinterface=ether4addbridge=bridge comment=defconfinterface=ether5/interfacelist memberaddcomment=defconfinterface=bridge list=LANaddcomment=defconfinterface=ether1 list=WANaddinterface=pppoe-vpn list=WANaddinterface=pppoe-wa list=WANaddinterface=pppoe-backup list=WAN/interfacewireguard peersaddallowed-address=192.168.9.3/32comment=macinterface=wireguard0/ip addressaddaddress=192.168.10.83/24comment=defconfinterface=bridge network=\192.168.10.0addaddress=192.168.9.83/24comment="wireguard interface local ip"\interface=wireguard0 network=192.168.9.0/ip firewall filteraddaction=accept chain=input comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=input comment="defconf: drop invalid"connection-state=\ invalidaddaction=accept chain=input comment="defconf: accept ICMP"protocol=icmpaddaction=accept chain=input comment="accept wireguard"dst-port=54321\in-interface=pppoe-vpn protocol=udpaddaction=accept chain=input comment=\"defconf: accept to local loopback (for CAPsMAN)"dst-address=127.0.0.1addaction=drop chain=input comment="defconf: drop all not coming from LAN"\in-interface-list=!LANaddaction=accept chain=forward comment="defconf: accept in ipsec policy"\ disabled=yes ipsec-policy=in, ipsecaddaction=accept chain=forward comment="defconf: accept out ipsec policy"\ disabled=yes ipsec-policy=out, ipsecaddaction=fasttrack-connection chain=forward comment="defconf: fasttrack"\ connection-state=established, related disabled=yes hw-offload=yesaddaction=accept chain=forward comment=\"defconf: accept established, related, untracked"connection-state=\ established, related, untrackedaddaction=drop chain=forward comment="defconf: drop invalid"\ connection-state=invalidaddaction=drop chain=forward comment=\"defconf: drop all from WAN not DSTNATed"connection-nat-state=!dstnat \ connection-state=newin-interface-list=WAN/ip firewall nataddaction=masquerade chain=srcnat comment="defconf: masquerade"\out-interface-list=WAN/ip routeadddisabled=nodistance=1dst-address=0.0.0.0/0gateway=pppoe-wa pref-src=""\ routing-table=main scope=30suppress-hw-offload=notarget-scope=10adddisabled=nodistance=2dst-address=0.0.0.0/0gateway=pppoe-vpn pref-src=\""routing-table=main scope=30suppress-hw-offload=notarget-scope=10 ``` ``` /ip firewall nataddaction=masquerade chain=srcnat comment="defconf: masquerade"\out-interface-list=WAN ``` anav's much appreciated Sagely advice...OK, have added all pppoe interfaces to WAN list, removed persistent keep alive for peer (it was indeed also set on client), added IP for Wireguard interface (which added a dynamic routing to the main routing table), disabled the mangle rules, and updated the pppoe-vpn route.Config now looks like:
```
Packet sniffer shows packet coming in through pppoe-vpn but response still goes out through the default gateway, pppoe-wa:sniffer-4.PNGAnd no handshake.Is this masquerade rule correct?
```

```
---
```

## Response 5
Author: [SOLVED]Thu Nov 03, 2022 7:06 pm
Yes masquerade rule is correct, it was me that erred.Lets fix this for you.By the way what is with .83 LOL, its when I graduated University, so its a nice number!Please add this third route and routing rule......../ip routeadd disabled=no distance=1 dst-address=0.0.0.0/0 gateway=pppoe-wa pref-src="" \routing-table=main scope=30 suppress-hw-offload=no target-scope=10add disabled=no distance=2 dst-address=0.0.0.0/0 gateway=pppoe-vpn pref-src=\"" routing-table=main scope=30 suppress-hw-offload=no target-scope=10add disabled=no distance=2 dst-address=0.0.0.0/0 gateway=pppoe-vpntable=vpn/routing ruleadd interface=src-address=IPaddress (of pppoe-vpn) action=lookup-only-in-table table=vpnThat should allow the handshakeProblem is that that IP is not static right ???If not then you will need a script to keep it correct.