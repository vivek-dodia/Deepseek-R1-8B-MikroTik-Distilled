# Thread Information
Title: Thread-1119473
Section: RouterOS
Thread ID: 1119473

# Discussion

## Initial Question
Unfortunately, it looks like there's something in the way the PCIe card reboots that upsets HP servers.When I reboot the CCR, the server INSTANTLY hangs, with errors like "Uncorrectable Machine Check Exception (Board 0, Processor 1, APIC ID 0x00000000, Bank 0x00000013, Status 0xFE200000'000C110A, Address 0x00000000'80500000, Misc 0x44FC3816'00402086)" and "PCI Bus Error (Slot 2, Bus 0, Device 2, Function 0)"Has anyone managed to get these cards working with enterprise-ish servers at all? I can understand that a normal PC without all the failsafe/monitoring would probably not notice, or even mind, that a PCI card vanishes, but these bigger servers obviously do!This SPECIFIC host is a HP DL360 G9, with 2 x E5-2687W v3's, but I suspect that almost all servers are going to have a similar problem. ---

## Response 1
Or perhaps not. If reboot of this device indeed makes it (momentarily) vanish from PCIe bus, then this indeed causes problems to hardware and OSes that can not handle hot-plug events on PCIe. This is fairly recent development (e.g. less than 10 years) and not all hardware engineered around that time already supports it ... which is true for OS kernels as well. I would expect that latest hardware (e.g. HPE servers gen11) and OS (e.g. linux kernels 5.x ...) handle this without issues. Older servers (possibly gen9 is affected) and older OSes (e.g. linux kernel 4.x and older, Windows server 2016 and lower) don't expect this to happen and freak out.Mind that a proper CCR2004-PCIe reboot may be harder on PCIe host than reset of chip on a more ordinary PCIe card ... ---

## Response 2
It causes a crash even if the machine is still in POST. It's pretty clear that the ILO equipped devices are far more picky about how pcie devices are hotplugged than a normal dumb machine. I plugged it into a generic dell PC and rebooting the CCR didn't bother the PC at all.I don't have a Dell server with a DRAC, so I can't check with that, but two HPs servers both crashed with similar errors when the 2004 was rebooted.There's obviously something that the HPs don't like about them unplugging and replugging themselves - even though I can literally PHYSICALLY unplug a normal NIC while the machine is on. ---

## Response 3
Another possibility would be power surge following full board reset ... it could momentarily overload PCIe bus power capabilities. I wasn't able to find a good reference on that, but from the top of my memory PCIe capability is somewhere around 30-50W, possibly depending on PCIe version and particular mainboard implementation. ---

## Response 4
Typical max PCIe slot power is 75W and it's quite common for GPUs or things like AI/Crypto accelerators to use all of it... continously.Mikrotik card should not be consuming so much power. And any brief spikes should be smoothed out by capacitors on board.So I'd say the hardware side of this problem is far less likely then some software issue in ILO or BIOS, especially if it keeps happening just on range of HP servers and not other vendors... ---

## Response 5
When initially reading about this card I though "wow! that is interesting! that could be the ideal router for a 1U server in a colocation datacenter!".But issues like what you mention here (and also the reverse: what will happen to the card when the host is rebooted? will it remain running?), plus the lack of drivers for VMware ESXi, has made me put it aside as "unfortunately, not so interesting".What we need is a card that can function almost independently from the host, with only the data path via the PCI bus. So we can tie a cable from the ethernet port to the ILO/DRAC port, and have a 10Gbit or faster link to the ISP. And then be able to setup a VPN to manage the host via ILO and directly on the network interface.It seems it is still a dream. ---

## Response 6
If there is ever revision 2 of this card, adding optional external power (either jack or POE or internal connector) would help. That way it would be possible to run it at all times, no matter what's the state of PC. Or even use it as a "router on a stick" like some users tried (and fried) using mining riser.As for drivers, that's still a problem. Too bad it requires modified ones so running any unsupported OS is just out of the question... ---

## Response 7
If there is ever revision 2 of this card, adding optional external power (either jack or POE or internal connector) would help. That way it would be possible to run it at all times, no matter what's the state of PC. Or even use it as a "router on a stick" like some users tried (and fried) using mining riser.As for drivers, that's still a problem. Too bad it requires modified ones so running any unsupported OS is just out of the question...probably the card would work a PCIe riser what does nothing but powering the card? ---

## Response 8
I wouldn´t! Here it is how I tried and fried and also repaired it:viewtopic.php?t=189441Besides there are no proper cases available. ---

## Response 9
I wouldn´t! Here it is how I tried and fried and also repaired it:viewtopic.php?t=189441Besides there are no proper cases available.if i'm right, that card is blown because of OLD picoPSU...the proper case is not an issue. ---

## Response 10
I´m not sure if that was my PicoPSU or the riser. I have measured the outputs of that PicoPSU after the fuse was blown and they were OK. So I rather tend to say, that the riser had issues and the capacitor exploded on it, so I can´t test that any more.I would not use a plastic case, but something out of sheet metal for fire protection (it should run 24hours a day for many years). Of course it´s doable, but it needs time and effort, to manufacture it.Cooling should be considered as well. I don´t have the time for a custom made one.So to me it is an issue. Not an unsolvable one, I could even take one of my MiniITX cases.They are however bulky, compared to an RB5009. Taking care of low noise cooling+ custom case + power would also add to the costs.Besides my most important usecase requires OpenBSD compatibility, which is not given and there was no information if MT will support the driver development. ---

## Response 11
well, i tought to use them in DC/hosting environment, probably a 2U rack chassis serving 6-9 cards in 2-3 columns. ---

## Response 12
It seems to me, for that case the cards are perfect. You don´t need a host for the cards and you could probably get multi PCIe riser boards in higher quality. Besides I´m sure you could just use any server case, powering the whole thing with a beefy standard server PSU.The missing drivers are not needed in this case, while you get the best price/performance for a router from MT.Great idea! The only problem I see is the avilability of the cards.... ---

## Response 13
I don't see a need to hack a case for this card, in that situation I would just buy a router in a case.My use-case is in colocation environments where you rent only a single 1U slot and thus there is no space for an external router, only your 1U server.With this card you would be able to have an external router to protect the management interfaces of your server (ILO/DRAC, RDP, SSH etc) using a VPN, and have routing functionality in general.The card would be placed in a slot of the server, the ethernet port connected to the ILO/DRAC port, and the SFP used to connect to the ISP network. ---

## Response 14
I did see a need to hack a case, becuase my usecase is that of a remote location ("spoke" - meaning the flat of my family) equipped with an X86 OpenSense box, which should have been prepared for 10G interfaces.At the time of the purchase of the MT card it was no big additional cost to purchase a CCR2004 card intead of a dual SFP+ Intel card.It turned out, that the OpenBSD drivers for the CCR2004 are unusable.My next idea would have been to use my CCR2004 as a standalone router instead of an rb5009, but there were some issues.... ---

## Response 15
I have the same problem with this card on HP DL165 G9. After firmware update and rebooting routeros, server is hang and reboot too.Uncorrectable Machine Check Exception (Board 0, Processor 1, APIC ID 0x00000000, Bank 0x00000013, Status 0xBE200000'000C110A, Address 0x00000000'80600000, Misc 0xCCFC3816'00402086)PCI Bus Error (Slot 1, Bus 0, Device 3, Function 0) ---

## Response 16
I just installed two of these cards in 2 separate servers. When I reboot the Mikrotik router, one of them which has ESXi, crashes and hangs in purple screen. The one with the linux reboots. I believe it is a bug and may be reboot command causes the server crash. I was going to use them in all of my servers but I cannot go on with this problem. I have to shutdown the server safely but then the Mikrotik card is also shuts down. Crazy chicken and egg problem. ---

## Response 17
Yeah, it is clear that this card, which seemed very attractive for co-located servers requiring a router, is not usable in practice.E.g. it would also have to be running when the system is in STANDBY state, so you can poweroff the server via ILO/DRAC and then still be connected to send a poweron command later.So, it all was just a dream. ---

## Response 18
probably the card doing some strange PCI init thing - what causes the machine to crash or forces reboot.If a soft-restart (like watchdog reboot) can be survived by the host, and only firmware upgrade would need cold restart, that would be something i can live with.Until than, i only can ask if there is someone who builds a 2U chassis (like for crypto mining purposes) where i can put some of those cards - and do nothing but powers PCI bus with redundant power supplies? ---

## Response 19
I've been running this card in a HP XL420/Apollo 4200 Gen9, on fw 7.8 for a while, without any crashes. Without further research, I have deployed 7.12 and 7.16 in quick succession and found out about the reboot bug right after -- but since then I have experienced 2 random crashes with the same
```
UncorrectableMachineCheckException(Board0,Processor1,APIC ID0x00000000,Bank0x00000013,Status0xBE200000'000C110A, Address 0x00000000'80500000,Misc0x54FC3816'00402086)message, without any manual reboots of the card.For now, I downgraded system package to 7.12.1, while left the routerboard firmware on 7.16.1, and will report in on any further crashes.

---
```

## Response 20
In that machine, can you turn power off in the server via ILO with the CCR2004 still powered via standby power? ---

## Response 21
No, the machine turns off the slot, thus the card shuts down with the machine. ---

## Response 22
For now, I downgraded system package to 7.12.1, while left the routerboard firmware on 7.16.1, and will report in on any further crashes.While 7.16.1 could barely stay alive for ~4-5 hours, 7.12.1 has accumulated 10 hrs uptime already. I'm hopeful that this version will stay stable.update 1:Current uptime is 1d 5h, simply put there has been no random reboots since downgrading to 7.12.1.update 2:7.12.1 remained stable for the past 2 days, I consider that version at least to be safe. ---

## Response 23
Hi, I've faced same issue, and after some checking and lot of upgrade / downgrade attempts finally managed to found latest stable RouterOS version working on my side is 7.13.5, what I have seen it's happening with 7.16 / 7.16.1 / 7.16.2 is high ram memory usage after some traffic.I've also sent a support request SUP-176536 with all the details on the steps I made and how to reproduce the issue. This is the support request message:SymptomI've acquired a CCR2004-1G-2XS-PCIe device and after installing it and doing some tests, as I usual do, I've upgraded it to the latest RouterOS available version (7.16.2) and configured for my setup. For my surprise here I started facing some issues with random reboots on mikrotik and then after a while also on host server. After wasting some time wondering can be the issue I finally found this forum thread where says that I'm not the only one with this issue and that it is not happening in 7.12.1 version:viewtopic.php?t=191581(hope that is the correct link but I cannot confirm currently since forum is giving a 504 error)I've tried to downgrade to this version and it seems to be right. But at this point I wanted to know what is the exact latest working version for acquiring all the information possible before sending a support case.Lower than 7.14 seems to be safe versions in my setupInstalling 7.14 makes it unusable and also harm to main server bios initialisation (not booting anymore, continuous reboot loop on host and neither possible to connect to mikrotik). On human intervention to server, I've managed to stop bios boot process before it got stuck so mikrotik board has stable power supply so I finally managed to connect RouterOS with winbox, here I've tried in several attempts without success to downgrade using 7.13.5 package.Finally I've used netinstall for flashing 7.13.5, confirmed stability and then upgraded by uploading package 7.14.1 (that says in changelog that is resolving sfp system stability in this device) and rebooting; this version at least seems to work but it immediately reboot every time we made some load between two bridges, so it is also unusable. Also due to the abrupt interruption it is freezing linux os with kernel messages like "[ 743.566365] atlic 0000:03:00.3 enp3s0f3: NETDEV WATCHDOG: CPU: 14: transmit queue 2 timed out 5696 ms". Only way to restore is to restart os that also triggers another routerboard restart.After checking all the newer versions changelog entries regarding CCR2004-1G-2XS-PCIe I've observed that there are more stability fixes on two versions after 7.14.1: 7.15 and 7.16 so I've directly taken 7.16 version and executed "/system routerboard upgrade" as suggested on changelog.At this step (7.16 version) I'm facing the same first time "out of memory condition" issue than on the first step with latest 7.16.2 version. So since it is a good idea to deliver something minimal that is already causing the issue to made easy to reproduce I've reseted all my setup configuration and created something similar but much more simple:TL;DR:
```
# Tested RouterOS version: 7.16.2 (latest known working version: 7.13.5)# Server where CCR2004-1G-2XS-PCIe is inserted is a Dell PowerEdge R720 with latest proxmox 8.3.2 (pve kernel: Linux version 6.8.12-5-pve (build@proxmox) (gcc (Debian 12.2.0-14) 12.2.0, GNU ld (GNU Binutils for Debian) 2.40) #1 SMP PREEMPT_DYNAMIC PMX 6.8.12-5 (2024-12-03T10:26Z) ())# Testing Environment Setup (assumming no default configuration):/interfaceethernetset[finddefault-name=ether-pcie1]passthrough-interface=noneset[finddefault-name=ether-pcie2]passthrough-interface=none/interfacebridgeaddname=br0-lanaddname=br2-serversaddname=br10-wan0/interfacebridge portaddbridge=br10-wan0interface=sfp28-1addbridge=br0-laninterface=sfp28-2addbridge=br0-laninterface=ether1addbridge=br0-laninterface=ether-pcie1addbridge=br2-serversinterface=ether-pcie4/ip dhcp-clientadddefault-route-distance=200interface=br10-wan0/ip firewall nataddchain=srcnatout-interface=br10-wan0 action=masquerade/ip addressaddinterface=br0-lan address=192.168.0.254/24addinterface=br2-servers address=11.0.0.254/24/system loggingaddaction=disk topics=error,critical# Working tests# - Reboot proxmox server so interfaces are properly recognised (ping to proxmox host on both 11.0.0.250 and 192.168.0.250)# - Connected lan device at sfp28-2 port, configured address/gw/dns and tested internet with speedtest.net (br0-lan <> br10-wan0)# Issue triggering# - For bandwidth tests I'm using goben (https://github.com/udhos/goben) but I think any other tool like iperf or similar should work.# - Started server on proxmox (listening on all interfaces): ./goben_linux_amd64# - Started client on lan host already connected at sfp28-2 port targgeting br2-servers address: ./goben_darwin_arm64_softfloat --hosts=11.0.0.250 -totalDuration=50# - At this point CCR2004-1G-2XS-PCIe memory is really high and proxmox server is stuck with this kind of kernel messages: "[ 1247.366308] atlic 0000:03:00.0 enp3sofo: NETDEV WATCHDOG: CPU: 12: transmit queue 3 timed out 946688 ms". At this moment I've experienced two possible scenarios:#   > 1. First Mikrotik restarts due to an 'out of memory condition' (see log attached at end of description). At this moment also proxmox crashes and whole server restart, forcing a new routeros restart due to pci ports initialization. After server boots up it is working again but after some time routerboard is going to fill again all the memory this first scenario is triggered indefinitely.#   > 2. Keep online for some time: Communication through pci network interfaces is not working anymore (kernel messages like '[ 2221.702340] atlic 0000:03:00.0 enp3s0f0: NETDEV WATCHDOG: CPU: 19: transmit queue 3 timed out 1921024 ms' are appearing continuously on proxmox), RouterOS is stabilized at high ram usage but did not restart with no CPU usage (Memory Free/Used/Total: 258.1 MiB / 3857.9 MiB / 4096.0 MiB). At this state since conflicting pci traffic is not possible anymore, it is harder to manually trigger the upcoming restart that will ussually happen letting it alone in less than 30min. After this time comes, follows scenario 1 behaviour.# RouterOS startup log (attaching also a support.rif):# 37  2025-01-16 00:54:14 disk    system, error, critical router was rebooted without proper shutdown, probably kernel failure# 38  2025-01-16 00:54:14 memory  system, error, critical kernel failure in previous boot# 39  2025-01-16 00:54:14 disk    system, error, critical kernel failure in previous boot# 40  2025-01-16 00:54:14 memory  system, error, critical out of memory condition was detected# 41  2025-01-16 00:54:14 disk    system, error, critical out of memory condition was detected# 42  2025-01-16 00:54:15   memory interface, info  lo link up---# Other attempts made:## 1. Similar configuration without using bridge interfaces (deconfigured ether-pcie1 interface at proxmox so traffic directed to 192.168.0.0/24 comes back to CCR2004-1G-2XS-PCIe as gateway):/ip addressaddaddress=192.168.0.254/24interface=sfp28-2network=192.168.0.0addaddress=11.0.0.254/24interface=ether-pcie4 network=11.0.0.0/ip dhcp-clientadddefault-route-distance=200interface=sfp28-1/ip firewall nataddaction=masquerade chain=srcnatout-interface=sfp28-1/system loggingaddaction=disk topics=error,critical## > This configuration also leads to same non operation behaviour.Note: I also have some extracted proxmox syslog dumps from the pci errors causing proxmox crashes. Do not hesitate to ask me to send in case that they are useful.

---
```

## Response 24
Just some hours later (at Thu, 16 Jan 2025 13:55:33 UTC), Mikrotik has released 7.17 stable version. I've tested it and it is and seems to be resolved and working properly right now. ---