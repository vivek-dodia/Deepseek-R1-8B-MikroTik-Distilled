# Thread Information
Title: Untitled Thread
Section: mikrotik_forum
Thread ID: 206714

# Discussion

## Initial Question
Author: Fri Apr 19, 2024 4:03 am
``` /ip vrfaddinterfaces=pppoe-out1 name=vrf-wanaddinterfaces=ether2 name=vrf-lan/ip addressaddaddress=100.64.1.1/24interface=ether2 network=100.64.1.0/ip firewall mangleaddaction=mark-routing chain=prerouting dst-address=!100.64.1.1in-interface=ether2 log=yes log-prefix=LANnew-routing-mark=vrf-wan passthrough=noaddaction=mark-routing chain=preroutingin-interface=pppoe-out1new-routing-mark=vrf-lan passthrough=no/ip dhcp-serveraddadd-arp=yesinterface=ether2 name=server-lan/ip dhcp-server leaseaddaddress=<publicip>mac-address=<macofUDM>server=server-lan ``` I think TheWeegee is asking for a way to offload only the pppoe stuff to the RB5009 and than pass through the public ip by dhcp to the UDM. The UDM should stay because his whole network is build around Unifi.I think this should be possible with two VRF instances and two mangle rules.Not teste btw.
```
---
```

## Response 1
Author: Fri Apr 19, 2024 6:04 pm
``` /ip vrfaddinterfaces=pppoe-out1 name=vrf-wanaddinterfaces=ether2 name=vrf-lan/ip addressaddaddress=100.64.1.1/24interface=ether2 network=100.64.1.0/ip firewall mangleaddaction=mark-routing chain=prerouting dst-address=!100.64.1.1in-interface=ether2 log=yes log-prefix=LANnew-routing-mark=vrf-wan passthrough=noaddaction=mark-routing chain=preroutingin-interface=pppoe-out1new-routing-mark=vrf-lan passthrough=no/ip dhcp-serveraddadd-arp=yesinterface=ether2 name=server-lan/ip dhcp-server leaseaddaddress=<publicip>mac-address=<macofUDM>server=server-lan ``` I think TheWeegee is asking for a way to offload only the pppoe stuff to the RB5009 and than pass through the public ip by dhcp to the UDM. The UDM should stay because his whole network is build around Unifi.I think this should be possible with two VRF instances and two mangle rules.Not teste btw.
```
This is the closest I've managed to get it to work, PPPoE is up but once I do this ping timeouts all the time saying no route to host, and while it says my public ISP IP is bound to my UDM and "working", the DHCP for server-lan is red and I have no traffic activity in interfaces for the SFP port which I'm using instead of ether2.  What you described makes sense, I guess I've been accustomed to easy-mode with GUIs for far too long.


---
```

## Response 2
Author: [SOLVED]Sat Apr 20, 2024 1:49 am
``` exporthide-sensitive ``` ``` /interfaceethernetset[finddefault-name=ether1]name=ether1-ontset[finddefault-name=ether2]name=ether2-udmpset[finddefault-name=ether3]name=ether3-lan/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether1-ont name=pppoe-out1 user=user1/ip dhcp-serveraddadd-arp=yesinterface=ether2-udmp lease-time=5mname=server-lan/ip vrfaddinterfaces=pppoe-out1 name=vrf-wanaddinterfaces=ether2-udmp name=vrf-lan/ip addressaddaddress=100.64.1.1interface=ether2-udmp network=100.64.1.1/ip dhcp-clientaddinterface=ether3-lan/ip dhcp-server leaseaddaddress=100.64.0.24mac-address=0C:48:07:B6:00:00server=server-lan/ip firewall mangleaddaction=mark-routing chain=prerouting dst-address=!100.64.1.1in-interface=ether2-udmp log-prefix=LANnew-routing-mark=vrf-wan passthrough=yesaddaction=mark-routing chain=preroutingin-interface=pppoe-out1new-routing-mark=vrf-lan passthrough=yes/ip routeadddst-address=100.64.0.24gateway=ether2-udmp@vrf-lan routing-table=vrf-lan/system identitysetname=PPPoE-Client ``` Maybe you should share the config with
```
Also i missed something in the last post. You need to also add a route to your public ip in the "vrf-lan" instance.add dst-address=<public ip> gateway=ether2@vrf-lan routing-table=vrf-lanThis should work. 100.64.0.24 is the public ip in this example.
```

```
A red marked dhcp server usually means that the dhcp server interface is on a slave port, e.g. form a bridge, or the port is disabled.A problem that could also occur is, if you have a dynamic IPv4 address via pppoe because the the dhcp lease will not automatically change. But this could be easily solved with scripting.


---
```

## Response 3
Author: Sat Apr 20, 2024 3:28 am
Also i missed something in the last post. You need to also add a route to your public ip in the "vrf-lan" instance.add dst-address=<public ip> gateway=ether2@vrf-lan routing-table=vrf-lanA problem that could also occur is, if you have a dynamic IPv4 address via pppoe because the the dhcp lease will not automatically change. But this could be easily solved with scripting.I had a play with this and it works, with a bit of fiddling. CoolNote on mine I also added the following (The dhcp client I am using is windows 10 though)/ip dhcp-server networkadd address=STATIC_PPPOE_IP/32 comment="for pppoe passthru" dns-server=\DNS_SERVER_IP gateway=100.64.1.1I thought about some scripting for dynamic IP, and discovered (again) there is no on-Up Script functionality in the pppoe client ---

## Response 4
Author: Sat Apr 20, 2024 3:52 pm
``` :localpassInterface"ether2-udmp";:localpassMACAddress"0C:48:07:B6:00:00";### Internal varaibles:localip $"local-address";:localpassVRFName[/ip/vrf/get[find interfaces=$passInterface]name];:localdhcpServerName[/ip/dhcp-server/get[findinterface=$passInterface]name];:localipPoolName"pass-through-ip";:localgatewayVRF($passInterface."@".$passVRFName);:localgatewayAddressCidr[/ip/address/get[([findinterface=ether2-udmp]->0)]address];:localgatewayAddress[:pick $gatewayAddressCidr0[:find $gatewayAddressCidr"/"]];:localdhcpServerPool[/ip/dhcp-server/get[findinterface=$passInterface]address-pool];:localcommentIdentifier"pppoe pass through script";### Code/ip/dhcp-server/lease/remove[find server=$dhcpServerName];/log/info message="Removing old dhcp leases from server $dhcpServerName";:if([:len $passMACAddress]=0)do={:if($dhcpServerPool="static-only")do={/ip/pool/addname=$ipPoolName ranges=$ip;/ip/dhcp-server/set[findinterface=$passInterface]address-pool=$ipPoolName;}else={/ip/pool/set[find name=$dhcpServerPool]ranges=$ip;}/log/info message="Updated dhcp range to $ip";}else={/ip/dhcp-server/lease/addserver=$dhcpServerName mac-address=$passMACAddress address=$ip;/ip/dhcp-server/set[findinterface=$passInterface]address-pool="static-only";/ip/pool/remove[find name=$ipPoolName];/log/info message="Added dhcp lease for pass through device ($passMACAddress)";}:localdhcpNetworks[/ip/dhcp-server/network/find comment=$commentIdentifier];:if([:len $dhcpNetworks]>0)do={:localfirst[:toid($dhcpNetworks->0)];/ip/dhcp-server/network/remove[find comment!=$commentIdentifier address="$ip/32"];/ip/dhcp-server/network/set$first address="$ip/32"comment=$commentIdentifier gateway=$gatewayAddress netmask=32}else={/ip/dhcp-server/network/addcomment=$commentIdentifier address="$ip/32"gateway=$gatewayAddress netmask=32;}/ip/dhcp-server/network/remove[find comment=$commentIdentifier address!="$ip/32"];/ip/route/remove[find routing-table=$passVRFNamestatic=yes];/ip/route/adddst-address=$ip gateway=$gatewayVRF routing-table=$passVRFName;/ip/dhcp-server/enable[findinterface=$passInterface disabled=yes]; ``` ``` :localpassInterface"ether2-udmp";## Code/ip/dhcp-server/disable[findinterface=$passInterface disabled=no] ``` Note on mine I also added the following (The dhcp client I am using is windows 10 though)/ip dhcp-server networkadd address=STATIC_PPPOE_IP/32 comment="for pppoe passthru" dns-server=\DNS_SERVER_IP gateway=100.64.1.1Yeah for a Windows 10 client this shoud be fine but for a router i would specify a public dns resolver manuell on the pass through device. Cascading dns resolvers with there own cache is a bad idea in my opinion.I think this should do the trick. passMACAddress can be empty. Then the first device asking for an ip will get the public ip. Change to the /ip/dhcp/network, for example to the dns server, are persistent.UP Script
```
Down Script
```

```
---
```

## Response 5
Author: Thu Nov 21, 2024 12:26 pm
``` /interfaceethernetset[finddefault-name=ether1]comment="LAN MGMT"set[finddefault-name=ether2]comment="FTTP ONT"mtu=1508set[finddefault-name=ether3]comment="Fortigate WAN1"/ip dhcp-serveraddadd-arp=yesinterface=ether3 lease-time=5mname=server-wan/ip vrfaddinterfaces=ether3 name=vrf-wan/ppp profileaddname=pppoe on-down=":local passInterface \"ether3\";\r\ \n\r\ \n## Code\r\ \n\r\ \n/ip/dhcp-server/disable [ find interface=\$passInterface disabled=no ]"on-up=":local passInterface \"ether3\";\r\ \n:local passMACAddress \"94:ff:3c:xx:xx:xx\";\r\ \n\r\ \n### Internal varaibles\r\ \n\r\ \n:local ip \$\"local-address\";\r\ \n:local passVRFName [ /ip/vrf/get [ find interfaces=\$passInterface ] name ];\r\ \n:local dhcpServerName [ /ip/dhcp-server/get [ find interface=\$passInterface ] name ];\r\ \n:local ipPoolName \"pass-through-ip\";\r\ \n:local gatewayVRF (\$passInterface . \"@\" . \$passVRFName);\r\ \n:local gatewayAddressCidr [ /ip/address/get [ ( [ find interface=\$passInterface]->0 ) ] address ];\r\ \n:local gatewayAddress [ :pick \$gatewayAddressCidr 0 [ :find \$gatewayAddressCidr \"/\" ] ];\r\ \n:local dhcpServerPool [ /ip/dhcp-server/get [ find interface=\$passInterface ] address-pool ];\r\ \n:local commentIdentifier \"pppoe pass through script\";\r\ \n\r\ \n### Code\r\ \n\r\ \n/ip/dhcp-server/lease/remove [ find server=\$dhcpServerName ];\r\ \n/log/info message=\"Removing old dhcp leases from server \$dhcpServerName\";\r\ \n\r\ \n:if ( [ :len \$passMACAddress ] = 0 ) do={\r\ \n\r\ \n :if ( \$dhcpServerPool = \"static-only\" ) do={\r\ \n \r\ \n /ip/pool/add name=\$ipPoolName ranges=\$ip;\r\ \n /ip/dhcp-server/set [ find interface=\$passInterface ] address-pool=\$ipPoolName;\r\ \n } else={\r\ \n /ip/pool/set [ find name=\$dhcpServerPool ] ranges=\$ip;\r\ \n }\r\ \n \r\ \n /log/info message=\"Updated dhcp range to \$ip\";\r\ \n \r\ \n} else={\r\ \n /ip/dhcp-server/lease/add server=\$dhcpServerName mac-address=\$passMACAddress address=\$ip;\r\ \n /ip/dhcp-server/set [ find interface=\$passInterface ] address-pool=\"static-only\";\r\ \n /ip/pool/remove [ find name=\$ipPoolName ];\r\ \n /log/info message=\"Added dhcp lease for pass through device (\$passMACAddress)\";\r\ \n}\r\ \n\r\ \n:local dhcpNetworks [ /ip/dhcp-server/network/find comment=\$commentIdentifier ];\r\ \n\r\ \n:if ( [ :len \$dhcpNetworks ] > 0) do={\r\ \n \r\ \n :local first [ :toid (\$dhcpNetworks->0)];\r\ \n /ip/dhcp-server/network/remove [ find comment!=\$commentIdentifier address=\"\$ip/32\" ];\r\ \n /ip/dhcp-server/network/set \$first address=\"\$ip/32\" comment=\$commentIdentifier gateway=\$gatewayAddress netmask=32;\r\ \n} else={\r\ \n /ip/dhcp-server/network/add comment=\$commentIdentifier address=\"\$ip/32\" gateway=\$gatewayAddress netmask=32 dns-server=8.8.8.8;\r\ \n}\r\ \n\r\ \n/ip/dhcp-server/network/remove [ find comment=\$commentIdentifier address!=\"\$ip/32\" ];\r\ \n\r\ \n/ip/route/remove [ find routing-table=\$passVRFName static=yes ];\r\ \n/ip/route/add dst-address=\$ip gateway=\$gatewayVRF routing-table=\$passVRFName;\r\ \n\r\ \n/ip/dhcp-server/enable [ find interface=\$passInterface disabled=yes ];"/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether2 max-mru=1500max-mtu=1500name=pppoe-vodafone profile=pppoe user=pppoeuser/ip addressaddaddress=192.168.0.2/24interface=ether1 network=192.168.0.0addaddress=100.64.1.1interface=ether3 network=100.64.1.1/ip dnssetservers=192.168.0.1/ip vrfaddinterfaces=ether2, pppoe-vodafone name=vrf-ont/ip firewall mangleaddaction=mark-routing chain=prerouting dst-address=!100.64.1.1in-interface=ether3 log-prefix=WANnew-routing-mark=vrf-ontaddaction=mark-routing chain=preroutingin-interface=pppoe-vodafone log-prefix=PPPOEnew-routing-mark=vrf-wan/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=192.168.0.1routing-table=main suppress-hw-offload=no/system identitysetname=PPPoE_Client ``` @TheWeegeecan i get the full concept please.Have the pppoe & the pub ip-address (100.64.1.0) been provided from the same ISP?Here is the config that I am using for this I have changed the MAC address and IP addresses but otherwise it’s a working example
```
---
```

## Response 6
Author: Sat Dec 07, 2024 12:20 am
``` /interfaceethernetset[finddefault-name=ether1]comment="LAN MGMT"set[finddefault-name=ether2]comment="FTTP ONT"mtu=1508set[finddefault-name=ether3]comment="Fortigate WAN1"/ip dhcp-serveraddadd-arp=yesinterface=ether3 lease-time=5mname=server-wan/ip vrfaddinterfaces=ether3 name=vrf-wan/ppp profileaddname=pppoe on-down=":local passInterface \"ether3\";\r\ \n\r\ \n## Code\r\ \n\r\ \n/ip/dhcp-server/disable [ find interface=\$passInterface disabled=no ]"on-up=":local passInterface \"ether3\";\r\ \n:local passMACAddress \"94:ff:3c:xx:xx:xx\";\r\ \n\r\ \n### Internal varaibles\r\ \n\r\ \n:local ip \$\"local-address\";\r\ \n:local passVRFName [ /ip/vrf/get [ find interfaces=\$passInterface ] name ];\r\ \n:local dhcpServerName [ /ip/dhcp-server/get [ find interface=\$passInterface ] name ];\r\ \n:local ipPoolName \"pass-through-ip\";\r\ \n:local gatewayVRF (\$passInterface . \"@\" . \$passVRFName);\r\ \n:local gatewayAddressCidr [ /ip/address/get [ ( [ find interface=\$passInterface]->0 ) ] address ];\r\ \n:local gatewayAddress [ :pick \$gatewayAddressCidr 0 [ :find \$gatewayAddressCidr \"/\" ] ];\r\ \n:local dhcpServerPool [ /ip/dhcp-server/get [ find interface=\$passInterface ] address-pool ];\r\ \n:local commentIdentifier \"pppoe pass through script\";\r\ \n\r\ \n### Code\r\ \n\r\ \n/ip/dhcp-server/lease/remove [ find server=\$dhcpServerName ];\r\ \n/log/info message=\"Removing old dhcp leases from server \$dhcpServerName\";\r\ \n\r\ \n:if ( [ :len \$passMACAddress ] = 0 ) do={\r\ \n\r\ \n :if ( \$dhcpServerPool = \"static-only\" ) do={\r\ \n \r\ \n /ip/pool/add name=\$ipPoolName ranges=\$ip;\r\ \n /ip/dhcp-server/set [ find interface=\$passInterface ] address-pool=\$ipPoolName;\r\ \n } else={\r\ \n /ip/pool/set [ find name=\$dhcpServerPool ] ranges=\$ip;\r\ \n }\r\ \n \r\ \n /log/info message=\"Updated dhcp range to \$ip\";\r\ \n \r\ \n} else={\r\ \n /ip/dhcp-server/lease/add server=\$dhcpServerName mac-address=\$passMACAddress address=\$ip;\r\ \n /ip/dhcp-server/set [ find interface=\$passInterface ] address-pool=\"static-only\";\r\ \n /ip/pool/remove [ find name=\$ipPoolName ];\r\ \n /log/info message=\"Added dhcp lease for pass through device (\$passMACAddress)\";\r\ \n}\r\ \n\r\ \n:local dhcpNetworks [ /ip/dhcp-server/network/find comment=\$commentIdentifier ];\r\ \n\r\ \n:if ( [ :len \$dhcpNetworks ] > 0) do={\r\ \n \r\ \n :local first [ :toid (\$dhcpNetworks->0)];\r\ \n /ip/dhcp-server/network/remove [ find comment!=\$commentIdentifier address=\"\$ip/32\" ];\r\ \n /ip/dhcp-server/network/set \$first address=\"\$ip/32\" comment=\$commentIdentifier gateway=\$gatewayAddress netmask=32;\r\ \n} else={\r\ \n /ip/dhcp-server/network/add comment=\$commentIdentifier address=\"\$ip/32\" gateway=\$gatewayAddress netmask=32 dns-server=8.8.8.8;\r\ \n}\r\ \n\r\ \n/ip/dhcp-server/network/remove [ find comment=\$commentIdentifier address!=\"\$ip/32\" ];\r\ \n\r\ \n/ip/route/remove [ find routing-table=\$passVRFName static=yes ];\r\ \n/ip/route/add dst-address=\$ip gateway=\$gatewayVRF routing-table=\$passVRFName;\r\ \n\r\ \n/ip/dhcp-server/enable [ find interface=\$passInterface disabled=yes ];"/interfacepppoe-clientaddadd-default-route=yes disabled=nointerface=ether2 max-mru=1500max-mtu=1500name=pppoe-vodafone profile=pppoe user=pppoeuser/ip addressaddaddress=192.168.0.2/24interface=ether1 network=192.168.0.0addaddress=100.64.1.1interface=ether3 network=100.64.1.1/ip dnssetservers=192.168.0.1/ip vrfaddinterfaces=ether2, pppoe-vodafone name=vrf-ont/ip firewall mangleaddaction=mark-routing chain=prerouting dst-address=!100.64.1.1in-interface=ether3 log-prefix=WANnew-routing-mark=vrf-ontaddaction=mark-routing chain=preroutingin-interface=pppoe-vodafone log-prefix=PPPOEnew-routing-mark=vrf-wan/ip routeadddisabled=nodst-address=0.0.0.0/0gateway=192.168.0.1routing-table=main suppress-hw-offload=no/system identitysetname=PPPoE_Client ``` Thanks for posting this. I've spent about 3 days trying to get this concept to work but so far without success.I'm usually fairly network literate, but Mikrotik RouterOS pushes me well outside my comfort zone!What I am really struggling to grasp is how to relate my IP addresses with the addresses in the script.The only thing I am sure of is that I need to replace the MAC address in the script with the mac address of the WAN port of my UDMP.My IP addresses:1) 192.168.4.1 UDMP's lan address2) WAN IP address 45.153.x.x (offered by DHCP from the ISP)3) Mikrotik Router IP address 192.168.88.1Script IP addresses:192.168.0.2/24 I don't know what this address relates to and why do I need it192.168.0.0 It seems that I should substitute this with my internal network address 192.168.4.0100.64.1.1 - Should I substitute this address for my WAN address 45.153.x.x?192.168.0.1 - Should I substitute this with my internal router address 192.168.4.1?@TheWeegeecan i get the full concept please.Have the pppoe & the pub ip-address (100.64.1.0) been provided from the same ISP?Here is the config that I am using for this I have changed the MAC address and IP addresses but otherwise it’s a working example
```
[/quote]
```