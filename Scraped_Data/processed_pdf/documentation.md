# MikroTik Documentation

1.5.10.1 Basic VLAN switching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 487 1.5.10.2 Bridge IGMP/MLD snooping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 491 1.5.10.3 Bridge VLAN Table . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 501 1.5.10.4 Controller Bridge and Port Extender . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 513 1.5.10.5 CRS1xx/2xx series switches examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 526 1.5.10.6 CRS3xx, CRS5xx, CCR2116, CCR2216 VLANs with Bonds . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 548 1.5.10.7 Layer2 misconfiguration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 555 1.5.10.8 Loop Protect . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 577 1.5.10.9 QoS with Switch Chip . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 578 1.5.10.10 Spanning Tree Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 583 1.5.10.11 Wireless VLAN Trunk . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 597 1.5.10.12 WMM and VLAN priority . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 600 1.6 Firewall and Quality of Service . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 604 1.6.1 Connection tracking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 605 1.6.2 Firewall . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 610 1.6.2.1 Filter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 612 1.6.2.2 Mangle . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 618 1.6.2.3 NAT . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 621 1.6.2.4 Common Firewall Matchers and Actions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 630 1.6.2.5 Layer7 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 638 1.6.2.6 Address-lists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 640 1.6.3 Packet Flow in RouterOS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 642 1.6.4 Queues . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 668 1.6.4.1 HTB (Hierarchical Token Bucket) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 678 1.6.4.2 Queue size . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 686 1.6.4.3 Queue Burst . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 689 1.6.4.4 PCQ example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 695 1.6.4.5 Queue types . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 697 1.6.4.5.1 CAKE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 698 1.6.4.5.2 PFIFO,BFIFO . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 703 1.6.5 Firewall and QoS Case Studies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 705 1.6.5.1 Building Advanced Firewall . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 706 1.6.5.2 Port knocking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 712 1.6.5.3 Building Your First Firewall . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 714 1.6.5.4 DDoS Protection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 715 1.6.5.5 Connection rate . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 717 1.6.5.6 Bruteforce prevention . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 720 1.6.6 Kid Control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 721 1.6.7 UPnP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 723 1.6.8 NAT-PMP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 726 1.6.9 IP Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 729 1.7 High Availability Solutions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 730 1.7.1 Load Balancing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 731 1.7.1.1 Failover (WAN Backup) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 732 1.7.1.2 OSPF Load Balancing (restricted) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 734 1.7.1.3 Per connection classifier . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 735 1.7.2 Bonding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 739 1.7.3 Bonding Examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 747 1.7.4 HA Case Studies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 750 1.7.5 Multi-chassis Link Aggregation Group . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 751 1.7.6 VRRP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 757 1.7.7 VRRP Configuration Examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 765 1.8 Mobile Networking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 770 1.8.1 GPS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 771 1.8.1.1 GPS-tracking using HTTP POST . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 774 1.8.1.2 GPS-tracking using MQTT and ThingsBoard . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 777 1.8.2 LTE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 783 1.8.3 PPP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 796 1.8.4 SMS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 797 1.8.5 Dual SIM Application . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 801 1.9 Multi Protocol Label Switching - MPLS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 804 1.9.1 MPLS Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 805 1.9.2 MPLS MTU, Forwarding and Label Bindings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 807 1.9.3 EXP bit and MPLS Queuing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 810 1.9.4 LDP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 812

1.9.5 VPLS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 826 1.9.5.1 VPLS Control Word . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 829 1.9.6 Traffic Eng . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 831 1.9.7 MPLS Reference . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 834 1.9.8 MPLS Case Studies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 835 1.10 Network Management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 836 1.10.1 ARP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 837 1.10.2 Cloud . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 840 1.10.3 DHCP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 845 1.10.4 DNS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 876 1.10.5 SOCKS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 883 1.10.6 Proxy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 886 1.11 Routing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 898 1.11.1 Routing Protocol Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 899 1.11.2 Moving from ROSv6 to v7 with examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 907 1.11.3 Routing Protocol Multi-core Support . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 913 1.11.4 Policy Routing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 916 1.11.5 Virtual Routing and Forwarding - VRF . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 919 1.11.6 OSPF . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 937 1.11.7 RIP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 961 1.11.8 BGP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 964 1.11.9 RPKI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 975 1.11.10 Route Selection and Filters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 977 1.11.11 Multicast . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 988 1.11.11.1 Group Management Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 989 1.11.11.2 IGMP Proxy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 990 1.11.11.3 PIM-SM . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 993 1.11.12 Routing Debugging Tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1001 1.11.12.1 /routing/fantasy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1003 1.11.12.2 /routing/route . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1004 1.11.13 Routing Reference . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1008 1.11.13.1 /routing/id . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1009 1.11.14 BFD . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1010 1.11.15 IS-IS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1012 1.12 Scripting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1015 1.12.1 Scripting examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1034 1.12.2 Scripting Tips and Tricks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1043 1.13 System Information and Utilities . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1049 1.13.1 Clock . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1050 1.13.2 Device-mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1051 1.13.3 E-mail . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1056 1.13.4 Fetch . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1059 1.13.5 Files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1062 1.13.6 Identity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1065 1.13.7 Interface Lists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1066 1.13.8 Neighbor discovery . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1068 1.13.9 Note . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1072 1.13.10 NTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1073 1.13.11 Partitions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1078 1.13.12 Precision Time Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1080 1.13.13 Scheduler . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1084 1.13.14 Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1087 1.13.15 TFTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1090 1.14 Virtual Private Networks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1092 1.14.1 6to4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1093 1.14.2 EoIP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1097 1.14.3 GRE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1101 1.14.4 IPIP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1104 1.14.5 IPsec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1106 1.14.5.1 IKEv2 EAP between NordVPN and RouterOS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1147 1.14.6 L2TP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1150 1.14.6.1 LAC and LNS setup with Cisco as LAC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1155 1.14.7 OpenVPN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1158 1.14.8 PPPoE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1164 1.14.8.1 IPv6 PD over PPP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1170

1.19.7 IP Scan . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1618 1.19.8 Log . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1619 1.19.8.1 Syslog with Elasticsearch . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1625 1.19.9 Netwatch . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1633 1.19.10 Packet Sniffer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1639 1.19.11 Ping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1644 1.19.12 Profiler . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1646 1.19.13 Resource . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1649 1.19.14 SNMP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1653 1.19.15 Speed Test . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1659 1.19.16 S-RJ10 general guidance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1661 1.19.17 Torch . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1663 1.19.18 Traceroute . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1664 1.19.19 Traffic Flow . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1665 1.19.19.1 NetFlow analysis with Elasticsearch . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1669 1.19.20 Traffic Generator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1674 1.19.21 Watchdog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1685 1.20 Extended features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1687 1.20.1 Back To Home . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1688 1.20.2 Container . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1693 1.20.2.1 Container - freeradius server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1700 1.20.2.2 Container - HomeAssistant . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1705 1.20.2.3 Container - mosquitto MQTT server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1708 1.20.2.4 Container - ThingsBoard MQTT/HTTP server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1715 1.20.3 DLNA Media server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1728 1.20.4 ROSE-storage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1729 1.20.5 SMB . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1741 1.20.6 UPS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1744 1.20.7 Wake on LAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1748 1.20.8 IP packing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1749

Jan 07, 2025 attached by • Serhii T.

Firewall Stateful filtering Source and destination NAT NAT helpers (h323, pptp, quake3, sip, ftp, irc, tftp) Internal connection, routing and packet marks Filtering by IP address and address range, port and port range, IP protocol, DSCP and many more Address lists Custom Layer7 matcher IPv6 support PCC - per connection classifier, used in load balancing configurations RAW filtering to bypass connection tracking. Routing Static routing Virtual Routing and Forwarding (VRF) Policy based routing Interface routing ECMP routing IPv4 dynamic routing protocols: RIP v1/v2, OSPFv2, BGP v4 IPv6 dynamic routing protocols: RIPng, OSPFv3, BGP Bidirectional Forwarding Detection (BFD) MPLS Static Label bindings for IPv4 Label Distribution protocol for IPv4 RSVP Traffic Engineering tunnels VPLS MP-BGP based autodiscovery and signaling MP-BGP based MPLS IP VPN VPN IPSec – tunnel and transport mode, certificate or PSK, AH and ESP security protocols. IKEv2 support AES-NI hardware acceleration support for IPSec Point to point tunneling ( OpenVPN, PPTP, PPPoE, L2TP, SSTP) Advanced PPP features (MLPPP, BCP) BCP supported on sstp, ppp, pptp, l2tp and pppoe Simple tunnels ( IPIP, EoIP) IPv4 andIPv6 support 6to4 tunnel support (IPv6 over IPv4 network) VLAN – IEEE802.1q Virtual LAN support, Q-in-Q support MPLS based VPNs WireGuard ZeroTier Wireless IEEE802.11a/b/g wireless client and access point Full IEEE802.11n support Nstreme and Nstreme2 proprietary protocols NV2 protocol Wireless Distribution System (WDS) Virtual AP WEP, WPA, WPA2 Access control list Wireless client roaming WMM HWMP+ Wireless MESH protocol MME wireless routing protocol

Kernel version RouterOS version 6.x uses 3.3.5 RouterOS version 7.x uses 5.6.3 Supported Encryptions RouterOS 7 is used for the management of network (telecommunication) devices. RouterOS 7 includes encryption features (components), intended for data (information) security, passed through telecommunication channels and device control channels. All encryption features (components) are an integral part of RouterOS 7 and can not be changed by the end-users. RouterOS 7 is intended for installation by end-users without significant support from the vendor. RouterOS 7 uses the following security protocols: Supported security protocol Encryption algorithm Maximum key length IPSecDES 56 bit 3DES 168 bit AES 128, 192, 256 bit Blowfish 448 bit Twofish 256 bit Camelia 128, 192, 256 bit PPTP (with MPPE) RC4 128 bit L2TP (with MPPE) RC4 128 bit SNMP DES 56 bit AES 128 bit SSH Blowfish 128 bit 3DES 192 bit AES 128, 192, 256 bit SSTP AES 256 bit RC4 128 bit Used in WinBox connection (nameless) AES 128 bit WEP RC4 104 bit WPA-TKIP RC4 128 bit WPA2-TKIP RC4 128 bit WPA-AES AES 128 bit WPA2-AES AES 128 bit HTTPS NULL, RC4, DES, DES40, 3DES, AES 128, 192, 256 bit

Feature support based on architecture All devices support the same features, with a few exceptions, clarified in the below table: Architecture Not supported Exclusively supported ARM Zerotier, Container, BTH ARM64 Zerotier, Container, BTH MIPSBE Zerotier, Dude server MMIPS Zerotier SMIPS Zerotier, DOT1X, BGP, MPLS, PIMSM, Dude server, User manager TILE Zerotier BTH PPC Zerotier, Dude server X86 PC Zerotier, Cloud Container CHR VM Apart from features, there are also a few differences in hardware capabilities, based on the specific model of device. For these differences, please see the below articles: Wifi - new driver implementation for 802.11ax devices and supported older devices https://help.mikrotik.com/docs/display/ROS/Wifi L3 Hardware offloading https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-L3HWDeviceSupport PTP https://help.mikrotik.com/docs/display/ROS/Precision+Time+Protocol Switch chip features https://help.mikrotik.com/docs/display/ROS/Switch+Chip+Features

First Time Configuration Connecting to the Router Router without Default Configuration Configuring IP Access Configuring Internet Connection Dynamic Public IP Static Public IP PPPoE Connection Verify Connectivity Protecting the Router User Password Access MAC Connectivity Access Neighbor Discovery IP Connectivity Access Administrative Services Other Services NAT Configuration Port Forwarding Setting up Wireless Protecting the Clients Blocking Unwanted Websites Troubleshooting Troubleshoot if ping fails Connecting to the Router There are two types of routers: Routers with default configuration. Routers without default configuration. In cases where no specific configuration is present, the IP address 192.168.88.1/24 is assigned to ether1, combo1, sfp1, or . MGMT/BOOT For additional details regarding the current default configuration, please refer to the Quick Guide document provided with your device. This document outlines which ports to initially utilize for connection and instructions on device setup. This document describes the step-by-step process for configuring the device from scratch. Therefore, we recommend clearing all defaults when initiating the setup. When connecting the first time to the router with the default username and ( admin no password or, for some models, check user and wireless passwords on the sticker ). Upon the initial boot, a notification will appear, offering you the choice to either remove the default configuration (even if the default config has only an IP address), leading to a reboot with no configuration applied, or to "Show Script" and retain the current default configuration, applying it Since this article assumes that there is no configuration on the router, you should remove it by pressing "r" on the keyboard when prompted or accordingly. click on the button in WinBox. "Remove Configuration" Router without Default Configuration If the router doesn't have a default configuration, there are multiple options to consider. However, in this case, we'll opt for a method that best fits our requirements. Connect the ISP cable to the router's ether1 port and connect your PC . to any port except ether1 Then, launch WinBox and search for your router using See detailed example in . the neighbor discovery feature. Winbox article If the router appears in the list, select its MAC address and click Connect . The easiest method to ensure a completely clean router is to run the CLI command /system reset-configuration no-defaults=yes skip-backup=yes Or from WinBox:

Configuring IP Access As MAC connection can sometimes be unreliable, our first step is to configure the router to enable IP connectivity: Create a bridge interface and assign bridge ports; Assign an ; IP address to the bridge interface Configure a DHCP server. Setting up the bridge and assigning an IP address are straightforward processes: /interface bridge add name=bridge1 /interface bridge port add interface=ether2 bridge=bridge1 /ip address add address=192.168.88.1/24 interface=bridge1 If you prefer WinBox/WebFig as configuration tools: Open window, tab should be selected; Bridge Bridge Click on the button ; + to open a new dialog box. You can either enter a custom bridge name or retain the default , then click to proceed bridge1 OK Switch to the Ports tab and click on the button ; + to open another dialog box Select interface and bridge form drop-down lists and click on the button to apply settings; ether2 bridge1 OK You may close the bridge dialog.

Access the menu and navigate to the dialog IP Addresses ; Select the button ; + to open a new dialog box Enter IP address select interface from the drop-down list; 192.168.88.1/24 bridge1 Click to confirm the settings.OK

/ip address add address=1.2.3.100/24 interface=ether1 /ip route add gateway=1.2.3.1 /ip dns set servers=8.8.8.8 PPPoE Connection PPPoE connection also gives you a dynamic IP address and can configure dynamically DNS and default gateway. Typically service provider (ISP) gives you a username and password for the connection /interface pppoe-client add disabled=no interface=ether1 user=me password=123 \ add-default-route=yes use-peer-dns=yes Winbox/WebFig actions: In the window, select the tab and click the "+" button; PPP Interfaces Choose from the dropdown list; PPPoE Client Set the name and select as the interface; ether1 Go to the tab, configure the username, password, and other parameters; Dial Out Click to save the settings.OK Further in configuration, the interface is now the interface, not . WAN pppoe-out1 ether1

To add additional rules, click on the "+" button for each new rule and fill in the same parameters as provided in the console example. Administrative Services Although the firewall protects the router from the public interface, you may still want to disable RouterOS services. Most of RouterOS administrative tools are configured at the menu /ip service Keep only secure ones, /ip service disable telnet,ftp,www,api

/ip firewall filter add chain=forward action=fasttrack-connection connection-state=established,related \ comment="fast-track for established,related"; add chain=forward action=accept connection-state=established,related \ comment="accept established,related"; add chain=forward action=drop connection-state=invalid add chain=forward action=drop connection-state=new connection-nat-state=!dstnat \ in-interface=ether1 comment="drop access to clients behind NAT from WAN" A ruleset is similar to input chain rules (accept established/related and drop invalid), except the first rule with . This action=fasttrack-connection rule allows established and related connections to bypass the firewall and significantly reduce CPU usage. Another difference is the last rule which drops all new connection attempts from the WAN port to our LAN network (unless DstNat is used). Without this rule, if an attacker knows or guesses your local subnet, he/she can establish connections directly to local hosts and cause a security threat. For more detailed examples on how to build firewalls will be discussed in the firewall section. Blocking Unwanted Websites Sometimes you may want to block certain websites, for example, deny access to entertainment sites for employees, deny access to porn, and so on. This can be achieved by redirecting HTTP traffic to a proxy server and use an access-list to allow or deny certain websites. First, we need to add a NAT rule to redirect HTTP to our proxy. We will use RouterOS built-in proxy server running on port 8080. /ip firewall nat add chain=dst-nat protocol=tcp dst-port=80 src-address=192.168.88.0/24 \ action=redirect to-ports=8080 Enable web proxy and drop some websites: /ip proxy set enabled=yes /ip proxy access add dst-host=www.facebook.com action=deny /ip proxy access add dst-host=*.youtube.* action=deny /ip proxy access add dst-host=:vimeo action=deny Using Winbox: On the left menu navigate to IP -> Web Proxy Web proxy settings dialog will appear. Check the "Enable" checkbox and click on the "Apply" button Then click on the "Access" button to open the "Web Proxy Access" dialog In the "Web Proxy Access" dialog click on "+" to add a new Web-proxy rule

or disable it: /lcd/set enabled=no

Add new package source on device which will be updated, in this example we use mirror device 10.155.136.71: Once you click Refresh in Local Update packages tab, device using Winbox will try to connect to source and check if there are new packages. Choose packages and click download, after download completes device will be needed to reboot for update.

NetInstall can also directly install RouterOS onto a disk (USB/CF/IDE/SATA) connected to the NetInstall Windows machine. Once installed, simply transfer the disk to the Router machine and boot from it. Attention! Do not try to install RouterOS on your system drive. Action will format your hard drive and wipe out your existing OS. CD Install RouterOS Package Types Information about RouterOS packages can be found here

Command Description disable schedule the package to be disabled after the next reboot. No features provided by the package will be accessible downgrade will prompt for the reboot. During the reboot process will try to downgrade the RouterOS to the oldest version possible by checking the packages that are uploaded to the router. enable schedule package to be enabled after the next reboot uninstall schedule package to be removed from the router. That will take place during the reboot. unschedule remove scheduled task for the package. print outputs information about the packages, like: version, package state, planned state changes, etc. update manages the channel and performs RouterOS upgrades "check-for-updates" Menu: /system/check-installation The "Check installation" function ensures the integrity of the RouterOS system by verifying the readability and correct placement of files. Its primary purpose is to confirm the health and status of your NAND/Flash storage. Menu: /system/package/update install ignore-missing command allows upgrading only the RouterOS main package, while omitting packages that are either missing or not uploaded during a manual upgrade process. Examples The upgrade process is described . here List of available packages. zerotier package is disabled and dude package is scheduled for uninstall. /system package print Flags: X - DISABLED Columns: NAME, VERSION, SCHEDULED # NAME VERSION SCHEDULED 0 dude 7.9 scheduled for uninstall 1 X zerotier 7.9 2 routeros 7.9 Uninstall package /system package uninstall dude; /system reboot; Reboot, yes? [y/N]: Disable package /system package disable zerotier; /system reboot; Reboot, yes? [y/N]: Downgrade /system package downgrade; /system reboot; Reboot, yes? [y/N]: Cancel uninstall or disable action /system package unschedule zerotier; /system package unschedule dude;

Configuration Management Overview Configuration Undo and Redo Safe Mode System Backup and Restore Configuration Export and Import Configuration Export Configuration Import Auto Import Import troubleshooting Configuration parts to watch out for in exported .rsc files Startup delay Configuration Reset Overview This article describes a set of commands used for configuration management. Configuration Undo and Redo Any action done in the GUI or any command executed from the CLI is recorded in . You can undo or redo any action by running /system history undo or commands from the CLI or by clicking on Undo, and Redo buttons from the GUI. redo A simple example to demonstrate the addition of the firewall rule and how to undo and redo the action: [admin@v7_ccr_bgp] /ip/firewall/filter> add chain=forward action=drop [admin@v7_ccr_bgp] /ip/firewall/filter> print Flags: X - disabled, I - invalid; D - dynamic 0 X chain=input action=drop protocol=icmp src-address=10.155.101.1 log=no log-prefix="" 1 chain=forward action=drop [admin@v7_ccr_bgp] /ip/firewall/filter> /system/history/print Flags: U - undoable, R - redoable, F - floating-undo Columns: ACTION, BY, POLICy ACTION BY POLIC F filter rule added admin write U --- write [admin@v7_ccr_bgp] /ip/firewall/filter> We have added a firewall rule and in we can see all that was done. /system history Let's undo everything: [admin@v7_ccr_bgp] /ip/firewall/filter> /undo [admin@v7_ccr_bgp] /ip/firewall/filter> print Flags: X - disabled, I - invalid; D - dynamic 0 X chain=input action=drop protocol=icmp src-address=10.155.101.1 log=no log-prefix="" [admin@v7_ccr_bgp] /ip/firewall/filter> As you can see firewall rule disappeared. Now redo the last change:

[admin@v7_ccr_bgp] /ip/firewall/filter> /redo [admin@v7_ccr_bgp] /ip/firewall/filter> print Flags: X - disabled, I - invalid; D - dynamic 0 X chain=input action=drop protocol=icmp src-address=10.155.101.1 log=no log-prefix="" 1 chain=forward action=drop [admin@v7_ccr_bgp] /ip/firewall/filter> System history is capable of showing exact CLI commands that will be executed during "Undo" or "Redo" actions even if we perform the action from GUI, for example, detailed history output after adding TCP accept rule from WinBox: [admin@v7_ccr_bgp] /system/history> print detail Flags: U - undoable, R - redoable, F - floating-undo F redo= /ip firewall filter add action=accept chain=forward disabled=no log=no \ log-prefix="" protocol=tcp undo=/ip firewall filter remove *4 action="filter rule added" by="admin" policy=write time=oct/10/2019 18:51:05 F redo=/ip firewall filter add action=accept chain=forward undo=/ip firewall filter remove *3 action="filter rule added" by="admin" policy=write time=oct/10/2019 18:49:03 U redo="" undo="" action="---" by="" policy=write time=sep/27/2019 13:07:35 [admin@v7_ccr_bgp] /system/history> Safe Mode It is sometimes possible to change router configuration in a way that will make the router inaccessible (except from the local console). Usually, this is done by accident, but there is no way to undo the last change when the connection to the router is already cut. Safe mode can be used to minimize such risk. The button in the Winbox GUI allows you to enter Safe Mode, while in the CLI, you can access it by either using the keyboard shortcut or "Safe Mode" F4 pressing . To exit without saving the made changes in CLI, hit [CTRL]+[X] [CTRL]+[D].

If too many changes are made while in safe mode, and there's no room in history to hold them all (currently history keeps up to 100 most recent actions), then the session is automatically put out of the safe mode, and no changes are automatically undone. Thus, it is best to change the configuration in small steps, while in safe mode. Pressing + twice is an easy way to empty the safe mode action list. [Ctrl] [X] System Backup and Restore System backup is the way to completely clone router configuration in binary format. More information about Backup and Restore is found .here Configuration Export and Import RouterOS allows exporting and importing parts of the configuration in plain text format. This method can be used to copy bits of configuration between different devices, for example, clone the whole firewall from one router to another. An export command can be executed from each menu (resulting in configuration export only from this specific menu and all its sub-menus) or from the root menu for complete config export and is available for CLI only. Configuration Export The following command parameters are accepted: Property Description compact Output only modified configuration, the default behavior file Export configuration to a specified file. When the file is not specified export output will be printed to the terminal show-sensitive yes|no( ; Default: no ). RouterOS version 7 only hide-sensitive yes|no( ; Default: no). RouterOS version 6 onlyShow sensitive information, like passwords, keys, etc. Hide sensitive information, like passwords, keys, etc. terse With this parameter, the export command will output only configuration parameters, without defaults. verbose With this parameter, the export command will output whole configuration parameters and items including defaults. For example, export configuration from the menu and save it to a file: /ip address The Export command does not export system user passwords, installed certificates, SSH keys, Dude, or a User-manager database. Installed certificates , , and databases must be manually exported and imported into a new device. Dude User-manager System user passwords and user SSH keys can not be exported. During config import, we suggest using the same RouterOS version used during config export to prevent cases when some of the commands do not exist in one or another RouterOS version.

Auto Import It is also possible to execute scripts after uploading to the router with FTP or SFTP. The script file must be named with the extension *.auto. automatically rsc. Once the commands in the file are executed, a new *.auto.log file is created which contains import success or failure information. Import troubleshooting Configuration parts to watch out for in exported .rsc files Things that should be removed from export files that were created with "/export", before attempting import on a new device. Interface renaming conflicts with the default ethernet naming scheme. /interface ethernet set [ find default-name=ether5 ] auto-negotiation=no name=ether1-gateway set [ find default-name=ether6 ] name=ether2 set [ find default-name=ether7 ] name=ether3 set [ find default-name=ether8 ] name=ether4 set [ find default-name=ether1 ] name=ether5 set [ find default-name=ether2 ] name=ether6 set [ find default-name=ether3 ] name=ether7 set [ find default-name=ether4 ] name=ether8 In older versions "export" default entries might show with "add" instead of the "set" command. That should be edited before import to avoid errors. Check if the total number of physical interfaces count matches the new and old devices. If there are some missing that will end up in error during . rsc import. In case of problematic import, attempt the following: Use the parameter to simulate the import without making any configuration changes. This helps in catching syntax errors. This option is dry-run only available in verbose mode. Reset the configuration on that device. Run the import command again with the "verbose=yes" argument. It will also stop the import process on a problem that you already encountered, but will also show the place where the export failed. This way shows you the place where things need to be edited in the .rsc import file. Startup delay If your configuration relies on interfaces that might not yet have started up upon command execution, it is suggested to introduce delays or to monitor until all needed interfaces are available. This example script allows you to set how many interfaces you are expecting, and how long to wait until they become available: { :local i 0 #Number of interfaces. It is necessary to reconfigure this number for each device (/interface print count-only) :local x 10 #Max time to wait :local t 30 while ($i < $t && [:len [/interface find]] < $x) do={ :put $i :set $i ($i + 1) :delay 1 } if ($i = $t) do={ :log warning message="Could not load all physical interfaces" } else={ #Rest of your script } } ".auto.rsc" in the filename is mandatory for a file to be automatically executed.

LTE CPE AP router This configuration type is applied to routers that have both LTE and wireless interfaces. LTE interface is considered a WAN port protected by a firewall and MAC discovery/connection disabled. The IP address on the WAN port is acquired automatically. Wireless is configured as an access point and bridged with all available Ethernet ports. List of routers using this type of configuration: wAP LTE Kit SXT LTE LtAP 4G kit LtAP LTE kit Chateau CPE RouterMode: * wireless interface connected to providers network (WAN port); * WAN port is protected by firewall and enabled DHCP client wlan1 Configuration: mode: station; band: 2ghz-b/g/n; tx-chains: 0;1; rx-chains: 0;1; installation: outdoor; wpa2: no; ht-extension: 20/40mhz-XX; LAN Configuration: IP address 192.168.88.1/24 is set on ether1 (LAN port) DHCP Server: enabled; DNS: enabled; WAN (gateway) Configuration: gateway:wlan1 ; ip4 firewall: enabled; ip6 firewall: enabled; NAT: enabled; DHCP Client: enabled; Login admin user protected by a password Configuration : preview .

AP Router This type of configuration is applied to home access point routers to be used straight out of the box without additional configuration (except router passwords and wireless keys) First Ethernet is always configured as a WAN port (protected by a firewall, enabled DHCP client, and disabled MAC connection/discovery). Other Ethernet ports and wireless interfaces are added to the local LAN bridge with 192.168.88.1/24 address set and configured DHCP server. In the case of dual-band routers, one wireless is configured as a 5 GHz access point and the other as a 2.4 GHz access point. List of routers using this type of configuration: RB 450,751,850,951,953,2011,3011,4011 hEX, PowerBox mAP wAP, wAP R (without LTE card) hAP cAP OmniTIK CRS series with wireless interface L009 series Audience Knot PWR CPE RouterMode: * wireless interface connected to providers network (WAN> * WAN port is protected by firewall and enabled DHCP cli> LAN Configuration: The IP address 192.168.188.1/24 is set on the bridge (LAN por> DHCP Server: enabled; DNS: enabled; WAN (gateway) Configuration: gateway:lte1 ; ip4 firewall: enabled; ip6 firewall: enabled; NAT: enabled; Login admin user protected by a password Configuration : preview .

PTP Bridge, W60G Bridge: Bridged Ethernet with a wireless interface. The default IP address 192.168.88.1/24 is set on the bridge interface. There are two possible options - CPE and AP. For CPE wireless interface is set in "station-bridge" mode, and for AP "bridge" mode is used. This configuration type is applied to W60G Bridge - routers that have a 60 GHz point-to-point link. RouterMode: * WAN port is protected by firewall and enabled DHCP cli> * Wireless and Ethernet interfaces (except WAN port/s) are part of the LAN bridge LAN Configuration: The IP address 192.168.88.1/24 is set on the bridge (LAN port) DHCP Server: enabled; DNS: enabled; wlan1 Configuration: mode: ap-bridge; band: 2ghz-b/g/n; tx-chains: 0;1; rx-chains: 0;1; installation: indoor; wpa2: no; ht-extension: 20/40mhz-XX; WAN (gateway) Configuration: ip4 firewall: enabled; ip6 firewall: enabled; NAT: enabled; DHCP Client: enabled; Login admin user protected by a password Configuration : preview

WISP Bridge The configuration is the same as PTP Bridge in AP mode, except that wireless mode is set to ap_bridge for PTMP setups. The router can be accessed directly using a MAC address. If the device is connected to the network with an enabled DHCP server, configured DHCP client configured on the bridge interface will get the IP address, that can be used to access the router. List of routers using this type of configuration: RB 911,912,921,922 - with Level4 license Groove A, RB 711 A BaseBox, NetBox mANTBox, NetMetal wAP 60G AP - with level4 license LtAP CME Switch WISP Bridge: * wireless and LAN interfaces are bridged; wlan1 Configuration: mode: ap-bridge; band: 2ghz-b/g/n; tx-chains: 0;1; rx-chains: 0;1; installation: outdoor; wpa2: no; ht-extension: 20/40mhz-XX; wlan2 Configuration: mode: ap-bridge; band: 5ghz-a/n/ac; tx-chains: 0;1; rx-chains: 0;1; installation: outdoor; wpa2: no; ht-extension: 20/40/80mhz-XXXX; LAN Configuration: DHCP Client: enabled on bridge (LAN port); Login admin user protected by a password Configuration : preview

This configuration utilizes switch chip features to configure a basic switch. All Ethernet ports are added to switch group and default IP address 192.168.88.1 /24 is set on bridge interface. List of routers using this type of configuration: FiberBox CRS without wireless interface IP Only When no specific configuration is found, IP address 192.168.88.1/24 is set on ether1, or combo1, or sfp1. List of routers using this type of configuration: RB 411,433,435,493,800,M11,M33,1100 CCR Switch mode: All interfaces switched; Login admin user protected by a password Configuration : preview

CAP This type of configuration is used when a device needs to be used as a wireless client device controlled by . CAPsMAN When CAP default configuration is loaded, ether1 is considered a management port with DHCP client configured. All other Ethernet interfaces are bridged and wlan1 is set to be managed by CAPsMAN. To load CAP configuration refer to . Reset Button manual LAN: IP on etherx: 192.168.88.1/24; Login admin no password. Configuration : preview

Reset Button Introduction The RouterOS password can only be reset by reinstalling the RouterOS or using the reset button (or jumper hole) in case the hardware is RouterBOARD. For X86(CHR) devices, only a complete reinstall will clear the password, along with any other configuration. For RouterBOARD devices, several methods exist, depending on the device model. Reset From RouterOS If you still have access to your router and want to recover its default configuration, then you can: Run the command from a command-line interface; "/system reset-configuration" Do it from menu in the graphical user interface; the System -> Reset Configuration Using Reset Button RouterBOARD devices are fitted with a reset button which has several functions: Loading the backup RouterBOOT loader Hold this button before applying power, and release it after three seconds since powering, to load the backup boot loader. This might be necessary if the device is not operating because of a failed RouterBOOT upgrade. When you have started the device with the backup loader, you can either set RouterOS to in the RouterBOARD settings or have a chance to reinstall the failed RouterBOOT from a ".fwf" force backup loader file (total of ) 3 seconds Resetting the RouterOS configuration Hold this button until the LED light starts flashing, and release the button to reset RouterOS configuration to default. Enabling CAPs mode To connect this device to a wireless network managed by CAPsMAN, keep holding the button for 5 more seconds, LED turns solid, release now to turn on CAPs mode. It is also possible to enable CAPs mode via the command line, to do so run the command "/system reset-configuration caps-mode=yes" ; Starting the RouterBOARD in Netinstall mode Or keep holding the button for 5 more seconds until the LED turns off, then release it to make the RouterBOARD look for Netinstall servers. You can also simply keep the button pressed until the device shows up in the Netinstall program on Windows. How to reset configuration 1) Unplug the device from power; 2) Press and hold the button right after applying power; Note: hold the button until the LED will start flashing; 3) Release the button to clear the configuration; You can also do the previous three functions without loading the backup loader, simply push the button immediately after you apply power. You might need the assistance of another person to push the button and also plug in the power supply at the same time! If you wait until the LED stops flashing, and only then release the button - this will instead launch Netinstall mode, to reinstall RouterOS.

Jumper hole reset Older RouterBOARD models are also fitted with a reset jumper hole. Some devices might need an opening of the enclosure, RB750/RB951/RB751 have the jumper hole under one of the rubber feet of the enclosure.

Close the jumper with a metal screwdriver, and boot the board until the configuration is cleared: Jumper reset for older models The below image shows the location of the Reset Jumper on older RouterBOARDs like RB133C:

WPS Some devices have WPS button, or reset button with WPS functionality to reach and control access for Wireless networks without logging into the device, so that client can connect without password. Specific models use WPS sync function to connect with each other. Detailed information on WPS and reset button functionality for each model are described in User Manuals Don't forget to remove the jumper after the configuration has been reset, or it will be reset every time you reboot!

Open Network & Internet and select Change adapter options Netinstall can run also on a local network, in such case you could skip setting a static IP address, but it is highly recommended that you set a static IP address if you are not familiar with Netinstall.

on your Ethernet interface and select Right-click Properties Select Internet Protocol Version 4 (TCP/IPv4) and click Properties

Check Use the following IP address and fill out the fields as shown in the image below

Open your Downloads .zip folder (or wherever you saved the downloaded files) and extract the Netinstall * file to a convenient place

Make sure that the Ethernet interface is running and launch Netinstall.exe. If you followed the guide precisely, then you should not have any Internet connection on your computer, Windows 10 wants to verify all apps that it runs, but will not be able to do it since lack of an Internet connection, for this reason, a warning might pop up, you should click . Run Allow access for Netinstall in Public networks and configure settings and fill out the required fields as shown in the image below Net booting Netinstall requires administrator rights, there should be a window asking for permissions to run Netinstall, you must accept these permissions in order for Netinstall to work properly.

Select your desired RouterOS packages and press Install. Wait for the installation to finish and press " " (Devices without serial console Reboot have to be rebooted manually). If you have downloaded RouterOS packages for multiple architectures, Netinstall will only display the appropriate architecture packages for your device after you have selected it. Unsupported packages will not appear in this window once a device is selected.

If the installation does not start (progress bar is not moving or no status is shown), then you can try closing the Netinstall application and opening it up again or try to put the device into Etherboot mode again. If you are still unable to get Netinstall working, then you should try using it on a different computer since there might be an operating system's issue that is preventing Netinstall from working properly.

After using Netinstall the device will be reset to defaults (unless you specified not to apply default configuration). Some devices are not accessible through e ther1 port with the default configuration for security reasons. Read more about Default configuration . Option allows you to retain the device's already installed branding package without reinstalling it using Netinstall. "Keep branding" You're all set! Configure your device and reconnect it to your network. Your device should now be functioning correctly! Instructions for Linux The Linux version is a command line tool, which offers nearly the same parameters as the Windows counterpart. Download the tool from our download page (links not literal): wget https://download.mikrotik.com/routeros/[VERSION]/netinstall-[VERSION].tar.gz Extract it: tar -xzf netinstall-[VERSION].tar.gz Run the tool: sudo ./netinstall-cli [-parameters] [address/interface] routeros-arm64-[package VERSION].npk The process involves downloading the configuration database from the router, reinstalling the router (including disk "Keep old configuration" formatting), and uploading the configuration files back to it. However, it's important to note that this process solely applies to the configuration itself and does not impact the files, including databases like the User Manager database, Dude database, and others. When using the Configure script option, it is suggested to introduce a delay before configuration execution. The tool requires privileged access and must be run as root, use sudo.

The available parameters are as follows: Parameter Meaning -r When the reinstallation process is performed, the current configuration will be reset, and for devices that have it, the default configuration will be applied (optional). -e Performing the reinstallation process will reset the device to an empty configuration. -b Option to discard the currently installed branding package from the device, otherwise it will be reinstalled together with RouterOS. -o When using the netinstall tool with the "-o" option, devices can only be installed once per netinstall run. This means that during the netinstall process, the tool will keep track of the MAC addresses of devices that were successfully installed. If a device with the same MAC address tries to reinstall during the same run, the tool will ignore it and not respond to its bootp requests. -k keyfile Provides the device with a license key in .KEY format (optional). -s userscript Pre-configures the device with the provided configuration (text file in .RSC format). This configuration also takes place of the default configuration. The script can access factory passwords with read-only variables $defconfPassword and $defconfWifiPassword ( starting (optional). from RouterOS 7.10beta8) -a IP Uses a specific IP address that the Netinstall server will assign to the device. Mandatory, but can be auto-assigned if interface parameter used. PACKAGE Specify a list of RouterOS.NPK format packages that Netinstall will try to install on the device (mandatory). The system package must be listed first. -i Allows you to specify an interface (optional). First make sure you have set the IP on your computer's interface: admin@ubuntu:~$ sudo ifconfig <interface> 192.168.88.2/24 Then run the version 6 (an example that ): Netinstall resets the configuration upon reinstallation procedure admin@ubuntu:~$ sudo ./netinstall -r -a 192.168.88.3 routeros-mipsbe-6.48.1.npk Using server IP: 192.168.88.2 Starting PXE server Waiting for RouterBOARD... PXE client: 01:23:45:67:89:10 Sending image: mips Discovered RouterBOARD... Formatting... Sending package routeros-mipsbe-6.48.1.npk ... Ready for reboot... Sent reboot command Or run the Netinstall version 7 (an example ): that applies an empty configuration and discards the branding during the reinstallation procedure If the "-r" or "e-" parameter is not specified, will reinstall RouterOS and will keep the current configuration by downloading current netinstall-cli configuration database from the router, reinstalling the router (including disk formatting), and uploading the configuration back to it, the same as Netinstall option. However, it's important to note that this process solely applies to the configuration itself and does "Keep old configuration" not impact the files, including databases like the User Manager database, Dude database, and others.

RouterBOOT booter 7.14.2 CRS328-4C-20S-4S+ CPU frequency: 800 MHz Memory size: 512 MiB Storage size: 16 MiB Press Ctrl+E to enter etherboot mode Press any key within 2 seconds to enter setup trying bootp protocol.... OK Got IP address: 192.168.88.3 resolved mac address 84:69:93:9E:E6:49 transfer started ............................... transfer ok, time=2.00s At this point your device is in Etherboot mode, now the device should show up in your Netinstall window.

To generate this file in Webfig, click on "Make Supout.rif" and then "Download" to get it on your computer. Console

To generate this file, please type in the command line: /system sup-output name=supout.rif If you open the file on supout viewer and output is too narrow, then you can re-generate supout file and specify output width manually with output-width option: /system sup-output name=supout.rif output-width=300

Review and Complete Your Purchase Review your order details. Proceed with payment using (CC) or . Credit Card PayPal

1. 2. 3. Congratulations! You have successfully purchased a RouterOS license key. How to Convert prepaid key to licence key for x86 Purchase a RouterOS Prepaid Key Log in to your account. mikrotik.com Purchase a RouterOS Prepaid key if you haven't already. Access the "Make a Key from Prepaid Key" Section Navigate to the "Make a key from prepaid key" section in your account. Select and Convert the Prepaid Key Select the desired prepaid key from the list. Input the of the x86 device you need to license, or the of the router to upgrade the licence level. Software ID Software ID

It is not possible to upgrade the x86 license to a CHR license. You will need to purchase a new license for the CHR.

Cloud Hosted Router, CHR System Requirements CHR has been tested on the following platforms: Usable Network and Disk interfaces on various hypervisors: How to Install a virtual RouterOS system with CHR images CHR Licensing Paid licenses Free licenses Prepaid Key How to Purchase a Prepaid Key to License a CHR Getting and Upgrading the License Initial Upgrade from Free to P1 License Level or Higher Upgrade license level using WinBox Upgrade license level using the command-line interface Payment License Update Upgrading the Level of Perpetual License License Transfer Virtual Network Adapters Troubleshooting Running on VMware ESXi Changing MTU Using bridge on Linux Packets not passing from guests Using VLANs on CHR in various Hypervisors ESXI Hyper-V bhyve hypervisor Linode Guest tools VMWare Time synchronization Power operations Quiescing/backup Guest info Provisioning Python example KVM Cloud Hosted Router (CHR) is a RouterOS version intended for running as a virtual machine. It supports the x86 64-bit architecture and can be used on most of the popular hypervisors such as VMWare, Hyper-V, VirtualBox, KVM, and others. CHR has full RouterOS features enabled by default but has a different licensing model than other RouterOS versions. System Requirements Package version: RouterOS v6.34 or newer Host CPU: 64-bit with virtualization support RAM: 256MB or more (Max: 128GB) Disk: 128MB disk space for the CHR virtual hard drive (Max: 16GB) The minimum required RAM depends on interface count and CPU count. You can get an approximate number by using the following formula: RouterOS v6 - RAM = 128 + [ 8 × (CPU_COUNT) × (INTERFACE_COUNT - 1) ] RouterOS v7 - RAM = 512 + [ 8 × (CPU_COUNT) × (INTERFACE_COUNT - 1) ] We recommend allocating at least 1024MiB of RAM for CHR instances. Note: CHR has been tested on the following platforms: VirtualBox 6 on Linux and OS X VMWare Fusion 7 and 8 on OS X

1. 2. 3. 4. 5. VMWare ESXi 6.5 and higher Qemu 2.4.0.1 on Linux and OS X Hyper-V on Windows Server 2008r2, 2012 and Windows 10 (Only Generation 1 Hyper-V virtual machine is supported at the moment) Xen Server 7.1 Warning: Hypervisors that provide paravirtualization are not supported. Usable Network and Disk interfaces on various hypervisors: ESX: Network: vmxnet3, E1000 Disk: IDE, VMware paravirtual SCSI, LSI Logic SAS, LSI Logic Parallel Hyper-V: Network: Network adapter, Legacy Network adapter Disk: IDE, SCSI Qemu/KVM: Network: Virtio, E1000, vmxnet3 (optional) Disk: IDE, Sata, Virtio VirtualBox Network: E1000, rtl8193 Disk: IDE, Sata, SCSI, SAS Note: SCSI controller Hyper-V and ESX are usable just for secondary disks, system image must be used with IDE controller! Warning: We do not recommend using the E1000 network interface if better synthetic interface options are available on a specific Hypervisor! How to Install a virtual RouterOS system with CHR images We provide 4 different virtual disk images to choose from. Note that they are only disk images, and you can't simply run them. RAW disk image (.img file) VMWare disk image (.vmdk file) Hyper-V disk image (.vhdx file) VirtualBox disk image (.vdi file) Steps to install CHR Download the virtual disk image for your hypervisor Create a guest virtual machine Use the previously downloaded image file as a virtual disk drive Start the guest CHR virtual machine Log in to your new CHR. The default user is 'admin', without a password Please note that running CHR systems can be cloned and copied, but the copy will be aware of the previous trial period, so you cannot extend your trial time by making a copy of your CHR. However, you are allowed to license both systems individually. To make a new trial system, you need to make a fresh installation and reconfigure RouterOS. Installing CHR guides VMWare Fusion/Workstation, ESXi 6.5 and higher VirtualBox Hyper-V Amazon Web Services (AWS) Hetzner Cloud Installation Linode Google Compute Engine ProxMox Vultr CHR Licensing The CHR ( ) has 4 license levels: Cloud Hosted Router

Review and Complete Your Purchase Review your order details. Proceed with payment using (CC) or . Credit Card PayPal

The list of your CHR instances and their corresponding licenses will be displayed. To upgrade from a Trial to a Paid license, click "Upgrade," select the desired license level (which can differ from the trial license level), and click "Upgrade" button.

If there are available, it is possible to use it for CHR - press " ". If there are no Prepaid keys or you do not want to use Prepaid keys Pay using Prepaid key them, press "Proceed to checkout". Choose the payment method: It is possible to pay using a credit card (CC) or PayPal.

License Update In the System-License menu, the router will indicate " " - the time when it will reattempt to contact the server located on . next-renewal-at licence.mikrotik.com Communication attempts will be performed once an hour after the date on " " and will not cease until the server responds with an error. next-renewal-at If the " " date is reached without successfully contacting the account server, the router will consider that the license has expired and will disallow deadline-at further software updates. However, the router will continue to work with the same license tier as before. After successful communication with the license server, the dates will be updated. Upgrading the Level of Perpetual License If you want to upgrade a perpetual license to a higher level, please transfer the previous perpetual license to another CHR first. This will prevent the previous perpetual license from being lost during the upgrade process.

It is possible to upgrade the Level of Perpetual License from P1 to P10 or P-Unlimited. Once the upgrade is purchased at the full price, the former license will become available for later use on your account. It is also possible to upgrade the Level of Perpetual License from P10 to P-Unlimited. Once the upgrade is purchased at the full price, the former license will become available for later use on your account. The P-Unlimited (perpetual-unlimited) license level allows CHR to run indefinitely. It is the highest-tier license and it has no enforced limitations. To upgrade the license level, follow these steps: Go to the "All CHR keys" section on your account. mikrotik.com Choose the CHR instance you want to upgrade and press "Upgrade". Select the desired license level to upgrade to (P10 or P-Unlimited) and press "Upgrade".

Virtual Network Adapters RouterOS v6 does not support Fast Path. Troubleshooting Running on VMware ESXi Changing MTU VMware ESXi supports MTU of up to 9000 bytes. To get the benefit of that, you have to adjust your ESXi installation to allow a higher MTU. Virtual Ethernet interface added the MTU change will be properly allowed by the ESXi server to pass jumbo frames. Interfaces added prior to MTU change after on the ESXi server will be barred by the ESXi server (it will still report the old MTU as the maximum possible size). If you have this, you have to re-add interfaces to the virtual guests. Example. There are 2 interfaces added to the ESXi guest, auto-detected MTU on the interfaces show MTU size as it was at the time when the interface was added: [admin@chr-vm] > interface ethernet print Flags: X - disabled, R - running, S - slave # NAME MTU MAC-ADDRESS ARP 0 R ether1 9000 00:0C:29:35:37:5C enabled 1 R ether2 1500 00:0C:29:35:37:66 enabled Using bridge on Linux If Linux bridge supports IGMP snooping, and there are problems with IPv6 traffic it is required to disable that feature as it interacts with MLD packets (multicast) and is not passing them through. echo -n 0 > /sys/class/net/vmbr0/bridge/multicast_snooping Packets not passing from guests The problem: after configuring a software interface (VLAN, EoIP, bridge, etc.) on the guest CHR it stops passing data to the outside world beyond the router. The solution: check your VMS (Virtualization Management System) security settings, if other MAC addresses are allowed to pass and if packets with VLAN tags are allowed to pass through. Adjust the security settings according to your needs like allowing MAC spoofing or a certain MAC address range. For VLAN interfaces, it is usually possible to define allowed VLAN tags or VLAN tag range. Fast Path is supported in RouterOS v7 for "vmxnet3" and "virtio-net" adapters.

Using VLANs on CHR in various Hypervisors In some hypervisors, before VLAN can be used on VMs, they need to first be configured on the hypervisor itself. ESXI Enable Promiscuous mode in a port group or virtual switch that you will use for a specific VM. ESX documentation: https://kb.vmware.com/kb/1004099 Hyper-V Hyper-V documentation: https://technet.microsoft.com/en-us/library/cc816585(v=ws.10).aspx#Anchor_2 bhyve hypervisor It won't be possible to run CHR on this hypervisor. CHR cannot be run as a para-virtualized platform. Linode When creating multiple Linodes with the same disk size, new Linodes will have the same systemID. This will cause issues to get a Trial/Paid license. To avoid this, run the command after the first boot and before you request a trial or paid license. This will make /system license generate-new-id sure the ID is unique. Some useful articles: Specific VLAN is untagged by NIC interface: https://blogs.msdn.microsoft.com/adamfazio/2008/11/14/understanding-hyper-v-vlans/ https://www.aidanfinn.com/?p=10164 Allow passing other VLANs: https://social.technet.microsoft.com/Forums/windows/en-US/79d36d5b-c794-4502-8ed4-b7a4183b1891/vlan-tags-and-hyperv-switches? forum=winserverhyperv Guest tools VMWare Time synchronization Must be enabled from GUI ('Synchronize guest time with host'). Backward synchronization is disabled by default - if the guest is ahead of the host by more than ~5 seconds, synchronization is not performed Power operations poweron and scripts are executed (if present and enabled) after power on and resume operations respectively. resume poweroff and scripts are executed before power off and suspend operations respectively. suspend If scripts take longer than 30 seconds or contain errors, the operation fails In case of failure, retrying the same operation will ignore any errors and complete it successfully Failed script output is saved to a file (e. g. 'poweroff-script.log', 'resume-script.log' etc) Scripts can be enabled/disabled from hypervisor GUI ('run VMware Tools Scripts') or by enabling/disabling scripts from the console Quiescing/backup Guest filesystem quiescing is performed only if requested.

freeze script is executed before freezing the filesystem freeze-fail script is executed if the hypervisor failed to prepare for a snapshot or if script failed freeze thaw script is executed after the snapshot has been taken Script run time is limited to 60 seconds freeze script timeouts and errors result in the backup operation being aborted FAT32 disks are not quiesced Failed script output is saved to a file (e. g. 'freeze-script.log', 'freeze-fail-script.log', 'thaw-script.log') Guest info Networking, disk, and OS info are reported to the hypervisor every 30 seconds (GuestStats (memory) are disabled by default, and can be enabled by setting 'guestinfo.disable-perfmon = "FALSE"' in VM config). The order, in which network interfaces are reported, can be controlled by setting 'guestinfo.exclude-nics', 'guestinfo.primary-nics' and 'guestinfo. low-priority-nics' options. Standard patterns can be used. wildcard Provisioning You can use the from Vim API to execute scripts. Python bindings are ProcessManager available Main data structure: GuestProgramSpec The and members are ignored workingDirectory envVariables programPath must be set to either 'inline' or 'import' If is ' , are interpreted as script text programPath inline' arguments If is ' , are interpreted as file path programPath import' arguments After using together with an instance of as arguments to unique is obtained. GuestProgramSpec GuestAuthentication StartProgramInGuest JobID Script progress can be tracked by using the command. accepts an array of job id's; passing an empty array ListProcessesInGuest ListProcessesInGuest will report on all jobs started from the API ListProcessesInGuest returns an array of instances: GuestProcessInfo pid field is set to JobID endTime is only set after completion exitCode is set to 0 on success and -1 on error name is set to 'inline' or 'import' (same as in ) programPath GuestProgramSpec Information about completed jobs is kept around for ~1 minute, or until (with the corresponding ) is called. If the script fails, a ListProcessesInGuest JobID file named 'vix_job_$JobID$ .txt' containing the script output is created. Script run time is limited to 120 seconds and script output is not saved on timeout, The command can also be used vmrun runScriptInGuest The cmdlet is not supported PowerCLI Invoke-VMScript Host/guest file transfer is not supported Python example #!/usr/bin/env python # -*- coding: utf-8 -*- import sys,time from pyVim import connect from pyVmomi import vmodl,vim def runInline(content,vm,creds,source): ''' Execute script source on vm ''' if isinstance(source, list): source = '\n'.join(source) ps = vim.vm.guest.ProcessManager.ProgramSpec( programPath = 'console', arguments = source ) return content.guestOperationsManager.processManager.StartProgramInGuest(vm,creds,ps) def runFromFile(content,vm,creds,fileName): ''' Execute script file located on CHR ''' ps = vim.vm.guest.ProcessManager.ProgramSpec( programPath = 'import', arguments = fileName ) return content.guestOperationsManager.processManager.StartProgramInGuest(vm,creds,ps)

1. Processors: Select the desired quantity of CPUs. Click .Next Step 3: Create a Virtual Hard Disk Virtual Hard Disk: Select "Use an existing Hard Disk File" Add the downloaded VDI image file Click . Choose Click .Next Check the settings and click . Finish

Step 4: Configure Virtual Machine Settings Settings : Select your newly created VM and click on . Settings System : Go to the tab and uncheck , in the Boot Order section. System Floppy Optical Processors : Go to the tab. Processor Select the desired quantity of CPUs. Network : Go to the tab. Network

Adapter 1: Enable the network adapter and attach it to or (depending on your network setup). Bridged Adapter NAT Step 5: Start the Virtual Machine Start VM : Click to boot your new virtual machine. Start Login : After the VM reboots, you will see the CHR login prompt. The default login credentials are: Username: admin Password: (blank)

Upgrading to v7 Introduction This document describes the recommended steps for upgrading RouterOS to v7 major release and the possible caveats when doing so. Upgrading from v6 to v7 happens the same way, as upgrading within v6 releases. Please follow the for more detailed steps. If you are Upgrade manual currently running RouterOS version 6 or older, we first suggest upgrading to the latest stable or long-term release in v6. Feature list compatibility As previously stated, nearly all RouterOS systems can use the "Check for updates" functionality and upgrade to v7 in a few clicks, but there are some features, where extra steps may be required: Feature Status CAPsMAN OK Interfaces OK Wireless OK Bridge/Switching OK Tunnels/PPP OK IPv6 OK BGP OK, but attention is required * OSPF OK, but attention is required ** MPLS OK, but attention is required *** Routing filters OK, but attention is required **** PIM-SM See notes IGMP Proxy OK Tools OK Queues OK Firewall OK HotSpot OK Static Routing OK User Manager See notes Note that in your RouterOS v6.x, only RouterOS release 7.12.1 will be shown as the latest release. You must upgrade to this version first and only then further upgrades to newer versions will become available. In most RouterOS setups that run fine with the aforementioned v6 versions, no extra steps are required. Upgrading to v7 will automatically convert the configuration and your device will function right away. Note: We do not recommend running v7 on hardware that does not have at least 64 MB of RAM.

Notes BGP All known configurations will upgrade from 6.x to 7.x successfully. But keep in mind that there is a complete redesign of the configuration. v7 BGP implementation provides with , and menus. connection templatesession Template contains all BGP protocol-related configuration options. It can be used as a template for dynamic peers and apply a similar config to a group of peers. Most of the parameters are similar to the previous implementation except that some are grouped in the output and input section making the config more readable and easier to understand whether the option is applied on input or output. BGP minimal set of parameters are , , and connection remote.address template, connect listen local.role Connect and listen to parameters specify whether peers will try to connect and listen to a remote address or just connect or just listen. It is possible that in setups where peer uses the multi-hop connection must be configured too. Peer role is now a mandatory parameter, for basic setups, you local.address can just use ibgp, ebgp. Now you can monitor the status of all connected and disconnected peers from menu. /routing bgp session Other great debugging information on all routing processes can be monitored from menu. /routing stats Networks are added to the firewall address-list and referenced in the BGP configuration.connection OSPF All known configurations will upgrade from 6.x to 7.x successfully. OSPFv2 and OSPFv3 are now merged into one single menu . At the moment there are no default instances and areas. To start OSPF /routing ospf you need to create an instance and then add area to the instance. RouterOSv7 uses templates to match the interface against the template and apply configuration from the matched template. OSPF menus interface and contains read-only entries for status monitoring. neighbor MPLS Upgrade MPLS setups with caution, and make sure to backup configuration before the upgrade. Routing filters All supported options are upgraded without any issue, in the case of an unsupported option - an empty entry is created. The routing filter configuration is changed to a script-like configuration. The rule now can have "if .. then" syntax to set parameters or apply actions based on conditions from the "if" statement. Multiple rules without action are stacked in a single rule and executed in order like a firewall, the reason is that the "set" parameter order is important, and writing one "set"s per line, allows for an easier understanding from top to bottom on what actions were applied. More RouterOSv7 routing filter examples are .here PIM-SM Upgrading RouterOS to v7 will not preserve PIM-related configuration. After the upgrade, multicast routing configuration will be available under the /routi menu and an additional "multicast" package is not required anymore. More information is available . ng/pimsm here The routing protocol configuration upgrade is triggered only once. This means that if a router was downgraded to ROSv6, the configuration was modified and the router got upgraded back to ROSv7, then the resulting configuration is the one that was present before the downgrade. To re- trigger v6 configuration conversion, load ROSv6 backup with the option . =yes force-v6-to-v7-configuration-upgrade

User Manager RouterOSv7 provides the new and redesigned implementation of User Manager, configuration is now integrated into RouterOS WinBox and console (WEB admin configuration interface is not available), more information is available . Direct migration from older User Manager is not possible, it is possible to here migrate older database from However, it might be a good idea to start configuration from the scratch. /user-manager/database/migrate-legacy-db New features A New Kernel is implemented in RouterOSv7, which leads to performance changes due to route cache, as well some tasks might require higher CPU and RAM usage for different processes. completely new NTP client and server implementation merged individual packages, only bundle and a few extra packages remain (dropped support for LCD and KVM packages) new Command Line Interface (CLI) style (RouterOS v6 commands are still supported) support for Let's Encrypt certificate generation support for REST API support for UEFI boot mode on x86 CHR FastPath support for "vmxnet3" and "virtio-net" drivers support for "Cake" and "FQ_Codel" type queues support for IPv6 NAT support for Layer 3 hardware acceleration on all CRS3xx devices support for MBIM driver with basic functionality support for all modems with MBIM mode support for MLAG on CRS3xx devices support for VRRP grouping and connection tracking data synchronization between nodes support for Virtual eXtensible Local Area Network (VXLAN) support for L2TPv3 support for OpenVPN UDP transport protocol support for WireGuard support for hardware offloaded VLAN filtering on RTL8367 (RB4011, RB100AHx4) and MT7621 (hEX, hEX S, RBM33G) switches support for ZeroTier on ARM and ARM64 devices completely new alternative wireless package "wifiwave2" with 802.11ac Wave2, WPA3, and 802.11w management frame protection support (requires ARM CPU and 256MB RAM) support for hardware offloaded VLAN filtering on RTL8367 (RB4011, RB100AHx4) and MT7621 (hEX, hEX S, RBM33G) switches support CPU frequency scaling for x86 devices Dropped support In RouterOS v7 has been dropped support for: LCD package KVM package

RouterBOOT Main and Backup loaders RouterBOARD reset button Configuration Reset For Wireless Wire kits Configuration Simple Upgrade Checking RouterBOOT version RouterBOOT is responsible for starting RouterOS in RouterBOARD devices. Main and Backup loaders By default, the main (regular) loader is used, but RouterBOARD devices also have a secondary (backup) bootloader, which can be used in case the main doesn't work. It is possible to call the backup loader with a configuration setting in RouterOS: system/routerboard/settings/set force-backup-booter=yes It is also possible to use the backup booter by turning on the device, with the RESET button pushed. It is only possible to upgrade the main RouterBOOT, so in case of failure, you can use the backup booter to start the device and downgrade the main loader. For upgrade instructions, follow the separate instructions in RouterBOARD#UpgradingRouterBOOT RouterBOARD reset button RouterBOOT reset button has three functions: Hold this button during boot time until the LED light starts flashing, and release the button to reset the RouterOS configuration (total 5 seconds) Keep holding for 5 more seconds, LED turns solid, release now to turn on CAPs mode (total 10 seconds) Or Keep holding the button for 5 more seconds until the LED turns off, then release it to make the RouterBOARD look for Netinstall servers Reset the password https://www.youtube.com/watch?v=6Unz92rABs8 Configuration Reset For kits Wireless Wire The reset button has the same functionality as on other devices, explained in detail https://help.mikrotik.com/docs/display/ROS/Reset+Button 5-second button hold on startup (USR LED light starts flashing) - resets to password-protected state. 10-second button hold on startup (USR LED turns solid after flashing) - completely removes configuration. Configuration For RouterBOARD devices that feature a serial console connector, it is possible to access the RouterBOOT loader configuration menu. The required cable is described in the manual. RouterBOARD serial port is configured to , , , and . We suggest Serial Console 115200bit/s 8 data bits 1 stop bit no parity disabling the hardware flow control. This example shows the menu which is available in RouterBOOT 7.4beta4: If you hold the button before applying power, backup RouterBOOT will be used in addition to all the above actions. To do the above actions without loading the backup loader, push the button right after applying power to the device.

RouterBOOT booter 7.4beta4 CRS328-24P-4S+ built by build at Jun/15/2022 11:34:09 from revision 73B4521C CPU frequency: 800 MHz Memory size: 512 MiB Storage size: 16 MiB Press Ctrl+E to enter etherboot mode Press any key within 2 seconds to enter setup RouterBOOT-7.4beta4 What do you want to configure? d - boot delay k - boot key s - serial console n - silent boot o - boot device z - extra kernel parameters r - reset booter configuration e - format storage w - repartition nand g - upgrade firmware i - board info p - boot protocol b - booter options j - boot os t - hardware tests l - erase license x - exit setup your choice: The options are self-explanatory. letter description explanation d boot delay Delays starting of RouterOS to allow an interface to initialize k boot key The button that will open the configuration menu s serial console Sets the baud rate of the serial port n silent boot Suppresses all output on the serial port, in case some device is connected to it (like a GPS device or a temperature monitor) o boot device Allows to enable Netinstall booting z extra kernel parameters r reset booter configurationResets the settings in this menu. Warning, no confirmation! e format storage Destroys all data on the NAND, including RouterOS configuration and license w repartition nand Refer to the document for more info Partitions y active partition Choose an active partition from which to try to load RouterOS g upgrade firmware Allows upgrading RouterBOOT version through the network, or the XModem protocol i board info p boot protocol b booter options Select which bootloader to use by default

t do memory testing booter options j boot os do memory testing t hardware tests l erase license x exit setup Hitting the appropriate keyboard letter will give you a list of further options, they are shown below: # d - boot delay: Select boot delay: 1 - 1s * 2 - 2s 3 - 3s 4 - 4s 5 - 5s 6 - 6s 7 - 7s 8 - 8s 9 - 9s # k - boot key: Select key which will enter setup on boot: * 1 - any key 2 - <Delete> key only # s - serial console: Select baud rate for serial console: * 1 - 115200 2 - 57600 3 - 38400 4 - 19200 5 - 9600 6 - 4800 7 - 2400 8 - 1200 9 - off # n - silent boot: Silent boot: 0 - off * 1 - on # o - boot device: Select boot device: e - boot over Ethernet * n - boot from NAND, if fail then Ethernet 1 - boot Ethernet once, then NAND o - boot from NAND only b - boot chosen device f - boot Flash Configure Mode 3 - boot Flash Configure Mode once, then NAND # f - cpu frequency: Select CPU frequency: a - 200MHz b - 400MHz c - 600MHz d - 800MHz e - 1000MHz * f - 1200MHz # r - reset booter configuration: # e - format nand: Do you realy want to format your storage device? that would result in losing all your data type "yes" to confirm: # w - repartition nand:

Select parititon count: 1 - partition * 2 - partitions 3 - partitions 4 - partitions # y - active partition: Select active partiton: * 0 - partition 1 - partition # g - upgrade firmware: Upgrade firmware options: e - upgrade firmware over ethernet s - upgrade firmware over serial port # i - board info: Board Info: Board type: CCR1009-8G-1S-1S+ Serial number: 48FF01DDE6FD Firmware version: 3.19 CPU frequency: 1200 MHz Memory size: 2048 MiB NAND size: 128 MiB Build time: 2014-09-23 15:02:34 eth1 MAC address: 00:0C:42:00:BE:4A eth2 MAC address: 00:0C:42:00:BE:4B eth3 MAC address: 00:0C:42:00:BE:4C eth4 MAC address: 00:0C:42:00:BE:4D eth5 MAC address: 00:0C:42:00:BE:4E eth6 MAC address: 00:0C:42:00:BE:4F eth7 MAC address: 00:0C:42:00:BE:50 eth8 MAC address: 00:0C:42:00:BE:51 eth9 MAC address: 00:0C:42:00:BE:52 eth10 MAC address: 00:0C:42:00:BE:53 # p - boot protocol: Choose which boot protocol to use: * 1 - bootp protocol 2 - dhcp protocol # b - booter options: Select which booter you want to load: * 1 - load regular booter 2 - force backup-booter loading #t - do memory testing: launches built in memory test! # x - exit setup: Exit bios configuration menu and continues with system startup. Simple Upgrade RouterBOOT can be upgraded from RouterOS by: Run command /system routerboard upgrade Reboot your router to apply the upgrade ( )] /system reboot [admin@admin] > system/routerboard/upgrade Do you really want to upgrade firmware? [y/n] Every ROS version has a new RouterBoot version included in it, once you perform a ROS upgrade we always recommend upgrading RouterBoot also.

IPv4 and IPv6 Fundamentals In This Section: Networking Models OSI Model TCP/IP Model Ethernet IP Networking ARP and Tying It All Together ARP Modes Enabled Disabled Reply Only Proxy ARP Local Proxy ARP TCP/IP TCP Session Establishment and Termination Connection establishment process Connection termination TCP Segments transmission (windowing) Networking Models Computer networks consist of many different components and protocols working together. To understand the concept of how node to node communication happens, let's get familiar to the OSI model and TCP/IP model. Both models help to visualize how communication between nodes is happening. OSI Model The Open Systems Interconnection (OSI) model is a 7-layer model that today is used as a teaching tool. The OSI model was originally conceived as a standard architecture for building network systems, but in real-world networks are much less defined than the OSI model suggests. Layer 7 (Application) - a protocol that defines the communication between the server and the client, for example, HTTP protocol. If the web browser wants to download an image, the protocol will organize and execute the request; Layer 6 (Presentation) - ensures data is received in a usable format. Encryption is done here (but in reality it may not be true, for example, IPSec); Layer 5 (Session) - responsible for setting up, managing and closing sessions between client and server; Layer 4 (Transport) - transport layers primary responsibility is assembly and reassembly, a data stream is divided into chunks (segments), assigned sequence numbers and encapsulated into protocol header (TCP, UDP, etc.); Layer 3 (Network) - responsible for logical device addressing, data is encapsulated within an IP header and now called "packet"; Layer 2 (Data link) - Data is encapsulated within a custom header, either 802.3 (Ethernet) or 802.11 (wireless) and is called "frame", handles flow control; Layer 1 (Physical) - Communication media that sends and receives bits, electric signaling, and hardware interface; TCP/IP Model This model has the same purpose as the OSI model but fits better into modern network troubleshooting. Comparing to the OSI model, TCP/IP is a 4- layer model: Application layer (4) - includes application, presentation and session layers of the OSI model, which significantly simplifies network troubleshooting; Transport layer (3) - same as a transport layer in the OSI model (TCP, UDP protocols); Internet layer (2) - does the same as Network layer in the OSI model (include ARP, IP protocols); Link layer (1) - also called the Network Access layer. Includes both Layer1 and 2 of the OSI model, therefore its primary concern is physical data exchange between network nodes;

TCP/IP OSI Model Protocols Application Layer Application Layer DNS, DHCP,HTTP,SSH etc. Presentation Layer JPEG,MPEG,PICT etc. Session Layer PAP, SCP, ZIP etc. Transport Layer Transport Layer TCP, UDP Internet Layer Network Layer ICMP, IGMP, IPv4, IPv6, IPSec Link Layer Data Link Layer ARP, CDP, MPLS, PPP etc. Physical Layer Bluetooth, Ethernet, Wi-Fi etc. Ethernet The most commonly used link layer protocol (OSI Layer2) in computer networks is the Ethernet protocol. In order to communicate, each node has a unique assigned address, called MAC (Media Access Control address) sometimes it is also called an Ethernet address. It is 48-bit long and typically fixed by the manufacturer (cannot be changed), but in recent years customization of MAC addresses is widely used, RouterOS also allows to set custom MAC address. Most commonly used MAC format is 6 hexadecimal numbers separated by colons ( ) D4:CA:6D:01:22:96 RouterOS shows MAC address in a configuration for all Ethernet-like interfaces (Wireless, 60G, VPLS, etc.) [admin@rack1_b32_CCR1036] /interface ethernet> print Flags: X - disabled, R - running, S - slave # NAME MTU MAC-ADDRESS ARP SWITCH 0 R ether1 1500 D4:CA:6D:01:22:96 enabled 1 R ether2 1500 D4:CA:6D:01:22:97 enabled 2 R ether3 1500 D4:CA:6D:01:22:98 enabled 3 ether4 1500 D4:CA:6D:01:22:99 enabled 4 ether5 1500 D4:CA:6D:01:22:9A enabled 5 ether6 1500 D4:CA:6D:01:22:9B enabled 6 ether7 1500 D4:CA:6D:01:22:9C enabled 7 R ether8 1500 D4:CA:6D:01:22:9D enabled 8 sfp-sfpplus1 1500 D4:CA:6D:01:22:94 enabled 9 sfp-sfpplus2 1500 D4:CA:6D:01:22:95 enabled There are three types of addresses:

Unicast address is sent to all nodes within the collision domain, which typically is Ethernet cable between two nodes or in case of wireless all receivers that can detect wireless signals. Only remote node with matching MAC address will accept the frame (unless the promiscuous mode is enabled) One of the special addresses is address ( ), a broadcast frame is accepted and forwarded over Layer2 broadcast FF:FF:FF:FF:FF:FF network by all nodes Another special address is . Frames with multicast addresses are received by all nodes configured to receive frames with this multicast address. IP Networking Ethernet protocol is sufficient to get data between two nodes on an Ethernet network, but it is not used on its own. For Internet/Networking layer (OSI Layer 3) IP (Internet Protocol) is used to identify hosts with unique logical addresses. Most of the current networks use IPv4 addresses, which are 32bit address written in dotted-decimal notation ( ) 192.168.88.1 There can be multiple logical networks and to identify which network IP address belongs to, the netmask is used. Netmask typically is specified as a number of bits used to identify a logical network. The format can also be in decimal notation, for example, the 24-bit netmask can be written as 255.25 5.255.0 Let's take a closer look at 192.168.3.24/24: 11000000 10101000 00000011 00011000 => 192.168.3.24 11111111 11111111 11111111 00000000 => /24 or 255.255.255.0 As can be seen from the illustration above high 24 bits are masked, leaving us with a range of 0-255. From this range, the first address is used to identify the network (in our example network address would be 192.168.3.0) and the last one is used for network broadcast (192.168.3.255). That leaves us with a range from 1 to 254 for host identification which is called addresses. unicast The same as in Ethernet protocol there can be also special addresses: broadcast - address to send data to all possible destinations ("all-hosts broadcast"), which permits the sender to send the data only once, and all receivers receive a copy of it. In the IPv4 protocol, the address 255.255.255.255 is used for local broadcast. In addition, a directed (limited) broadcast can be made to network broadcast address; multicast - address associated with a group of interested receivers. In IPv4, addresses through are 224.0.0.0 239.255.255.255 designated as multicast addresses. The sender sends a single datagram from its unicast address to the multicast group address and the intermediary routers take care of making copies and sending them to all receivers that have joined the corresponding multicast group; In case of logical IP network, unicast, broadcast and multicast visualization would look a bit different

There are also address ranges reserved for a special purpose, for example, , that should be used only in local networks and private address range typically are dropped when forwarded to the internet: 10.0.0.0/8 - start: 10.0.0.0; end: 10.255.255.255 172.16.0.0/12 - start: 172.16.0.0; end:172.31.255.255 192.168.0.0/16 - start: 192.168.0.0; end: 192.168.255.255 ARP and Tying It All Together Even though IP packets are addressed using IP addresses, hardware addresses must be used to actually transport data from one host to another. This brings us to Address Resolution Protocol (ARP) which is used for mapping the IP address of the host to the hardware address (MAC). ARP protocol is referenced in . RFC 826 Each network device has a table of currently used ARP entries. Normally the table is built dynamically, but to increase network security, it can be partially or completely built statically by means of adding static entries. When a host on the local area network wants to send an IP packet to another host in this network, it must look for the Ethernet MAC address of destination host in its ARP cache. If the destination host’s MAC address is not in the ARP table, then the ARP request is sent to find the device with a corresponding IP address. ARP sends a broadcast request message to all devices on the LAN by asking the devices with the specified IP address to reply with its MAC address. A device that recognizes the IP address as its own returns ARP response with its own MAC address: Address Resolution Protocol is a thing of the past. IPv6 completely eliminates use of the ARP.

Let's make a simple configuration and take a closer look at processes when Host A tries to ping Host C. At first, we add IP addresses on Host A: /ip address add address=10.155.101.225 interface=ether1 Host B: /ip address add address=10.155.101.221 interface=ether1 Host C: /ip address add address=10.155.101.217 interface=ether1 Now, let's run a packet sniffer that saves packet dump to the file and run the ping command on Host A: /tool sniffer set file-name=arp.pcap filter-interface=ether1 start /ping 10.155.101.217 count=1 stop Now you can download arp.pcap file from the router and open it in Wireshark for analyzing:

Host A sends ARP message asking who has "10.155.101.217" Host C responds that 10.155.101.217 can be reached at MAC address 08:00:27:3C:79:3A Both Host A and Host C now have updated their ARP tables and now ICMP (ping) packets can be sent If we look at ARP tables of both host we can see relevant entries, in RouterOS ARP table can be viewed by running command: /ip arp print [admin@host_a] /ip arp> print Flags: X - disabled, I - invalid, H - DHCP, D - dynamic, P - published, C - complete # ADDRESS MAC-ADDRESS INTERFACE 0 DC 10.155.101.217 08:00:27:3C:79:3A ether1 [admin@host_b] /ip arp> print Flags: X - disabled, I - invalid, H - DHCP, D - dynamic, P - published, C - complete # ADDRESS MAC-ADDRESS INTERFACE 0 DC 10.155.101.225 08:00:27:85:69:B5 ether1 ARP Modes Now the example above demonstrated default behavior, where ARP is enabled on interfaces, but there might be scenarios where different ARP behavior is necessary. RouterOS allows configuring different ARP modes for interfaces that support ARP. Enabled ARPs will be discovered automatically and new dynamic entries will be added to the ARP table. This is a default mode for interfaces in RouterOS and illustrated in the example above. Disabled If the ARP feature is turned off on the interface, i.e., is used, ARP requests from clients are not answered by the router. Therefore, static arp=disabled ARP entry should be added to the clients as well. For example, the router's IP and MAC addresses should be added: [admin@host_a] > /ip arp add mac-address=08:00:27:3C:79:3A address=10.155.101.217 interface=ether1 Reply Only If the ARP property is set to on the interface, then the router only replies to ARP requests. Neighbour MAC addresses will be resolved using reply-only /ip arp statically, but there will be no need to add the router's MAC address to other hosts' ARP tables like in cases where ARP is disabled. Proxy ARP A router with properly configured proxy ARP feature acts as a transparent ARP proxy between directly connected networks. This behavior can be useful, for example, if you want to assign dial-in (PPP, PPPoE, PPTP) clients IP addresses from the same address space as used on the connected LAN.

Let's look at the example setup from the image above. Host A (172.16.1.2) on Subnet A wants to send packets to Host D (172.16.2.3) on Subnet B. Host A has a /16 subnet mask which means that Host A believes that it is directly connected to all 172.16.0.0/16 network (the same LAN). Since the Host A believes that is directly connected it sends an ARP request to the destination to clarify the MAC address of Host D. (in the case when Host A finds that destination IP address is not from the same subnet it sends a packet to the default gateway.). Host A broadcasts an ARP request on Subnet A. Info from packet analyzer software: No. Time Source Destination Protocol Info 12 5.133205 00:1b:38:24:fc:13 ff:ff:ff:ff:ff:ff ARP Who has 173.16.2.3? Tell 173.16.1.2 Packet details: Ethernet II, Src: (00:1b:38:24:fc:13), Dst: (ff:ff:ff:ff:ff:ff) Destination: Broadcast (ff:ff:ff:ff:ff:ff) Source: (00:1b:38:24:fc:13) Type: ARP (0x0806) Address Resolution Protocol (request) Hardware type: Ethernet (0x0001) Protocol type: IP (0x0800) Hardware size: 6 Protocol size: 4 Opcode: request (0x0001) [Is gratuitous: False] Sender MAC address: 00:1b:38:24:fc:13 Sender IP address: 173.16.1.2 Target MAC address: 00:00:00:00:00:00 Target IP address: 173.16.2.3

1. 2. 3. 4. 1. if the arp property is set to on an interface, then the router performs proxy ARP to/from this interface only. I.e. for traffic that comes in local-proxy-arp and goes out of the same interface. In a normal LAN, the default behavior is for two network hosts to communicate directly with each other, without involving the router. This is done to support (Ethernet) switch features, like , where the individual ports are allowed to communicate with each other, but RFC 3069 NOT they are allowed to talk to the upstream router. As described in , it is possible to allow these hosts to communicate through the upstream RFC 3069 router by proxy_arp'ing. Don't need to be used together with proxy_arp. This technology is known by different names: In RFC 3069 it is called VLAN Aggregation; Cisco and Allied Telesis call it Private VLAN; Hewlett-Packard calls it Source-Port filtering or port-isolation; Ericsson calls it MAC-Forced Forwarding (RFC Draft). TCP/IP TCP Session Establishment and Termination TCP is a connection-oriented protocol. The difference between a connection-oriented protocol and a connection-less protocol is that a connection- oriented protocol does not send any data until a proper connection is established. TCP uses whenever the transmitting device tries to establish a connection to the remote node. As a result end-to-end virtual a three-way handshake (logical) circuit is created where flow control and acknowledgment for reliable delivery are used. TCP has several message types used in connection establishment and termination process. Connection establishment process The host A who needs to initialize a connection sends out an (Synchronize) packet with a proposed initial sequence number to the SYN destination "host B"; When the host B receives an message, it returns a packet with both and flags set in the TCP header (SYN-ACK); SYN SYN ACK When the host A receives the SYN-ACK, it sends back the (Acknowledgment) packet;ACK Host B receives and at this stage, the connection is ACK ESTABLISHED; Connection-oriented protocol services are often sending acknowledgments (ACKs) after successful delivery. After the packet with data is transmitted, the sender waits for acknowledgment from the receiver. If time expires and the sender did not receive ACK, a packet is retransmitted. Connection termination When the data transmission is complete and the host wants to terminate the connection, the termination process is initiated. Unlike TCP Connection establishment, which uses a three-way handshake, connection termination uses four-way massages. A connection is terminated when both sides have finished the shutdown procedure by sending a FIN (finish) and receiving an ACK (Acknowledgment).

1. 2. 3. 4. 1. 2. 3. The host A, who needs to terminate the connection, sends a special message with the flag, indicating that it has finished sending the FIN data; The host B, who receives the segment, does not terminate the connection but enters into a "passive close" (CLOSE_WAIT) state and FIN sends the for the back to the host A. If host B does not have any data to transmit to the host A it will also send the message. ACK FIN FIN Now the host B enters into LAST_ACK state. At this point host B will no longer accept data from host A, but can continue to transmit data to host A. When the host A receives the last from the host B, it enters into a (TIME_WAIT) state, and sends an back to the host B; FIN ACK Host B gets the from the host A and connection is terminated;ACK TCP Segments transmission (windowing) Now that we know how the TCP connection is established we need to understand how data transmission is managed and maintained. In TCP/IP networks transmission between hosts is handled by TCP protocol. Let’s think about what happens when data-grams are sent out faster than the receiving device can process. The receiver stores them in memory called a buffer. But since buffer space is not unlimited, when its capacity is exceeded receiver starts to drop the frames. All dropped frames must be re- transmitted again which is the reason for low transmission performance. To address this problem, TCP uses a flow control protocol. The window mechanism is used to control the flow of the data. When a connection is established, the receiver specifies the window field in each TCP frame. Window size represents the amount of received data that the receiver is willing to store in the buffer. Window size (in bytes) is sent together with acknowledgments to the sender. So the size of the window controls how much information can be transmitted from one host to another without receiving an acknowledgment. The sender will send only the amount of bytes specified in window size and then will wait for acknowledgments with updated window size. If the receiving application can process data as quickly as it arrives from the sender, then the receiver will send a positive window advertisement (increase the size of the window) with each acknowledgment. It works until the sender becomes faster than the receiver and incoming data will eventually fill the receiver's buffer, causing the receiver to advertise acknowledgment with a zero window. A sender that receives a zero window advertisement must stop transmit until it receives a positive window. Let's take a look at the illustrated windowing process: The "host A" starts to transmit with a window size of 1000, one 1000byte frame is transmitted; Receiver "host B" returns ACK with window size to increase to 2000;

3. 4. 5. 6. The host A receives ACK and transmits two frames (1000 bytes each); After that, the receiver advertises an initial window size to 3000. Now sender transmits three frames and waits for an acknowledgement; The first three segments fill the receiver's buffer faster than the receiving application can process the data, so the advertised window size reaches zero indicating that it is necessary to wait before further transmission is possible; The size of the window and how fast to increase or decrease the window size is available in various TCP congestion avoidance algorithms such as Reno, Vegas, Tahoe, etc;

IP Addressing Overview IPv4 Addressing Private Address Range Other Reserved Address Ranges Adding IP Address IPv6 Addressing Address Types Unicast Addresses Link-local Address Unique Local Address Special Purpose Address Compatibility Address Multicast Address Anycast Address Interface Identifier EUI-64 Configuring IPv6 Address SLAAC IPv6 Address Properties Read-only properties Frequently asked questions Overview IP addresses serve for general host identification purposes in IP networks ( ). A typical (IPv4) address consists of four octets. For proper RFC 791 addressing the router also needs the network mask value, id est which bits of the complete IP address refer to the address of the host, and which - to the address of the network. The network address value is calculated by binary AND operation from a network mask and IP address values. It's also possible to specify an IP address followed by a slash "/" and the number of bits that form the network address. In most cases, it is enough to specify the address, the netmask, and the interface arguments. The network prefix and the broadcast address are calculated automatically. It is possible to add multiple IP addresses to an interface or to leave the interface without any addresses assigned to it. In the case of bridging or PPPoE connection, the physical interface may not have any address assigned, yet be perfectly usable. Configuring an IP address to a physical interface included in a bridge would mean actually setting it on the bridge interface itself. You can use to see which interface the address belongs to. /ip address print detail IPv4 Addressing IPv4 uses 4-byte addresses which are segmented in four 8-bit fields called octets. Each octet is converted to a decimal format and separated by a dot. For example: 11000000 10101000 00000011 00011000 => 192.168.3.24 The IPv4 network consists of three addresses: network address - a standard way to refer to an IPv4 address assigned to a network. For example, we could refer to the network 192.168.1.0 or 172.16.0.0 as a “Network Address.” broadcast address - a special address for each network that allows communication to all the hosts in that network. The broadcast address uses the highest address in the network range. for example, broadcast address if 192.168.1.0/24 network will be 192.168.1.255 host address - any other address that is not a network address and broadcast address can be used as a host address. For example, 192.168.1.2 - 254 host addresses can be used from 192.168.1.0/24 address range There are several types of IP addressing unicast - normally refers to a single sender or a single receiver, and can be used for both sending and receiving. Usually, a unicast address is associated with a single device or host, but it is not a one-to-one correspondence.

broadcast - address to send data to all possible destinations ("all-hosts broadcast"), which permits the sender to send the data only once, and all receivers receive a copy of it. In the IPv4 protocol, the address is used for local broadcast. In addition, a directed (limited) 255.255.255.255 broadcast can be made by combining the network prefix with a host suffix composed entirely of binary 1s. For example, the destination address used for directed broadcast to devices on the 192.0.2.0/24 network is 192.0.2.255 multicast - address associated with a group of interested receivers. In IPv4, addresses 224.0.0.0 through 239.255.255.255 are designated as multicast addresses. The sender sends a single datagram from its unicast address to the multicast group address and the intermediary routers take care of making copies and sending them to all receivers that have joined the corresponding multicast group. Private Address Range The following IP address ranges are reserved ( ) for private addressing. These addresses are not routed in the global routing table and should be RFC 6890 translated to global addresses with network address translation (NAT): 10.0.0.0/8 - start: 10.0.0.0; end: 10.255.255.255 172.16.0.0/12 - start: 172.16.0.0; end:172.31.255.255 192.168.0.0/16 - start: 192.168.0.0; end: 192.168.255.255 Other Reserved Address Ranges 198.18.0.0/15 - benchmarking 192.88.99.0/24 - 6to4 relay anycast address range 192.0.2.0/24, 198.51.100.0/24, 203.0.113.0/24 - documentation 169.254.0.0/16 - auto-configuration address range Adding IP Address Consider a setup where two routers are directly connected with the cable and we do not want to waste address space: R1 configuration: /ip address add address=10.1.1.1/32 interface=ether1 network=172.16.1.1 R2 configuration: /ip address add address=172.16.1.1/32 interface=ether1 network=10.1.1.1 IPv6 Addressing Internet Protocol version 6 (IPv6) is the newer version of the Internet Protocol (IP). It was initially expected to replace IPv4 in a short enough time, but for now, it seems that these two versions will coexist on the Internet in foreseeable future. Nevertheless, IPv6 becomes more important, as the date of the unallocated IPv4 address pool's exhaustion approaches. The two main benefits of IPv6 over IPv4 are: much larger address space; support of stateless and stateful address auto-configuration; built-in security; new header format (faster forwarding). IPv6 uses 16 bytes addresses compared to 4-byte addresses in IPv4. IPv6 address syntax and types are described in . RFC 4291 There are multiple IPv6 address types, that can be recognized by their prefix. RouterOS distinguishes the following: multicast (with prefix ff00::/8) link-local (with prefix fe80::/10) unique local addresses (with prefix fc00::/7) loopback (the address::1/128) unspecified (the address::/128)

other (all other addresses, including the obsoleted site-local addresses, and unique local addresses; they all are treated as global RFC 4193 unicast). One difference between IPv6 and IPv4 addresses is that IPv6 automatically generates a IPv6 address for each active interface that has IPv6 link-local support. IPv6 addresses are represented a little bit differently than IPv4 addresses. For IPv6, the 128-bit address is divided into eight 16-bit blocks, and each 16-bit block is converted to a 4-digit hexadecimal number and separated by colons. The resulting representation is called colon-hexadecimal. In the example below IPv6 address in binary format is converted to a colon-hexadecimal representation 0010000000000001 0000010001110000 0001111100001001 0000000100110001 0000000000000000 0000000000000000 0000000000000000 0000000000001001 2001:0470:1f09:0131:0000:0000:0000:0009 The IPv6 address can be further simplified by removing leading zeros in each block: 2001:470:1f09:131:0:0:0:9 As you can see IPv6 addresses can have long sequences of zeros. This contiguous sequence can be compressed to :: 2001:470:1f09:131::9 IPv6 prefix is written in format. Compared to IPv4 decimal representation of a network mask cannot be used. Prefix examples: address/prefix-length 2001:470:1f09:131::/64 2001:db8:1234::/48 2607:f580::/32 2000::/3 Address Types Several IPv6 address types exist: Unicast Anycast Multicast As you can see there are no Broadcast addresses in the IPv6 network, compared to the IPv4 broadcast functionality was completely replaced with multicast. Unicast Addresses Packets addressed to a unicast address are delivered only to a single interface. To this group belong: globally unique addresses and can be used to connect to addresses with global scope anywhere; link-local addresses; unique local addresses (ULA RFC4193) site-local addresses (FEC0::/48) - deprecated; special-purpose addresses; compatibility addresses; Zero compression can only be used once. Otherwise, you could not determine the number of 0 bits represented by each instance of a double- colon

A global unicast address can be automatically assigned to the node by Stateless Address auto-configuration. Link-local Address A link-local address is required on every IPv6-enabled interface, applications may rely on the existence of a link-local address even when there is no IPv6 routing, that is why the link-local address is generated automatically for every active interface using its interface identifier (calculated EUI-64 from MAC address if present). The address prefix is always and IPv6 router never forwards link-local traffic beyond the link. FE80::/64 These addresses are comparable to the auto-configuration addresses 169.254.0.0/16 of IPv4. A link-local address is also required for IPv6 Neighbor Discovery processes. Unique Local Address Unique Local Address (ULA) is reserved for local use in the home and enterprise environments not routed in public address space and is equivalent to IPv4 private address ranges. The reserved address range is fc00::/7 Special Purpose Address Address Description Unspecified address (:: /128)Never assigned to an interface or used as a destination address, used only to indicate the absence of an address. Equivalent to IPv4 0.0.0.0 address. loopback address (::1 /128)Used to identify a loopback interface, enabling a node to send packets to itself. It is equivalent to the IPv4 loopback address of 127.0.0.1. 2002::/16 This prefix is used for 6to4 addressing. Here, an address from the IPv4 network 192.88.99.0/24 is also used. 2001:db8::/32 Address range reserved for documentation. These should never be seen as the source or destination. 2001:0010::/28 Orchid fixed term experiment. Should not be seen as a source or destination 2001:0002::/48 Used for benchmarking, should not be seen as source or destination 2001:0000::/32 Teredo Compatibility Address Address Description IPv4 compatibl e addressused by dual-stack nodes that are communicating with IPv6 over an IPv4 infrastructure. When the IPv4-compatible address is used as an IPv6 destination, IPv6 traffic is automatically encapsulated with an IPv4 header and sent to the destination by using the IPv4 infrastructure. The address is written in the following format , where w.x.y.z is the dotted decimal representation of a public IPv4 address. ::w.x.y.z IPv4 mapped addressused to represent an IPv4-only node to an IPv6 node. It is used only for internal representation. The IPv4-mapped address is never used as a source or destination address for an IPv6 packet. The IPv6 protocol does not support the use of IPv4-mapped addresses. The address is written in the following format: , where is the dotted-decimal representation of a public IPv4 address. ::ffff:w.x.y.z w.x.y.z Multicast Address The most important multicast aspects are: traffic is sent to a single address but is processed by multiple hosts; group membership is dynamic, allowing hosts to join and leave the group at any time; in IPv6, Multicast Listener Discovery (MLD) messages are used to determine group membership on a network segment, also known as a link or subnet; a host can send traffic to the group's address without belonging to the corresponding group. If the interface is set as a bridge port, an interface-specific link-local address is removed leaving only the bridge link-local address

A single IPv6 multicast address identifies each multicast group. Each group's reserved IPv6 address is shared by all host members of the group who listen and receive any IPv6 messages sent to the group's address. The multicast address consists of the following parts: The first 8 bits in the multicast address are always 1111 1111 (which is FF in hexadecimal format). The flag uses the 9th to 12th bit and shows if this multicast address is predefined (well-known) or not. If it is well-known, all bits are 0s. Scope ID indicates to which scope multicast address belongs, for example, Scope ID=2 is link-local scope. The group ID is used to specify a multicast group. There are predefined group IDs, such as Group ID=1 - all nodes. Therefore, if the multicast address is ff02::1, that means Scope ID=2 and Group ID=1, indicating all nodes in link-local scope. This is analogous to broadcast on IPv4. Here is the table of reserved IPV6 addresses for multicast: Address Description FF02::1 The all-nodes address is used to reach all nodes on the same link. FF02::2 The all-routers address is used to reach all routers on the same link. FF02::5 The all-Open Shortest Path First (OSPF) router address is used to reach all OSPF routers on the same link. FF02::6 The all-OSPF-designated router's address is used to reach all OSPF-designated routers on the same link. FF02::1: FFXX: XXXXThe solicited-node address is used in the address resolution process to resolve the IPv6 address of a link-local node to its link-layer address. The last 24 bits (XX:XXXX) of the solicited-node address are the last 24 bits of an IPv6 unicast address. The following table is a partial list of IPv6 multicast addresses that are reserved for IPv6 multicasting and registered with the Internet Assigned Numbers Authority (IANA). For a complete list of assigned addresses read IANA document. Multicast addresses can be used to discover nodes in a network. For example, discover all nodes mrz@bumba:/media/aaa/ver$ ping6 ff02::1%eth0 PING ff02::1%eth0(ff02::1) 56 data bytes 64 bytes from fe80::21a:4dff:fe5d:8e56: icmp_seq=1 ttl=64 time=0.037 ms 64 bytes from fe80::20c:42ff:fe0d:2c38: icmp_seq=1 ttl=64 time=4.03 ms (DUP!) 64 bytes from fe80::20c:42ff:fe28:7945: icmp_seq=1 ttl=64 time=5.59 ms (DUP!) 64 bytes from fe80::20c:42ff:fe49:fce5: icmp_seq=1 ttl=64 time=5.60 ms (DUP!) 64 bytes from fe80::20c:42ff:fe21:f1ec: icmp_seq=1 ttl=64 time=5.88 ms (DUP!) 64 bytes from fe80::20c:42ff:fe72:a1b0: icmp_seq=1 ttl=64 time=6.70 ms (DUP!) discover all routers mrz@bumba:/media/aaa/ver$ ping6 ff02::2%eth0 PING ff02::2%eth0(ff02::2) 56 data bytes 64 bytes from fe80::20c:42ff:fe28:7945: icmp_seq=1 ttl=64 time=0.672 ms 64 bytes from fe80::20c:42ff:fe0d:2c38: icmp_seq=1 ttl=64 time=1.44 ms (DUP!) Anycast Address An anycast address is a new type of address incorporated in IPv6. Anycasting is a new networking paradigm supporting service-oriented Addresses where an identical address can be assigned to multiple nodes providing a specific service. An anycast packet (i.e., one with an anycast destination address) is delivered to one of these nodes with the same anycast address. An anycast address is not assigned a specific address range. It is assigned from the unicast address range.

R1 configuration: /ipv6 address add address=2001:DB8::1/64 interface=ether1 advertise=no R2 configuration: /ipv6 address add address=2001:DB8::2/64 interface=ether1 advertise=no Check the address list: [admin@R1] /ipv6 address> print Flags: X - disabled, I - invalid, D - dynamic, G - global, L - link-local # ADDRESS FROM-POOL INTERFACE ADVERTISE 0 G 2001:db8::1/64 ether1 no 3 DL fe80::219:d1ff:fe39:3535/64 ether1 no Notice that our added address has a G flag indicating that this address can be globally routed. We also have a link-local address on the interface which is created automatically for every IPv6-capable interface. Test connectivity: [admin@R1] /ipv6 address> /ping 2001:DB8::2 HOST SIZE TTL TIME STATUS 2001:db8::2 56 64 12ms echo reply 2001:db8::2 56 64 0ms echo reply sent=2 received=2 packet-loss=0% min-rtt=0ms avg-rtt=6ms max-rtt=12ms SLAAC IPv6 Address If under IPv6/Settings menu "accept-router-advertisements" option is enabled and the router receives a Router Advertisement packet, then the SLAAC IPv6 address will be automatically assigned to the interface on which the advertisements were received. This address will have DG flags meaning that the address is dynamic and global. Such addresses will show valid and lifetime parameters. [admin@R1] /ipv6/address/print detail where dynamic && global Flags: X - disabled, I - invalid, D - dynamic; G - global, L - link-local 0 DG address=2001:db8::::ba69:f4ff:fe84:545/64 from-pool="" interface=ether1 actual-interface=test_fp eui-64=no advertise=no no-dad=no valid=4w2d preferred=1w If SLAAC addresses are accepted, then also dynamic route toward the Internet will be generated. It will also contain a few limitations if specified on the advertisement packet. For example, hop-limit and MTU. If multiple addresses are received on the same interface, then the lowest of the MTU values per interface will be used. [admin@R1] /routing/route/print detail where slaac Flags: X - disabled, F - filtered, U - unreachable, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - ldp- mapping, g - slaac, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp, B - blackhole Ag + afi=ip6 contribution=active dst-address=::/0 routing-table=main pref-src="" gateway=fe80::ba69:f4ff:fe84:7b2%ether1 immediate-gw=fe80::ba69:f4ff:fe84:7b2%ether1 distance=1 scope=30 target-scope=10 belongs-to="slaac" mtu=1400 hoplimit=10 debug.fwp-ptr=0x201C2C00

Properties Property Description address (A ddress ; /Netmask Default: )Ipv6 address. Allowed netmask range is 0..128. Address can also be constructed from the pool if property is specified. from-pool For example if address is set to ::1/64 then address will be constructed as follows <prefix_from_pool>::1/64 advertise (y ; es | no Default: ) noWhether to enable stateless address configuration. The prefix of that address is automatically advertised three times to hosts using ICMPv6 protocol. The option is set by default for addresses with prefix length 64. If address is removed or changed, then old prefix will be deprecated by automatically advertising the old prefix with lifetime set to "0s" three times to hosts using ICMPv6 protocol comment c omment (st ; ring Default: )Descriptive name of an item disabled (y ; es | no Default: ) noWhether address is disabled or not. By default it is not disabled eui-64 (yes ; | no Default: ) noWhether to calculate EUI-64 address and use it as last 64 bits of the IPv6 address. from-pool ( ; string Default: )Name of the pool from which prefix will be taken to construct IPv6 address taking last part of the address from property. address no-dad (yes ; | no Default: )noIf enabled (yes) - disables Duplicate Address Detection (DAD) for IPv6 addresses on an interface. This can be useful in scenarios where you want to assign static IPv6 addresses to devices and avoid the delay caused by DAD. interface (st ; ring Default: )Name of an interface on which Ipv6 address is set. Read-only properties Property Description actual-interface ( ) stringActual interface on which address is set up. For example, if address was configured on ethernet interface and ethernet interface was added to bridge, then actual interface is bridge not ethernet. dynamic (yes | )noWhether address is dynamically created global ( ) yes | no Whether address is global invalid (yes | )noWhether address is invalid link-local (yes | )noWhether address is link local deprecated (ye ) s | noWhether address is deprecated slave ( ) yes | no Whether address belongs to an interface which is a slave port to some other master interface Frequently asked questions Q: Does RouterOS support NAT64? A: No, currently NAT64 is not implemented in RouterOS

IPv6 Neighbor Discovery Summary Node description Stateless address autoconfiguration Address states Neighbor discovery Properties Prefix Properties Neighbors List Examples Stateless autoconfiguration example Summary Standards: RFC 2462, RFC 2461, RFC 4861 RouterOS has IPv6 Neighbor Discovery and stateless address autoconfiguration support using Router Advertisement Daemon (RADVD). Node description Node is a device that implements IPv6. In IPv6 networks nodes are divided into two types: Routers - a node that forwards IPv6 packets not explicitly addressed to itself. Hosts - any node that is not a router. Routers and hosts are strictly separated, meaning that routers cannot be hosts and hosts cannot be routers at the same time. Stateless address autoconfiguration There are several types of autoconfiguration: stateless - address configuration is done by receiving Router Advertisement messages. These messages include stateless address prefixes and require that host is not using stateful address configuration protocol. stateful - address configuration is done by using the stateful address configuration protocol (DHCPv6). The stateful protocol is used if RA messages do not include address prefixes. both - RA messages include stateless address prefixes and require that hosts use a stateful address configuration protocol. A highly useful feature of IPv6 is the ability to automatically configure itself without the use of a stateful configuration protocol like DHCP ( ). See example It is called stateless address autoconfiguration since there is no need to manage the state on the router side. It is a very simple, robust, and effective autoconfiguration mechanism. RouterOS uses RADVD to periodically advertise information about the link to all nodes on the same link. The information is carried by ICMPv6 "router advertisement" packet, and includes the following fields: IPv6 subnet prefix Default router link-local address Other parameters that may be optional: are link MTU, default hop limit, and router lifetime. Then host catches the advertisement, and configures the global IPv6 address and the default router. Global IPv6 address is generated from the advertised and EUI-64 . subnet prefix interface identifier Address autoconfiguration can only be performed on multicast-capable interfaces.

Optionally, the host can ask for an advertisement from the router by sending an ICMPv6 "router solicitation" packet. On Linux utility transmits the rtsol router solicitation packet. If you are running a mobile node, you may want to transmit router solicitations periodically. Address states When an auto-configuration address is assigned it can be in one of the following states: tentative - in this state host verifies that the address is unique. Verification occurs through duplicate address detection. preferred - at this state address is verified as unique and the node can send and receive unicast traffic to and from a preferred address. The period of time of the preferred state is included in the RA message. deprecated - the address is still valid, but is not used for new connections. invalid - node can no longer send or receive unicast traffic. An address enters the invalid state after the valid lifetime expires. The image above illustrates the relation between states and lifetimes. Neighbor discovery Sub-menu: /ipv6 nd In this submenu, IPv6 Neighbor Discovery (ND) protocol is configured. Neighbor Discovery (ND) is a set of messages and processes that determine relationships between neighboring nodes. ND, compared to IPv4, replaces Address Resolution Protocol (ARP), Internet Control Message Protocol (ICMP) Router Discovery, and ICMP Redirect and provides additional functionality. ND is used by hosts to: Discover neighboring routers. Discover addresses, address prefixes, and other configuration parameters. ND is used by routers to: Advertise their presence, host configuration parameters, and on-link prefixes. Inform hosts of a better next-hop address to forward packets to a specific destination. ND is used by nodes to: Both resolve the link-layer address of a neighboring node to which an IPv6 packet is being forwarded and determine when the link-layer address of a neighboring node has changed. Determine whether IPv6 packets can be sent to and received from a neighbor. Properties Property Description advertise-dns ( |; Default: yes no )yesOption to redistribute DNS server information using RADVD. You will need a running client-side software with Router Advertisement DNS support to take advantage of the advertised information. DNS Read more >> advertise-mac-address ( |yes no ; Default: ) yesWhen set, the link-layer address of the outgoing interface is included in the RA. comment ( ; Default: ) string Descriptive name of an item dns-servers ( | unspecified ipv6 ; Default: ) addresses unspecifiedSpecify a single IPv6 address or list of addresses that will be provided to hosts for DNS server configuration. disabled ( |; Default: ) yes no no Whether an item is disabled or not. By default, entry is enabled.

hop-limit ( | [ unspecified integer 0 ]; Default: ) ..255 unspecifiedThe default value that should be placed in the Hop Count field of the IP header for outgoing (unicast) IP packets. interface (| ; Default: ) all string The interface on which to run neighbor discovery. all- run ND on all running interfaces. managed-address-configuration ( |; Default: ) yes no noThe flag indicates whether hosts should use stateful autoconfiguration (DHCPv6) to obtain addresses. mtu ( | [ unspecified integer 0.. ]; Default: 4294967295 unspecifi )edThe MTU option is used in router advertisement messages to ensure that all nodes on a link use the same MTU value in those cases where the link MTU is not well known. unspecified - do not send the MTU option. other-configuration ( |; yes no Default: ) noThe flag indicates whether hosts should use stateful autoconfiguration to obtain additional information (excluding addresses). pref64-prefixes ( | unspecified ip ; Default: ) v6 prefixes unspecifiedSpecify IPv6 prefix or list of prefixes within /32, /40. /48, /56, /64, or /96 subnet that will be provided to hosts as NAT64 prefixes. ra-delay ( ; Default: ) time 3s The minimum time allowed between sending multicast router advertisements from the interface. ra-interval ( [ ] time 3s..20m50s - [ ]; Default: time 4s..30m 3m20s- )10mThe min-max interval allowed between sending unsolicited multicast router advertisements from the interface. ra-preference ( | | low medium ; Default: ) high mediumSpecify the router preference that is communicated to IPv6 hosts through router advertisements. The preference value in the router advertisements enables IPv6 hosts to select a default router to reach a remote destination ra-lifetime ( | ; Default: none time )30mSets the RA lifetime. A Lifetime of 0 indicates that the router is not a default router.(see Section 6.2.3 of RFC 4861) reachable-time ( | unspecified [ ]; Default: ) time 0..1h unspecifiedThe time that a node assumes a neighbor is reachable after having received a reachability confirmation. Used by the Neighbor Unreachability Detection algorithm (see Section 7.3 of RFC 2461) retransmit-interval (unspecified ; Default: ) | time unspecifiedThe time between retransmitted Neighbor Solicitation messages. Used by address resolution and the Neighbor Unreachability Detection algorithm (see Sections 7.2 and 7.3 of RFC 2461) Prefix Sub-menu: /ipv6 nd prefix Prefix information sent in RA messages used by stateless address auto-configuration. Note: The autoconfiguration process applies only to hosts and not routers. Properties Property Description 6to4- interface (no ; ne | string Default: )If this option is specified, this prefix will be combined with the IPv4 address of the interface name to produce a valid 6to4 prefix. The first 16 bits of this prefix will be replaced by 2002 and the next 32 bits of this prefix will be replaced by the IPv4 address assigned to the interface name at configuration time. The remaining 80 bits of the prefix (including the SLA ID) will be advertised as specified in the configuration file. autonomous ( ; yes | no Default: ) yesWhen set, indicates that this prefix can be used for autonomous address configuration. Otherwise, prefix information is silently ignored. If ND is automatically generated by LTE configuration, then the maximum lifetime for RA will be capped at 1 hour.

comment (st ; ring Default: )Descriptive name of an item disabled (ye ; s | no Default: ) noWhether an item is disabled or not. By default, entry is enabled. on-link (yes ; Default:| no )yesWhen set, indicates that this prefix can be used for on-link determination. When not set the advertisement makes no statement about the on-link or off-link properties of the prefix. For instance, the prefix might be used for address configuration with some of the addresses belonging to the prefix being on-link and others being off-link. preferred- lifetime (infin ; ity | time Default: ) 1wTimeframe (relative to the time the packet is sent) after which generated address becomes "deprecated". Deprecated is used only for already existing connections and is usable until expires. valid lifetime Read more >> prefix (ipv6 ; prefix Default: ) ::/64A prefix from which stateless address autoconfiguration generates the valid address. valid-lifetime (infinity | ; time Default: 4w2d )The length of time (relative to the time the packet is sent) an address remains in the valid state. The must be greater valid lifetime than or equal to the . preferred lifetime Read more >> interface (str ; Default: ing )Interface name on which stateless auto-configuration will be running. Neighbors List Sub-menu: /ipv6 neighbor List of all discovered nodes by IPv6 neighbor discovery protocol (neighbor cache) or manually added by configuration. Property Description address ( ; Default: ) ipv6 address IPv6 address of the neighbour. interface ( ; Default: ) string interface name to which this neighbour is attached. mac-address ( ; Default: ) MAC 00:00:00:00:00:00 MAC address of the device to be added. Read-only Properties Property Description address ( ) ipv6 address IPv6 address of the node. interface ( ) string The interface on which the node was detected. mac-address ( ) string Mac address of the discovered node. router ( ) yes | no Whether the discovered node is a router

address ()IP IP address that is assigned to client from the pool info ( ) string For DHCP MAC address from leases menu and for PPP connections username of PPP type client owner ( ) string Service which is using this IP address pool ( ) string Name of the IP pool IPv6 Pool Sub-menu: /ipv6 pool Property Description name ( ; Default: ) string Descriptive name of the pool. prefix ( ; Default: ) IPv6/0..128 Ipv6 address prefix prefix-length ( ; Default: ) integer [1..128] The option represents the prefix size that will be given out to the client. Read-only properties Property Description dynamic ( ) yes | no Whether the pool is dynamic. expire-time ( )time Expire time is set to dynamic pools added by . DHCPv6 client Example The example will create a pool of "2001::/60" to give out /62 prefixes: [admin@test-host] /ipv6 pool> add name: test prefix: 2001::/60 prefix-length: 62 [admin@test-host] /ipv6 pool> print # NAME PREFIX PREFIX-LENGTH 0 test 2001::/60 62bits Used addresses Sub-menu: /ipv6 pool used Read-only properties Property Description info ( ) string Shows DUID related information received from the client (value in hex). Can contain also a raw timestamp in hex. owner ( ) string What reserved the prefix ("DHCP", etc.) pool ( ) string Name of the pool. prefix ( ) IPv6/0..128 IPv6 prefix that is assigned to the client from the pool.

IP Routing Overview How Routing Works Routing Information Routing Information Base Connected Routes Default Route Hardware Offloaded Route Multipath (ECMP) routes Route Selection Nexthop Lookup Route Storage Forwarding Information Base Routing table lookup Show Routes Overview Routing is the process of selecting paths across the networks to move packets from one host to another. How Routing Works Let's look at a basic configuration example to illustrate how routing is used to forward packets between two local networks and to the Internet. In this setup, we have several networks: two client networks (192.168.2.0/24 and 192.168.1.0/24); one network to connect routers (172.16.1.0/30), usually called backbone; the last network (10.1.1.0/24) connects our gateway router (Router1) to the internet. Router 2: /ip address add address=172.16.1.2/30 interface=ether1 add address=192.168.2.1/24 interface=bridge2 Router1 (gateway) where ether1 connects to the internet:

Routing Information Base Routing Information Base is a database that lists entries for particular network destinations and their (address of the next device along the path gateways or simply ). One such entry in the routing table is called a . next-hop route A occurs when a packet is passed from one network segment to another.hop By default, all routes are organized in one "main" routing table. It is possible to make more than one routing table which we will discuss further in this article, but for now, for sake of simplicity, we will consider that there is only one "main" routing table. RIB table contains complete routing information, including static routes and policy routing rules configured by the user, routing information learned from dynamic routing protocols (RIP, OSPF, BGP), and information about connected networks. Its purpose is not just to store routes, but also to filter routing information to calculate the best route for each destination prefix, to build and update the Forwarding Information Base, and to distribute routes between different routing protocols. Connected Routes Connected routes represent the network on which hosts can be directly reached (direct attachment to Layer2 broadcast domain). These routes are created automatically for each IP network that has at least one enabled interface attached to it (as specified in the or configuration). RIB /ip address /ipv6 address tracks the status of connected routes but does not modify them. For each connected route there is one IP address item such that: address part of the of the connected route is equal to a network of IP address item. dst-address netmask part of of the connected route is equal to the netmask part of the address of the IP address item. dst-address gateway of the connected route is equal to the actual of the IP address item (same as an interface, except for bridge interface ports) and -interface represents an interface where directly connected hosts from the particular Layer3 network can be reached. The is not used anymore for connected routes. FIB chooses the source address based on the out-interface. This allows preferred source making setups that in ROS v6 and older were considered invalid. See for more details. examples

ECMP (Equal cost multi-path) routes have multiple gateways (next-hop) values. All reachable next-hops are copied to FIB and are used to forward packets. These routes can be created manually, as well as dynamically by any of the dynamic routing protocols (OSPF, BGP, RIP). Multiple equally preferred routes to the same destination will have assigned + flag and grouped together automatically by RouterOS (see example below). [admin@TempTest] /ip/route> print Flags: D - DYNAMIC; I - INACTIVE, A - ACTIVE; C - CONNECT, S - STATIC, m - MODEM; + - ECMP Columns: DST-ADDRESS, GATEWAY, DISTANCE # DST-ADDRESS GATEWAY D 0 AS+ 192.168.2.0/24 10.155.125.1 1 1 AS+ 192.168.2.0/24 172.16.1.2 1 By default, ECMP uses hash policy which hashes source IP and destination IP (for IPv4) or source IP, destination IP, flow label and IP protocol (for Layer3 IPv6). It is possible to change hashing policies in /ip/setting and /ipv6/settings to hashing or hashing. Layer4 inner Layer3 IPv4 IPv6 L3 srcIPv4, dstIPv4 srcIPv6, dstIPv6, flow label, IP proto L4 srcIPv4, dstIPv4, srcPort, dstPort, IP proto srcIPv6, dstIPv6, srcPort, dstPort, IP Proto

L3-Inner srcIPv4, dstIPv4 (if inner IPv4) srcIPv6, dstIPv6, flow label, IP proto (if inner IPv6) Same as L3 if inner is not present.srcIPv4, dstIPv4 (if inner IPv4) srcIPv6, dstIPv6, flow label, IP proto (if inner IPv6) Same as L3 if inner is not present. Route Selection There can be multiple routes with the same destination received from various routing protocols and from static configurations but only one (best) destination can be used for packet forwarding. To determine the best path, RIB runs a Route Selection algorithm that picks the best route from all candidate routes per destination. Only routes that meet the following criteria can participate in the route selection process: Route is not disabled. If the type of route is it must have at least one reachable next-hop. ( if a gateway is from a connected network and there is a connected unicast route active, the gateway is considered as reachable) Route should not be . synthetic The candidate route with the lowest distance becomes an active route. If there is more than one candidate route with the same distance, the selection of the active route is arbitrary. Nexthop Lookup Nexthop lookup is a part of the route selection process. Its main purpose is to find a directly reachable gateway address (next-hop). Only after a valid next-hop is selected router knows which interface to use for packet forwarding. Nexthop lookup becomes more complicated if routes have a gateway address that is several hops away from this router (e. g. iBGP, multihop eBGP). Such routes are installed in the FIB after the next-hop selection algorithm determines the address of the directly reachable gateway (immediate next-hop). It is necessary to restrict the set of routes that can be used to look up immediate next-hops. Nexthop values of RIP or OSPF routes, for example, are supposed to be directly reachable and should be looked up only using connected routes. This is achieved using scope andtarget-scope properties. Routes with a scope greater than the maximum accepted value are not used for next-hop lookup. Each route specifies the maximum accepted scope value for its nexthop in the target- scope property. The default value of this property allows nexthop lookup only through connected routes, with the exception of iBGP routes that have a larger default value and can lookup nexthop also through IGP and static routes. There are changes in RouterOS v7 nexthop lookup. Routes are processed in scope order, and updates to routes with a larger scope cannot affect the state of nexthop lookup for routes with a smaller scope. Consider an example from v6:

/ip route add dst-address=10.0.1.0/24 gateway=10.0.0.1 scope=50 target-scope=30 comment=A /ip route add dst-address=10.0.2.0/24 gateway=10.0.0.1 scope=30 target-scope=20 comment=B /ip route add dst-address=10.0.0.0/24 scope=20 gateway=WHATEVER comment=C Gateway 10.0.0.1 is recursively resolved through C using the smallest referring scope (scope 20 from route B), both routes are active. Now we change both A and B at the same time: /ip route set A target-scope=10 Suddenly, applying an update to route A makes the gateway of route B inactive. This is because in v6 there is only one gateway object per address. v7 keeps multiple gateway objects per address, one for each combination of scope and gateway check. When or gateway check of a route is changed, ROS v7 , as it does in v6. In v7 target-scope and gateway check target-scope will not affect other routes are properties that are internally attached to the gateway, not to the route. Scope values considered as invalid and fixed automatically: if gateway scope is set to 255 - RouterOS will internally fix this error by setting gateway scope to 254. if route scope is less than gateway scope - RouterOS will internally fix this error by setting route scope to "gateway scope + 1" Used actual scope and target scope values can be seen in menu /routing/nexthop Gateway check can be extended by setting parameter. Gateway reachability can be checked by sending ARP probes, or ICMP check-gateway messages or by checking active BFD sessions. The router periodically (every 10 seconds) checks the gateway by sending either an ICMP echo request ( pi ) or an ARP request ( ). If no response from the gateway is received for 10 seconds, the request times out. After two timeouts gateway is considered ng arp unreachable. After receiving a reply from the gateway it is considered reachable and the timeout counter is reset. Route Storage Routing information is stored to take as little memory as possible in a common case. These optimizations have non-obvious worst cases and impact on performance. All routes and gateways are kept in a single hierarchy by the prefix/address. Dst [4]/0 1/0+4 18 <-- number of prefixes ^ ^ ^ ^ ^ | | | | | | | | | \- bytes taken by Route distinguisher or Interface Id | | | \--- vrf/routing table | | \----- AFI | \------- netmask length of prefix \---------- bytes taken by prefix value [subject to change without notice] Each of these 'Dst' corresponds to a unique 'dst-address' of route or address of the gateway. Each 'Dst' requires one or more 'T2Node' objects as well. All routes with the same 'dst-address' are kept in Dst in a list sorted by route preference. WORST CASE: having a lot of routes with the same 'dst-address' is really slow! even if they are inactive! because updating a sorted list with tens of Note: thousands of elements is slow! Route order changes only when route attributes change. If the route becomes active/inactive, the order does not change. Each Route has three copies of route attributes: private -- what is received from the peer, before passing in-filters. updated -- what is the result of applying in-filters. current -- what are the attributes currently used by the route.

Periodically (when needed), attributes are update calculated from attri private butes. This happens when route update is received, or when in-filter is updated. When the routing table is recalculated, attribu current tes are set to the value from attributes. updated This means, that usually if there is no in-filter that changes route attributes, pri , and vate updated, current share the same value. Route attributes are kept in several groups: L1 Data - all flags, list of extra properties, as- path; L2 Data - nexthops, RIP, OSPF, BGP metrics, route tags, originators, etc. L3 Data - distance, scope, kernel type, MPLS stuff extra properties - communities, originator, aggregator-id, cluster-list, unknown Having for example many different combinations of and route attributes will use more memory! distance scope Matching communities or as-path using regexp will cache the result, to speed up filtering. Each as-path or community value has a cache for all regexp, which is filled on-demand with match results. WORST CASE: changing attributes in 'in-filter' will make the route program use more memory! Because 'private' and 'updated' attributes will be Note: different! Having a lot of different regexps will make matching slow and use a lot of memory! Because each value will have a cache with thousands of entries! Detailed info about used memory by routing protocols can be seen in menu stats memory /routing Forwarding Information Base FIB (Forwarding Information Base) contains a copy of the information that is necessary for packet forwarding: all active routes policy routing rules Each route has property, that specifies all destination addresses this route can be used for. If several routes apply to a particular IP address, dst-address the most specific one (with the largest netmask) is used. This operation (finding the most specific route that matches the given address) is called ''routing table lookup''.

Only one Best route can be used for packet forwarding. In cases where the routing table contains several routes with the same , all equally dst-address best routes are combined into one route. The best route is installed into FIB and marked as ''active''. ECMP When forwarding decision uses additional information, such as the source address of the packet, it is called . Policy routing is implemented as policy routing alist of policy routing rules, that select different routing tables based on the destination address, source address, source interface, and routing mark (which can be changed by firewall mangle rules) of the packet. Routing table lookup FIB uses the following information from the packet to determine its destination: source address destination address source interface routing mark Possible routing decisions are: receive packet locally discard the packet (either silently or by sending an ICMP message to the sender of the packet)

send the packet to a specific IP address on a specific interface Run routing decision: check that the packet has to be locally delivered (the destination address is the address of the router) process implicit policy routing rules process policy routing rules added by a user process implicit catch-all rule that looks up the destination in the ''main'' routing table the returned result is "network unreachable" The result of the routing decision can be: IP address of nexthop + interface point-to-point interface local delivery discard ICMP prohibited ICMP host unreachable ICMP network unreachable Rules that do not match the current packet are ignored. If a rule has action: drop or , then it is returned as a result of the routing decision process. unreachable lookup then the destination address of the packet is looked up in the routing table that is specified in the rule. If the lookup fails (no route matches the destination address of the packet), then FIB proceeds to the next rule. lookup-only is similar to except that lookup fails if none of the routes in the table matches the packet. lookup Otherwise: if the type of the route is , or , then return this action as the routing decision result; blackhole prohibit, unreachable if this is a connected route or route with an interface as the value, then return this interface and the destination address of the packet as gateway the routing decision result; if this route has an IP address as the value of , then return this address and associated interface as the routing decision result; the gateway if this route has multiple values of nexthop, then pick one of them in a round-robin fashion. Show Routes In RouterOS you have three menus to see the current state of routes in the routing table: /ip route - list IPv4 routes and basic properties /ipv6 route - list IPv6 routes and basic properties /routing route - list all routes with extended properties Example output /routing route menu currently is read-only. To add or remove routes menus should be used. /() ipipv6 route

IP Settings Summary IPv4 Settings IPv6 Settings Summary Several IPv4 and IPv6 related kernel and system-wide parameters are configurable. IPv4 Settings Sub-menu: /ip settings Property Description accept- redirects (yes ; Default:| no )noWhether to accept ICMP redirect messages. Typically should be enabled on a host and disabled on routers. accept- source-route ( ; yes | no Default: ) noWhether to accept packets with the SRR option. Typically should be enabled on the router. allow-fast- path (yes | no ; Default: ) yesAllows . Fast Path arp-timeout (ti ; me interval Default: ) 30sSets Linux (base_reachable_time_ms) on all interfaces that use ARP. The initial validity of the ARP entry is base_reachable_time picked from the interval [timeout/2 - 3*timeout/2] (default from 15s to 45s) after the neighbor was found. Can use postfix ms, s, m, h, d for milliseconds, seconds, minutes, hours, or days. if no postfix is set then seconds (s) are used. The parameter means how long a valid ARP record will be considered complete if no one communicates with the specific MAC/IP during this time. The parameter does not represent a time when an ARP entry is removed from the ARP cache (see setting). max-neighbor-entries icmp-errors- use-inbound- interface- address (yes ; | no Default: no)If enabled, the ICMP error message reply will be sent with the source address equal to primary address of the receiving interface that caused the error . This feature can be useful for complex network debugging. icmp-rate- limit (integer [0.. ; 4294967295] Default: ) 10Limit the maximum rates for sending ICMP packets whose type matches icmp-rate-mask to specific targets. disables any limiting, 0 other values indicate the minimum space between responses in milliseconds. icmp-rate- mask ([0.. ; FFFFFFFF] Default: 0x18 )18Mask made of ICMP types for which rates are being limited. More info in Linux man pages ip-forward (ye ; s | no Default: ) yesEnable/disable packet forwarding between interfaces. Resets all configuration parameters to defaults according to RFC1812 for routers.

ipv4- multipath- hash-policy (l3 ; | l4 | l3-inner Default: ) l3IPv4 Hash policy used for ECMP routing in menu /ip/settings l3 -- layer-3 hashing of src IP, dst IP l3-inner -- layer-3 hashing or inner layer-3 hashing if available l4 -- layer-4 hashing of src IP, dst IP, IP protocol, src port, dst port rp-filter (loose ; | no | strict Default: ) noDisables or enables source validation. no - No source validation. strict - Strict mode as defined in RFC3704 Strict Reverse Path. Each incoming packet is tested against the FIB and if the interface is not the best reverse path the packet check will fail. By default failed packets are discarded. loose - Loose mode as defined in RFC3704 Loose Reverse Path. Each incoming packet's source address is also tested against the FIB and if the source address is not reachable via any interface the packet check will fail. The current recommended practice in RFC3704 is to enable strict mode to prevent IP spoofing from DDoS attacks. If using asymmetric routing or other complicated routing or VRRP, then the loose mode is recommended. Warning: strict mode does not work with routing tables secure- redirects (yes ; Default:| no )yesAccept ICMP redirect messages only for gateways, listed in the default gateway list. send- redirects (yes ; Default:| no )yesWhether to send ICMP redirects. Recommended to be enabled on routers. tcp- timestamps ( disabled | enabled | random-offset ; Default: rand om-offset)Parameter allows to enable/disable TCP timestamps or add random offset to TCP timestamp (default behavior). Disabling timestamps completely may help to reduce spikes of performance drops. tcp- syncookies (y ; es | no Default: ) noSend out syncookies when the syn backlog queue of a socket overflows. This is to prevent the common 'SYN flood attack'. syncookies seriously violate TCP protocol, and disallow the use of TCP extensions, which can result in serious degradation of some services (f.e. SMTP relaying), visible not by you, but to your clients and relays, contacting you. max- neighbor- entries (integ er [0.. ; 4294967295] Default: ) Sets Linux A maximum number of allowed neighbors in the ARP table. Since RouterOS version 7.1, gc_thresh3. the default value depends on the installed amount of RAM. It is possible to set a higher value than the default, but it increases the risk of out-of- memory condition. The default values for certain RAM sizes: 2048 for 64 MB, 4096 for 128 MB, 8192 for 256 MB, 16384 for 512 MB or higher. The ARP cache stores ARP entries, and if some of these entries are incomplete, they can stay in the cache for an indefinite period of time. This will only happen if the number of entries in the cache is less than one-fourth of the maximum number allowed. The reason for this is to prevent the unnecessary running of the garbage-collector when the ARP table is not close to being full. route-cache ( ; yes | no Default: ) yesDisable or enable the Linux route cache. Note that disabling the route cache, will also disable the fast path. Read-Only Properties Property Description

ipv4-fast-path-active ( ) yes | no Indicates whether fast-path is active ipv4-fast-path-bytes ( ) integer Amount of fast-pathed bytes ipv4-fast-path-packets ( ) integer Amount of fast-pathed packets ipv4-fasttrack-active ( ) yes | no Indicates whether fasttrack is active ipv4-fasttrack-bytes ( ) integer Amount of fasttracked bytes ipv4-fasttrack-packets ( ) integer Amount of fasttracked packet. IPv6 Settings Sub-menu: /ipv6 settings Property Description accept-redirects (no | yes-if-forwarding- ; Default: ) disabled yes-if-forwarding-disabledWhether to accept ICMP redirect messages. Typically should be enabled on the host and disabled on routers accept-router-advertisements (no | yes | yes- ; Default: if-forwarding-disabled yes-if- ) forwarding-disabledAccept router advertisement (RA) messages. If enabled, the router will be able to get the address using stateless address configuration disable-ipv6 ( ; Default: ) yes | no no Enable/disable system wide IPv6 settings (prevents LL address generation) forward ( ; Default: ) yes | no yes Enable/disable packet forwarding between interfaces max-neighbor-entries (integer [0.. ; Default: ) 4294967295] A maximum number or IPv6 neighbors. Since RouterOS version 7.1, the default value depends on the installed amount of RAM. It is possible to set a higher value than the default, but it increases the risk of out-of-memory condition. The default values for certain RAM sizes: 1024 for 64 MB, 2048 for 128 MB, 4096 for 256 MB, 8192 for 512 MB, 16384 for 1024 MB or higher. multipath-hash-policy ( ; l3 | l4 | l3-inner Default: ) l3IPv6 Hash policy used for ECMP routing in menu /ipv6/settings l3 -- layer-3 hashing of src IP, dst IP, flow label, IP protocol l3-inner -- layer-3 hashing or inner layer-3 hashing if available l4 -- layer-4 hashing of src IP, dst IP, IP protocol, src port, dst port Changing /ipv6 settings will not dynamically remove the old SLAAC configuration present on your router. A reboot is required to apply the new settings.

API Summary Protocol API words Command word Attribute word API attribute word Query word Reply word API sentences Initial login Tags Command description Queries OID !trap message category Command examples /system/package/getall /user/active/listen /cancel, simultaneous commands Example client See also API examples Summary Application Programmable Interface (API) allows users to create custom software solutions to communicate with RouterOS to gather information, adjust the configuration, and manage the router. API closely follows syntax from the command-line interface (CLI). It can be used to create translated or custom configuration tools to aid ease of use in running and managing routers with RouterOS. API service must be enabled before trying to establish the API connection. By default, API uses TCP: and TCP: (secure). 8728 8729 API-SSL service is capable of working in two modes - with and without a certificate. In the case no certificate is used in settings then an /ip service anonymous Diffie-Hellman cipher has to be used to establish a connection. If a certificate is in use, a TLS session can be established. Protocol Communication with the router is done by sending sentences and receiving one or more sentences in return. A sentence is a sequence of words terminated by zero-length words. Word is part of a sentence encoded in a certain way - encoded length and data. Communication happens by sending sentences to the router and receiving replies to sent sentences. Each sentence sent to the router using API should contain a command as a first word followed by words in no particular order, the end of the sentence is marked by a zero-length word. When the router receives a full sentence (command word, no or more attribute words, and zero-length word) it is evaluated and executed, then a reply is formed and returned. API words Words are part of a sentence. Each word has to be encoded in a certain way - the length of the word followed by the word content. The length of the word should be given as a count of bytes that are going to be sent. The length of the word is encoded as follows: Value of length # of bytes Encoding 0 <= len <= 0x7F 1 len, lowest byte 0x80 <= len <= 0x3FFF 2 len | 0x8000, two lower bytes

0x4000 <= len <= 0x1FFFFF 3 len | 0xC00000, three lower bytes 0x200000 <= len <= 0xFFFFFFF 4 len | 0xE0000000 len >= 0x10000000 5 0xF0 and len as four bytes Each word is encoded as length, followed by that many bytes of content; Words are grouped into sentences. The end of a sentence is terminated by a zero-length word; The scheme allows encoding of length up to , only four-byte length is supported; 0x7FFFFFFFFF len bytes are sent most significant first (network order); If the first byte of the word is , then it is a reserved control byte. After receiving an unknown control byte API client cannot proceed, >= 0xF8 because it does not know how to interpret the following bytes; Currently, control bytes are not used; In general, can be described like this << >< >>. can be separated into 5 parts: , words encoded word length word content Word content command word attribut , . and e word API attribute word , query word reply word Command word The first word in the sentence has to be a command followed by attribute words and a zero-length word or terminating word. The name of the command word should begin with '/'. Names of commands closely follow CLI, with spaces replaced with '/'. Some commands are specific to API; Command word structure in the strict order: encoded length content prefix / CLI converted command API-specific commands: login cancel Command word content examples: /login /user/active/listen /interface/vlan/remove /system/reboot Attribute word Each has its list of depending on content. command word attribute words Attribute word structure consists of 5 parts in this order: encoded length content prefix equals sign - = attribute name separating equals sign - = value of an attribute if there is one. It is possible that the attribute does not have a value Examples without encoded length prefix: Value can hold multiple signs in the value of an since the way the word is encoded. equal attribute word Value can be empty.

=address=10.0.0.1 =name=iu=c3Eeg =disable-running-check=yes API attribute word API attribute word structure is in the strict order: encoded length content prefix with the dot . attribute name name postfixed with equals sign= attribute value Currently, the only such API attribute is the .tag Query word Sentences can have additional query parameters that restrict their scope. A detailed explanation is in the . query section Example of a sentence using query word attributes: /interface/print ?type=ether ?type=vlan ?#|! Query words begin with '?'. Currently, only the command handles query words. print Reply word It is only sent by the router in response to the full sentence received from the client. The first word of reply begins with '!'; Each sentence sent generates at least one reply (if a connection does not get terminated); The last reply for every sentence is the reply that has the first word ; !done Errors and exceptional conditions begin with ;!trap Data replies begin with !re If the API connection is closed, RouterOS sends with a reason as a reply and then closes the connection; !fatal API sentences API sentence is the main object of communication using API. Empty sentences are ignored. A sentence is processed after receiving zero length word. There is a limit on the number and size of sentences that the client can send before it has logged in. Order of attribute words should not be relied on. As order and count are changeable by attribute. .proplist The sentence structure is as follows: The first word should contain a ; command word Order of attribute words and API parameters is not important and should not be relied on If the sentence contains an tag then each returned sentence in reply from the router to that tagged sentence will be tagged API attribute word with the same tag. The order of query words is significant

Should contain to terminate the sentence; zero-length word Can contain none or several . There is no particular order in what attribute words have to be sent in the sentence, order is attribute words not important for ; attribute words Can contain none or several . The order of in the sentence is important. query words query words Initial login Note: that each command and response ends with an empty word. Login method post-v6.43: /login =name=admin =password= !done Now the client sends a username and password in the first message. Password is sent in plain text. in case of an error, the reply contains =message= . error message In case of a successful login, the client can start to issue commands. Tags It is possible to run several commands simultaneously, without waiting for the previous one to complete. If the API client is doing this and needs to differentiate command responses, it can use the ' ' API parameter in command sentences.tag If you include the ' ' parameter with a non-empty value in the command sentence, then the ' ' parameter with the same value will be included tag tag in all responses generated by this command. If you do not include the ' ' parameter or its value is empty, then all responses for this command will not have a ' ' parameter. tag tag Command description /cancel optional argument: =tag= , without it, cancels all running commands tag of command to cancel does not cancel itself all canceled commands are interrupted and in the usual case generate '!trap' and '!done' responses please note that /cancel is separate command and can have its own unique '.tag' parameter, that is not related to '=tag' argument of this command listen listen command is available where console print command is available, but it does not have the expected effect everywhere (i.e. may not work) !re"" sentences are generated as something changes in a particular item list when an item is deleted or disappears in any other way, the ' ' sentence includes the value '=.dead=yes'!re This command does not terminate. To terminate it, use / command. cancel getall getall command is available where console print command is available ( is an alias for ). getall print replies contain =.id= property. Item internal number print API print command differs from the console counterpart in the following ways: where an argument is not supported. Items can be filtered using query words (see below). .proplist argument is a comma-separated list of property names that should be included for the returned items. Zero-length word terminates the sentence. If it is not provided router will not start to evaluate sent words and will consider all the input as part of the same sentence.

returned items may have additional properties. order of returned properties is not defined. if a list contains duplicate entries, handling of such entries is not defined. if a property is present in " , but absent from the item, then that item does not have this property value (?name .proplist " will evaluate to false for that item). if " is absent, all properties are included as requested by the print command, even those that have slow .proplist " access time (such as file contents and performance counters). Thus the use of is encouraged. The omission .proplist of may have a high-performance penalty if the "=detail=" argument is set. .proplist Queries The command accepts query words that limit the set of returned sentences. print Query words begin with '?'. The order of query words is significant. A query is evaluated starting from the first word. A query is evaluated for each item in the list. If the query succeeds, the item is processed, if a query fails, the item is ignored. A query is evaluated using a stack of boolean values. Initially, the stack contains an infinite amount of 'true' values. At the end of the evaluation, if the stack contains at least one 'false' value, the query fails. Query words operate according to the following rules: Query Description ?name pushes 'true' if an item has a value of property , 'false' if it does not. name ?-name pushes 'true' if an item does not have a value of property , 'false' otherwise. name ? = name x ?= = name xpushes 'true' if the property has a value equal to , 'false' otherwise. name x ?<name= x pushes 'true' if the property has a value less than , 'false' otherwise. name x ?>name= x pushes 'true' if the property has a value greater than , 'false' otherwise. name x ?#operations applies operations to the values in the stack. operation string is evaluated from left to right. the sequence of decimal digits followed by any other character or end of the word is interpreted as a stack index. top value has an index 0. an index that is followed by a character pushes a copy of the value at that index. an index that is followed by the end of the word replaces all values with the value at that index. ! character replaces the top value with the opposite. & pops two values and pushes the result of logical 'and' operation. | pops two values and pushes the result of logical 'or' operation. . after an index does nothing. . after another character pushes a copy of the top value. Examples: Get all ethernet and VLAN interfaces: /interface/print ?type=ether ?type=vlan ?#| Get all routes that have a non-empty comment: /ip/route/print ?>comment= Regular expressions are not supported in API, so do not try to send a query with the symbol~

Forum thread with a detailed explanation of the use of queries OID The command can return OID values for properties that are available in SNMP. print In the console, OID values can be seen by running the 'print oid' command. In API, these properties have a name that ends with ".oid", and can be retrieved by adding their name to the value of '.proplist'. An example: /system/resource/print =.proplist=uptime,cpu-load,uptime.oid,cpu-load.oid !re =uptime=01:22:53 =cpu-load=0 =uptime.oid=.1.3.6.1.2.1.1.3.0 =cpu-load.oid=.1.3.6.1.2.1.25.3.3.1.2.1 !done !trap When for some reason API sentence fails trap is sent in return accompanied by a attribute and on some occasions argument. message category message When an API sentence fails, some generic message or message from the used internal process is returned to give more details about the failure <<< /ip/address/add <<< =address=192.168.88.1 <<< =interface=asdf <<< >>> !trap >>> =category=1 >>> =message=input does not match any value of interface category if it is a general error, it is categorized and the error category is returned. possible values for this attribute are 0 - missing item or command 1 - argument value failure 2 - execution of command interrupted 3 - scripting related failure 4 - a general failure 5 - API related failure 6 - TTY related failure 7 - value generated with :return command Command examples

/system/package/getall /system/package/getall !re =.id=*5802 =disabled=no =name=routeros-x86 =version=3.0beta2 =build-time=oct/18/2006 16:24:41 =scheduled= !re =.id=*5805 =disabled=no =name=system =version=3.0beta2 =build-time=oct/18/2006 17:20:46 =scheduled= ... more !re sentences ... !re =.id=*5902 =disabled=no =name=advanced-tools =version=3.0beta2 =build-time=oct/18/2006 17:20:49 =scheduled= !done /user/active/listen /user/active/listen !re =.id=*68

=radius=no =when=oct/24/2006 08:40:42 =name=admin =address=0.0.0.0 =via=console !re =.id=*68 =.dead=yes ... more !re sentences ... /cancel, simultaneous commands /login !done =ret=856780b7411eefd3abadee2058c149a3 /login =name=admin =response=005062f7a5ef124d34675bf3e81f56c556 !done -- first start listening for interface changes (tag is 2) /interface/listen .tag=2 -- disable interface (tag is 3) /interface/set =disabled=yes =.id=ether1 .tag=3 -- this is done for disable command (tag 3) !done .tag=3 -- enable interface (tag is 4) /interface/set

=disabled=no =.id=ether1 .tag=4 -- this update is generated by a change made by the first set command (tag 3) !re =.id=*1 =disabled=yes =dynamic=no =running=no =name=ether1 =mtu=1500 =type=ether .tag=2 -- this is done for enable command (tag 4) !done .tag=4 -- get interface list (tag is 5) /interface/getall .tag=5 -- this update is generated by a change made by the second set command (tag 4) !re =.id=*1 =disabled=no =dynamic=no =running=yes =name=ether1 =mtu=1500 =type=ether .tag=2 -- these are replies to getall command (tag 5) !re =.id=*1

=disabled=no =dynamic=no =running=yes =name=ether1 =mtu=1500 =type=ether .tag=5 !re =.id=*2 =disabled=no =dynamic=no =running=yes =name=ether2 =mtu=1500 =type=ether .tag=5 -- here interface getall ends (tag 5) !done .tag=5 -- stop listening - request to cancel command with tag 2, cancel itself uses tag 7 /cancel =tag=2 .tag=7 -- listen command is interrupted (tag 2) !trap =category=2 =message=interrupted .tag=2 -- cancel command is finished (tag 7) !done .tag=7

Python3 Example A simple Python3 example client. usage: api.py ip-address username password secure i.e. api.py 10.0.0.1 Admin Badpassword123 True after that, type words from the keyboard, terminating them with a new line Since an empty word terminates a sentence, you should press enter after the last word before a sentence will be sent to the router. twice #!/usr/bin/python3 # -*- coding: latin-1 -*- import sys, posix, time, binascii, socket, select, ssl import hashlib class ApiRos: "Routeros api" def __init__(self, sk): self.sk = sk self.currenttag = 0 def login(self, username, pwd): for repl, attrs in self.talk(["/login", "=name=" + username, "=password=" + pwd]): if repl == '!trap': return False elif '=ret' in attrs.keys(): #for repl, attrs in self.talk(["/login"]): chal = binascii.unhexlify((attrs['=ret']).encode(sys.stdout.encoding)) md = hashlib.md5() md.update(b'\x00') md.update(pwd.encode(sys.stdout.encoding)) md.update(chal) for repl2, attrs2 in self.talk(["/login", "=name=" + username, "=response=00" + binascii.hexlify(md.digest()).decode(sys.stdout.encoding) ]): if repl2 == '!trap': return False return True def talk(self, words): if self.writeSentence(words) == 0: return r = [] while 1: i = self.readSentence(); if len(i) == 0: continue reply = i[0] attrs = {} for w in i[1:]: j = w.find('=', 1) if (j == -1): attrs[w] = '' else: attrs[w[:j]] = w[j+1:] r.append((reply, attrs)) if reply == '!done': return r def writeSentence(self, words): ret = 0 for w in words: self.writeWord(w) ret += 1 self.writeWord('') return ret def readSentence(self): r = [] while 1: w = self.readWord() if w == '': return r

r.append(w) def writeWord(self, w): print(("<<< " + w)) self.writeLen(len(w)) self.writeStr(w) def readWord(self): ret = self.readStr(self.readLen()) print((">>> " + ret)) return ret def writeLen(self, l): if l < 0x80: self.writeByte((l).to_bytes(1, sys.byteorder)) elif l < 0x4000: l |= 0x8000 tmp = (l >> 8) & 0xFF self.writeByte(((l >> 8) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte((l & 0xFF).to_bytes(1, sys.byteorder)) elif l < 0x200000: l |= 0xC00000 self.writeByte(((l >> 16) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 8) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte((l & 0xFF).to_bytes(1, sys.byteorder)) elif l < 0x10000000: l |= 0xE0000000 self.writeByte(((l >> 24) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 16) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 8) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte((l & 0xFF).to_bytes(1, sys.byteorder)) else: self.writeByte((0xF0).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 24) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 16) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte(((l >> 8) & 0xFF).to_bytes(1, sys.byteorder)) self.writeByte((l & 0xFF).to_bytes(1, sys.byteorder)) def readLen(self): c = ord(self.readStr(1)) # print (">rl> %i" % c) if (c & 0x80) == 0x00: pass elif (c & 0xC0) == 0x80: c &= ~0xC0 c <<= 8 c += ord(self.readStr(1)) elif (c & 0xE0) == 0xC0: c &= ~0xE0 c <<= 8 c += ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) elif (c & 0xF0) == 0xE0: c &= ~0xF0 c <<= 8 c += ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) elif (c & 0xF8) == 0xF0: c = ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) c <<= 8 c += ord(self.readStr(1)) return c

def writeStr(self, str): n = 0; while n < len(str): r = self.sk.send(bytes(str[n:], 'UTF-8')) if r == 0: raise RuntimeError("connection closed by remote end") n += r def writeByte(self, str): n = 0; while n < len(str): r = self.sk.send(str[n:]) if r == 0: raise RuntimeError("connection closed by remote end") n += r def readStr(self, length): ret = '' # print ("length: %i" % length) while len(ret) < length: s = self.sk.recv(length - len(ret)) if s == b'': raise RuntimeError("connection closed by remote end") # print (b">>>" + s) # atgriezt kaa byte ja nav ascii chars if s >= (128).to_bytes(1, "big") : return s # print((">>> " + s.decode(sys.stdout.encoding, 'ignore'))) ret += s.decode(sys.stdout.encoding, "replace") return ret def open_socket(dst, port, secure=False): s = None res = socket.getaddrinfo(dst, port, socket.AF_UNSPEC, socket.SOCK_STREAM) af, socktype, proto, canonname, sockaddr = res[0] skt = socket.socket(af, socktype, proto) if secure: s = ssl.wrap_socket(skt, ssl_version=ssl.PROTOCOL_TLSv1_2, ciphers="ECDHE-RSA-AES256-GCM- SHA384") #ADH-AES128-SHA256 else: s = skt s.connect(sockaddr) return s def main(): s = None dst = sys.argv[1] user = "admin" passw = "" secure = False port = 0 # use default username and pasword if not specified arg_nr = len(sys.argv) if arg_nr > 2: user = sys.argv[2] if arg_nr > 3: passw = sys.argv[3] if arg_nr > 4: secure = sys.argv[4] if (port==0): port = 8729 if secure else 8728 s = open_socket(dst, port, secure) if s is None: print ('could not open socket') sys.exit(1) apiros = ApiRos(s); if not apiros.login(user, passw): return inputsentence = [] while 1: r = select.select([s, sys.stdin], [], [], None)

if s in r[0]: # something to read in socket, read sentence x = apiros.readSentence() if sys.stdin in r[0]: # read line from input and strip off newline l = sys.stdin.readline() l = l[:-1] # if empty line, send sentence and start with new # otherwise append to input sentence if l == '': apiros.writeSentence(inputsentence) inputsentence = [] else: inputsentence.append(l) if __name__ == '__main__': main()

If a Default configuration or CAPs mode script execution takes more than 2 minutes, a script will fail, and LOG will contain "runtime limit or in rare cases error. exceeded" "std failure: timeout"

move Changes the order of items in the list. Parameters: the first argument specifies the item(-s) being moved. the second argument specifies the item before which to place all items being moved (they are placed at the end of the list if the second argument is omitted). print Shows all information that's accessible from a particular command level. Thus, shows the system date and time, /system clock print shows all routes etc. If there\'s a list of items in the current level and they are not read-only, i.e. you can change /ip route print /remove them (example of read-only item list is , which shows a history of executed actions), then print command also /system history assigns numbers that are used by all commands that operate with items in this list. Common Parameters: append - brief - forces the print command to use tabular output form count-only - shows the number of items detail - forces the print command to use property=value output form file - prints the contents of the specific sub-menu into a file on the router. follow - follow-only - follow-strict - from - show only specified items, in the same order in which they are given. interval - updates the output from the print command for every interval of seconds. oid - prints the OID value for properties that are accessible from SNMP. proplist - comma-separated and ordered list of property names that should be included for the returned items. show-ids - where - show only items that match specified criteria. The syntax of where the property is similar to the find command. without-paging - prints the output without stopping after each screenful. remove Removes specified item(-s) from a list. set Allows you to change values of general parameters or item parameters. The set command has arguments with names corresponding to values you can change. Use ? or double Tab to see a list of all arguments. If there is a list of items in this command level, then the set has one action argument that accepts the number of items (or list of numbers) you wish to set up. This command does not return anything. Input Modes It is possible to switch between several input modes: Normal mode - indicated by normal command prompt. Safe mode - safe mode is indicated by the word SAFE after the command prompt. In this mode, the configuration is saved to disk only after the safe mode is turned off. Safe mode can be turned on/off with Ctrl+X or F4. Read more >> Hot-lock mode - indicated by additional yellow >. Hot-lock mode autocompletes commands and can be turned on/off with F7 Quick Typing There are two features in the console that help entering commands much quicker and easier - the [ ] key completions, and abbreviations of command Tab names. Completions work similarly to the bash shell in UNIX. If you press the [ ] key after a part of a word, the console tries to find the command within Tab the current context that begins with this word. If there is only one match, it is automatically appended, followed by a space: /inte[Tab]_ becomes /interface _ If there is more than one match, but they all have a common beginning, which is longer than that what you have typed, then the word is completed to this common part, and no space is appended: /interface set e [Tab]_ becomes /interface set ether_ If you've typed just the common part, pressing the tab key once has no effect. However, pressing it for the second time shows all possible completions in compact form:

F7 toggle hot-lock mode Control-R or F3 toggle console search F6 toggle cellar F1 show context-sensitive help. Tab perform line completion. When pressed a second time, show possible completions. # Send a message to an internal chat system Delete remove character at the cursor Control-H or Backspaceremoves character before cursor and moves the cursor back one position. Control-\ split line at cursor. Insert newline at the cursor position. Display second of the two resulting lines. Control-B or Left move cursor backward one character Control-F or Right move cursor forward one character Control-P or Up go to the previous line. If this is the first line of input then recall previous input from history. Control-N or Down go to the next line. If this is the last line of input then recall the next input from the history Control-A or Home move the cursor to the beginning of the line. If the cursor is already at the beginning of the line, then go to the beginning of the first line of the current input Control-E or End move the cursor to the end of the line. If the cursor is already at the end of the line, then move it to the end of the last line of the current input Control-L or F5 reset terminal and repaint screen

[admin@device] > tool mac-server mac-winbox set allowed-interface-list=none [admin@device] > tool mac-server mac-winbox print allowed-interface-list: none MAC Ping Server MAC Ping Server can be either set to be "disabled" or "enabled": [admin@device] > tool mac-server ping print enabled: yes You can enable or disable MAC ping with the help of the commands ( → to enable the feature; → to disable the feature): enable=yes enable=no [admin@device] > tool mac-server ping set enabled=yes [admin@device] > tool mac-server ping set enabled=no When MAC Ping is enabled, other hosts on the same broadcast domain can use ping tool to ping the mac address. For example, you can issue the following command to check MAC ping results: [admin@device] > /ping 00:0C:42:72:A1:B0 HOST SIZE TTL TIME STATUS 00:0C:42:72:A1:B0 56 0ms 00:0C:42:72:A1:B0 56 0ms sent=2 received=2 packet-loss=0% min-rtt=0ms avg-rtt=0ms max-rtt=0ms

WPS accept : Use this button to grant access to a specific device that supports the WPS connection mode. Useful for printers and other peripherals where typing a password is difficult. First start WPS mode in your client device, then once click the WPS button here to allow said device. Button works for a few seconds and operates on a per-client basis. Guest network : Useful for house guests who don't need to know your main WiFi password. Set a separate password for them in this option. Important! Guest users will not be able to access other devices in your LAN and other guest devices. This mode enabled Bridge filters to prevent this. Wireless clients : This table shows the currently connected client devices (their MAC address, if they are in your Access List, their last used IP address, how long are they connected, their signal level in dBm and in a bar graph). Internet Port: Select which port is connected to the ISP (internet) modem. Usually Eth1. Address Acquisition : Select how the ISP is giving you the IP address. Ask your service provider about this and the other options (IP address, Netmask, Gateway). MAC address : Normally should not be changed, unless your ISP has locked you to a specific MAC address, and you have changed the router to a new one. Firewall router : This enables a secure firewall for your router and your network. Always make sure this box is selected, so that no access is possible to your devices from the internet port. MAC server / MAC Winbox : Allows connection with the [Winbox utility ] from the LAN port side in MAC address mode. Useful https://mt.lv/winbox for debugging and recovery, when IP mode is not available. Advanced use only. Discovery : Allows the device to be identified by model name from other RouterOS devices. Local Network IP address : Mostly can stay at the default 192.168.88.1 unless your router is behind another router. To avoid IP conflict, change to 192.168.89.1 or similar Netmask : In most situations can leave 255.255.255.0 Bridge all LAN ports : Allows your devices to communicate to each other, even if, say, your TV is connected via Ethernet LAN cable, but your PC is connected via WiFi. DHCP server : Normally, you would want automatic IP address configuration in your home network, so leave the DHCP settings ON and on their defaults. NAT: Turn this off ONLY if your ISP has provided a public IP address for both the router and also the local network. If not, leave NAT on. UPnP : This option enables automatic port forwarding ("opening ports to the local network" as some call it) for supported programs and devices, like your NAS disks and peer-to-peer utilities. Use with care, as this option can sometimes expose internal devices to the internet without your knowledge. Enable only if specifically needed. VPN If you want to access your local network (and your router) from the internet, use a secure VPN tunnel. This option gives you a domain name where to connect to, and enables PPTP and L2TP/IPsec (the second one is recommended). The username is 'vpn' and you can specify your own password. All you need to do is enable it here, and then provide the address, username and password in your laptop or phone, and when connected to the VPN, you will have a securely encrypted connection to your home network. Also, useful when travelling - you will be able to browse the internet through a secure line, as if connecting from your home. This also helps to avoid geographical restrictions that are set up in some countries. System Check for updates : Always make sure your device is up-to-date with this button. Checks if an updated RouterOS release is available, and installs it. Password : Sets the password for the device config page itself. Make sure nobody can access your router config page and change the settings. FAQ Q: How is Quickset different from the Webfig tab, where a bunch of new menus appear? A: QuickSet is for new users who only need their device up and running in no time. It provides the most commonly used options in one place. If you need more options, do not use any Quickset settings at all, click on "Webfig" to open the advanced configuration interface. The full functionality is unlocked. Q: Can I use Quickset and Webfig together? While settings that are not conflicting can be configured this way, it is not recommended to mix up these menus. A: If you are going to use Quickset, use only Quickset and vice versa. What is difference between Router and Bridge mode? Bridge mode adds all interfaces to the bridge, allowing to forward Layer2 packets (acts as a hub/switch). In Router mode, packets are forwarded in Layer3 by using IP addresses and IP routes (acts as a router).

Q: In HomeAP mode, should the 2GHz and 5GHz network names be the same, or different? A: If you prefer that all your client devices, like TV, phones, game consoles, would automatically select the best preferred network, set the names identically. If you would like to force a client device to use the faster 5GHz 802.11ac connection, set the names unique. Q: Can I create an AP without security settings - no password or connect to such AP while using QuickSet? A: QuickSet uses WPA2 pre-shared key by default. It means that the minimal password length is 8 symbols and the device can only connect to WPA2 secured AP or serve as AP itself. For configurations with no security settings, you need to configure them manually using WinBox, Webfig, or console. QuickSet interface:

The server also accepts numbers in octal format (begins with 0) and hexadecimal format (begins with 0x). If the numbers are sent in a string format, they are assumed to be in decimal format. Numbers with exponents are not supported. HTTP Methods Below is a table summarising supported HTTP methods HTTP Verv CRUD ROS Description GET Read print To get the records. PATCH Update/Modify set To update a single record. PUT Create add To create a new record. DELETE Delete remove To delete a single record. POST Universal method to get access to all console commands. GET This method allows getting the list of all records or a single record from the specified menu encoded in the URL. For example, get all IP addresses (equivalent to the ' ' command from the CLI): ip/address/print $ curl -k -u admin: https://10.155.101.214/rest/ip/address [{".id":"*1","actual-interface":"ether2","address":"10.0.0.111/24","disabled":"false", "dynamic":"false","interface":"ether2","invalid":"false","network":"10.0.0.0"}, {".id":"*2","actual-interface":"ether3","address":"10.0.0.109/24","disabled":"true", "dynamic":"false","interface":"ether3","invalid":"false","network":"10.0.0.0"}] To return a single record, append the ID at the end of the URL: $ curl -k -u admin: https://10.155.101.214/rest/ip/address/*1 {".id":"*1","actual-interface":"ether2","address":"10.0.0.111/24","disabled":"false", "dynamic":"false","interface":"ether2","invalid":"false","network":"10.0.0.0"} If table contains named parameters, then name instread of ID can be used, for example, get ether1: $ curl -k -u admin: https://10.155.101.214/rest/interface/ether1 It is also possible to filter the output, for example, return only valid addresses that belong to the 10.155.101.0 network: $ curl -k -u admin: "https://10.155.101.214/rest/ip/address?network=10.155.101.0&dynamic=true" [{".id":"*8","actual-interface":"sfp12","address":"10.155.101.214/24","disabled":"false", "dynamic":"true","interface":"sfp12","invalid":"false","network":"10.155.101.0"}] Another example returns only addresses on the "dummy" interface and with the comment "test": $ curl -k -u admin: 'https://10.155.101.214/rest/ip/address?comment=test&interface=dummy' [{".id":"*3","actual-interface":"dummy","address":"192.168.99.2/24","comment":"test", "disabled":"false","dynamic":"false","interface":"dummy","invalid":"false","network":"192.168.99.0"}] If you want to return only specific properties, you can use the ' .proplist ', followed by the '=' and a list of comma-separated properties. For example, to show only the address and if it's disabled: $ curl -k -u admin: https://10.155.101.214/rest/ip/address?.proplist=address,disabled [{"address":"10.0.0.111/24","disabled":"false"},{"address":"10.0.0.109/24","disabled":"true"}]

PATCH This method is used to update a single record. Set PATCH call body as a JSON object which contains fields and values of the properties to be updated. For example, add a comment: $ curl -k -u admin: -X PATCH https://10.155.101.214/rest/ip/address/*3 \ --data '{"comment": "test"}' -H "content-type: application/json" {".id":"*3","actual-interface":"dummy","address":"192.168.99.2/24","comment":"test", "disabled":"false","dynamic":"false","interface":"dummy","invalid":"false","network":"192.168.99.0"} In case of a successful update, the server returns the updated object with all its parameters. PUT A method is used to create new records in the menu encoded in the URL. The body should be set as a JSON object containing parameters applied to the newly created record. In case of success, the server returns the created object with all its parameters. Only one resource can be created in a single request. For example, add an IP address to a dummy interface: $ curl -k -u admin: -X PUT https://10.155.101.214/rest/ip/address \ --data '{"address": "192.168.111.111", "interface": "dummy"}' -H "content-type: application/json" {".id":"*A","actual-interface":"dummy","address":"192.168.111.111/32","disabled":"false", "dynamic":"false","interface":"dummy","invalid":"false","network":"192.168.111.111"} DELETE This method is used to delete the record with a specified ID from the menu encoded in the URL. If the deletion has been succeeded, the server responds with an empty response. For example, call to delete the record twice, on second call router will return 404 error: $ curl -k -u admin: -X DELETE https://10.155.101.214/rest/ip/address/*9 $ curl -k -u admin: -X DELETE https://10.155.101.214/rest/ip/address/*9 {"error":404,"message":"Not Found"} POST All the features are available through the method. The command word is encoded in the header and optional parameters are passed in the API POST JSON object with the corresponding fields and values. For example, to change the password of the active user, send POST https://router/rest/password {"old-password":"old","new-password":"N3w", "confirm-new-password":"N3w"} REST response is structured similar to API response: If the response contains ' ' sentences (records), the JSON reply will contain a list of objects.!re If the '!done ' sentence contains data, the JSON reply will contain an object with the data. If there are no records or data in the ' !done ' sentence, the response will hold an empty list. There are two special keys: and , which are used with the command word. Read more about APIs responses, prop lists, and .proplist .query print queries in the documentation.API Proplist The '. ' key is used to create attribute word. The values can be a single string with comma-separated values: proplist .proplist

POST https://router/rest/interface/print {".proplist":"name,type"} or a list of strings: POST https://router/rest/interface/print {".proplist":["name","type"]} For example, return address and interface properties from the ip/address list: $ curl -k -u admin: -X POST https://10.155.101.214/rest/ip/address/print\ --data '{"_proplist": ["address","interface"]}' -H "content-type: application/json" [{"address":"192.168.99.2/24","interface":"dummy"}, {"address":"172.16.5.1/24","interface":"sfpplus1"}, {"address":"172.16.6.1/24","interface":"sfp2"}, {"address":"172.16.7.1/24","interface":"sfp3"}, {"address":"10.155.101.214/24","interface":"sfp12"}, {"address":"192.168.111.111/32","interface":"dummy"}] Query The ' ' key is used to create a query stack. The value is a list of query words. For example this POST request : .query POST https://router/rest/interface/print {".query":["type=ether","type=vlan","#|!"]} is equivalent to this API sentence /interface/print ?type=ether ?type=vlan ?#|! For example, let's combine ' ' and ' ', to return ' ', ' ', and ' ' properties for all dynamic records and records with the network query proplist .idaddress interface 192.168.111.111 $ curl -k -u admin: -X POST https://10.155.101.214/rest/ip/address/print \ --data '{".proplist": [".id","address","interface"], ".query": ["network=192.168.111.111","dynamic=true"," #|"]}'\ -H "content-type: application/json" [{".id":"*8","address":"10.155.101.214/24","interface":"sfp12"}, {".id":"*A","address":"192.168.111.111/32","interface":"dummy"}] Timeout If the command runs indefinitely, it will timeout and the connection will be closed with an error. The current timeout interval is 60 seconds. To avoid timeout errors, add a parameter that would sufficiently limit the command execution time. For example, let's see what we get when the ping command exceeds the timeout and how to prevent this by adding a count parameter: Timeout is not affected by the parameters passed to the commands. If the command is set to run for an hour, it will terminate early and return an error message.

$ curl -k -u admin: -X POST https://10.155.101.214/rest/ping \ --data '{"address":"10.155.101.1"}' \ -H "content-type: application/json" {"detail":"Session closed","error":400,"message":"Bad Request"} $ curl -k -u admin: -X POST https://10.155.101.214/rest/ping \ --data '{"address":"10.155.101.1","count":"4"}' \ -H "content-type: application/json" [{"avg-rtt":"453us","host":"10.155.101.1","max-rtt":"453us","min-rtt":"453us","packet-loss":"0","received":"1"," sent":"1","seq":"0","size":"56","time":"453us","ttl":"64"}, {"avg-rtt":"417us","host":"10.155.101.1","max-rtt":"453us","min-rtt":"382us","packet-loss":"0","received":"2"," sent":"2","seq":"1","size":"56","time":"382us","ttl":"64"}, {"avg-rtt":"495us","host":"10.155.101.1","max-rtt":"650us","min-rtt":"382us","packet-loss":"0","received":"3"," sent":"3","seq":"2","size":"56","time":"650us","ttl":"64"}, {"avg-rtt":"461us","host":"10.155.101.1","max-rtt":"650us","min-rtt":"359us","packet-loss":"0","received":"4"," sent":"4","seq":"3","size":"56","time":"359us","ttl":"64"}] Another example is a bandwidth test tool, which can be limited by providing run duration: $ curl -k -u admin: -X POST 'https://10.155.101.214/rest/tool/bandwidth-test' \ --data '{"address":"10.155.101.1","duration":"2s"}' \ -H "content-type: application/json" [{".section":"0","connection-count":"20","direction":"receive","lost-packets":"0", "random-data":"false","rx-10-second-average":"0","rx-current":"0","rx-size":"1500", "rx-total-average":"0", "status":"connecting"}, {".section":"1","connection-count":"20","direction":"receive","duration":"1s", "lost-packets":"0","random-data":"false","rx-10-second-average":"0","rx-current":"0", "rx-size":"1500","rx-total-average":"0", "status":"running"}, {".section":"2","connection-count":"20","direction":"receive","duration":"2s", "lost-packets":"581175","random-data":"false","rx-10-second-average":"854372352", "rx-current":"854372352","rx-size":"1500","rx-total-average":"854372352", "status":"running"}, {".section":"3","connection-count":"20","direction":"receive","duration":"3s", "lost-packets":"9014","random-data":"false","rx-10-second-average":"891979008", "rx-current":"929585664","rx-size":"1500","rx-total-average":"891979008", "status":"done testing"}] Errors The success or failure of the API calls is indicated in the HTTP status code. In case of failure (status code 400 or larger), the body of the response contains a JSON object with the error code, a description of the error, and optional error details. For example, trying to delete an interface will return {"error":406,"message":"Not Acceptable","detail":"no such command or directory (remove)"}

In order to establish the RoMON session directly by using the command line on a computer, you must specify RoMON agents and desired routers addresses. RoMON agent must be saved on Managed routers list in WinBox in order to make a successful connection: winbox.exe --romon 192.168.88.1 6C:3B:6B:48:0E:8B admin "" Connect to RoMON through WinBox GUI Watch a video here.

The problem with the first cable is when connected to a device on which hardware flow control is enabled software may hang when checking modem signal lines. Null modem cable with loop back handshake fixes the problem, its main purpose is to fool well-defined software into thinking there is handshaking available: Side1 (DB9f) Side2 (DB9f) Function 2 3 Rx ← Tx 3 2 Tx → Rx 5 5 GND 1+4+6 - DTR → CD + DSR - 1+4+6 DTR → CD + DSR 7+8 - RTS → CTS - 7+8 RTS → CTS Hardware flow control is not possible with this cable. Also if remote software does not send its own ready signal to DTR output communication will hang. Null Modem With Partial Handshake This cable can be used when flow control enabled without being incompatible with the original way flow control was used with DTE/DCE communication. This type of cable is not recommended for use with RouterOS. Side1 (DB9f) Side2 (DB9f) Function 1 7+8 RTS2 → CTS2 + CD1 2 3 Rx ← Tx 3 2 Tx → Rx 4 6 DTR → DSR 5 5 GND 6 4 DSR ← DTR 7+8 1 RTS1 → CTS1 + CD2 Null Modem With Full Handshake Used with special software and should not be used with RouterOS. Side1 (DB9f) Side2 (DB9f) Function 2 3 Rx ← Tx 3 2 Tx → Rx 4 6 DTR → DSR 5 5 GND 6 4 DSR ← DTR 7 8 RTS → CTS 8 7 CTS ← RTS

Null Modem Compatibility Summary tables below will allow you to choose the proper cable for your application. No handshake Loopback handshakePartial handshakeFull handshake RouterBoards with limited port functionalityY Y N* N RouterBoards with full functionalityY Y Y N * - may work only when hardware flow control is disabled No handshake Loopback handshakePartial handshakeFull handshake Software flow control onlyY Y* Y** Y** Low-speed DTE/DCE compatible hardware flow controlN Y Y* N High-speed DTE/DCE compatible hardware flow controlN Y Y** N High speed communication using special softwareN N Y* Y * - will work as an alternative ** - will work but not recommended RJ45 Type Serial Port This type of port is used on RouterBOARD 2011, 3011, 4011, CCR1072, CCR1036 r2, CCR2xxx and CRS series devices, sometimes called "Cisco style" serial port. RJ45 to DB9 Cable Pinout:

Signal Console Port (DTE) RJ-45RJ-45 Rolled Cable RJ-45 PinAdapter DB-9 Pin Adapter DB-25 Pin Signal RTS 1 8 8 5 CTS DTR 2 7 6 6 DSR TxD 3 6 2 3 RxD Ground 4 5 5 7 Ground Ground 5 4 5 7 Ground RxD 6 3 3 2 TxD DSR 7 2 4 20 DTR CTS 8 1 7 4 RTS RB M33G Additional Serial Header For RBM33G additional serial header can be attached on GPIO pins U3_RXD, GND, U3_TXD, and 3V3 CCR Serial Header The Cloud Core Router series devices have a serial header on the PCB board, called J402 or 100 Here is the pin-out of that connector: Serial Terminal Usage RouterOS allows to communicate with devices and other systems that are connected to the router via the serial port using a /system serial- command. All keyboard input will be forwarded to the serial port and all data from the port is output to the connected device. terminal First, you have to have a free serial port, if the device has only one serial port (like all RouterBoards, WRAP/ALIX boards, etc.) you will have to disable the system console on this serial port to be able to use it as for connection to other equipment (switches, modems, etc): Serial Terminal /system console disable 0 Be sure to just disable the console rather than removing it, as RouterOS will recreate the console after the next reboot when you really remove it.

Next, you will have to configure your serial port according to the serial port settings of the connected device. Using the following command you will set your serial port to 19200 Baud 8N1. What settings you need to use depends on the device you connect: /port set serial0 baud-rate=19200 data-bits=8 parity=none stop-bits=1 You can also try to let RouterOS guess the needed baud rate by setting /port set serial0 baud-rate=auto Now's the time to connect your device if not already done. Usually, you will have to use a (the same thing as a cross-over-cable for null modem cable Ethernet). Now we're ready to go: /system serial-terminal serial0 This will give you access to the device you connected to port Serial0. is the prefix key, which means that you will enter a small "menu". If you need to Ctrl-A send the character to a remote device, press twice. Ctrl-A Ctrl-A If you want to exit the connection to the serial device type , then . This will return you to your RouterOS console. Ctrl-A Q Special Login Special login can be used to access another device (like a switch, for example) that is connected through a serial cable by opening a telnet/ssh session that will get you directly on this device (without having to login to RouterOS first). For demonstration we will use two RouterBoards and one PC. Note that there are some caveats you should be aware of! Take your time understanding those limits to avoid strange things to happen when connecting a device to a serial port on a RouterBoard: By re-configuring port Serial0 on a RouterBoard as seen above, you will lose your serial console access to RouterOS. This means, that if you cannot access your RouterBoard over the network anymore, you might even have to reset the whole configuration of it to gain access again. When rebooting a RouterBoard the boot loader (RouterBOOT) will always use the serial console (Serial0 on RouterBoards) to send out some startup messages and offer access to the RouterBOOT menu. Having text coming out of the serial port to the connected device might confuse your attached device. Furthermore, in the standard config, you can enter the RouterBOOT menu by pressing key. So if your serial device sends any character to the serial port of ANY your RouterBoard during boot time, the RouterBoard will enter the RouterBOOT menu and will boot RouterOS unless you NOT manually intervene! You can reconfigure RouterBOOT to enter the RouterBOOT menu only when a character is received - use this to reduce the DEL chance to get a router that's stuck when rebooting! Or if newer versions are used feature can be used to suppress any output on the serial interface, including removal of "Silent boot" booting sounds. Do not connect to devices at an incorrect speed and avoid dumping binary data.

enter bootloader menu press 'k' for boot key options press '2' to change key to <delete> What do you want to configure? d - boot delay k - boot key s - serial console n - silent boot o - boot device u - cpu mode f - cpu frequency r - reset booter configuration e - format nand g - upgrade firmware i - board info p - boot protocol b - booter options t - call debug code l - erase license x - exit setup your choice: k - boot key Select key which will enter setup on boot: * 1 - any key 2 - <Delete> key only your choice: 2

SSH SSH Server Properties Enabling PKI authentication SSH Client Simple log-in to remote host Log-in from certain IP address of the router Log-in using RSA public/private key Executing remote commands SSH exec Retrieve information SSH Server RouterOS has built in SSH (SSH v2) server that is enabled by default and is listening for incoming connections on port TCP/22. It is possible to change the port and disable the server under menu. Services Properties Sub-menu: /ip ssh Property Description allow-none-crypto ( ; Default: ) yes|no no Whether to allow connection if cryptographic algorithms are set to none. always-allow-password-login ( ; Default: ) yes | no no Whether to allow password login at the same time when public key authorization is configured for a user. forwarding-enabled ( ; both | local | no | remote Default: )noAllows to control which SSH forwarding method to allow: no - SSH forwarding is disabled; local - Allow SSH clients to originate connections from the server(router), this setting controls also dynamic forwarding; remote - Allow SSH clients to listen on the server(router) and forward incoming connections; both - Allow both local and remote forwarding methods. host-key-size ( ; 1024 | 1536 | 2048 | 4096 | 8192 Default: ) 2048RSA key size when host key is being regenerated. host-key-type ( | ; Default: ) ed25519 rsa rsa Select host key type strong-crypto ( ; Default: ) yes | no no Use stronger encryption, HMAC algorithms, use bigger DH primes and disallow weaker ones: use 256 and 192 bit encryption instead of 128 bits; disable null encryption; use sha256 for hashing instead of sha1; disable md5; use 2048bit prime for Diffie-Hellman exchange instead of 1024bit. Commands Property Description

export-host-key (key-file- ) prefixExport public and private RSA/Ed25519 to files. Command takes two parameters: key-file-prefix - used prefix for generated files, for example, prefix 'my' will generate files 'my_rsa', 'my_rsa.pub' etc. passphrase - private key passphrase import-host-key (private- ) key-fileImport and replace private RSA/Ed25519 key from specified file. Command takes two parameters: private-key-file - name of the private RSA/Ed25519 key file passphrase - private key passphrase regenerate-host-key () Generated new and replace current set of private keys (RSA/Ed25519) on the router. Be aware that previously imported keys might stop working. Enabling PKI authentication Example of importing public key for user admin Generate SSH keys on the client device (the device you will connect from). Upload the public SSH key to the router and import it. /user ssh-keys import public-key-file=id_rsa.pub user=admin SSH Client Sub-menu: /system ssh Simple log-in to remote host It is able to connect to remote host and initiate ssh session. IP address supports both IPv4 and IPv6. /system ssh 192.168.88.1 /system ssh 2001:db8:add:1337::beef In this case user name provided to remote host is one that has logged into the router. If other value is required, then has to be used. user=<username> /system ssh 192.168.88.1 user=lala /system ssh 2001:db8:add:1337::beef user=lala Log-in from certain IP address of the router For testing or security reasons it may be required to log in to other host using certain source address of the connection. In this case src-address=<ip argument has to be used. Note that IP address in this case supports both, IPv4 and IPv6. address> /system ssh 192.168.88.1 src-address=192.168.89.2 /system ssh 2001:db8:add:1337::beef src-address=2001:db8:bad:1000::2 Host keys are exported in PKCS#8 format. Private key is supported in PEM or PKCS#8 format. Exporting the SSH host key requires "sensitive" user policy.

exit-code : returns 0 if the command execution succeeded output : returns the output of remotely executed command Example: Code below will retrieve interface status of ether1 from device 10.10.10.1 and output the result to "Log" :local Status ([/system ssh-exec address=10.10.10.1 user=remote command=":put ([/interface ethernet monitor [find where name=ether1] once as-value]->\"status\")" as-value]->"output") :log info $Status Watch how to . execute commands through SSH For security reasons you should not use plain text password with parameter "password" specified in the command line. To ensure safe execution of the command remotely, it is strongly recommended to use SSH PKI authentication for users on both sides. The user group and script policy executing the command requires permissiontest

TR-069 Configuration Settings Writable Settings Read-only Settings Commands CWMP Session Parameters and Data Models Download RPC RouterOS Update (1 Firmware Upgrade Image) Configuration Change (3 Vendor Configuration File) Alter configuration Overwrite all configurations RouterOS default configuration change (X MIKROTIK Factory Configuration File) FactoryReset RPC Upload RPC Upload current configuration (1 Vendor Configuration File) Upload log file (2 Vendor Log File) Upload default configuration (X MIKROTIK Factory Configuration File) Security Tested ACSs Commercial Open Source TR069-client implements CPE WAN Management Protocol (CWMP) for remote device management, which is standardized by the Broadband Forum (BBF). CWMP works over IP network using HTTP(S) to communicate with an Auto Configuration Server (ACS), which can monitor, configure attributes and update the firmware of a remote device. Typically used by ISPs to manage CPEs, but also can be used for Network Infrastructure Device management. Requires tr069-client package. Configuration Settings Sub-menu: /tr069-client TR069-client menu parameters: Writable Settings Client configuration settings. Property Description enabled enable/disable CWMP protocol acs-url URL of ACS. Examples: " ", " " https://example.com:8080/path/ https://192.168.1.100/ If ACS is accessed using HTTPS, in a client must be imported Root CA to verify ACS server certificate. username HTTP authentication username (used by CPE to "login" into ACS) password HTTP authentication password (used by CPE to "login" into ACS) periodic- inform- enabledenable/disable CPE periodical session initiation. Timer is started after every successful session. When session is started by periodic interval then Inform RPC contains "2 PERIODIC" event. Maps to "Device.ManagementServer.PeriodicInformEnable" Parameter periodic- inform- intervaltimer interval of periodic inform. Maps to "Device.ManagementServer.PeriodicInformInterval" client- certificatecertificate of client/CPE, which can be used by ACS for extra authentication Read-only Settings

WebFig Introduction Connecting to a Router Enable HTTPS The "Terminal" Skins Designing skins Skin design examples Using skins Introduction WebFig is a web-based RouterOS utility that allows you to monitor, configure and troubleshoot the router. It is designed as an alternative of WinBox, both have similar layouts and both have access to almost any feature of RouterOS. As Webfig is platform-independent, it can be used to configure a router directly from various devices without the need for software developed for specific platforms. In other words, there is no need to install additional software. WebFig allows performing three basic actions: Configuration - view and edit current configuration; Monitoring - display the current status of the router, routing information, interface stats, logs, etc.; Troubleshooting - RouterOS has built-in many troubleshooting tools (like ping, traceroute, packet sniffers, traffic generators, etc.) and all of them can be used with WebFig Connecting to a Router As we already know from the section, the device by default configured. Simply open a First Time Configuration has username admin and no password Web browser and in the search bar type device IP address which by default is Be sure your device has IP address from the same network, 192.168.88.1. for example, 192.168.88.2 otherwise Layer3 communication will not work.

WebFig is a handy tool to make the interface more user-friendly. It is not a security tool. If the user has sufficient rights it is possible to access Design Skin hidden features by other means. Designing skins If the user has sufficient permissions (the group has the policy "policy" and "sensitive" to edit permissions) Design Skin button becomes available. Pressing that toggle button will open interface editing options. To prevent the user from accessing the menu, disable policy "policy" and "sensitive" under the user group configuration. Design Skin Possible operations are: Hide menu - this will hide all items from the menu and its submenus; Hide submenu - only certain submenu will be hidden; Hide tabs - if submenu details have several tabs, it is possible to hide them this way; Rename menus and items - make certain features more obvious or translate them into your language; Add a note to the item (in detail view) - to add comments on the field; Make item read-only (in detail view) - for user safety very sensitive fields can be made read only; Hide flags (in detail view) - while it is only possible to hide a flag in detail view, this flag will not be visible in list view and in detailed view; Add limits for the field - (in detail view) where it is the list of times that are comma or newline separated list of allowed values: number interval '..' example: 1..10 will allow values from 1 to 10 for fields with numbers, for example, MTU size. field prefix (Text fields, MAC address, set fields, combo-boxes). If it is required to limit prefix length should be added to the end. For $ example, limiting the wireless interface to "station" only, "Add limit" will contain "station$" Add - will add a gray ribbon with an editable label that will separate the fields. Ribbon will be added before the field it is added to; Tab Add - will add a low height horizontal separator before the field it is added to. Separator Skin design examples If you need to limit the user for some services Note: Number interval cannot be set to extend limitations set by RouterOS for that field Note: Set fields are arguments that consist of a set of check-boxes, for example, setting up policies for user groups, RADIUS "Service" Note: Limitations set for combo-boxes will also limit the values selectable from the dropdown

Add a limit to the RADIUS Service. The result will be only those services, that are pointed in the "Limit" field.

Using skins To use skins you have to assign the skin to the group. When that is done, users of that group will automatically use the selected skin as their default when logging into WebFig or WinBox. /user/group/set your_group_name skin=your_skin If it is required to use created skin on another router you can copy files to the skins folder on the other router. On the new router, it is required to add copied skin to the user group to use it.

To connect to the router enter the IP or MAC address of the router, specify username and password (if any) and click on the button. You can also Connect enter the port number after the IP address, separating them with a colon, like this 192.168.88.1:9999. The port can be changed in the RouterOS services menu. You can also use neighbor discovery, to list available routers use the Neighbors tab: From the list of discovered routers, you can click on the IP or MAC address column to connect to that router. If you click on IP address then IP will be used to connect, but if you click on MAC Address then the MAC address will be used to connect to the router. It is recommended to use an IP address whenever possible. MAC session uses network broadcasts and is not 100% reliable. Neighbor discovery will show also devices that are not compatible with WinBox, like Cisco routers or any other device that uses CDP (Cisco Discovery Protocol). If you will try to connect to a SwOS device, then the connection will be established through a web browser

Buttons/check-boxes and Other Fields Connect - Connect to the router Connect To RoMON - Connect to Agent RoMON Add/set - Save/Edit any of the saved router entries in the tab. Managed Open In New Window - Leaves loader open in the background and opens new windows for each device to which connection is made. Connect To: - destination IP or MAC address of the router Login - username used for authentication Password - password used for authentication Keep Password - if unchecked, the password is not saved to the list Menu Items File New - Create a new managed router list in a specified location Open - Open managed router list file Save As - Save current managed router list to file Exit - Exit WinBox loader Tools Advanced Mode - Enables/Disables advanced mode view Import - Imports saved session file Export - Exports saved session file Move Session Folder - Change path where session files are stored Clear cache - Clear WinBox cache Check For Updates - Check for updates for WinBox loader Advanced mode Additional WinBox loader parameters are revealed when an is enabled with advanced mode Tools → Advanced Mode: Buttons/check-boxes and Other Fields

Safe Mode Currently loaded session More about Safe mode and undoing performed actions read . in this article On the right side is located: an indicator that shows whether the WinBox session uses encryption WinBox traffic indicator displayed as a green bar, Custom info fields that can be added by the user by right-clicking on the toolbar and picking available info fields from the list Work Area and Child Windows WinBox has an MDI interface meaning that all menu configuration (child) widows are attached to the main (parent) WinBox window and is showed in the work area. Child windows can not be dragged out of the working area. Notice in the screenshot above that the window is dragged out of the visible working Interface area and a horizontal scroll bar appeared at the bottom. If any window is outside visible work area boundaries the vertical or/and horizontal scrollbars will appear. Child window menu bar Each child window has its own toolbar. Most of the windows have the same set of toolbar buttons: - add a new item to the listAdd

- remove the selected item from the list Remove - enable selected item (the same as command from console) Enable enable - disable selected item (the same as command from console) Disable disable - add or edit a comment Comment - allows to sort out items depending on various parameters. Sort Read more >> Almost all windows have a quick search input field on the right side of the toolbar. Any text entered in this field is searched through all the items and highlighted as illustrated in the screenshot below Notice that on the right side next to the quick find input filed there is a drop-down box. For the currently opened (IP Route) window, this drop-down box allows to quickly sort out items by routing tables. For example, if the is selected, then only routes from the main routing table will be listed. main A similar drop-down box is also in all firewall windows to quickly sort out rules by chains. Sorting out displayed items Almost every window has a button. When clicking on this button several options appear as illustrated in the screenshot belowSort

1. 2. 3. 4. 5. 6. The example shows how to quickly filter out routes that are in the 10.0.0.0/8 range Press buttonSort Choose from the first drop-down box. Dst.Address Choose form the second drop-down box. "in" means that filter will check if DST address value is in range of the specified network.in Enter the network against which values will be compared (in our example enter "10.0.0.0/8") These buttons are to add or remove another filter to the stack. Press the button to apply our filter. Filter As you can see from the screenshot WinBox sorted out only routes that are within the 10.0.0.0/8 range. Comparison operators (Number in the screenshot) may be different for each window. For example "IP Route" window has only two and . Other 3 is in windows may have operators such as "is not", "contains", "contains not". WinBox allows building a stack of filters. For example, if there is a need to filter by destination address and gateway, then set the first filter as described in the example above, press button to add another filter bar in the stack.[+] set up a second filter to filter by the gateway press the button to apply filters. Filter You can also remove unnecessary filters from the stack by pressing the button.[-] Customizing list of displayed columns By default, WinBox shows the most commonly used parameters. However sometimes it is needed to see other parameters, for example, "BGP AS Path" or other BGP attributes to monitor if routes are selected properly. WinBox allows to customize displayed columns for each individual window. For example to add BGP AS path column: Click on the little arrow button ( ) on the right side of the column titles or right mouse click on the route list.1 From popped up menu move to () and from the sub-menu pick the desired column, in our case click on () Show Columns 2 BGP AS Path 3

Changes made to window layout are saved and next time when WinBox is opened the same column order and size are applied. Detail mode It is also possible to enable . In this mode all parameters are displayed in columns, the first column is the parameter name, the second column Detail mode is the parameter's value. To enable detail mode right mouse click on the item list and from the popup menu pick Detail mode

Category view It is possible to list items by categories. In this mode, all items will be grouped alphabetically or by another category. For example, items may be categorized alphabetically if sorted by name, items can also be categorized by type like in the screenshot below. To enable Category view, right mouse click on the item list and from the popup menu pick Show Categories Drag & Drop It is possible to upload and download files to/from the router using WinBox drag & drop functionality. You can also download the file by pressing the right mouse button on it and selecting "Download". Traffic monitoring WinBox can be used as a tool to monitor the traffic of every interface, queue, or firewall rule in real-time. The screenshot below shows Ethernet traffic monitoring graphs. Drag & Drop works if WinBox is running on Linux using wine4. Drag and drop between two WinBox windows may fail.

Item copy This shows how easy it is to copy an item in WinBox. In this example, we will use the COPY button to make a Dynamic PPPoE server interface into a Static interface. This image shows us the initial state, as you see DR indicates "D" which means Dynamic:

Double-Click on the interface and click on COPY: A new interface window will appear, a new name will be created automatically (in this case pppoe-in1)

After this Down/Up event this interface will be Static:

Transferring Settings Managed router transfer - In the File menu, use Save As and Open functions to save the managed router list to file and open it up again on a new workstation. Router sessions transfer - In the Tools menu, use Export and Import functions to save existing sessions to file and import them again on a new workstation. WinBox Keyboard Shortcuts Shortcut Description Ctrl + F Find Ctrl + G Find Next F3 Find / Find next Ctrl + M Add or edit a comment Ctrl + or E Num+ Enables a selected setting Ctrl + or D Num- Disables a selected setting Ctrl + + Zoom in WinBox Ctrl + - Zoom out WinBox Tab Choose next control

Tab + Shift Choose previous control Space Select focused control F4 or Esc Close window F6 Focus previous window F6 + Shift Focus next window Insert Add new entry into list Delete Delete entry from list Troubleshooting WinBox cannot connect to the router's IP address, devices do not show up in the Neighbors list Make sure that the Windows firewall is set to allow WinBox connections through Private and/or Public network interfaces in the Windows firewall, it can be changed in or disable the Windows firewall. Control Panel\System and Security\Windows Defender Firewall\Allowed applications I get an error '(port 20561) timed out' when connecting to routers mac address Windows (7/8) does not allow mac connection if file and print sharing is disabled. I can't find my device in WinBox IPv4 Neighbors list or MAC connection fails with "ERROR could not connect to XX-XX-XX-XX- XX-XX" Most of the network drivers will not enable IP stack unless your host device has an IP configuration. Set IPv4 configuration on your host device. Sometimes the device will be discovered due to caching, but MAC connection will still fail with "ERROR: could not connect to XX:XX:XX:XX:XX:XX WinBox MAC-ADDRESS connection requires MTU value set to 1500, unfragmented. Other values can perform poorly - loss of connectivity can occur.

Activate FlashFig server, now it is ready to FlashFig. Note, any RouterBOARD will be FlashFig'ed within the network when they are powered on with boot-device configured to or , flash-boot flash-boot-once-then-nand RouterBOARD FlashFig mode is enabled on every RouterBOARD from the factory by default, which means is required on RouterBOARD. no configuration If FlashFig is not enabled on your router, access the RouterBOARD with WinBox/Console and change the to or boot-device flash-boot flash-boot- : once-then-nand system/routerboard/settings/set boot-device=flash-boot Or use a more preferable option, for a single boot flash-boot: system/routerboard/settings/set boot-device=flash-boot-once-then-nand Your router is now ready for FlashFig. Connect Connect the port of RouterBOARD and FlashFig computer to the same Local Area Network.Boot Run FlashFig Plug-in power for RouterBOARD

Check the status on FlashFig program, Messages log shows "FlashFigged" and RouterBOARD should repeatedly make the morse code sound for the character "/" ("_.._." and flash the LED - it is now safe to unplug / power down the router. FlashFig was applied to the RouterBOARD and it is to be used in production with this new config. configuration ready Troubleshoot FlashFig can not find a router If between a PC and a router there is another device (a router/switch), ensure that for this device: DHCP server is disabled; if used ports are in a bridge, set bridge to ; protocol-mode none HW-offload for used ports is disabled. FlashFig finds a router, flashing is not done ( no TFTP request) Ensure that the computer on which FlashFig is running has only one network interface active. FlashFig is done, but a configuration is not applied If all procedures went successfully, but RouterOS configuration from .rsc file is not applied, add to *.rsc configuration file. The reason might startup delay be, that the configuration script is executed before all interfaces boots up. Not enough flash space, ignoring FlashFig configuration maximum file size is up to 4000 bytes, otherwise program will return an error as above.

Authentication, Authorization, Accounting In This Section:

Certificates Overview Overview Certificate Template Certificate properties Certificate read-only properties Sign Certificate Export Certificate Import Certificate Settings Let's Encrypt certificates Different acme servers Server properties Example: SCEP /certificate The general menu is used to manage certificates, add templates, issue certificates, and manage CRL and SCEP Clients. Certificate Template Certificate templates are used to prepare a desired certificate for signing. Certificate template is deleted right after a certificate is signed or a certificate request command is executed /certificate add name=CA-Template common-name=CAtemp key-usage=key-cert-sign,crl-sign add name=Server common-name=server add name=Client common-name=client To print out certificates: [admin@4k11] /certificate> print detail Flags: K - private-key; L - crl; C - smart-card-key; A - authority; I - issued, R - revoked; E - expired; T - trusted 0 name="CA-Template" key-type=rsa common-name="CAtemp" key-size=2048 subject-alt-name="" days- valid=365 key-usage=key-cert-sign,crl-sign 1 name="Server" key-type=rsa common-name="server" key-size=2048 subject-alt-name="" days-valid=365 key-usage=digital-signature,key-encipherment,data-encipherment,key-cert-sign,crl-sign,tls-server,tls- client 2 name="Client" key-type=rsa common-name="client" key-size=2048 subject-alt-name="" days-valid=365 key-usage=digital-signature,key-encipherment,data-encipherment,key-cert-sign,crl-sign,tls-server,tls- client Certificate properties Property Description common-name ( ) string Certificate common name

copy-from ( ) name Certificate name from which to copy general settings country ( ) string Certificate issuer country (days Default: 365) days-valid Days certificate will be valid after signing digest-algorithm (md5 | sha1 | sha256 | sha384 | sha512 Default: sha256 ) Certificate public key algorithm key-size (1024 | 1536 | 2048 | 4096 | 8192 | prime256v1 | secp384r1 | secp521r1 Default: 2048 ) Certificate public key size key-usage (code-sign | crl-sign | decipher-only | dvcs | encipher-only key-cert-sign | ocsp-sign | tls-client | content-commitment | data-encipherment | digital-signature | email-protect | key-agreement | key-encipherment | timestamp | tls-server Default: digital- signature,key-encipherment,data-encipherment,key-cert-sign,crl-sign,tls-server,tls-client )Certificate usage ( ) locality string Certificate issuer locality name ( ) string Certificate name organization ( ) string Certificate issuer organization state ( ) string Certificate issuer state subject-alt-name (DNS: | IP: | email: ) Certificate subject alternative name trusted (no| yes Default: ) unit ( ) string Certificate issuer organizational unit Certificate read-only properties After a certificate is signed, most of a certificate template properties are converted to read-only (except and ) name trusted Property Description serial-number Certificate serial number fingerprint akid Certificate authority ID skid Certificate subject ID invalid-before Date and time before which a certificate expired invalid-after Date and time after which a certificate expired expires-after key-type ca Certificate authority common name If the CA certificate is removed, all issued certificates in the chain are also removed.

crl-store ( Default ram | sytem : ram)Where to store downloaded CRL information CRL will be automatically renewed every hour for certificates which have "trusted=yes" using http protocol (ldap and ftp is currently unsupported) crl-use ( Default: no) yes | no Whether to use CRL An on importing a root certificate. example Let's Encrypt certificates RouterOS v7 has Let's Encrypt (letsencrypt) certificate support for the 'www-ssl' service. To enable the Let's Encrypt certificate service with automatic certificate renewal, use the 'enable-ssl-certificate' command: /certificate enable-ssl-certificate dns-name=my.domain.com Note that the DNS name must point to the router and port TCP/80 must be available from the WAN. If the dns-name is not specified, it will default to the automatically generated / name (ie. ) ip cloud http://example.sn.mynetname.net Different acme servers Support has been added starting from 7.15beta7, you can use not only Let's Encrypt certificate service, but any other you like. Server properties Property Description directory-url ( ) string ACME directory url. eab-hmac-key ( ) string HMAC key for ACME External Account Binding (optional). eab-kid ( ) string Key identifier (optional). Example: /certificate/enable-ssl-certificate directory-url=https://acme.zerossl.com/v2/DV90 dns-name=mydomain.abc eab- hmac-key=4ac7xuxAdV4mIncwIIEhLjExsFZ4v1rWgDkX4SKXD25pMVtF85GZJYSF8UKXUOjzSr2g3-v4lhL57NHFaQ42Ff eab- kid=GHWaP2_Ghx73vcU8ricAKU Watch a on Let's encrypt setup. video SCEP SCEP is using HTTP protocol and base64 encoded GET requests. Most of the requests are without authentication and cipher, however, important ones can be protected if necessary (ciphered or signed using a received public key). SCEP client in RouterOS will: get CA certificate from CA server or RA (if used); user should compare the fingerprint of the CA certificate or if it comes from the right server; generate a self-signed certificate with a temporary key; send a certificate request to the server; if the server responds with status x, then the client keeps requesting until the server sends an error or approval. The SCEP server supports the issuance of one certificate only. RouterOS supports also renew and next-ca options: renew - the possibility to renew the old certificate automatically with the same CA. next-ca - possibility to change the current CA certificate to the new one.

The client polls the server for any changes, if the server advertises that the next-ca is available, then the client may request the next CA or wait until CA almost expires and then request the next-ca. The RouterOS client by default will try to use POST, AES, and SHA256 if the server advertises that. If the above algorithms are not supported, then the client will try to use 3DES, DES and SHA1, MD5. SCEP certificates are renewed when 3/4 of their validity time has passed.

Dot1X Summary Client Server Examples RouterOS Authenticator configuration Port based VLAN ID assignment Dynamic switch rule configuration RouterOS Supplicant configuration Summary Dot1X is implementation of IEEE 802.1X standard in RouterOS. Main purpose is to provide port-based network access control using EAP over LAN also known as EAPOL. 802.1X consists of a supplicant (client), an authenticator (server) and an authentication server (RADIUS server). Both authenticator and supplicant sides are supported in RouterOS, as well as authentication server when package is installed. Supported User Manager EAP methods for supplicant are EAP-TLS, EAP-TTLS, EAP-MSCHAPv2 and PEAPv0/EAP-MSCHAPv2. Client Supplicant configuration settings. Sub-menu: /interface dot1x client Property Description anon-identity ( ; Default: ) string Identity for outer layer EAP authentication. Used only with and methods. If not eap-ttls eap-peap set, value from parameter will be used for outer layer EAP authentication. identity client-certificate ( ; Default: ) string Name of a certificate listed in . Necessary when method is used. System/Certificates eap-tls comment ( ; Default: ) string Short description of the entry. disabled ( ; Default: ) yes | no no Whether client is enabled or not. eap-methods (eap-tls | eap-ttls | eap- ; Default: ) peap | eap-mschapv2Ordered list of EAP methods used for authentication. identity ( ; Default: ) string Supplicant identity used for EAP authentication. interface ( ; Default: ) string Name of the interface the client will run on. password ( ; Default: ) string Cleartext password for supplicant. Read only properties Property Description Feature is not supported on SMIPS devices (hAP lite, hAP lite TC and hAP mini).

status (authenticated | authenticating | ) disabledPossible statuses: authenticated - the client has successfully authenticated; authenticated without server - access to the port is granted without communication with server; authenticating - the server is reached and authentication process is ongoing; connecting - initial stage of the authentication process; disabled - the client is disabled; error - an internal error has occurred; interface is down - the parent interface is not running; rejected - the server denied the authentication. Server A RouterOS dot1x server acts as an authenticator. An interface where dot1x server is enabled will block all traffic except for EAPOL packets which is used for the authentication. After client is successfully authenticated, the interface will accept all received traffic on the port. If the interface is connected to a shared medium with multiple hosts, the traffic will be accepted from all hosts when at least one client is successfully authenticated. However, it is possible to to accept only the authenticated user source MAC address and drop all other source MAC configure dynamic switch rules addresses. In case of failed authentication, it is possible to accept the traffic with a dedicated port VLAN ID. Sub-menu: /interface dot1x server Property Description accounting ( ; Default: ) yes | no yes Whether to send RADIUS accounting requests to authentication server. auth-timeout ( ; Default: ) time 1m Total time available for EAP authentication. auth-types ( ; Default: dot1x | mac-auth ) dot1xUsed authentication type on a server interface. When both options are selected at the same time, the server will prefer authentication type and only after 3 periods, the dot1x retrans-timeout authentication type will fall back to In order for authentication type to work, the . mac-auth mac-auth server interface should receive at least one frame containing a client's device source MAC address. comment ( ; Default: ) string Short description of the entry. disabled ( ; Default: ) yes | no no Whether server config is enabled or not. guest-vlan-id (i ; nteger: 1..4094 Default: ) !guest-vlan-idAssigned VLAN when end devices does not support authentication and no fall back is dot1x mac-auth configured. The setting will apply after 3 periods. Once dot1x enabled client is retrans-timeout created and successful re-authentication happened, the port is removed from the guest VLAN. This setting is available since RouterOS 7.2 version and has an effect when bridge is vlan-filtering enabled. By default, guest VLAN is disabled. interface ( ; Default: ) string Name of the interface or interface list the server will run on. interim-update ( ; Default: ) time 0s Interval between scheduled RADIUS Interim-Update messages. mac-auth-mode (mac-as-username | ; mac-as-username-and-password Default: ) mac-as-usernameAllows to control User-Name and User-Password RADIUS attributes when using MAC authentication. radius-mac-format (XX-XX-XX-XX-XX- XX | XX:XX:XX:XX:XX:XX | XXXXXXXXXXXX | xx-xx-xx-xx-xx-xx ; | xx:xx:xx:xx:xx:xx | xxxxxxxxxxxx Default: ) XX:XX:XX:XX:XX:XXControls how the MAC address of the client is encoded in the User-Name and User-Password attributes when using MAC authentication. When a dot1x server is created on a bridge port, the bridge should be running (R/M)STP, otherwise EAP packets from the client will not be correctly accepted. Bridge interface is created with by default. If the bridge port should not send any BPDUs or any =rstp protocol-mode received BPDUs should be ignored, use configuration on bridge ports. =yesedge

reauth-timeout ( ; Default: time !reauth- ) timeoutEnables server port re-authentication. When enabled with authentication type, server will try to re-dot1x authenticate a client by sending EAP-Request Identity to the client. When enabled with mac-auth authentication type, server will try to re-authenticate client with RADIUS server by using the last seen MAC address. This setting is available since RouterOS 7.2 version. By default, re-authentication is disabled. reject-vlan-id (i ; nteger: 1..4094 Default: ) !reject-vlan-idAssigned VLAN when authentication failed and a RADIUS server responded with an Access-Reject message. This property will not apply if the RADIUS server is not responding at all, the client authentication will simply timeout and the service will be unavailable. This property only has an effect when bridge is enabled. By default, reject VLAN is disabled. vlan-filtering retrans-timeout ( ; Default: ) time 30s Time interval between message re-transmissions if no response is received from supplicant. server-fail-vlan-id (i ; nteger: 1..4094 Default: ) !server-fail-vlan-idAssigned VLAN when RADIUS server is not responding and request timeout has elapsed. This setting is available since RouterOS 7.2 version and has an effect when bridge is enabled. By vlan-filtering default, server-fail VLAN is disabled. Currently authenticated clients are listed in the active menu (read only properties). Sub-menu: /interface dot1x server active Property Description auth-info ( ) string Authentication information: dot1x dot1x (guest vlan) dot1x (reject vlan) dot1x (server fail vlan) mac-auth mac-auth (reject vlan) mac-auth (server fail vlan) client-mac ( ) mac-address MAC Address of the supplicant. interface ( ) string Name of the interface. session-id ( ) string Unique session identifier. username ( ) string Identity of the supplicant. vlan-id ( ) string Untagged VLAN ID that is assigned to the interface. VLAN ID filtering must be enabled on bridge. Statuses of all active dot1x server interfaces are listed in the state menu (read only properties). Sub-menu: /interface dot1x server state Property Description interface ( ) string Name of the interface. status ( ) string Possible interface statuses: authorized - access to interface is granted; iface-down - interface is not running; rejected-holding - access was rejected by the RADIUS server; un-authorized - access to interface is not granted. Examples Below are described the most common configuration examples for dot1x server and client.

RouterOS Authenticator configuration Start off by adding a new RADIUS client. The authentication server (RADIUS) does not necessary have to be in the same LAN as authenticator, but it must be reachable from the authenticator, so any firewall limitations must be considered. /radius add address=10.1.2.3 secret=radiussecret service=dot1x Add new dot1x server instances. /interface dot1x server add interface=ether2 interim-update=30s comment=accounted add interface=ether12 accounting=no comment=notaccounted Port based VLAN ID assignment It is possible to assign an authenticated interface to a specific VLAN ID using bridge VLAN filtering. This can be done using RADIUS Tunnel-Type, Tunnel-Medium-Type and Tunnel-Private-Group-ID attributes. Note that only devices with hardware offloaded VLAN filtering will be able to do this in switch chip. f RADIUS communication is done over public network, it is advised to use RadSec for RADIUS communication. More information: I RADIUS

First of all, make sure the interface is added to a bridge which has VLAN filtering enabled. /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether12 It is necessary to add static VLAN configuration for tagged VLAN traffic to be sent over ether1 interface. /interface bridge vlan add bridge=bridge1 tagged=ether1 vlan-ids=2 add bridge=bridge1 tagged=ether1 vlan-ids=12 With enabled RADIUS debug logs it is possible to see complete RADIUS message packets with all attributes. In our example, Tunnel attributes are received in Access-Accept message from RADIUS server: 09:51:45 radius,debug,packet received Access-Accept with id 64 from 10.1.2.3:1812 09:51:45 radius,debug,packet Tunnel-Type = 13 09:51:45 radius,debug,packet Tunnel-Medium-Type = 6 09:51:45 radius,debug,packet Tunnel-Private-Group-ID = "12" (..) 09:51:45 radius,debug,packet User-Name = "dot1x-user" The VLAN ID is now present in active session list and untagged ports are added to previously created static VLAN configuration. /interface dot1x server active print 0 interface=ether12 username="dot1x-user" user-mac=00:0C:42:EB:71:F6 session-id="86b00006" vlan=12 /interface bridge vlan print detail Flags: X - disabled, D - dynamic 0 D bridge=bridge1 vlan-ids=1 tagged="" untagged="" current-tagged="" current-untagged=bridge1,ether3 1 bridge=bridge1 vlan-ids=2 tagged=ether1 untagged="" current-tagged=ether1 current-untagged=ether2 2 bridge=bridge1 vlan-ids=12 tagged=ether1 untagged="" current-tagged=ether1 current-untagged=ether12 Dynamic switch rule configuration In some network configurations, additional access rules are needed for a particular supplicant to restrict or allow certain network services. This can be done using a Mikrotik-Switching-Filter attribute, please see the . When a client is successfully authenticated by an RADIUS vendor dictionary authentication server, the server can pass back the Mikrotik-Switching-Filter attribute. Based on the received information, the authenticator will create dynamic access rules on a switch port where the client resides. These rules will be active as long as the client session is active and the interface is running. There are certain order and restrictions regarding correct switch rule implementation: The , ( ), mac-protocol src-mac-address available only since RouterOS 7.2 version src-address (IPv4/mask, available only since RouterOS 7.2 version), dst-address (IPv4/mask), (IPv4) (L4, available only since RouterOS 7.2 version), protocol src-port dst-port (L4) conditional parameters are supported Hexadecimal or decimal representation can be used for mac-protocol and protocol parameters (e.g. or ) protocol 17 protocol 0x11 The support single or range values (e.g. or ) and src-port dst-port src-port 10 src-port 10-20 The support "xx:xx:xx:xx:xx:xx" or "xxxxxxxxxxxx" formats, and switch rule without any source MAC address can be set src-mac-address with "none" keyword (e.g. ) src-mac-address none The (if not already set by the attribute) src-mac-address , switch and ports conditional parametrs are automatically set for each rule Each rule should end with an action property, supported values are either or . If no action property is set, the default value drop allow allow will be used. Multiple rules are supported for a single supplicant and they must be separated by a comma ","

Below are some examples of Mikrotik-Switching-Filter attributes and dynamic switch rules they create: # Drop ARP frames (EtherType: 0x0806 or 2054) Mikrotik-Switching-Filter = "mac-protocol 2054 action drop" /interface ethernet switch rule print Flags: X - disabled, I - invalid, D - dynamic 0 D ;;; dot1x dynamic switch=switch1 ports=ether1 src-mac-address=CC:2D:E0:11:22:33/FF:FF:FF:FF:FF:FF mac-protocol=arp copy- to-cpu=no redirect-to-cpu=no mirror=no new-dst-ports="" # Allow UDP (IP protocol: 0x11 or 17) destination port 100 and drop all other packets Mikrotik-Switching-Filter = "protocol 17 dst-port 100 action allow, action drop" /interface ethernet switch rule print Flags: X - disabled, I - invalid, D - dynamic 0 D ;;; dot1x dynamic switch=switch1 ports=ether1 src-mac-address=CC:2D:E0:11:22:33/FF:FF:FF:FF:FF:FF protocol=udp dst- port=100 copy-to-cpu=no redirect-to-cpu=no mirror=no 1 D ;;; dot1x dynamic switch=switch1 ports=ether1 src-mac-address=CC:2D:E0:11:22:33/FF:FF:FF:FF:FF:FF copy-to-cpu=no redirect-to-cpu=no mirror=no new-dst-ports="" # Allow only authenticated source MAC address, drop all other packets Mikrotik-Switching-Filter = "action allow, src-mac-address none action drop" /interface ethernet switch rule print Flags: X - disabled, I - invalid; D - dynamic 0 D ;;; dot1x dynamic switch=switch1 ports=ether1 src-mac-address=CC:2D:E0:01:6D:EB/FF:FF:FF:FF:FF:FF copy-to-cpu=no redirect-to-cpu=no mirror=no 1 D ;;; dot1x dynamic switch=switch1 ports=ether1 copy-to-cpu=no redirect-to-cpu=no mirror=no new-dst-ports="" In our example, Supplicant2 on ether2 is only allowed to access the 192.168.50.0/24 network with UDP destination port 50, all other traffic should be dropped. First, make sure that hardware offloading is working on bridge ports, otherwise switch rules might not work properly. /interface bridge port print Flags: X - disabled, I - inactive, D - dynamic, H - hw-offload # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH- COST HORIZON 0 H ether1 bridge1 yes 1 0x80 10 10 none 1 H ether2 bridge1 yes 1 0x80 10 10 none 2 H ether12 bridge1 yes 1 0x80 10 10 none With enabled RADIUS debug logs it is possible to see complete RADIUS message packets with all attributes. In our example, Mikrotik-Switching-Filter attribute is received in Access-Accept message from Radius server: 02:35:38 radius,debug,packet received Access-Accept with id 121 from 10.1.2.3:1812 (..) 02:35:38 radius,debug,packet MT-Switching-Filter = "mac-protocol 2048 dst-address 192.168.50.0/24 dst- port 50 protocol 17 action allow,action drop" The dynamic switch rules are now present under the switch menu:

/interface ethernet switch rule print Flags: X - disabled, I - invalid, D - dynamic 0 D ;;; dot1x dynamic switch=switch1 ports=ether2 src-mac-address=CC:2D:E0:11:22:33/FF:FF:FF:FF:FF:FF mac-protocol=ip dst- address=192.168.50.0/24 protocol=udp dst-port=50 copy-to-cpu=no redirect-to-cpu=no mirror=no 1 D ;;; dot1x dynamic switch=switch1 ports=ether2 src-mac-address=CC:2D:E0:11:22:33/FF:FF:FF:FF:FF:FF copy-to-cpu=no redirect-to-cpu=no mirror=no new-dst-ports="" RouterOS Supplicant configuration CA certificates are required for eap-tls eap-ttls, and eap-peap authentication methods. Additionally a client certificate is required for eap-tls method. For this example we have already imported a P12 certificate bundle with self signed client and CA certificates. For more information how to import certificates in RouterOS, please visit System/Certificates . /certificate print Flags: K - private-key, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted # NAME COMMON- NAME SUBJECT-ALT-NAME FINGERPRINT 0 K A T dot1x-client ez_dot1x- client IP:10.1.2.34 1 L A T dot1x CA ca Simply add a new dot1x client instance that will initiate authentication process. /interface dot1x client add anon-identity=anonymous client-certificate=dot1x-client eap-methods=eap-tls identity=dot1x-user interface=ether1 password=dot1xtest If authentication was successful, the interface should have status authenticated . /interface dot1x client print Flags: I - inactive, X - disabled 0 interface=ether1 eap-methods=eap-peap identity="dot1x-user" password="dot1xtest" anon-identity=" anonymous" client-certificate=dot1x-client status="authenticated" Dynamic switch rules will only apply to RouterBoards with switch rule support - CRS3xx, CRS5xx series switches, CCR2116, CCR2216, and devices with QCA8337, Atheros8327 and Atheros8316 switch chips. CRS1xx/2xx series switches do no support this functionality. Take into consideration the maximum number of rules for each device, see CRS3xx, CRS5xx, CCR2116, CCR2216 table and basic switch chip table

masquerade network ( ; yes | no Default: ) yesWhether to masquerade HotSpot network, when rule is added to with yes /ip firewall nat action=masquerade address pool of network ( ; string Default: ) yesAddress pool for HotSpot network, which is used to change user IP address to a valid address. Useful if providing network access to mobile clients that are not willing to change their networking settings. select certificate (none | import- ; Default: ) other-certificateChoose SSL certificate, when HTTPS authorization method is required. ip address of smtp server (; IP Default: ) 0.0.0.0The IP address of the SMTP server, where to redirect HotSpot's network SMTP requests (25 TCP port) dns servers (; Default:IP 0.0.0.0 )DNS server addresses used for HotSpot clients, configuration taken from menu of the HotSpot gateway /ip dns dns name ( ; Default: ) string "" the domain name of the HotSpot server, a full qualified domain name is required, for example, www.example.com name of local hotspot user (stri ; Default: ) ng "admin"username of one automatically created HotSpot user, added to /ip hotspot user password for the user' ( ; string Default: )Password for automatically created HotSpot user IP HotSpot /ip/hotspot The menu is designed to manage the HotSpot servers of the router. It is possible to run HotSpot on Ethernet, wireless, VLAN, and bridge interfaces. One HotSpot server is allowed per interface. When HotSpot is configured on the bridge interface, set HotSpot interface as bridge interface, not as bridge port, do not add public interfaces to bridge ports. You can add HotSpot servers manually to the menu, but it is advised to run , which /ip/hotspot /ip/hotspot/setup adds all necessary settings. Parameters Description name (text) HotSpot server's name or identifier address-pool (name / none; default: none )address space used to change HotSpot client anyIP address to a valid address. Useful for providing public network access to mobile clients that are not willing to change their networking settings idle-timeout (time /none ; default: 5m) period of inactivity for unauthorized clients. When there is no traffic from this client (literally client computer should be switched off), once the timeout is reached, a user is dropped from the HotSpot host list, its used address becomes available keepalive-timeout (ti me/none ; default: no ne)Value of how long host can stay out of reach to be removed from the HotSpot login-timeout (time /none ; default: none )Period of time after which if a host hasn't been authorized itself with a system the host entry gets deleted from host table. Loop repeats until the host logs in the system. Enable if there are situations where a host cannot log in after being too long in the host table unauthorized. interface (name of an interface)Interface to run HotSpot on addresses-per-mac (i nteger /unlimited; default: 2)Number of IP addresses allowed to be bind with the MAC address, when multiple HotSpot clients connected with one MAC- address profile (name; default: default )HotSpot server default HotSpot profile, which is located in /ip/hotspot/profile Read-only Parameters Description

keepalive-timeout (read- only; time)The exact value of the keepalive-timeout, that is applied to the user. Value shows how long the host can stay out of reach to be removed from the HotSpot IP HotSpot Active /ip/hotspot/active HotSpot active menu shows all clients authenticated in HotSpot, the menu is informational (read-only) it is not possible to change anything here. Parameters Description server (read-only; name) HotSpot server name client is logged in user (read-only; name) name of the HotSpot user domain (read-only; text) the domain of the user (if split from the username), a parameter is used only with RADIUS authentication address (read-only; IP address) The IP address of the HotSpot user mac-address (read-only; MAC-address) MAC-address of the HotSpot user login-by (read-only; multiple-choice: cookie /http-chap / http-pap /https /mac /mac-cookie /trial) the authentication method used by the HotSpot client uptime (read-only; time) current session time of the user, it is showing how long the user has been logged in idle-time (read-only; time) the amount of time the user has been idle session-time-left (read-only; time) the exact value of session-time, that is applied for the user. Value shows how long user is allowed to be online to be logged off automatically by uptime reached idle-timeout (read-only; time) the exact value of the user's idle-timeout keepalive-timeout (read-only; time) the exact value of the keepalive-timeout, that is applied for the user. Value shows how long the host can stay out of reach to be removed from the HotSpot limit-bytes-in (read-only; integer) value shows how many bytes received from the client, an option is active when the appropriate parameter is configured for HotSpot user limit-bytes-out (read-only; integer) value shows how many bytes send to the client, an option is active when the appropriate parameter is configured for HotSpot user limit-bytes-total (read-only; integer) value shows how many bytes total were send/received from the client, an option is active when the appropriate parameter is configured for HotSpot user IP HotSpot H ost /ip/hotspot/host The host table lists all computers connected to the HotSpot server. The host table is informational and it is not possible to change any value there: Parameters Description mac-address (read-only; MAC- address)HotSpot user MAC-address address (read-only; IP address) HotSpot client original IP address to-address (read-only; IP address) The new client address assigned by HotSpot might be the same as the original address

server (read-only; name) HotSpot server name client is connected to bridge-port (read-only; name) the client is connected to, value is unknown when HotSpot is not configured on the "/interface bridge port" bridge uptime (read-only; time) value shows how long the user is online (connected to the HotSpot) idle-time (read-only; time) time user has been idle idle-timeout (read-only; time) value of the client idle-timeout (unauthorized client) keepalive-timeout (read-only; time) keepalive-timeout value of the unauthorized client bytes-in (read-only; integer) amount of bytes received from an unauthorized client packet-in (read-only; integer) amount of packets received from an unauthorized client bytes-out (read-only; integer) amount of bytes sent to an unauthorized client packet-out (read-only; integer) amount of packets sent to an unauthorized client IP Binding /ip/hotspot/ip-binding IP-Binding HotSpot menu allows to the setup of static One-to-One NAT translations, allows to bypass specific HotSpot clients without any authentication, and also allows to block specific hosts and subnets from the HotSpot network Property Description address ( ; Default: ) IP Range "" The original IP address of the client mac-address ( ; Default: ) MAC "" MAC address of the client server ( ; Default: ) string | all "all" Name of the HotSpot server. all - will be applied to all hotspot servers to-address (; Default: ) IP "" New IP address of the client, translation occurs on the router (client does not know anything about the translation) type ( ; blocked | bypassed | regular Default: ) ""Type of the IP-binding action regular - performs One-to-One NAT according to the rule, translates to the address to-address bypassed - performs the translation, but excludes client from login to the HotSpot blocked - translation is not performed and packets from a host are dropped Cookies The menu contains all cookies sent to the HotSpot clients, which are authorized by cookie method, all the entries are read-only. /ip/hotspot/cookie Property Description domain ( ) string The domain name (if split from the username) expires-in ( )time How long the cookie is valid

mac-address ( ) MAC Client's MAC-address user ( ) string HotSpot username Using DHCP option to advertise HotSpot URL Most devices, such as modern smartphones, do some kind of background checking to see if they are behind a captive portal. They do this by requesting a known webpage and comparing the contents of that page, to what they should be. If contents are different, the device assumes there is a login page and creates a popup with this login page. This does not always happen, as this "known webpage" could be blocked, whitelisted, or not accessible in internal networks. To improve on this mechanism, RFC 7710 was created, allowing the HotSpot to inform all DHCP clients that they are behind a captive-portal device and that they will need to authenticate to get Internet access, regardless of what webpages they do or do not request. This DHCP option field is enabled automatically, but only if the router has a DNS name configured and has a valid SSL certificate (so that the login page can be accessed over HTTPS). When these requirements are met, a special DHCP option will be sent, containing a link to https://<dns-name-of- . This link contains information in JSON format, instructing the client device of the captive portal status, and the location of the login page. hotspot>/api Contents of are as follows: https://<dns-name-of-hotspot>/api { "captive": $(if logged-in == 'yes')false$(else)true$(endif), "user-portal-url": "$(link-login-only)", $(if session-timeout-secs != 0) "seconds-remaining": $(session-timeout-secs), $(endif) $(if remain-bytes-total) "bytes-remaining": $(remain-bytes-total), $(endif) "can-extend-session": true } Some devices require venue-info URL as well, so you are free to modify the api.json file to your liking, just like any other hotspot files. It is located in the router files menu. Important If you have set up Hotspot before RouterOS v7.3 when RFC 7710 was implemented, you will have to use "Reset HTML" function, or manually add/edit the api.json file to have the above contents, for Hotspot detection to work.

1. Hotspot customisation Requirements HotSpot captive portal Introduction You can create a completely different set of servlet pages for each HotSpot server you have, specifying the directory in the "html-override-directory" property of a HotSpot server profile /ip hotspot profile. The default servlet pages are copied in the directory "hotspot" directory right after you create the server profile. This directory can be accessed by connecting to the router with an FTP client. You can copy this directory and modify the pages as you like using the information from this section of the manual. Note that it is suggested to edit the files manually, as automated HTML editing tools may corrupt the pages by removing variables or other vital parts. After you are finished with content modification you need to upload this modified content to some custom directory on the hotspot router and point previously mentioned property "html-override-directory" value as path to this new custom HTML directory. Note: If "html-override-directory" value path is missing or empty then the hotspot server will revert to default HTML files. Available Pages Main HTML servlet pages, which are shown to the user: redirect.html - redirects the user to another URL (for example, to the login page) login.html - login page shown to a user to ask for a username and password. This page may take the following parameters: username - username password - either plain-text password (in case of PAP authentication) or MD5 hash of chap-id variable, password, and CHAP challenge (in case of CHAP authentication). This value is used as e-mail address for trial users dst - original URL requested before the redirect. This will be opened on successful login popup - whether to pop-up a status window on successful login radius<id> - send the attribute identified with <id> in text string form to the RADIUS server (in case RADIUS authentication is used; lost otherwise) radius<id>u - send the attribute identified with <id> in unsigned integer form to the RADIUS server (in case RADIUS authentication is used; lost otherwise) radius<id>-<vnd-id> - send the attribute identified with <id> and vendor ID <vnd-id> in text string form to the RADIUS server (in case RADIUS authentication is used; lost otherwise) radius<id>-<vnd-id>u - send the attribute identified with <id> and vendor ID <vnd-id> in unsigned integer form to the RADIUS server (in case RADIUS authentication is used; lost otherwise) md5.js - JavaScript for MD5 password hashing. Used together with http-chap login method alogin.html - page shown after a client has logged in. It pops-up status page and redirects the browser to the originally requested page (before he /she was redirected to the HotSpot login page) status.html - status page, shows statistics for the client. It is also able to display advertisements automatically logout.html - logout page, shown after a user is logged out. Shows final statistics about the finished session. This page may take the following additional parameters: erase-cookie - whether to erase cookies from the HotSpot server on logout (makes it impossible to log in with cookie next time from the same browser, might be useful in multiuser environments) error.html - error page, shown on fatal errors only Some other pages are available as well, if more control is needed: rlogin.html - page, which redirects the client from some other URL to the login page, if authorization of the client is required to access that URL rstatus.html - similar to rlogin.html, only in case if the client is already logged in and the original URL is not known radvert.html - redirects the client to the scheduled advertisement link flogin.html - shown instead of login.html, if some error has happened (invalid username or password, for example) fstatus.html - shown instead of redirect, if a status page is requested, but the client is not logged in flogout.html - shown instead of redirect, if logout page is requested, but the client is not logged in Serving Servlet Pages The HotSpot servlet recognizes 5 different request types: request for a remote host if user is logged in and advertisement is due to be displayed, radvert.html is displayed. This page redirects to the scheduled advertisement page if user is logged in and advertisement is not scheduled for this user, the requested page is served if user is not logged in, but the destination host is allowed by the walled garden, then the request is also served

link-login - link to login page including original URL requested (" ") http://10.5.50.1/login?dst=http://www.example.com/ link-login-only - link to login page, not including original URL requested (" ") http://10.5.50.1/login link-logout - link to logout page (" ") http://10.5.50.1/logout link-status - link to status page (" ") http://10.5.50.1/status link-orig - original URL requested (" ") http://www.example.com/ General client information: domain - domain name of the user (" ") example.com interface-name - physical HotSpot interface name (in case of bridged interfaces, this will return the actual bridge port name) ip - IP address of the client ("10.5.50.2") logged-in - "yes" if the user is logged in, otherwise - "no" ("yes") mac - MAC address of the user ("01:23:45:67:89:AB") trial - a "yes/no" representation of whether the user has access to trial time. If user's trial time has expired, the value is "no" username - the name of the user ("John") host-ip - client IP address from /ip hotspot host table vlan-id - Represents ID of a VLAN interface from which the client is connected User status information: idle-timeout - idle timeout ("20m" or "" if none) idle-timeout-secs - idle timeout in seconds ("88" or "0" if there is such timeout) limit-bytes-in - byte limit for send ("1000000" or "---" if there is no limit) limit-bytes-out - byte limit for receive ("1000000" or "---" if there is no limit) refresh-timeout - status page refresh timeout ("1m30s" or "" if none) refresh-timeout-secs - status page refresh timeout in seconds ("90s" or "0" if none) session-timeout - session time left for the user ("5h" or "" if none) session-timeout-secs - session time left for the user, in seconds ("3475" or "0" if there is such timeout) session-time-left - session time left for the user ("5h" or "" if none) session-time-left-secs - session time left for the user, in seconds ("3475" or "0" if there is such timeout) uptime - current session uptime ("10h2m33s") uptime-secs - current session uptime in seconds ("125") Traffic counters, which are available only on the status page: bytes-in - number of bytes received from the user ("15423") bytes-in-nice - user-friendly form of number of bytes received from the user ("15423") bytes-out - number of bytes sent to the user ("11352") bytes-out-nice - user-friendly form of number of bytes sent to the user ("11352") packets-in - number of packets received from the user ("251") packets-out - number of packets sent to the user ("211") remain-bytes-in - remaining bytes until limit-bytes-in will be reached ("337465" or "---" if there is no limit) remain-bytes-out - remaining bytes until limit-bytes-out will be reached ("124455" or "---" if there is no limit) Miscellaneous variables: session-id - value of 'session-id' parameter in the last request var - value of 'var' parameter in the last request error - error message, if something failed ("invalid username or password") error-orig - original error message (without translations retrieved from errors.txt), if something failed ("invalid username or password") chap-id - value of chap ID ("\371") chap-challenge - value of chap challenge ("\357\015\330\013\021\234\145\245\303\253\142\246\133\175\375\316") popup - whether to pop-up checkbox ("true" or "false") advert-pending - whether an advertisement is pending to be displayed ("yes" or "no") http-status - allows the setting of the http status code and message http-header - allows the setting of the http header RADIUS-related variables: radius<id> - show the attribute identified with <id> in text string form (in case RADIUS authentication was used; "" otherwise) radius<id>u - show the attribute identified with <id> in unsigned integer form (in case RADIUS authentication was used; "0" otherwise) radius<id>-<vnd-id> - show the attribute identified with <id> and vendor ID <vnd-id> in text string form (in case RADIUS authentication was used; "" otherwise) radius<id>-<vnd-id>u - show the attribute identified with <id> and vendor ID <vnd-id> in unsigned integer form (in case RADIUS authentication was used; "0" otherwise) Working with variables

$(if <var_name>) statements can be used in these pages. The following content will be included, if value of <var_name> will not be an empty string. It is an equivalent to $(if <var_name> != "") It is possible to compare on equivalence as well: $(if <var_name> == <value>) These statements have effect until $(elif <var_name>), $(else) or $(endif). In general case it looks like this: some content, which will always be displayed $(if username == john) Hey, your username is john $(elif username == dizzy) Hello, Dizzy! How are you? Your administrator. $(elif ip == 10.1.2.3) You are sitting at that old computer, which is so slow... $(elif mac == 00:01:02:03:04:05) This is an ethernet card, which was stolen few months ago... $(else) I don't know who you are, so lets live in peace. $(endif) other content, which will always be displayed Only one of those expressions will be shown. Which one - depends on the values of those variables for each client. Redirects and custom Headers $(if http-status == 302)Hotspot login required$(endif) $(if http-header == "Location")$(link-redirect)$(endif) Note: Although the above appears to use the conditional expression 'if' it is in fact setting the 'http-status' to '302' not testing for it. Also the same for the variable 'http-header'. Once again, even though it uses an 'if' it is in fact setting the variable to 'Location' followed by the URL set from the variable 'link- redirect'. For example, in the case where $(link-redirect) evaluates to " ", then the HTTP response returned to the client will be changed to: http://192.168.88.1/login HTTP/1.0 302 Hotspot login required <regular HTTP headers> Location: http://192.168.88.1/login http-status syntax : $(if http-status == XYZ)HTTP_STATUS_MESSAGE$(endif) XYZ - The status code you wish to return. Should be 3 decimal digits, the first one must not be 0 HTTP_STATUS_MESSAGE - any text you wish to return to the client that will follow the above status code in the HTTP reply In any HTTP response it will be on the first line and will be as follows: HTTP/1.0 XYZ HTTP_STATUS_MESSAGE http-header syntax: $(if http-header == HTTP_HEADER_NAME)HTTP_HEADER_VALUE$(endif) HTTP_HEADER_NAME - name of the HTTP header to be sent in the response HTTP_HEADER_VALUE - the value of the HTTP header with the name HTTP_HEADER_NAME to be sent in the response The HTTP response will appear as: HTTP_HEADER_NAME: HTTP_HEADER_VALUE All variables and conditional expressions within HTTP_HEADER_VALUE and HTTP_STATUS_MESSAGE are processed as usual. In case multiple headers with the same name are added, then only the last one will be used (previous ones will be discarded). It allows the system to override regular HTTP headers (for example, Content-Type and Cache-Control). Customizing Error Messages All error messages are stored in the errors.txt file within the respective HotSpot servlet directory. You can change and translate all these messages to your native language. To do so, edit the errors.txt file. You can also use variables in the messages. All instructions are given in that file. Multiple Versions of HotSpot Pages

Multiple HotSpot page sets for the same HotSpot server are supported. They can be chosen by the user (to select language) or automatically by JavaScript (to select PDA/regular version of HTML pages). To utilize this feature, create subdirectories in the HotSpot HTML directory, and place those HTML files, which are different, in that subdirectory. For example, to translate everything in Latvian, the subdirectory "lv" can be created with login.html, logout.html, status.html, alogin.html, radvert.html and errors. txt files, which are translated into Latvian. If the requested HTML page can not be found in the requested subdirectory, the corresponding HTML file from the main directory will be used. Then main login.html file would contain a link to "/lv/login?dst=$(link-orig-esc)", which then displays Latvian version of login page: <a href="/lv/login?dst=$(link-orig-esc)">Latviski</a> . And Latvian version would contain a link to English version: <a href="/login?dst=$(link-orig- esc)">English</a> Another way of referencing directories is to specify 'target' variable: <a href="$(link-login-only)?dst=$(link-orig-esc)&target=lv">Latviski</a> <a href="$(link-login-only)?dst=$(link-orig-esc)&target=%2F">English</a> After the preferred directory has been selected (for example, "lv"), all links to local HotSpot pages will contain that path (for example, $(link-status) = " http:// "). So, if all HotSpot pages reference links using "$(link-xxx)" variables, then no more changes are to be made - each client will stay hotspot.mt.lv/lv/status within the selected directory all the time. Misc If you want to use the HTTP-CHAP authentication method, you need to include the function (which references to the which must be doLogin() md5.js already loaded) before the of the login form. Otherwise, CHAP login will fail. Submit action The resulting password to be sent to the HotSpot gateway in case of HTTP-CHAP method, it is formed by MD5-hashing the concatenation of the following: chap-id, the password of the user, and chap-challenge (in the given order) In case variables are to be used in the link directly, then they must be escaped accordingly. For example, in login page, <a href=" https://login.example.com will not work as intended, if username will be "123&456=1 2". In this case instead of $(user), its escaped > /login?mac=$(mac)&user=$(username)">link</a version must be used: $(user-esc): . Now the same username will be <a href=" > https://login.server.serv/login?mac=$(mac-esc)&user=$(user-esc)">link</a converted to "123%26456%3D1+2", which is the valid representation of "123&456=1 2" in URL. This trick may be used with any variables, not only with $(username). There is a boolean parameter "erase-cookie" to the logout page, which may be either "on" or "true" to delete user cookie on logout (so that the user would not be automatically logged on when he/she opens a browser next time. Examples With basic HTML language knowledge and the examples below it should be easy to implement the ideas described above. To provide predefined value as username, in login.html change: <type="text" value="$(username)> to this line: <input type="hidden" name="username" value="hsuser"> (where hsuser is the username you are providing) To provide a predefined value as a password, in login.html change: <input type="password"> to this line: <input type="hidden" name="password" value="hspass"> (where hspass is the password you are providing) To send the client's MAC address to a registration server in the form of: https://www.example.com/register.html?mac=XX:XX:XX:XX:XX:XX change the Login button link in login.html to: https://www.example.com/register.html?mac=$(mac) (you should correct the link to point to your server)

To show a banner after user login, in alogin.html after $(if popup == 'true') add the following line: open('http://www.example.com/your-banner-page.html', 'my-banner-name',''); (you should correct the link to point to the page you want to show) To choose a different page shown after login, in login.html change: <input type="hidden" name="dst" value="$(link-orig)"> to this line: <input type="hidden" name="dst" value="http://www.example.com"> (you should correct the link to point to your server) To erase the cookie on logoff, in the page containing a link to the logout (for example, in status.html) change: open('$(link-logout)', 'hotspot_logout', ... to this: open('$(link-logout)?erase-cookie=on', 'hotspot_logout', ... or alternatively add this line: <input type="hidden" name="erase-cookie" value="on"> before this one: <input type="submit" value="log off"> External authentication Another example is making HotSpot to authenticate on a remote server (which may, for example, perform credit card charging): Allow direct access to the external server in walled-garden (either HTTP-based or IP-based) Modify the login page of the HotSpot servlet to redirect to the external authentication server. The external server should modify the RADIUS database as needed Here is an example of such a login page to put on the HotSpot router (it is redirecting to , replace with the actual https://auth.example.com/login.php address of an external authentication server): <html> <title>...</title> <body> <form name="redirect" action="https://auth.example.com/login.php" method="post"> <input type="hidden" name="mac" value="$(mac)"> <input type="hidden" name="ip" value="$(ip)"> <input type="hidden" name="username" value="$(username)"> <input type="hidden" name="link-login" value="$(link-login)"> <input type="hidden" name="link-orig" value="$(link-orig)"> <input type="hidden" name="error" value="$(error)"> </form> <script language="JavaScript"> <!-- document.redirect.submit(); //--> </script> </body> </html> The external server can log in a HotSpot client by redirecting it back to the original HotSpot servlet login page, specifying the correct username and password Here is an example of such a page (it is redirecting to , replace with the actual address of a HotSpot router; also, it is https://hotspot.example.com/login displaying after successful login, replace with what is needed): www.mikrotik.com

<html> <title>Hotspot login page</title> <body> <form name="login" action="https://hotspot.example.com/login" method="post"> <input type="text" name="username" value="demo"> <input type="password" name="password" value="none"> <input type="hidden" name="domain" value=""> <input type="hidden" name="dst" value="http://www.mikrotik.com/"> <input type="submit" name="login" value="log in"> </form> </body> </html> Hotspot will ask the RADIUS server whether to allow the login or not. If allowed, alogin.html page will be displayed (it can be modified to do anything). If not allowed, the flogin.html (or login.html) page will be displayed, which will redirect the client back to the external authentication server. Note: as shown in these examples, HTTPS protocol and POST method can be used to secure communications. HTTP header detection The Hotspot login pages have access to HTTP headers by using $(http-header-name); For example, there exists an ability to check the user agent (or browser), and will return any other content instead of the regular login page, if so desired. This can be used to disable automatic popups in phones, for example. For example, to output "SUCCESS" for users of a specific Firefox mobile version, instead of the login page, you can these lines on the top of the rlogin.html page in your hotspot directory: $(if user-agent == "Mozilla/5.0 (Android; Mobile; rv:40.0) Gecko/40.0 Firefox/40.0" ) <HTML><HEAD><TITLE>Success</TITLE></HEAD><BODY>Success</BODY></HTML> $(else) ---- regular content of rlogin.html page ---- $(endif) This will DISABLE the login popup for Android Firefox 40 users. One-click login It is possible to create a modified captive portal for quick one-click login for scenarios where no user or password is required. What you need to do is: Create a user for this purpose. In example, it is "notsosecretuser" with password "notsosecretpass" Assign this user to a user profile that allows a specific/unlimited amount of simultaneous active users. Copy original hotspot directory that is already generated in routers file menu on root level. Modify the contents of this copy directory contents. Only one file requires modifications for this to work, the "login.html". Original: <table width="100" style="background-color: #ffffff"> <tr><td align="right">login</td> <td><input style="width: 80px" name="username" type="text" value="$(username)"/></td> </tr> <tr><td align="right">password</td> <td><input style="width: 80px" name="password" type="password"/></td> </tr> <tr><td> </td> <td><input type="submit" value="OK" /></td> </tr> </table> Modified:

<table width="100" style="background-color: #ffffff"> <tr style="display:none;"><td align="right">login</td> <td><input style="width: 80px" name="username" type="text" value="notsosecretuser"/></td> </tr> <tr style="display:none;"><td align="right">password</td> <td><input style="width: 80px" name="password" type="password" value="notsosecretpass"/></td> </tr> <tr><td> </td> <td><input type="submit" value="Proceed to Internet!" /></td> </tr> </table> What changed: User and Password "" fields are hidden. Both User and Password field values contain predefined values. Changed the "OK" button value(name) to something more fitting. Now upload this new hotspot folder back to the router, preferably with a different name. Change settings in the hotspot server profile to use this new html directory. /ip hotspot profile set (profile number or name) html-directory-override=(dir path/name) Firewall customizations Summary Apart from the obvious dynamic entries in the /ip hotspot submenu itself (like hosts and active users), some additional rules are added in the firewall tables when activating a HotSpot service. NAT From command, you can get something like this (comments follow after each of the rules): /ip firewall nat print dynamic 0 D chain=dstnat action=jump jump-target=hotspot hotspot=from-client Putting all HotSpot-related tasks for packets from all HotSpot clients into a separate chain. 1 I chain=hotspot action=jump jump-target=pre-hotspot Any actions that should be done before HotSpot rules apply, should be put in the pre-hotspot chain. This chain is under full administrator control and does not contain any rules set by the system, hence the invalid jump rule (as the chain does not have any rules by default). 2 D chain=hotspot action=redirect to-ports=64872 dst-port=53 protocol=udp 3 D chain=hotspot action=redirect to-ports=64872 dst-port=53 protocol=tcp Redirect all DNS requests to the HotSpot service. The 64872 port provides DNS service for all HotSpot users. If you want the HotSpot server to listen to another port, add rules here the same way, changing dst-port property. 4 D chain=hotspot action=redirect to-ports=64873 hotspot=local-dst dst-port=80 protocol=tcp Redirect all HTTP login requests to the HTTP login servlet. The 64873 is HotSpot HTTP servlet port. 5 D chain=hotspot action=redirect to-ports=64875 hotspot=local-dst dst-port=443 protocol=tcp Redirect all HTTPS login requests to the HTTPS login servlet. The 64875 is HotSpot HTTPS servlet port. 6 D chain=hotspot action=jump jump-target=hs-unauth hotspot=!auth protocol=tcp All other packets except DNS and login requests from unauthorized clients should pass through the hs-unauth chain. 7 D chain=hotspot action=jump jump-target=hs-auth hotspot=auth protocol=tcp And packets from the authorized clients - through the hs-auth chain. 8 D ;;; www.mikrotik.com chain=hs-unauth action=return dst-address=66.228.113.26 dst-port=80 protocol=tcp First in the chain is put everything that affects TCP protocol in the submenu (i.e., everything where either hs-unauth /ip hotspot walled-garden ip protocol is not set, or set to TCP). Here we are excluding from being redirected to the login page. www.mikrotik.com 9 D chain=hs-unauth action=redirect to-ports=64874 dst-port=80 protocol=tcp

All other HTTP requests are redirected to the Walled Garden proxy server which listens to the 64874 port. If there is an "allow" entry in the /ip hotspot menu for an HTTP request, it is being forwarded to the destination. Otherwise, the request will be automatically redirected to the HotSpot walled-garden login servlet (port 64873). 10 D chain=hs-unauth action=redirect to-ports=64874 dst-port=3128 protocol=tcp 11 D chain=hs-unauth action=redirect to-ports=64874 dst-port=8080 protocol=tcp HotSpot by default assumes that only these ports may be used for HTTP proxy requests. These two entries are used to "catch" client requests to unknown proxies (you can add more rules here for other ports). I.e., to make it possible for the clients with unknown proxy settings to work with the HotSpot system. This feature is called "Universal Proxy". If it is detected that a client is using some proxy server, the system will automatically mark those packets with the HTTP hotspot mark to work around the unknown proxy problem, as we will see later on. Note that the port used (64874) is the same as for HTTP requests in rule #9 (so both HTTP and HTTP proxy requests are processed by the same code). 12 D chain=hs-unauth action=redirect to-ports=64875 dst-port=443 protocol=tcp HTTPS proxy is listening on the 64875 port. 13 I chain=hs-unauth action=jump jump-target=hs-smtp dst-port=25 protocol=tcp Redirect for SMTP protocol may also be defined in the HotSpot configuration. In case it is, a redirect rule will be put in the hs-smtp chain. This is done so that users with unknown SMTP configuration would be able to send their mail through the service provider's (your) SMTP server instead of going to the [possibly unavailable outside their network of origin] SMTP server users have configured on their computers. The chain is empty by default, hence the invalid jump rule. 14 D chain=hs-auth action=redirect to-ports=64874 hotspot=http protocol=tcp Providing HTTP proxy service for authorized users. Authenticated user requests may need to be subject to transparent proxying (the "Universal Proxy" technique and advertisement feature). This HTTP mark is put automatically on the HTTP proxy requests to the servers detected by the HotSpot HTTP proxy (the one that is listening on the 64874 port) as HTTP proxy requests for unknown proxy servers. This is done so that users that have some proxy settings would use the HotSpot gateway instead of the [possibly unavailable outside their network of origin] proxy server users have configured in their computers. This mark is also applied when an advertisement is due to be shown to the user, as well as on any HTTP requests from the users whose profile is configured to transparently proxy their requests. 15 I chain=hs-auth action=jump jump-target=hs-smtp dst-port=25 protocol=tcp Providing SMTP proxy for authorized users (the same as in rule #13). Packet Filtering From command, you can get something like this (comments follow after each of the rules): /ip firewall filter print dynamic 0 D chain=forward action=jump jump-target=hs-unauth hotspot=from-client,!auth Any packet that traverse the router from an unauthorized client will be sent to the chain. The hs-unauth implements the IP-based Walled Garden hs-unauth filter. 1 D chain=forward action=jump jump-target=hs-unauth-to hotspot=to-client,!auth Everything that comes to clients through the router, gets redirected to another chain, called . This chain should reject unauthorized requests to hs-unauth-to the clients. 2 D chain=input action=jump jump-target=hs-input hotspot=from-client Everything that comes from clients to the router itself, gets to yet another chain, called . hs-input 3 I chain=hs-input action=jump jump-target=pre-hs-input Before proceeding with [predefined] dynamic rules, the packet gets to the administratively controlled chain, which is empty by default, hence pre-hs-input the invalid state of the jump rule. 4 D chain=hs-input action=accept dst-port=64872 protocol=udp 5 D chain=hs-input action=accept dst-port=64872-64875 protocol=tcp Allow client access to the local authentication and proxy services (as described earlier). 6 D chain=hs-input action=jump jump-target=hs-unauth hotspot=!auth All other traffic from unauthorized clients to the router itself will be treated the same way as the traffic traversing the routers. 7 D chain=hs-unauth action=return protocol=icmp 8 D ;;; www.mikrotik.com chain=hs-unauth action=return dst-address=66.228.113.26 dst-port=80 protocol=tcp

Unlike the NAT table where only TCP-protocol related Walled Garden entries were added, in the packet filter chain is added to everything you hs-unauth have set in the menu. That is why although you have seen only one entry in the NAT table, there are two rules here. /ip hotspot walled-garden ip 9 D chain=hs-unauth action=reject reject-with=tcp-reset protocol=tcp 10 D chain=hs-unauth action=reject reject-with=icmp-net-prohibited Everything else that has not been white-listed by the Walled Garden will be rejected. Note the usage of TCP Reset for rejecting TCP connections. 11 D chain=hs-unauth-to action=return protocol=icmp 12 D ;;; www.mikrotik.com chain=hs-unauth-to action=return src-address=66.228.113.26 src-port=80 protocol=tcp The same action as in rules #7 and #8 is performed for the packets destined to the clients (chain ) as well. hs-unauth-to 13 D chain=hs-unauth-to action=reject reject-with=icmp-host-prohibited Reject all packets to the clients with an ICMP reject message.

bridge-port-vid (integer 0.. 4094)Used to assign PVID parameter for dynamically created interface. bridge-port-trusted ( ; no | yes Default: ) noUsed to set dynamically created interface as DHCP trusted. change-tcp-mss (yes | no | ; Default: ) default noModifies connection MSS settings (applies only for IPv4): yes - adjust connection MSS value no - do not adjust connection MSS value default - derive this value from the interface default profile; same as no if this is the interface default profile comment ( ; Default: ) string Profile comment dhcpv6-pd-pool ( ; string Default: )Name of the which will be used by dynamically created when client connects. IPv6 pool DHCPv6 server Read more >> dns-server (; Default: )IP IP address of the DNS server that is supplied to PPP clients idle-timeout ( ; Default: )time Specifies the amount of time after which the link will be terminated if there is no activity present. Timeout is not set by default incoming-filter ( ; string Default: )Firewall chain name for incoming packets. The specified chain gets control of each packet coming from the client. The ppp chain should be manually added and rules with action=jump jump-target=ppp should be added to other relevant chains for this feature to work. For more information look at the section examples insert-queue-before (bottom ; | first | queue name Default: )Inserts new queue as the last, first, or before a specified queue interface-list (interface list ; Default: ) nameSpecifies interface list to which profile interfaces will be added local-address (IP address | ; Default: )poolTunnel address or name of the from which the address is assigned to ppp interface locally pool name ( ; Default: ) string PPP profile name on-up ( ; Default: ) script Execute script on user login-event. These are available variables that are accessible for the event script: user local-address remote-address caller-id called-id interface on-down ( ; Default: ) script Execute script on the user logging off. See for more details on-up only-one ( ; yes | no | default Default: ) defaultDefines whether a user is allowed to have more than one ppp session at a time yes - a user is not allowed to have more than one ppp session at a time no - the user is allowed to have more than one ppp session at a time default - derive this value from the interface default profile; same as no if this is the interface default profile outgoing-filter ( ; string Default: )Firewall chain name for outgoing packets. The specified chain gets control for each packet going to the client. The PPP chain should be manually added and rules with action=jump jump-target=ppp should be added to other relevant chains for this feature to work. For more information look at the Examples section. parent-queue ( | none queue ; Default: ) nameSpecifies parent queue

queue-type (default | ethernet-default | wireless- default | synchronous- default | hotspot-default | pcq-upload-default | pcq- download-default | only- hardware-queue | multi- queue-ethernet-default | default-small | custom ; Default: ) queue type name Specifies queue type rate-limit ( ; Default: ) string Rate limitation in form of rx-rate[/tx-rate] [rx-burst-rate[/tx-burst-rate] [rx-burst-threshold[/tx-burst-threshold] [rx-burst-time[ from the point of view of the router (so "rx" is client upload, and "tx" is /tx-burst-time] [priority] [rx-rate-min[/tx-rate-min]]]] client download). All rates are measured in bits per second, unless followed by an optional 'k' suffix (kilobits per second) or 'M' suffix (megabits per second). If tx-rate is not specified, rx-rate serves as tx-rate too. The same applies to tx-burst- rate, tx-burst-threshold and tx-burst-time. If both rx-burst-threshold and tx-burst-threshold are not specified (but burst-rate is specified), rx-rate and tx-rate are used as burst thresholds. If both rx-burst-time and tx-burst-time are not specified, 1s is used as default. Priority takes values 1..8, where 1 implies the highest priority, but 8 - the lowest. If rx-rate-min and tx- rate-min are not specified rx-rate and tx-rate values are used. The rx-rate-min and tx-rate-min values can not exceed rx- rate and tx-rate values. remote-address (; IP Default: )Tunnel address or name of the from which address is assigned to remote ppp interface. pool remote-ipv6-prefix-pool (stri ; Default: ) ng | none noneAssign a prefix from the IPv6 pool to the client and install the corresponding IPv6 route. session-timeout ( ; time Default: )Maximum time the connection can stay up. By default, no time limit is set. use-compression (yes | no | ; Default: ) default defaultSpecifies whether to use data compression or not. yes - enable data compression no - disable data compression default - derive this value from the interface default profile; same as no if this is the interface default profile This setting does not affect OVPN tunnels. use-encryption (yes | no | ; Default: default | require def )aultSpecifies whether to use data encryption or not. yes - enable data encryption no - disable data encryption default - derive this value from the interface default profile; same as no if this is the interface default profile require - explicitly requires encryption This setting does not work on OVPN and SSTP tunnels. use-ipv6 (yes | no | default | ; Default: ) require defaultSpecifies whether to allow IPv6. By default is enabled if IPv6 package is installed. yes - enable IPv6 support no - disable IPv6 support default - derive this value from the interface default profile; same as no if this is the interface default profile require - explicitly requires IPv6 support use-mpls (yes | no | default ; Default: ) | require defaultSpecifies whether to allow MPLS over PPP. yes - enable MPLS support no - disable MPLS support default - derive this value from the interface default profile; same as no if this is the interface default profile require - explicitly requires MPLS support use-upnp ( ; yes | no | default Default: ) defaultSpecifies whether to allow UPnP yes - enable UPnP no - disable UPnP default - derive this value from the interface default profile; same as no if this is the interface default profile

wins-server ( ; IP address Default: )IP address of the WINS server to supply to Windows clients Notes The two default profiles cannot be removed: [admin@rb13] ppp profile> print Flags: * - default 0 * name="default" use-compression=no use-encryption=no only-one=no change-tcp-mss=yes 1 * name="default-encryption" use-compression=default use-encryption=yes only-one=default change-tcp-mss=default [admin@rb13] ppp profile> incoming-filter and arguments add dynamic jump rules to chain , where the jump-target argument will be equal to or outgoing-filter ppp incoming-filter outgoi argument in the profile. Therefore, chain should be manually added before changing these arguments. ng-filter ppp only-one parameter is ignored if RADIUS authentication is used. User Database Sub-menu: /ppp secret PPP User Database stores PPP user access records with PPP user profile assigned to each user. Properties Property Description caller-id ( ; Default: ) string For and it is the IP address a client must connect from. For it is the MAC address (written in CAPITAL PPTP L2TP PPPoE letters) a client must connect from. For ISDN it is the caller's number (that may or may not be provided by the operator) the client may dial-in from comment ( ; Default: string )Short description of the user. disabled ( ; yes | no Default: )noWhether secret will be used. limit-bytes-in ( ; integer Default: )0The maximum amount of bytes for a session that the client can upload. limit-bytes-out ( ; integer Default: )0The maximum amount of bytes for a session that the client can download. local-address ( ; IP address Default: )IP address that will be set locally on ppp interface. name ( ; Default: ) string Name used for authentication password ( ; Default: string )Password used for authentication profile ( ; Default: string def )aultWhich to use user profile remote-address (; IP Default: )IP address that will be assigned to the remote ppp interface. remote-ipv6-prefix (IPv6 ; Default: ) prefixIPv6 prefix assigned to ppp client. Prefix is added to enabling address auto-configuration on ppp ND prefix list stateless interface.

routes ( ; Default: ) string Routes that appear on the server when the client is connected. The route format is: dst-address gateway metric (for example, 10.1.0.0/ 24 10.0.0.1 1). Other syntax is not acceptable since it can be represented incorrectly. Several routes may be specified and separated with commas. This parameter will be ignored for . OpenVPN service (any | async | isdn | l2tp | pppoe | pptp | ; Default: ) ovpn | sstp anySpecifies the services that a particular user will be able to use. Active Users Sub-menu: /ppp active This submenu allows monitoring active (connected) users. /ppp active print command will show all currently connected users. /ppp active print stats command will show received/sent bytes and packets Properties Property Description address ( ) IP address The IP address the client got from the server bytes ( ) integer Amount of bytes transferred through this connection. The first figure represents the amount of transmitted traffic from the router's point of view, while the second one shows the amount of received traffic. caller-id ( ) string For and it is the IP address the client connected from. For , it is the MAC address the client PPTP L2TP PPPoE connected from. encoding ( ) string Shows encryption and encoding (separated with '/' if asymmetric) being used in this connection limit-bytes-in ( ) integer The maximum amount of bytes the user is allowed to send to the router. limit-bytes-out ( ) integer The maximum amount of bytes the user is allowed to send to the client. name ( ) string User name supplied at authentication stage packets ( ) integer/integer Amount of packets transferred through this connection. The first figure represents the amount of transmitted traffic from the router's point of view, while the second one shows the amount of received traffic service (async | isdn | l2tp | ) pppoe | pptp | ovpn | sstpType of service the user is using. session-id ( ) string Shows unique client identifier. uptime ( )time User's uptime Remote AAA Sub-menu: /ppp aaa Settings in this submenu allows to set RADIUS accounting and authentication. Note that the RADIUS user database is consulted only if the required username is not found in the local user database. Properties Property Description accounting ( ; yes | no Default: yes )Enable RADIUS accounting

interim- update (ti ; me Default: )0sInterim-Update time interval use-radius ( ; yes | no Default: no )Enable user authentication via RADIUS. If an entry in the local secret database is not found, then the client will be authenticated via RADIUS. enable- ipv6- accountin g (yes | no ; Default: )noEnable IPv6 separate accounting. PPP service counts Layer2, IPv4 and IPv6 data all together when reporting network usage statistics to the RADIUS server by default. If it is required to differ IPv4 and IPv6 traffic, then this option can be enabled. Prerequisites for it to work are that the prefix must be assigned to the client through PPP service and also rate-limit must be provided. Dynamically created queue statistics will be used as counters for IPv6 data, which then will be included in accounting packets as separate IPv6 statistics attributes. This will not work for prefixes assigned by dynamically created DHCPv6 server due to provided prefix pool or PPP/Profile configuration. Then prefix assignment is handled by DHCP service, not PPP, thus accounting can not be managed by PPP service. Examples Add new profile To add the profile ex that assigns the router itself the 10.0.0.1 address, and the addresses from the ex pool to the clients, filtering traffic coming from clients through mypppclients chain: [admin@rb13] ppp profile> add name=ex local-address=10.0.0.1 remote-address=ex incoming-filter=mypppclients [admin@rb13] ppp profile> print Flags: * - default 0 * name="default" use-compression=no use-vj-compression=no use-encryption=no only-one=no change-tcp-mss=yes 1 name="ex" local-address=10.0.0.1 remote-address=ex use-compression=default use-vj-compression=default use-encryption=default only-one=default change-tcp-mss=default incoming-filter=mypppclients 2 * name="default-encryption" use-compression=default use-vj-compression=default use-encryption=yes only-one=default change-tcp-mss=default [admin@rb13] ppp profile> Add new user To add the user ex with password lkjrht and profile ex available for PPTP service only, enter the following command: [admin@rb13] ppp secret> add name=ex password=lkjrht service=pptp profile=ex [admin@rb13] ppp secret> print Flags: X - disabled # NAME SERVICE CALLER-ID PASSWORD PROFILE REMOTE-ADDRESS 0 ex pptp lkjrht ex 0.0.0.0 [admin@rb13] ppp secret>

name ( ) string Username. radius ( ) true | false Whether a user is authenticated by the RADIUS server. via ( ) telnet | ssh | winbox | api | rest-api | web | ftp User's access method by-romon (MAC address) RoMON agent MAC address when ( )time Time and date when the user logged in. Request logout It is possible to close an active CLI session using the request logout function. /user/active/request-logout ACTIVE_USER_SESSION_NUMBER Remote AAA Router user remote AAA enables router user authentication and accounting via a RADIUS server. The RADIUS user database is consulted only if the required username is not found in the local user database. Properties Property Description accounting ( ; yes | no Default: )yesIf the RADIUS server should be sent accounting of login, logout. Bandwidth usage statistics are not part of /user accounting exclude-groups (list of ; Default: ) group namesExclude-groups consist of the groups that should not be allowed to be used for users authenticated by radius. If the radius server provides a group specified in this list, the default-group will be used instead. This is to protect against privilege escalation when one user (without policy permission) can change the radius server list, set up its own radius server and log in as admin. default-group ( ; string Default: )readUser group used by default for users authenticated via a RADIUS server. interim-update ( ; time Default: )0sInterim-Update time interval use-radius ( ; yes |no Default: )noEnable user authentication via RADIUS SSH Keys This menu allows importing of private and public keys used for SSH authentication. If you are using RADIUS, you need to have CHAP support enabled in the RADIUS server for WinBox to work By default, User is not allowed to log in via SSH by password if an SSH key for the user is added. For more details see the page.SSH

Public keys This menu is used to import and list imported public keys. Public keys are used to approve another device's identity when logging into a router using an SSH key. On public key import, is it possible to specify key-owner. Property Description user ( ; Default: ) string username to which the SSH key is assigned. key-owner ( ) string SSH key owner public-key-file ( ) string file name in the router's root directory containing the public key. key-type (read-only ) key type bits (read-only ) key length Private keys This menu is used to import and list imported private keys. Private keys are used to approve the router's identity during login into another device using an SSH key. On private key import, is it possible to specify key-owner. Property Description user ( ; Default: ) string username to which the SSH key is assigned. key-owner ( ) string SSH key owner private-key-file ( ) string file name in the router's root directory containing the private key. passphrase (string) key file passphrase key-type (read-only ) key type bits (read-only ) key length RSA and Ed25519 keys are supported in PEM, PKCS#8, or OpenSSH format. RSA and Ed25519 keys are supported in PEM or PKCS#8 format.

User Manager Overview Attributes Database Limitations Payments Profiles Profile Limitations Routers Sessions Settings Advanced Users User Groups User Profiles WEB Interface Application Guides Batch user creation Providing NAS with custom RADIUS attributes Static IP address for a user Specifying address pool for a group of users Using TOTP (time-based one-time password) for user authentication Exporting user credentials Printable login credentials for a single user Multiple user credential export Generating usage report Purchasing a profile Migrating from RouterOS v6 Application Examples Basic L2TP/IPsec server with User Manager authentication MFA authentication for RouterOS user login Overview User Manager is RADIUS server implementation in RouterOS which provides centralized user authentication and authorization to a certain service. Having a central user database allows better tracking of system users and customers. As a separate package, User Manager is available on all architectures except SMIPS, however, care must be taken due to limited free space available. It supports many different authentication methods including PAP, CHAP, MS-CHAP, MS-CHAPv2, EAP-TLS, EAP-TTLS, and EAP-PEAP. In RouterOS, DHCP, Dot1x, Hotspot, IPsec, PPP, and Wireless are features that benefit from User Manager the most. Each user can see their account statistics and manage available profiles using the WEB interface. Additionally, users can buy their own data plans (profiles) using the most popular payment gateway - PayPal making it a great system for service providers. Customized reports can be generated to ease processing by the billing department. User Manager works according to RADIUS standards defined in and . RFC2865 RFC3579 User Manager is one of the RouterOS features, that is limited by the RouterOS license level. Depending on the , number of active sessions License level will be limited, including multiple connections per user (not unique accounts).

Attributes Sub-menu: /user-manager attribute RADIUS attributes are defined authorization, information, and configuration parameters that are passed between the RADIUS server and the client. User Manager allows sending customized attributes defined in the "attributes" menu. RouterOS has a set of predefined attributes already present, but it is also possible to add additional attributes if necessary. Predefined attributes: Attribute Vendor IDType IDValue type Packet typeDescription Framed-IP- Address0 (standard)8 ip address Access- AcceptRFC2865 section 5.8 Framed-IP- Netmask0 (standard)9 ip address Access- AcceptRFC2865 section 5.9 Session- Timeout0 (standard)27 integer Access- Accept, Access- ChallengeRFC2865 section 5.27 Idle- Timeout0 (standard)28 integer Access- Accept, Access- ChallengeRFC2865 section 5.28

Tunnel- Type0 (standard)64 Value Description 1 Point-to-Point Tunneling Protocol (PPTP) 2 Layer Two Forwarding (L2F) 3 Layer Two Tunneling Protocol (L2TP) 4 Ascend Tunnel Management Protocol (ATMP) 5 Virtual Tunneling Protocol (VTP) 6 IP Authentication Header in the Tunnel-mode (AH) 7 IP-in-IP Encapsulation (IP-IP) 8 Minimal IP-in- IP Encapsulation (MIN-IP-IP) 9 IP Encapsulating Security Payload in the Tunnel- mode (ESP) 10 Generic Route Encapsulation (GRE) 11 Bay Dial Virtual Services (DVS) 12 IP-in-IP Tunneling 13 Virtual LANAccess- AcceptRFC2868 section 3.1 RFC3580 section 3.31

Tunnel- Medium- Type0 (standard)65 Value Description 1 IPv4 (IP version 4) 2 IPv6 (IP version 6) 3 NSAP 4 HDLC (8-bit multidrop) 5 BBN 1822 6 802 (includes all 802 media plus Ethernet "canonical format") 7 E.163 (POTS) 8 E.164 (SMDS, Frame Relay, ATM) 9 F.69 (Telex) 10 X.121 (X.25, Frame Relay) 11 IPX 12 Appletalk 13 Decnet IV 14 Banyan Vines 15 E.164 with NSAP format subaddressAccess- AcceptRFC2868 section 3.2 Tunnel- Private- Group-ID0 (standard)81 string Access- AcceptRFC2868 section 3.6 Framed- Pool0 (standard)88 string Access- AcceptRFC2869 section 5.18 Framed- IPv6-Prefix0 (standard)97 ipv6 prefix Access- AcceptRFC3162 section 2.3 Framed- IPv6-Pool0 (standard)100 string Access- AcceptRFC3162 section 2.6 Delegated- IPv6-Prefix0 (standard)123 ipv6 prefix Access- AcceptRFC4818 Framed- IPv6- Address0 (standard)168 ip address Access- AcceptRFC6911 section 3.1 Mikrotik- Recv-Limit14988 (Mikrotik)1 integer Access- AcceptTotal receive limit in bytes for the client. Mikrotik- Xmit-Limit14988 (Mikrotik)2 integer Access- AcceptTotal transmit limit in bytes for the client. Mikrotik- Group14988 (Mikrotik)3 string Access- AcceptUser's group for local users. HotSpot profile for HotSpot users. PPP profile for PPP users. Mikrotik- Wireless- Forward14988 (Mikrotik)4 integer Access- AcceptNot forward the client's frames back to the wireless infrastructure if this attribute is set to "0" (wireless only). Mikrotik- Wireless- Skip-Dot1x14988 (Mikrotik)5 integer Access- AcceptDisable 802.1x authentication for the particular wireless client if set to a non-zero value (wireless only).

Mikrotik- DHCP- Option-Set14988 (Mikrotik)23 string Access- Accept Mikrotik- DHCP- Option- Param- STR114988 (Mikrotik)24 string Access- Accept Mikrotik- DHCP- Option- Param- STR214988 (Mikrotik)25 string Access- Accept Mikrotik- Wireless- VLANID14988 (Mikrotik)26 integer Access- AcceptVLAN ID for the client (Wireless only). Mikrotik- Wireless- VLANIDtype14988 (Mikrotik)27 Value Description 0 802.1q 1 802.1adAccess- AcceptVLAN ID type for the client (Wireless only). Mikrotik- Wireless- Minsignal14988 (Mikrotik)28 string Access- Accept Mikrotik- Wireless- Maxsignal14988 (Mikrotik)29 string Access- Accept Mikrotik- Switching- Filter14988 (Mikrotik)30 string Access- AcceptAllows to create dynamic switch rules when authenticating clients with dot1x server. Properties Property Description name ( ; Default: ) string Name of the attribute. packet-types ( ; Default: ) string access-accept access-accept - use this attribute in RADIUS Access-Accept messages access-challenge - use this attribute in RADIUS Access-Challenge messages type-id ( ; Default: ) integer:1..255 Attribute identification number from the specific vendor's attribute database. value-type ( ; Default: ) string hex ip-address - IPv4 or IPv6 IP address ip6-prefix - IPv6 prefix macro string uint32 vendor-id ( ; Default: ) integer 0 IANA allocated a specific enterprise identification number. Database Sub-menu: /user-manager database All RADIUS-related information is stored in a separate User Manager's database configurable under the "database" sub-menu. "Enabled" and "db-path" are the only parameters that are not stored in the User Manager's database and instead are stored in the main RouterOS configuration table meaning that these parameters will be affected by the RouterOS configuration reset. The rest of the configuration, session, and payment data is stored in a separate SQLite database on the FLASH storage of the device. When performing any actions with databases, it is advised to make a backup before and after any activity. Properties

Property Description db-path ( ; Default: ) string Path to the location where database files will be stored. Read-only properties Property Description db-size The current size of the database. free-disk-space Free space left on the disk where the database is stored. Commands Property Description load ( ) name Restore previously created backup file in .umb format. migrate-legacy-db (database-path; ) overwriteConvert the old User Manager (from RouterOS v6 or before) to the new standard. It is possible to overwrite the current database. optimize-db () save (name; overwrite) Save the current state of the User Manager database. Limitations Sub-menu: /user-manager limitation Limitations are used by Profiles and are linked together by Profile-Limitations. RADIUS accounting and Interim updates must be enabled to seamlessly switch between multiple limitations or disconnect active sessions when , or is reached. download-limit upload-limit uptime-limit To disconnect already active sessions from User Manager, must be set to on the RADIUS client side. If simultaneous session limits are not accept yes unlimited (shared-users) and it has reached the maximum allowed number, then the router will try to disconnect the older user session first. User-Manager attempts to disconnect an active session before a new user will be accepted (when the appropriate limit is set), that's why in such setups it is suggested to use 1s for /radius client timeout. Properties Property Description comment ( ; Default: ) string Short description of the limitation. download-limit ( ; Default: ) integer 0 The total amount of traffic a user can download in Bytes. name ( ; Default: ) string Unique name of the limitation. rate-limit-burst-rx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-burst-threshold-rx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-burst-threshold-tx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-burst-time-rx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-burst-time-tx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-burst-tx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue IPsec service in RouterOS does not support rate limitations.

rate-limit-min-rx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-min-tx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-priority () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-rx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue rate-limit-tx () Part of RADIUS attribute. Refer to . MT-Rate-Limit Queues#SimpleQueue reset-counters-interval ( | | | | ); hourly daily weekly monthly disabled Default: ) disabledThe interval from when all associated user reset-counters-start-time statistics are cleared. reset-counters-start-time ( ; Default: ) datetime Static date and time value from which is calculated. reset-counters-interval transfer-limit ( ; Default: ) integer 0 The total amount of aggregated (download+upload) traffic in Bytes. upload-limit ( ; Default: ) integer 0 The total amount of traffic a user can upload in Bytes. uptime-limit ( ; Default: ) time 00:00:00 The total amount of uptime a user can stay active. Payments Sub-menu: /user-manager payment Information about all received payments is available in this section. Read-only properties Property Description currency ( ) string The currency used in the transaction. method ( ) string Service used for the transaction (currently PayPal only). price ( ) decimal Amount paid by the user. profile ( ) profile Name of the profile the user purchased. trans-end ( ) datetime Date and time when the transaction started. trans-start ( ) datetime Date and time when the transaction ended. trans-status ( ) string Status of the transaction. Possible statuses - , , , , , , , . Only started pending approved declined error timeout aborted user approved a should be considered as a complete transaction. pproved user ( ; Default: string )Name of the user who performed the transaction. user-message (string ; Default: ) Profiles Sub-menu: /user-manager profile Properties Property Description comment ( ; Default: ) string Short description of the entry. name ( ; Default: ) string Unique name of the profile. name-for-users ( ; Default: ) string Name of the profile that will be shown for users on the Web page.

override-shared-users (decimal | off | ; Default: ) unlimited offWhether to allow multiple sessions with the same user name. This overrides the setting. shared-users price ( ; Default: ) decimal 0.00 starts-when ( | ; assigned first-auth Default: ) assignedThe time when does the profile become active. - immediately when a User Profile entry is created. Assigned Fir - upon first authentication request from the user. st-auth validity ( ; Default: time | unlimited unlimi )tedThe total amount of time a user can use this profile. Profile Limitations Sub-menu: /user-manager profile-limitation Profile-Limitations table links Limitations and Profiles together and defines their validity period. When multiple Limitations are assigned to the same Profile, a user must comply with all Limitations for the session to be established. This allows more complicated setups to be created, for example, separate monthly and daily bandwidth limits. Properties Property Description comment ( ; Default: ) string Short description of the entry. from-time ( ; Default: ) time 00:00:00 Time of day when the limitation should start. limitation ( ; Default: ) limitation Name of already created . Limitation profile ( ; Default: ) profile Name of already created . Profile till-time ( ; Default: ) time 23:59:59 Time of day when the limitation should end. weekdays ( ; Default: day of week Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, ) SaturdayDay of the week when the limitation should be active. Routers Sub-menu: /user-manager router Here you can define NAS devices that can use User Manager as a RADIUS server. Properties Property Description coa-port ( ; Default: ) integer:1..65535 3799 Port number of CoA (Change of Authorization) communication. address ( Default: ) IP/IPv6 ; IP address of the RADIUS client. comment ( ; Default: ) string Short description of the NAS. disabled ( ; Default: ) yes | no no Controls whether the entry is currently active or not. name ( ; Default: ) string Unique name of the RADIUS client. shared-secret ( ; Default: ) string Used to secure communication between a RADIUS server and a RADIUS client. Commands Property Description reset-counters () Clear all statistics for specific RADIUS client.

Sessions Sub-menu: /user-manager session Sessions are logged only if accounting is enabled on NAS. Read-only properties Property Description acct-session-id ( ) stringUnique identification of the accounting session. active ( ) yes | no Whether the session is currently used. calling-station-id ( ) stringUser's identifier, usually IP address or MAC address. download ( ) Bytes Amount of traffic downloaded. ended ( ) datetime Date and time when the session was closed. Empty for active sessions. last-accounting- packet ( ) datetimeDate and time when the last accounting update was received. nas-ip-address (I ) P addressThe IP address of the NAS. nas-port-id (string )Identifier of the NAS port that is authenticating the user. nas-port-type (str )ingThe port type ( or ) that is authenticating the user. physical virtual started ( ) datetime Date and time when the session was established. status (list of ) statusesPossible available statuses of a session: accounting message has been received, accounting message has start - Start stop - Stop been received, has been received, - session is successfully closed, interim - Interim update close-acked expired. terminate-cause ( ) stringThe reason why the session was closed. upload ( ) Bytes Amount of traffic uploaded. uptime ( )time Total logged uptime on the session. user ( ) string Name of the user. user-address (IP ) addressIP address provided to the user. Settings Sub-menu: /user-manager Properties Property Description accounting-port ( ; Default: ) integer 1813 Port to listen for RADIUS accounting requests. authentication-port ( ; Default: integer 1812 )Port to listen for RADIUS authentication requests. certificate ( ; Default: ) certificate Certificate for use in EAP TLS-type authentication methods.

enabled ( ; Default: ) yes | no no Whether the User Manager functionality is enabled. use-profiles ( ; Default: ) yes | no no Whether to use and . When set to only configuration is required to run User Profiles Limitations no, User Manager. Advanced Sub-menu: /user-manager advanced Properties Property Description paypal-allow ( ; Default: ) yes | no no Whether to enable PayPal functionality for User Manager. paypal-currency ( ; Default: ) string USD The currency related to setting in which users will be billed. price paypal-password ( ; Default: ) string The password of your PayPal API account. paypal-signature ( ; Default: ) string Signature of your PayPal API account. paypal-use-sandbox ( ; Default: ) yes | no no Whether to use PayPal's sandbox environment for testing purposes. paypal-user ( ; Default: ) string Username of your PayPal API account. web-private-password ( ; Default: ) string Password for accessing section over HTTP. /um/PRIVATE/ web-private-username ( ; Default: ) string Username for accessing section over HTTP. /um/PRIVATE/ Users Sub-menu: /user-manager user Properties Property Description attributes ( ; Default: ) array of attributes Custom set of with their values that will additionally be added to Access-Accept messages. Attributes caller-id ( ; Default: ) string Allow user's authentication with a specific value. Calling-Station-Id comment ( ; Default: ) string Short description of the user. disabled ( ; Default: ) yes | no no Controls whether the user can be used or not. group ( ; Default: ) group default Name of the the user is associated to. Group name ( ; Default: ) string Username for session authentication. otp-secret ( ; Default: ) string A one-time password token that is attached to the password. password ( ; Default: ) string The password of the user for session authentication. shared-users ( ; Default: ) integer | unlimited 1The total amount of sessions the user can simultaneously establish. Commands Property Description add-batch-users ()The command can generate multiple user accounts based on various parameters. generate-voucher ()Generates a file based on that can be presented to the end user. voucher-template

monitor () Shows total statistics for a user. Stats include , , , , , total-uptime total-download total-upload active-sessions actual-profile attributes- . details User Groups Sub-menu: /user-manager user group User groups define common characteristics of multiple users such as allowed authentication methods and RADIUS attributes. There are two groups already present in User Manager called and . default default-anonymous Properties Property Description attributes (array of ; Default: ) attributesCustom set of with their values that will additionally be added to Access-Accept messages for users in this group. Attributes comment ( ; string Default: )Short description of the group. inner-auths ( ; list of auths Default: )List of allowed authentication methods for tunneled (outer) authentication methods. Supported inner authentication methods - , , , , . ttls-pap ttls-chap ttls-mschap1 ttls-mschap2 peap-mschap2 name ( ; Default: ) string Unique name of the group. outer-auths ( ; list of auths Default: )List of allowed authentication methods. Supported outer authentication methods - , , , , , pap chap mschap1 mschap2 eap-tls ea , , . p-ttls eap-peap eap-mschap2 User Profiles Sub-menu: /user-manager user-profile This menu assigns users a profile and tracks the status of the profile. A single user can have multiple profiles assigned, however, only one can be used at the same time. A user will seamlessly be switched to the next profile when the currently active profile expires without dropping the user's session. Properties Property Description profile ( ; Default: ) profile Name of the profile to assign for user. user ( ; Default: )user Name of the user to use particular profile. Read-only properties Property Description end-time ( ) datetime Date and time the will expire. User Profile state ( | running active running | ) usedThe current state of the . currently used profile by the user. - a profile is ready to be User Profile Running active - Running used. - an expired profile that can no longer be activated. Used Commands Property Description activate-user-profile ()Make a entry active immediately. User Profile WEB Interface

/user-manager user set [find name=username] shared-users=1 attributes=Framed-IP-Address:192.168.1.4 Specifying address pool for a group of users We can group up multiple similar users and assign RADIUS attributes to all of them at once. First of all, create a new group: /user-manager user group add name=location1 outer-auths=chap,eap-mschap2,eap-peap,eap-tls,eap-ttls,mschap1,mschap2,pap \ inner-auths=peap-mschap2,ttls-chap,ttls-mschap1,ttls-mschap2,ttls-pap attributes=Framed-Pool:pool1 The next step is to assign a user to the group: /user-manager user set [find name=username] group=location1 In this case, an IP address from will be assigned to the user upon authentication - make sure is created on the NAS device. pool1 pool1 Using TOTP (time-based one-time password) for user authentication User Manager supports time-based authentication token addition to the user's password field that is regenerated every 30 seconds. TOTP works by having a shared secret on the supplicant (client) and the authentication server (User Manager). To configure TOTP on RouterOS, simply set the for the user. For example: otp-secret /user-manager user set [find name=username] password=mypass otp-secret=mysecret To calculate the TOTP token on the supplicant side, many widely available applications can be used, for example, Google Authenticator or . https://totp.app/ Adding mysecret to the TOTP token generator will provide a new unique 6-digit code that must be added to the user password. The following example will accept the user's authentication with a calculated TOTP token added to the common password until a new TOTP token is generated, for example, User-Name=username User-Password=mypass620872 Exporting user credentials OTP depends on the clock, so make sure time settings are configured correctly.

Printable login credentials for a single user To generate a single user's printable voucher card, simply use the command. Specify the RouterOS ID number of the user or use the generate-voucher find command to specify a username. A template is already included in User Manager's installation available in the Files section of your device. You can customize the template for your needs. /user-manager user generate-voucher voucher-template=printable_vouchers.html [find where name=username] The generated voucher card is available by accessing the router using a WEB browser and navigating to /um/PRIVATE/GENERATED/vouchers /gen_printable_vouchers.html By default, the printable card looks like this: It is possible to use different variables when generating vouchers. Currently, supported variables are: $(username) - Represents User Manager username $(password) - Password of the username $(userprofname) - Profile that is active for the particular user $(userprofendtime) - Profile validity end time if specified Multiple user credential export It is possible to generate a CSV or XML file with multiple or all user credentials at once by using the or as . export.xml export.csv voucher-template /user-manager user generate-voucher voucher-template=export.xml [find] The command generates an XML file which can either be accessible by the WEB browser or um5files/PRIVATE/GENERATED/vouchers/gen_export.xml any other file access tools. To access the PRIVATE path of the /um/ directory by the WEB browser, and must be configured. See private-username private-password Settin section.gs

<?xml version="1.0" encoding="UTF-8"?> <users> <user> <username>olsgkl</username> <password>86a6zH</password> </user> <user> <username>lkbwss</username> <password>jaKY5V</password> </user> <user> <username>cwxbwu</username> <password>a62yZd</password> </user> <user> <username>username</username> <password>secretpassword</password> </user> </users> Generating usage report In cases where presentable network usage information is required by companies billing or legal team an automated session export can be created using the command. The command requires an input of the report template - an example of the template is available in generate-report um5files/PRIVATE . Example of the report generation: /TEMPLATES/reports/report_default.html /user-manager generate-report report-template=report_default.html columns=username,uptime,download,upload The generated report is available by accessing the router using a WEB browser and navigating to /um/PRIVATE/GENERATED/reports/gen_report_default. html

Purchasing a profile After logging into the user's private profile by accessing the router's directory using a WEB browser, for example, he will be /um/ http://example.com/um/, able to see all available in the respective menu. Profiles that have specified values will have a button available. Profiles price Buy this Profile After pressing the button, the user will be asked to choose from available transaction service providers (currently only PayPal is available) Buy this Profile and later redirected to PayPal's payment processing page.

When the payment is completed, the User Manager will ask PayPal to approve the transaction. After approval, the profile is assigned to the user and is ready to use. Migrating from RouterOS v6 When you upgrade your User Manager router from RouterOS v6 to the v7 the new User Manager will work with new database files and configuration. To continue using the old user, router, profile, etc. configuration you must manually execute the migrate command. To do so you must have files from the old User Manager server folder "user-manager" present. The folder can be renamed, but all the contents from the old installation must be transferred to the new v7 installation (you can move the old configuration from one router to another router with v7, you must copy "user-manager" folder). After that, all you need to do is execute this command - "/user-manager/database/migrate-legacy-db database-path=<path_to_old_user_manager_folder>". The import process will try to convert such configuration - users, profiles, user-profiles, limitations, profile-limitations, user-counters, routers, and sessions. Application Examples Basic L2TP/IPsec server with User Manager authentication

User Manager configuration Start off by enabling User Manager functionality. /user-manager set enabled=yes Allow receiving RADIUS requests from the localhost (the router itself). /user-manager router add address=127.0.0.1 comment=localhost name=local shared-secret=test Next, add users and their credentials that clients will use to authenticate to the server. /user-manager user add name=user1 password=password Configuring RADIUS client For the router to use the RADIUS server for user authentication, it is required to add a new RADIUS client that has the same shared secret that we already configured on User Manager. /radius add address=127.0.0.1 secret=test service=ipsec L2TP/IPsec server configuration Configure the IP pool from which IP addresses will be assigned to the users and assign it to the PPP Profile. /ip pool add name=vpn-pool range=192.168.99.2-192.168.99.100 /ppp profile set default-encryption local-address=192.168.99.1 remote-address=vpn-pool Enable the use of RADIUS for PPP authentication.

Bridging and Switching Other resources: Summary Bridge Interface Setup Example Bridge Monitoring Spanning Tree Protocol Per-port STP Create edge ports Drop received BPDUs Enable BPDU guard Enable Root guard Bridge Settings Port Settings Example Interface lists Bridge Port Monitoring Hosts Table Monitoring Static entries Multicast Table Static entries Bridge Hardware Offloading Example Bridge VLAN Filtering Bridge VLAN table Bridge port settings Bridge host table VLAN Example - Trunk and Access Ports VLAN Example - Trunk and Hybrid Ports VLAN Example - InterVLAN Routing by Bridge Management access configuration Untagged access without VLAN filtering Tagged access without VLAN filtering Tagged access with VLAN filtering Untagged access with VLAN filtering Changing untagged VLAN for the bridge interface VLAN Tunneling (QinQ) Tag stacking MVRP Property Reference Fast Forward IGMP/MLD Snooping DHCP Snooping and DHCP Option 82 Controller Bridge and Port Extender Bridge Firewall Bridge Packet Filter Bridge NAT See also Summary

Ethernet-like networks (Ethernet, Ethernet over IP, IEEE 802.11 in ap-bridge or bridge mode, WDS, VLAN) can be connected together using MAC bridges. The bridge feature allows the interconnection of hosts connected to separate LANs (using EoIP, geographically distributed networks can be bridged as well if any kind of IP network interconnection exists between them) as if they were attached to a single LAN. As bridges are transparent, they do not appear in the traceroute list, and no utility can make a distinction between a host working in one LAN and a host working in another LAN if these LANs are bridged. However, depending on the way the LANs are interconnected, latency and data rate between hosts may vary. Network loops may emerge (intentionally or not) in complex topologies. Without any special treatment, loops would prevent the network from functioning normally, as they would lead to avalanche-like packet multiplication. Each bridge runs an algorithm that calculates how the loop can be prevented. (R/M)STP allows bridges to communicate with each other, so they can negotiate a loop-free topology. All other alternative connections that would otherwise form loops are put on standby, so that should the main connection fail, another connection could take its place. This algorithm exchanges configuration messages (BPDU - Bridge Protocol Data Unit) periodically, so that all bridges are updated with the newest information about changes in a network topology. (R/M)STP selects a root bridge which is responsible for network reconfiguration, such as blocking and opening ports on other bridges. The root bridge is the bridge with the lowest bridge ID. Bridge Interface Setup To combine a number of networks into one bridge, a bridge interface should be created. Later, all the desired interfaces should be set up as its ports. By default, bridge MAC address will be chosen automatically, depending on the bridge port configuration. To avoid unwanted MAC address changes, it is recommended to disable " " and manually specifying the MAC address by using " ". auto-mac admin-mac Sub-menu: /interface bridge Property Description add-dhcp-option82 (ye |; Default: ) s no noWhether to add DHCP Option-82 information (Agent Remote ID and Agent Circuit ID) to DHCP packets. Can be used together with Option-82 capable DHCP server to assign IP addresses and implement policies. This property only has an effect when is set to . dhcp-snooping yes admin-mac (MAC ; Default: address none )Static MAC address of the bridge. This property only has an effect when is set to . auto-mac no ageing-time ( ; time Default: ) 00:05:00How long a host's information will be kept in the bridge database.

1. 2. 3. arp ( | disabled | enabled local-proxy- arp | proxy-arp | reply- ; Default: ) only enabledAddress Resolution Protocol setting disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only respond to requests originating from matching IP address/MAC address combinations that are entered as static entries in the IP/ARP table. No dynamic entries will be automatically stored in the IP/ARP table. Therefore, for communications to be successful, a valid static entry must already exist. arp-timeout (auto | ; Default: ) integer autoHow long the ARP record is kept in the ARP table after no packets are received from IP address. Value equals to the auto value of in , default is . arp-timeout ip/settings 30s auto-mac ( ; yes | no Default: ) yesWhen is configured, the bridge will automatically select a MAC address for the bridge interface based on auto-mac=yes the following order of priority: From an Ethernet interface that is part of the bridge; From a non-Ethernet interface in the bridge (e.g., WiFi or tunnel); A randomly generated address if neither of the above is available. If the configuration is changed, for example, you add a new port to the bridge, the bridge’s MAC address will be updated only if a higher-priority address source becomes available. For example, if the bridge initially used a randomly generated MAC, then an Ethernet interface was added, the MAC would update according to the highest available priority (in this case, the Ethernet interface). The bridge will also update the MAC address if the current MAC is associated with a port that is moved to a different bridge. The current MAC address and its priority level are saved and will be reused after a reboot. When is configured, you can set a static MAC address manually using the property. auto-mac=no admin-mac comment ( ; string Default: )Short description of the interface. dhcp-snooping (yes | ; Default: ) no noEnables or disables DHCP Snooping on the bridge. disabled ( ; yes | no Default: ) noChanges whether the bridge is disabled. ether-type (0x9100 | ; 0x8100 | 0x88a8 Default: ) 0x8100Changes the EtherType, which will be used to determine if a packet has a VLAN tag. Packets that have a matching EtherType are considered as tagged packets. This property only has an effect when is set to . vlan-filtering yes fast-forward ( ; yes | no Default: ) yesSpecial and faster case of Fast Path which works only on bridges with 2 interfaces (enabled by default only for new bridges). More details can be found in the Fast Forward section. forward-delay ( ; time Default: ) 00:00:15The time which is spent during the initialization phase of the bridge interface (i.e., after router startup or enabling the interface) in the listening/learning state before the bridge will start functioning normally.

forward-reserved- addresses ( : yes | no Default: )noWhether to forward IEEE reserved multicast MAC address that are in range. Bridges compliant with the 01:80:C2:00:00:0x R/M/STP standards should refrain from forwarding these packets, t his property can only be applied when protocol-mode is set to none . Enabling forwarding of reserved MAC addresses may affect certain protocols relying on these addresses. It is advisable to enable forwarding only when absolutely necessary, such as in transparent bridging setups (e.g., extending long links, using bridge as media converters, or conducting network analysis). Here are some notable MAC addresses and protocols used by RouterOS: 01:80:C2:00:00:00 - ; Spanning Tree Protocol (STP) 01:80:C2:00:00:01 - Flow Control; Ethernet 01:80:C2:00:00:02 - ; Link Aggregation Control Protocol (LACP) 01:80:C2:00:00:03 - client and server; Dot1x 01:80:C2:00:00:08 - Spanning Tree Protocol (for 802.1ad bridges, using ); ether-type=0x88a8 01:80:C2:00:00:0D - ; Multiple VLAN Registration protocol (for 802.1ad bridges, using ) ether-type=0x88a8 01:80:C2:00:00:0E - and ; Link Layer Discovery Protocol Multi-chassis Link Aggregation Group frame-types (admit-all | admit-only-untagged- and-priority-tagged | admit-only-vlan- ; Default: tagged admit )-allSpecifies allowed frame types on a bridge port. This property only has an effect when is set to . vlan-filtering yes igmp-snooping (yes | ; Default: ) no noEnables multicast group and port learning to prevent multicast traffic from flooding all interfaces in a bridge. igmp-version ( ; 2 | 3 Default: ) 2Selects the IGMP version in which IGMP membership queries will be generated when the bridge interface is acting as an IGMP querier. This property only has an effect when and is set to . igmp-snooping multicast-querier yes ingress-filtering (yes | ; Default: ) no yesEnables or disables VLAN ingress filtering, which checks if the ingress port is a member of the received VLAN ID in the bridge VLAN table. By default, VLANs that don't exist in the bridge VLAN table are dropped before they are sent out (egress), but this property allows you to drop the packets when they are received (ingress). Should be used with frame- to specify if the ingress traffic should be tagged or untagged. This property only has an effect when types vlan- is set to . The setting is enabled by default since RouterOS v7. filtering yes l2mtu ( ; read-only Default: )L2MTU indicates the maximum size of the frame without a MAC header that can be sent by this interface. The L2MTU value will be automatically set by the bridge and it will use the lowest L2MTU value of any associated bridge port. This value cannot be manually changed. last-member-interval (t ; Default: ) ime 1sWhen the last client on the bridge port unsubscribes to a multicast group and the bridge is acting as an active querier, the bridge will send group-specific IGMP/MLD query, to make sure that no other client is still subscribed. The setting changes the response time for these queries. In case no membership reports are received in a certain time period ( last-member- * ), the multicast group is removed from the multicast database (MDB). interval last-member-query-count If the bridge port is configured with , the multicast group is removed right away without sending any queries. fast-leave This property only has an effect when and is set to . igmp-snooping multicast-querier yes last-member-query- count (integer: 0.. ; Default: 4294967295 2 )How many times should last-member-interval pass until the IGMP/MLD snooping bridge stops forwarding a certain multicast stream. This property only has an effect when igmp-snooping and multicast-querier is set to yes. max-hops (integer: 6.. ; Default: ) 40 20Bridge count which BPDU can pass in an MSTP enabled network in the same region before BPDU is being ignored. This property only has an effect when is set to . protocol-mode mstp The Flow Control MAC address 01:80:C2:00:00:01 is an exception, it does not get forwarded by the bridge.

max-learned-entries (i nteger: 0.. 4294967295 | auto | ; Default: unlimited auto )Sets the maximum number of learned hosts for the bridge interface. The default value is , and it depends on the auto installed amount of RAM. It is possible to set a higher value than the default or choose option, but it increases unlimited the risk of out-of-memory condition. The default values for certain RAM sizes: 8192 for 64 MB; 16384 for 128 MB; 32768 for 256 MB; 65536 for 512 MB; 131072 for 1024 MB or higher. This limit specifically applies to the bridge interface, not the hardware limits on the switch FDB table. Even if the bridge limit is reached, the switch can continue learn hosts up to its hardware limits and make correct forwarding decisions. However, these additional hosts will not show up in the " " table nor can be monitored. /interface bridge host Additionally, hitting this limit could impact MLAG host synchronization. This setting has been available since RouterOS version 7.16. max-message-age (ti ; Default: me: 6s..40s 0 ) 0:00:20Changes the Max Age value in BPDU packets, which is transmitted by the root bridge. A root bridge sends a BPDUs with Max Age set to max-message-age value and a Message Age of 0. Every sequential bridge will increment the Message Age before sending their BPDUs. Once a bridge receives a BPDU where Message Age is equal or greater than Max Age, the BPDU is ignored. This property only has an effect when is set to or . protocol-mode stp rstp membership-interval (t ; Default: ) ime 4m20sThe amount of time after an entry in the Multicast Database (MDB) is removed if no IGMP/MLD membership reports are received on a bridge port. This property only has an effect when igmp-snooping is set to yes. mld-version ( ; 1 | 2 Default: ) 1Selects the MLD version in which MLD membership queries will be generated, when the bridge interface is acting as an MLD querier. This property only has an effect when the bridge has an active IPv6 address, igmp-snooping and multica st-querier is set to yes. mtu ( ; Default: integer )autoMaximum transmission unit, by default, the bridge will set MTU automatically and it will use the lowest MTU value of any associated bridge port. The default bridge MTU value without any bridge ports added is 1500. The MTU value can be set manually, but it cannot exceed the bridge L2MTU or the lowest bridge port L2MTU. If a new bridge port is added with L2MTU which is smaller than the of the bridge (set by the property), then manually set value will be actual-mtu mtu ignored and the bridge will act as if is set. mtu=auto When adding VLAN interfaces on the bridge, and when VLAN is using higher MTU than default 1500, it is recommended to set manually the MTU of the bridge. multicast-querier (yes ; Default: ) | no noMulticast querier generates periodic IGMP/MLD general membership queries to which all IGMP/MLD capable devices respond with an IGMP/MLD membership report, usually a PIM (multicast) router or IGMP proxy generates these queries. By using this property you can make an IGMP/MLD snooping enabled bridge to generate IGMP/MLD general membership queries. This property should be used whenever there is no active querier (PIM router or IGMP proxy) in a Layer2 network. Without a multicast querier in a Layer2 network, the Multicast Database (MDB) is not being updated, the learned entries will timeout and IGMP/MLD snooping will not function properly. Only untagged IGMP/MLD general membership queries are generated, IGMP queries are sent with IPv4 0.0.0.0 source address, MLD queries are sent with IPv6 link-local address of the bridge interface. The bridge will not send queries if an external IGMP/MLD querier is detected (see the monitoring values and ). igmp-querier mld-querier This property only has an effect when is set to . igmp-snooping yes multicast-router (disab led | permanent | ; temporary-query Default: temporary- ) queryA multicast router port is a port where a multicast router or querier is connected. On this port, unregistered multicast streams and IGMP/MLD membership reports will be sent. This setting changes the state of the multicast router for a bridge interface itself. This property can be used to send IGMP/MLD membership reports to the bridge interface for further multicast routing or proxying. This property only has an effect when igmp-snooping is set to yes. disabled - disabled multicast router state on the bridge interface. Unregistered multicast and IGMP/MLD membership reports are not sent to the bridge interface regardless of what is configured on the bridge interface. permanent - enabled multicast router state on the bridge interface. Unregistered multicast and IGMP/MLD membership reports are sent to the bridge interface itself regardless of what is configured on the bridge interface. temporary-query - automatically detect multicast router state on the bridge interface using IGMP/MLD queries. name (; Default:text br ) idgeNName of the bridge interface.

port-cost-mode (long ; Default: ) | short longChanges the port path-cost and internal-path-cost mode for bridged ports, utilizing automatic values based on interface speed. This setting does not impact bridged ports with manually configured path-cost or internal-path-cost properties. Below are examples illustrating the path-costs corresponding to specific data rates (with proportionate calculations for intermediate rates): Data rate Long Short 10 Mbps 2,000,000 100 100 Mbps 200,000 19 1 Gbps 20,000 4 10 Gbps 2,000 2 25 Gbps 800 1 40 Gbps 500 1 50 Gbps 400 1 100 Gbps 200 1 For bonded interfaces, the highest path-cost among all bonded member ports is applied, this value remains unaffected by the total link speed of the bonding. For virtual interfaces ( VLAN, EoIP, VXLAN), as well as wifi, wireless, and 60GHz interfaces, a path-cost of 20,000 such as is assigned for long mode, and 10 for short mode. For dynamically bridged interfaces (e.g. wifi, wireless, PPP, VPLS), the path-cost defaults to 20,000 for long mode and 10 for short mode. However, this can be manually overridden by the service that dynamically adds interfaces to bridge, for instance, by using the CAPsMAN setting. datapath.bridge-cost Use to observe the applied path-cost. port monitor This property has an effect when is set to , , or . protocol-mode stprstp mstp priority (integer: 0.. 65535 decimal format or 0x0000-0xffff hex ; Default: format 32768 ) / 0x8000Bridge priority, used by R/STP to determine root bridge, used by MSTP to determine CIST and IST regional root bridge. This property has no effect when is set to . protocol-mode none protocol-mode (none ; | rstp | stp | mstp Default: ) rstpSelect Spanning tree protocol (STP) or Rapid spanning tree protocol (RSTP) to ensure a loop-free topology for any bridged LAN. RSTP provides a faster spanning tree convergence after a topology change. Select MSTP to ensure loop- free topology across multiple VLANs. The forwarding of reserved MAC addresses that are in range is separated the 01:80:C2:00:00:0x from protocol- , and is now available as a controllable property since mode=none forward-reserved-addresses RouterOS v7.16. pvid ( ; integer: 1..4094 Default: ) 1Port VLAN ID (pvid) specifies which VLAN the untagged ingress traffic is assigned to. It applies e.g. to frames sent from bridge IP and destined to a bridge port. This property only has an effect when is set to . vlan-filtering yes querier-interval ( ; time Default: ) 4m15sChanges the timeout period for detected querier and multicast-router ports. This property only has an effect when igmp- is set to . snooping yes query-interval ( ; time Default: ) 2m5sChanges the interval on how often IGMP/MLD general membership queries are sent out when the bridge interface is acting as an IGMP/MLD querier. The interval takes place when the last startup query is sent. This property only has an effect when igmp-snooping and multicast-querier is set to yes. query-response- interval ( ; Default:time )10sThe setting changes the response time for general IGMP/MLD queries when the bridge is active as an IGMP/MLD querier. This property only has an effect when igmp-snooping and multicast-querier is set to yes. region-name (; text Default: )MSTP region name. This property only has an effect when is set to . protocol-mode mstp

Create edge ports Setting a bridge port as an edge port will restrict it from sending BPDUs and will ignore any received BPDUs: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 edge=yes add bridge=bridge1 interface=ether2 Drop received BPDUs The bridge filter or NAT rules cannot drop BPDUs when the bridge has STP/RSTP/MSTP enabled due to the special processing of BPDUs. However, dropping received BPDUs on a certain port can be done on some switch chips using ACL rules: On CRS3xx: /interface ethernet switch rule add dst-mac-address=01:80:C2:00:00:00/FF:FF:FF:FF:FF:FF new-dst-ports="" ports=ether1 switch=switch1 On CRS1xx/CRS2xx with Access Control List (ACL) support : /interface ethernet switch acl add action=drop mac-dst-address=01:80:C2:00:00:00 src-ports=ether1 In this example all received BPDUs on ether1 are dropped. Enable BPDU guard In this example, if receives a BPDU, it will block the port and will require you to manually re-enable it. ether1 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 bpdu-guard=yes add bridge=bridge1 interface=ether2 Enable Root guard In this example, is configured with It prevented the port from becoming the root port for the CIST or any MSTI, ether1 restricted-role=yes. regardless of its best spanning tree priority vector. Such a port will be selected as an Alternate Port (discarding state) and remains so as long as it continues to receive superior BPDUs. It will automatically transition to the forwarding state when it no longer detects a superior root path. Network administrators may enable this setting to safeguard against external bridges influencing the active spanning tree. Be careful when changing the default (R/M)STP functionality, make sure you understand the working principles of STP and BPDUs. Misconfigured (R/M)STP can cause unexpected behavior. If you intend to drop received BPDUs on a port, then make sure to prevent BPDUs from being sent out from the interface that this port is connected to. A root bridge always sends out BPDUs and under normal conditions is waiting for a more superior BPDU (from a bridge with a lower bridge ID), but the bridge must temporarily disable the new root-port when transitioning from a root bridge to a designated bridge. If you have blocked BPDUs only on one side, then a port will flap continuously.

bridge-fast- path-bytes (int ; Default:eger )Shows byte count forwarded by bridge Fast Path. bridge-fast- forward- packets (integ ; Default:er )Shows packet count forwarded by bridge Fast Forward. bridge-fast- forward-bytes ( ; integer Default: )Shows byte count forwarded by bridge Fast Forward. Port Settings Port submenu is used to add interfaces in a particular bridge. Sub-menu: /interface bridge port Property Description auto-isolate (y ; es | no Default: ) noWhen enabled, prevents a port moving from discarding into forwarding state if no BPDUs are received from the neighboring bridge. The port will change into a forwarding state only when a BPDU is received. This property only has an effect when protoco is set to or and is set to . l-mode rstp mstp edge no bpdu-guard (y ; es | no Default: ) noEnables or disables BPDU Guard feature on a port. This feature puts the port in a disabled role if it receives a BPDU and requires the port to be manually disabled and enabled if a BPDU was received. Should be used to prevent a bridge from BPDU related attacks. This property has no effect when is set to . protocol-mode none bridge ( ; name Default: ) noneThe bridge interface where the respective interface is grouped in. broadcast- flood ( ; yes | no Default: ) yesWhen enabled, bridge floods broadcast traffic to all bridge egress ports. When disabled, drops broadcast traffic on egress ports. Can be used to filter all broadcast traffic on an egress port. Broadcast traffic is considered as traffic that uses a FF:FF:FF:FF:FF:FF s destination MAC address, such traffic is crucial for many protocols such as DHCP, ARP, NDP, BOOTP (Netinstall), and others. This option does not limit traffic flood to the CPU. edge (auto | no | no- discover | yes ; | yes-discover Default: ) autoSet port as edge port or non-edge port, or enable edge discovery. Edge ports are connected to a LAN that has no other bridges attached. An edge port will skip the learning and the listening states in STP and will transition directly to the forwarding state, this reduces the STP initialization time. If the port is configured to discover edge port then as soon as the bridge detects a BPDU coming to an edge port, the port becomes a non-edge port. This property has no effect when is set to . protocol-mode none no- non-edge port, will participate in learning and listening states in STP. no-discover - non-edge port with enabled discovery, will participate in learning and listening states in STP, a port can become an edge port if no BPDU is received. yes - edge port without discovery, will transit directly to forwarding state. yes-discover - edge port with enabled discovery, will transit directly to forwarding state. auto - same as , but will additionally detect if a bridge port is a Wireless interface with disabled bridge-mode, no-discover such interface will be automatically set as an edge port without discovery. fast-leave (yes ; Default:| no no )Enables IGMP/MLD fast leave feature on the bridge port. The bridge will stop forwarding multicast traffic to a bridge port when an IGMP/MLD leave message is received. This property only has an effect when is set to . igmp-snooping yes In case you want to assign Simple Queues or global Queue Trees to traffic that is being forwarded by a bridge, then you need to enable the property. Without using this property the bridge traffic will never reach the postrouting chain, Simple Queues and global use-ip-firewall Queue Trees are working in the postrouting chain. To assign Simple Queues or global Queue Trees for VLAN or PPPoE traffic in a bridge you should enable appropriate properties as well.

frame-types (a dmit-all | admit-only- untagged-and- priority-tagged | admit-only- ; vlan-tagged Default: admit- )allSpecifies allowed ingress frame types on a bridge port. This property only has an effect when is set to . vlan-filtering yes ingress- filtering (yes | ; Default:no yes )Enables or disables VLAN ingress filtering, which checks if the ingress port is a member of the received VLAN ID in the bridge VLAN table. Should be used with to specify if the ingress traffic should be tagged or untagged. This property only frame-types has effect when is set to . The setting is enabled by default since RouterOS v7. vlan-filtering yes learn (auto | ; no | yes Default: ) autoChanges MAC learning behavior on a bridge port yes - enables MAC learning no- disables MAC learning auto - detects if bridge port is a Wireless interface and uses a Wireless registration table instead of MAC learning, will use Wireless registration table if the Wireless interface is set to one of , , mode and bridge mode ap-bridge bridge wds-slave for the Wireless interface is disabled. multicast- router (disable d | permanent | temporary- ; Default: query temporary- ) queryA multicast router port is a port where a multicast router or querier is connected. On this port, unregistered multicast streams and IGMP/MLD membership reports will be sent. This setting changes the state of the multicast router for bridge ports. This property can be used to send IGMP/MLD membership reports to certain bridge ports for further multicast routing or proxying. This property only has an effect when igmp-snooping is set to yes. disabled - disabled multicast router state on the bridge port. Unregistered multicast and IGMP/MLD membership reports are not sent to the bridge port regardless of what is connected to it. permanent - enabled multicast router state on the bridge port. Unregistered multicast and IGMP/MLD membership reports are sent to the bridge port regardless of what is connected to it. temporary-query - automatically detect multicast router state on the bridge port using IGMP/MLD queries. horizon (intege r 0.. ; 429496729 Default: ) noneUse split horizon bridging to prevent bridging loops. Set the same value for a group of ports, to prevent them from sending data to ports with the same horizon value. Split horizon is a software feature that disables hardware offloading. Read more about Bridge . split horizon hw ( ; yes | no Default: )yesAllows to enable or disable on interfaces capable of HW offloading. For software interfaces like or hardware offloading EoIP VLAN this setting is ignored and has no effect. Certain bridge or port functions can automatically disable HW offloading, use the print command to see whether the "H" flag is active. internal-path- cost (integer: ; 1..200000000 Default: ) Path cost to the interface for MSTI0 inside a region. If not manually configured, the bridge automatically determines the internal- path-cost based on the interface speed and the setting. To revert to the automatic determination and remove port-cost-mode any manually applied value, simply use an exclamation mark before the property. This property only has internal-path-cost effect when is set to . protocol-mode mstp /interface bridge port set [find interface=sfp28-1] !internal-path-cost Use to observe the applied internal-path-cost. port monitor interface (name ; Default: ) noneName of the interface or interface list. path-cost (inte ger: 1.. ; 200000000 Default: ) Path cost to the interface, used by STP and RSTP to determine the best path, and used by MSTP to determine the best path between regions. If not manually configured, the bridge automatically determines the path-cost based on the interface speed and the setting. To revert to the automatic determination and remove any manually applied value, simply use an port-cost-mode exclamation mark before the property. This property has no effect when is set to . path-cost protocol-mode none /interface bridge port set [find interface=sfp28-1] !path-cost Use to observe the applied path-cost. port monitor

point-to-point ( ; auto | yes | no Default: ) autoSpecifies if a bridge port is connected to a bridge using a point-to-point link for faster convergence in case of failure. By setting this property to , you are forcing the link to be a point-to-point link, which will skip the checking mechanism, which detects and yes waits for BPDUs from other devices from this single link. By setting this property to , you are expecting that a link can receive no BPDUs from multiple devices. By setting the property to , you are significantly improving (R/M)STP convergence time. In yes general, you should only set this property to if it is possible that another device can be connected between a link, this is mostly no relevant to Wireless mediums and Ethernet hubs. If the Ethernet link is full-duplex, enables point-to-point functionality. This auto property has no effect when is set to . protocol-mode none priority (integer ; : 0..240 Default: ) 128The priority of the interface, used by STP to determine the root port, used by MSTP to determine root port between regions. pvid (integer ; 1..4094 Default: ) 1Port VLAN ID (pvid) specifies which VLAN the untagged ingress traffic is assigned to. This property only has an effect when vlan- is set to . filtering yes restricted-role ( ; yes | no Default: ) noEnables or disables the restricted role on a port. When enabled, it prevents the port from becoming the root port for the CIST or any MSTI, regardless of its best spanning tree priority vector. Such a port will be selected as an Alternate Port (discarding state) and remains so as long as it continues to receive superior BPDUs. It will automatically transition to the forwarding state when it no longer detects a superior root path. Network administrators may enable this setting to safeguard against external bridges influencing the active spanning tree, a feature also known as root-guard or root-protection. This property has an effect when prot is set to , (support for STP and RSTP is available since RouterOS v7.14). ocol-mode stprstp , or mstp restricted-tcn ( ; yes | no Default: ) noEnables or disables topology change notification (TCN) handling on a port. When enabled, it causes the port not to propagate received topology change notifications to other ports, and any changes caused by the port itself does not result in topology change notification to other ports. This parameter is disabled by default. It can be set by a network administrator to prevent external bridges causing MAC address flushing in local network. This property has an effect when is set to , protocol-mode stp (support for STP and RSTP is available since RouterOS v7.14). rstp , or mstp tag-stacking (y ; es | no Default: ) noForces all packets to be treated as untagged packets. Packets on ingress port will be tagged with another VLAN tag regardless if a VLAN tag already exists, packets will be tagged with a VLAN ID that matches the value and will use EtherType that is pvid specified in . This property only has effect when is set to . ether-type vlan-filtering yes trusted (yes | ; Default: ) no noWhen enabled, it allows forwarding DHCP packets towards the DHCP server through this port. Mainly used to limit unauthorized servers to provide malicious information for users. This property only has an effect when is set to . dhcp-snooping yes unknown- multicast-flood ( ; yes | no Default: ) yesChanges the multicast flood option on bridge port, only controls the egress traffic. When enabled, the bridge allows flooding multicast packets to the specified bridge port, but when disabled, the bridge restricts multicast traffic from being flooded to the specified bridge port. The setting affects all multicast traffic, this includes non-IP, IPv4, IPv6 and the link-local multicast ranges (e. g. 224.0.0.0/24 and ). ff02::1 Note that when is enabled and IGMP/MLD querier is detected, the bridge will automatically restrict unknown IP igmp-snooping multicast from being flooded, so the setting is not mandatory for IGMP/MLD snooping setups. When using this setting together with , the only multicast traffic that is allowed on the bridge port is the known igmp-snooping multicast from the MDB table. unknown- unicast-flood ( ; yes | no Default: ) yesChanges the unknown unicast flood option on bridge port, only controls the egress traffic. When enabled, the bridge allows flooding unknown unicast packets to the specified bridge port, but when disabled, the bridge restricts unknown unicast traffic from being flooded to the specified bridge port. If a MAC address is not learned in , then the traffic is considered as unknown unicast traffic and will be flooded to all the host table ports. MAC address is learned as soon as a packet on a bridge port is received and the source MAC address is added to the bridge host table. Since it is required for the bridge to receive at least one packet on the bridge port to learn the MAC address, it is recommended to use static bridge host entries to avoid packets being dropped until the MAC address has been learned. Example To group ether1 and ether2 in the already created bridge1 interface. RouterOS can handle a maximum of 1024 bridged interfaces per bridge, this limit is fixed and cannot be modified. If you try to add more interfaces as bridge ports, it may lead to unpredictable behavior.

1. 2. 3. 4. 5. 6. 7. [Atheros8227] + + - - - - - - [Atheros7240] + + - - - - - - [IPQ-PPE] +6 - - - - - - - [ICPlus175D] + - - - - - - - [MT7621, MT7531, EN7562CT] + + 3+ 3 - - + 3 - - [RTL8367] + + 3+ 3 - - + 3 - - [88E6393X, 88E6191X, ] 88E6190+ + + + + + 3+ 7 - Footnotes: The feature will not work properly in VLAN switching setups. It is possible to correctly snoop DHCP packets only for a single VLAN, but this requires that these DHCP messages get tagged with the correct VLAN tag using an ACL rule, for example, /interface ethernet switch acl add dst-l3-port=67-68 ip-protocol=udp mac-protocol=ip new-customer-vid=10 src-ports=switch1- . DHCP Option 82 will not contain any information regarding VLAN-ID.cpu The feature will not work properly in VLAN switching setups. The HW vlan-filtering and R/M/STP was added in the RouterOS 7.1rc1 (for RTL8367) and 7.1rc5 (for MT7621) versions. The switch does not support other ether-type 0x88a8 or 0x9100 (only 0x8100 is supported) and no tag-stacking. Using these features will disable HW offload. The HW offloading will be disabled only for the specific bridge port, not the entire bridge. Only and modes can be HW offloaded. Other bonding modes do not support HW offloading. 802.3ad balance-xor Currently, HW offloaded bridge support for the IPQ-PPE switch chip is still a work in progress. We recommend using, the default, non-HW offloaded bridge (enabled RSTP). The mode is compatible only with R/M/STP enabled bridge. 802.3ad Bridge Hardware Offloading should be considered as port switching, but with more possible features. By enabling hardware offloading you are allowing a built-in switch chip to process packets using its switching logic. The diagram below illustrates that switching occurs before any software related action. A packet that is received by one of the ports always passes through the switch logic first. Switch logic decides which ports the packet should be going to (most commonly this decision is made based on the destination MAC address of a packet, but there might be other criteria that might be involved based on the packet and the configuration). In most cases the packet will not be visible to RouterOS (only statistics will show that a packet has passed through), this is because the packet was already processed by the switch chip and never reached the CPU. When upgrading from older versions (before RouterOS v6.41), only the master-port configuration is converted. For each master-port a bridge will be created. VLAN configuration is not converted and should not be changed, check the guide to be sure Basic VLAN switching how VLAN switching should be configured for your device.

Bridge VLAN table Bridge VLAN table represents per-VLAN port mapping with an egress VLAN tag action. ports send out frames with a corresponding The tagged VLAN ID tag. ports remove a VLAN tag before sending out frames. Bridge ports with set to or The untagged frame-types admit-all admit- will be automatically added as untagged ports for the VLAN. only-untagged-and-priority-tagged pvid Sub-menu: /interface bridge vlan Property Description bridge ( ; Default: name n )oneThe bridge interface which the respective VLAN entry is intended for. disabled ( ; yes | no Default: ) noEnables or disables Bridge VLAN entry. tagged ( ; interfaces Default: ) noneInterfaces or with a VLAN tag adding action in egress. This setting accepts comma-separated values. e.g. interface list ta . =ether1,ether2gged untagged ( ; interfaces Default: ) noneInterfaces or with a VLAN tag removing action in egress. This setting accepts comma-separated values. e.g. interface list =ether3,ether4. untagged vlan-ids (integer 1..4094 ; Default: ) 1The list of VLAN IDs for certain port configuration. This setting accepts the VLAN ID range as well as comma-separated values. e.g. . =100-115,120,122,128-130 vlan-ids Bridge port settings Each bridge port have multiple VLAN related settings, that can change untagged VLAN membership, VLAN tagging/untagging behavior and packet filtering based on VLAN tag presence. Sub-menu: /interface bridge port Property Description Currently, CRS3xx, CRS5xx series switches, CCR2116, CCR2216 routers and RTL8367, 88E6393X, 88E6191X, 88E6190, MT7621 and switch chips (since RouterOS v7) are capable of using bridge VLAN filtering and hardware offloading at the same time, other MT7531 devices will not be able to use the benefits of a built-in switch chip when bridge VLAN filtering is enabled. Other devices should be configured according to the method described in the guide. If an improper configuration method is used, your device Basic VLAN switching can cause throughput issues in your network. The parameter can be used to specify a set or range of VLANs, but specifying multiple VLANs in a single bridge VLAN table vlan-ids entry should only be used for ports that are tagged ports. In case multiple VLANs are specified for access ports, then tagged packets might get sent out as untagged packets through the wrong access port, regardless of the PVID value. Make sure you have added all needed interfaces to the bridge VLAN table when using bridge VLAN filtering. For routing functions to work properly on the same device through ports that use bridge VLAN filtering, you will need to allow access to the bridge interface (this automatically include a switch-cpu port when HW offloaded vlan-filtering is used, e.g. on CRS3xx series switches), this can be done by adding the bridge interface itself to the VLAN table, for tagged traffic you will need to add the bridge interface as a tagged port and create a VLAN interface on the bridge interface. Examples can be found in the inter-VLAN routing and Management port sections. When allowing access to the CPU, you are allowing access from a certain port to the actual router/switch, this is not always desirable. Make sure you implement proper firewall filter rules to secure your device when access to the CPU is allowed from a certain VLAN ID and port, use firewall filter rules to allow access to only certain services. Improperly configured bridge VLAN filtering can cause security issues, make sure you fully understand how works Bridge VLAN table before deploying your device into production environments.

Create a bridge with disabled to avoid losing access to the device before VLANs are completely configured. If you need a vlan-filtering management access to the bridge, see the section. Management access configuration /interface bridge add name=bridge1 vlan-filtering=no Add bridge ports and specify for access ports to assign their untagged traffic to the intended VLAN. Use setting to accept only pvid frame-types tagged or untagged packets. /interface bridge port add bridge=bridge1 interface=ether2 frame-types=admit-only-vlan-tagged add bridge=bridge1 interface=ether6 pvid=200 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether7 pvid=300 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether8 pvid=400 frame-types=admit-only-untagged-and-priority-tagged Add Bridge VLAN entries and specify tagged ports in them. Bridge ports with frame-types set to admit-only-untagged-and-priority- tagged will be automatically added as untagged ports for the pvid VLAN. /interface bridge vlan add bridge=bridge1 tagged=ether2 vlan-ids=200 add bridge=bridge1 tagged=ether2 vlan-ids=300 add bridge=bridge1 tagged=ether2 vlan-ids=400 In the end, when VLAN configuration is complete, enable Bridge VLAN Filtering. /interface bridge set bridge1 vlan-filtering=yes Optional step is to set on the bridge interface in order to disable the default untagged VLAN 1 ( ). frame-types=admit-only-vlan-tagged pvid=1 /interface bridge set bridge1 frame-types=admit-only-vlan-tagged VLAN Example - Trunk and Hybrid Ports

Create a bridge with disabled vlan-filtering to avoid losing access to the router before VLANs are completely configured. If you need a management access to the bridge, see the section. Management access configuration /interface bridge add name=bridge1 vlan-filtering=no Add bridge ports and specify on hybrid VLAN ports to assign untagged traffic to the intended VLAN. Use setting to accept only pvid frame-types tagged packets on ether2. /interface bridge port add bridge=bridge1 interface=ether2 frame-types=admit-only-vlan-tagged add bridge=bridge1 interface=ether6 pvid=200 add bridge=bridge1 interface=ether7 pvid=300 add bridge=bridge1 interface=ether8 pvid=400 Add Bridge VLAN entries and specify tagged ports in them. In this example egress VLAN tagging is done on ether6,ether7,ether8 ports too, making them into hybrid ports. Bridge ports with frame-types set to admit-all will be automatically added as untagged ports for the pvid VLAN. /interface bridge vlan add bridge=bridge1 tagged=ether2,ether7,ether8 vlan-ids=200 add bridge=bridge1 tagged=ether2,ether6,ether8 vlan-ids=300 add bridge=bridge1 tagged=ether2,ether6,ether7 vlan-ids=400 In the end, when VLAN configuration is complete, enable Bridge VLAN Filtering. /interface bridge set bridge1 vlan-filtering=yes Optional step is to set on the bridge interface in order to disable the default untagged VLAN 1 ( ). frame-types=admit-only-vlan-tagged pvid=1

/interface bridge set bridge1 frame-types=admit-only-vlan-tagged VLAN Example - InterVLAN Routing by Bridge Create a bridge with disabled to avoid losing access to the router before VLANs are completely configured. vlan-filtering If you need a management access to the bridge, see the section. Management access configuration /interface bridge add name=bridge1 vlan-filtering=no Add bridge ports and specify pvid for VLAN access ports to assign their untagged traffic to the intended VLAN. Use setting to accept frame-types only untagged packets. /interface bridge port add bridge=bridge1 interface=ether6 pvid=200 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether7 pvid=300 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether8 pvid=400 frame-types=admit-only-untagged-and-priority-tagged Add Bridge VLAN entries and specify tagged ports in them. In this example bridge1 interface is the VLAN trunk that will send traffic further to do InterVLAN routing. Bridge ports with frame-types set to admit-only-untagged-and-priority-tagged will be automatically added as untagged ports for the pvid VLAN. You don't have to add access ports as untagged ports, because they will be added dynamically as an untagged port with the VLAN ID that is specified in , you can specify just the trunk port as a tagged port. All ports that have the same set will be added as untagged pvid pvid ports in a single entry. You must take into account that the bridge itself is a port and it also has a value, this means that the bridge pvid port also will be added as an untagged port for the ports that have the same . You can circumvent this behavior by either setting pvid different on all ports (even the trunk port and bridge itself), or to use set to . pvid frame-type accept-only-vlan-tagged

/interface bridge vlan add bridge=bridge1 tagged=bridge1 vlan-ids=200 add bridge=bridge1 tagged=bridge1 vlan-ids=300 add bridge=bridge1 tagged=bridge1 vlan-ids=400 Configure VLAN interfaces on the bridge1 to allow handling of tagged VLAN traffic at routing level and set IP addresses to ensure routing between VLANs as planned. /interface vlan add interface=bridge1 name=VLAN200 vlan-id=200 add interface=bridge1 name=VLAN300 vlan-id=300 add interface=bridge1 name=VLAN400 vlan-id=400 /ip address add address=20.0.0.1/24 interface=VLAN200 add address=30.0.0.1/24 interface=VLAN300 add address=40.0.0.1/24 interface=VLAN400 In the end, when VLAN configuration is complete, enable Bridge VLAN Filtering: /interface bridge set bridge1 vlan-filtering=yes Optional step is to set on the bridge interface in order to disable the default untagged VLAN 1 ( ). frame-types=admit-only-vlan-tagged pvid=1 /interface bridge set bridge1 frame-types=admit-only-vlan-tagged Since RouterOS v7, it is possible to route traffic using the L3 HW offloading on certain devices. See more details on . L3 Hardware Offloading Management access configuration There are multiple ways to set up management access on a device that uses bridge VLAN filtering. Below are some of the most popular approaches to properly enable access to a router/switch. Start by creating a bridge without VLAN filtering enabled: /interface bridge add name=bridge1 vlan-filtering=no Untagged access without VLAN filtering In case VLAN filtering will not be used and access with untagged traffic is desired, the only requirement is to create an IP address on the bridge interface. /ip address add address=192.168.99.1/24 interface=bridge1 Tagged access without VLAN filtering In case VLAN filtering will not be used and access with tagged traffic is desired, create a routable VLAN interface on the bridge and add an IP address on the VLAN interface. /interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.1/24 interface=MGMT Tagged access with VLAN filtering

In case VLAN filtering is used and access with tagged traffic is desired, additional steps are required. In this example, VLAN 99 will be used to access the device. A VLAN interface on the bridge must be created and an IP address must be assigned to it. /interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.1/24 interface=MGMT For example, if you want to allow access to the device from ports , using tagged VLAN 99 traffic, then you must add this ether3 ether4, sfp-sfpplus1 entry to the VLAN table. Note that the interface is also included in the tagged port list: bridge1 /interface bridge vlan add bridge=bridge1 tagged=bridge1,ether3,ether4,sfp-sfpplus1 vlan-ids=99 After that you can enable VLAN filtering: /interface bridge set bridge1 vlan-filtering=yes Untagged access with VLAN filtering In case VLAN filtering is used and access with untagged traffic is desired, the VLAN interface must use the same VLAN ID as the untagged port VLAN ID ( ). Just like in the previous example, start by creating a VLAN interface on the bridge and add an IP address for the VLAN.pvid /interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.1/24 interface=MGMT For example, untagged ports and should be able to communicate with the VLAN 99 interface using untagged traffic. In order to achieve ether2 ether3 this, these ports should be configured with the that matches the VLAN ID on management VLAN. Note that the interface is a tagged port pvid bridge1 member, you can configure additional tagged ports if necessary (see the previous example). /interface bridge port set [find interface=ether2] pvid=99 set [find interface=ether3] pvid=99 /interface bridge vlan add bridge=bridge1 tagged=bridge1 untagged=ether2,ether3 vlan-ids=99 After that you can enable VLAN filtering: /interface bridge set bridge1 vlan-filtering=yes Changing untagged VLAN for the bridge interface In case VLAN filtering is used, it is possible to change the untagged VLAN ID for the bridge interface using the setting. Note that creating pvid routable VLAN interfaces and allowing tagged traffic on the bridge is a more flexible and generally recommended option. First, create an IP address on the bridge interface. /ip address add address=192.168.99.1/24 interface=bridge1 For example, untagged traffic should be able to communicate with untagged and ports and tagged port in VLAN 99. bridge1 ether2 ether3 sfp-sfpplus1 In order to achieve this, , , should be configured with the same and sfp-sfpplus1 added as a tagged member. bridge1 ether2 ether3 pvid

/interface bridge set [find name=bridge1] pvid=99 /interface bridge port set [find interface=ether2] pvid=99 set [find interface=ether3] pvid=99 /interface bridge vlan add bridge=bridge1 tagged=sfp-sfpplus1 untagged=bridge1,ether2,ether3 vlan-ids=99 After that you can enable VLAN filtering: /interface bridge set bridge1 vlan-filtering=yes VLAN Tunneling (QinQ) Since RouterOS v6.43 the RouterOS bridge is IEEE 802.1ad compliant and it is possible to filter VLAN IDs based on Service VLAN ID (0x88a8) rather than Customer VLAN ID (0x8100). The same principles can be applied as with IEEE 802.1Q VLAN filtering (the same setup examples can be used). Below is a topology for a common : Provider bridge In this example, ,, and might be sending any VLAN tagged traffic by 802.1Q (CVID), but and needs isolate traffic between R1 R2 R3, R4 SW1 SW2 routers in a way that is able to communicate only with ,and is only able to communicate with . To do so, you can tag all ingress traffic R1 R3 R2 R4 with an SVID and only allow these VLANs on certain ports. Start by enabling the service tag 0x88a8, introduced by , on the bridge. Use 802.1ad these commands on and : SW1 SW2 /interface bridge add name=bridge1 vlan-filtering=no ether-type=0x88a8 In this setup, ether1 and ether2 are going to be access ports (untagged), use the pvid parameter to tag all ingress traffic on each port, use these commands on SW1 and SW2 : /interface bridge port add interface=ether1 bridge=bridge1 pvid=200 add interface=ether2 bridge=bridge1 pvid=300 add interface=ether3 bridge=bridge1 Specify tagged and untagged ports in the bridge VLAN table, use these commands on SW1 and SW2 : If the connection to the router/switch through an IP address is not required, then steps adding an IP address can be skipped since a connection to the router/switch through Layer2 protocols (e.g. MAC-telnet) will be working either way.

/interface bridge vlan add bridge=bridge1 tagged=ether3 untagged=ether1 vlan-ids=200 add bridge=bridge1 tagged=ether3 untagged=ether2 vlan-ids=300 When the bridge VLAN table is configured, you can enable bridge VLAN filtering, use these commands on SW1 and SW2: /interface bridge set bridge1 vlan-filtering=yes Tag stacking Since RouterOS v6.43 it is possible to forcefully add a new VLAN tag over any existing VLAN tags, this feature can be used to achieve a CVID stacking setup, where a CVID (0x8100) tag is added before an existing CVID tag. This type of setup is very similar to Provider bridge setup, to the achieve the same setup but with multiple CVID tags (CVID stacking) we can use the same topology: In this example ,, and might be sending any VLAN tagged traffic, it can be 802.1ad, 802.1Q or any other type of traffic, but and R1 R2 R3, R4 SW1 SW2 needs isolate traffic between routers in a way that is able to communicate only with ,and is only able to communicate with . To do so, R1 R3 R2 R4 you can tag all ingress traffic with a new CVID tag and only allow these VLANs on certain ports. Start by selecting the proper EtherType, use these commands on and : SW1 SW2 By enabling vlan-filtering you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you set up a Management port. Note, that if you are using the new EtherType/TPID 0x88a8 (service tag) and you also need a VLAN interface for your Service VLAN, you will also have to apply the parameter on the VLAN interface. use-service-tag When is configured, the bridge checks the outer VLAN tag and sees if it is using EtherType . If the bridge ether-type=0x8100 0x8100 receives a packet with an outer tag that has a different EtherType, it will mark the packet as . Since RouterOS only checks the untagged outer tag of a packet, it is not possible to filter 802.1Q packets when the 802.1ad protocol is used. Currently, only CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers are capable of hardware offloaded VLAN filtering using the Service tag, EtherType/TPID . 0x88a8 Devices with switch chip Marvell-98DX3257 (e.g. CRS354 series) do not support VLAN filtering on 1Gbps Ethernet interfaces for other VLAN types ( and ). 0x88a8 0x9100

/interface bridge add name=bridge1 vlan-filtering=no ether-type=0x8100 In this setup, ether1 and ether2 will ignore any VLAN tags that are present and add a new VLAN tag, use the pvid parameter to tag all ingress traffic on each port and allow tag-stacking on these ports, use these commands on SW1 and SW2 : /interface bridge port add interface=ether1 bridge=bridge1 pvid=200 tag-stacking=yes add interface=ether2 bridge=bridge1 pvid=300 tag-stacking=yes add interface=ether3 bridge=bridge1 Specify tagged and untagged ports in the bridge VLAN table, you only need to specify the VLAN ID of the outer tag, use these commands on SW1 and SW2 : /interface bridge vlan add bridge=bridge1 tagged=ether3 untagged=ether1 vlan-ids=200 add bridge=bridge1 tagged=ether3 untagged=ether2 vlan-ids=300 When the bridge VLAN table is configured, you can enable bridge VLAN filtering, which is required in order for the parameter to have any effect, pvid use these commands on and SW1 SW2: /interface bridge set bridge1 vlan-filtering=yes MVRP Multiple VLAN Registration protocol (MVRP) is a protocol based on Multiple Registration Protocol (MRP) which allows to register attributes (VLAN IDs in case of MVRP) with other members of Bridged LAN. An MRP application can make or withdraw declarations of attributes which result in registration or leaving of those attributes with other MRP participants. Here's how it works. MRP consists of two parts: Applicant - responsible for sending declarations (or leaves). Its behavior can be configured on a per-port basis using the setting called mvrp- , and per-VLAN using the setting. applicant-state mvrp-forbidden Registrar - responsible for registering incoming declarations. Its configuration can be set per-port using the mvrp-registrar-state setting, and per-VLAN using the setting. mvrp-forbidden Registration Propagation: Incoming registration on a bridge port dynamically makes that specific port a tagged VLAN member. Additionally, the attributes associated with this registration are spread to all active (forwarding) bridge ports as a declaration. Declaration Operation: In case of MVRP, the configured VLAN's get declared on each port, but they will only get configured as members of those VLAN's when a declaration is received from the LAN (Registrar will register the VLAN). From the perspective of an end-station, a single declaration will be registered on each upstream port across the entire LAN. When another end-station declares the same attribute, a path of registrations will be made between the two (or more) end stations, see the picture below. MVRP helps to dynamically propagate VLAN information throughout the bridged network and configure VLANs only on the needed ports. This makes the network efficient by avoiding unnecessary traffic flooding. As noted before, MVRP is only active on ports that are forwarding. In case of MSTP declarations and registrations are made only if the port is forwarding in the MSTI in which VLAN is mapped. By enabling vlan-filtering you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you set up a Management port.

The point-to-point ports speed up the process of registration (or leaving). Manually configuring point-to-point=yes can be advantageous for non- Ethernet interfaces. Property Reference Sub-menu: /interface bridge Property Description mvrp ( |; yes no Default: )noEnables MVRP for bridge. It ensures that the MAC address 01:80:C2:00:00:21 is trapped and not forwarded, the vlan- must be enabled. filtering Sub-menu: /interface bridge port The port menu enables control over the applicant and registrar settings on a per-port basis. Property Description mvrp-applicant-state ( Default: non-participant | normal-participant; n ) ormal-participantMVRP applicant options: non-participant - port does not send any MRP messages; normal-participant - port participates normally in MRP exchanges. mvrp-registrar-state ( ; Default: ) fixed | normal normal MVRP registrar options: fixed - port ignores all MRP messages, and remains Registered (IN) in all configured vlans. normal - port receives MRP messages and handles them according to the standard.

In this example, SW1 and SW2 are DHCP Snooping, and Option 82 enabled devices. First, we need to create a bridge, assign interfaces and mark trusted ports. Use these commands on : SW1 /interface bridge add name=bridge /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 trusted=yes For SW2, the configuration will be similar, but we also need to mark ether1 as trusted, because this interface is going to receive DHCP messages with Option 82 already added. You need to mark all ports as trusted if they are going to receive DHCP messages with added Option 82, otherwise these messages will be dropped. Also, we add ether3 to the same bridge and leave this port untrusted, imagine there is an unauthorized (rogue) DHCP server. Use these commands on SW2 : /interface bridge add name=bridge /interface bridge port add bridge=bridge interface=ether1 trusted=yes add bridge=bridge interface=ether2 trusted=yes add bridge=bridge interface=ether3 Then we need to enable DHCP Snooping and Option 82. In case your DHCP server does not support DHCP Option 82 or you do not implement any Option 82 related policies, this option can be disabled. Use these commands on SW1 and SW2 : /interface bridge set [find where name="bridge"] dhcp-snooping=yes add-dhcp-option82=yes Now both devices will analyze what DHCP messages are received on bridge ports. The SW1 is responsible for adding and removing the DHCP Option 82. The SW2 will limit rogue DHCP server from receiving any discovery messages and drop malicious DHCP server messages from ether3. Controller Bridge and Port Extender Controller Bridge (CB) and Port Extender (PE) is an IEEE 802.1BR standard implementation in RouterOS for CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers. It allows virtually extending the CB ports with a PE device and managing these extended interfaces from a single controlling device. Such configuration provides a simplified network topology, flexibility, increased port density, and ease of manageability. See more details on . Controller Bridge and Port Extender manual Bridge Firewall The bridge firewall implements packet filtering and thereby provides security functions that are used to manage data flow to, from, and through the bridge. Packet flow diagram shows how packets are processed through the router. It is possible to force bridge traffic to go through r /ip firewall filter ules (see the bridge settings). There are two bridge firewall tables: Currently, CRS3xx, CRS5xx series switches, CCR2116, CR2216 routers, and fully support 88E6393X, 88E6191X, 88E6190 switch chips hardware offloaded DHCP Snooping and Option 82. For CRS1xx and CRS2xx series switches it is possible to use DHCP Snooping along with VLAN switching, but then you need to make sure that DHCP packets are sent out with the correct VLAN tag using egress ACL rules. Other devices are capable of using DHCP Snooping and Option 82 features along with hardware offloading, but you must make sure that there is no VLAN-related configuration applied on the device, otherwise, DHCP Snooping and Option 82 might not work properly. See Br the idge Hardware Offloading section with supported features. Starting from RouterOS v7.17, DHCP snooping is supported with hardware offloading bonding interfaces.

filter - bridge firewall with three predefined chains: input - filters packets, where the destination is the bridge (including those packets that will be routed, as they are destined to the bridge MAC address anyway) output - filters packets, which come from the bridge (including those packets that has been routed normally) forward - filters packets, which are to be bridged (note: this chain is not applied to the packets that should be routed through the router, just to those that are traversing between the ports of the same bridge) nat - bridge network address translation provides ways for changing source/destination MAC addresses of the packets traversing a bridge. Has two built-in chains: srcnat - used for "hiding" a host or a network behind a different MAC address. This chain is applied to the packets leaving the router through a bridged interface dstnat - used for redirecting some packets to other destinations You can put packet marks in bridge firewall (filter and NAT), which are the same as the packet marks in IP firewall configured by '/ip firewall . In this way, packet marks put by bridge firewall can be used in 'IP firewall', and vice versa.' mangle General bridge firewall properties are described in this section. Some parameters that differ between nat and filter rules are described in further sections. Sub-menu: /interface bridge filter, /interface bridge nat Property Description 802.3-sap ( ; Default: ) integer DSAP (Destination Service Access Point) and SSAP (Source Service Access Point) are 2 one-byte fields, which identify the network protocol entities which use the link-layer service. These bytes are always equal. Two hexadecimal digits may be specified here to match an SAP byte. 802.3-type ( ; Default: ) integer Ethernet protocol type, placed after the IEEE 802.2 frame header. Works only if 802.3-sap is 0xAA (SNAP - Sub-Network Attachment Point header). For example, AppleTalk can be indicated by the SAP code of 0xAA followed by a SNAP type code of 0x809B. action (accept | drop | jump | log | mark-packet | passthrough | return | set- ; Default: ) priorityAction to take if the packet is matched by the rule: accept - accept the packet. The packet is not passed to the next firewall rule drop - silently drop the packet jump - jump to the user-defined chain specified by the value of ju parameter mp-target log- add a message to the system log containing the following data: in-interface, out-interface, src-mac, protocol, src-ip:port- >dst-ip:port and length of the packet. After the packet is matched it is passed to the next rule in the list, similar as passthrough mark-packet - place a mark specified by the new-packet-mark parameter on a packet that matches the rule passthrough - if the packet is matched by the rule, increase counter and go to next rule (useful for statistics) return - passes control back to the chain from where the jump took place set-priority - set priority specified by the new-priority parameter on the packets sent out through a link that is capable of transporting priority (VLAN or WMM-enabled wireless interface). Read more arp-dst-address ( ; Default: ) IP address ARP destination IP address. arp-dst-mac-address ( ; Default: ) MAC address ARP destination MAC address. arp-gratuitous ( ; Default: ) yes | no Matches ARP gratuitous packets. arp-hardware-type ( ; Default: ) integer 1 ARP hardware type. This is normally Ethernet (Type 1).

arp-opcode (arp-nak | drarp-error | drarp-reply | drarp-request | inarp-reply ; Default: ) | inarp-request | reply | reply-reverse | request | request-reverseARP opcode (packet type) arp-nak - negative ARP reply (rarely used, mostly in ATM networks) drarp-error - Dynamic RARP error code, saying that an IP address for the given MAC address can not be allocated drarp-reply - Dynamic RARP reply, with a temporary IP address assignment for a host drarp-request - Dynamic RARP request to assign a temporary IP address for the given MAC address inarp-reply - InverseARP Reply inarp-request - InverseARP Request reply - standard ARP reply with a MAC address reply-reverse - reverse ARP (RARP) reply with an IP address assigned request - standard ARP request to a known IP address to find out unknown MAC address request-reverse - reverse ARP (RARP) request to a known MAC address to find out the unknown IP address (intended to be used by hosts to find out their own IP address, similarly to DHCP service) arp-packet-type ( ; Default: ) integer 0..65535 | hex 0x0000-0xffff ARP Packet Type. arp-src-address ( ; Default: ) IP address ARP source IP address. arp-src-mac-address ( ; Default: ) MAC addres ARP source MAC address. chain (; Default: )text Bridge firewall chain, which the filter is functioning in (either a built-in one, or a user-defined one). dst-address ( ; Default: ) IP address Destination IP address (only if MAC protocol is set to IP). dst-address6 ( ; Default: ) IPv6 address Destination IPv6 address (only if MAC protocol is set to IPv6). dst-mac-address ( ; Default: ) MAC address Destination MAC address. dst-port ( ; Default: ) integer 0..65535 Destination port number or range (only for TCP or UDP protocols). in-bridge ( ; Default: ) name Bridge interface through which the packet is coming in. in-bridge-list ( ; Default: ) name Set of bridge interfaces defined in interface list. Works the same as in . -bridge in-interface ( ; Default: ) name Physical interface (i.e., bridge port) through which the packet is coming in. in-interface-list ( ; Default: ) name Set of interfaces defined in interface list. Works the same as in- . interface ingress-priority ( ; Default: ) integer 0..63 Matches the priority of an ingress packet. Priority may be derived from VLAN, WMM, DSCP or MPLS EXP bit. read more

ip-protocol (dccp | ddp | egp | encap | etherip | ggp | gre | hmp | icmp | icmpv6 | idpr-cmtp | igmp | ipencap | ipip | ipsec-ah | ipsec-esp | ipv6 | ipv6- frag | ipv6-nonxt | ipv6-opts | ipv6-route | iso-tp4 | l2tp | ospf | pim | pup | ; rdp | rspf | rsvp | sctp | st | tcp | udp | udp-lite | vmtp | vrrp | xns-idp | xtp Default: )IP protocol (only if MAC protocol is set to IPv4) dccp - Datagram Congestion Control Protocol ddp- Datagram Delivery Protocol egp- Exterior Gateway Protocol encap - Encapsulation Header etherip - Ethernet-within-IP Encapsulation ggp- Gateway-to-Gateway Protocol gre- Generic Routing Encapsulation hmp - Host Monitoring Protocol icmp - IPv4 Internet Control Message Protocol icmpv6 - IPv6 Internet Control Message Protocol idpr-cmtp - Inter-Domain Policy Routing Control Message Transport Protocol igmp - Internet Group Management Protocol ipencap - IP in IP (encapsulation) ipip- IP-within-IP Encapsulation Protocol ipsec-ah - IPsec Authentication Header ipsec-esp - IPsec Encapsulating Security Payload ipv6 - Internet Protocol version 6 ipv6-frag - Fragment Header for IPv6 ipv6-nonxt - No Next Header for IPv6 ipv6-opts - Destination Options for IPv6 ipv6-route - Routing Header for IPv6 iso-tp4 - ISO Transport Protocol Class 4 l2tp- Layer Two Tunneling Protocol ospf - Open Shortest Path First pim- Protocol Independent Multicast pup- PARC Universal Packet rdp- Reliable Data Protocol rspf- Radio Shortest Path First rsvp - Reservation Protocol sctp - Stream Control Transmission Protocol st- Internet Stream Protocol tcp- Transmission Control Protocol udp- User Datagram Protocol udp-lite - Lightweight User Datagram Protocol vmtp - Versatile Message Transaction Protocol vrrp- Virtual Router Redundancy Protocol xns-idp - Xerox Network Systems Internet Datagram Protocol xtp- Xpress Transport Protocol jump-target ( ; Default: ) name If specified, then specifies the user-defined firewall action=jump chain to process the packet. limit ( ; Default: ) integer/time,integer Matches packets up to a limited rate. A rule using this matcher will match until this limit is reached. count - maximum average packet rate, measured in packets per second (pps), unless followed by Time option time - specifies the time interval over which the packet rate is measured burst - number of packets to match in a burst log ( ) yes | no; Default: no Add a message to the system log containing the following data: in- interface, out-interface, src-mac, dst-mac, eth-protocol, ip-protocol, src-ip:port->dst-ip:port, and length of the packet. log-prefix (; Default: )text Defines the prefix to be printed before the logging information.

mac-protocol (802.2 | arp | capsman | dot1x | homeplug-av | ip | ipv6 | ipx | lacp | length | lldp | loop-protect | macsec | mpls-multicast | mpls-unicast | packing-compr | packing-simple | pppoe | pppoe-discovery | rarp | romon | ; Default: ) service-vlan | vlan | integer 0..65535 | hex 0x0000-0xffffEthernet payload type (MAC-level protocol). To match protocol type for VLAN encapsulated frames (0x8100 or 0x88a8), a vlan-encap prop erty should be used. 802.2 - 802.2 Frames (0x0004) arp- Address Resolution Protocol (0x0806) homeplug-av - HomePlug AV MME (0x88E1) ip- Internet Protocol version 4 (0x0800) ipv6 - Internet Protocol Version 6 (0x86DD) ipx- Internetwork Packet Exchange (0x8137) length - Packets with length field (0x0000-0x05DC) lldp- Link Layer Discovery Protocol (0x88CC) loop-protect - Loop Protect Protocol (0x9003) mpls-multicast - MPLS multicast (0x8848) mpls-unicast - MPLS unicast (0x8847) packing-compr - Encapsulated packets with compressed IP (0x9001) packing packing-simple - Encapsulated packets with simple (0 IP packing x9000) pppoe - PPPoE Session Stage (0x8864) pppoe-discovery - PPPoE Discovery Stage (0x8863) rarp- Reverse Address Resolution Protocol (0x8035) service-vlan - Provider Bridging (IEEE 802.1ad) & Shortest Path Bridging IEEE 802.1aq (0x88A8) vlan - VLAN-tagged frame (IEEE 802.1Q) and Shortest Path Bridging IEEE 802.1aq with NNI compatibility (0x8100) new-packet-mark ( ; Default: ) string Sets a new packet-mark value. new-priority ( ; Default: ) integer | from-ingress Sets a new priority for a packet. This can be the VLAN, WMM or MPLS EXP priority . This property can also be used to set Read more an internal priori out-bridge ( ; Default: ) name Outgoing bridge interface. out-bridge-list ( ; Default: ) name Set of bridge interfaces defined in interface list. Works the same as ou . t-bridge out-interface ( ; Default: ) name Interface that the packet is leaving the bridge through. out-interface-list ( ; Default: ) name Set of interfaces defined in . Works the same as interface list out- . interface packet-mark ( ; Default: ) name Match packets with a certain packet mark. packet-type ( ; Default: ) broadcast | host | multicast | other-host MAC frame type: broadcast - broadcast MAC packet host - packet is destined to the bridge itself multicast - multicast MAC packet other-host - packet is destined to some other unicast address, not to the bridge itself src-address ( ; Default: ) IP address Source IP address (only if MAC protocol is set to IPv4). src-address6 ( ; Default: ) IPv6 address Source IPv6 address (only if MAC protocol is set to IPv6). src-mac-address ( ; Default: ) MAC address Source MAC address. src-port ( ; Default: ) integer 0..65535 Source port number or range (only for TCP or UDP protocols).

stp-flags ( ; Default: ) topology-change | topology-change-ack The BPDU (Bridge Protocol Data Unit) flags. Bridge exchange configuration messages named BPDU periodically for preventing loops topology-change - topology change flag is set when a bridge detects port state change, to force all other bridges to drop their host tables and recalculate network topology topology-change-ack - topology change acknowledgment flag is sent in replies to the notification packets stp-forward-delay ( ; Default: ) integer 0..65535 Forward delay timer. stp-hello-time ( ; Default: ) integer 0..65535 STP hello packets time. stp-max-age ( ; Default: ) integer 0..65535 Maximal STP message age. stp-msg-age ( ; Default: ) integer 0..65535 STP message age. stp-port ( ; Default: ) integer 0..65535 STP port identifier. stp-root-address ( ; Default: ) MAC address Root bridge MAC address. stp-root-cost ( ; Default: ) integer 0..65535 Root bridge cost. stp-root-priority ( ; Default: ) integer 0..65535 Root bridge priority. stp-sender-address ( ; Default: ) MAC address STP message sender MAC address. stp-sender-priority ( ; Default: ) integer 0..65535 STP sender priority. stp-type ( ; Default: ) config | tcn The BPDU type: config - configuration BPDU tcn- topology change notification tls-host ( ; Default: ) string Allows matching https traffic based on TLS SNI hostname. Accepts GL for wildcard matching. Note that matcher will not be able to OB syntax match hostname if the TLS handshake frame is fragmented into multiple TCP segments (packets). vlan-encap (802.2 | arp | ip | ipv6 | ipx | length | mpls-multicast | mpls- unicast | pppoe | pppoe-discovery | rarp | vlan | integer 0..65535 | hex ; Default: ) 0x0000-0xffffMatches the MAC protocol type encapsulated in the VLAN frame. vlan-id ( ; Default: ) integer 0..4095 Matches the VLAN identifier field. vlan-priority ( ; Default: ) integer 0..7 Matches the VLAN priority (priority code point) Footnotes: STP matchers are only valid if the destination MAC address is (Bridge Group address), 01:80:C2:00:00:00/FF:FF:FF:FF:FF:FF also STP should be enabled. ARP matchers are only valid if mac-protocol is or arp rarp VLAN matchers are only valid for or ethernet protocols 0x8100 0x88a8 IP or IPv6 related matchers are only valid if mac-protocol is either set to or ip ipv6 802.3 matchers are only consulted if the actual frame is compliant with IEEE 802.2 and IEEE 802.3 standards. These matchers are ignored for other packets. Bridge Packet Filter This section describes specific bridge filter options. Sub-menu: /interface bridge filter

Property Description action (accept | drop | jump | log | mark-packet | passthrough | return | ; Default: ) set-priority acceptAction to take if the packet is matched by the rule: accept - accept the packet. No action, i.e., the packet is passed through without undertaking any action, and no more rules are processed in the relevant list/chain drop - silently drop the packet (without sending the ICMP reject message) jump - jump to the chain specified by the value of the jump-target argument log- add a message to the system log containing the following data: in-interface, out-interface, src- mac, dst-mac, eth-proto, protocol, src-ip:port->dst-ip:port and length of the packet. After packet is matched it is passed to the next rule in the list, similar as passthrough mark - mark the packet to use the mark later passthrough - ignore this rule and go on to the next one. Acts the same way as a disabled rule, except for the ability to count packets return - return to the previous chain, from where the jump took place set-priority - set priority specified by the new-priority parameter on the packets sent out through a link that is capable of transporting priority (VLAN or WMM-enabled wireless interface). Read more Bridge NAT This section describes specific bridge NAT options. Sub-menu: /interface bridge nat Property Description action (accept | drop | jump | mark-packet | redirect | set- priority | arp-reply | dst-nat | log | passthrough | return | ; Default: ) src-nat acceptAction to take if the packet is matched by the rule: accept - accept the packet. No action, i.e., the packet is passed through without undertaking any action, and no more rules are processed in the relevant list/chain arp-reply - send a reply to an ARP request (any other packets will be ignored by this rule) with the specified MAC address (only valid in dstnat chain) drop - silently drop the packet (without sending the ICMP reject message) dst-nat - change destination MAC address of a packet (only valid in dstnat chain) jump - jump to the chain specified by the value of the jump-target argument log- log the packet mark - mark the packet to use the mark later passthrough - ignore this rule and go on to the next one. Acts the same way as a disabled rule, except for the ability to count packets redirect - redirect the packet to the bridge itself (only valid in dstnat chain) return - return to the previous chain, from where the jump took place set-priority - set priority specified by the new-priority parameter on the packets sent out through a link that is capable of transporting priority (VLAN or WMM- enabled wireless interface). Read more src-nat - change source MAC address of a packet (only valid in srcnat chain) to-arp-reply-mac-address ( ; Default: ) MAC address Source MAC address to put in Ethernet frame and ARP payload, when action=arp- is selected reply to-dst-mac-address ( ; Default: ) MAC address Destination MAC address to put in Ethernet frames, when is action=dst-nat selected to-src-mac-address ( ; Default: ) MAC address Source MAC address to put in Ethernet frames, when is selected action=src-nat See also CRS1xx/2xx series switches CRS3xx, CRS5xx series switches, and CCR2116, CCR2216 routers Switch chip features MTU on RouterBOARD Layer2 misconfiguration

Bridge VLAN Table Wireless VLAN Trunk VLANs on Wireless

CRS3xx, CRS5xx, CCR2116, CCR2216 switch chip features Summary Features Models Abbreviations Port switching VLAN VLAN Filtering Port-Based VLAN MAC Based VLAN Protocol Based VLAN VLAN Tunneling (Q-in-Q) Ingress VLAN translation (R/M)STP Bonding Multi-chassis Link Aggregation Group L3 Hardware Offloading Port isolation IGMP/MLD Snooping DHCP Snooping and DHCP Option 82 Controller Bridge and Port Extender Mirroring Configuration examples Port Based Mirroring VLAN Based Mirroring MAC Based Mirroring IP Based Mirroring Remote Switch Port Analyzer Property Reference Traffic Shaping Traffic Storm Control MPLS hardware offloading Switch Rules (ACL) Port Security Dual Boot Configuring SwOS using RouterOS See also Summary The CCR3xx, CRS5xx series switches and CCR2116, CCR2216 routers have highly integrated switches with high-performance CPU and feature-rich packet processors. These devices can be designed into various Ethernet applications including unmanaged switch, Layer 2 managed switch, carrier switch, inter-VLAN router, and wired unified packet processor. Features Features Description This article applies to CRS3xx, CRS5xx series switches, CCR2116, CCR2216 routers, and not to . CRS1xx/CRS2xx series switches

Forwarding Configurable ports for switching or routing Full non-blocking wire-speed switching Large Unicast FDB for Layer 2 unicast forwarding Forwarding Databases works based on IVL Jumbo frame support IGMP Snooping support DHCP Snooping with Option 82 Routing Layer 3 Hardware Offloading: IPv4, IPv6 Unicast Routing Supported on Ethernet, Bridge, Bonding, and VLAN interfaces ECMP Blackholes Offloaded Fasttrack connections 1 Offloaded NAT for Fasttrack connections 1 Multiple MTU profiles Spanning Tree Protocol STP RSTP MSTP Edge port, BPDU Guard, Root Guard Mirroring Various types of mirroring: Port based mirroring VLAN based mirroring MAC based mirroring Remote Switch Port Analyzer (RSPAN) VLAN Fully compatible with IEEE802.1Q and IEEE802.1ad VLAN 4k active VLANs Flexible VLAN assignment: Port based VLAN Protocol based VLAN MAC based VLAN VLAN filtering Ingress VLAN translation Multiple VLAN Registration protocol (MVRP) Bonding Supports 802.3ad (LACP), balance-xor and active-backup modes Up to 8 member ports per bonding interface Hardware automatic failover and load balancing MLAG 1. Applies only to certain switch models

Quality of Service (QoS) Eight output queues per port DSCP and 802.1p PCP mapping Port based Layer2 and Layer3 trust settings Port and Queue based egress rate limiter Policy based QoS via ACL rules Strict Priority (SP) and Shaped Deficit Weighted Round Robin (SDWRR) queuing Enhanced Transmission Selection (ETS) scheduling Weighted Random Early Detection (WRED) 1 Explicit Congestion Notification (ECN) 1 Priority-based Flow Control (PFC) 1 Resource allocation control (queue, shared-pool and multicast based) with extensive monitoring capabilities Compatible with Dante enviroments Compatible with RDMA over Converged Ethernet (RoCE) enviroment 1 Ingress traffic limiting (port based or via ACL rules) Traffic storm control Port isolation Applicable for Private VLAN implementation Access Control List Ingress ACL tables Classification based on ports, L2, L3, L4 protocol header fields ACL actions include filtering, forwarding and modifying of the protocol header fields PTP Two-step Ordinary Clock and Boundary Clock. Hardware timestamping, ensuring clock syncronization in nanosecond(ns) range. IPv4 and Layer 2 (L2) multicast transport modes. End-to-End (E2E) and Peer-to-Peer (P2P) delay mechanisms. IEEE 1588-2008 (PTPv2) Profile Support for: 802.1AS: Audio Video Bridging (AVB) and Time-Sensitive Networking (TSN). AES67: High-performance audio-over-IP interoperability. G.8275.1: Frequency and phase synchronization in PTP-aware networks. SMPTE: Audio/video synchronization in professional broadcast environments Models This table clarifies the main differences between Cloud Router Switch models and CCR routers. Model Switch Chip CPU Cores 10G SFP+ 10G Ethernet 25G SFP2840G QSFP+100G QSFP28ACL rulesUnicast FDB entriesJumbo Frame (Bytes) netPower 15FR (CRS318-1Fi- 15Fr-2S)Marvell- 98DX224S800MHz 1 - - - - - 128 16,000 10218 1. Applies only to certain switch models PTP support is hardware-dependent, please refer to the list of supported devices. For L3 hardware offloading feature support and hardware limits, please refer to and user manuals. Feature Support Device Support For QoS hardware offloading feature support and hardware limits, please refer to user manuals. Quality of Service (QoS)

netPower 16P (CRS318-16P- 2S+)Marvell- 98DX226S800MHz 1 2 - - - - 128 16,000 10218 CRS310-1G-5S-4S+ (netFiber 9 /IN)Marvell- 98DX226S800MHz 1 4 - - - - 128 16,000 10218 CRS320-8P-8B-4S+RM Marvell- 98DX226S800MHz 2 4 - - - - 128 16,000 10218 CRS326-24G-2S+ (RM/IN) Marvell- 98DX3236800MHz 1 2 - - - - 128 16,000 10218 CRS328-24P-4S+ Marvell- 98DX3236800MHz 1 4 - - - - 128 16,000 10218 CRS328-4C-20S-4S+ Marvell- 98DX3236800MHz 1 4 - - - - 128 16,000 10218 CRS305-1G-4S+ Marvell- 98DX3236800MHz 1 4 - - - - 128 16,000 10218 CRS309-1G-8S+ Marvell- 98DX8208800MHz 2 8 - - - - 1024 32,000 10218 CRS317-1G-16S+ Marvell- 98DX8216800MHz 2 16 - - - - 1024 128,000 10218 CRS312-4C+8XG Marvell- 98DX8212650MHz 1 4 (combo ports)8 + 4 (combo ports)- - - 512 32,000 10218 CRS326-24S+2Q+ Marvell- 98DX8332650MHz 1 24 - - 2 - 256 32,000 10218 CRS326-4C+20G+2Q+RM Marvell- 98DX8332650MHz 1 4 (combo ports)- - 2 - 256 32,000 10218 CRS354-48G-4S+2Q+ Marvell- 98DX3257650MHz 1 4 - - 2 - 170 32,000 10218 CRS354-48P-4S+2Q+ Marvell- 98DX3257650MHz 1 4 - - 2 - 170 32,000 10218 CRS504-4XQ (IN/OUT) Marvell- 98DX4310650MHz 1 - - - - 4 1024 128,000 10218 CRS510-8XS-2XQ-IN Marvell- 98DX4310650MHz 1 - - 8 - 2 1024 128,000 10218 CRS518-16XS-2XQ Marvell- 98DX8525650MHz 1 - - 16 - 2 1024 128,000 10218 CRS520-4XS-16XQ-RM Marvell- 98CX84102000M Hz4 - 2 4 - 16 682 256,000 9570 CCR2116-12G-4S+ Marvell- 98DX32552000M Hz16 4 - - - - 512 32,000 9570 CCR2216-1G-12XS-2XQ Marvell- 98DX85252000M Hz16 - - 12 - 2 1024 128,000 9570 Abbreviations FDB - Forwarding Database MDB - Multicast Database SVL - Shared VLAN Learning IVL - Independent VLAN Learning PVID - Port VLAN ID ACL - Access Control List CVID - Customer VLAN ID SVID - Service VLAN ID Port switching In order to set up a port switching, check the page. Bridge Hardware Offloading Currently, it is possible to create only one bridge with hardware offloading. Use the parameter to select which bridge will use hw=yes/no hardware offloading.

VLAN Since RouterOS version 6.41, a bridge provides VLAN aware Layer2 forwarding and VLAN tag modifications within the bridge. This set of features makes bridge operation more like a traditional Ethernet switch and allows to overcome Spanning Tree compatibility issues compared to the configuration when tunnel-like VLAN interfaces are bridged. Bridge VLAN Filtering configuration is highly recommended to comply with STP (802.1D), RSTP (802.1w) standards and it is mandatory to enable MSTP (802.1s) support in RouterOS. VLAN Filtering VLAN filtering is described on the section. Bridge VLAN Filtering VLAN setup examples Below are describes some of the most common ways how to utilize VLAN forwarding. Port-Based VLAN The configuration is described on the section. Bridge VLAN FIltering MAC Based VLAN Enable switching on ports by creating a bridge with enabled hw-offloading: /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether7 hw=yes Add VLANs in the Bridge VLAN table and specify ports: /interface bridge vlan add bridge=bridge1 tagged=ether2 untagged=ether7 vlan-ids=200,300,400 Add Switch rules which assign VLAN id based on MAC address: /interface ethernet switch rule add switch=switch1 ports=ether7 src-mac-address=A4:12:6D:77:94:43/FF:FF:FF:FF:FF:FF new-vlan-id=200 add switch=switch1 ports=ether7 src-mac-address=84:37:62:DF:04:20/FF:FF:FF:FF:FF:FF new-vlan-id=300 add switch=switch1 ports=ether7 src-mac-address=E7:16:34:A1:CD:18/FF:FF:FF:FF:FF:FF new-vlan-id=400 Protocol Based VLAN Bridge STP/RSTP/MSTP, IGMP Snooping and VLAN filtering settings don't affect hardware offloading, since RouterOS v6.42 Bonding interfaces are also hardware offloaded. The Switch Rule table is used for MAC Based VLAN functionality, see on how many rules each device supports. this table MAC-based VLANs will only work properly between switch ports and not between switch ports and CPU. When a packet is being forwarded to the CPU, the property for the bridge port will be always used instead of from ACL rules. pvid new-vlan-id MAC-based VLANs will not work for DHCP packets when DHCP snooping is enabled.

Enable switching on ports by creating a bridge with enabled hw-offloading: /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Add VLANs in the Bridge VLAN table and specify ports: /interface bridge vlan add bridge=bridge1 tagged=ether2 untagged=ether6 vlan-ids=200 add bridge=bridge1 tagged=ether2 untagged=ether7 vlan-ids=300 add bridge=bridge1 tagged=ether2 untagged=ether8 vlan-ids=400 Add Switch rules which assign VLAN id based on MAC protocol: /interface ethernet switch rule add mac-protocol=ip new-vlan-id=200 ports=ether6 switch=switch1 add mac-protocol=ipx new-vlan-id=300 ports=ether7 switch=switch1 add mac-protocol=0x80F3 new-vlan-id=400 ports=ether8 switch=switch1 VLAN Tunneling (Q-in-Q) Since RouterOS v6.43 it is possible to use a provider bridge (IEEE 802.1ad) and Tag Stacking VLAN filtering, and hardware offloading at the same time. The configuration is described in the section. Bridge VLAN Tunneling (Q-in-Q) Ingress VLAN translation It is possible to translate a certain VLAN ID to a different VLAN ID using ACL rules on an ingress port. In this example we create two ACL rules, allowing bidirectional communication. This can be done by doing the following. Create a new bridge and add ports to it with hardware offloading: /interface bridge add name=bridge1 vlan-filtering=no /interface bridge port add interface=ether1 bridge=bridge1 hw=yes add interface=ether2 bridge=bridge1 hw=yes Add ACL rules to translate a VLAN ID in each direction: /interface ethernet switch rule add new-dst-ports=ether2 new-vlan-id=20 ports=ether1 switch=switch1 vlan-id=10 add new-dst-ports=ether1 new-vlan-id=10 ports=ether2 switch=switch1 vlan-id=20 The Switch Rule table is used for Protocol Based VLAN functionality, see on how many rules each device supports. this table Protocol-based VLANs will only work properly between switch ports and not between switch ports and CPU. When a packet is being forwarded to the CPU, the property for the bridge port will be always used instead of from ACL rules. pvid new-vlan-id Protocol-based VLANs will not work for DHCP packets when DHCP snooping is enabled. Devices with switch chip Marvell-98DX3257 (e.g. CRS354 series) do not support VLAN filtering on 1Gbps Ethernet interfaces for other VLAN types ( and ). 0x88a8 0x9100

Add both VLAN IDs to the bridge VLAN table: /interface bridge vlan add bridge=bridge1 tagged=ether1 vlan-ids=10 add bridge=bridge1 tagged=ether2 vlan-ids=20 Enable bridge VLAN filtering: /interface bridge set bridge1 vlan-filtering=yes (R/M)STP CRS3xx, CRS5xx series switches, and CCR2116, CCR2216 routers are capable of running STP, RSTP, and MSTP on a hardware level. For more detailed information you should check out the manual page. Spanning Tree Protocol Bonding CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers support hardware offloading with bonding interfaces. Only and 802.3ad balance- bonding modes are hardware offloaded, other bonding modes will use the CPU's resources. You can find more information about the bonding xor interfaces in the section. If mode is used, then LACP (Link Aggregation Control Protocol) is supported. Bonding Interface 802.3ad To create a hardware offloaded bonding interface, you must create a bonding interface with a supported bonding mode: /interface bonding add mode=802.3ad name=bond1 slaves=ether1,ether2 This interface can be added to a bridge alongside other interfaces: /interface bridge add name=bridge /interface bridge port add bridge=bridge interface=bond1 hw=yes add bridge=bridge interface=ether3 hw=yes add bridge=bridge interface=ether4 hw=yes Make sure that the bonding interface is hardware offloaded by checking the "H" flag: /interface bridge port print Flags: X - disabled, I - inactive, D - dynamic, H - hw-offload # INTERFACE BRIDGE HW 0 H bond1 bridge yes 1 H ether3 bridge yes 2 H ether4 bridge yes Bidirectional communication is limited only between two switch ports. Translating VLAN ID between more ports can cause traffic flooding or incorrect forwarding between the same VLAN ports. By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port Do not add interfaces to a bridge that are already in a bond, RouterOS will not allow you to add an interface to bridge that is already a slave port for bonding.

Multi-chassis Link Aggregation Group MLAG (Multi-chassis Link Aggregation Group) implementation in RouterOS allows configuring LACP bonds on two separate devices, while the client device believes to be connected on the same machine. This provides a physical redundancy in case of switch failure. All CRS3xx, CRS5xx series and CCR2116, CCR2216 devices can be configured with MLAG. Read for more information.here L3 Hardware Offloading Layer3 hardware offloading (otherwise known as IP switching or HW routing) will allow to offload some of the router features onto the switch chip. This allows reaching wire speeds when routing packets, which simply would not be possible with the CPU. Offloaded feature set depends on the used chipset. Read for more info.here Port isolation Since RouterOS v6.43 is it possible to create a Private VLAN setup, an example can be found in the manual page. Hardware Switch chip port isolation offloaded bonding interfaces are not included in the switch port-isolation menu, but it is still possible to configure port-isolation individually on each secondary interface of the bonding. IGMP/MLD Snooping CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers are capable of using IGMP/MLD Snooping on a hardware level. To see more detailed information, you should check out the manual page. IGMP/MLD snooping DHCP Snooping and DHCP Option 82 CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers are capable of using DHCP Snooping with Option 82 on a hardware level. The switch will create a dynamic ACL rule to capture the DHCP packets and redirect them to the main CPU for further processing. To see more detailed information, please visit the manual page. DHCP Snooping and DHCP Option 82 Controller Bridge and Port Extender Controller Bridge (CB) and Port Extender (PE) is an IEEE 802.1BR standard implementation in RouterOS. It allows virtually extending the CB ports with a PE device and managing these extended interfaces from a single controlling device. Such configuration provides a simplified network topology, flexibility, increased port density, and ease of manageability. See more details on Controller Bridge and Port Extender manual . Mirroring With HW-offloaded bonding interfaces, the built-in switch chip will always use Layer2+Layer3+Layer4 for a transmit hash policy, changing the transmit hash policy manually will have no effect. Port isolation can be used with vlan-filtering bridge and it is possible to isolate ports that are members of the same VLAN. The isolation works per-port, it is not possible to isolate ports per-VLAN. Starting from RouterOS v7.17, DHCP snooping is supported with hardware offloading bonding interfaces.

Mirroring is a function that allows a network switch to duplicate all the data passing through it and send a copy to another specified port, known as the mirr . This feature is useful for setting up a tap device, which allows for analyzing network traffic using a separate device. You can set up mirroring or-target in a simple way by designating source ports (see and in ), or you can mirror-egress mirror-ingress /interface/ethernet/switch/port configure more advanced mirroring based on different criteria (see in ). mirror /interface/ethernet/switch/rule It is important to note that the port must be on the same switch. You can check the device block diagram or navigate to the mirror-target /interface menu to identify which interfaces are connected where. When setting up the configration, it is not mandatory to add the /ethernet mirror-target interface to the same hardware offloaded bridge where the source ports are set up. The port can be a standalone interface (not mirror-target configured as a bridge port), or it can be within a bridge setup. When using the with a bridge, note that data and mirrored traffic may mirror-target both travel on the same LAN. In such cases, consider employing RSPAN (Remote Switch Port Analyzer), where mirrored traffic is encapsulated into a separate VLAN before being transmitted over the network. Additionally, you can set the port to a special value "cpu", which means that the copied packets will be sent to the switch chip's CPU port. mirror-target Configuration examples Port Based Mirroring Starting from RouterOS version 7.15, it is possible to configure multiple source ports and selectively choose whether to mirror incoming traffic, outgoing traffic, or both. In this example, both incoming and outgoing traffic from the interface will be copied and sent to the interface for monitoring or ether2 ether3 analysis. # Since RouterOS v7.15 /interface ethernet switch port set ether2 mirror-egress=yes mirror-ingress=yes /interface ethernet switch set switch1 mirror-target=ether3 # Older RouterOS: /interface ethernet switch set switch1 mirror-source=ether2 mirror-target=ether3 VLAN Based Mirroring Using ACL rules, it is possible to mirror packets from multiple interfaces using the setting. Additionally, you can specify more detailed criteria such ports as VLAN ID, MAC/IP address or TCP/UDP port. Only packets are mirrored to interface. This example will mirror incoming VLAN ingress mirror-target 11 traffic from the interface, and send copies to the interface. To use an ACL rule with a matcher, you need to have ether2 ether3 vlan-id bridge vlan- enabled. filtering /interface bridge set bridge1 vlan-filtering=yes /interface ethernet switch set switch1 mirror-target=ether3 /interface ethernet switch rule add mirror=yes ports=ether1 switch=switch1 vlan-id=11 MAC Based Mirroring This example will mirror incoming traffic with 64:D1:54:D9:27:E6 MAC destination or source address from the interface, and send copies to the ether1 ether3 interface. /interface ethernet switch set switch1 mirror-target=ether3 /interface ethernet switch rule add mirror=yes ports=ether1 switch=switch1 dst-mac-address=64:D1:54:D9:27:E6/FF:FF:FF:FF:FF:FF add mirror=yes ports=ether1 switch=switch1 src-mac-address=64:D1:54:D9:27:E6/FF:FF:FF:FF:FF:FF IP Based Mirroring

This example will mirror incoming traffic with 192.168.88.0/24 IP destination or source address from the interface, and send copies to the ether1 ether3 interface. /interface ethernet switch set switch1 mirror-target=ether3 mirror-source=none /interface ethernet switch rule add mirror=yes ports=ether1 switch=switch1 src-address=192.168.88.0/24 add mirror=yes ports=ether1 switch=switch1 dst-address=192.168.88.0/24 There are other options as well, check the ACL section to find out all possible parameters that can be used to match packets. Remote Switch Port Analyzer This example will mirror incomming and outgoing traffic from the interface, copies will be encapsulated in 802.1Q VLAN using the 999 as VLAN ID, ether2 and packets will be sent to the interface. If the original traffic is already VLAN tagged, RSPAN will add another layer of VLAN tagging as an outer ether3 tag. This results in the mirrored traffic being tagged twice. If the port is included in vlan-filtering bridge, it is not required to make the mirror-target interface as tagged VLAN member under the menu for the RSPAN. /interface/bridge/vlan /interface ethernet switch port set ether2 mirror-egress=yes mirror-ingress=yes /interface ethernet switch set switch1 mirror-target=ether3 rspan=yes rspan-egress-vlan-id=999 rspan-ingress-vlan-id=999 Property Reference Sub-menu: /interface/ethernet/switch Property Description mirror-target (cpu | ; Default: name | none no )neSelects a single mirroring target port. Packets from and ( mirror-egress mirror-ingress /interface/ethernet ) and ( ) will be sent to the selected port. /switch/port mirror /interface/ethernet/switch/rule rspan ( ; Default: no | yes )noEnables Remote Switch Port Analyzer (RSPAN) feature on . Traffic marked for ingress or egress mirroring mirror-target is carried over a specified remote analyzer VLAN - and . rspan-egress-vlan-id rspan-ingress-vlan-id rspan-egress-vlan-id (int ; Default: ) eger: 1..4095 1Selects the VLAN ID for marked egress traffic. Only applies when is enabled. rspan rspan-ingress-vlan-id (int ; Default: ) eger: 1..4095 1Selects the VLAN ID for marked ingress traffic. Only applies when is enabled.rspan Sub-menu: /interface/ethernet/switch/port Property Description ( ; Default: ) mirror-egress no | yes no Whether to send egress packet copy to the port. mirror-target ( ; Default: ) mirror-ingress no | yes no Whether to send ingress packet copy to the port. mirror-target Sub-menu: /interface/ethernet/switch/rule Property Description mirror ( ; Default: ) no | yes no Whether to send a packet copy to port. mirror-target Traffic Shaping

It is possible to limit ingress traffic that matches certain parameters with ACL rules and it is possible to limit ingress/egress traffic per port basis. The policer is used for ingress traffic, the shaper is used for egress traffic. The ingress policer controls the received traffic with packet drops. Everything that exceeds the defined limit will get dropped. This can affect the TCP congestion control mechanism on end hosts and achieved bandwidth can be actually less than defined. The egress shaper tries to queue packets that exceed the limit instead of dropping them. Eventually, it will also drop packets when the output queue gets full, however, it should allow utilizing the defined throughput better. Port-based traffic police and shaper: /interface ethernet switch port set ether1 ingress-rate=10M egress-rate=5M MAC-based traffic policer: /interface ethernet switch rule add ports=ether1 switch=switch1 src-mac-address=64:D1:54:D9:27:E6/FF:FF:FF:FF:FF:FF rate=10M VLAN-based traffic policer: /interface bridge set bridge1 vlan-filtering=yes /interface ethernet switch rule add ports=ether1 switch=switch1 vlan-id=11 rate=10M Protocol-based traffic policer: /interface ethernet switch rule add ports=ether1 switch=switch1 mac-protocol=ipx rate=10M There are other options as well, check the ACL section to find out all possible parameters that can be used to match packets. Traffic Storm Control Since RouterOS v6.42 it is possible to enable traffic storm control. A traffic storm can emerge when certain frames are continuously flooded on the network. Storm control settings is generally configured on non-uplink ports to restrict incoming storm traffic on those specific ports. This helps safeguard the entire switch and its connected ports by minimizing the impact of traffic storms across the network. For example, if a network loop has been created and no loop avoidance mechanisms are used (e.g. ), broadcast or multicast Spanning Tree Protocol frames can quickly overwhelm the network, causing degraded network performance or even complete network breakdown. With CRS3xx, CRS5xx series switches and CCR2116, CCR2216 routers it is possible to limit broadcast, unknown multicast and unknown unicast traffic. Unknown unicast traffic is considered when a switch does not contain a host entry for the destined MAC address. Unknown multicast traffic is considered when a switch does not contain a multicast group entry in the menu. Storm control settings should be applied to ingress ports, the egress traffic will be /interface bridge mdb limited. By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port The Switch Rule table is used for QoS functionality, see on how many rules each device supports. this table

Sub-menu: /interface ethernet switch port Property Description limit-broadcasts ( ; Default: ) yes | no yes Limit broadcast traffic on a switch port. limit-unknown-multicasts ( ; Default: yes | no )noLimit unknown multicast traffic on a switch port. limit-unknown-unicasts ( ; Default: yes | no no )Limit unknown unicast traffic on a switch port. storm-rate ( ; Default: ) integer 0..100 100 Amount of broadcast, unknown multicast and/or unknown unicast traffic is limited to in percentage of the link speed. For example, to limit 1% (10Mbps) of broadcast and unknown unicast traffic on ether1 (1Gbps), use the following commands: /interface ethernet switch port set ether1 storm-rate=1 limit-broadcasts=yes limit-unknown-unicasts=yes MPLS hardware offloading Since RouterOS v6.41 it is possible to offload certain MPLS functions to the switch chip, the switch must be a (P)rovider router in a PE-P-PE setup in order to achieve hardware offloading. A setup example can be found in the manual page. The hardware offloading will only take Basic MPLS setup example place when LDP interfaces are configured as physical switch interfaces (e.g. Ethernet, SFP, SFP+). The storm control parameter is specified in percentage (%) of the link speed. If your link speed is 1Gbps, then specifying as will storm-rate 10 allow only 100Mbps of broadcast, unknown multicast and/or unknown unicast traffic to be forwarded. Devices with Marvell-98DX3236 switch chip cannot distinguish unknown multicast traffic from all multicast traffic. For example, CRS326-24G- 2S+ will limit all multicast traffic when and is used. For other devices, for example, CRS317-1G- limit-unknown-multicasts storm-rate 16S+ the parameter will limit only unknown multicast traffic (addresses that are not present in limit-unknown-multicasts /interface bridge mdb). Currently only and using RouterOS v6.41 and newer are capable of hardware offloading certain MPLS CRS317-1G-16S+ CRS309-1G-8S+ functions. and built-in switch chip is not capable of popping MPLS labels from packets, in a PE-P-PE CRS317-1G-16S+ CRS309-1G-8S+ setup you either have to use explicit null or disable TTL propagation in MPLS network to achieve hardware offloading.

Switch Rules (ACL) Access Control List contains ingress policy and egress policy engines. See on how many rules each device supports. It is an advanced tool for this table wire-speed packet filtering, forwarding and modifying based on Layer2, Layer3 and Layer4 protocol header field conditions. Sub-menu: /interface ethernet switch rule Property Description copy-to-cpu ( ; Default: ) no | yes no Clones the matching packet and sends it to the CPU. disabled ( ; Default: ) yes | no no Enables or disables ACL entry. dscp ( ) 0..63 Matching the DSCP field of the packet (only applies to IPv4 packets). dst-address ( ) IP address/Mask Matching destination IPv4 address and mask, also matches the destination IP in ARP packets. dst-address6 ( ) IPv6 address/Mask Matching destination IPv6 address and mask. dst-mac-address ( ) MAC address/Mask Matching destination MAC address and mask. dst-port ( ) 0..65535 Matching destination protocol port number (applies to IPv4 and IPv6 packets if is not specified). mac-protocol flow-label ( ) 0..1048575 Matching IPv6 flow label. mac-protocol (802.2 | arp | capsman | dot1x | homeplug-av | ip | ipv6 | ipx | lacp | lldp | loop-protect | macsec | mpls-multicast | mpls-unicast | packing- compr | packing-simple | pppoe | pppoe-discovery | rarp | romon | service-vlan ) | vlan | or 0..65535 | or 0x0000-0xffffMatching particular MAC protocol specified by protocol name or number mirror ( ) no | yes Clones the matching packet and sends it to the mirror-target port. new-dst-ports ( ) ports | bond | all Changes the destination port to the specified value: If the setting is left empty (e.g. ), the packet new-dst-ports="" will be dropped; If a port or interface is specified, the hardware-offloaded bonding packet will be redirected to that port. Only single port or bond interface is supported; if you use the argument, packet will be allowed to pass all through to the egress processing without being dropped; If this parameter is not used, the packet will be accepted as is. The MPLS hardware offloading has been removed since RouterOS v7. ACL rules are checked for each received packet until a match has been found. If there are multiple rules that can match, then only the first rule will be triggered. A rule without any action parameters is a rule to accept the packet. It is not required to set to certain IP version when using L3 or L4 matchers, however, it is recommended to set the mac-protocol mac- or when filtering any IP packets. protocol=ip mac-protocol=ipv6 When switch ACL rules are modified (e.g. added, removed, disabled, enabled, or moved), the existing switch rules will be inactive for a short time. This can cause some packet leakage during the ACL rule modifications.

new-vlan-id ( ) 0..4095 Changes the VLAN ID to the specified value. Requires vlan- . filtering=yes new-vlan-priority ()0..7 Changes the VLAN priority (priority code point). Requires vlan- . filtering=yes ports ( ) ports | bond Matching switch interfaces where the rule will apply to incoming traffic. Multiple ports and interfaces can be hardware-offloaded bonding selected. Note that the port cannot be selected. If switch1-cpu ports property is left empty, the rule will apply to all switch interfaces. protocol (dccp | ddp | egp | encap | etherip | ggp | gre | hmp | icmp | icmpv6 | idpr-cmtp | igmp | ipencap | ipip | ipsec-ah | ipsec-esp | ipv6 | ipv6-frag | ipv6- nonxt | ipv6-opts | ipv6-route | iso-tp4 | l2tp | ospf | pim | pup | rdp | rspf | rsvp | ) sctp | st | tcp | udp | udp-lite | vmtp | vrrp | xns-idp | xtp | or 0..255Matching particular IP protocol specified by protocol name or number. Only applies to IPv4 packets if is not specified. To mac-protocol match certain IPv6 protocols, use the setting. mac-protocol=ipv6 rate ( ) 0..4294967295 Sets ingress traffic limitation (bits per second) for matched traffic. redirect-to-cpu ( ) no | yes Changes the destination port of a matching packet to the CPU. src-address ( ) IP address/Mask Matching source IPv4 address and mask, also matches the source IP in ARP packets. src-address6 ( ) IPv6 address/Mask Matching source IPv6 address and mask. src-mac-address ( ) MAC address/Mask Matching source MAC address and mask. src-port ( ) 0..65535 Matching source protocol port number (applies to IPv4 and IPv6 packets if is not specified). mac-protocol switch ( ) switch group Matching switch group on which will the rule apply. traffic-class ( ) 0..255 Matching IPv6 traffic class. vlan-id ( ) 0..4095 Matching VLAN ID. Requires . vlan-filtering=yes vlan-header ( ) not-present | present Matching VLAN header, whether the VLAN header is present or not. Requires . vlan-filtering=yes vlan-priority ()0..7 Matching VLAN priority (priority code point). Action parameters: copy-to-cpu redirect-to-cpu mirror new-dst-ports (can be used to drop packets) new-vlan-id new-vlan-priority rate Layer2 condition parameters: dst-mac-address mac-protocol src-mac-address vlan-id vlan-header vlan-priority Layer3 condition parameters: dscp protocol IPv4 conditions: dst-address src-address IPv6 conditions: dst-address6

flow-label src-address6 traffic-class Layer4 condition parameters: dst-port src-port Port Security It is possible to limit allowed MAC addresses on a single switch port. For example, to allow 64:D1:54:81:EF:8E MAC address on a switch port, start by switching multiple ports together, in this example 64:D1:54:81:EF:8E is going to be located behind . ether1 Create an ACL rule to allow the given MAC address and drop all other traffic on ether1 (for ingress traffic): /interface ethernet switch rule add ports=ether1 src-mac-address=64:D1:54:81:EF:8E/FF:FF:FF:FF:FF:FF switch=switch1 add new-dst-ports="" ports=ether1 switch=switch1 Switch all required ports together, disable MAC learning and disable unknown unicast flooding on : ether1 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes learn=no unknown-unicast-flood=no add bridge=bridge1 interface=ether2 hw=yes Add a static hosts entry for 64:D1:54:81:EF:8E (for egress traffic): /interface bridge host add bridge=bridge1 interface=ether1 mac-address=64:D1:54:81:EF:8E Dual Boot The “dual boot” feature allows you to choose which operating system you prefer to use on CRS3xx series switches, RouterOS or SwOS. Device operating system could be changed using: Command-line ( ) /system routerboard settings set boot-os=swos Winbox Webfig Serial Console More details about SwOS are described here: SwOS manual For VLAN related matchers or VLAN related action parameters to work, you need to enable on the bridge interface and vlan-filtering make sure that hardware offloading is enabled on those ports, otherwise, these parameters will not have any effect. When bridge interface is set to , then VLAN related ACL rules are relevant to ether-type 0x8100 frames tagged using regular/customer VLAN 0x8100), this includes and . When bridge interface is set to , then ACL rules are relevant (TPID vlan-id new-vlan-id ether-type 0x88a8 to frames tagged with 802.1ad service tag (TPID 0x88a8). Broadcast traffic will still be sent out from . To limit broadcast traffic flood on a bridge port, you can use the parameter ether1 broadcast-flood to toggle it. Do note that some protocols depend on broadcast traffic, such as streaming protocols and DHCP.

Configuring SwOS using RouterOS Since RouterOS 6.43 it is possible to load, save and reset SwOS configuration, as well as upgrade SwOS and set an IP address for the CRS3xx series switches by using RouterOS. Save configuration with /system swos save-config Load configuration with /system swos load-config Change password with /system swos password Reset configuration with /system swos reset-config Upgrade SwOS from RouterOS using /system swos upgrade Property Description address-acquisition-mode (d hcp-only | dhcp-with-fallback ; Default: | static dhcp-with- ) fallbackChanges address acquisition method: dhcp-only - uses only a DHCP client to acquire address dhcp-with-fallback - for the first 10 seconds will try to acquire address using a DHCP client. If the request is unsuccessful, then address falls back to static as defined by static-ip-address property static - address is set as defined by static-ip-address property allow-from ( ; Default: IP/Mask ) 0.0.0.0/0IP address or a network from which the switch is accessible. By default, the switch is accessible by any IP address. allow-from-ports ( ; name Default: )List of switch ports from which the device is accessible. By default, all ports are allowed to access the switch allow-from-vlan (integer: 0.. ; Default: ) 4094 0VLAN ID from which the device is accessible. By default, all VLANs are allowed identity ( ; Default: name Mikr )otikName of the switch (used for Mikrotik Neighbor Discovery protocol) static-ip-address (; Default:IP ) 192.168.88.1IP address of the switch in case address-acquisition-mode is either set to dhcp-with-fallback orstatic. By setting a static IP address, the address acquisition process does not change, which is DHCP with fallback by default. This means that the configured static IP address will become active only when there is going to be no DHCP servers in the same broadcast domain See also CRS Router CRS3xx VLANs with Bonds Basic VLAN switching Bridge Hardware Offloading Route Hardware Offloading Spanning Tree Protocol The configuration will be saved on the same device with as a filename, make sure you download the file from your device since swos.config the configuration file will be removed after a reboot. The upgrade command will automatically install the latest available SwOS primary backup version, make sure that your device has access to the Internet in order for the upgrade process to work properly. When the device is booted into SwOS, the version number will include the letter "p", indicating a primary backup version. You can then install the latest available SwOS secondary main version from the SwOS "Upgrade" menu.

MTU on RouterBOARD Layer2 misconfiguration Bridge VLAN Table Bridge IGMP/MLD snooping Multi-chassis Link Aggregation Group

CRS1xx and 2xx series switches Summary Cloud Router Switch models Abbreviations and Explanations Port Switching Multiple switch groups Global Settings Port Settings Forwarding Databases Unicast FDB Multicast FDB Reserved FDB VLAN VLAN Table Egress VLAN Tag Ingress/Egress VLAN Translation Protocol Based VLAN MAC Based VLAN 1:1 VLAN Switching Port Isolation/Leakage Trunking Quality of Service Shaper Ingress Port Policer QoS Group DSCP QoS Map DSCP To DSCP Map Policer QoS Map Access Control List ACL Policer See also Summary The Cloud Router Switch series are highly integrated switches with high-performance MIPS CPU and feature-rich packet processors. The CRS switches can be designed into various Ethernet applications including unmanaged switch, Layer 2 managed switch, carrier switch, and wireless/wired unified packet processing. See configuration examples Cloud Router Switch Features Description Forwarding Configurable ports for switching or routing Full non-blocking wire-speed switching Up to 16k MAC entries in Unicast FDB for Layer 2 unicast forwarding Up to 1k MAC entries in Multicast FDB for multicast forwarding Up to 256 MAC entries in Reserved FDB for control and management purposes All Forwarding Databases support IVL and SVL Configurable Port-based MAC learning limit Jumbo frame support (CRS1xx: 4064 Bytes; CRS2xx: 9204 Bytes) IGMP Snooping support This article applies to CRS1xx and CRS2xx series switches and not to CRS3xx series switches. For CRS3xx series devices, read the CRS3xx, manual. CRS5xx series switches and CCR2116, CCR2216 routers

Mirroring Various types of mirroring: Port-based mirroring VLAN-based mirroring MAC-based mirroring 2 independent mirroring analyzer ports VLAN Fully compatible with IEEE802.1Q and IEEE802.1ad VLAN 4k active VLANs Flexible VLAN assignment: Port-based VLAN Protocol-based VLAN MAC-based VLAN From any to any VLAN translation and swapping 1:1 VLAN switching - VLAN to port mapping VLAN filtering Port Isolation and Leakage Applicable for Private VLAN implementation 3 port profile types: Promiscuous, Isolated, and Community Up to 28 Community profiles Leakage profiles allow bypassing egress VLAN filtering Trunking Supports static link aggregation groups Up to 8 Port Trunk groups Up to 8 member ports per Port Trunk group Hardware automatic failover and load balancing Quality of Service (QoS) Flexible QoS classification and assignment: Port-based MAC-based VLAN-based Protocol-based PCP/DEI based DSCP based ACL based QoS remarking and remapping for QoS domain translation between a service provider and client networks Overriding of each QoS assignment according to the configured priority Shaping and Scheduling 8 queues on each physical port Shaping per port, per queue, per queue group Access Control List Ingress and Egress ACL tables Up to 128 ACL rules (limited by RouterOS) Classification based on ports, L2, L3, L4 protocol header fields ACL actions include filtering, forwarding, and modifying the protocol header fields Cloud Router Switch models This table clarifies the main differences between Cloud Router Switch models. Model Switch Chip CPU Wireless SFP+ port Access Control List Jumbo Frame (Bytes) CRS105-5S-FB QCA-8511 400MHz - - + 9204

CRS106-1C-5S QCA-8511 400MHz - - + 9204 CRS112-8G-4S QCA-8511 400MHz - - + 9204 CRS210-8G-2S+ QCA-8519 400MHz - + + 9204 CRS212-1G-10S-1S+ QCA-8519 400MHz - + + 9204 CRS226-24G-2S+ QCA-8519 400MHz - + + 9204 CRS125-24G-1S QCA-8513L 600MHz - - - 4064 CRS125-24G-1S-2HnD QCA-8513L 600MHz + - - 4064 CRS109-8G-1S-2HnD QCA-8513L 600MHz + - - 4064 Abbreviations and Explanations CVID - Customer VLAN id: inner VLAN tag id of the IEEE 802.1ad frame SVID - Service VLAN id: outer VLAN tag id of the IEEE 802.1ad frame IVL - Independent VLAN learning - learning/lookup is based on both MAC addresses and VLAN IDs. SVL - Shared VLAN learning - learning/lookup is based on MAC addresses - not on VLAN IDs. TPID - Tag Protocol Identifier PCP - Priority Code Point: a 3-bit field which refers to the IEEE 802.1p priority DEI - Drop Eligible Indicator DSCP - Differentiated services Code Point Drop precedence - internal CRS switch QoS attribute used for packet enqueuing or dropping. Port Switching To set up port switching on CRS1xx/2xx series switches, check the page. Bridge Hardware Offloading Multiple switch groups The CRS1xx/2xx series switches allow you to use multiple bridges with hardware offloading, this allows you to easily isolate multiple switch groups. This can be done by simply creating multiple bridges and enabling hardware offloading. Global Settings Dynamic reserved VLAN entries (VLAN4091; VLAN4090; VLAN4089; etc.) are created in the CRS switch when switched port groups are added when a hardware offloaded bridge is created. These VLANs are necessary for internal operation and have lower precedence than user- configured VLANs. Multiple hardware offloaded bridge configuration is designed as a fast and simple port isolation solution, but it limits a part of the VLAN functionality supported by the CRS switch chip. For advanced configurations use one bridge within the CRS switch chip for all ports, configure VLANs, and isolate port groups with port isolation profile configuration. CRS1xx/2xx series switches can run multiple hardware offloaded bridges with (R)STP enabled, but it is not recommended since the device is not designed to run multiple (R)STP instances on a hardware level. To isolate multiple switch groups and have (R)STP enabled you should isolate port groups with port isolation profile configuration.

The CRS switch chip is configurable from the console menu. /interface ethernet switch Sub-menu: /interface ethernet switch Property Description name (string ; value Default: switc )h1Name of the switch. bridge-type (c ustomer-vid- used-as- lookup-vid | service-vid- used-as- ; lookup-vid Default: custo mer-vid-used- ) as-lookup-vidThe bridge type defines which VLAN tag is used as Lookup-VID. Lookup-VID serves as the VLAN key for all VLAN-based lookups. mac-level- isolation (yes ; Default:| no )yesGlobally enables or disables MAC level isolation. Once enabled, the switch will check the source and destination MAC address entries and their from the unicast forwarding table. By default, the switch will learn MAC addresses and place isolation-profile them into a isolation profile. Other isolation profiles can be used when creating static unicast entries. If the source or promiscuous destination MAC address is located on a isolation profile, the packet is forwarded. If both source and destination promiscuous MAC addresses are located on the same or isolation profile, the packet is forwarded. The packet is community1 community2 dropped when the source and destination MAC address isolation profile is , or when the source and destination MAC isolated address isolation profiles are from different communities (e.g. source MAC address is and destination MAC address is community1 ). When MAC level isolation is globally disabled, the isolation is bypassed. community2 use-svid-in- one2one- vlan-lookup (y ; es | no Default: ) noWhether to use service VLAN ID for 1:1 VLAN switching lookup. use-cvid-in- one2one- vlan-lookup (y ; es | no Default: ) yesWhether to use customer VLAN ID for 1:1 VLAN switching lookup. multicast- lookup-mode (dst-ip-and- vid-for-ipv4 | dst-mac-and- ; vid-always Default: dst-ip- and-vid-for- )ipv4Lookup mode for IPv4 multicast bridging. dst-mac-and-vid-always - For all packet types lookup key is the destination MAC and VLAN ID. dst-ip-and-vid-for-ipv4 - For IPv4 packets lookup key is the destination IP and VLAN ID. For other packet types, the lookup key is the destination MAC and VLAN ID. unicast-fdb- timeout (time ; interval Default: ) 5mTimeout for Unicast FDB entries. override- existing- when-ufdb-full ( ; yes | no Default: ) noEnable or disable to override existing entry which has the lowest aging value when UFDB is full.

Property Description drop-if-no-vlan-assignment-on-ports ( ; ports Default: ) nonePorts which drop frames if no MAC-based, Protocol-based VLAN assignment or Ingress VLAN Translation is applied. drop-if-invalid-or-src-port- -not-member-of-vlan-on-ports ( ; Default: ) ports nonePorts that drop invalid and other port VLAN ID frames. unknown-vlan-lookup-mode ( ; Default: ) ivl | svl svl Lookup and learning mode for packets with invalid VLAN. forward-unknown-vlan ( ; Default: ) yes | no yes Whether to allow forwarding VLANs that are not members of the VLAN table. Property Description bypass-vlan-ingress-filter-for ( ; protocols Default: ) noneProtocols that are excluded from Ingress VLAN filtering. These protocols are not dropped if they have invalid VLAN. (arp, dhcpv4, dhcpv6, eapol, igmp, mld, nd, pppoe-discovery, ripv1) bypass-ingress-port-policing-for ( ; protocols Default: ) noneProtocols that are excluded from Ingress Port Policing. (arp, dhcpv4, dhcpv6, eapol, igmp, mld, nd, pppoe-discovery, ripv1) bypass-l2-security-check-filter-for (protocols ; Default: ) noneProtocols that are excluded from Policy rule security check. (arp, dhcpv4, dhcpv6, eapol, igmp, mld, nd, pppoe-discovery, ripv1) Property Description ingress-mirror0 ( ; Default: port | trunk,format no ) ne,modifiedThe first ingress mirroring analyzer port or trunk and mirroring format: analyzer-configured - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the analyzer port. modified - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the egress port. original - Traffic is mirrored without any change to the original incoming packet format. But the service VLAN tag is stripped in the edge port. ingress-mirror1 ( ; Default: port | trunk,format no ) ne,modifiedThe second ingress mirroring analyzer port or trunk and mirroring format: analyzer-configured - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the analyzer port. modified - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the egress port. original - Traffic is mirrored without any change to the original incoming packet format. But the service VLAN tag is stripped in the edge port. ingress-mirror-ratio ( ; Default: ) 1/32768..1/1 1/1 The proportion of ingress mirrored packets compared to all packets. egress-mirror0 ( ; Default: port | trunk,format no ) ne,modifiedThe first egress mirroring analyzer port or trunk and mirroring format: analyzer-configured - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the analyzer port. modified - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the egress port. original - Traffic is mirrored without any change to the original incoming packet format. But the service VLAN tag is stripped in the edge port.

egress-mirror1 ( ; Default: port | trunk,format no ) ne,modifiedThe second egress mirroring analyzer port or trunk and mirroring format: analyzer-configured - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the analyzer port. modified - The packet is the same as the packet to the destination. VLAN format is modified based on the VLAN configurations of the egress port. original - Traffic is mirrored without any change to the original incoming packet format. But the service VLAN tag is stripped in the edge port. egress-mirror-ratio ( ; Default: ) 1/32768..1/1 1/1 Proportion of egress mirrored packets compared to all packets. mirror-egress-if-ingress-mirrored ( ; yes | no Default: ) noWhen a packet is applied to both ingress and egress mirroring, only ingress mirroring is performed on the packet, if this setting is disabled. If this setting is enabled both mirroring types are applied. mirror-tx-on-mirror-port ( ; Default: ) yes | no no mirrored-packet-qos-priority (; Default: ) 0..7 0 Remarked priority in mirrored packets. mirrored-packet-drop-precedence (drop | ; Default: ) green | red | yellow greenRemarked drop precedence in mirrored packets. This QoS attribute is used for mirrored packet enqueuing or dropping. fdb-uses ( ; Default: ) mirror0 | mirror1 mirror0 Analyzer port used for FDB-based mirroring. vlan-uses ( ; Default: ) mirror0 | mirror1 mirror0 Analyzer port used for VLAN-based mirroring. Port Settings Sub-menu: /interface ethernet switch port Property Description vlan-type ( ; edge-port | network-port Default: ) network-portPort VLAN type specifies whether VLAN ID is used in UFDB learning. The network port learns VLAN ID in UFDB, edge port does not - VLAN 0. It can be observed only in IVL learning mode. isolation-leakage-profile-override (ye ; Default: s | no !isolation-leakage-profile-override ) ( ;) isolation-leakage-profile 0..31Custom port profile for port isolation/leakage configurations. Port-level isolation profile 0. Uplink port - allows the port to communicate with all ports in the device. Port-level isolation profile 1. Isolated port - allows the port to communicate only with uplink ports. Port-level isolation profile 2 - 31. Community port - allows communication among the same community ports and uplink ports. learn-override ( ; Default: yes | no ! ) learn-override ( ; Default: learn-limit 1..1023 !learn- )limitEnable or disable MAC address learning and set the MAC limit on the port. MAC learning limit is disabled by default when !learn-override and !learn-limit are set. Property learn-override is replaced with learn under /int menu since RouterOS v6.42. erface bridge port drop-when-ufdb-entry-src-drop (yes ; Default: ) | no yesEnable or disable to drop packets when UFDB entry has action src-drop. allow-unicast-loopback ( ; yes | no Default: ) noUnicast loopback on port. When enabled, it permits sending back when the source port and destination port are the same for known unicast packets. allow-multicast-loopback ( ; yes | no Default: ) noMulticast loopback on port. When enabled, it permits sending back when the source port and destination port are the same for registered multicast or broadcast packets. action-on-static-station-move (copy- to-cpu | drop | forward | redirect-to- ; Default: ) cpu forwardAction for packets when UFDB already contains a static entry with such MAC but with a different port. drop-dynamic-mac-move ( ; yes | no Default: ) noPrevents MAC relearning until UFDB timeout if MAC is already learned on another port.

Property Description allow-fdb-based-vlan-translate ( ; Default: ) yes | no no Enable or disable MAC-based VLAN translation on the port. allow-mac-based-service-vlan-assignment-for (all-frames | none | tagged-frame-only | untagged-and-priority-tagged-frame-only ; Default: ) noneFrame type for which applies MAC-based service VLAN translation. allow-mac-based-customer-vlan-assignment-for (all-frames | none | tagged-frame-only | untagged-and-priority-tagged-frame-only ; Default: ) noneFrame type for which applies MAC-based customer VLAN translation. default-customer-pcp (; Default: ) 0..7 0 Default customer PCP of the port. default-service-pcp (; Default: ) 0..7 0 Default service PCP of the port. pcp-propagation-for-initial-pcp ( ; Default: ) yes | no no Enables or disables PCP propagation for initial PCP assignment on ingress. If the port vlan-type is Edge port, the service PCP is copied from the customer PCP. If the port vlan-type is a Network port, the customer PCP is copied from the service PCP. filter-untagged-frame ( ; Default: ) yes | no no Whether to filter untagged frames on the port. filter-priority-tagged-frame ( ; Default: ) yes | no no Whether to filter tagged frames with priority on the port. filter-tagged-frame ( ; Default: ) yes | no no Whether to filter tagged frames on the port. Property Description egress-vlan-tag-table-lookup-key (accordin ; Default: g-to-bridge-type | egress-vid egre ) ss-vidEgress VLAN table (VLAN Tagging) lookup: egress-vid - Lookup VLAN ID is CVID when Edge port is configured, SVID when Network port is configured. according-to-bridge-type - Lookup VLAN ID is CVID when customer VLAN bridge is configured, SVID when service VLAN bridge is configured. The Customer tag is unmodified for Edge port in service VLAN bridge. egress-vlan-mode (tagged | unmodified | ; Default: ) untagged unmodifiedEgress VLAN tagging action on the port. egress-pcp-propagation ( ; Default: yes | no )noEnables or disables egress PCP propagation. If the port vlan-type is Edge port, the service PCP is copied from the customer PCP. If the port vlan-type is Network port, the customer PCP is copied from the service PCP. Property Description ingress-mirror-to ( ; Default: ) mirror0 | mirror1 | none none Analyzer port for port-based ingress mirroring. ingress-mirroring-according-to-vlan ( ; Default: ) yes | no no egress-mirror-to ( ; Default: ) mirror0 | mirror1 | none none Analyzer port for port-based egress mirroring.

Property Description qos-scheme-precedence (da-based | dscp-based | ingress-acl-based | pcp- ; Default: based | protocol-based | sa-based | vlan-based pcp-based, sa- ) based, da-based, dscp-based, protocol-based, vlan-basedSpecifies applied QoS assignment schemes on the ingress of the port. da-based dscp-based ingress-acl-based pcp-based protocol-based sa-based vlan-based pcp-or-dscp-based-qos-change-dei ( ; Default: ) yes | no no Enable or disable PCP or DSCP based DEI change on port. pcp-or-dscp-based-qos-change-pcp ( ; Default: ) yes | no no Enable or disable PCP or DSCP based PCP change on port. pcp-or-dscp-based-qos-change-dscp ( ; Default: ) yes | no no Enable or disable PCP or DSCP based DSCP change on port. dscp-based-qos-dscp-to-dscp-mapping ( ; Default: ) yes | no yes Enable or disable DSCP to internal DSCP mapping on port. pcp-based-qos-drop-precedence-mapping (PCP/DEI-range:drop- ; Default: ) precedence 0-15:greenThe new value of drop precedence for the PCP/DEI to drop precedence (drop | green | red | yellow) mapping. Multiple mappings are allowed separated by a comma e.g. "0-7:yellow,8-15:red". pcp-based-qos-dscp-mapping ( ; Default: ) PCP/DEI-range:DEI 0-15:0 The new value of DSCP for the PCP/DEI to DSCP (0..63) mapping. Multiple mappings are allowed separated by a comma e.g. "0-7:25,8- 15:50". pcp-based-qos-dei-mapping ( ; Default: ) PCP/DEI-range:DEI 0-15:0 The new value of DEI for the PCP/DEI to DEI (0..1) mapping. Multiple mappings are allowed separated by a comma e.g. "0-7:0,8-15:1". pcp-based-qos-pcp-mapping ( ; Default: ) PCP/DEI-range:DEI 0-15:0 The new value of PCP for the PCP/DEI to PCP (0..7) mapping. Multiple mappings are allowed separated by a comma e.g. "0-7:3,8- 15:4". pcp-based-qos-priority-mapping ( ; Default: ) PCP/DEI-range:DEI 0-15:0 The new value of internal priority for the PCP/DEI to priority (0..15) mapping. Multiple mappings are allowed separated by a comma e.g. "0-7:5,8-15:15". Property Description priority-to-queue ( ; Default: priority-range:queue 0-15:0,1: ) 1,2:2,3:3Internal priority (0..15) mapping to queue (0..7) per port. per-queue-scheduling ( ; Scheduling-type:Weight Default: wrr-group0:1,wrr-group0:2,wrr-group0:4,wrr- group0:8,wrr-group0:16,wrr-group0:32, ) wrr-group0:64,wrr-group0:128Set port to use either strict or weighted round robin policy for traffic shaping for each queue group, each queue is separated by a comma. Property Description

ingress-customer-tpid-override (yes ;| no Default: !ingress-customer-tpid- ) override ( ; ingress-customer-tpid 0..10000 Default: ) 0x8100Ingress customer TPID override allows accepting specific frames with a custom customer tag TPID. The default value is for the tag of 802.1Q frames. egress-customer-tpid-override (yes ; Default:| no !egress-customer-tpid-override ) ( ; egress-customer-tpid 0..10000 Default: ) 0x8100Egress customer TPID override allows custom identification for egress frames with a customer tag. The default value is for the tag of 802.1Q frames. ingress-service-tpid-override (yes | ; Default:no !ingress-service-tpid-override ) ( ; ingress-service-tpid 0..10000 Default: ) 0x88A8Ingress service TPID override allows accepting specific frames with a custom service tag TPID. The default value is for the service tag of 802.1AD frames. egress-service-tpid-override (yes | ; Default:no !egress-service-tpid-override ) ( ; egress-service-tpid 0..10000 Default: ) 0x88A8Egress service TPID override allows custom identification for egress frames with a service tag. The default value is for the service tag of 802.1AD frames. Property Description custom-drop-counter-includes ( ; Default: ) counters none Custom include to count dropped packets for switch port custom-drop-packet counter. device-loopback fdb-hash-violation exceeded-port-learn-limitation dynamic-station-move static-station-move ufdb-source-drop host-source-drop unknown-host ingress-vlan-filtered queue-custom-drop-counter0-includes ( ; Default: counters none )Custom include to count dropped packets for switch port tx-queue-custom0-drop- packet and bytes for tx-queue-custom0-drop-byte counters. red yellow green queue0 ... queue7

queue-custom-drop-counter1-includes ( ; Default: counters none )Custom include to count dropped packets for switch port tx-queue-custom1-drop- packet and bytes for tx-queue-custom1-drop-byte counters. red yellow green queue0 ... queue7 policy-drop-counter-includes ( ; Default: ) counters none Custom include to count dropped packets for switch port policy-drop-packet counter. ingress-policing ingress-acl egress-policing egress-acl Forwarding Databases Unicast FDB The unicast forwarding database supports up to 16318 MAC entries. Sub-menu: /interface ethernet switch unicast-fdb Property Description action ( ; Default: ) action forward Action for UFDB entry: dst-drop - Packets are dropped when their destination MAC matches the entry. dst-redirect-to-cpu - Packets are redirected to the CPU when their destination MAC matches the entry. forward - Packets are forwarded. src-and-dst-drop - Packets are dropped when their source MAC or destination MAC matches the entry. src-and-dst-redirect-to-cpu - Packets are redirected to CPU when their source MAC or destination MAC matches the entry. src-drop - Packets are dropped when their source MAC matches the entry. src-redirect-to-cpu - Packets are redirected to the CPU when their source MAC matches the entry. disabled ( ; Default: ) yes | no no Enables or disables Unicast FDB entry. isolation-profile (community1 | community2 | isolated | ; Default: ) promiscuous promiscuousMAC level isolation profile. mac-address ( ) MAC address Theaction command applies to the packet when the destination MAC or source MAC matches the entry. mirror ( ; Default: ) yes | no no Enables or disables mirroring based on source MAC or destination MAC. port ()port Matching port for the Unicast FDB entry. qos-group ( ; Default: ) none none Defined QoS group from QoS group menu.

svl ( ; Default: ) yes | no no Unicast FDB learning mode: Shared VLAN Learning (svl) - learning/lookup is based on MAC addresses - not on VLAN IDs. Independent VLAN Learning (ivl) - learning/lookup is based on both MAC addresses and VLAN IDs. vlan-id ( ) 0..4095 Unicast FDB lookup/learning VLAN id. Multicast FDB CRS125 switch-chip supports up to 1024 entries in MFDB for multicast forwarding. For each multicast packet, destination MAC or destination IP lookup is performed in MFDB. MFDB entries are not automatically learned and can only be configured. Sub-menu: /interface ethernet switch multicast-fdb Property Description address (X.X.X.X | XX:XX:XX:XX:XX: )XXMatching IP address or MAC address for multicast packets. bypass-vlan-filter ( ; Default: ) yes | no no Allow to bypass VLAN filtering for matching multicast packets. disabled ( ; Default: ) yes | no no Enables or disables Multicast FDB entry. ports ( ) ports Member ports for multicast traffic. qos-group ( ; Default: ) none none Defined QoS group from QoS group menu. svl ( ; Default: ) yes | no no Multicast FDB learning mode: Shared VLAN Learning (svl) - learning/lookup is based on MAC addresses - not on VLAN IDs. Independent VLAN Learning (ivl) - learning/lookup is based on both MAC addresses and VLAN IDs. vlan-id ( ; Default: ) 0..4095 0 Multicast FDB lookup VLAN ID. If the VLAN learning mode is IVL, VLAN id is lookup id, otherwise VLAN id = 0. Reserved FDB Cloud Router Switch supports 256 RFDB entries. Each RFDB entry can store either Layer2 unicast or multicast MAC address with specific commands. Sub-menu: /interface ethernet switch reserved-fdb Property Description action ( ; Default: copy-to-cpu | drop | forward | redirect-to-cpu ) forwardAction for RFDB entry: copy-to-cpu - Packets are copied to the CPU when their destination MAC matches the entry. drop - Packets are dropped when their destination MAC matches the entry. forward - Packets are forwarded when their destination MAC matches the entry. redirect-to-cpu - Packets are redirected to CPU when their destination MAC matches the entry. bypass-ingress-port-policing ( ; Default: ) yes | no no Allow to bypass Ingress Port Policer for matching packets. bypass-ingress-vlan-filter ( ; Default: ) yes | no no Allow to bypass VLAN filtering for matching packets. disabled ( ; Default: ) yes | no no Enables or disables Reserved FDB entry. mac-address ( ; Default: ) MAC address 00:00:00:00:00:00 Matching MAC address for Reserved FDB entry. qos-group ( ; Default: ) none none Defined QoS group from QoS group menu.

VLAN VLAN Table The VLAN table supports 4096 VLAN entries for storing VLAN member information as well as other VLAN information such as QoS, isolation, forced VLAN, learning, and mirroring. Sub-menu: /interface ethernet switch vlan Property Description disabled ( ; Default: ) yes | no no Indicate whether the VLAN entry is disabled. Only enabled entry is applied to the lookup process and forwarding decision. flood ( ; Default: ) yes | no no Enables or disables forced VLAN flooding per VLAN. If the feature is enabled, the result of the destination MAC lookup in the UFDB or MFDB is ignored, and the packet is forced to flood in the VLAN. ingress-mirror ( ; Default: yes | no )noEnable the ingress mirror per VLAN to support the VLAN-based mirror function. learn ( ; Default: ) yes | no yes Enables or disables source MAC learning for VLAN. ports ( ) ports Member ports of the VLAN. qos-group ( ; Default: ) none none Defined QoS group from QoS group menu. svl ( ; Default: ) yes | no no FDB lookup mode for lookup in UFDB and MFDB. Shared VLAN Learning (svl) - learning/lookup is based on MAC addresses - not on VLAN IDs. Independent VLAN Learning (ivl) - learning/lookup is based on both MAC addresses and VLAN IDs. vlan-id ( ) 0..4095 VLAN ID of the VLAN member entry. Egress VLAN Tag Egress packets can be assigned different VLAN tag formats. The VLAN tags can be removed, added, or remained as is when the packet is sent to the egress port (destination port). Each port has dedicated control of the egress VLAN tag format. The tag formats include: Untagged Tagged Unmodified The Egress VLAN Tag table includes 4096 entries for VLAN tagging selection. Sub-menu: /interface ethernet switch egress-vlan-tag Property Description disabled ( ; Default: ) yes | no no Enables or disables Egress VLAN Tag table entry. tagged-ports ( ) ports Ports that are tagged in egress. vlan-id ( ) 0..4095 VLAN ID which is tagged in egress. Ingress/Egress VLAN Translation The Ingress VLAN Translation table allows for up to 15 entries for each port. One or multiple fields can be selected from the packet header for lookup in the Ingress VLAN Translation table. The S-VLAN or C-VLAN or both configured in the first matched entry are assigned to the packet. Sub-menu: /interface ethernet switch ingress-vlan-translation

Sub-menu: /interface ethernet switch egress-vlan-translation Property Description customer-dei (; Default: ) 0..1 none Matching DEI of the customer tag. customer-pcp (; Default: ) 0..7 none Matching PCP of the customer tag. customer-vid ( ; Default: ) 0..4095 none Matching the VLAN ID of the customer tag. customer-vlan-format (any | priority-tagged-or-tagged | ; Default: ) tagged | untagged-or-tagged anyType of frames with customer tag for which VLAN translation rule is valid. disabled ( ; Default: ) yes | no no Enables or disables VLAN translation entry. new-customer-vid ( ; Default: ) 0..4095 none The new customer VLAN ID replaces the matching customer VLAN ID. If set to 4095 and ingress VLAN translation is used, then traffic is dropped. new-service-vid ( ; Default: ) 0..4095 none The new service VLAN ID replaces the matching service VLAN ID. pcp-propagation ( ; Default: ) yes | no no Enables or disables PCP propagation. If the port type is Edge, the customer PCP is copied from the service PCP. If the port type is Network, the service PCP is copied from the customer PCP. ports ( ) ports Matching switch ports for VLAN translation rule. protocol ( ; Default: ) protocols none Matching Ethernet protocol. (only for Ingress VLAN Translation) sa-learning ( ; Default: ) yes | no no Enables or disables source MAC learning after VLAN translation. (only for Ingress VLAN Translation) service-dei (; Default: ) 0..1 none Matching DEI of the service tag. service-pcp (; Default: ) 0..7 none Matching PCP of the service tag. service-vid ( ; Default: ) 0..4095 none Matching VLAN ID of the service tag. service-vlan-format (any | priority-tagged-or-tagged | ; Default: ) tagged | untagged-or-tagged anyType of frames with service tag for which VLAN translation rule is valid. Below is a table of traffic that triggers a rule that has a certain VLAN format set, note that traffic that is tagged with VLAN ID 0 is a special case that is also taken into account. Property Description any Accepts: Untagged traffic Tagged traffic Tagged traffic with priority set VLAN 0 traffic VLAN 0 traffic with priority set priority-tagged-or-tagged Accepts: Tagged traffic Tagged traffic with priority set VLAN 0 traffic VLAN 0 traffic with priority set tagged Accepts: Tagged traffic Tagged traffic with priority set

untagged-or-tagged Accepts: Untagged traffic Tagged traffic Tagged traffic with priority set Protocol Based VLAN Protocol Based VLAN table is used to assign VID and QoS attributes to related protocol packets per port. Sub-menu: /interface ethernet switch protocol-based-vlan Property Description disabled ( ; Default: ) yes | no no Enables or disables Protocol Based VLAN entry. frame-type ( ; Default: ) ethernet | llc | rfc-1042 ethernet Encapsulation type of the matching frames. new-customer-vid ( ; Default: ) 0..4095 0 The new customer VLAN ID replaces the original customer VLAN ID for the specified protocol. If set to 4095, then traffic is dropped. new-service-vid ( ; Default: ) 0..4095 0 The new service VLAN ID replaces the original service VLAN ID for the specified protocol. ports ( ) ports Matching switch ports for Protocol-based VLAN rule. protocol ( ; Default: ) protocol 0 Matching protocol for Protocol-based VLAN rule. qos-group ( ; Default: ) none none Defined QoS group from QoS group menu. set-customer-vid-for (all | none | tagged | untagged-or- ; Default: ) priority-tagged allCustomer VLAN ID assignment command for different packet types. set-qos-for (all | none | tagged | untagged-or-priority- ; Default: ) tagged noneFrame type for which QoS assignment command applies. set-service-vid-for (all | none | tagged | untagged-or- ; Default: ) priority-tagged allService VLAN ID assignment command for different packet types. MAC Based VLAN MAC Based VLAN table is used to assign VLAN based on the source MAC. Sub-menu: /interface ethernet switch mac-based-vlan Property Description disabled ( ; Default: ) yes | no no Enables or disables MAC Based VLAN entry. new-customer-vid ( ; 0..4095 Default: ) 0The new customer VLAN ID replaces the original service VLAN ID for matched packets. If set to 4095, then traffic is dropped. new-service-vid ( ; Default: 0..4095 0 )The new service VLAN ID replaces the original service VLAN ID for matched packets. src-mac-address ( ) MAC address Matching source MAC address for MAC based VLAN rule. If is set to , then set to will trigger the switch rule with VLAN 0 traffic. In this case, the VLAN-format any customer-vid / service-vid 0 switch rule will be looking for untagged traffic or traffic with a VLAN 0 tag, and only will filter out VLAN 0 traffic in this untagged-or-tagged case.

1:1 VLAN Switching 1:1 VLAN switching can be used to replace the regular L2 bridging for matched packets. When a packet hits a 1:1 VLAN switching table entry, the destination port information in the entry is assigned to the packet. The matched destination information in the UFDB and MFDB entry no longer applies to the packet. Sub-menu: /interface ethernet switch one2one-vlan-switching Property Description customer-vid ( ; Default: ) 0..4095 0Matching customer VLAN id for 1:1 VLAN switching. disabled ( ; Default: ) yes | no no Enables or disables 1:1 VLAN switching table entry. dst-port ()port Destination port for matched 1:1 VLAN switching packets. service-vid ( ; Default: ) 0..4095 0 Matching customer VLAN id for 1:1 VLAN switching. Port Isolation/Leakage The CRS switches support flexible multi-level isolation features, which can be used for user access control, traffic engineering and advanced security and network management. The isolation features provide an organized fabric structure allowing user to easily program and control the access by port, MAC address, VLAN, protocol, flow, and frame type. The following isolation and leakage features are supported: Port-level isolation MAC-level isolation VLAN-level isolation Protocol-level isolation Flow-level isolation Free combination of the above Port-level isolation supports different control schemes on the source port and destination port. Each entry can be programmed with access control for either the source port or the destination port. When the entry is programmed with source port access control, the entry is applied to the ingress packets. When the entry is programmed with destination port access control, the entry is applied to the egress packets. Port leakage allows bypassing egress VLAN filtering on the port. A leaky port is allowed to access other ports for various applications such as security, network control, and management. Note: When both isolation and leakage are applied to the same port, the port is isolated. Sub-menu: /interface ethernet switch port-isolation Sub-menu: /interface ethernet switch port-leakage Property Description disabled ( ; Default: ) yes | no no Enables or disables port isolation/leakage entry. flow-id ( ; Default: ) 0..63 none forwarding-type ( ; Default: ) bridged; routed bridged,routed Matching traffic forwarding type on Cloud Router Switch. mac-profile ( ; community1 | community2 | isolated | promiscuous Default: ) noneMatching MAC isolation/leakage profile. All CRS1xx/2xx series switches support up to 1024 MAC Based VLAN table entries.

port-profile ( ; Default: ) 0..31 none Matching Port isolation/leakage profile. ports ( ; Default: ) ports none Isolated/leaked ports. protocol-type ( ; Default: arp; nd; dhcpv4; dhcpv6; ripv1 arp,nd, ) dhcpv4,dhcpv6,ripv1Included protocols for isolation/leakage. registration-status ( ; Default: ) known; unknown known,unknown Registration status for matching packets. Known are present in UFDB and MFDB, and unknown are not. traffic-type ( ; Default: unicast; multicast; broadcast unicast, ) multicast,broadcastMatching traffic type. type ( ; Default: ) dst | src src Lookup type of the isolation/leakage entry: src- Entry applies to ingress packets of the ports. dst- Entry applies to egress packets of the ports. vlan-profile ( ; community1 | community2 | isolated | promiscuous Default: ) noneMatching VLAN isolation/leakage profile. Trunking The Trunking in the Cloud Router Switches provides static link aggregation groups with hardware automatic failover and load balancing. IEEE802.3ad and IEEE802.1ax compatible Link Aggregation Control Protocol is not supported. Up to 8 Trunk groups are supported with up to 8 Trunk member ports per Trunk group. CRS Port Trunking calculates transmit-hash based on all following parameters: L2 src-dst MAC + L3 src-dst IP + L4 src-dst Port. Sub-menu: /interface ethernet switch trunk Property Description disabled ( ; Default: ) yes | no no Enables or disables port trunking entry. member-ports ( ) ports Member ports of the Trunk group. name ( ; Default: ) string value trunkX Name of the Trunk group. Quality of Service Shaper Traffic shaping restricts the rate and burst size of the flow which is transmitted out from the interface. The shaper is implemented by a token bucket. If the packet exceeds the maximum rate or the burst size, which means not enough token for the packet, the packet is stored to buffer until there is enough token to transmit it. Sub-menu: /interface ethernet switch shaper Property Description burst ( ; Default: ) integer 100k Maximum data rate which can be transmitted while the burst is allowed. disabled ( ; Default: ) yes | no no Enables or disables traffic shaper entry. meter-unit ( ; Default: ) bit | packet bit Measuring units for traffic shaper rate. port ()port Physical port for traffic shaper. rate ( ; Default: ) integer 1M Maximum data rate limit.

target ( ; port | queueX | wrr-groupX Default: ) portThree levels of shapers are supported on each port (including CPU port): Port level - Entry applies to the port of the switch-chip. WRR group level - Entry applies to one of the 2 Weighted Round Robin queue groups (wrr-group0, wrr-group1) on the port. Queue level - Entry applies to one of the 8 queues (queue0 - queue7) on the port. Ingress Port Policer Sub-menu: /interface ethernet switch ingress-port-policer Property Description burst ( ; Default: ) integer 100k Maximum data rate which can be transmitted while the burst is allowed. disabled ( ; Default: ) yes | no no Enables or disables ingress port policer entry. meter-len ( ; Default: ) layer-1 | layer-2 | layer-3 layer-1 Packet classification which sets the packet byte length for metering. layer-1 - includes entire layer-2 frame + FCS + inter-packet gap + preamble. layer-2 - includes layer-2 frame + FCS. layer-3 - includes only layer-3 + ethernet padding without layer-2 header and FCS. meter-unit ( ; Default: ) bit | packet bit Measuring units for traffic ingress port policer rate. new-dei-for-yellow ( ; Default: ) 0..1 | remap none Remarked DEI for exceeded traffic if yellow-action is remark. new-dscp-for-yellow ( ; Default: ) 0..63 | remap none Remarked DSCP for exceeded traffic if yellow-action is remark. new-pcp-for-yellow ( ; Default: ) 0..7 | remap none Remarked PCP for exceeded traffic if yellow-action is remark. packet-types ( ; Default: packet-types all types from ) descriptionMatching packet types for which ingress port policer entry is valid. port ()port Physical port or trunk for ingress port policer entry. rate ( ) integer Maximum data rate limit. yellow-action ( ; Default: ) drop | forward | remark drop Performed action for exceeded traffic. QoS Group The global QoS group table is used for VLAN-based, Protocol-based, and MAC-based QoS group assignment configuration. Sub-menu: /interface ethernet switch qos-group Property Description dei (; Default: ) 0..1 none The new value of DEI for the QoS group. disabled ( ; Default: ) yes | no no Enables or disables protocol QoS group entry. drop-precedence ( ; drop | green | red | yellow Default: ) greenDrop precedence is an internal QoS attribute used for packet enqueuing or dropping. dscp ( ; Default: ) 0..63 none The new value of DSCP for the QoS group. name ( ; Default: ) string value groupX Name of the QoS group. pcp (; Default: ) 0..7 none The new value of PCP for the QoS group. priority ( ; Default: ) 0..15 0 Internal priority is a local significance of priority for classifying traffic to different egress queues on a port. (1 is highest, 15 is lowest)

DSCP QoS Map The global DSCP to QOS mapping table is used for mapping from the DSCP of the packet to new QoS attributes configured in the table. Sub-menu: /interface ethernet switch dscp-qos-map Property Description dei ()0..1 The new value of DEI for the DSCP to QOS mapping entry. drop-precedence ( ) drop | green | red | yellow The new value of Drop precedence for the DSCP to QOS mapping entry. pcp ()0..7 The new value of PCP for the DSCP to QOS mapping entry. priority ( ) 0..15 The new value of internal priority for the DSCP to QOS mapping entry. DSCP To DSCP Map The global DSCP to DSCP mapping table is used for mapping from the packet's original DSCP to the new DSCP value configured in the table. Sub-menu: /interface ethernet switch dscp-to-dscp Property Description new-dscp ( ) 0..63 The new value of DSCP for the DSCP to DSCP mapping entry. Policer QoS Map Sub-menu: /interface ethernet switch policer-qos-map Property Description dei-for-red (; Default: ) 0..1 0 Policer DEI remapping value for red packets. dei-for-yellow (; Default: ) 0..1 0 Policer DEI remapping value for yellow packets. dscp-for-red ( ; Default: ) 0..63 0 Policer DSCP remapping value for red packets. dscp-for-yellow ( ; Default: ) 0..63 0Policer DSCP remapping value for yellow packets. pcp-for-red (; Default: ) 0..7 0 Policer PCP remapping value for red packets. pcp-for-yellow (; Default: ) 0..7 0 Policer PCP remapping value for yellow packets. Access Control List Access Control List contains of ingress policy and egress policy engines and allows configuration of up to 128 policy rules (limited by RouterOS). It is an advanced tool for wire-speed packet filtering, forwarding, shaping, and modifying based on Layer2, Layer3, and Layer4 protocol header field conditions. Sub-menu: /interface ethernet switch acl ACL condition part for MAC-related fields of packets. See the Summary section for Access Control List supported Cloud Router Switch devices. Due to hardware limitations, it is not possible to match broadcast/multicast traffic on specific ports. You should use port isolation, drop traffic on ingress ports, or use VLAN filtering to prevent certain broadcast/multicast traffic from being forwarded.

Property Description disabled ( ; Default: ) yes | no no Enables or disables ACL entry. table ( ; Default: ) egress | ingress ingress Selects the policy table for incoming or outgoing packets. invert-match ( ; Default: ) yes | no no Inverts the whole ACL rule matching. src-ports ( ) ports,trunks Matching physical source ports or trunks. dst-ports ( ) ports,trunks Matching physical destination ports or trunks. It is not possible to match broadcast/multicast traffic on the egress port due to a hardware limitation. mac-src-address ( ) MAC address/Mask Source MAC address and mask. mac-dst-address ( ) MAC address/Mask Destination MAC address and mask. dst-addr-registered ( ) yes | no Defines whether to match packets with registered state - packets whose destination MAC address is in UFDB/MFDB/RFDB. Valid only in the egress table. mac-protocol (802.2 | arp | homeplug-av | ip | ip-or-ipv6 | ipv6 | ipx | lldp | loop-protect | mpls- multicast | mpls-unicast | non-ip | packing-compr | packing-simple | pppoe | pppoe-discovery | ) rarp | service-vlan | vlan or integer: 0..65535 decimal format or 0x0000-0xffff hex formatEthernet payload type (MAC-level protocol) 802.2 - 802.2 Frames (0x0004) arp - Address Resolution Protocol (0x0806) capsman - CAPsMAN to CAP MAC layer connection ( ) 0x88BB dot1x - EAPoL IEEE 802.1X ( ) 0x888E homeplug-av - HomePlug AV MME (0x88E1) ip - Internet Protocol version 4 (0x0800) ip-or-ipv6 - IPv4 or IPv6 (0x0800 or 0x86DD) ipv6 - Internet Protocol Version 6 (0x86DD) ipx - Internetwork Packet Exchange (0x8137) lacp - Link Aggregation Control Protocol ( 0x8809 ) lldp - Link Layer Discovery Protocol (0x88CC) loop-protect - Loop Protect Protocol (0x9003) macsec - MAC security IEEE 802.1AE (0x88E5) mpls-multicast - MPLS multicast (0x8848) mpls-unicast - MPLS unicast (0x8847) non-ip - Not Internet Protocol version 4 (not 0x0800) packing-compr - Encapsulated packets with compressed (0x9001) IP packing packing-simple - Encapsulated packets with simple (0x9000) IP packing pppoe - PPPoE Session Stage (0x8864) pppoe-discovery - PPPoE Discovery Stage (0x8863) rarp - Reverse Address Resolution Protocol (0x8035) romon - Router Management Overlay Network RoMON ( ) 0x88BF service-vlan - Provider Bridging (IEEE 802.1 ad) & Shortest Path Bridging IEEE 802.1aq (0x88A8) vlan - VLAN-tagged frame (IEEE 802.1Q) and Shortest Path Bridging IEEE 802.1aq with NNI compatibility (0x8100) drop-precedence ( ) drop | green | red | yellow Matching internal drop precedence. Valid only in the egress table.

custom-fields ACL condition part for VLAN-related fields of packets. Property Description lookup-vid ( ) 0..4095 VLAN id used in lookup. It can be changed before reaching the egress table. service-vid ( ) 0-4095 Matching service VLAN id. service-pcp ()0..7 Matching service PCP. service-dei ()0..1 Matching service DEI. service-tag ( ) priority-tagged | tagged | tagged-or-priority-tagged | untagged Format of the service tag. customer-vid ( ) 0-4095 Matching customer VLAN ID. customer-pcp ()0..7 Matching customer PCP. customer-dei ()0..1 Matching customer DEI. customer-tag (priority-tagged | tagged | tagged-or-priority-tagged | ) untaggedFormat of the customer tag. priority ( ) 0..15 Matching internal priority. Valid only in the egress table. ACL condition part for IPv4 and IPv6 related fields of packets. Property Description ip-src ( ) IPv4/0..32 Matching source IPv4 address. ip-dst ( ) IPv4/0..32 Matching destination IPv4 address. ip-protocol ( ) tcp | udp | udp-lite | other IP protocol type. src-l3-port ( ) 0-65535 Matching Layer3 source port. dst-l3-port ( ) 0-65535 Matching Layer3 destination port. ttl ( ) 0 | 1 | max | other Matching TTL field of the packet. dscp ( ) 0..63 Matching DSCP field of the packet. ecn ()0..3 Matching ECN field of the packet. fragmented ( ) yes | no Whether to match fragmented packets. first-fragment ( ) yes | no YES matches not fragmented and the first fragments, NO matches other fragments. ipv6-src ( ) IPv6/0..128 Matching source IPv6 address. ipv6-dst ( ) IPv6/0..128 Matching destination IPv6 address. mac-isolation-profile (community1 | community2 | ) isolated | promiscuousMatches isolation profile based on UFDB. Valid only in the egress policy table. src-mac-addr-state (dynamic-station-move | sa- ) found | sa-not-found | static-station-moveDefines whether to match packets with registered state - packets whose destination MAC address is in UFDB/MFDB/RFDB. Valid only in the egress policy table. flow-id ( ) 0..63 ACL rule action part. Property Description

action (copy-to-cpu | drop | forward | redirect-to-cpu | send-to-new-dst-ports ; Default: ) forwardcopy-to-cpu - Packets are copied to the CPU if they match the ACL conditions. drop - Packets are dropped if they match the ACL conditions. forward - Packets are forwarded if they match the ACL conditions. redirect-to-cpu - Packets are redirected to the CPU if they match the ACL conditions. send-to-new-dst-ports - Packets are sent to new destination ports if they match the ACL conditions. new-dst-ports ( ) ports,trunks If the action is "send-to-new-dst-ports", then this property sets which ports/trunks are the new destinations. mirror-to ( ) mirror0 | mirror1 Mirroring destination for ACL packets. policer ( ) policer Applied ACL Policer for ACL packets. src-mac-learn ( ) yes | no Whether to learn the source MAC of the matched ACL packets. Valid only in the ingress policy table. new-service-vid ( ) 0..4095 New service VLAN ID for ACL packets. new-service-pcp ()0..7 New service PCP for ACL packets. new-service-dei ()0..1 New service DEI for ACL packets. new-customer-vid ( ) 0..4095 New customer VLAN ID for ACL packets. If set to 4095, then traffic is dropped. new-customer-pcp ()0..7 New customer PCP for ACL packets. new-customer-dei ()0..1 New customer DEI for ACL packets. new-dscp ( ) 0..63 New DSCP for ACL packets. new-priority ( ) 0..15 New internal priority for ACL packets. new-drop-precedence (drop | green | ) red | yellowNew internal drop precedence for ACL packets. new-registered-state ( ) yes | no Whether to modify packet status. YES sets packet status to registered, NO - unregistered. Valid only in the ingress policy table. new-flow-id ( ) 0..63 Filter bypassing part for ACL packets. Property Description attack-filter-bypass ( ; Default: ) yes | no no ingress-vlan-filter-bypass ( ; yes | no Default: ) noAllows bypassing ingress VLAN filtering in the VLAN table for matching packets. This applies only to the ingress policy table. egress-vlan-filter-bypass ( ; yes | no Default: ) noAllows bypassing egress VLAN filtering in the VLAN table for matching packets. This applies only to the ingress policy table. isolation-filter-bypass ( ; Default: ) yes | no no Allows bypassing the Isolation table for matching packets. This applies only to the ingress policy table. egress-vlan-translate-bypass ( ; yes | no Default: ) noAllows bypassing egress VLAN translation table for matching packets. ACL Policer Sub-menu: /interface ethernet switch acl policer Property Description name ( ; Default: ) string policerX Name of the Policer used in ACL. yellow-rate ( ) integer Maximum data rate limit for packets with yellow drop precedence.

yellow-burst ( ; Default: ) integer 0 Maximum data rate which can be transmitted while the burst is allowed for packets with yellow drop precedence. red-rate ( ); Default: ) integer 0 Maximum data rate limit for packets with red drop precedence. red-burst ( ; Default: ) integer 0 Maximum data rate which can be transmitted while the burst is allowed for packets with red drop precedence. meter-unit ( ; Default: ) bit | packet bit Measuring units for ACL traffic rate. meter-len ( ; Default: layer-1 | layer-2 | layer-3 la ) yer-1Packet classification which sets the packet byte length for metering. layer-1 - includes entire layer-2 frame + FCS + inter-packet gap + preamble. layer-2 - includes layer-2 frame + FCS. layer-3 - includes only layer-3 + ethernet padding without layer-2 header and FCS. color-awareness ( ; Default: ) yes | no no YES makes the policer to take into account pre-colored drop precedence, NO - ignores drop precedence. bucket-coupling ( ; Default: ) yes | no no yellow-action ( ; Default: drop | forward | remark )dropPerformed action for exceeded traffic with yellow drop precedence. new-dei-for-yellow ( ) 0..1 | remap New DEI for yellow drop precedence packets. new-pcp-for-yellow ( ) 0..7 | remap New PCP for yellow drop precedence packets. new-dscp-for-yellow ( ) 0..63 | remap New DSCP for yellow drop precedence packets. red-action ( ; Default: drop | forward | remark dr )opPerformed action for exceeded traffic with red drop precedence. new-dei-for-red ( ) 0..1 | remap New DEI for red drop precedence packets. new-pcp-for-red ( ) 0..7 | remap New PCP for red drop precedence packets. new-dscp-for-red ( ) 0..63 | remap New DSCP for red drop precedence packets. See also CRS1xx/2xx series switches examples CRS Router CRS1xx/2xx VLANs with Trunks Basic VLAN switching Bridge Hardware Offloading Spanning Tree Protocol IGMP Snooping DHCP Snooping and Option 82 MTU on RouterBOARD Layer2 misconfiguration

L3 Hardware Offloading Introduction Switch Configuration Switch Port Configuration L3HW Settings Basic Settings Advanced Settings Monitor Advanced Monitor Interface Lists MTU Layer 2 Dependency MAC telnet Inter-VLAN Routing L3HW MAC Address Range Limitation (DX2000/DX3000 series only) Route Configuration Suppressing HW Offload Routing Filters Offloading Fasttrack Connections Stateless Hardware Firewall Switch Rules (ACL) vs. Fasttrack HW Offloading Configuration Examples Inter-VLAN Routing with Upstream Port Behind Firewall/NAT Typical Misconfiguration VLAN interface on a switch port or bond Not adding the bridge interface to /interface/bridge/vlan/ Creating multiple bridges Using ports that do not belong to the switch Relying on Fasttrack HW Offloading too much Trying to offload slow-path connections L3HW Feature Support L3HW Device Support CRS3xx: Switch DX3000 and DX2000 Series CRS3xx, CRS5xx: Switch DX8000 and DX4000 Series CCR2000 Introduction ( , otherwise known as IP switching or HW routing) allows to offload some router features onto the switch chip. This Layer 3 Hardware Offloading L3HW allows reaching wire speeds when routing packets, which would simply not be possible with the CPU. Switch Configuration To enable Layer 3 Hardware Offloading, set for the switch: l3-hw-offloading=yes /interface/ethernet/switch set 0 l3-hw-offloading=yes Switch Port Configuration Layer 3 Hardware Offloading can be configured for each physical switch port. For example: /interface/ethernet/switch/port set sfp-sfpplus1 l3-hw-offloading=yes Note that l3hw settings for switch and ports are different: Setting for the switch completely disables offloading - all packets will be routed by CPU. l3-hw-offloading =no

However, setting for a switch port only disables hardware routing from/to this particular port. Moreover, the port can still l3-hw-offloading =no participate in Fastrack connection offloading. To enable full hardware routing, enable l3hw on all switch ports: /interface/ethernet/switch set 0 l3-hw-offloading=yes /interface/ethernet/switch/port set [find] l3-hw-offloading=yes To make all packets go through the CPU first, and offload only the Fasttrack connections, disable l3hw on all ports but keep it enabled on the switch chip itself: /interface/ethernet/switch set 0 l3-hw-offloading=yes /interface/ethernet/switch/port set [find] l3-hw-offloading=no The next example enables hardware routing on all ports but the upstream port (sfp-sfpplus16). Packets going to/from sfp-sfpplus16 will enter the CPU and, therefore, subject to Firewall/NAT processing. /interface/ethernet/switch set 0 l3-hw-offloading=yes /interface/ethernet/switch/port set [find] l3-hw-offloading=yes /interface/ethernet/switch/port set sfp-sfpplus16 l3-hw-offloading=no L3HW Settings Basic Settings The L3HW Settings menu has been introduced in RouterOS version 7.6. Sub-menu: /interface ethernet switch l3hw-settings Property Description autorestart (ye s | no ; Default: no)Automatically restarts the l3hw driver in case of an error. Otherwise, if an error occurs, gets disabled, and the l3-hw-offloading error code is displayed in the switch settings and . Autorestart does not work for system failures, such as OOM (Out Of #monitor Memory). fasttrack-hw (y es | no ; Default: yes (if supported) )Enables or disables FastTrack HW Offloading. Keep it enabled unless HW TCAM memory reservation is required, e.g., for dynamic switch ACL rules creation. Not all switch chips support FastTrack HW Offloading (see ). hw-supports-fasttrack ipv6-hw (yes | no; Default: no)Enables or disables IPv6 Hardware Offloading. Since IPv6 routes occupy a lot of HW memory, enable it only if IPv6 traffic speed is significant enough to benefit from hardware routing. icmp-reply-on- error (yes | no ; Default: yes)Since the hardware cannot send ICMP messages, the packet must be redirected to the CPU to send an ICMP reply in case of an error (e.g., "Time Exceeded", "Fragmentation required", etc.). Enabling icmp-reply-on-error helps with network diagnostics but may open potential vulnerabilities for DDoS attacks. Disabling icmp-reply-on-error silently drops the packets on the hardware level in case of an error. Read-Only Properties Property Description hw-supports-fasttrack (yes | no )Indicates if the hardware (switch chip) supports FastTrack HW Offloading. Packets get routed by the hardware only if both source and destination ports have . l3-hw-offloading=yes If at least one of them has l3- , packets will go through the CPU/Firewall while offloading only the Fasttrack connections. hw-offloading=no The existing connections may be unaffected by the setting change. l3-hw-offloading

neigh- keepalive- interval (ti me; Default: 15s , min: 5s )Neighbor (host) keepalive interval. When a host (IP neighbor) gets hw-offloaded, all traffic from/to it is routed by the switch chip, and RouterOS may think the neighbor is inactive and delete it. To prevent that, the switch driver must keep the offloaded neighbors alive by sending periodical refreshes to RouterOS. neigh- discovery- interval (ti me; Default: 1 m37s , min: 30s )Unfortunately, switch chips do not provide per-neighbor stats. Hence, the only way to check if the offloaded host is still active is by sending occasional ARP (IPv4) / Neighbor Discovery (IPv6) requests to the connected network. Increasing the value lowers the broadcast traffic but may leave inactive hosts in hardware memory for longer. Neighbor discovery is triggered within the neighbor keepalive work. Hence, the discovery time is rounded up to the next keepalive session. Choose a value for not dividable by to send ARP/ND requests in various sessions, neigh-discovery-interval neigh-keepalive-interval preventing broadcast bursts. neigh- discovery- burst-limit ( number ; Default: 64)The maximum number of ARP/ND requests that can be sent at once. neigh- discovery- burst- delay (time ; Default: 3 00ms , min: 10ms )The delay between ARP/ND subsequent bursts if the number of requests exceeds neigh-discovery-burst-limit . Monitor The L3HW Monitor feature has been introduced in RouterOS version 7.10. It allows monitoring of switch chip and driver stats related to L3HW. /interface/ethernet/switch/l3hw-settings/monitor ipv4-routes-total: 99363 ipv4-routes-hw: 61250 ipv4-routes-cpu: 38112 ipv4-shortest-hw-prefix: 24 ipv4-hosts: 87 ipv6-routes-total: 15 ipv6-routes-hw: 11 ipv6-routes-cpu: 4 ipv6-shortest-hw-prefix: 0 ipv6-hosts: 7 route-queue-size: 118 fasttrack-ipv4-conns: 2031 fasttrack-hw-min-speed: 0 nexthop-cap: 8192 nexthop-usage: 93 Stats Property Description ipv4- routes- totalThe total number of IPv4 routes handled by the switch driver. Some settings only apply to certain switch models.

ipv4- routes-hwThe number of hardware-offloaded IPv4 routes (a.k.a. hardware routes) ipv4- routes-cpuThe number of IPv4 routes redirected to the CPU (a.k.a. software routes) ipv4- shortest- hw-prefixShortest Hardware Prefix (SHWP) for IPv4. If the entire IPv4 routing table does not fit into the hardware memory, is partial offloading applied, where the longest prefixes are hw-offloaded while the shorter ones are redirected to the CPU. This field shows the shortest route prefix (/x) that is offloaded to the hardware memory. All prefixes shorter than this are processed by the CPU. " ipv4-shortest-hw- " means the entire IPv4 routing table is offloaded to the hardware memory. prefix=0 ipv4-hosts The number of hardware-offloaded IPv4 hosts (/32 routes) ipv6- routes- total 1The total number of IPv6 routes handled by the switch driver. ipv6- routes-hw 1The number of hardware-offloaded IPv6 routes (a.k.a. hardware routes) ipv6- routes-cpu 1The number of IPv6 routes redirected to the CPU (a.k.a. software routes) ipv6- shortest- hw-prefix 1Shortest Hardware Prefix (SHWP) for IPv6. If the entire IPv6 routing table does not fit into the hardware memory, is partial offloading applied, where the longest prefixes are hw-offloaded while the shorter ones are redirected to the CPU. This field shows the shortest route prefix (/x) that is offloaded to the hardware memory. All prefixes shorter than this are processed by the CPU. " ipv6-shortest-hw- " means the entire IPv6 routing table is offloaded to the hardware memory. prefix=0 ipv6-hosts 1The number of hardware-offloaded IPv6 hosts (/128 routes) route- queue- sizeThe number of routes in the queue for processing by the switch chip driver. Under normal working conditions, this field is 0, meaning that all routes are processed by the driver. fasttrack- ipv4- conns 2The number of hardware-offloaded FastTrack connections. fasttrack- hw-min- speed 2When the hardware memory for storing FastTrack is full, this field shows the minimum speed (in bytes per second) of a hw-offloaded FastTrack connection. Slower connections are routed by the CPU. IPv6 stats appear only when IPv6 hardware routing is enabled ( )1 ipv6-hw=yes FastTrack stats appear only when hardware offloading of FastTrack connections is enabled ( )2 fasttrack-hw=yes Advanced Monitor An enhanced version of Monitor with extra telemetry data for advanced users. Advanced Monitor contains all data from the basic monitor plus the fields listed below.

/interface/ethernet/switch/l3hw-settings/advanced> monitor once ipv4-routes-total: 29968 ipv4-routes-hw: 29957 ipv4-routes-cpu: 11 ipv4-shortest-hw-prefix: 0 ipv4-hosts: 3 ipv6-routes-total: 4 ipv6-routes-hw: 0 ipv6-routes-cpu: 4 ipv6-shortest-hw-prefix: 0 ipv6-hosts: 0 route-queue-size: 0 route-queue-rate: 0 route-process-rate: 0 fasttrack-ipv4-conns: 0 fasttrack-queue-size: 0 fasttrack-queue-rate: 0 fasttrack-process-rate: 0 fasttrack-hw-min-speed: 0 fasttrack-hw-offloaded: 0 fasttrack-hw-unloaded: 0 lpm-cap: 54560 lpm-usage: 31931 lpm-bank-cap: 2728 lpm-bank-usage: 46,0,0,0,2589,2591,1983,0,2728,2728,2728,2728,2728,2728,2728,2728,2728,170,0,0 pbr-cap: 8192 pbr-usage: 0 pbr-lpm-bank: 3 nat-usage: 0 nexthop-cap: 8192 nexthop-usage: 85 Stats Property Description route- queue-rateThe rate at which routes are added to the queue for the switch driver processing. In other words, the growth rate of (rout route-queue-size es per second) route- process- rateThe rate at which previously queued routes are processed by the switch driver. In other words, the shrink rate of (routes route-queue-size per second) fasttrack- queue-sizeThe number of FastTrack connections in the queue for processing by the switch chip driver. fasttrack- queue-rateThe rate at which FastTrack connections are added to the queue for the switch driver processing. In other words, the growth rate of fasttra (connections per second) ck-queue-size fasttrack- process- rateThe rate at which previously queued FastTrack connections are processed by the switch driver. In other words, the shrink rate of fasttrack (connections per second) -queue-size fasttrack- hw- offloadedThe number of FastTrack connections offloaded to the hardware. The counter resets every second (or every monitor interval). fasttrack- hw- unloadedThe number of FastTrack connections unloaded from the hardware (redirected to software routing). The counter resets every second (or every monitor interval). lpm-cap The size of the LPM hardware table (LPM = Longest Prefix Match). LPM stores route indexes for hardware routing. Not every switch chip model uses LPM. Others use TCAM. lpm-usage The number of used LPM blocks. / = usage percentage. lpm-usage lpm-cap

lpm-bank- capLPM memory is organized in banks - special memory units. The bank size depends on the switch chip model. This value shows the size of a single bank (in LPM blocks). / = the number of banks (usually, 20). lpm-cap lpm-bank-cap lpm-bank- usagePer-bank LPM usage (in LPM blocks) pbr-cap The size of the Policy-Based Routing (PBR) hardware table. PBR is used for NAT offloading of FastTrack connections. pbr-usage The number of used PBR entries. / = usage percentage. pbr-usage pbr-cap pbr-lpm- bankPBR shares LPM memory banks with routing tables. This value shows the LPM bank index shared with PBR (0 = the first bank). nat-usage The number of used NAT hardware entries (for FastTrack connections). Interface Lists It is impossible to use interface lists directly to control because an interface list may contain virtual interfaces (such as VLAN) while l3-hw-offloading the setting must be applied to physical switch ports only. For example, if there are two VLAN interfaces (vlan20 and vlan30) running l3-hw-offloading on the same switch port (trunk port), it is impossible to enable hardware routing on vlan20 but keep it disabled on vlan30. However, an interface list may be used as a port selector. The following example demonstrates how to enable hardware routing on LAN ports (ports that belong to the "LAN" interface list) and disable it on WAN ports: :foreach i in=[/interface/list/member/find where list=LAN] do={ /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=yes } :foreach i in=[/interface/list/member/find where list=WAN] do={ /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=no } Please take into account that since interface lists are not directly used in hardware routing control., modifying the interface list also does not automatically . For instance, adding a switch port to the "LAN" interface list does not automatically enable on it. The user reflect in l3hw changes l3-hw-offloading has to rerun the above script to apply the changes. MTU The hardware supports up to 8 MTU profiles, meaning that the user can set up to 8 different MTU values for interfaces: the default 1500 + seven custom ones. MTU Change Example /interface/ethernet/switch set 0 l3-hw-offloading=no /interface set sfp-sfpplus1 mtu=9000 l2mtu=9022 /interface set sfp-sfpplus2 mtu=9000 l2mtu=9022 /interface set sfp-sfpplus3 mtu=10000 l2mtu=10022 /interface/ethernet/switch set 0 l3-hw-offloading=yes Layer 2 Dependency Layer 3 hardware processing lies on top of Layer 2 hardware processing. Therefore, L3HW offloading requires L2HW offloading on the underlying interfaces. The latter is enabled by default, but there are some exceptions. For example, CRS3xx devices support only one hardware bridge. If there are multiple bridges, others are processed by the CPU and are not subject to L3HW. Another example is ACL rules. If a rule redirects traffic to the CPU for software processing, then hardware routing (L3HW) is not triggered: It is recommended to disable while changing the MTU/L2MTU values on the interfaces. l3-hw-offloading

ACL rule to disable hardware processing on a specific port /interface/ethernet/switch/rule/add switch=switch1 ports=ether1 redirect-to-cpu=yes To make sure that Layer 3 is in sync with Layer 2 on both the software and hardware sides, we recommend disabling L3HW while configuring Layer 2 features. The recommendation applies to the following configuration: adding/removing/enabling/disabling bridge; adding/removing switch ports to/from the bridge; bonding switch ports / removing bond; changing VLAN settings; changing MTU/L2MTU on switch ports; changing ethernet (MAC) addresses. In short, disable while making changes under and : l3-hw-offloading /interface/bridge/ /interface/vlan/ Layer 2 Configuration Template /interface/ethernet/switch set 0 l3-hw-offloading=no /interface/bridge # put bridge configuration changes here /interface/vlan # define/change VLAN interfaces /interface/ethernet/switch set 0 l3-hw-offloading=yes MAC telnet There is a limitation for MAC telnet when L3HW offloading is enabled on , or switch chips. Packets from MAC Telnet are 98DX8xxx 98DX4xxx, 98DX325x dropped and do not reach the CPU, thus access to the device will fail. If MAC telnet is desired in combination with L3HW, certain ACL rule can be created to force these packets to the CPU. For example, if MAC telnet access on sfp-sfpplus1 and sfp-sfpplus2 is needed, you will need to add this ACL rule. It is possible to select even more interfaces with the setting.ports /interface ethernet switch rule add dst-port=20561 ports=sfp-sfpplus1,sfp-sfpplus2 protocol=udp redirect-to-cpu=yes switch=switch1 Inter-VLAN Routing Since L3HW depends on L2HW, and L2HW is the one that does VLAN processing, Inter-VLAN routing requires a hardware bridge underneath. hardware Even if a particular VLAN has only one tagged port member, the latter must be a bridge member. Do not assign a VLAN interface directly on a switch port! Otherwise, L3HW offloading fails and the traffic will get processed by the CPU: /interface/vlan add interface=ether2 name=vlan20 vlan-id=20 Assign the VLAN interface to the bridge instead. This way, VLAN configuration gets offloaded to the hardware, and, with L3HW enabled, the traffic is subject to inter-VLAN hardware routing. It is recommended to turn off L3HW offloading during L2 configuration.

For dynamic routing protocols like OSFP and BGP, it is possible to suppress HW offloading using . For example, to suppress HW offloading routing filters on all OSFP instance routes, use " suppress-hw-offload yes " property: /routing/ospf/instance set [find name=instance1] in-filter-chain=ospf-input /routing/filter/rule add chain="ospf-input" rule="set suppress-hw-offload yes; accept" Offloading Fasttrack Connections Firewall filter rules have option for Fasttrack, allowing fine-tuning connection offloading. Since the hardware memory for Fasttrack hw-offload connections is very limited, we can choose what type of connections to offload and, therefore, benefit from near-the-wire-speed traffic. The next example offloads only TCP connections while UDP packets are routed via the CPU and do not occupy HW memory: /ip/firewall/filter add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=yes protocol=tcp add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=no add action=accept chain=forward connection-state=established,related Stateless Hardware Firewall While connection tracking and stateful firewalling can be performed only by the CPU, the hardware can perform stateless firewalling via . switch rules (ACL) The next example prevents (on a hardware level) accessing a MySQL server from the ether1, and redirects to the CPU/Firewall packets from ether2 and ether3: /interface ethernet switch rule add switch=switch1 dst-address=10.0.1.2/32 dst-port=3306 ports=ether1 new-dst-ports="" add switch=switch1 dst-address=10.0.1.2/32 dst-port=3306 ports=ether2,ether3 redirect-to-cpu=yes Switch Rules (ACL) vs. Fasttrack HW Offloading Some firewall rules may be implemented both via and CPU + Fasttrack HW Offloading. Both options grant near-the-wire- switch rules (ACL) Firewall Filter speed performance. So the question is which one to use? First, , and without HW offloading, Firewall Filter uses only software routing, which is dramatically slower not all devices support Fasttrack HW Offloading than its hardware counterpart. Second, even if Fasttrack HW Offloading is an option, a rule of thumb is: Switch rules share the hardware memory with Fastrack connections. However, hardware resources are allocated for each Fasttrack connection while a single ACL rule can match multiple connections. For example, if you have a guest WiFi network connected to sfp-sfpplus1 VLAN 10 and you don't want it to access your internal network, simply create an ACL rule: /interface/ethernet/switch/rule add switch=switch1 ports=sfp-sfpplus1 vlan-id=10 dst-address=10.0.0.0/8 new-dst-ports="" The matched packets will be dropped on the hardware level. It is much better than letting guest packets to the CPU for Firewall filtering. all Of course, ACL rules cannot match everything. For instance, ACL rules cannot filter connection states: accept established, drop others. That is where Fasttrack HW Offloading gets into action - redirect the packets to the CPU by default for firewall filtering, then offload the established Fasttrack connections. However, disabling for the entire switch, port is not the only option. l3-hw-offloading Always use Switch Rules (ACL), if possible. Define ACL rules with instead of setting of the switch port for narrowing down the traffic redirect-to-cpu=yes l3-hw-offloading=no that goes to the CPU.

Configuration Examples Inter-VLAN Routing with Upstream Port Behind Firewall/NAT This example demonstrates how to benefit from near-to-wire-speed inter-VLAN routing while keeping Firewall and NAT running on the upstream port. Moreover, Fasttrack connections to the upstream port get offloaded to hardware as well, boosting the traffic speed close to wire-level. Inter-VLAN traffic is fully routed by the hardware, not entering the CPU/Firewall, and, therefore, not occupying the hardware memory of Fasttrack connections. We use the model with the following setup: CRS317-1G-16S+ sfp1-sfp4 - bridged ports, VLAN ID 20, untagged sfp5-sfp8 - bridged ports, VLAN ID 30, untagged sfp16 - the upstream port ether1 - management port Setup interface lists for easy access: Interface Lists /interface list add name=LAN add name=WAN add name=MGMT /interface list member add interface=sfp-sfpplus1 list=LAN add interface=sfp-sfpplus2 list=LAN add interface=sfp-sfpplus3 list=LAN add interface=sfp-sfpplus4 list=LAN add interface=sfp-sfpplus5 list=LAN add interface=sfp-sfpplus6 list=LAN add interface=sfp-sfpplus7 list=LAN add interface=sfp-sfpplus8 list=LAN add interface=sfp-sfpplus16 list=WAN add interface=ether1 list=MGMT Bridge Setup /interface bridge add name=bridge vlan-filtering=yes /interface bridge port add bridge=bridge interface=sfp-sfpplus1 pvid=20 add bridge=bridge interface=sfp-sfpplus2 pvid=20 add bridge=bridge interface=sfp-sfpplus3 pvid=20 add bridge=bridge interface=sfp-sfpplus4 pvid=20 add bridge=bridge interface=sfp-sfpplus5 pvid=30 add bridge=bridge interface=sfp-sfpplus6 pvid=30 add bridge=bridge interface=sfp-sfpplus7 pvid=30 add bridge=bridge interface=sfp-sfpplus8 pvid=30 /interface bridge vlan add bridge=bridge tagged=bridge untagged=sfp-sfpplus1,sfp-sfpplus2,sfp-sfpplus3,sfp-sfpplus4 vlan-ids=20 add bridge=bridge tagged=bridge untagged=sfp-sfpplus5,sfp-sfpplus6,sfp-sfpplus7,sfp-sfpplus8 vlan-ids=30 Routing requires dedicated VLAN interfaces. For standard L2 VLAN bridging (without inter-VLAN routing), the next step can be omitted.

VLAN Interface Setup for Routing /interface vlan add interface=bridge name=vlan20 vlan-id=20 add interface=bridge name=vlan30 vlan-id=30 /ip address add address=192.168.20.17/24 interface=vlan20 network=192.168.20.0 add address=192.168.30.17/24 interface=vlan30 network=192.168.30.0 Configure management and upstream ports, a basic firewall, NAT, and enable hardware offloading of Fasttrack connections: Firewall Setup /ip address add address=192.168.88.1/24 interface=ether1 add address=10.0.0.17/24 interface=sfp-sfpplus16 /ip route add gateway=10.0.0.1 /ip firewall filter add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=yes add action=accept chain=forward connection-state=established,related /ip firewall nat add action=masquerade chain=srcnat out-interface-list=WAN At this moment, all routing still is performed by the CPU. Enable hardware routing on the switch chip: Enable Layer 3 Hardware Offloading # Enable full hardware routing on LAN ports :foreach i in=[/interface/list/member/find where list=LAN] do={ /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=yes } # Disable full hardware routing on WAN or Management ports :foreach i in=[/interface/list/member/find where list=WAN or list=MGMT] do={ /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=no } # Activate Layer 3 Hardware Offloading on the switch chip /interface/ethernet/switch/set 0 l3-hw-offloading=yes Results: Within the same VLAN (e.g., sfp1-sfp4), traffic is forwarded by the hardware on Layer 2 . (L2HW) Inter-VLAN traffic (e.g. sfp1-sfp5) is routed by the hardware on Layer 3 (L3HW). Traffic from/to the WAN port gets processed by the CPU/Firewall first. Then Fasttrack connections get offloaded to the hardware (Hardware- NAT applies both on CPU- and HW-processed packets. Accelerated L4 Stateful Firewall). Traffic to the management port is protected by the Firewall. Typical Misconfiguration Below are typical user errors in configuring Layer 3 Hardware Offloading. VLAN interface on a switch port or bond

/interface/vlan add name=vlan10 vlan-id=10 interface=sfp-sfpplus1 add name=vlan20 vlan-id=20 interface=bond1 VLAN interface must be set on the bridge due to Layer 2 Dependency. Otherwise, L3HW will not work. The correct configuration is: /interface/bridge/port add bridge=bridge1 interface=sfp-sfpplus1 frame-types=admit-only-vlan-tagged add bridge=bridge1 interface=bond1 frame-types=admit-only-vlan-tagged /interface/bridge/vlan add bridge=bridge1 tagged=bridge1,sfp-sfpplus1 vlan-ids=10 add bridge=bridge1 tagged=bridge1,bond1 vlan-ids=20 /interface/vlan add name=vlan10 vlan-id=10 interface=bridge1 add name=vlan20 vlan-id=20 interface=bridge1 Not adding the bridge interface to /interface/bridge/vlan/ For Inter-VLAN routing, the bridge interface itself needs to be added to the tagged members of the given VLANs. In the next example, Inter-VLAN routing works between VLAN 10 and 11, but packets are NOT routed to VLAN 20. /interface bridge vlan add bridge=bridge1 vlan-ids=10 tagged=bridge1,sfp-sfpplus1 add bridge=bridge1 vlan-ids=11 tagged=bridge1 untagged=sfp-sfpplus2,sfp-sfpplus3 add bridge=bridge1 vlan-ids=20 tagged=sfp-sfpplus1 untagged=sfp-sfpplus4,sfp-sfpplus5 The above example does not always mean an error. Sometimes, you may want the device to act as a simple L2 switch in some/all VLANs. Just make sure you set such behavior on purpose, not due to a mistake. Creating multiple bridges The devices support only one hardware bridge. If there are multiple bridges created, only one gets hardware offloading. While for L2 that means software forwarding for other bridges, in the case of L3HW, multiple bridges may lead to undefined behavior. Using ports that do not belong to the switch Some devices have two switch chips or the management port directly connected to the CPU. For example, has port CRS312-4C+8XG an ether9 connected to a separate switch chip. Trying to add this port to a bridge or involve it in the L3HW setup leads to unexpected results. Leave the management port for management! Instead of creating multiple bridges, create one and segregate L2 networks with VLAN filtering.

[admin@crs312] /interface/ethernet/switch> print Columns: NAME, TYPE, L3-HW-OFFLOADING # NAME TYPE L3-HW-OFFLOADING 0 switch1 Marvell-98DX8212 yes 1 switch2 Atheros-8227 no [admin@crs312] /interface/ethernet/switch> port print Columns: NAME, SWITCH, L3-HW-OFFLOADING, STORM-RATE # NAME SWITCH L3-HW-OFFLOADING STORM-RATE 0 ether9 switch2 1 ether1 switch1 yes 100 2 ether2 switch1 yes 100 3 ether3 switch1 yes 100 4 ether4 switch1 yes 100 5 ether5 switch1 yes 100 6 ether6 switch1 yes 100 7 ether7 switch1 yes 100 8 ether8 switch1 yes 100 9 combo1 switch1 yes 100 10 combo2 switch1 yes 100 11 combo3 switch1 yes 100 12 combo4 switch1 yes 100 13 switch1-cpu switch1 100 14 switch2-cpu switch2 Relying on Fasttrack HW Offloading too much Since Fasttrack HW Offloading offers near-the-wire-speed performance at zero configuration overhead, the users are tempted to use it as the default solution. However, the number of HW Fasttrack connections is very limited, leaving the other traffic for the CPU. Try using the hardware routing as much as possible, reduce the CPU traffic to the minimum via switch ACL rules, and then fine-tune which Fasttrack connections to offload with firewall filter rules. Trying to offload slow-path connections Using certain configurations (e.g. enabling bridge " " setting, creating bridge nat/filter rules) or running specific features like sniffer or torch can use-ip-firewall disable RouterOS , which will affect the ability to properly FastTrack and HW offload connections. If HW offloaded Fasttrack is required, make FastPath sure that there are no settings that disable the FastPath and verify that connections are getting the "H" flag or use the L3HW command to see the monitor amount of HW offloaded connections. L3HW Feature Support HW - the feature is supported and offloaded to the hardware. CPU - the feature is supported but performed by software (CPU) N/A - the feature is not available together with L3HW. Layer 3 hardware offloading must be completely disabled ( ) switch l3-hw-offloading=no to make this feature work. FW - the feature requires for a given . On the level, l3-hw-offloading =no switch port switch . l3-hw-offloading=yes Feature Support Comments Release IPv4 Unicast RoutingHW 7.1 IPv6 Unicast RoutingHW /interface/ethernet/switch/l3hw-settings/set ipv6-hw=yes 7.6 IPv4 Multicast RoutingCPU IPv6 Multicast RoutingCPU

ECMP HW Multipath routing 7.1 Blackholes HW /ip/route add dst-address=10.0.99.0/24 blackhole 7.1 gateway=<int erface_name>CPU/HW /ip/route add dst-address=10.0.0.0/24 gateway=ether1 This works only for directly connected networks. Since HW does not know how to send ARP requests, CPU sends an ARP request and waits for a reply to find out the DST MAC address on the first received packet of the connection that matches a DST IP address. After DST MAC is determined, HW entry is added and all further packets will be processed by the switch chip.7.1 Bridge HW Routing from/to interface. hardware-offloaded bridge 7.1 VLAN HW Routing between VLAN interfaces that are created on hardware-offloaded bridge interface with . vlan-filtering /interface/vlan7.1 Bonding HW Routing between bonding interfaces. /interface/bonding Only 802.3ad and balance-xor bonding modes are hardware offloaded.7.1 IPv4 Firewall FW Users must choose either HW-accelerated routing or firewall. Firewall rules get processed by the CPU. connections get offloaded to HW. Fasttrack 7.1 IPv4 NAT FW NAT rules applied to the offloaded connections get processed by HW too. Fasttrack 7.1 MLAG N/A VRF N/A Only the routing table gets offloaded. If VRF is used together with L3HW and packets arrive on a switch port with main l3-hw- , packets can be incorrectly routed through the main routing table. To avoid this, disable L3HW on needed offloadin g=yes switch ports or use ACL rules to redirect specific traffic to the CPU. VRRP N/A Controller Bridge and Port ExtenderN/A VXLAN CPU MTU HW The hardware supports up to 8 MTU profiles. 7.1 QinQ Routing CPU Stacked routable VLAN interfaces will lose L3HW offloading, while routable VLAN interfaces created directly on the bridge interface can still use HW offloading. Only the devices listed in the table below support L3 HW Offloading. L3HW Device Support Only the devices listed in the table below support L3 HW Offloading. CRS3xx: Switch DX3000 and DX2000 Series The devices below are based on , or switch chip models. Marvell 98DX224S, 98DX226S 98DX3236 Below are some important features that these devices are missing when compared to other switch models: Fasttrack and NAT connection offloading; per-VLAN packet and byte counters. Model Switch Chip Release IPv4 Route Prefixes1IPv6 Route Prefixes2 Nexthops ECMP paths per prefix3 CRS305-1G-4S+ 98DX3236 7.1 13312 3328 4K 8 CRS310-1G-5S-4S+ 98DX226S 7.1 13312 3328 4K 8 The and 98DX3255 98DX3257 models are exceptions, which have a feature set of the DX8000 rather than the DX3000 series.

IPv4 and IPv6 routing tables share the same hardware memory.8 CCR2000 Model Switch Chip Release IPv4 Routes IPv4 Hosts IPv6 Routes IPv6 Hosts Nexthops Fasttrack connections NAT entries CCR2116-12G-4S+ 98DX3255 1 7.1 16K - 36K 16K 4K - 6K 8K 8K 2.25K 2.25K CCR2216-1G-12XS-2XQ 98DX8525 7.1 60K - 120K 64K 15K - 20K 32K 8k 4.5K 4K The switch chip has a feature set of the DX8000 series.1

MACsec Overview Basic Configuration Example Property Reference Interface settings Profile settings Overview The MACsec (Media Access Control Security) protocol is a standard security technology employed in Ethernet networks to ensure the confidentiality, integrity, and authenticity of data transmitted over the physical medium. MACsec is defined by IEEE standard 802.1AE. MACsec utilizes GCM-AES-128 encryption over Ethernet and secures all LAN traffic, including DHCP, ARP, LLDP, and higher-layer protocols. Basic Configuration Example Imagine Host1 ether1 is connected to Switch ether1 and Host2 ether1 is connected to Switch ether2. In this example, we will create two MACsec interface pairs and use a bridge to create a secure Layer2 connection between both end devices. First, configure MACsec interfaces on Host1 and Host2. We can specify only the Ethernet interface and RouterOS will automatically generate the Connectivity Association Key (CAK) and connectivity association name (CKN). Use the command to see the values:print # Host1 /interface macsec add interface=ether1 name=macsec1 [admin@Host2] /interface/macsec print Flags: I - inactive, X - disabled, R - running 0 name="macsec1" mtu=1468 interface=ether1 status="negotiating" cak=71a7c363794da400dbde595d3926b0e9 ckn=f2c4660060169391d29d8db8a1f06e5d4b84a128bad06ad43ea2bd4f7d21968f profile=default # Host2 /interface macsec add interface=ether1 name=macsec1 [admin@Host2] /interface/macsec print Flags: I - inactive, X - disabled, R - running 0 name="macsec1" mtu=1468 interface=ether1 status="negotiating" cak=dc47d94291d19a6bb26a0c393a1af9a4 ckn=e9bd0811dad1e56f06876aa7715de1855f1aee0baf5982ac8b508d4fc0f162d9 profile=default On the Switch device, to enable MACsec we need to configure the matching CAK and CKN values for the appropriate Ethernet interface: # Switch /interface macsec add comment=Host1 cak=71a7c363794da400dbde595d3926b0e9 ckn=f2c4660060169391d29d8db8a1f06e5d4b84a128bad06ad43ea2bd4f7d21968f interface=ether1 name=macsec1 add comment=Host2 cak=dc47d94291d19a6bb26a0c393a1af9a4 ckn=e9bd0811dad1e56f06876aa7715de1855f1aee0baf5982ac8b508d4fc0f162d9 interface=ether2 name=macsec2 Once the pre-shared keys are successfully exchanged, the MACsec Key Agreement (MKA) protocol is activated. MKA is responsible for ensuring the continuity of MACsec on the link and determines which side becomes the key server in a point-to-point connection. The key server generates a Secure Association Key (SAK) that is shared exclusively with the device on the other end of the link. This SAK is used to secure all data traffic passing through the link. Periodically, the key server generates a new randomly-created SAK and shares it over the point-to-point link to maintain MACsec functionality. RouterOS MACsec implementation is in the early stage, it dynamic key management via (manual key configuration is does not support Dot1x required) and hardware-accelerated encryption (maximum throughput is highly limited by the device CPU).

In RouterOS, the MACsec interface can be configured like any Ethernet interface. It can be used as a routable interface with an IP address, or placed inside a bridge. On Host1 and Host2 we will add an IP address from the same network. On Switch, we will use a bridge. # Host1 /ip address add address=192.168.10.10/24 interface=macsec1 # Host2 /ip address add address=192.168.10.20/24 interface=macsec1 # Switch /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=macsec1 add bridge=bridge1 interface=macsec2 Last, confirm that Host1 can reach Host2 using a ping. [admin@Host1] > ping 192.168.10.20 SEQ HOST SIZE TTL TIME STATUS 0 192.168.10.20 56 64 1ms438us 1 192.168.10.20 56 64 818us 2 192.168.10.20 56 64 791us 3 192.168.10.20 56 64 817us 4 192.168.10.20 56 64 783us sent=5 received=5 packet-loss=0% min-rtt=783us avg-rtt=929us max-rtt=1ms438us Property Reference Interface settings Sub-menu: /interface/macsec Configuration settings for the MACsec interface. Property Description cak ( ; Default: ) string A 16-byte pre-shared connectivity association key (CAK). To enable MACsec, configure the matching CAK and CKN on both ends of the link. When not specified, RouterOS will automatically generate a random value. ckn ( ; Default: ) string A 32-byte connectivity association name (CKN). To enable MACsec, configure the matching CAK and CKN on both ends of the link. When not specified, RouterOS will automatically generate a random value. comment ( ; Default: ) string Short description of the interface. disabled ( ; Default: ) yes | no no Changes whether the interface is disabled. interface ( ; Default: ) name Ethernet interface name where MACsec is created on, limited to one MACsec interface per Ethernet. mtu ( ; Default: ) integer 1468 Sets the maximum transmission unit. The will be set automatically according to the associated l2mtu interfa (subtracting 32 bytes corresponding to the MACsec encapsulation). The cannot be changed. ce l2mtu name ( ; Default: ) string macsec1 Name of the interface. profile ( ; Default: ) name default Sets MACsec profile, used for determining the key server in a point-to-point connection. status (read-only: disabled | initializing ) | | negotiating | open-encrypted invalidShows the current MACsec interface status.

Profile settings Sub-menu: /interface/macsec/profile Configuration settings for the MACsec profile. Property Description name ( ; Default: ) string Name of the profile. server-priority (integer: ; Default: ) 0..255 10Sets the priority for determining the key server in a point-to-point connection, a lower value means higher priority. In case of a priority match, the interface with the lowest MAC address will be acting as a key server.

MACVLAN Overview Basic Configuration Example Property Reference Overview The MACVLAN provides a means to create multiple virtual network interfaces, each with its own unique Media Access Control (MAC) address, attached to a physical network interface. This technology is utilized to address specific network requirements, such as obtaining multiple IP addresses or establishing distinct PPPoE client connections from a single physical Ethernet interface while using different MAC addresses. Unlike traditional (Virtual LAN) VLAN interfaces, which rely on Ethernet frames tagged with VLAN identifiers, MACVLAN operates at the MAC address level, making it a versatile and efficient solution for specific networking scenarios. Basic Configuration Example Picture a scenario where the ether1 interface connects to your ISP, and your router needs to lease two IP addresses, each with a distinct MAC address. Traditionally, this would require the use of two physical Ethernet interfaces and an additional switch. However, a more efficient solution is to create a virtual MACVLAN interface. To create a MACVLAN interface, select the needed Ethernet interface. A MAC address will be automatically assigned if not manually specified: /interface macvlan add interface=ether1 name=macvlan1 /interface macvlan print Flags: R - RUNNING Columns: NAME, MTU, INTERFACE, MAC-ADDRESS, MODE # NAME MTU INTERFACE MAC-ADDRESS MODE 0 R macvlan1 1500 ether1 76:81:BF:68:69:83 bridge Now, a DHCP client can be created on ether1 and macvlan1 interfaces: /ip dhcp-client add interface=ether1 add interface=macvlan1 Property Reference Sub-menu: /interface/macvlan Configuration settings for the MACVLAN interface. Property Description RouterOS MACVLAN interfaces are not supported by , as it exclusively utilizes (Virtual Ethernet) interfaces for its networking. Container VETH A MACVLAN interface can only receive broadcast packets, packets addressed to its own MAC address, and a limited number of multicast addresses. If the physical interface has a VLAN configured, the MACVLAN interface cannot receive packets from that VLAN. For bridging and more complex Layer2 solutions involving VLANs, a dedicated switch should be used instead.

arp (disabled | enabled | local-proxy-arp | proxy-arp | ; Default: ) reply-only enabledAddress Resolution Protocol setting disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originating from matching IP address/MAC address combinations, which are entered as static entries in the IP/ARP table. No dynamic entries will be automatically stored in the IP/ARP table. Therefore, for communications to be successful, a valid static entry must already exist. arp-timeout ( ; auto | integer Default: ) autoSets for how long the ARP record is kept in the ARP table after no packets are received from IP. Value equals to auto the value of in , default is 30s. arp-timeout /ip/settings/ comment ( ; Default: ) string Short description of the interface. disabled ( ; Default: yes | no )noChanges whether the interface is disabled. interface ( ; Default: ) name Name of the interface on top of which MACVLAN will work. MACVLAN interfaces can be created on Ethernet or VLAN interfaces, adding VLAN on MACVLAN is not supported. loop-protect (on | off | ; Default: ) default defaultEnables or disables loop protect on the interface, the works as turned off. default loop-protect-disable-time (ti ; Default: ) me interval | 0 5mSets how long the selected interface is disabled when a loop is detected. - forever. 0 loop-protect-send-interval (ti ; Default: ) me interval 5sSets how often loop protect packets are sent on the selected interface. mac-address ( ; MAC Default: )Static MAC address of the interface. A randomly generated MAC address will be assigned when not specified. mode ( ; private | bridge Default: ) bridgeSets MACVLAN interface mode: private - does not allow communication between MACVLAN instances on the same parent . interface bridge - allows communication between MACVLAN instances on the same parent . interface mtu ( ; Default: ) integer 1500 Sets Layer 3 Maximum Transmission Unit. For the MACVLAN interface, it cannot be higher than the parent . interface name ( ; Default: ) string Interface name.

1. 2. 3. 4. 5. Quality of Service Overview QoS Terminology QoS Device Support Applications and Usage Examples Basic Configuration Example Dante RDMA over Converged Ethernet (RoCE) QoS Marking Understanding Map ranges Understanding Port, Profile, and Map relation QoS Marking via Switch Rules (ACL) QoS Enforcement Hardware Queues Hardware Resources Resource Saving Traffic Prioritization Active Queue Management (AQM) Weighted Random Early Detection (WRED) Explicit Congestion Notification (ECN) Priority-based Flow Control (PFC) Property Reference Switch settings Port settings Port Stats Port Resources/Usage Port PFC Stats QoS Menu QoS Settings QoS Monitor QoS Profile QoS Mapping VLAN Map DSCP Map Transmission Manager Transmission Queue Scheduler Priority-based Flow Control (PFC) Overview This document defines usage in RouterOS based on (CRS3xx, CRS5xx series switches, and Quality of Service (QoS) Marvell Prestera DX switch chips CCR2116, CCR2216 routers). QoS is a set of features in network switches that allow network administrators to prioritize traffic and allocate network resources to ensure that important data flows smoothly and with low latency. The primary function of QoS in network switches is to manage network traffic in a way that meets the specific requirements of different types of network applications. For example, voice and video data require low latency and minimal packet loss to ensure high-quality communication, while file transfers and other data applications can tolerate higher levels of latency and packet loss. QoS works by identifying the type of traffic flowing through the switch and assigning it a priority level based on its requirements. The switch can then use this information to alter packet headers and prioritize the flow of traffic, ensuring that higher-priority traffic is given preferential treatment over lower-priority traffic. RouterOS v7.15+ is required to support all QoS features: QoS Marking. QoS profile matching by ingress packet headers, then egress header alternation according to the assigned QoS profiles. QoS Enforcement . Avoid or resolve congestion based on the assigned QoS profiles and traffic shaping. QoS Policy . Assign QoS profiles via ACL rules. Active Queue Management: ( Random Early Detection), notification, and processing, . WRED Weighted ECN PFC (Priority-based Flow Control) Traffic shaping .

QoS Terminology These terms will be used throughout the article. QoS - Quality of Service. ACL - Access Control List, a set of switch rules used to filter network traffic based on specified criteria. AQM - Active Queue Management. DSCP - Differentiated Services Code Point, a 6-bit field in the IP header used to prioritize network traffic. ECN - Explicit Congestion Notification. ETS - Enhanced Transmission Selection. PCP - Priority Code Point, a 3-bit field in the VLAN header used to prioritize traffic within a VLAN. PFC - Priority-based Flow Control (IEEE 802.1Qbb). RoCE - RDMA over Converged Ethernet. WRED - Weighted Random Early Detection. /in/eth/sw/ a shortcut for . The shortcut works in CLI, too. /interface/ethernet/switch/ QoS Device Support Model Switch ChipQoS ProfilesQoS MapsTx ManagersWRED ECN PFC Profiles 3Port/Queue Usage Stats CCR2116-12G-4S+ 98DX3255 1024 12 15 ✔ ✔ 8 Unreliable 1 CCR2216-1G-12XS-2XQ 98DX8525 1024 12 15 ✔ ✔ 8 Max fill 2 CRS305-1G-4S+ 98DX3236 128 1 8 - Current values CRS309-1G-8S+ 98DX8208 1024 12 15 ✔ ✔ 8 Unreliable CRS310-1G-5S-4S+ 98DX226S 128 1 8 - Current values CRS312-4C+8XG 98DX8212 1024 12 15 ✔ ✔ 8 Unreliable CRS317-1G-16S+ 98DX8216 1024 12 15 ✔ ✔ 8 Unreliable CRS318-1Fi-15Fr-2S 98DX224S 128 1 8 - Current values CRS318-16P-2S+ 98DX226S 128 1 8 - Current values CRS326-24G-2S+ 98DX3236 128 1 8 - Current values CRS326-24S+2Q+ 98DX8332 1024 12 15 ✔ ✔ 8 Unreliable CRS328-24P-4S+ 98DX3236 128 1 8 - Current values CRS328-4C-20S-4S+ 98DX3236 128 1 8 - Current values CRS354-48G-4S+2Q+, CRS354-48P- 4S+2Q+98DX3257 1024 12 15 ✔ ✔ 8 5 Unreliable CRS504-4XQ 98DX4310 1024 12 15 ✔ ✔ 8 Max fill CRS510-8XS-2XQ 98DX4310 1024 12 15 ✔ ✔ 8 Max fill CRS518-16XS-2XQ 98DX8525 1024 12 15 ✔ ✔ 8 Max fill CRS520-4XS-16XQ 98CX8410 1024 12 15 ✔ ✔ 8 5Unavailable 4 Due to hardware limitations, some switch chip models may break traffic flow while accessing QoS port/queue usage data.1 The device gathers max queue fill statistics instead of displaying the current usage values. Use the command to reset those stats.2reset-counters The devices without PFC profiles do not support Priority-based Flow Control.3 4 Usage data for individual queues on a port are unavailable, only the total usage for the entire port can be accessed. Due to hardware limitations, PFC settings cannot be configured on certain switch ports. For series models, PFC is not supported on ports 5CRS354 ether37 to . For the model, PFC is not supported on ports to . ether48 CRS520-4XS-16XQ qsfp28-4-1 qsfp28-7-4 Applications and Usage Examples Basic Configuration Example

In this example, we define just one QoS level - VoIP (IP Telephony) on top of the standard "Best Effort" class. Let's imagine that we have a CRS326-24G- 2S+ device where: all ports are bridged and using ; vlan-filtering sfp-sfpplus1 is a VLAN trunk connected to another switch; ether1-ether9 are dedicated ports for IP phones; ether10-ether24 are standard ports for host connection; First, we need to define QoS profiles. Defined and values that will be used in forwarded packets on egress: dscp pcp /interface ethernet switch qos profile add dscp=46 name=voip pcp=5 traffic-class=5 Port-based QoS profile assignment on dedicated ports for IP phones applies to ingress traffic. Other Ethernet ports will use the default (where profile ds and ): cp=0 pcp=0 /interface ethernet switch qos port set ether1 profile=voip set ether2 profile=voip set ether3 profile=voip set ether4 profile=voip set ether5 profile=voip set ether6 profile=voip set ether7 profile=voip set ether8 profile=voip set ether9 profile=voip The trunk port receives both types of QoS traffic. We need to create VLAN priority mapping with the QoS profile and enable to differentiate trust-l2 them: /interface ethernet switch qos map vlan add pcp=5 profile=voip /interface ethernet switch qos port set sfp-sfpplus1 trust-l2=trust Finally, enable QoS hardware offloading for the above settings to start working: /interface ethernet switch set switch1 qos-hw-offloading=yes It is possible to verify the port QoS settings with command:print

/interface/ethernet/switch/qos/map/ip add dscp=56 profile=dante-ptp add dscp=46 profile=dante-audio add dscp=8 profile=dante-low Configure hardware queues to enforce QoS on Dante traffic. /interface/ethernet/switch/qos/tx-manager/queue set [find where traffic-class>=2] schedule=strict-priority set [find where traffic-class<2] schedule=low-priority-group weight=1 Dante's High and Medium priority traffic is scheduled in strict order. The devices transmits time-critical PTP packets until queue7 gets empty, then proceed with audio (queue5). Low and other traffic gets transmitted only when PTP and audio queues are empty. Since Dante does not define priority order between Low and Other traffic (usually, CS1 has lower priority than Best Effort), and the Low traffic class is reserved for future use anyway, we treat both traffic types equally by putting both into the same group with the same weight. Feel free to change the CS1/BE traffic scheduling according to the requirements if some Dante hardware in your network uses the low-priority traffic class. The next step is to enable trust mode for incoming Layer3 packets (IP DSCP field): /interface/ethernet/switch/qos/port set [find] trust-l3=keep Finally, enable QoS hardware offloading for the above settings to start working: /interface ethernet switch set switch1 qos-hw-offloading=yes When using Dante in multicast mode, it is beneficial to enable IGMP snooping on the switch. This feature directs traffic only to ports with subscribed devices, preventing unnecessary flooding. Additionally, enabling an IGMP querier (if not already enabled on another device in the same LAN), adjusting query intervals, and activating fast-leave can further optimize multicast performance. /interface/bridge set [find name=bridge] igmp-snooping=yes multicast-querier=yes query-interval=60s /interface/bridge/port set [find] fast-leave=yes RDMA over Converged Ethernet (RoCE) RoCE allows you to directly access memory on remote storage systems using Ethernet networks without involving the host CPU. This capability significantly reduces latency and CPU overhead, making RoCE ideal for high-performance computing and data center environments. RoCE also enables a converged network, where various services (such as data storage, networking, and multimedia) run over a single Ethernet infrastructure. This simplifies network management and reduces the cost and complexity of maintaining separate networks. RoCE achieves this through the use of and mechanisms. These features help prevent network congestion and packet loss, ensuring reliable, ECN PFC lossless communication. See the for compatible switches. Although switches can support RoCE environments, the end hosts must device feature table also be compatible with the RoCE protocol and equipped with RDMA-capable network interface cards (NICs). There are two main versions of RoCE. RoCEv1 operates as an Ethernet link layer protocol and uses Ethertype 0x8915. RoCEv2 works over standard IP networks, using UDP destination port number 4791. ECN bits in the IP header are marked to signal network congestion, and a Congestion Notification Packet (CNP) is used to acknowledge congestion to the sender. For traffic prioritization, DSCP 26 is used for RoCEv2 traffic, while DSCP 48 for CNPs. The following example can be used for lossless RoCEv2 with PFC and ECN and it assumes that the switch is using its , which default configuration includes a default "bridge" interface and all Ethernet interfaces added as bridge ports. The minimal recommended RouterOS version is 7.17. First, configure additional profiles. Non-RoCE traffic will be assigned to already existing "default" profile with traffic-class 1, RoCEv2 to traffic-class 3, and CNP to traffic-class 6.

/interface ethernet switch qos profile add name=roce traffic-class=3 add name=cnp traffic-class=6 Create a QoS mapping to match QoS profiles based on DSCP values. /interface ethernet switch qos map ip add dscp=26 profile=roce add dscp=48 profile=cnp Configure hardware queues and scheduler. We are using ETS ( ) for traffic-class 1 and traffic-class 3 with 50% schedule=high-priority-group bandwith assigment each ( ), and strict priority scheduling for traffic-class 6. Additionally, configure a separate shared memory pool ( weight=1 shared- ) for lossless traffic in traffic-class 3 and enable ECN ( ) to mark IP packets in the switch that experience congestion. pool-index=1 ecn=yes /interface ethernet switch qos tx-manager queue set 1 schedule=high-priority-group weight=1 set 3 schedule=high-priority-group weight=1 shared-pool-index=1 ecn=yes set 6 schedule=strict-priority Configure PFC profile for traffic-class 3 to ensure a lossless environment for RoCEv2 traffic. /interface ethernet switch qos priority-flow-control add name=pfc-tc3 rx=yes traffic-class=3 tx=yes Set Layer3 trust mode ( ) on switch ports where RoCEv2 traffic is expected, set PFC ( ) and egress-rate for queue3 to trust-l3=keep pfc=pfc-tc3 comply with PFC requirements ( ). In this example, 10Gbps SFP+ interfaces are used, and the egress rate can be set egress-rate-queue3=10.0Gbps to match the physical speed of the interface. Change this property depending on your interface speeds. /interface ethernet switch qos port set sfp-sfpplus1 egress-rate-queue3=10.0Gbps pfc=pfc-tc3 trust-l3=keep set sfp-sfpplus2 egress-rate-queue3=10.0Gbps pfc=pfc-tc3 trust-l3=keep set sfp-sfpplus3 egress-rate-queue3=10.0Gbps pfc=pfc-tc3 trust-l3=keep set sfp-sfpplus4 egress-rate-queue3=10.0Gbps pfc=pfc-tc3 trust-l3=keep Enable QoS hardware offloading for the above settings to start working. /interface ethernet switch set switch1 qos-hw-offloading=yes Enable the to share QoS settings and capabilities with other neighboring devices. LLDP Data Center Bridging Capability Exchange Protocol (DCBX) /ip neighbor discovery-settings set lldp-dcbx=yes As an optional step, increase the L2MTU to accommodate larger data packets. /interface ethernet set [find switch=switch1] l2mtu=9500 Although using allows you to create separate ETS scheduling and bandwidth allocation for a different set schedule=low-priority-group of traffic-classes, it is not recommended to use this setting together with . The reason is that the ETS Configuration lldp-dcbx=yes /Recommendation TLVs are designed to handle a single bandwidth allocation across traffic classes, thus schedule=high-priority-group should be used instead.

QoS Marking Understanding Map ranges In order to avoid defining all possible PCP and DSCP mappings, RouterOS allows setting multiple values and ranges for PCP and DSCP values for QoS Profile mapping. In the following example, PCP values 0 and 2 use the default QoS profile, 1, 3-4 - streaming, 5 - voip, and 6-7 - control. /interface ethernet switch qos map vlan add pcp=1,3-4 profile=streaming add pcp=5 profile=voip add pcp=6-7 profile=control Understanding Port, Profile, and Map relation Each switch port has Layer2 and Layer3 trust settings that will change how ingress packets are classified into QoS profiles and what PCP and DSCP values will be used. Below are tables that describe all possible options: qos- trust- l2qos- trust- l3Behavior ignore ignore The port is considered untrusted. Both headers are ignored, and the port's is forced to all ingress packets. This is the default profile setting. ignore trust Trust the Layer 3 header. Use the DSCP field from the IP header of ingress packets for QoS profile lookup (see /in/eth/sw/qos ). If the lookup fails (no QoS profiles are mapped to the given DSCP value), the QoS profile is used (not the switch /map/ip default port's QoS profile). The switch port's field is used only for non-IP traffic. profile ignore keep Trust the Layer 3 header. Use the DSCP field from the IP header of ingress packets for QoS profile lookup (see /in/eth/sw/qos ). If the lookup fails, the QoS profile is used. The switch port's field is used only for non-IP traffic. If the /map/ip default profile forwarded/routed packet is VLAN-tagged, its PCP value is set from the selected QoS profile. However, the original DSCP value of the packet is kept intact. trust ignore Trust the Layer 2 header, but ignore L3. If an ingress packet is VLAN-tagged, use the PCP field from the VLAN header for QoS profile lookup (see ). If the lookup fails (no QoS profiles are mapped to the given PCP value), the /in/eth/sw/qos/map/vlan defa QoS profile is used. The switch port's field is used only for untagged traffic. ult profile trust trust Trust both headers, but Layer 3 has higher precedence. In the case of an IP packet, use the DSCP field for QoS profile lookup (see / ). If the DSCP-to-QoS lookup fails, use the profile. If the packet is not an IP packet but is VLAN- in/eth/sw/qos/map/ip default tagged, use the PCP field from the VLAN header for QoS profile lookup (see ). If the VLAN-to-QoS /in/eth/sw/qos/map/vlan lookup fails, use the QoS profile. Non-IP untagged packets use the switch port's . default profile trust keep The same as , but the original DSCP value is preserved in forwarded/routed packets. trust+trust keep ignore Trust the Layer 2 header but ignore L3. If an ingress packet is VLAN-tagged, use the PCP field from the VLAN header for QoS profile lookup (see ). If the lookup fails (no QoS profiles are mapped to the given PCP value), the /in/eth/sw/qos/map/vlan defa QoS profile is used. The switch port's field is used only for untagged traffic. If the packet is VLAN-tagged on both ingress ult profile and egress, the original PCP value is kept. keep trust Trust both headers, but Layer 3 has higher precedence. In the case of an IP packet, use the DSCP field for QoS profile lookup (see / ). If the DSCP-to-QoS lookup fails, use the profile. If the packet is not an IP packet but is VLAN- in/eth/sw/qos/map/ip default tagged, use the PCP field from the VLAN header for QoS profile lookup (see ). If the VLAN-to-QoS /in/eth/sw/qos/map/vlan lookup fails, use the QoS profile. Non-IP untagged packets use the switch port's . If the packet is VLAN-tagged on both default profile ingress and egress, the original PCP value is kept. The DSCP value in forwarded/routed packets is set from the selected QoS profile. keep keep Trust both headers, but Layer 3 has higher precedence. In the case of an IP packet, use the DSCP field for QoS profile lookup (see / ). If the DSCP-to-QoS lookup fails, use the profile. If the packet is not an IP packet but is VLAN- in/eth/sw/qos/map/ip default tagged, use the PCP field from the VLAN header for QoS profile lookup (see ). If the VLAN-to-QoS /in/eth/sw/qos/map/vlan lookup fails, use the QoS profile. Non-IP untagged packets use the switch port's . Keep both the original PCP and/or default profile DSCP values intact in cases of VLAN-tagged and/or IP packets, respectively.

Port settings The selected QoS profile and the source for PCP / DSCP field values in forwarded/routed packets qos-trust-l2 qos-trust-l3 VLAN-Tagged IP Untagged IP VLAN-Tagged Non-IP Untagged Non-IP QoS Profile PCP DSCP QoS Profile PCP 1 DSCP QoS Profile PCP DSCP QoS Profile PCP 1 DSCP ignore ignore profile profile profile profile profile profile profile profile - profile profile - ignore trust map/ip map/ip map/ip map/ip map/ip map/ip profile profile - profile profile - ignore keep map/ip map/ip original map/ip map/ip original profile profile - profile profile - trust ignore map/vlan map/vlan map/vlan profile profile profile map/vlan map/vlan - profile profile - trust trust map/ip map/ip map/ip map/ip map/ip map/ip map/vlan map/vlan - profile profile - trust keep map/ip map/ip original map/ip map/ip original map/vlan map/vlan - profile profile - keep ignore map/vlan original map/vlan profile profile profile map/vlan original - profile profile - keep trust map/ip original map/ip map/ip profile map/ip map/vlan original - profile profile - keep keep map/ip original original map/ip profile original map/vlan original - profile profile - applies only when ingress traffic is untagged, but the egress needs to be VLAN-tagged.1 QoS Marking via Switch Rules (ACL) Starting from , it is possible to assign QoS profiles via . RouterOS v7.15 Switch Rules (ACL) Sub-menu: /interface/ethernet/switch/rule New/Changed PropertiesDescription new-qos-profile ( ) name The name of the to assign to the matched packets. QoS profile keep-qos-fields ( ; yes | no Default: ) noShould the original values of QoS fields (PCP, DSCP) be kept ( ), or replace them with the ones from the assigned QoS yes profile ( )? Relevant only if is set. no new-qos-profile new-vlan-priority ()0..7 Deprecated and should be replaced with the respective . Kept for backward compatibility. Relevant only if new-qos-profile qos-hw-offloading=no. The following example assigns a QoS profile based on the source MAC address. /interface ethernet switch rule add new-qos-profile=stream ports=ether1,ether2 src-mac-address=00:01:02:00:00:00/FF:FF:FF:00:00:00 switch=switch1 add new-qos-profile=voip ports=ether1,ether2 src-mac-address=04:05:06:00:00:00/FF:FF:FF:00:00:00 switch=switch1 QoS Enforcement Hardware Queues Each switch port has eight hardware transmission (tx) queues (queue0..queue7). Each queue corresponds to a traffic class (tc0..tc7) set by a . QoS profile Each ingress packet gets assigned to a QoS profile, which, in turn, determines the traffic class for tx queue selection on the egress port. Hardware queues are of variable size - set by the . Moreover, multiple ports and/or queues can share resources with each other (so- Transmission Manager called ). For example, a device with 25 ports has memory (buffers) to queue 1200 packets in total. If we split the resources equally, each Shared Buffers port gets 48 exclusive buffers with a maximum of 6 packets per queue (48/8) - which is usually insufficient to absorb even a short burst of traffic. However, choosing to share 50% of the buffers leaves each port with 24 exclusive buffers (3 per queue), but at the same time, a single queue can grow up to 603 buffers (3 exclusive + 600 shared). RouterOS allows enabling/disabling the shared pool for each queue individually - for example, to prevent low-priority traffic from consuming the entire hardware memory. In addition, port buffer limits may prevent a single low-speed port from consuming the entire shared pool. See and QoS Settings Trans for details. mission Manager

Hardware Resources The hardware (switch chips) has limited resources (memory). There are two main hardware resources that are relevant to QoS: - contain packet control information (target port, header alternation, etc). Packet descriptors - memory chunks containing the actual payload. Buffer size depends on the switch chip model. Usually - 256 bytes. Data buffers One packet descriptor may use multiple buffers (depending on the payload size); buffers may be shared by multiple descriptors - in cases of multicast /broadcast. If the hardware does not have enough free descriptors or buffers, the packet gets dropped ( ). tail-drop Hardware resources can be limited per destination type (multicast/unicast), per port, and per each tx queue. If any limits are reached, no more packets can be enqueued for transmission, and further packets get dropped. RouterOS obscures low-level hardware information, allowing to set resource limits either in terms of packets or a percentage of the total amount. RouterOS automatically calculates the required hardware descriptor and buffer count based on the user-specified packet limit and port's MTU. Moreover, RouterOS comes with preconfigured hardware resources, so there is no need to do a manual configuration in common QoS environments. Resource Saving Since reallocating hardware resources in runtime is not an option, RouterOS cannot automatically free queue buffers reserved for inactive ports. Those buffers remain unused. However, if the user knows that the specific ports will be used (e.g., stay physically disconnected), the respective queue never resources can be manually freed by using the built-in "offline" tx-manager with minimum resources: /interface/ethernet/switch/qos/port set [find where !running] tx-manager=offline Traffic Prioritization The hardware provides two types of traffic transmission prioritization: Strict Priority - traffic from higher queues is always transmitted first; Enhanced Transmission Selection (ETS) - multiple queues participate in packet transmission scheduling at the same time. Strict priority queues are straightforward. If the highest priority queue (Q7) has packets, those are transmitted first. When Q7 is empty, packets from Q6 get transmitted, and so on. The packets from the lowest priority queue (Q0) are transmitted only if all other queues are empty. The downside of strict prioritization is increased latency in lower queues while "overprioritizing" higher queues. Suppose the acceptable latency of TC5 is 20ms, TC3 - 50ms. Traffic appearing in Q5 gets immediately transmitted due to the strict priority of the queue, adding extra latency to every packet in the lower queues (Q4..Q0). A packet burst in Q5 (e.g., a start of a voice call) may temporarily "paralyze" Q3, increasing TC3 latencies over the acceptable 50ms (or even causing packet drops due to full queue) while TC5 packets get transmitted at <1ms (way below the 20ms limit). Slightly sacrificing TC5 latency by transmitting TC3 packets in between would make everybody happy. That is for.ETS Enhanced Transmission Selection (ETS) schedule traffic for transmission from multiple queues (group members) in a weighted round-robin manner. A queue's weight sets the number of packets transmitted from the queue in each round. For example, if Q2, Q1, and Q0 are the group members, and their weights are 3, 2, and 1, respectively, the scheduler transmits 3 packets from Q2, 2 - from Q1, and 1 - from Q0. The actual Tx order is "Q2, Q1, Q0, Q2, Q1, Q2" - for even fairer scheduling. There are two hardware groups: and . There is a strict priority ordering between the two groups: the low- low-priority-group high-priority-group priority-group is transmitting only when queues in the high-priority-group are empty. However, it is possible to use only one group for all queues.all The default (built-in) RouterOS queue setup is listed below. Q3-Q5 share the bandwidth within the high-priority group, where packets are transmitted while Q6 and Q7 are empty. Q0-Q2 are the members of the low-priority-group, where packets are transmitted while Q3-Q7 are empty. The default, best-effort (PCP=0, DSCP=0) traffic class is 1, while the lowest priority (PCP=1) has traffic class 0. Changing any hardware resource allocation parameter in runtime results in a temporary device halt when no packets can be enqueued nor transmitted. Temporary packet loss is expected while the device is forwarding traffic.

1. 2. 3. 4. /interface/ethernet/switch/qos/profile add name=tcp-wred traffic-class=2 pcp=0 dscp=0 # move TCP traffic to queue2 /interface/ethernet/switch/rule add new-qos-profile=tcp-wred ports=ether1,ether2,ether3,ether4 protocol=tcp switch=switch1 # set the same scheduling priority (weight) between queue1 and queue2 # apply WRED only to queue2 - TCP traffic /interface/ethernet/switch/qos/tx-manager/queue/ set [find where traffic-class=1] weight=2 schedule=low-priority-group use-shared-buffers=yes shared-pool- index=0 wred=no set [find where traffic-class=2] weight=2 schedule=low-priority-group use-shared-buffers=yes shared-pool- index=0 wred=yes Explicit Congestion Notification (ECN) Some switch chips can perform ECN marking of IP packets on the hardware level, according to RFC 3168. Hardware ECN marking is based on the WRED mechanism, but instead of dropping IP packets, they are marked with CE (Congestion Experienced, binary 11) in the ECN field (two least significant bits in IPv4/TOS or IPv6/TrafficClass octet). Only ECN-Capable IP packets may be marked - those with the ECN field value of ECT(1) or ECT(0) (binary 01 or 10, respectively). Not ECN-Capable Transport packets (ECN=00) never get marked. If a packet already has the CE mark (ECN=11), it never gets cleared, even if the device does not experience congestion. Set on to enable ECN marking. ecn=yes Tx Manager Queue The packet receives the CE mark if all conditions below are met: The packet is either IPv4 or IPv6. The ECN field value in IP header is either ECT(1) or ECT(0). Egress port's Tx Queue has ecn=yes and uses shared buffers ( ). use-shared-buffers=yes or queueX-packet-use > queueX-shared-packet-cap queueX-byte-use > queueX-shared-byte-cap . Priority-based Flow Control (PFC) Priority-Based Flow Control (PFC) provides lossless operation for up to eight traffic classes, so that congestion in one traffic class does not pause other traffic classes. In addition, PFC enables co-existence of loss-sensitive traffic types with loss tolerant traffic type in the same network. PFC-capable switch chips are complaint with IEEE 802.1Qbb PFC, meaning that the respective devices are capable of generating and responding to PFC frames. On the triggering part, the PFC frame is sent by the source port and traffic class experiencing the congestion. The timer values of the generated PFC frames are 0xFFFF for pause (XOFF) and 0x0 for resume (XON), and the appropriate bit in the priority enable vector is set. On the response part, the received PFC frame pauses the specific priority queues on the port that received the PFC frame for the duration specified by the PFC frame. In RouterOS, PFC configuration is organized in , where each port can be assigned to a specific profile. A PFC profile defines the traffic classes to profiles enable PFC on, pause/resume thresholds to send XOFF/XON PFC frames, respectively, and whenever the assigned ports should transmit or/and receive PFC frames. While congestion occurs on egress ports, PFC is triggered on the ingress port. Shared buffers must be used to associate the amount of ingressed traffic with the respective packets waiting in Tx queues. For each PFC-enabled traffic class, set to the respective . It is also use-shared-buffers=yes Tx Queues recommended that a separate shared pool ( ) be used for each PFC-enabled queue, especially not to mix it with PFC-disabled traffic shared-pool-index classes. ECN marking mechanism requires the respective Tx queues to use shared buffers ( . use-shared-buffers =yes) Since enabling ECN (ecn=yes) prevents ECN-capable packet drop, queue usage may exceed WRED thresholds if the traffic sender doesn't react to congestion notification in time. RouterOS implements 1:1 mapping between traffic classes and Tx queues. Packets with assigned traffic class 0 get enqueued in queue0, TC1 - queue1, etc., up to TC7-Q7. Hence, the terms "traffic class" and "tx queue" are used interchangeably in this text.

When choosing pause and resume thresholds, consider a delay in transmitting a PFC frame and processing it by the other side. For example, device A experienced congestion at time T, transmitted a PFC pause frame to device B, and B processed the frame and halted transmission at time T+D. During the delta time D, device B still kept sending traffic. If device A has configured the pause threshold to 100%, it has no free buffers available, and, therefore, packets may drop, which is unacceptable for lossless traffic classes. Lowering the pause threshold, let's say, down to 80% issues a PFC pause frame while still having free memory to accumulate traffic during the delta time D. The same applies to resume threshold. Setting it to 0% keeps the device idle during the delta time, lowering the overall throughput. PFC Rx requires setting the egress rate to all associated queues to calculate pause time, even if it matches the wire speed. For example, if PFC runs on traffic class 3, the assigned ports require the setting. egress-rate-queue3 /interface/ethernet/switch/qos/priority-flow-control add name=pfctc3 traffic-class=3 rx=yes /interface/ethernet/switch/qos/port set sfp-sfpplus1,sfp-sfpplus2 pfc=pfctc3 egress-rate-queue3=10G Property Reference Switch settings Sub-menu: /interface/ethernet/switch Switch QoS settings (in addition to the existing ones). Property Description qos-hw-offloading ( ; Default: ) yes | no no Allows enabling QoS for the given switch chip (if the latter supports QoS). Port settings Sub-menu: /interface/ethernet/switch/qos/port Switch port QoS settings. Assigns a QoS profile to ingress packets on the given port. The assigned profile can be changed via match rules if the port is considered trusted. By default, ports are untrusted and receive the default QoS profile (Best-Effort, PCP=0, DSCP=0), where priority fields are cleared from the egress packets. Property Description egress-rate-queue0 .. egress-rate-queue7 ( ; integer: 0..18446744073709551615 Default ) !egress-rate-queuexSets egress traffic limitation (bits per second) for specific output queue. It is possible to specify the limit using suffixes like k, M, or G to represent kbps, Mbps, or Gbps. This setting can be combined with the overall per-port limit (see ). egress-rate /in/eth/sw/port map ( ; Default: ) name default Allows user-defined in the case of a trusted port or host (see QoS priority-to-profile mapping /in/eth/sw )./qos/map pfc ( ; Default: ) name disabled The name of the to control ingress priority-based traffic flow (see PFC profile /in/eth/sw/qos /priority-flow-control ). profile ( ; Default: ) name default The name of the to assign to the ingress packets by default (see QoS profile /in/eth/sw/qos/profile ). trust-l2 ( ; Default: ignore | trust | keep ignore )Whenever to trust the Layer 2 headers of the incoming packets (802.1p PCP field): ignore - ignore L2 header; use the port's value for all incoming packets; profile trust - use PCP field of VLAN-tagged packets for QoS profile lookup in . Untagged packets use map the port's value. Forwarded VLAN or priority-tagged packets receive the PCP value from the profile selected QoS profile (overwriting the original value). keep - trust but keep the original PCP value in forwarded packets. When you enable QoS, turning off the setting will not completely revert to the previous functionality. It is recommended to qos-hw-offloading reboot the device after disabling it.

trust-l3 ( ; Default: ignore | trust | keep ignore )Whenever to trust the Layer 3 headers of the incoming packets (IP DSCP field): ignore - ignore L3 header; use either L2 header or the port's (depends on ). profile trust-l2 trust - use DSCP field of IP packets for QoS profile lookup in . Forwarded/routed IP packets map receive the DSCP value from the selected QoS profile (overwriting the original value). keep - trust but keep the original DSCP value in forwarded/routed packets. tx-manager ( ; Default: ) name default The name of the that is responsible for enqueuing and transmitting packets Transmission Manager from the given port (see ). /in/eth/sw/qos/tx-manager Commands. Command Description print Print the above properties in a human-friendly format. print stats Print port statistics: total and per-queue transmitted/dropped packets/bytes. reset-counters Reset all counters in port statistics to zero. print usage Print queue usage/resources. print pfc Pring Priority Flow Control stats print rates Print per-queue egress traffic limitation (set by ) egress-rate-queueX Port Stats Example [admin@Mikrotik] /interface/ethernet/switch/qos/port> print stats where name=ether2 name: ether2 tx-packet: 2 887 tx-byte: 3 938 897 drop-packet: 1 799 drop-byte: 2 526 144 tx-queue0-packet: 50 tx-queue1-packet: 1 871 tx-queue3-packet: 774 tx-queue5-packet: 192 tx-queue0-byte: 3 924 tx-queue1-byte: 2 468 585 tx-queue3-byte: 1 174 932 tx-queue5-byte: 291 456 drop-queue1-packet: 1 799 drop-queue1-byte: 2 526 144 Property Description name Port name. tx-packet The total number of packets transmitted via this port. tx-byte The total number of bytes transmitted via this port. L3 trust mode has higher precedence than L2 unless or the packet does not have an IP header. trust-l3=ignore Forwarded/routed packets obtain priority field values (PCP, DSCP) from the selected QoS profile, overwriting the original values unless the respective trust mode is set to . keep

drop-packet The total number of packets should have been transmitted via this port but were dropped due to a lack of resources (e. g., queue buffers) or QoS Enforcement. drop-byte The total number of bytes should have been transmitted via this port but were dropped. tx-queue0-packet .. tx-queue7- packetThe number of packets transmitted via this port from the respective queue. tx-queue0-byte .. tx-queue7- byteThe number of bytes transmitted via this port from the respective queue. drop-queue0-packet .. drop- queue7-packetThe number of packets dropped from the respective queue (or not enqueued at all due to lack of resources). drop-queue0-byte .. drop- queue7-byteThe number of bytes dropped from the respective queue. Port Resources/Usage Example [admin@crs326] /interface/ethernet/switch/qos/port> print usage where name=ether2 name: ether2 packet-cap: 136 packet-use: 5 byte-cap: 35 840 byte-use: 9 472 queue0-packet-cap: 130 queue0-packet-use: 1 queue1-packet-cap: 5 queue1-packet-use: 4 queue3-packet-cap: 65 queue3-packet-use: 2 queue0-byte-cap: 24 576 queue0-byte-use: 256 queue1-byte-cap: 7 680 queue1-byte-use: 6 144 queue3-byte-cap: 14 080 queue3-byte-use: 3 072 Property Description name Port name. packet-cap Port's packet capacity. The maximum number of packets that can be enqueued for transmission via the port. packet-use 1 Port's packet usage. The number of packets that are currently enqueued in all port's queues. byte-cap Port's byte capacity (buffer size). The maximum number of bytes that can be enqueued for transmission via the port. byte-use 1 Port's byte usage. The size of hardware buffers (in bytes) that are currently allocated for packets the enqueued packets. Since the buffers are allocated by blocks (usually - 256B each), the allocated buffer size can be bigger than the actual payload. queue0-packet-cap .. queue7-packet-cap 2Individual queue capacity. The maximum number of packets that can be enqueued in the respective queues (unless the S are enabled). hared Buffers Due to hardware limitations, some switch chip models may break traffic flow while accessing QoS port data. Use port for usage usage diagnostics/troubleshooting only. For monitoring, use QoS or Port instead. monitor stats

queue0-shared-packet-cap .. queue7-shared-packet- cap2 Shared queue capacity (individual queue capacity + shared buffers). The maximum number of packets that can be enqueued in the respective queues. queue0-packet-use .. queue7-packet-use 2Queue packet usage. The number of enqueued packets in the respective queues. queue0-byte-cap .. queue7- byte-cap 2Individual queue capacity. The maximum number of bytes that can be enqueued in the respective queues (unless the Shar ed Buffers are enabled). queue0-shared-byte-cap .. queue7-shared-byte-cap 2Shared queue capacity (individual queue capacity + shared buffers). The maximum number of bytes that can be enqueued in the respective queues. queue0-byte-use .. queue7- byte-use 2Queue buffer usage (in bytes). The size of hardware buffers (in bytes) that are currently allocated for packets in the respective queues. queue0-byte-max .. queue7-byte-max 2Maximum queue buffer fill level (in bytes). Available only on devices that provide the queue statistics service. Use the reset command to reset values. -counters Port's packet/byte usage can exceed the capacity if are enabled.1Shared Buffers Only the queues in use are printed.2 Port PFC Stats Example [admin@crs317] /interface/ethernet/switch/qos/port> print pfc interval=1 where running name: sfp-sfpplus1 sfp-sfpplus2 ether1 pfc: roce disabled disabled pfc-tx: 46 pfc-paused-tc: 3 pfc3-pause-threshold: 1 048 576 pfc3-resume-threshold: 10 240 pfc3-use: 1 075 200 Property Description name Port name. pfc PFC profile name. pfc-rx Received PFC frame count. pfc-tx Transmitted PFC frame count. pfc-paused-tc The list of traffic classes should be paused (from the sender's perspective). PFC pause frames (XOFF) are periodically sent with the listed timers set from this port. pfc0-pause-threshold .. pfc7-pause-thresholdPause thresholds of the respective traffic classes. Only PFC-enabled traffic classes are displayed. pfc0-resume-threshold .. pfc7-resume-thresholdResume thresholds of the respective traffic classes. Only PFC-enabled traffic classes are displayed. pfc0-use .. pfc7-use The current buffer usage of the respective traffic classes (in bytes). In other words, it is the total size of all queued packets on all ports that were received from this port. Only PFC-enabled traffic classes are displayed. QoS Menu Sub-menu: /interface/ethernet/switch/qos

Almost the entire QoS HW configuration is located under . Such an approach allows storing all QoS-related configuration items in one /in/eth/sw/qos place, easy monitoring and exporting ( ). /in/eth/sw/qos/export QoS entries have two major flags: H - Hardware-offloaded. I - Inactive. QoS Settings Sub-menu: /interface/ethernet/switch/qos/settings Property Description multicast- buffers (perc ; ent: 1..90 Default: )10Maximum amount of packet buffers for multicast/broadcast traffic (% of the total buffer memory). shared- buffers (perc ; ent: 0..90 Default: )40Maximum amount of packet buffers that are shared between ports (% of the total buffer memory). Setting it to 0 disables buffer sharing. The remaining buffer memory is split between the ports. shared- buffers-color (all | green- only | yellow- ; and-green Default: )allRestricts shared buffer usage for specific traffic colors only. shared- pool0 .. shared- pool7 (perce ; nt: 0..100 Default: )autoIf the device supports multiple shared buffer pools, these settings allows adjusting the size of each pool (% of the buffer memory, shared where 100% means all shared buffers allocated by the setting). For example, if shared-buffers=40 and shared-pool0=50, shared-buffers the shared pool #0 (the first one) receives 20% of the total buffer memory (50% of 40% or "0.5 * 0.4 = 0.2"). Auto mode tries to equally allocate available resources between pools that uses auto setting, and provides at least a minimum of 10% of the total shared buffer size if the sum of other manually configured pools are exceeded. The default setting (auto). treat-yellow- as (green | ; Default: red )redFor devices that support only two-color traffic marking (red/green). This setting allows using the same QoS profiles for the devices with two- and three-color traffic marking. wred- threshold (lo w | medium Defau | high; lt: ) mediumA relative amount of packets above a shared queue cap (" " or " ") where queueX-shared-packet-cap queueX-shared-byte-cap random drops take place. This threshold is applied only to queues with enabled ( ) that use Weighed Random Early Detection wred=yes shared buffers ( . The higher the queue buffer fill level, the higher the packet drop chance. The threshold use-shared-buffers=yes) low means the random tail drop starts later; the - sooner. high QoS Monitor Command: /interface/ethernet/switch/qos/monitor

Example [admin@crs312] /interface/ethernet/switch/qos> monitor once total-packet-cap: 11 480 total-packet-use: 454 total-byte-cap: 3072.0KiB total-byte-use: 681.0KiB multicast-packet-cap: 1 148 multicast-packet-use: 0 multicast-byte-cap: 307.0KiB multicast-byte-use: 0 shared-pool0-packet-cap: 2 296 shared-pool0-packet-use: 0 shared-pool3-packet-cap: 2 296 shared-pool3-packet-use: 190 shared-pool0-byte-cap: 614.2KiB shared-pool0-byte-use: 0 shared-pool3-byte-cap: 614.2KiB shared-pool3-byte-use: 610.5KiB wred-packet-cap: 512 wred-byte-cap: 128.0KiB Monitors hardware QoS resources. Property Description total-packet-cap (in teger)Total packet capacity. The maximum number of hardware packet descriptors that the device can store is all queues. total-packet-use (in teger)Total packet usage. The current number of packet descriptors residing in the hardware memory. total-byte-cap (byte) Total tx memory capacity. total-byte-use (byte) Total tx memory usage. The current number of bytes occupied by the packets in all tx queues. multicast-packet- cap (integer)Multicast packet capacity. The maximum number of hardware packet descriptors that can be used by multicast/broadcast traffic. Depends on the setting. multicast-buffers multicast-packet- use (integer)Multicast packet usage. The hardware makes a copy of the packet descriptor for each multicast destination. shared-packet-cap (integer)Shared packet capacity. The maximum number of hardware packet descriptors that can be shared between ports and tx queues. Depends on the setting. shared-buffers shared-packet-use (integer)Shared packet usage. The current number of shared packet descriptors used by all tx queues. shared-byte-cap (b yte)Shared tx memory capacity. Depends on the setting. shared-buffers shared-byte-use (b yte)Shared tx memory usage. The current number of shared buffers occupied by the packets in all tx queues. shared-pool0- packet-cap .. shared-pool7- packet-cap (integer)Shared packet capacity of the each shared pool. Only the shared pools in use are displayed. These fields are omitted if the device does not support multiple shared pools. shared-pool0- packet-use .. shared-pool7- packet-use (integer)Per-pool shared packet usage. Only the shared pools in use are displayed. These fields are omitted if the device does not support multiple shared pools.

wred-packet-cap (i nteger)The maximum packet count that a queue can use above the shared cap (" queueX-shared-packet-cap " in "/in/eth/sw/qos /port print usage ") to trigger a random tail drop. For example, if " queue1-shared-packet-cap=3072 " and "wred- packet-cap=512 ", WRED triggers when queue1-packet-use exceeds 3072, reaching 100% drop rate at 3072+512=3584 packets. wred-byte-cap (inte ger)The maximum byte count that a queue can use above the shared cap (" ") to trigger a random tail queueX-shared-byte-cap drop. For example, if " " and " ", WRED triggers when queue1-shared-byte-cap=768KiB wred-byte-cap=128KiB queue1- exceeds 768KiB, reaching 100% drop rate at 768+128=896KiB. packet-use QoS Profile Sub-menu: /interface/ethernet/switch/qos/profile QoS profiles determine priority field values (PCP, DSCP) for the forwarded/routed packets. Congestion avoidance/resolution is based on QoS profiles. Each packet gets a QoS profile assigned based on the ingress switch port QoS settings (see ). /in/eth/sw/port Property Description color (green ; | yellow | red Default: green )Traffic color for color-aware drop precedence management. Leave the default value (green) for color-blind drop precedence management. dscp (integer ; : 0..63 Default: )0IPv4/IPv6 DSCP field value for the egress packets assigned to the QoS profile. name ( ; string Default: )The user-defined name of the QoS profile. pcp (integer: ; 0..7 Default: )0VLAN priority value (IEEE 802.1q PCP - Priority Code Point). Used only if the egress packets assigned to the QoS profile are VLAN- tagged (have the 802.1q header). The value can be further altered via the QoS Egress Map. traffic-class (i ; nteger: 0..7 Default: )0The traffic class determines the packet priority and the egress queue (see ). The queue number is usually the same as the tx-manager traffic class (packets with tc0 go into queue0, tc1 - queue1, ... tc7 - queue7). Unlike pcp, where 0 means the default priority but 1 - the lowest one (and further customizable), traffic classes are strictly ordered. TC0 always selects the lowest priority, etc. QoS Mapping Sub-menu: /interface/ethernet/switch/qos/map Priority-to-profile mapping table(-s) for trusted packets. All switch chips have one built-in map - . In addition, some models allow the user to define default custom mapping tables and assign different maps to various switch ports via the property: qos-map devices based on , or switch chip models support only one map - default. Marvell Prestera 98DX224S, 98DX226S 98DX3236 devices based on , switch chips, or model devices support up to 12 maps (the default + 11 user- Marvell Prestera 98DX8xxx 98DX4xxx 98DX325x defined). Property Description name ( ; Default: ) string The user-defined name of the mapping table. VLAN Map Sub-menu: /interface/ethernet/switch/qos/map/vlan Matches VLAN priorities (802.1p PCP/DEI fields) to QoS profiles. By default, all values are matched to the default QoS profile. Property Description dei-only (yes ; Default: ) | no no Map only packets with DEI (formerly CFI) bit set in the VLAN header.

map ( ; Default: ) name default The name of the mapping table. profile ( ; Default: ) name The name of the QoS profile to assign to the matched packets. pcp ( ; Default: ) range: 0..7 0 VLAN priority (PCP) value(-s) for the lookup. DSCP Map Sub-menu: /interface/ethernet/switch/qos/map/ip Matches DSCP values to QoS profiles. Property Description dscp ( ; Default: ) range: 0..63 0DSCP value(-s) for the lookup. map ( ; Default: ) name default The name of the mapping table. If not set, the standard (built-in) mapping table gets altered. profile ( ; Default: ) name The name of the QoS profile to assign to the matched packets. Transmission Manager Sub-menu: /interface/ethernet/switch/qos/tx-manager Transmission (Tx) Manager controls packet enqueuing for transmission and packet tx order. Different switch ports can be assigned to different Tx managers. The maximum number of hardware Tx managers depends on the switch chip model. Property Description name ( ; string Default: )The user-defined name of the Tx Manager queue-buffers (perc ent: 0%..100% | bytes | auto; Default: ) autoThe total amount of hardware Tx buffers allocated to all ports linked to this Tx Manager. Any value but is NOT scaled by the auto number of ports. For example, if queue-buffers=30%, and there are 3 ports using this Tx Manager, each respective port receives 10% of total available resources. Adding two more ports to the Tx Manager drops per-port buffers down to 6% (30/5). Transmission Queue Scheduler Sub-menu: /interface/ethernet/switch/qos/tx-manager/queue Each port has eight Tx queues. The assigned Tx Manager controls packet enqueuing and schedules transmission orders. Each queue can have either strict priority (where packets with the highest traffic class are always transmitted first) or grouped together for a weighted round-robin tx schedule. Creating a Tx Manager automatically creates all eight respective queue schedulers. Property Description tx-manager (na ; ) meread-onlyThe linked Tx Manager Port status has not effect on the allocated resources. Running ports receive the same amount of queue buffers as disconnected or disabled ones if all of them are assigned to the same Tx Manager. Changing any properties of Tx manager or queues completely halts traffic enqueueing and transmission during the offload process. Temporary packet loss is expected while the device is forwarding traffic.

traffic-class (int ; eger: 0..7 ) read-onlyThe traffic class (tc0..tc7) and the respective port queue (queue0..queue7) that the scheduler controls. schedule (strict- priority | high- priority-group | low-priority- ) group strict-priority - packets in the respective queue are always scheduled before moving to lower traffic classes. Packets with lower traffic classes are not transmitted until the current queue is empty. high-priority-group - all queues in the group are scheduled together by using a weighted round-robin principle. For example, if TC5 has weight 4, TC4 - 3, and TC3 - 2, then the scheduler transmits 4 packets from queue5, 3 packets from Q4, and 2 packets from Q3 in a single round. To achieve lower latency, each round is "sliced" between all queues in the group. In other words, the packet order in each round of the above example is "Q5, Q4, Q3, Q5, Q4, Q3, Q5, Q4, Q5". low-priority-group - similar logic to the high-priority-group, but the low-priority-group is scheduled only when all queues in the high-priority-group are empty. weight (integer: 0..255; Default: 1 )The weight value for the traffic class if it is a member of a schedule group. The field is not used in the case of strict priority schedule. queue-buffers ( percent: 0%.. 100% | bytes | auto; Default: a )utoThe amount of hardware Tx buffers allocated to this queue. Any value but is NOT scaled by the number of ports, i.e., the value auto gets split on ports linked to the Tx Manager. When given in percent, it means percentage of the tx-manager's queue-buffers value. use-shared- buffers (yes | no)Allow the queue to use the shared buffer pool when are full. If the queue is full and the shared buffers are disabled, the queue-buffers packet gets dropped. If the shared buffers are enabled, the queue may use up to or (see shared-packet-cap shared-poolX-packet-cap ) packets from the shared pool. for details QoS Settings shared-pool- index (integer; Default: )0The shared pool index for the queue to use. Relevant only if and the device supports multiple shared pools. use-shared-buffers=yes wred ( ; yes | no Default: no)Enables/disables for the given queue. Weighted Random Early Detection ecn ( yes | no; Default: ) noEnables/disables of the transmitted packets. ECN marking wred-actual (ye ; read- s | no only)The actual WRED value. ecn-actual (yes ; read-only)| noThe actual ECN value. Priority-based Flow Control (PFC) Sub-menu: /interface/ethernet/switch/qos/priority-flow-control PFC configuration is organized in profiles. Different switch ports can be assigned to different PFC profiles. The maximum number of hardware Tx managers depends on the switch chip model. The builtin profile named " " cannot be changed. disabled Property Description name ( ; Default: ) string The user-defined name of the PFC profile pause-threshold (percent: 0%..100% | bytes | auto; Default: auto)Transmits a pause frame (XOFF) when the total size of enqueued packets reaches this threshold. Enqueued packets are counted per ingress port. Applies only when . The value can be given either explicitly in bytes or percent of the tx=yes respective shared pool size ( ). shared-poolX-byte-cap On some device models, due to hardware limitations, enabling ECN on one queue turns on CE marking of ECN-capable packets on all queues. In such cases, despite . ecn-actual=yes ecn=no

resume-threshold (percen t: 0%..100% | bytes | auto; Default: auto)Transmits a resume frame (XON) when the total size of enqueued packets drops down to this threshold. Enqueued packets are counted per ingress port. Applies only when . The value can be given either explicitly in bytes or percent of the tx=yes respective shared pool size ( ). shared-poolX-byte-cap rx ( ; Default: yes | no no) Enables receiving of PFC frames. The received PFC frame pauses the specific priority queues on the port that received the PFC frame for the duration specified by the PFC frame. Disabling rx disables queue pausing. traffic-class (integer ) array: 0..7The list of PFC-enabled traffic classes. tx ( ; Default: yes | no no) Enables transmition of PFC frames.

1. 2. 3. Switch Chip Features Introduction Features Port Switching Switch All Ports Feature Port Mirroring Port Settings VLAN Table Host Table Rule Table Port isolation Private VLAN Isolated switch groups CPU Flow Control Statistics Setup Examples VLAN Example 1 (Trunk and Access Ports) VLAN Example 2 (Trunk and Hybrid Ports) Management access configuration Tagged Untagged Untagged from tagged port Inter-VLAN routing See also Introduction There are several types of switch chips on Routerboards and they have different sets of features. Most of them (from now on "Other") have only the basic "Port Switching" feature, but there are a few with more features: Feature QCA8337 Atheros8327 Atheros8316 Atheros8227 Atheros7240 IPQ- PPEICPlus175D MT7621, MT7531EN7562CT RTL8367 88E6393X 88E6191X, 88E6190 Port Switchingyes yes yes yes yes yes yes yes yes yes yes yes Port Mirroringyes yes yes yes yes no yes yes yes yes yes yes TX limit 1 yes yes yes yes yes no no yes yes yes yes yes RX limit 1 yes yes no no no no no yes yes yes yes yes Host table 2048 entries 2048 entries 2048 entries 1024 entries 2048 entries 2048 entries2048 entries 2 2048 entries 1024 entries 2048 entries 16k entries 16k entries Vlan table 4096 entries 4096 entries 4096 entries 4096 entries 16 entries no no 4096 entries 34096 entries 34096 entries 34096 entries 34096 entries 3 Rule table 92 rules 92 rules 32 rules no no no no no no no 256 no Notes For QCA8337, Atheros8327, Atheros8316, Atheros8227, and Atheros7240 the Tx/Rx rate limits can be changed with property on bandwidth "/i menu, see more details in the . For RTL8367, 88E6393X, 88E6191X, MT7621 and MT7531 Tx " nterface ethernet Ethernet manual 88E6190, /Rx rate limit can be changed with and properties on " " menu. egress-rate ingress-rate /interface ethernet switch port MAC addresses are learned up to the specified number, but the content of a switch host table is not available in RouterOS and static host configuration is not supported. Bridge HW vlan-filtering was added in the RouterOS . 7.1rc1 (for RTL8367) and 7.1rc5 (for MT7621) versions other The switch does not support et 0x88a8 or 0x9100 (only 0x8100 is supported) and no . Using these features will disable HW offload. her-type tag-stacking RouterBoard Switch-chip description Cloud Router Switch (CRS) series devices have highly advanced switch chips built-in, they support a wide variety of features. For more details about switch chip capabilities on CRS1xx/CRS2xx series devices check the manual, for CRS3xx series CRS1xx/CRS2xx series switches devices check the manual. CRS3xx, CRS5xx series switches, and CCR2116, CCR2216 routers

C52iG-5HaxD2HaxD-TC (hAP ax ), C53UiG+5HPaxD2HPaxD (hAP ax ), Chateau ax series2 3 IPQ-PPE (ether1-ether5) cAPGi-5HaxD2HaxD (cAP ax) IPQ-PPE (ether1-ether2) L009 series 88E6190 (ether2-ether8, sfp1) RB5009 series 88E6393X (ether1-ether8, sfp- sfpplus1) CCR2004-16G-2S+ 88E6191X (ether1-ether8); 88E6191X (ether9-ether16); RB4011iGS+ RTL8367 (ether1-ether5); RTL8367 (ether6-ether10); RB1100AHx4 RTL8367 (ether1-ether5); RTL8367 (ether6-ether10); RTL8367 (ether11- ether13) L41G-2axD (hAP ax lite) MT7531 (ether1-ether4) RB750Gr3 (hEX), RB760iGS (hEX S) MT7621 (ether1-ether5) E50UG (hEX Refresh) EN7562CT (ether2-ether5) RBM33G MT7621 (ether1-ether3) RB3011 series QCA8337 (ether1-ether5); QCA8337 (ether6-ether10) RB OmniTik ac series QCA8337 (ether1-ether5) RBwsAP-5Hac2nD (wsAP ac lite) Atheros8227 (ether1-ether3) RB941-2nD (hAP lite) Atheros8227 (ether1-ether4) RB951Ui-2nD (hAP); RB952Ui-5ac2nD (hAP ac lite); RB750r2 (hEX lite); RB750UPr2 (hEX PoE lite); RB750P- PBr2 (PowerBox); RB750P r2; RBOmniTikU-5HnDr2 (OmniTIK 5); RBOmniTikUPA-5HnDr2 (OmniTIK 5 PoE)Atheros8227 (ether1-ether5) RB750Gr2 (hEX); RB962UiGS-5HacT2HnT (hAP ac); RB960PGS (hEX PoE); RB960PGS-PB (PowerBox Pro) QCA8337 (ether1-ether5) RB953GS Atheros8327 (ether1-ether3+sfp1) RB850Gx2 Atheros8327 (ether1-ether5) with ether1 optional RB2011 series Atheros8327 (ether1-ether5+sfp1); Atheros8227 (ether6-ether10) RB750GL; RB751G-2HnD; RB951G-2HnD; RBD52G-5HacD2HnD (hAP ac²), RBD53iG-5HacD2HnD (hAP ac³), RBD53GR-5HacD2HnD&R11e-LTE6 (hAP ac³ LTE6 kit), RBD53G-5HacD2HnD-TC&EG12-EA (Chateau LTE12)Atheros8327 (ether1-ether5) RBcAPGi-5acD2nD (cAP ac), RBwAPGR-5HacD2HnD (wAP R ac and wAP ac LTE series), RBwAPG- 5HacD2HnD (wAP ac), RBD25G-5HPacQD2HPnD (Audience), RBD25GR-5HPacQD2HPnD&R11e-LTE6 (Audience LTE6 kit), Atheros8327 (ether1-ether2) RBD22UGS-5HPacD2HnD (mANTBox 52 15s) Atheros8327 (ether1-sfp1) RB1100AH Atheros8327 (ether1-ether5); Atheros8327 (ether6-ether10) RB1100AHx2 Atheros8327 (ether1-ether5); Atheros8327 (ether6-ether10) CCR1009-8G-1S-1S+; CCR1009-8G-1S Atheros8327 (ether1-ether4) RB493G Atheros8316 (ether1+ether6-ether9); Atheros8316 (ether2-ether5)

Ether1 port on RB450G/RB435G/RB850Gx2 devices has a feature that allows it to be removed/added to the default switch group, this setting is available on the menu. By default ether1 port will be included in the switch group. /interface ethernet switch Property Description switch-all-ports (no | ; Default: ) yes yesChanges ether1 switch group only on RB450G/RB435G/RB850Gx2 devices. yes - ether1 is part of the switch and supports switch grouping and all other advanced Atheros8316/Atheros8327 features including extended statistics ( ). /interface ethernet print stats no - ether1 is not part of the switch, effectively making it a stand-alone ethernet port, this way increasing its throughput to other ports in bridged and routed mode, but removing the switching possibility on this port. Port Mirroring Port mirroring lets the switch to copy all traffic that is going in and out of one port ( ) and send out these copied frames to some other port ( mirror-source ). This feature can be used to easily set up a 'tap' device that receives all traffic that goes in/out of some specific port. Note that mirror-target mirror- and ports have to belong to the same switch (see which port belongs to which switch in menu). Also, source mirror-target /interface ethernet mirror-target can have a special ' ' value, which means that mirrored packets should be sent out to the switch chips CPU port. Port mirroring happens cpu independently of switching groups that have or have not been set up. Sub-menu: /interface ethernet switch Property Description mirror-source (name | ; Default: ) none noneSelects a single mirroring source port. Ingress and egress traffic will be sent to the port. mirror-target Note that mirror- port has to belong to the same switch (see which port belongs to which switch in target /interface ethernet menu). mirror-target (name | ; Default: none | cpu none )Selects a single mirroring target port. Mirrored packets from and (see the property in rule and host mirror-source mirror table) will be sent to the selected port. mirror-egress-target (na ; Default: me | none none )Selects a single mirroring egress target port, only available on , and switch chips. Mirrored 88E6393X 88E6191X 88E6190 packets from (see the property in port menu) will be sent to the selected port. mirror-egress Sub-menu: /interface ethernet switch rule Property Description mirror ( ; no | yes Default: ) noWhether to send a packet copy to port. mirror-target

mirror-ports ( ; name Default: ) Selects multiple mirroring target ports, only available on switch chip. Matched packets in the ACL rule will be 88E6393X copied and sent to selected ports. Sub-menu: /interface ethernet switch host Property Description mirror ( ; no | yes Default: ) noWhether to send a frame copy to port from a frame with a matching MAC destination address (matching mirror-target destination or source address for CRS3xx series switches) Sub-menu: /interface ethernet switch port Property Description ( ; mirror-egress no | yes Default: )noWhether to send egress packet copy to the port, only available on , mirror-egress-target 88E6393X 88E6191X and switch chips. 88E6190 ( ; mirror-ingress no | yes Default: )noWhether to send ingress packet copy to the port, only available on , mirror-ingress-target 88E6393X 88E6191X and switch chips. 88E6190 mirror-ingress-target (name | ; Default: ) none noneSelects a single mirroring ingress target port, only available on , and switch chips. 88E6393X 88E6191X 88E6190 Mirrored packets from will be sent to the selected port. mirror-ingress Port mirroring configuration example: /interface ethernet switch set switch1 mirror-source=ether2 mirror-target=ether3 Port Settings Properties under this menu are used to configure VLAN switching and filtering options for switch chips that support a VLAN Table. These properties are only available to switch chips that have VLAN Table support, check the table to make sure your device supports such a feature. Switch Chip Features Property Description vlan-mode (check | disabled | fallback | ; Default: secure disab )ledChanges the VLAN lookup mechanism against the for ingress traffic. VLAN Table disabled - disables checking against the VLAN Table completely for ingress traffic. No traffic is dropped when set on the ingress port. fallback - checks tagged traffic against the VLAN Table for ingress traffic and forwards all untagged traffic. If ingress traffic is tagged and the egress port is not found in the VLAN table for the appropriate VLAN ID, then traffic is dropped. If a VLAN ID is not found in the VLAN Table, then traffic is forwarded. Used to allow known VLANs only in specific ports. check - checks tagged traffic against the VLAN Table for ingress traffic and drops all untagged traffic. If ingress traffic is tagged and the egress port is not found in the VLAN table for the appropriate VLAN ID, then traffic is dropped. secure - checks tagged traffic against the VLAN Table for ingress traffic and drops all untagged traffic. Both ingress and egress port must be found in the VLAN Table for the appropriate VLAN ID, otherwise, traffic is dropped. If you set as an Ethernet port for a device with at least two switch chips and these mirror-source ports are in a single bridge while mirror-source mirror-target for both switch chips are set to send the packets to the CPU, then this will result in a loop, which can make your device inaccessible. Ingress traffic is considered as traffic that is being sent a certain port, this port is sometimes called . Egress traffic is considered IN ingress port as traffic that is being sent of a certain port, this port is sometimes called . Distinguishing them is very important to properly set OUT egress port up VLAN filtering since some properties apply only to either ingress or egress traffic.

vlan-header (add-if- missing | always-strip ; Default: | leave-as-is ) leave-as-isSets action which is performed on the port for egress traffic. add-if-missing - adds a VLAN tag on egress traffic and uses default-vlan-id from the ingress port. Should be used for trunk ports. always-strip - removes a VLAN tag on egress traffic. Should be used for access ports. leave-as-is - does not add nor remove a VLAN tag on egress traffic. Should be used for hybrid ports. default-vlan-id (auto | ; integer: 0..4095 Default: ) autoAdds a VLAN tag with the specified VLAN ID on all untagged ingress traffic on a port, should be used with set to vlan-header al on a port to configure the port to be the access port. For hybrid ports is used to tag untagged ways-strip default-vlan-id traffic. If two ports have the same , then VLAN tag is not added since the switch chip assumes that traffic is being default-vlan-id forwarded between access ports. VLAN Table VLAN table specifies certain forwarding rules for packets that have a specific 802.1Q tag. Those rules are of higher priority than switch groups configured using the Bridge Hardware Offloading feature. Basically, the table contains entries that map specific VLAN tag IDs to a group of one or more ports. Packets with VLAN tags leave the switch chip through one or more ports that are set in the corresponding table entry. The exact logic that controls how packets with VLAN tags are treated is controlled by a parameter that is changeable per switch port. vlan-mode VLAN ID based forwarding takes into account the MAC addresses dynamically learned or manually added in the host table. QCA8337 and Atheros8327 switch-chips also support Independent VLAN Learning (IVL) which does the learning based on both - MAC addresses and VLAN IDs, thus allowing the same MAC to be used in multiple VLANs. Packets without VLAN tag are treated just as if they had a VLAN tag with port . If or is default-vlan-id vlan-mode=check vlan=mode=secure configured, to forward packets without VLAN tags you have to add an entry to the VLAN table with the same VLAN ID according to . default-vlan-id Property Description disabled ( ; Default: ) no | yes no Enables or disables switch VLAN entry. independent-learning (no ; | yes Default: ) yesWhether to use shared-VLAN-learning (SVL) or independent-VLAN-learning (IVL). ports ( ; Default: ) name none Interface member list for the respective VLAN. This setting accepts comma-separated values. e.g. ports=eth . er1,ether2 switch ( ; Default: ) name none Name of the switch for which the respective VLAN entry is intended for. vlan-id ( ; Default: ) integer: 0..4095 The VLAN ID for certain switch port configurations. VLAN Forwarding Both and along with the VLAN Table can be used to configure VLAN tagging, untagging and filtering, multiple combinations vlan-mode vlan-header are possible, each achieving a different result. Below you can find a table of what kind of traffic is going to be sent out through an egress port when a certain traffic is received on an ingress port for each VLAN Mode. NOTES: L - is set to vlan-header leave-as-is S - set to vlan-header always-strip A - set to vlan-header add-if-missing U - Untagged traffic is sent out T - Tagged traffic is sent out, a tag is already present on the ingress port TA - Tagged traffic is sent out, a tag was added on the ingress port DI - Traffic is dropped on ingress port because of mode selected in vlan-mode On and switch chips, a default property should be used. The switch chip will determine QCA8337 Atheros8327 vlan-header=leave-as-is which ports are access ports by using the property. The should only be used on access/hybrid ports to default-vlan-id default-vlan-id specify which VLAN the untagged ingress traffic is assigned to. Devices with , , , , , switch chips support in RouterOS v7. MT7621 MT7531 RTL8367 88E6393X 88E6191X 88E6190 HW offloaded vlan-filtering VLAN-related configuration on the " h" menu is not available. /interface ethernet switc

DE - Traffic is dropped on egress port because egress port was not found in the VLAN Table VID match - VLAN ID from the VLAN tag for ingress traffic is present in the VLAN Table Port match - Ingress port is present in the VLAN Table for the appropriate VLAN ID VLAN Mode = disabledEgress port not present in VLAN Table Egress port is present in VLAN Table L S A L S A Untagged trafficU U TA U U TA Tagged traffic; no VID matchT U T Tagged traffic; VID match; no Port matchT U T T U T Tagged traffic; VID match; Port matchT U T T U T VLAN Mode = fallbackEgress port not present in VLAN Table Egress port is present in VLAN Table L S A L S A Untagged trafficU U TA U U TA Tagged traffic; no VID matchT U T Tagged traffic; VID match; no Port matchDE DE DE T U T Tagged traffic; VID match; Port matchDE DE DE T U T VLAN Mode = checkEgress port not present in VLAN Table Egress port is present in VLAN Table L S A L S A Untagged traffic Tagged traffic; no VID matchDI DI DI Tagged traffic; VID match; no Port matchDE DE DE T U T Tagged traffic; VID match; Port matchDE DE DE T U T VLAN Mode = secureEgress port not present in VLAN Table Egress port is present in VLAN Table L S A L S A Untagged traffic Tagged traffic; no VID matchDI DI DI Tagged traffic; VID match; no Port matchDI DI DI DI DI DI Tagged traffic; VID match; Port matchDE DE DE T U T Host Table The tables above are meant for more advanced configurations and to double-check your understanding of how packets will be processed with each VLAN related property.

The host table represents switch chip's internal MAC address to port mapping. It can contain two kinds of entries: dynamic and static. Dynamic entries get added automatically, this is also called a learning process: when switch chip receives a packet from a certain port, it adds the packet's source MAC address and port it received the packet from to the host table, so when a packet comes in with the same destination MAC address, it knows to which port it should forward the packet. If the destination MAC address is not present in the host table (so-called unknown-unicast traffic) then it forwards the packet to all ports in the group. Dynamic entries take about 5 minutes to time out. Learning is enabled only on ports that are configured as part of the switch group, so you won't see dynamic entries if you have not set up port switching. Also, you can add static entries that take over dynamic if a dynamic entry with the same MAC address already exists. Since port switching is configured using a bridge with hardware offloading, any static entries created on one table (either bridge host or switch host) will appear on the opposite table as a dynamic entry. Adding a static entry on the switch host table will provide access to some more functionality that is controlled via the following params: Property Description copy-to-cpu ( ; no | yes Default: ) noWhether to send a frame copy to switch CPU port from a frame with a matching MAC destination address (matching destination or source address for CRS3xx series switches) drop ( ; Default: no | yes )noWhether to drop a frame with a matching MAC source address received on a certain port (matching destination or source address for CRS3xx series switches) mac-address ( Def MAC; ault: ) 00:00:00:00:00:00Host's MAC address mirror ( ; Default: no | yes )noWhether to send a frame copy to port from a frame with a matching MAC destination address (matching mirror-target destination or source address for CRS3xx series switches) ports ( ; Default: name no )neName of the interface, static MAC address can be mapped to more than one port, including switch CPU port redirect-to-cpu (no | yes ; Default: ) noWhether to redirect a frame to switch CPU port from a frame with a matching MAC destination address (matching destination or source address for CRS3xx series switches) share-vlan-learned (no | ; Default: ) yes noWhether the static host MAC address lookup is used with shared-VLAN-learning (SVL) or independent-VLAN-learning (IVL). The SVL mode is used for those VLAN entries that do not support IVL or IVL is disabled (independent-learning=no) switch ( ; Default: name n )oneName of the switch to which the MAC address is going to be assigned to vlan-id ( ; integer: 0..4095 Default: ) VLAN ID for the statically added MAC address entry Rule Table Rule table is a very powerful tool allowing wire-speed packet filtering, forwarding and VLAN tagging based on L2, L3 and L4 protocol header field conditions. The menu contains an ordered list of rules just like in , so ACL rules are checked for each packet until a match has /ip firewall filter been found. If multiple rules can match, then only the first rule will be triggered. A rule without any action parameters is a rule to accept the packet. Each rule contains a conditions part and an action part. The action part is controlled by the following parameters: Every switch chip has a finite number of MAC addresses it can store on the chip, see the Introduction table for a specific host table size. Once a host table is full, different techniques can be utilized to cope with the situation, for example, the switch can remove older entries to free space for more recent MAC addresses (used on QCA-8337 and Atheros-8327 switch chips), another option is to simply ignore the new MAC addresses and only remove entries after a timeout has passed (used on Atheros8316, Atheros8227, Atheros-7240, ICPlus175D and Realtek-RTL8367 switch chips), the last option is a combination of the previous two - only allow a certain amount of entries to be renewed and keep the other host portion intact till the timeout (used on MediaTek-MT7621, MT7531 switch chip). These techniques cannot be changed with configuration. For Atheros8316, Atheros8227 and Atheros-7240 switch chips, the switch-cpu port will always participate in the host learning process when at least one hardware offloaded bridge port is active on the switching group. It will cause the switch-cpu port to learn MAC addresses from non- HW offloaded interfaces. This might cause packet loss when a single bridge contains HW and non-HW offloaded interfaces. Also, packet loss might appear when a duplicate MAC address is used on the same switching group regardless if hosts are located on different logical networks. It is recommended to use HW offloading only when all bridge ports can use HW offloaded or keep it disabled on all switch ports when one or more bridge ports cannot be configured with HW offloading.

Property Description copy-to-cpu (no | ; Default: ) yes noWhether to send a packet copy to switch CPU port mirror ( ; no | yes Default: ) noWhether to send a packet copy to port mirror-target new-dst-ports (na ; Default: ) me noneChanges the destination port as specified, multiple ports allowed, including a switch CPU port. An empty setting will drop the packet. When the parameter is not used, the packet will be accepted new-vlan-id (integ ) er: 0..4095Changes the VLAN ID to the specified value or adds a new VLAN tag if one was not already present (the property only applies to the , and switch chips ( : 88E6393X vlan-filtering=yes Atheros8316 88E6393X NOTE in case of switch chip, is also required) new-vlan-priority ( ) integer: 0..7Changes the VLAN priority field (priority code point, the property only applies to , and switch Atheros8327 QCA8337 Atheros8316 chips) rate(integer: 0.. ) 4294967295Sets ingress traffic limitation (bits per second) for matched traffic, can only be applied to the first 32 rule slots (the property only applies to switch chips) Atheros8327/QCA8337 redirect-to-cpu (n ; Default: o | yes no )Changes the destination port of a matching packet to the switch CPU The conditions part is controlled by the rest of the parameters: Property Description disabled ( ; Default: ) no | yes no Enables or disables switch rule dscp ( ) integer: 0..63 Matching DSCP field of the packet dst-address ( ) IP address/Mask Matching destination IP address and mask dst-address6 ( ) IPv6 address/Mask Matching destination IPv6 address and mask dst-mac-address ( ) MAC address/Mask Matching destination MAC address and mask dst-port ( ) integer: 0..65535 Matching destination protocol port number or range flow-label ( ) integer: 0..1048575 Matching IPv6 flow label mac-protocol (802.2 | arp | capsman | dot1x | homeplug-av | ip | ipv6 | ipx | lacp | lldp | loop-protect | macsec | mpls-multicast | mpls-unicast | packing-compr | packing-simple | pppoe | pppoe-discovery | rarp | romon | service-vlan | vlan | or 0.. ) 65535 | or 0x0000-0xffffMatching particular MAC protocol specified by protocol name or number (skips VLAN tags if any) ports ( ) name Name of the interface on which the rule will apply on the received traffic, multiple ports are allowed. If ports property is left empty, the rule will apply to all switch interfaces protocol (dccp | ddp | egp | encap | etherip | ggp | gre | hmp | icmp | icmpv6 | idpr- cmtp | igmp | ipencap | ipip | ipsec-ah | ipsec-esp | ipv6 | ipv6-frag | ipv6-nonxt | ipv6- opts | ipv6-route | iso-tp4 | l2tp | ospf | pim | pup | rdp | rspf | rsvp | sctp | st | tcp | ) udp | udp-lite | vmtp | vrrp | xns-idp | xtp | or 0..255Matching particular IP protocol specified by protocol name or number src-address ( ) IP address/Mask Matching source IP address and mask src-address6 ( ) IPv6 address/Mask Matching source IPv6 address and mask src-mac-address ( ) MAC address/Mask Matching source MAC address and mask src-port ( ) 0..65535 Matching source protocol port number or range switch ( ) switch group Matching switch group on which will the rule apply traffic-class ( ) 0..255 Matching IPv6 traffic class

vlan-id ( ) 0..4095 Matching VLAN ID (the property only applies to the Atheros8316, switch chips) Atheros8327, QCA8337, 88E6393X vlan-header ( ) not-present | present Matching VLAN header, whether the VLAN header is present or not (the property only applies to th e Atheros8316, Atheros8327, QCA8337, 88E6393X switch chips. in case of switch 88E6393X ) chip, vlan-filtering=yes is also required vlan-priority ( )0..7 Matching VLAN priority (priority code point) Port isolation Port isolation provides the possibility to divide (isolate) certain parts of your network, this might be useful when you need to make sure that certain devices cannot access other devices, this can be done by isolating switch ports. Port isolation only works between ports that are members of the same switch. Switch port isolation is available on all switch chips since RouterOS v6.43. Property Description forwarding-override ( ; interface Default: )Forces ingress traffic to be forwarded to a specific interface. Multiple interfaces can be specified by separating them with a comma. Private VLAN In some scenarios, you might need to forward all traffic to an uplink port while all other ports are isolated from each other. This kind of setup is called Privat configuration, the will forward all Ethernet frames directly to the uplink port allowing the to filter unwanted packets and limit access e VLAN Switch Router between devices that are behind switch ports. IPv4 and IPv6 specific conditions cannot be present in the same rule. Because the rule table is processed entirely in switch chips hardware, there is a limitation to how many rules you may have. Depending on the number of conditions (MAC layer, IP layer, IPv6, L4 layer) you use in your rules, the number of active rules may vary from 8 to 32 for Atheros8316 switch chip, from 8 to 16 for Atheros8327/QCA8337 switch chip and from 42 to 256 for 88E6393X switch chip. You can always do / after modifying your rule set to see that no rules at the end of the list are 'invalid' which means interface ethernet switch rule print those rules did not fit into the switch chip. (R/M)STP will only work properly in PVLAN setups, (R/M)STP will not work properly in setups, where there are multiple isolated switch groups, because switch groups might not properly receive BPDUs and therefore fail to detect network loops. The property affects ingress traffic only. Switch ports that do not have the specified can forwarding-override forwarding-override send packets through all switch ports. Switch chips with a VLAN table support ( , , , and ) can override the port isolation QCA8337 Atheros8327 Atheros8316 Atheros8227 Atheros7240 configuration when enabling a VLAN lookup on the switch port (the is set to , or ). If additional port vlan-mode fallback check secure isolation is needed between ports on the same VLAN, a switch rule with a new-dst-ports property can be implemented. Other devices without switch rule support cannot overcome this limitation.

To configure switch port isolation, you need to switch all required ports: /interface bridge add name=bridge1 /interface bridge port add interface=sfp1 bridge=bridge1 hw=yes add interface=ether1 bridge=bridge1 hw=yes add interface=ether2 bridge=bridge1 hw=yes add interface=ether3 bridge=bridge1 hw=yes Override the egress port for each switch port that needs to be isolated (excluding the uplink port): /interface ethernet switch port-isolation set ether1 forwarding-override=sfp1 set ether2 forwarding-override=sfp1 set ether3 forwarding-override=sfp1 Isolated switch groups In some scenarios you might need to isolate a group of devices from other groups, this can be done using the switch port isolation feature. This is useful when you have multiple networks but you want to use a single switch, with port isolation you can allow certain switch ports to be able to communicate through only a set of switch ports. In this example, devices on will only be able to communicate with devices that are on , while devices on ether1-3 ether1-3 will only be able to communicate with devices on ( is not able to communicate with ) ether4-5 ether4-5 ether1-3 ether4-5 By default, the bridge interface is configured with set to . For some devices, this can disable hardware offloading protocol-mode rstp because specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading It is possible to set multiple uplink ports for a single switch chip, this can be done by specifying multiple interfaces and separating them with a comma. Port isolation is only available between ports that are members of the same switch.

To configure isolated switch groups you must first switch all ports: /interface bridge add name=bridge /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether5 hw=yes Then specify in the property all ports that you want to be in the same isolated switch group (except the port on which you are forwarding-override applying the property), for example, to create an isolated switch group for devices: A /interface ethernet switch port-isolation set ether1 forwarding-override=ether2,ether3 set ether2 forwarding-override=ether1,ether3 set ether3 forwarding-override=ether1,ether2 To create an isolated switch group for devices: B By default, the bridge interface is configured with set to . For some devices, this can disable hardware offloading protocol-mode rstp because specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading

/interface ethernet switch port-isolation set ether4 forwarding-override=ether5 set ether5 forwarding-override=ether4 CPU Flow Control All switch chips have a special port that is called , this is the CPU port for a switch chip, it is meant to forward traffic from a switch chip to the switchX-cpu CPU, such a port is required for management traffic and routing features. By default the switch chip ensures that this special CPU port is not congested and sends out Pause Frames when link capacity is exceeded to make sure the port is not oversaturated, this feature is called . Without CPU Flow Control this feature packets that might be crucial for routing or management purposes might get dropped. Since RouterOS v6.43 it is possible to disable the CPU Flow Control feature on some devices that are using one of the following switch chips: Atheros8227, QCA8337, Atheros8327, Atheros7240 or Atheros8316. Other switch chips have this feature enabled by default and cannot be changed. To disable CPU Flow Control use the following command: /interface ethernet switch set switch1 cpu-flow-control=no Statistics Some switch chips are capable of reporting statistics, this can be useful to monitor how many packets are sent to the CPU from the built-in switch chip. These statistics can also be used to monitor CPU Flow Control. You can find an example of the switch chip's statistics below:

RouterBOARDs with Atheros switch chips can be used for 802.1Q Trunking. This feature in RouterOS v6 is supported by QCA8337, Atheros8316, and switch chips. In this example, , and interfaces are access ports, while is a trunk Atheros8327, Atheros8227 Atheros7240 ether3 ether4, ether5 ether2 port. VLAN IDs for each access port: ether3 - 400, ether4 - 300, ether5 - 200. Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether5 hw=yes Add VLAN table entries to allow frames with specific VLAN IDs between ports: /interface ethernet switch vlan add ports=ether2,ether3 switch=switch1 vlan-id=200 add ports=ether2,ether4 switch=switch1 vlan-id=300 add ports=ether2,ether5 switch=switch1 vlan-id=400 Assign and mode for each port and also on ingress for each access port: vlan-mode vlan-header default-vlan-id By default, the bridge interface is configured with set to . For some devices, this can disable hardware offloading protocol-mode rstp because specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading

/interface ethernet switch port set ether2 vlan-mode=secure vlan-header=add-if-missing set ether3 vlan-mode=secure vlan-header=always-strip default-vlan-id=200 set ether4 vlan-mode=secure vlan-header=always-strip default-vlan-id=300 set ether5 vlan-mode=secure vlan-header=always-strip default-vlan-id=400 Setting ensures strict use of the VLAN table. vlan-mode=secure Setting for access ports removes the VLAN header from the frame when it leaves the switch chip. vlan-header=always-strip Setting for trunk port adds VLAN header to untagged frames. vlan-header=add-if-missing default-vlan-id specifies what VLAN ID is added for untagged ingress traffic of the access port. VLAN Example 2 (Trunk and Hybrid Ports) VLAN Hybrid ports can forward both tagged and untagged traffic. This configuration is supported only by some Gigabit switch chips ( QCA8337, ). Atheros8327 Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether5 hw=yes On and switch chips, a default property should be used. The switch chip will determine QCA8337 Atheros8327 vlan-header=leave-as-is which ports are access ports by using the property. The should only be used on access/hybrid ports to default-vlan-id default-vlan-id specify which VLAN the untagged ingress traffic is assigned to.

Add VLAN table entries to allow frames with specific VLAN IDs between ports. /interface ethernet switch vlan add ports=ether2,ether3,ether4,ether5 switch=switch1 vlan-id=200 add ports=ether2,ether3,ether4,ether5 switch=switch1 vlan-id=300 add ports=ether2,ether3,ether4,ether5 switch=switch1 vlan-id=400 In the switch port menu set on all ports and also on planned hybrid ports: vlan-mode default-vlan-id /interface ethernet switch port set ether2 vlan-mode=secure vlan-header=leave-as-is set ether3 vlan-mode=secure vlan-header=leave-as-is default-vlan-id=200 set ether4 vlan-mode=secure vlan-header=leave-as-is default-vlan-id=300 set ether5 vlan-mode=secure vlan-header=leave-as-is default-vlan-id=400 vlan-mode=secure will ensure strict use of the VLAN table. default-vlan-id will define VLAN for untagged ingress traffic on the port. In QCA8337 and Atheros8327 chips when is used, it ignores switch port options. VLAN table entries handle e vlan-mode=secur vlan-header all the egress tagging/untagging and works as on all ports. It means what comes in tagged, goes out tagged as vlan-header=leave-as-is well, only frames are untagged at the egress port. default-vlan-id Management access configuration In these examples, there will be shown examples for multiple scenarios, but each of these scenarios requires you to have switched ports. Below you can find how to switch multiple ports: /interface bridge add name=bridge1 /interface bridge port add interface=ether1 bridge=bridge1 hw=yes add interface=ether2 bridge=bridge1 hw=yes In these examples, it will be assumed that is the trunk port and is the access port, for configuration as the following: ether1 ether2 /interface ethernet switch port set ether1 vlan-header=add-if-missing set ether2 default-vlan-id=100 vlan-header=always-strip /interface ethernet switch vlan add ports=ether1,ether2,switch1-cpu switch=switch1 vlan-id=100 Tagged To make the device accessible only from a certain VLAN, you need to create a new VLAN interface on the bridge interface and assign an IP address to it: /interface vlan add name=MGMT vlan-id=99 interface=bridge1 /ip address add address=192.168.99.1/24 interface=MGMT By default, the bridge interface is configured with set to . For some devices, this can disable hardware offloading protocol-mode rstp because specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading By default, the bridge interface is configured with set to . For some devices, this can disable hardware offloading protocol-mode rstp because specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading

Specify from which interfaces it is allowed to access the device: /interface ethernet switch vlan add ports=ether1,switch1-cpu switch=switch1 vlan-id=99 When the VLAN table is configured, you can enable to limit access to the CPU: vlan-mode=secure /interface ethernet switch port set ether1 vlan-header=add-if-missing vlan-mode=secure set ether2 default-vlan-id=100 vlan-header=always-strip vlan-mode=secure set switch1-cpu vlan-header=leave-as-is vlan-mode=secure Untagged To make the device accessible from the access port, create a VLAN interface with the same VLAN ID as set in , for example, VLAN default-vlan-id 100, and add an IP address to it: /interface vlan add name=VLAN100 vlan-id=100 interface=bridge1 /ip address add address=192.168.100.1/24 interface=VLAN100 Specify which access (untagged) ports are allowed to access the CPU: /interface ethernet switch vlan add ports=ether1,ether2,switch1-cpu switch=switch1 vlan-id=100 When the VLAN table is configured, you can enable to limit access to the CPU: vlan-mode=secure /interface ethernet switch port set ether1 vlan-header=add-if-missing vlan-mode=secure set ether2 default-vlan-id=100 vlan-header=always-strip vlan-mode=secure set switch1-cpu vlan-header=leave-as-is vlan-mode=secure Untagged from tagged port It is possible to allow access to the device from the trunk (tagged) port with untagged traffic. To do so, assign an IP address on the bridge interface: /ip address add address=10.0.0.1/24 interface=bridge1 Only specify trunk ports in this VLAN table entry, it is not possible to allow access to the CPU with tagged traffic through an access port since the access port will tag all ingress traffic with the specified value. default-vlan-id Most commonly an access (untagged) port is accompanied by a trunk (tagged) port. In case of untagged access to the CPU, you are forced to specify both the access port and the trunk port, this gives access to the CPU from the trunk port as well. Not always this is desired and a Firewall might be required on top of VLAN filtering. To setup the management port using untagged traffic on a device with the switch chip, you will need to set Atheros7240 vlan-header=add- for the CPU port.g if-missin

/ip pool add name=POOL10 ranges=192.168.10.100-192.168.10.200 add name=POOL20 ranges=192.168.20.100-192.168.20.200 /ip dhcp-server add address-pool=POOL10 disabled=no interface=VLAN10 name=DHCP10 add address-pool=POOL20 disabled=no interface=VLAN20 name=DHCP20 /ip dhcp-server network add address=192.168.10.0/24 dns-server=8.8.8.8 gateway=192.168.10.1 add address=192.168.20.0/24 dns-server=8.8.8.8 gateway=192.168.20.1 Enable NAT on the device: /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 Add each port to the VLAN table and allow these ports to access the CPU to make DHCP and routing work: /interface ethernet switch vlan add independent-learning=yes ports=ether2,switch1-cpu switch=switch1 vlan-id=10 add independent-learning=yes ports=ether3,switch1-cpu switch=switch1 vlan-id=20 Specify each port to be an access port, and enable secure VLAN mode on each port and on the switch1-cpu port: /interface ethernet switch port set ether2 default-vlan-id=10 vlan-header=always-strip vlan-mode=secure set ether3 default-vlan-id=20 vlan-header=always-strip vlan-mode=secure set switch1-cpu vlan-mode=secure If your device has a switch rule table, then you can limit access between VLANs on a hardware level. As soon as you add an IP address on the VLAN interface you enable inter-VLAN routing, but this can be limited on a hardware level while preserving DHCP Server and other router-related services. To do so, use these ACL rules. With this type of configuration, you can achieve isolated port groups using VLANs. /interface ethernet switch rule add dst-address=192.168.20.0/24 new-dst-ports="" ports=ether2 switch=switch1 add dst-address=192.168.10.0/24 new-dst-ports="" ports=ether3 switch=switch1 See also Switch Router Basic VLAN Switching Bridge Hardware Offloading Spanning Tree Protocol DHCP Snooping and Option 82 MTU on RouterBOARD Layer2 misconfiguration Master-port On and switch chips, a default property should be used. The switch chip will determine QCA8337 Atheros8327 vlan-header=leave-as-is which ports are access ports by using the property. The should only be used on access/hybrid ports to default-vlan-id default-vlan-id specify which VLAN the untagged ingress traffic is assigned to.

If any packet is sent over the 'vlan2' interface, two VLAN tags will be added to the Ethernet header - '11' and '12'. Properties Property Description arp (disabled | enabled | local- proxy-arp | proxy- ; arp | reply-only Default: ) enabledAddress Resolution Protocol setting disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originated from matching IP address/MAC address combinations which are entered as static entries in the IP/ARP table. No dynamic entries will be automatically stored in the IP/ARP table. Therefore for communications to be successful, a valid static entry must already exist. arp-timeout (auto | ; Default: integer auto )How long the ARP record is kept in the ARP table after no packets are received from IP. Value equals to the value of auto arp- inIP/Settings, default is 30s. timeout disabled ( ; yes | no Default: ) noChanges whether the bridge is disabled. interface ( ; name Default: ) Name of the interface on top of which VLAN will work mvrp ( ; yes | no Default: ) noSpecifies whether this VLAN should declare its attributes through Multiple VLAN Registration Protocol (MVRP) as an applicant. Its main use case is for VLANs that is created on Ethernet interface (such as a "router on a stick" setup) that is connected to a bridge supporting . Enabling this option on a VLAN interface that is already part of an MVRP-enabled bridge has no effect, as the MVRP bridge manages MVRP in that case. This property only has an effect when use-service-tag is disabled . mtu (integer: 68.. ; Default: 65535 1500 )Layer3 Maximum transmission unit name ( ; string Default: ) Interface name use-service-tag (ye ; Default: ) s | no IEEE 802.1ad compatible Service Tag vlan-id (integer: 1.. ; Default: ) 4094 1Virtual LAN identifier or tag that is used to distinguish VLANs. Must be equal for all computers that belong to the same VLAN. Setup examples Video examples VLANs pt1 , , VLANs pt2 VLANs pt3 Layer2 VLAN examples MTU should be set to 1500 bytes same as on Ethernet interfaces. But this may not work with some Ethernet cards that do not support receiving /transmitting of full-size Ethernet packets with VLAN header added (1500 bytes data + 4 bytes VLAN header + 14 bytes Ethernet header). In this situation, MTU 1496 can be used, but note that this will cause packet fragmentation if larger packets have to be sent over the interface. At the same time remember that MTU 1496 may cause problems if path MTU discovery is not working properly between source and destination.

/interface vlan add name=VLAN2 vlan-id=2 interface=ether1 disabled=no add name=VLAN3 vlan-id=3 interface=ether1 disabled=no add name=VLAN4 vlan-id=4 interface=ether1 disabled=no Add IP addresses to VLANs: /ip address add address=10.10.20.1/24 interface=VLAN2 add address=10.10.30.1/24 interface=VLAN3 add address=10.10.40.1/24 interface=VLAN4 RouterOS /32 and IP unnumbered addresses In RouterOS, to create a point-to-point tunnel with addresses you have to use the address with a network mask of '/32' that effectively brings you the same features as some vendors unnumbered IP address. There are 2 routers RouterA and RouterB where each is part of networks 10.22.0.0/24 and 10.23.0.0/24 respectively and to connect these routers using VLANs as a carrier with the following configuration: RouterA: /ip address add address=10.22.0.1/24 interface=ether1 /interface vlan add interface=ether2 vlan-id=1 name=vlan1 /ip address add address=10.22.0.1/32 interface=vlan1 network=10.23.0.1 /ip route add gateway=10.23.0.1 dst-address=10.23.0.0/24 RouterB: /ip address add address=10.23.0.1/24 interface=ether1 /interface vlan add interface=ether2 vlan-id=1 name=vlan1 /ip address add address=10.23.0.1/32 interface=vlan1 network=10.22.0.1 /ip route add gateway=10.22.0.1 dst-address=10.22.0.0/24

VXLAN Introduction Configuration options Forwarding table Configuration example Introduction Virtual eXtensible Local Area Network (VXLAN) is a tunneling protocol designed to solve the problem of limited VLAN IDs (4096) in IEEE 802.1Q, and it is described by IETF RFC 7348. With VXLAN the size of the identifier is expanded to 24 bits (16777216). It creates a Layer 2 overlay scheme on a Layer 3 network and the protocol runs over UDP. RouterOS VXLAN interface supports IPv4 or IPv6 (since version 7.6), but dual-stack is not supported. Only devices within the same VXLAN segment can communicate with each other. Each VXLAN segment is identified through a 24-bit segment ID, termed the VXLAN Network Identifier (VNI). Unlike most tunnels, a VXLAN is a 1-to-N network, not just point-to-point. VXLAN endpoints, which terminate VXLAN tunnels are known as VXLAN tunnel endpoints (VTEPs). RouterOS only supports statically configured remote VTEPs. When unicast traffic needs to be sent over VXLAN, a device can learn the IP address of the other endpoint dynamically in a manner similar to a learning bridge, and forward traffic only to the necessary VTEP. For traffic that needs to be flooded (broadcast, unknown-unicast, and multicast) to all VTEPs on the same segment, VXLAN can use multicast or unicast with head-end replication to send one replica for every remote VTEP. Configuration options This section describes the VXLAN interface and VTEP configuration options. Sub-menu: /interface vxlan Property Description allow-fast-path ( ; yes | no Default: ) yesWhether to allow processing. Fragmented and flooded packets over VXLAN Fast Path are redirected via a slow path. Fast Path is disabled for VXLAN interface that uses IPv6 VTEP version or VRF. The setting is available since RouterOS version 7.8. arp (disabled | enabled | local- proxy-arp | proxy-arp | ; reply-only Default: enabled )Address Resolution Protocol setting disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originating from matching IP address/MAC address combinations which are entered as static entries in the IP/ARP table. No dynamic entries will be automatically stored in the IP/ARP table. Therefore for communications to be successful, a valid static entry must already exist. arp-timeout (aut ; o | integer Default: ) autoHow long the ARP record is kept in the ARP table after no packets are received from IP. Value equals to the value of auto arp- inIP/Settings, default is the 30s. timeout comment (string ; Default: )Short description of the interface. disabled (yes | ; Default: ) no noChanges whether the interface is disabled. VXLAN creates a 50-byte overhead for IPv4 and a 70-byte overhead for IPv6. When configuring VXLAN, it is recommended to ensure that the size of the encapsulated Ethernet frame does not exceed the MTU of the underlying network, by configuring the MTU accordingly or by limiting the size of the Ethernet frames.

dont-fragment ( disabled | enabled | inherit ; Default: disabl )edThe Don't Fragment (DF) flag controls whether a packet can be broken into smaller packets, called fragments, before being sent over a network. When configuring VXLAN, this setting determines the presence of the DF flag on the outer IPv4 header and can control packet fragmentation if the encapsulated packet exceeds the outgoing interface MTU. This setting has three options: disabled - the DF flag is not set on the outer IPv4 header, which means that packets can be fragmented if they are too large to be sent over the outgoing interface. This also allows packet fragmentation when VXLAN uses IPv6 underlay. enabled - the DF flag is always set on the outer IPv4 header, which means that packets will not be fragmented and will be dropped if they exceed the outgoing interface's MTU. This also avoids packet fragmentation when VXLAN uses IPv6 underlay. inherit - The DF flag on the outer IPv4 header is based on the inner IPv4 DF flag. If the inner IPv4 header has the DF flag set, the outer IPv4 header will also have it set. If the packet exceeds the outgoing interface's MTU and DF is set, it will be dropped. If the inner packet is non-IP, the outer IPv4 header will not have the DF flag set and packets can be fragmented. If the inner packet is IPv6, the outer IPv4 header will always set the DF flag and packets cannot be fragmented. Note that when VXLAN uses IPv6 underlay, this setting does not have any effect and is treated the same as . disabled The setting is available since RouterOS version 7.8. group (IPv4 | ; Default: )IPv6When specified, a multicast group address can be used to forward broadcast, unknown-unicast, and multicast traffic between VTEPs. This property requires specifying the setting. The interface will use IGMP or MLD to join the specified multicast group, interface make sure to add the necessary PIM and IGMP/MDL configuration. When this property is set, the automatically vteps-ip-version gets updated to the used multicast IP version. interface ( ; name Default: ) Interface name used for multicast forwarding. This property requires specifying the setting.group local-address (I ; Pv4 | IPv6 Default: )Specifies the local source address for the VXLAN interface. If not set, one IP address of the egress interface will be selected as a source address for VXLAN packets. When the property is set, the automatically gets updated to the used local vteps-ip-version IP version. The setting is available since RouterOS version 7.7. mac-address (M AC; Default: )Static MAC address of the interface. A randomly generated MAC address will be assigned when not specified. max-fdb-size (in ; teger: 1 ..65535 Default: 4096 )Limits the maximum number of MAC addresses that VXLAN can store in the forwarding database (FDB). mtu ( ; integer Default: ) 1500For the maximum transmission unit, the VXLAN interface will set MTU to 1500 by default. The will be set automatically l2mtu according to the associated (subtracting 50 bytes corresponding to the VXLAN header). If no interface is specified, the interface l2 value of 65535 is used. The cannot be changed. mtu l2mtu name (; text Default: ) vxlan1Name of the interface. port (integer: 1 .. ; Default: 65535 ) 4789Used UDP port number. ttl (auto | ; integer: 0 ..255 Default: ) autoSpecifies the TTL value to use in outgoing packets. By default, the TTL is set to 64 when using the option. However, if VXLAN auto is using a multicast underlay network, the default TTL is set to 1. If the multicast network involves routing, you will need to increase the TTL to a higher value. vni (integer: 1.. ; 16777216 Default: ) VXLAN Network Identifier (VNI). vrf ( ; name Default: ) mainSet VRF for the VXLAN interface on which the VTEPs listen and make connections. VRF is not supported when using interface and multicast settings. The same UDP cannot be used in multiple routing tables at the same time. The setting is group port available since RouterOS version 7.7. vteps-ip-version ( ; ipv4 | ipv6 Default: ) ipv4Used IP protocol version for statically configured VTEPs. The RouterOS VXLAN interface does not support dual-stack, any configured remote VTEPs with the opposite IP version will be ignored. When multicast or properties are set, group local-address the automatically gets updated to the used IP version. The setting is available since RouterOS version 7.6. vteps-ip-version Sub-menu: /interface vxlan vteps Property Description

Bridging and Switching Case Studies IN THIS SECTION

/interface bridge add name=bridge1 frame-types=admit-only-vlan-tagged /interface bridge port add bridge=bridge1 interface=ether1 frame-types=admit-only-vlan-tagged add bridge=bridge1 interface=ether2 pvid=20 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether3 pvid=30 frame-types=admit-only-untagged-and-priority-tagged /interface bridge vlan add bridge=bridge1 tagged=ether1 vlan-ids=20 add bridge=bridge1 tagged=ether1 vlan-ids=30 add bridge=bridge1 tagged=ether1,bridge1 vlan-ids=99 /interface vlan add interface=bridge1 vlan-id=99 name=MGMT /ip address add address=192.168.99.1/24 interface=MGMT /interface bridge set bridge1 vlan-filtering=yes More detailed examples can be found . here CRS1xx/CRS2xx series switches /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 /interface ethernet switch ingress-vlan-translation add ports=ether2 customer-vid=0 new-customer-vid=20 add ports=ether3 customer-vid=0 new-customer-vid=30 /interface ethernet switch egress-vlan-tag add tagged-ports=ether1 vlan-id=20 add tagged-ports=ether1 vlan-id=30 add tagged-ports=ether1,switch1-cpu vlan-id=99 /interface ethernet switch vlan add ports=ether1,ether2 vlan-id=20 add ports=ether1,ether3 vlan-id=30 add ports=ether1,switch1-cpu vlan-id=99 /interface vlan add interface=bridge1 vlan-id=99 name=MGMT /ip address add address=192.168.99.1/24 interface=MGMT /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether1,ether2,ether3 More detailed examples can be found . here Other devices with a built-in switch chip RTL8367, 88E6393X, 88E6191X, MT7621 and MT7531 switch chips can use HW offloaded vlan-filtering since RouterOS v7. 88E6190, Bridge ports with set to or will be automatically added as frame-types admit-all admit-only-untagged-and-priority-tagged untagged ports for the VLAN.pvid

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 /interface ethernet switch vlan add ports=ether1,ether2 switch=switch1 vlan-id=20 add ports=ether1,ether3 switch=switch1 vlan-id=30 add ports=ether1,switch1-cpu switch=switch1 vlan-id=99 /interface vlan add interface=bridge1 vlan-id=99 name=MGMT /ip address add address=192.168.99.1/24 interface=MGMT /interface ethernet switch port set ether1 vlan-mode=secure vlan-header=add-if-missing set ether2 vlan-mode=secure vlan-header=always-strip default-vlan-id=20 set ether3 vlan-mode=secure vlan-header=always-strip default-vlan-id=30 set switch1-cpu vlan-header=leave-as-is vlan-mode=secure More detailed examples can be found . here Other devices without a built-in switch chip It is possible to do VLAN filtering using the CPU, there are multiple ways to do it, but it is highly recommended to use bridge VLAN filtering. Not all devices with a switch chip are capable of VLAN switching on a hardware level, check the supported features for each switch chip, the compatibility table can be found . If a device has support, then it is capable of VLAN switching using the built-in switch chip. here VLAN table You can check the device's switch chip either in the provided link or by using /interface ethernet switch print On QCA8337 and Atheros8327 switch chips, a default vlan-header=leave-as-is property should be used. The switch chip will determine which ports are access ports by using the default-vlan-id property. The default-vlan-id should only be used on access/hybrid ports to specify which VLAN the untagged ingress traffic is assigned to. This type of configuration should be used on RouterBOARD series devices, this includes RB4xx, RB9xx, RB2011, RB3011, hAP, hEX, cAP, and other devices. By default, the bridge interface is configured with protocol-mode set to . For some devices, this can disable hardware offloading because rstp specific switch chips do not support this feature. See the section with supported features. Bridge Hardware Offloading For devices that have multiple switch chips (for example, RB2011, RB3011, RB1100), each switch chip is only able to switch VLAN traffic between ports that are on the same switch chip, VLAN filtering will not work on a hardware level between ports that are on different switch chips, this means you should not add all ports to a single bridge if you are intending to use VLAN filtering using the switch chip, VLANs between switch chips will not get filtered. You can connect a single cable between both switch chips to work around this hardware limitation, another option is to use Bridge VLAN Filtering, but it disables hardware offloading (and lowers the total throughput).

/interface bridge add name=bridge1 frame-types=admit-only-vlan-tagged /interface bridge port add bridge=bridge1 interface=ether1 frame-types=admit-only-vlan-tagged add bridge=bridge1 interface=ether2 pvid=20 frame-types=admit-only-untagged-and-priority-tagged add bridge=bridge1 interface=ether3 pvid=30 frame-types=admit-only-untagged-and-priority-tagged /interface bridge vlan add bridge=bridge1 tagged=ether1 vlan-ids=20 add bridge=bridge1 tagged=ether1 vlan-ids=30 add bridge=bridge1 tagged=ether1,bridge1 vlan-ids=99 /interface vlan add interface=bridge1 vlan-id=99 name=MGMT /ip address add address=192.168.99.1/24 interface=MGMT /interface bridge set bridge1 vlan-filtering=yes More detailed examples can be found . here

Bridge IGMP/MLD snooping Introduction Configuration options Monitoring and troubleshooting Configuration examples Basic IGMP snooping configuration IGMP snooping configuration with VLANs Static MDB entries Introduction IGMP (Internet Group Management Protocol) and MLD (Multicast Listener Discovery) snooping allow the bridge to listen to IGMP/MLD communication and make forwarding decisions for multicast traffic based on the received information. By default, bridges are flooding multicast traffic to all bridge ports just like broadcast traffic, which might not always be the best scenario (e.g. for multicast video traffic or SDVoE applications). The IGMP/MLD snooping tries to solve the problem by forwarding the multicast traffic only to ports where clients are subscribed to, see an IGMP/MLD network concept below. RouterOS bridge can process IGMP v1/v2/v3 and MLD v1/v2 packets. The implemented bridge IGMP/MLD snooping is based on RFC4541, and IGMP/MLD protocols are specified on RFC1112 (IGMPv1) RFC2236 (IGMPv2), RFC3376 (IGMPv3), RFC2710 (MLDv1), RFC3810 (MLDv2). Source-specific multicast forwarding is not supported for IGMP v3 and MLD v2.

The bridge will process the IGMP/MLD messages only when is enabled. Additionally, the bridge should have an active IPv6 address to igmp-snooping process MLD packets. At first, the bridge does not restrict the multicast traffic and all multicast packets get flooded. Once IGMP/MLD querier is detected by receiving an IGMP/MLD query message (the query message can be received by an external multicast router or locally by bridge interface with enabled mul ), only then the bridge will start to restrict unknown IP multicast traffic and forward the known multicast from the multicast database ticast-querier (MDB). The IGMP and MLD querier detection is independent, which means that detecting only IGMP querier will not affect IPv6 multicast forwarding and vice versa. The querier detection also does not restrict the forwarding of non-IP and link-local multicast groups, like 224.0.0.0/24 and ff02::1. Configuration options This section describes the IGMP and MLD snooping bridge configuration options. Sub-menu: /interface bridge Property Description CRS3xx series devices with Marvell-98DX3236, Marvell-98DX224S or Marvell-98DX226S switch chips are not able to distinguish non-IP/IPv4 /IPv6 multicast packets once IGMP or MLD querier is detected. It means that the switch will stop forwarding all unknown non-IP/IPv4/IPv6 multicast traffic when the querier is detected. This does not apply to certain link-local multicast address ranges, like 224.0.0.0/24 or ff02::1.

igmp-snooping (yes ; Default: ) | no noEnables IGMP and MLD snooping. igmp-version ( ; 2 | 3 Default: ) 2Selects the IGMP version in which IGMP membership queries will be generated when the bridge interface is acting as an IGMP querier. This property only has an effect when and is set to . igmp-snooping multicast-querier yes last-member-interval ( ; Default: ) time 1sWhen the last client on the bridge port unsubscribes to a multicast group and the bridge is acting as an active querier, the bridge will send group-specific IGMP/MLD query, to make sure that no other client is still subscribed. The setting changes the response time for these queries. In case no membership reports are received in a certain time period ( * last-member-interval last- ), the multicast group is removed from the multicast database (MDB). member-query-count If the bridge port is configured with , the multicast group is removed right away without sending any queries. fast-leave This property only has an effect when and is set to . igmp-snooping multicast-querier yes last-member-query- count (integer: 0.. ; 4294967295 Default: ) 2How many times should pass until the IGMP/MLD snooping bridge stops forwarding a certain last-member-interval multicast stream. This property only has an effect when and is set to . igmp-snooping multicast-querier yes membership-interval ( ; Default:time 4m20s )The amount of time after an entry in the Multicast Database (MDB) is removed if no IGMP/MLD membership reports are received on a bridge port. This property only has an effect when is set to . igmp-snooping yes mld-version ( ; 1 | 2 Default: ) 1Selects the MLD version in which MLD membership queries will be generated, when the bridge interface is acting as an MLD querier. This property only has an effect when the bridge has an active IPv6 address, and igmp-snooping multicast- is set to . querier yes multicast-querier (ye ; Default: ) s | no noMulticast querier generates periodic IGMP/MLD general membership queries to which all IGMP/MLD capable devices respond with an IGMP/MLD membership report, usually a PIM (multicast) router or IGMP proxy generates these queries. By using this property you can make an IGMP/MLD snooping enabled bridge to generate IGMP/MLD general membership queries. This property should be used whenever there is no active querier (PIM router or IGMP proxy) in a Layer2 network. Without a multicast querier in a Layer2 network, the Multicast Database (MDB) is not being updated, the learned entries will timeout and IGMP/MLD snooping will not function properly. Only untagged IGMP/MLD general membership queries are generated, IGMP queries are sent with IPv4 0.0.0.0 source address, MLD queries are sent with IPv6 link-local address of the bridge interface. The bridge will not send queries if an external IGMP /MLD querier is detected (see the monitoring values and ). igmp-querier mld-querier This property only has an effect when is set to . igmp-snooping yes multicast-router (dis abled | permanent | ; temporary-query Default: temporary- ) queryA multicast router port is a port where a multicast router or querier is connected. On this port, unregistered multicast streams and IGMP/MLD membership reports will be sent. This setting changes the state of the multicast router for a bridge interface itself. This property can be used to send IGMP/MLD membership reports and multicast traffic to the bridge interface for further multicast routing or proxying. This property only has an effect when igmp-snooping is set to yes. disabled - disabled multicast router state on the bridge interface. Unregistered multicast streams and IGMP/MLD membership reports are not sent to the bridge interface regardless of what is configured on the bridge interface. permanent - enabled multicast router state on the bridge interface. Unregistered multicast streams and IGMP/MLD membership reports are sent to the bridge interface itself regardless of what is configured on the bridge interface. temporary-query - automatically detect multicast router state on the bridge interface using IGMP/MLD queries. querier-interval (time ; Default: ) 4m15sChanges the timeout period for detected querier and multicast-router ports. This property only has an effect when igmp- is set to . snooping yes query-interval ( ; time Default: ) 2m5sChanges the interval on how often IGMP/MLD general membership queries are sent out when the bridge interface is acting as an IGMP/MLD querier. The interval takes place when the last startup query is sent. This property only has an effect when igmp- and is set to . snooping multicast-querier yes query-response- interval ( ; time Default: ) 10sThe setting changes the response time for general IGMP/MLD queries when the bridge is acting as an IGMP/MLD querier. This property only has an effect when and is set to . igmp-snooping multicast-querier yes

startup-query-count ( integer: 0.. ; 4294967295 Default: ) 2Specifies how many times general IGMP/MLD queries must be sent when the bridge interface is enabled or active querier timeouts. This property only has an effect when and is set to . igmp-snooping multicast-querier yes startup-query- interval ( ; time Default: ) 31s250msSpecifies the interval between startup general IGMP/MLD queries. This property only has an effect when and igmp-snooping m is set to . ulticast-querier yes Sub-menu: port /interface bridge Property Description fast-leave ( ; yes | no Default: ) noEnables IGMP/MLD fast leave feature on the bridge port. The bridge will stop forwarding multicast traffic to a bridge port when an IGMP/MLD leave message is received. This property only has an effect when is set to . igmp-snooping yes multicast-router (disa bled | permanent | ; temporary-query Default: temporary- ) queryA multicast router port is a port where a multicast router or querier is connected. On this port, unregistered multicast streams and IGMP/MLD membership reports will be sent. This setting changes the state of the multicast router for bridge ports. This property can be used to send IGMP/MLD membership reports and multicast streams to certain bridge ports for further multicast routing or proxying. This property only has an effect when igmp-snooping is set to yes. disabled - disabled multicast router state on the bridge port. Unregistered multicast streams and IGMP/MLD membership reports are not sent to the bridge port regardless of what is connected to it. permanent - enabled multicast router state on the bridge port. Unregistered multicast and IGMP/MLD membership reports are sent to the bridge port regardless of what is connected to it. temporary-query - automatically detect multicast router state on the bridge port using IGMP/MLD queries. unknown-multicast- flood ( ; yes | no Default: ) yesChanges the multicast flood option on the bridge port, only controls the egress traffic. When enabled, the bridge allows flooding multicast packets to the specified bridge port, but when disabled, the bridge restricts multicast traffic from being flooded to the specified bridge port. The setting affects all multicast traffic, this includes non-IP, IPv4, IPv6, and the link-local multicast ranges (e.g. 224.0.0.0/24 and ). ff02::1 Note that when is enabled and IGMP/MLD querier is detected, the bridge will automatically restrict unknown igmp-snooping IP multicast from being flooded, so the setting is not mandatory for IGMP/MLD snooping setups. When using this setting together with , the only multicast traffic that is allowed on the bridge port is the known igmp-snooping multicast from the MDB table. Sub-menu: /interface bridge mdb Property Description bridge ( ; name Default: )The bridge interface to which the MDB entry is going to be assigned. disabled ( ; yes | no Default: )noDisables or enables static MDB entry. group (ipv4 | ipv6 ; Default: address )The IPv4 or IPv6 multicast address. Static entries for link-local multicast groups 224.0.0.0/24 and ff02::1 cannot be created, as these packets are always flooded on all ports and VLANs. ports ( ; name Default: )The list of bridge ports to which the multicast group will be forwarded. vid (integer: 1.. ; Default: ) 4094The VLAN ID on which the MDB entry will be created, only applies when is enabled. When the VLAN ID is not vlan-filtering specified, the entry will work in shared-VLAN mode and dynamically apply on all defined VLAN IDs for particular ports. Monitoring and troubleshooting This section describes the IGMP/MLD snooping bridge monitoring and troubleshooting options. To monitor learned multicast database (MDB) entries, use the command.print

First, create a bridge interface with enabled IGMP snooping. In this example, there is no active IGMP querier (no multicast router or proxy), so a local IGMP querier must be enabled on the same bridge. This can be done with a setting. If there is no active IGMP querier in the LAN, multicast-querier the unregistered IP multicast will be flooded and multicast entries will always timeout from the multicast database. /interface bridge add igmp-snooping=yes multicast-querier=yes name=bridge1 Then add the necessary interfaces as bridge ports. /interface bridge port add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 add bridge=bridge1 interface=ether4 add bridge=bridge1 interface=ether5 The basic IGMP snooping configuration is finished. Use " command to monitor the active multicast groups. If " /interface bridge mdb print necessary, you can configure an IP address and on the same bridge interface. DHCP server IGMP snooping configuration with VLANs The second example adds some complexity. There are two IGMP snooping bridges and we need to isolate the multicast traffic on a different VLAN. See a network scheme below.

First, create a bridge on both devices and add the needed interfaces as bridge ports. To change untagged VLAN for a bridge port, use the setting. pvid The Bridge1 will be acting as an IGMP querier. Below are the configuration commands for the Bridge1: /interface bridge add igmp-snooping=yes multicast-querier=yes name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 pvid=10 add bridge=bridge1 interface=ether3 pvid=10 add bridge=bridge1 interface=ether4 pvid=10 add bridge=bridge1 interface=ether5 pvid=20 add bridge=bridge1 interface=sfp-sfpplus1 pvid=10 And for the Bridge2: /interface bridge add igmp-snooping=yes name=bridge1 /interface bridge port add bridge=bridge1 interface=ether3 pvid=10 add bridge=bridge1 interface=ether4 pvid=10 add bridge=bridge1 interface=ether5 pvid=20 add bridge=bridge1 interface=sfp-sfpplus1 pvid=10 Make sure to configure for devices. It is essential when configuring a bridge with VLAN filtering. In this example, a VLAN 99 interface management access with an IP address is added to the bridge. This VLAN will be allowed on the tagged sfp-sfpplus1 port. Below are configuration commands for the Bridge1: Bridge IGMP querier implementation can only send untagged IGMP queries. In case tagged IGMP queries should be sent or IGMP queries should be generated in multiple VLANs, it is possible to install a , add a VLAN interface and configure a on multicast package PIM interface VLAN. The PIM interface can be used as an IGMP querier.

/interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.1/24 interface=MGMT network=192.168.99.0 /interface bridge vlan add bridge=bridge1 tagged=bridge1,sfp-sfpplus1 vlan-ids=99 And for the Bridge2: /interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.2/24 interface=MGMT network=192.168.99.0 /interface bridge vlan add bridge=bridge1 tagged=bridge1,sfp-sfpplus1 vlan-ids=99 Add bridge VLAN entries and specify tagged and untagged ports. The VLAN 99 entry was already created when configuring management access, only VLAN 10 and VLAN 20 should be added now. Below are the configuration commands for the Bridge1: /interface bridge vlan add bridge=bridge1 untagged=ether2,ether3,ether4,sfp-sfpplus1 vlan-ids=10 add bridge=bridge1 tagged=sfp-sfpplus1 untagged=ether5 vlan-ids=20 And for the Bridge2: /interface bridge vlan add bridge=bridge1 untagged=ether3,ether4,sfp-sfpplus1 vlan-ids=10 add bridge=bridge1 tagged=sfp-sfpplus1 untagged=ether5 vlan-ids=20 Last, enable VLAN filtering. Below is the configuration command for Bridge1 and Bridge2: /interface bridge set [find name=bridge1] vlan-filtering=yes At this point, VLANs and IGMP snooping are configured and devices should be able to communicate through ports. However, it is recommended to go even a step further and apply some additional filtering options. Enable ingress-filtering on bridge ports. Below are the and frame-types configuration commands for the Bridge1: /interface bridge port set [find interface=ether2] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=ether3] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=ether4] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=ether5] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=sfp-sfpplus1] ingress-filtering=yes And for the Bridge2: /interface bridge port set [find interface=ether3] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=ether4] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=ether5] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged set [find interface=sfp-sfpplus1] ingress-filtering=yes Static MDB entries Since RouterOS version 7.7, it is possible to create static MDB entries for IPv4 and IPv6 multicast groups. For example, to create a static MDB entry for multicast group 229.10.10.10 on ports ether2 and ether3 on VLAN 10, use the command below:

Bridge VLAN Table Summary Background Trunk/Access port setup VLAN Tunnelling setup Tag Stacking Summary It is possible to use a bridge to filter out VLANs in your network. To achieve this, you should use the feature. This feature should be Bridge VLAN Filtering used instead of many known VLAN misconfigurations that are most likely causing you either performance issues or connectivity issues, you can read about one of the most popular misconfigurations in the section. The most important part of the bridge VLAN VLAN in a bridge with a physical interface filtering feature is the bridge VLAN table, which specifies which VLANs are allowed on each port, but configuring it might get quite complex if you are trying to make a more advanced setup, for generic setups you should be able to configure your device using the example, but the Trunk and Access ports purpose of this guide is to provide in-depth explanation and point out some of the behavior characteristics when using bridge VLAN Filtering. Background Before explaining bridge VLAN filtering in-depth, you should understand a few basic concepts that are involved in bridge VLAN filtering. Tagged/Untagged - Under you can specify an entry that contains tagged anduntagged ports. In general, /interface bridge vlan menu, tagged ports should be your trunk ports and untagged ports should be your access ports. By specifying a tagged port the bridge will always set a VLAN tag for packets that are being sent out through this port (egress). By specifying an untagged port the bridge will always remove the VLAN tag from egress packets. VLAN-ids - Under you can specify an entry in which certain VLANs are allowed on specific ports. The VLAN /interface bridge vlan menu, ID is checked on egress ports. If the packet contains a VLAN ID that does not exist in the bridge VLAN table for the egress port, then the packet is dropped before it gets sent out. PVID - The Port VLAN ID is used for access ports to tag all ingress traffic with a specific VLAN ID. A dynamic entry is added in the bridge VLAN table for every PVID used, the port is automatically added as an untagged port. Ingress filtering - By default, VLANs that don't exist in the bridge VLAN table are dropped before they are sent out (egress), but this property allows you to drop the packets when they are received (ingress). Management access - The bridge is supposed to simply forward packets between bridge ports and it would seem to other devices that there is simply a wire between them. With bridge VLAN filtering you can limit which packets are allowed to access the device that has the bridge configured, the most common practice is to allow access to the device only by using a very specific VLAN ID, but there are other ways you can grant access to the device. Management access is a great way to add another layer of security when accessing the device through a bridge port, this type of access is sometimes called the management port. For devices that support , It is also related VLAN Filtering with hardware offloading to the CPU port of a bridge. CPU port - Every device with a switch chip has a special purpose port called CPU port and it is used to communicate with the device's CPU. For devices that support VLAN filtering with hardware offloading, this port is the bridge interface itself. This port is mostly used to create management access but can be used for other purposes, for example, to route traffic between VLANs, to mark packets, and to apply queues. frame-type - You can filter out packets whether they have a VLAN tag or not, this is useful to add an extra layer of security for your bridge ports. EtherType - By default, a VLAN aware bridge will filter VLANs by checking the C-TAG (0x8100), all other VLAN tags are considered as untagged packets (without a VLAN tag). The selected EtherType will be used for VLAN filtering and VLAN tagging/untagging. VLAN Tunnelling - If the EtherType of the packet does not match with the EtherType configured for the bridge, then ingress packets are considered as untagged packets, this behavior gives a possibility to encapsulate VLANs into another, different VLAN. This also gives a possibility to divert specific traffic through different devices in your network. Tag stacking - If a packet has a VLAN tag that matches the EtherType, then the packet is considered as a tagged packet, but you can force another VLAN tag regardless of the packet's content. By setting on a bridge port, you will add another VLAN tag with the PV tag-stacking=yes IDvalue on top of any other tag for all ingress packets. Trunk/Access port setup Below you can find a very common diagram for a very typical type of setup that consists of a trunk port and multiple access ports:

This setup is very common since it gives the possibility to divide your network into multiple segments while using a single switch and maybe a single router, such a requirement is very common for companies that want to separate multiple departments. With VLANs you can use different DHCP Servers, which can give out an IP address from a different subnet based on the VLAN ID, which makes creating Firewall rules and QoS a lot easier. In such a setup you would connect some generic devices like Desktop PCs to and , these can be considered as workstations and they ether2 ether3 generally only use untagged traffic (it is possible to force a VLAN tag for all traffic that is sent out a generic workstation, though it is not very common). To isolate some workstations from other workstations you must add a VLAN tag to all packets that enter or , but to decide what VLAN ID should ether2 ether3 the packet get, you need to use a concept called . In this concept, packets get a VLAN tag with a VLAN ID based on the bridge port to Port-based VLANs which the device is connected. For example, in this setup the device on will get a VLAN tag with and the device on will get a VLAN ether2 VLAN20 ether3 tag with , this concept is very scalable as long as you have enough bridge ports. This should give you the understanding that traffic between the VLAN30 bridge and devices behind is untagged (since there is no VLAN tag, hence the name). ether2/ether3 When we have determined our untagged ports, we can now determine our tagged ports. Tagged ports are going to be the trunk ports (the port, that carries multiple VLANs) and usually, this port is connected to a router or another switch/bridge, you can have multiple trunk ports as well. Tagged ports are always carrying packets with a VLAN tag (hence the name) and you must specify the tagged ports for each VLAN ID you want this port to forward. It is ALWAYS possible that a port is a tagged port for one VLAN ID and the same port is an untagged port for a different VLAN ID, but this is for a different type of setup (Hybrid port setup). A special note must be added for the PVID property. This property should be used on access ports, but it can be used for trunk ports as well (in Hybrid port setup). By using the PVID property you are adding a new VLAN tag with a VLAN ID that is specified in the PVID to all packets that are UNTAGGED received on that specific bridge port. The PVID does not have any effect on tagged packets, this means that, for example, if a packet with a VLAN tag of VL is received on that has , then the VLAN tag is changed and forwarding will depend on the entries from the bridge VLAN table. AN40 ether2 PVID=20 NOT To configure the trunk/access port setup, you need to first create a bridge: /interface bridge add name=bridge1 Add the bridge ports and specify PVID for each access port: /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 pvid=20 add bridge=bridge1 interface=ether3 pvid=30 Don't enable VLAN filtering yet as you might get locked out from the device because of the lack of management access, which is configured at the end.

Add appropriate entries in the bridge VLAN table: /interface bridge vlan add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=20 add bridge=bridge1 tagged=ether1 untagged=ether3 vlan-ids=30 You might think that you could simplify this entry with a single entry, similar to this: /interface bridge vlan add bridge=bridge1 tagged=ether1 untagged=ether2,ether3 vlan-ids=20,30 Do use multiple VLAN IDs on access ports. This will unintentionally allow both and on both access ports. In the example above, NOT VLAN20 VLAN30 eth is supposed to set a VLAN tag for all ingress packets to use (since ), but this does not limit the allowed VLANs on this port when er3 VLAN30 PVID=30 VLANs are being sent out through this port. The bridge VLAN table is responsible for deciding whether a VLAN is allowed to be sent through a specific port or not. The entry above specifies that both and are allowed to be sent out through and and on top of that the entry VLAN20 VLAN30 ether2 ether3 specifies that packets should be sent out without a VLAN tag (packets are sent out as untagged packets). As a result, you may create a packet leak from VLANs to ports that are not even supposed to receive such traffic, see the image below. A misconfigured VLAN table allows VLAN20 to be sent through ether3, it will also allow VLAN30 through ether2 It is not necessary to add a bridge port as an untagged port, because each bridge port is added as an untagged port dynamically with a VLAN ID that is specified in the PVID property. This is because of a feature that automatically will add an appropriate entry in the bridge VLAN table for convenience and PVID performance reasons, this feature does have some caveats that you must be aware of. All ports that have the same will be added to a single entry for also the appropriate VLAN ID as untagged ports, but note that the Bridge interface has a VLAN ID. For testing purposes, we are going to enable VLAN filtering, but note that it might make you lose access to the device since it does not have management access configured yet (we will configure it later). It is always recommended to configure VLAN filtering while using a serial console, though you can also configure a device through a port, that is not added to a bridge. Make sure you are using a serial console or connected through a different port (that is not in a bridge) and enable VLAN filtering: /interface bridge set bridge1 vlan-filtering=yes PVID has no effect until VLAN filtering is enabled. Don't use more than one VLAN ID specified in a bridge VLAN table entry for access ports, you should only specify multiple VLAN IDs for trunk ports.

/interface bridge set [find name=bridge1] pvid=30 /interface bridge vlan set [find vlan-ids=30] untagged=bridge1,ether3 Allowing access to the device using untagged traffic is not considered a good security practice, a much better way is to allow access to the device using a very specific VLAN sometimes called the management VLAN, in our case, this is going to be . This adds a significant layer of security since an VLAN99 attacker must guess the VLAN ID that is being used for management purposes and then guess the login credentials, on top of this you can even add another layer of security by allowing access to the device using only certain IP addresses. The purpose of this guide is to provide an in-depth explanation, for that reason, we are adding a level of complexity to our setup to understand some possible caveats that you must take into account. We are going to allow access from an access port using tagged traffic (illustrated in the image below). To allow access to the device using from , we must VLAN99 ether3 add a proper entry in the bridge VLAN table. Additionally, a network device connected to ether3 must support VLAN tagging. /interface bridge vlan add bridge=bridge1 tagged=bridge1,ether3 vlan-ids=99 Management access using tagged traffic through an access port (which makes it a hybrid port) But you might notice that access using VLAN99 does not work at this point, this is because you need a VLAN interface that listens for tagged traffic, you can simply create this interface for the appropriate VLAN ID and you can set an IP address for the interface as well: /interface vlan add interface=bridge1 name=VLAN99 vlan-id=99 /ip address add address=192.168.99.2/24 interface=VLAN99 You can use the feature that dynamically adds untagged ports with the same PVID value, you can simply change the PVID to match between et and . her3 bridge1 If PVID for ether1 and bridge1 matches (by default, it does match with 1), then access to the device is allowed using untagged traffic from ether1 because of the feature that dynamically adds untagged ports to the bridge VLAN table. Our access port ( ) at this point expects tagged and untagged traffic at the same time, such a port is called a . ether3 hybrid port

Trunk/access port setup with and without ingress filtering. Ingress filtering can prevent unwanted traffic from being forwarded. Note that ether1 is not allowed to carry VLAN99 in the bridge VLAN table. The ingress-filtering can be used on the CPU port (bridge) as well, this can be used to prevent some possible attack vectors and limit the allowed VLANs that can access the CPU. It is better to drop a packet on an ingress port, rather than on an egress port, this reduces the CPU load, which is quite crucial when you are using hardware offloading with bridge VLAN filtering. Always try to use wherever it is possible, it adds a significant layer of security. ingress-filtering The property only affects ingress traffic, but affects both egress and ingress traffic. ingress-filtering frame-type

Even though you can limit the allowed VLANs and packet types on a port, it is never a good security practice to allow access to a device through access ports since an attacker could sniff packets and extract the management VLAN's ID, you should only allow access to the device from the trunk port ( ether1 ) since trunk ports usually have better physical security, you should remove the previous entry and allow access to the device through the port that is connected to your router (illustrated in the image below): /interface bridge vlan add bridge=bridge1 tagged=bridge1,ether1 vlan-ids=99 VLAN Tunnelling setup In some cases, you might want to forward already tagged traffic through certain switches. This is a quite common setup for backbone infrastructures since it provides a possibility to encapsulate traffic from, for example, your edge routers and seamlessly forward it over your backbone to another edge router. Below you can find an example of a VLAN tunneling topology: Provider bridge topology SVID stands for Service VID, indicating the tag type along with the VID.

There are two possible ways to achieve this, one is the standardized IEEE 802.1ad way, and the other way is using , we will first review the Tag stacking standardized way since the same principles apply to both ways and only a couple of parameters must be changed to use the other method. The way VLAN tunneling works is that the bridge checks if the outer VLAN tag is using the same VLAN tag as specified as ether-type. If the VLAN tag matches, the packet is considered as a tagged packet, otherwise, it is considered as an untagged packet. Theether-type property allows you to select the following EtherTypes for the VLAN tag: 0x88a8 - IEEE 802.1ad, Service Tag 0x8100 - IEEE 802.1Q, Customer VLAN (regular VLAN tag) 0x9100 - Unofficial tag type (rarely used) To properly configure bridge VLAN filtering, you must understand how the bridge distinguishes between tagged and untagged packets. As mentioned before, the bridge will check if EtherType matches with the outer VLAN tag in the packet. For example, consider the following packet: FFFFFFFFFFFF 6C3B6B7C413E 8100 6063 9999 ---------------------------------------- DST-MAC = FFFFFFFFFFFF SRC-MAC = 6C3B6B7C413E Outer EtherType = 8100 (IEEE 802.1Q VLAN tag) VLAN priority = 6 VLAN ID = 99 (HEX = 63) Inner EtherType = 9999 Let us assume that we have set , in this case, the packet above will be considered untagged since the bridge is looking for a ether-type=0x88a8 different VLAN tag. Lets now consider the following packet: FFFFFFFFFFFF 6C3B6B7C413E 88A8 6063 8100 5062 9999 ---------------------------------------- DST-MAC = FFFFFFFFFFFF SRC-MAC = 6C3B6B7C413E Outer EtherType = 88A8 (IEEE 802.1ad VLAN tag) VLAN priority = 6 VLAN ID = 99 (HEX = 63) Inner EtherType 1 = 8100 (IEEE 802.1Q VLAN tag) VLAN priority = 5 VLAN ID = 98 (HEX = 62) Innter EtherType 2 = 9999 This time let us assume that we have set , in this case, the packet above is considered as untagged as well since the outer tag is ether-type=0x8100 using an IEEE 802.1ad VLAN tag. The same principles apply to other VLAN related functions, for example, the property will add a new VLAN tag on PVID access ports and the VLAN tag will be using the EtherType specified in ether-type. Both and are using the same configuration: SW1 SW2 /interface bridge add name=bridge1 vlan-filtering=yes ether-type=0x88a8 /interface bridge port add interface=ether1 bridge=bridge1 pvid=200 add interface=ether2 bridge=bridge1 pvid=300 add interface=ether3 bridge=bridge1 /interface bridge vlan add bridge=bridge1 tagged=ether3 untagged=ether1 vlan-ids=200 add bridge=bridge1 tagged=ether3 untagged=ether2 vlan-ids=300 To fully understand how to configure VLAN tunneling properly, you should first read the Trunk/Access port setup section before proceeding any further. The bridge checks only the outer tag (closest to the MAC address), any other tag is ignored anywhere in a bridge configuration. The bridge is not aware of the packet contents, even though there might be another VLAN tag, only the first VLAN tag is checked.

In this example, we are assuming that all routers are passing traffic that is using a regular/customer VLAN tag. Such traffic on switches will be considered as untagged traffic based on the principle described above. Switches will encapsulate this traffic using a Service VLAN tag (the outer 802.1ad tag) and traffic between and will be considered as tagged. Before traffic reaches its destination, the switches will decapsulate the outer tag and forward SW1 SW2 the original 802.1Q tagged frame. See a packet example below: A packet example before and after 802.1ad VLAN encapsulation In case you want to create management access from, let's say, to the device and want to use , then you would use such commands: ether3 VLAN99 /interface bridge vlan add bridge=bridge1 tagged=bridge1,ether3 vlan-ids=99 /interface vlan add interface=bridge1 name=VLAN99 use-service-tag=yes vlan-id=99 /ip address add address=192.168.99.2/24 interface=VLAN99 As you may notice, the only difference is that the VLAN interface is using , this sets the VLAN interface to listen to IEEE 802.1ad use-service-tag=yes VLAN tags. This will require you to use the IEEE 802.1ad VLAN tag to access the device using the management VLAN - you will not be able to connect to the device using a regular VLAN tag while bridge VLAN filtering is enabled. The ether-type is set globally and will affect all bridge VLAN filtering functions. Tag Stacking In the VLAN Tunnelling setup, we were adding a new VLAN tag that was different from the VLAN tag, but it is possible to add a new VLAN tag regardless of the packet contents. The difference between the regular VLAN tunneling setup is that the bridge does not check if the packet is tagged or untagged, it assumes that all packets that are received on a specific port are all untagged packets and will add a new VLAN tag regardless of whether a VLAN tag is present or not, this is called since it "stacks" VLAN tags on top of the previous tag, regardless of the VLAN tag type. This is a very common Tag Stacking setup for networks that do not support the IEEE 802.1ad standard, but still want to encapsulate VLAN traffic into a new VLAN. The VLAN tag that is going to be added depends on and . For example, if you have and on a port, ether-type PVID ether-type=0x8100 PVID=200 then the bridge will add a new IEEE 802.1Q VLAN tag right on top of any other tag (if such are present). The same VLAN filtering principles still apply, you have to determine which ports are going to be your trunk ports and mark them as tagged ports, determine your access ports, and add them as untagged ports. To explain how VLAN tagging and untagging works with tag stacking, let us use the same network topology as before: All principles that apply to the regular trunk/access port setup using IEEE 802.1Q also apply to VLAN tunneling setups, make sure you are limiting VLANs and packet type properly using the bridge VLAN table and ingress filtering. Devices with switch chip Marvell-98DX3257 (e.g. CRS354 series) do not support VLAN filtering on 1Gbps Ethernet interfaces for other VLAN types ( and ). 0x88a8 0x9100

What we want to achieve is that regardless of what is being received on and , a new VLAN tag will be added to encapsulate the traffic that is ether2 ether3 coming from those ports. forces a new VLAN tag, so we can use this property to achieve our desired setup. We are going to be using the Tag-stacking same configuration as in the Trunk/Access port setup, but with enabled on the access ports: tag-stacking /interface bridge add name=bridge1 vlan-filtering=yes ether-type=0x8100 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 tag-stacking=yes pvid=20 add bridge=bridge1 interface=ether3 tag-stacking=yes pvid=30 /interface bridge vlan add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=20 add bridge=bridge1 tagged=ether1 untagged=ether3 vlan-ids=30 Let us assume that the devices behind and are sending tagged traffic. With this configuration, packets will get encapsulated ether2 ether3 VLAN40 ALL with a new VLAN tag, but you must make sure that you have added the VLAN ID from the outer tag to the bridge VLAN table. The is not added to VLAN40 the bridge VLAN table since it is the inner tag and it is not checked, we are only concerned about the outer tag, which is either or dependi VLAN20 VLAN30 ng on the port. Similar to other setups, the bridge VLAN table is going to be used to determine if the VLAN tag needs to be removed or not. For example, receives ether1 tagged packets, the bridge checks that is allowed to carry so it is about to send it out through , but it also checks the bridge VLAN20 ether2 VLAN20 ether2 VLAN table whether the VLAN tag should be removed and since is marked as an untagged port, then the bridge will forward these packets from ether2 ethe to without the VLAN tag. r1 ether2 VLAN20 From the access port perspective, the same principles as in the Trunk/Access port setup apply. All packets that are received on will get a new VLAN ether2 tag with the VLAN ID that is specified in PVID, in this case, a new VLAN tag will be added with and this VLAN will be subjected to VLAN filtering. VLAN20 See a packet example below: The added VLAN tag will use the specified . The selected EtherType will also be used for VLAN filtering. Only the outer tag is ether-type checked, but with tag-stacking in place, the tag checking is skipped and assumes that a new tag must be added either way.

A packet example before and after tag stacking

Controller Bridge and Port Extender Summary Limitations Quick setup Discovery and control protocols Packet flow Controller Bridge settings and monitoring Port Extender settings Configuration examples Basic CB and PE configuration Trunk and Access ports Cascading multiple Port Extenders and using bonding interface Configuration modification and removal Summary Controller Bridge (CB) and Port Extender (PE) is an IEEE 802.1BR standard implementation in RouterOS for CRS3xx series switches. It allows virtually extending the CB ports with a PE device and manage these extended interfaces from a single controlling device. Such configuration provides a simplified network topology, flexibility, increased port density and ease of manageability. An example of Controller Bridge and Port Extender topology can be seen below.

The Controller Bridge establishes communication with the Port Extender through a . Similarly, the Port Extender will communicate with cascade port the Controller Bridge only through an . On a PE device, control ports must be configured and only one port (closest to the CB) will act as upstream port an upstream port, other control ports can act as a backup for upstream port or even cascade port for switches connected in series (e.g. Port Extender 2 and 3 in the image above). Cascade and upstream ports are used to transmit and receive control and network traffic. are interfaces Extended ports that are controlled by the CB device and they are typically connected to the end hosts. Extended ports only transmit and receive network traffic. See supported features for each switch model below. Model Controller Bridge Port Extender netPower 15FR (CRS318-1Fi-15Fr-2S) - + netPower 16P (CRS318-16P-2S+) - + CRS310-1G-5S-4S+ (netFiber 9/IN) - + CRS326-24G-2S+ (RM/IN) - + CRS328-24P-4S+ - + CRS328-4C-20S-4S+ - + CRS305-1G-4S+ - + CRS309-1G-8S+ + + CRS317-1G-16S+ + + CRS312-4C+8XG + + CRS326-24S+2Q+ + + CRS354-48G-4S+2Q+ + + CRS354-48P-4S+2Q+ + + Limitations Although controller allows to configure port extender interfaces, some bridging and switching features cannot be used or will not work properly. Below are the most common controller and extender limitations. The list might change . along upcoming RouterOS releases Feature Support Bonding for cascade and upstream ports + Bridge VLAN filtering + Bonding for extended ports - Dot1x authenticator (server) - Ingress and egress rate - Mirroring - Port ingress VLAN filtering - Port isolation - Storm control - Switch rules (ACL) - L3HW offloading - MLAG -

Quick setup In this example, we will create a Controlling Bridge (e.g. a CRS317-1G-16S+ switch) that will connect to a single Port Extender (e.g. a CRS326-24G- 2S+ switch) through an SFP+1 interface. First, configure a bridge with enabled VLAN filtering on a CB device: /interface bridge add name=bridge1 vlan-filtering=yes On the same device, configure a port that is connected to the PE device and will act as cascade port: /interface bridge port-controller set bridge=bridge1 cascade-ports=sfp-sfpplus1 switch=switch1 Last, on a PE device, simply configure a control port, which will be selected as an upstream port: /interface bridge port-extender set control-ports=sfp-sfpplus1 switch=switch1 Once PE and CB devices are connected, all interfaces that are on the same switch group (except for control ports) will be extended and can be further configured on a CB device. An automatic bridge port configuration will be applied on the CB device which adds all extended ports in a single bridge, this configuration can be modified afterward. Discovery and control protocols Before frame forwarding on extended ports is possible, Controlling Bridge and Port Extender must discover each other and exchange with essential information. CB and PE enabled devices are using a neighbor discovery protocol LLDP with specific Port Extension TLV. This allows CB and PE devices to advertise their support on cascade and control ports. Once LLDP messages are exchanged between CB and PE, a Control and Status Protocol (CSP) over an Edge Control Protocol (ECP) will initiate. The CSP is used between CB and PE to assert control and receive status information from the associated PE - it assigns unique IDs for extended ports, controls data-path settings (e.g. port VLAN membership) and sends port status information (e.g. interface stats, PoE-out monitoring). The ECP provides a reliable and sequenced frame delivery (encoded with EtherType 0x8940). Packet flow In order to exclude some port from being extended (e.g. for out-of-band management purposes), additionally, configure excluded-ports property. Make sure not to include the and in any routing or bridging configurations. These ports are cascade-ports control-ports recommended only for a CB and PE usage. CB and PE configuration can override the neighbor discovery settings, for example, if a cascade port is not included in a neighbor discovery interface list, the LLDP messages will be still sent. The current CB implementation does not support any failover techniques. Once the CB device becomes unavailable, the PE devices will lose all the control and data forwarding rules.

1. 2. 3. 4. a. b. 5. a. b. To better understand the underlying principles of Controlling Bridge and Port Extender, a packet walkthrough is provided below: An L2 packet is received on the extended port; The Port Extender encapsulates the packet with an E-TAG header (EtherType 0x893F) and forwards it through an upstream port, towards the Controller Bridge. An E-TAG packet contains information regarding the PE source port ID. The PE device does not make any local switching decisions; The Controller Bridge receives the E-TAG packet and knows exactly which extended interface received it. The CB then internally decapsulates the packet and proceed it through a regular switching decision (host learning, destination address lookup, VLAN filtering, etc.); Once a switching decision is made, the CB will again encapsulate the original packet with an E-TAG and send it through a cascade port, towards Port Extender; For a single destination packet (unicast), the CB will include the PE destination port ID in the E-TAG and send it through a correct cascade port; For a multi-destination packet (broadcast, multicast or unknown-unicast), the CB will include a target group mark and source port ID in the E-TAG and send a single packet replica per every cascade port; Once a PE device receives an E-TAG packet on the upstream port, PE decapsulates it and sends the original L2 packet through the extended port; For a single destination packet (unicast), the PE will send the packet only to the correct extended port; For a multi-destination packet (broadcast, multicast or unknown-unicast), the PE will send a single packet replica per every extended port (except for the source port where the packet was received). Controller Bridge settings and monitoring This section describes the Controller Bridge settings and monitoring options. Sub-menu: /interface bridge port-controller Property Description bridge (name; Default: n )oneThe bridge interface where ports will be extended. The CB will only enable when and properties are bridge switch specified, otherwise, it will be in a disabled state. cascade-ports (interface Default: ) s; noneInterfaces that will act as cascade ports. A bonding interface with 802.3ad or balance-xor is also supported.mode switch (name; Default: n )oneThe switch that will act as the CB and ensure the control and network traffic. The CB will only enable when and bridge properties are specified, otherwise, it will be in a disabled state. switch After CB and PE devices are configured and connected, each PE device will be automatically visible on the device menu, use and print monitor commands to see more details.

name ( ) name Automatically assigned PE port name. pcid ( ) integer Automatically assigned port identifier. port-status ( ) dev-inactive | not-added | ok PE port status. rate ( )bps Data rate of the connection. status ( ) link-ok | no-link | unknown PE port link status. The Controller Bridge can monitor the PoE-out related information from Port Extenders on the port poe menu, use and commands to print monitor see more details. For more information regarding PoE-out, please visit the . PoE-out manual [admin@Controller] > interface bridge port-controller port poe print # NAME DEVICE 0 pe1-ether1 pe1 1 pe1-ether2 pe1 2 pe1-ether3 pe1 3 pe1-ether4 pe1 4 pe1-ether5 pe1 5 pe1-ether6 pe1 6 pe1-ether7 pe1 ... [admin@Controller] > interface bridge port-controller port poe monitor pe1-ether2,pe1-ether3 name: pe1-ether2 pe1-ether3 poe-out-status: powered-on powered-on poe-out-voltage: 52.8V 52.9V poe-out-current: 123mA 95mA poe-out-power: 6.4W 5W Port Extender settings This section describes the Port Extender settings. Sub-menu: /interface bridge port-extender Property Description control-ports (interfaces; Default: ) noneInterfaces that will either connect to the CB (upstream port) or connect other PE devices in series (cascade port). A bonding interface with 802.3ad or balance-xor is also supported.mode excluded-ports (interfaces Default: ) ; noneInterfaces that will not be extended. switch (name; Default: no )neThe switch that will act as the extender and ensure the control and network traffic. The PE will only enable when this property is specified, otherwise, it will be in a disabled state. Configuration examples Below are described the most common configuration examples. For CB and PE configuration to work properly, a bridge VLAN filtering needs to be enabled, so make sure to understand the filtering principles first - , . bridge VLAN filtering bridge VLAN table Basic CB and PE configuration In this example, a CRS317-1G-16S+ device is used as a Controller Bridge and CRS328-24P-4S+ as a Port Extender, see the connection scheme below.

First, configure the CB device. This can be done by adding a bridge interface with enabled VLAN filtering. Additionally, add any local interfaces to the same bridge, it allows to In this example, an sfp-sfpplus2 interface is added. forward traffic between any local interfaces and extended interfaces. /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=sfp-sfpplus2 To enable CB, specify the bridge, switch and at least one cascade port. Make sure that cascade ports are not included in the bridge or routing configurations. These ports are recommended only for a CB and PE usage. /interface bridge port-controller set bridge=bridge1 cascade-ports=sfp-sfpplus1 switch=switch1 To enable PE, configure control ports and switch. Additionally, configure one or multiple interfaces that should not be extended with excluded-ports property (e.g. for out-of-band management purposes). In this example, all switch ports will be extended. /interface bridge port-extender set control-ports=sfp-sfpplus4 switch=switch1 Once PE and CB devices finish the discovery and start the Control and Status Protocol (CSP), the RouterOS will permanently create new interfaces and add them into bridge on the CB device. Interfaces are named by the automatically assigned PE device name, plus the default interface name, these interface names can be modified afterwards. Note that control and excluded ports will be also displayed into the interface list, but they are not included into the bridge.

[admin@Controller_Bridge] > /interface print where name~"pe" Flags: D - dynamic, X - disabled, R - running, S - slave # NAME TYPE ACTUAL-MTU L2MTU MAX-L2MTU 0 RS pe1-ether1 extport 1500 1584 1 RS pe1-ether2 extport 1500 1584 2 RS pe1-ether3 extport 1500 1584 3 S pe1-ether4 extport 1500 1584 4 S pe1-ether5 extport 1500 1584 5 S pe1-ether6 extport 1500 1584 6 S pe1-ether7 extport 1500 1584 7 S pe1-ether8 extport 1500 1584 8 S pe1-ether9 extport 1500 1584 9 S pe1-ether10 extport 1500 1584 10 S pe1-ether11 extport 1500 1584 11 S pe1-ether12 extport 1500 1584 12 S pe1-ether13 extport 1500 1584 13 S pe1-ether14 extport 1500 1584 14 S pe1-ether15 extport 1500 1584 15 S pe1-ether16 extport 1500 1584 16 S pe1-ether17 extport 1500 1584 17 S pe1-ether18 extport 1500 1584 18 S pe1-ether19 extport 1500 1584 19 S pe1-ether20 extport 1500 1584 20 S pe1-ether21 extport 1500 1584 21 S pe1-ether22 extport 1500 1584 22 S pe1-ether23 extport 1500 1584 23 S pe1-ether24 extport 1500 1584 24 RS pe1-sfpplus1 extport 1500 1584 25 RS pe1-sfpplus2 extport 1500 1584 26 RS pe1-sfpplus3 extport 1500 1584 27 pe1-sfpplus4 extport 1500 1584 [admin@Controller_Bridge] > interface bridge port print Flags: X - disabled, I - inactive, D - dynamic, H - hw-offload # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH-COST HORIZON 0 H sfp-sfpplus2 bridge1 yes 1 0x80 10 10 none 1 H pe1-ether1 bridge1 yes 1 0x80 10 10 none 2 H pe1-ether2 bridge1 yes 1 0x80 10 10 none 3 H pe1-ether3 bridge1 yes 1 0x80 10 10 none 4 I H pe1-ether4 bridge1 yes 1 0x80 10 10 none 5 I H pe1-ether5 bridge1 yes 1 0x80 10 10 none 6 I H pe1-ether6 bridge1 yes 1 0x80 10 10 none 7 I H pe1-ether7 bridge1 yes 1 0x80 10 10 none 8 I H pe1-ether8 bridge1 yes 1 0x80 10 10 none 9 I H pe1-ether9 bridge1 yes 1 0x80 10 10 none 10 I H pe1-ether10 bridge1 yes 1 0x80 10 10 none 11 I H pe1-ether11 bridge1 yes 1 0x80 10 10 none 12 I H pe1-ether12 bridge1 yes 1 0x80 10 10 none 13 I H pe1-ether13 bridge1 yes 1 0x80 10 10 none 14 I H pe1-ether14 bridge1 yes 1 0x80 10 10 none 15 I H pe1-ether15 bridge1 yes 1 0x80 10 10 none 16 I H pe1-ether16 bridge1 yes 1 0x80 10 10 none 17 I H pe1-ether17 bridge1 yes 1 0x80 10 10 none 18 I H pe1-ether18 bridge1 yes 1 0x80 10 10 none 19 I H pe1-ether19 bridge1 yes 1 0x80 10 10 none 20 I H pe1-ether20 bridge1 yes 1 0x80 10 10 none 21 I H pe1-ether21 bridge1 yes 1 0x80 10 10 none 22 I H pe1-ether22 bridge1 yes 1 0x80 10 10 none 23 I H pe1-ether23 bridge1 yes 1 0x80 10 10 none 24 I H pe1-ether24 bridge1 yes 1 0x80 10 10 none 25 H pe1-sfpplus1 bridge1 yes 1 0x80 10 10 none 26 H pe1-sfpplus2 bridge1 yes 1 0x80 10 10 none 27 H pe1-sfpplus3 bridge1 yes 1 0x80 10 10 none Now the CRS317-1G-16S+ device has extended its ports using the CRS328-24P-4S+ device and packet forwarding can be done between all bridged ports. Trunk and Access ports

In this example, untagged (access) and tagged (trunk) port configuration will be created on the Controller Bridge device, see the network diagram below. First, configure the CB and PE devices, the configuration is identical to the previous example. Use this configuration for CB device. /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=sfp-sfpplus2 /interface bridge port-controller set bridge=bridge1 cascade-ports=sfp-sfpplus1 switch=switch1 Use this configuration for PE device. /interface bridge port-extender set control-ports=sfp-sfpplus4 switch=switch1 After extended ports are successfully created and added to the bridge on the CB device, we can start configuring VLAN related properties. First, configure access ports to their respective VLAN ID using a property. Use a command in " " menu to find out pvid print /interface bridge port the exact interface name.

/interface bridge port set [find interface=pe1-ether1] pvid=10 set [find interface=pe1-ether2] pvid=20 set [find interface=pe1-ether3] pvid=30 Then add bridge VLAN entries and specify tagged, untagged ports. Note that there are two tagged ports - local port named sfp-sfpplus2 and extended port named pe1-sfpplus1. /interface bridge vlan add bridge=bridge1 tagged=pe1-sfpplus1,sfp-sfpplus2 untagged=pe1-ether1 vlan-ids=10 add bridge=bridge1 tagged=pe1-sfpplus1,sfp-sfpplus2 untagged=pe1-ether2 vlan-ids=20 add bridge=bridge1 tagged=pe1-sfpplus1,sfp-sfpplus2 untagged=pe1-ether3 vlan-ids=30 At this point VLANs are configured and devices should be able to communicate through the ports. However, it is recommended to go even a step further and apply some additional filtering options. Enable port on local bridge ports and use frame filtering based on the ingress-filtering packet type with setting. frame-types /interface bridge port set [find interface=pe1-ether1] frame-types=admit-only-untagged-and-priority-tagged set [find interface=pe1-ether2] frame-types=admit-only-untagged-and-priority-tagged set [find interface=pe1-ether3] frame-types=admit-only-untagged-and-priority-tagged set [find interface=pe1-sfpplus1] frame-types=admit-only-vlan-tagged set [find interface=sfp-sfpplus2] frame-types=admit-only-vlan-tagged ingress-filtering=yes Cascading multiple Port Extenders and using bonding interface In this example, two PE devices (CRS328-24P-4S+ and CRS326-24G-2S+) will be added to the CB (CRS317-1G-16S+). To increase throughput for upstream and cascade ports, will be created. See the network diagram below. bonding interfaces Port ingress VLAN filtering is not supported on extended ports.

The CB and PE configuration is similar to the first example, the main difference is the bonding interface usage. First, configure the CB device - create a bonding interface for cascade port, create a bridge and add any needed local bridge ports, last enable the CB. Use the following commands: /interface bonding add mode=802.3ad name=bond1 slaves=sfp-sfpplus1,sfp-sfpplus2 /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=sfp-sfpplus3 /interface bridge port-controller set bridge=bridge1 cascade-ports=bond1 switch=switch1 Then configure the Port Extender 1 device. This device needs two bonding interfaces - the first one will be used as an upstream port and the second one will be a cascade port for the Port Extender 2 device. Additionally, configure one or multiple interfaces that should not be extended with excluded property (e.g. for out-of-band management purposes). In this example, all switch ports will be extended. -ports

/interface bonding add mode=802.3ad name=bond1 slaves=sfp-sfpplus1,sfp-sfpplus2 add mode=802.3ad name=bond2 slaves=sfp-sfpplus3,sfp-sfpplus4 /interface bridge port-extender set control-ports=bond1,bond2 switch=switch1 Last, configure the Port Extender 2 device - create a bonding interface and enable PE. Additionally, configure one or multiple if excluded-ports necessary. In this example, all switch ports will be extended. /interface bonding add mode=802.3ad name=bond1 slaves=sfp-sfpplus1,sfp-sfpplus2 /interface bridge port-extender set control-ports=bond1 switch=switch1 Now the CRS317-1G-16S+ device has extended its ports with additional 48 Gigabit Ethernet ports and packet forwarding can be achieved between all bridged ports. Use the command in the device menu to see the PE device connection path. Also, use command in the port menu to see which PE monitor print interfaces are used as upstream and cascade ports. [admin@Controller_Bridge] > interface bridge port-controller device monitor [find] name: pe1 pe2 status: active active connected-via-ports: bond1==pe1-cntrl-bond1 bond1==pe1-cntrl-bond1 pe1-cntrl-bond2==pe2-cntrl-bond1 connected-via-devs: controller controller pe1 [admin@Controller_Bridge] > interface bridge port-controller port print where running or upstream-port Flags: I - inactive, X - disabled, R - running, U - upstream-port, C - cascade-port # NAME DEVICE 0 R pe1- ether2 pe1 1 R pe1- ether3 pe1 2 R pe1- ether4 pe1 3 U pe1- sfpplus1 pe1 4 U pe1- sfpplus2 pe1 5 RC pe1- sfpplus3 pe1 6 RC pe1- sfpplus4 pe1 7 R pe2- ether1 pe2 8 R pe2- ether2 pe2 9 R pe2- ether3 pe2 10 R pe2- ether4 pe2 11 U pe2- sfpplus1 pe2 12 U pe2- sfpplus2 pe2 Configuration modification and removal In certain situations, CB and PE device configuration needs to be adjusted (e.g. PE device needs new control ports) or removed completely. To modify the PE device configuration, all related PE device configuration should be removed from the CB device first. Only then the new configuration can be applied.

First, to remove PE configuration from CB, disable the PE using the following command: /interface bridge port-extender set switch=none control-ports="" excluded-ports="" Then, on the CB device, remove the related bridge and other RouterOS configuration where PE interfaces were used (e.g. see the export from " /inte " and " " menus). For example, to remove all bridge ports from a specific PE device, use the rface bridge port /interface bridge vlan command below: /interface bridge port remove [find interface~"pe1"] Once the configuration is removed, PE can be removed from the CB device list. This command will also automatically remove all the PE device interfaces from the CB interface list. In case some PE interface configuration is still applied on the CB, it will not be valid anymore. Use print command to find out the PE device name. /interface bridge port-controller device remove [find name=pe1]

CRS1xx/2xx series switches examples Summary Port switching Management access configuration Untagged Tagged VLAN Port Based VLAN Example 1 (Trunk and Access ports) Example 2 (Trunk and Hybrid Ports) Protocol Based VLAN MAC Based VLAN InterVLAN Routing Unknown/Invalid VLAN filtering VLAN Tunneling (Q-in-Q) CVID Stacking Mirroring Port-Based Mirroring VLAN Based Mirroring MAC Based Mirroring Trunking Limited MAC Access per Port Isolation Port Level Isolation Protocol Level Isolation Quality of Service (QoS) MAC-based traffic scheduling using internal Priority MAC-based traffic shaping using internal Priority VLAN-based traffic scheduling + shaping using internal Priorities PCP-based traffic scheduling Bandwidth Limiting Traffic Storm Control See also Summary Basic use cases and configuration examples for Cloud Router Switch features. Port switching To set up port switching on CRS1xx/2xx series switches, check the page. Bridge Hardware Offloading Management access configuration In general, switches are only supposed to forward packets by using the built-in switch chip, but not allow access to the device itself for security reasons. It is possible to use the device's serial port for management access, but in most cases, such an access method is not desired and access using an IP address is more suitable. In such cases, you will need to configure management access. This article applies to CRS1xx and CRS2xx series switches and not to CRS3xx series switches. For CRS3xx series devices read the CRS3xx, manual. CRS5xx series switches and CCR2116, CCR2216 It is possible to create multiple isolated switch groups by using multiple bridges with enabled hardware offloading, this is possible only on CRS1xx/2xx series switches. For more complex setups (for example, VLAN filtering) you should use the port isolation feature instead.

In all types of management access it is assumed that ports must be switched together, use the following commands to switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether5 hw=yes You should also assign an IP address to the bridge interface so the device is reachable using an IP address (the device is also reachable using a MAC address): /ip address add address=192.168.88.1/24 interface=bridge1 Untagged If invalid VLAN filtering is not enabled, management access to the device using tagged or untagged ( ) traffic is already allowed from any port, VLAN 0 though this is not a good practice, this can cause security issues and can cause the device's CPU to be overloaded in certain situations (most commonly with a broadcast type of traffic). If you intend to use invalid VLAN filtering (which you should), then ports, from which you are going to access the switch, must be added to the VLAN table for untagged ( ) traffic, for example, in case you want to access the switch from : VLAN 0 ether2 /interface ethernet switch vlan add vlan-id=0 ports=ether2,switch1-cpu Tagged Allowing only tagged traffic to have management access to the device through a specific port is a much better practice. For example, to allow only VLAN99 to access the device through you should first add an entry to the VLAN table, which will allow the selected port and the CPU port ( ) to ether2 switch1-cpu forward the selected VLAN ID, therefore allowing management access: /interface ethernet switch vlan add ports=ether2,switch1-cpu vlan-id=99 Packets that will be sent out from the CPU, for example, ping replies will not have a VLAN tag, to solve this you need to specify which ports should always send out packets with a VLAN tag for a specific VLAN ID: /interface ethernet switch egress-vlan-tag add tagged-ports=ether2,switch1-cpu vlan-id=99 After a valid VLAN99 configuration has been set up, you can enable unknown/invalid VLAN filtering, which will not allow the management access through different ports than specified in the VLAN table: /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether2,ether3,ether4,ether5 In this example VLAN99 will be used to access the device, a VLAN interface on the bridge must be created and an IP address must be assigned to it. /interface vlan add interface=bridge1 name=MGMT vlan-id=99 /ip address add address=192.168.99.1/24 interface=MGMT

VLAN Port Based VLAN Example 1 (Trunk and Access ports) Switch together the required ports: It is recommended to get a Serial Console cable and testing it before configuring VLANs because you may lose access to the CPU and/or the port you are connected to. Some changes may take some time to take effect due to already-learned MAC addresses. In such cases flushing the Unicast Forwarding Database can help: /interface ethernet switch unicast-fdb flush Multiple hardware offloaded bridge configuration is designed as a fast and simple port isolation solution, but it limits part of the VLAN functionality supported by the CRS switch-chip. For advanced configurations use one bridge within the CRS switch chip for all ports, configure VLANs, and isolate port groups with port isolation profile configuration. For CRS3xx series devices, you must use bridge VLAN filtering, you can read more about it in the section. Bridge VLAN Filtering

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Specify the VLAN ID that the switch must set on untagged (VLAN0) traffic for each access port: /interface ethernet switch ingress-vlan-translation add ports=ether6 customer-vid=0 new-customer-vid=200 add ports=ether7 customer-vid=0 new-customer-vid=300 add ports=ether8 customer-vid=0 new-customer-vid=400 You must also specify which VLANs should be sent out to the trunk port with a VLAN tag. Use the tagged-ports property to set up a trunk port: /interface ethernet switch egress-vlan-tag add tagged-ports=ether2 vlan-id=200 add tagged-ports=ether2 vlan-id=300 add tagged-ports=ether2 vlan-id=400 Add entries to the VLAN table to specify VLAN memberships for each port and each VLAN ID: /interface ethernet switch vlan add ports=ether2,ether6 vlan-id=200 add ports=ether2,ether7 vlan-id=300 add ports=ether2,ether8 vlan-id=400 After a valid VLAN configuration has been set up, you can enable unknown/invalid VLAN filtering: /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether2,ether6,ether7,ether8 Example 2 (Trunk and Hybrid Ports) When an entry is created under , then the switch chip will add a VLAN tag /interface ethernet switch ingress-vlan-translation on ingress frames on the specified port. To remove the VLAN tag on the same port for egress frames, an /interface ethernet switch entry should be created for the same VLAN ID where only tagged ports are specified. If a specific VLAN is forwarded only egress-vlan-tag between access ports, the entry should still be created without any tagged ports. /interface ethernet switch egress-vlan-tag Another option is to create extra entries under menu to set untagged /interface ethernet switch egress-vlan-translation (VLAN0) traffic. It is possible to use the built-in switch chip and the CPU at the same time to create a Switch-Router setup, where a device acts as a switch and as a router simultaneously. You can find a configuration example in the guide. CRS-Router

Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Specify the VLAN ID that the switch must set on untagged (VLAN0) traffic for each access port: /interface ethernet switch ingress-vlan-translation add ports=ether6 customer-vid=0 new-customer-vid=200 add ports=ether7 customer-vid=0 new-customer-vid=300 add ports=ether8 customer-vid=0 new-customer-vid=400 By specifying ports as tagged-ports, the switch will always send out packets as tagged packets with the corresponding VLAN ID. Add appropriate entries according to the diagram above: /interface ethernet switch egress-vlan-tag add tagged-ports=ether2,ether7,ether8 vlan-id=200 add tagged-ports=ether2,ether6,ether8 vlan-id=300 add tagged-ports=ether2,ether6,ether7 vlan-id=400 Add entries to the VLAN table to specify VLAN memberships for each port and each VLAN ID:

/interface ethernet switch vlan add ports=ether2,ether6,ether7,ether8 vlan-id=200 learn=yes add ports=ether2,ether6,ether7,ether8 vlan-id=300 learn=yes add ports=ether2,ether6,ether7,ether8 vlan-id=400 learn=yes After a valid VLAN configuration has been set up, you can enable unknown/invalid VLAN filtering: /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether2,ether6,ether7,ether8 Protocol Based VLAN Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Set VLAN for IP and ARP protocols:

/interface ethernet switch protocol-based-vlan add port=ether2 protocol=arp set-customer-vid-for=all new-customer-vid=0 add port=ether6 protocol=arp set-customer-vid-for=all new-customer-vid=200 add port=ether2 protocol=ip set-customer-vid-for=all new-customer-vid=0 add port=ether6 protocol=ip set-customer-vid-for=all new-customer-vid=200 Set VLAN for IPX protocol: /interface ethernet switch protocol-based-vlan add port=ether2 protocol=ipx set-customer-vid-for=all new-customer-vid=0 add port=ether7 protocol=ipx set-customer-vid-for=all new-customer-vid=300 Set VLAN for AppleTalk AARP and AppleTalk DDP protocols: /interface ethernet switch protocol-based-vlan add port=ether2 protocol=0x80F3 set-customer-vid-for=all new-customer-vid=0 add port=ether8 protocol=0x80F3 set-customer-vid-for=all new-customer-vid=400 add port=ether2 protocol=0x809B set-customer-vid-for=all new-customer-vid=0 add port=ether8 protocol=0x809B set-customer-vid-for=all new-customer-vid=400 MAC Based VLAN Switch together the required ports: Internally all MAC addresses in MAC-based VLANs are hashed, certain MAC addresses can have the same hash, which will prevent a MAC address from being loaded into the switch chip if the hash matches with a hash from a MAC address that has been already loaded, for this reason, it is recommended to use Port bases VLANs in combination with MAC-based VLANs. This is a hardware limitation.

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether7 hw=yes Enable MAC-based VLAN translation on access port: /interface ethernet switch port set ether7 allow-fdb-based-vlan-translate=yes Add MAC-to-VLAN mapping entries in the MAC-based VLAN table: /interface ethernet switch mac-based-vlan add src-mac=A4:12:6D:77:94:43 new-customer-vid=200 add src-mac=84:37:62:DF:04:20 new-customer-vid=300 add src-mac=E7:16:34:A1:CD:18 new-customer-vid=400 Add VLAN200, VLAN300, and VLAN400 tagging on the ether2 port to create it as a VLAN trunk port: /interface ethernet switch egress-vlan-tag add tagged-ports=ether2 vlan-id=200 add tagged-ports=ether2 vlan-id=300 add tagged-ports=ether2 vlan-id=400 Additionally, add entries to the VLAN table, specify VLAN membership for each port, and enable unknown/invalid VLAN filtering, see an example below - U nknown/Invalid VLAN filtering. This is required for network setups where more interfaces are added to the bridge, as it allows to define VLAN boundaries. InterVLAN Routing

InterVLAN routing configuration consists of two main parts – VLAN tagging in switch-chip and routing in RouterOS. This configuration can be used in many applications by combining it with a DHCP server, Hotspot, PPP, and other features for each VLAN. Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Set VLAN tagging on the CPU port for all VLANs to make packets tagged before they are routed: /interface ethernet switch egress-vlan-tag add tagged-ports=switch1-cpu vlan-id=200 add tagged-ports=switch1-cpu vlan-id=300 add tagged-ports=switch1-cpu vlan-id=400 add ingress VLAN translation rules to ensure that the correct VLAN ID assignment is done on access ports: /interface ethernet switch ingress-vlan-translation add ports=ether6 customer-vid=0 new-customer-vid=200 add ports=ether7 customer-vid=0 new-customer-vid=300 add ports=ether8 customer-vid=0 new-customer-vid=400 Create the VLAN interfaces on top of the bridge interface:

/interface vlan add name=VLAN200 interface=bridge1 vlan-id=200 add name=VLAN300 interface=bridge1 vlan-id=300 add name=VLAN400 interface=bridge1 vlan-id=400 Add IP addresses on created VLAN interfaces. In this example, three 192.168.x.1 addresses are added to VLAN200, VLAN300, and VLAN400 interfaces: /ip address add address=192.168.20.1/24 interface=VLAN200 add address=192.168.30.1/24 interface=VLAN300 add address=192.168.40.1/24 interface=VLAN400 Unknown/Invalid VLAN filtering VLAN membership is defined in the VLAN table. Adding entries with VLAN ID and ports makes that VLAN traffic valid on those ports. After a valid VLAN configuration has been set up, unknown/invalid VLAN filtering can be enabled. This VLAN filtering configuration example applies to InterVLAN Routing s the etup. /interface ethernet switch vlan add ports=switch1-cpu,ether6 vlan-id=200 add ports=switch1-cpu,ether7 vlan-id=300 add ports=switch1-cpu,ether8 vlan-id=400 Option 1: disable invalid VLAN forwarding on specific ports (more common): /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether2,ether6,ether7,ether8 Option 2: disable invalid VLAN forwarding on all ports: /interface ethernet switch set forward-unknown-vlan=no VLAN Tunneling (Q-in-Q) This example covers a typical VLAN tunneling use case where service provider devices add another VLAN tag for independent forwarding in the meantime allowing customers to use their own VLANs. Make sure the VLAN interfaces are created on top of the bridge interface instead of any of the physical interfaces. If the VLAN interfaces are created on a slave interface, then the packet might not be received correctly, and therefore routing might fail. More detailed information can be found in the manual page. VLAN interface on a slave interface Using multiple bridges on a single switch chip with enabled unknown/invalid VLAN filtering can cause unexpected behavior. You should always use a single bridge configuration whenever using VLAN filtering. If port isolation is required, then the port isolation feature should be used instead of using multiple bridges. This example contains only the Service VLAN tagging part. It is recommended to additionally set Unknown/Invalid VLAN filtering configuration on ports.

CRS-1 : The first switch on the edge of the service provider network has to properly identify traffic from the customer VLAN ID on port and assign a new service VLAN ID with ingress VLAN translation rules. VLAN trunk port configuration for service provider VLAN tags is in the same tabl egress-vlan-tag e. The main difference from basic Port-Based VLAN configuration is that the CRS switch-chip has to be set to do forwarding according to service ( ) outer VLAN ID instead of customer ( ) VLAN ID. inner /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether9 hw=yes /interface ethernet switch ingress-vlan-translation add customer-vid=200 new-service-vid=400 ports=ether1 add customer-vid=300 new-service-vid=500 ports=ether2 /interface ethernet switch egress-vlan-tag add tagged-ports=ether9 vlan-id=400 add tagged-ports=ether9 vlan-id=500 /interface ethernet switch set bridge-type=service-vid-used-as-lookup-vid CRS-2 : The second switch in the service provider network requires only switched ports to do forwarding according to service ( ) VLAN ID instead of outer customer ( ) VLAN ID. inner /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether9 hw=yes add bridge=bridge1 interface=ether10 hw=yes /interface ethernet switch set bridge-type=service-vid-used-as-lookup-vid CRS-3 : The third switch has a similar configuration to CRS-1: Ports in a switch group using a bridge; Ingress VLAN translation rules to define new service VLAN assignments on ports; tagged-ports for service provider VLAN trunks; CRS switch-chip set to use service VLAN ID in switching lookup.

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether10 hw=yes /interface ethernet switch ingress-vlan-translation add customer-vid=200 new-service-vid=400 ports=ether3 add customer-vid=300 new-service-vid=500 ports=ether4 /interface ethernet switch egress-vlan-tag add tagged-ports=ether10 vlan-id=400 add tagged-ports=ether10 vlan-id=500 /interface ethernet switch set bridge-type=service-vid-used-as-lookup-vid CVID Stacking It is possible to use CRS1xx/CRS2xx series switches for CVID Stacking setups. CRS1xx/CRS2xx series switches are capable of VLAN filtering based on the outer tag of tagged packets that have two CVID tags (double CVID tag), these switches are also capable of adding another CVID tag on top of an existing CVID tag (CVID Stacking). For example, in a setup where is receiving tagged packets with CVID 10, but it is required that sends out ether1 ether2 these packets with another tag CVID 20 (VLAN10 inside VLAN20) while filtering out any other VLANs, the following must be configured: Switch together and : ether1 ether2 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes Set the switch to filter VLANs based on the service tag (0x88a8): /interface ethernet switch set bridge-type=service-vid-used-as-lookup-vid Add a service tag SVID 20 to packets that have a CVID 10 tag on : ether1 /interface ethernet switch ingress-vlan-translation add customer-vid=10 new-service-vid=20 ports=ether1 Specify as the tagged/trunk port for SVID 20: ether2 /interface ethernet switch egress-vlan-tag add tagged-ports=ether2 vlan-id=20 Allow and to forward SVID 20: ether1 ether2 /interface ethernet switch vlan add ports=ether1,ether2 vlan-id=20 Override the SVID EtherType (0x88a8) to CVID EtherType (0x8100) on : ether2 /interface ethernet switch port set ether2 egress-service-tpid-override=0x8100 ingress-service-tpid-override=0x8100

Enable unknown/invalid VLAN filtering: /interface ethernet switch set drop-if-invalid-or-src-port-not-member-of-vlan-on-ports=ether1,ether2 Mirroring The Cloud Router Switches support three types of mirroring. Port-based mirroring can be applied to any switch-chip ports, VLAN-based mirroring works for all specified VLANs regardless of switch-chip ports, and MAC-based mirroring copies traffic sent or received from specific device reachable from the port configured in Unicast Forwarding Database. Port-Based Mirroring The first configuration sets the ether5 port as a mirror0 analyzer port for both ingress and egress mirroring, mirrored traffic will be sent to this port. Port- based ingress and egress mirroring are enabled from the ether6 port. /interface ethernet switch set ingress-mirror0=ether5 egress-mirror0=ether5 /interface ethernet switch port set ether6 ingress-mirror-to=mirror0 egress-mirror-to=mirror0 VLAN Based Mirroring The second example requires ports to be switched in a group. Mirroring configuration sets the ether5 port as a mirror0 analyzer port and sets the mirror0 port to be used when mirroring from VLAN occurs. VLAN table entry enables mirroring only for VLAN 300 traffic between ether2 and ether7 ports. Since the switch is set to look up VLAN ID based on the service tag, which is overridden with a different EtherType, then VLAN filtering is only done on the outer tag of a packet, the inner tag is not checked.

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether7 hw=yes /interface ethernet switch set ingress-mirror0=ether5 vlan-uses=mirror0 /interface ethernet switch vlan add ports=ether2,ether7 vlan-id=300 learn=yes ingress-mirror=yes MAC Based Mirroring The third configuration also requires ports to be switched in a group. Mirroring configuration sets the ether5 port as a mirror0 analyzer port and sets the mirror0 port to be used when mirroring from the Unicast Forwarding database occurs. The entry from the Unicast Forwarding database enables mirroring for packets with source or destination MAC address E7:16:34:A1:CD:18 from ether8 port. /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether8 hw=yes /interface ethernet switch set ingress-mirror0=ether5 fdb-uses=mirror0 /interface ethernet switch unicast-fdb add port=ether8 mirror=yes svl=yes mac-address=E7:16:34:A1:CD:18 Trunking The Trunking in the Cloud Router Switches provides static link aggregation groups with hardware automatic failover and load balancing. IEEE802.3ad and IEEE802.1ax compatible Link Aggregation Control Protocol is not supported yet. Up to 8 Trunk groups are supported with up to 8 Trunk member ports per Trunk group. Configuration requires a group of switched ports and an entry in the Trunk table: /interface bridge add name=bridge1 protocol-mode=none /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes /interface ethernet switch trunk add name=trunk1 member-ports=ether6,ether7,ether8

This example also shows proper bonding configuration in RouterOS on the other end: /interface bonding add name=bonding1 slaves=ether2,ether3,ether4 mode=balance-xor transmit-hash-policy=layer-2-and-3 Limited MAC Access per Port Disabling MAC learning and configuring static MAC addresses gives the ability to control what exact devices can communicate to CRS1xx/2xx switches and through them. Configuration requires a group of switched ports, disabled MAC learning on those ports, and static UFDB entries: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes learn=no unknown-unicast-flood=no add bridge=bridge1 interface=ether7 hw=yes learn=no unknown-unicast-flood=no /interface ethernet switch unicast-fdb add mac-address=4C:5E:0C:00:00:01 port=ether6 svl=yes add mac-address=D4:CA:6D:00:00:02 port=ether7 svl=yes /interface ethernet switch acl add action=drop src-mac-addr-state=sa-not-found src-ports=ether6,ether7 table=egress add action=drop src-mac-addr-state=static-station-move src-ports=ether6,ether7 table=egress CRS1xx/2xx switches also allow to learn one dynamic MAC per port to ensure only one end-user device is connected no matter its MAC address: /interface ethernet switch port set ether6 learn-limit=1 set ether7 learn-limit=1 Isolation Port Level Isolation You can find a working example for trunking and port-based VLANs on page. CRS VLANs with Trunks Bridge (R)STP is not aware of the underlying switch trunking configuration and some trunk ports can move to a discarding or blocking state. When trunking member ports are connected to other bridges, you should either disable the (R)STP or filter out any BPDU between trunked devices (e.g. with ACL rules).

Port-level isolation is often used for Private VLAN, where: One or multiple uplink ports are shared among all users for accessing the gateway or router. Port group Isolated Ports is for guest users. Communication is through the uplink ports only. Port group Community 0 is for department A. Communication is allowed between the group members and through uplink ports. Port group Community X is for department X. Communication is allowed between the group members and through uplink ports. The Cloud Router Switches use port-level isolation profiles for Private VLAN implementation: Uplink ports – port-level isolation profile 0 Isolated ports – port-level isolation profile 1 Community 0 ports - port-level isolation profile 2 Community X (X <= 30) ports - port-level isolation profile X This example requires a group of switched ports. Assume that all ports used in this example are in one switch group. /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes add bridge=bridge1 interface=ether9 hw=yes add bridge=bridge1 interface=ether10 hw=yes The first part of port isolation configuration is setting the Uplink port – set a port profile to 0 for ether2: /interface ethernet switch port set ether2 isolation-leakage-profile-override=0 Then continue with setting isolation profile 1 to all isolated ports and adding the communication port for port isolation profile 1: /interface ethernet switch port set ether5 isolation-leakage-profile-override=1 set ether6 isolation-leakage-profile-override=1 /interface ethernet switch port-isolation add port-profile=1 ports=ether2 type=dst Configuration to set Community 2 and Community 3 ports is similar:

/interface ethernet switch port set ether7 isolation-leakage-profile-override=2 set ether8 isolation-leakage-profile-override=2 /interface ethernet switch port-isolation add port-profile=2 ports=ether2,ether7,ether8 type=dst /interface ethernet switch port set ether9 isolation-leakage-profile-override=3 set ether10 isolation-leakage-profile-override=3 /interface ethernet switch port-isolation add port-profile=3 ports=ether2,ether9,ether10 type=dst Protocol Level Isolation Protocol level isolation on CRS switches can be used to enhance network security. For example, restricting DHCP traffic between the users and allowing it only to trusted DHCP server ports can prevent security risks like DHCP spoofing attacks. The following example shows how to configure it on CRS. Switch together the required ports: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes add bridge=bridge1 interface=ether4 hw=yes add bridge=bridge1 interface=ether5 hw=yes Set the same Community port profile for all DHCP client ports. Community port profile numbers are from 2 to 30. /interface ethernet switch port set ether2 isolation-leakage-profile-override=2 set ether3 isolation-leakage-profile-override=2 set ether4 isolation-leakage-profile-override=2 set ether5 isolation-leakage-profile-override=2 And configure port isolation/leakage profile for selected Community (2) to allow DHCP traffic destined only to the port where the trusted DHCP server is located. andtraffic-type properties have to be set empty to apply restrictions only for DHCP protocol. registration status

/interface ethernet switch port-isolation add port-profile=2 protocol-type=dhcpv4 type=dst forwarding-type=bridged ports=ether1 registration-status="" traffic-type="" Quality of Service (QoS) QoS configuration schemes MAC based traffic scheduling and shaping: [MAC address in UFDB] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] VLAN based traffic scheduling and shaping: [VLAN id in VLAN table] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] Protocol based traffic scheduling and shaping: [Protocol in Protocol VLAN table] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] PCP/DEI based traffic scheduling and shaping: [Switch port PCP/DEI mapping] -> [Priority] -> [Queue] -> [Shaper] DSCP based traffic scheduling and shaping: [QoS DSCP mapping] -> [Priority] -> [Queue] -> [Shaper] MAC-based traffic scheduling using internal Priority In Strict Priority scheduling mode, the highest priority queue is served first. The queue number represents the priority and the queue with the highest queue number has the highest priority. Traffic is transmitted from the highest priority queue until the queue is empty, and then moves to the next highest priority queue, and so on. If no congestion is present at the egress port, a packet is transmitted as soon as it is received. If congestion occurs in the port where high-priority traffic keeps coming, the lower-priority queues starve. On all CRS switches the scheme where MAC-based egress traffic scheduling is done according to internal Priority would be the following: [MAC address] - > [QoS Group] -> [Priority] -> [Queue]; In this example, host1 (E7:16:34:00:00:01) and host2 (E7:16:34:00:00:02) will have higher priority 1 and the rest of the hosts will have lower priority 0 for transmitted traffic on port ether7. Note that CRS has a maximum of 8 queues per port. /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create a QoS group for use in UFDB: /interface ethernet switch qos-group add name=group1 priority=1 Add UFDB entries to match specific MACs on ether7 and apply the QoS group1: /interface ethernet switch unicast-fdb add mac-address=E7:16:34:00:00:01 port=ether7 qos-group=group1 svl=yes add mac-address=E7:16:34:00:00:02 port=ether7 qos-group=group1 svl=yes Configure ether7 port queues to work according to Strict Priority and QoS scheme only for destination address: /interface ethernet switch port set ether7 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1 qos-scheme- precedence=da-based MAC-based traffic shaping using internal Priority

The scheme where MAC-based traffic shaping is done according to internal Priority would be following: [MAC address] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper]; In this example, unlimited traffic will have priority 0 and limited traffic will have priority 1 with a bandwidth limit of 10Mbit. Note that CRS has a maximum of 8 queues per port. Create a group of ports for switching: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create a QoS group for use in UFDB: /interface ethernet switch qos-group add name=group1 priority=1 Add UFDB entry to match specific MAC on ether8 and apply QoS group1: /interface ethernet switch unicast-fdb add mac-address=E7:16:34:A1:CD:18 port=ether8 qos-group=group1 svl=yes Configure ether8 port queues to work according to Strict Priority and QoS scheme only for destination address: /interface ethernet switch port set ether8 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1 qos-scheme- precedence=da-based Apply bandwidth limit for queue1 on ether8: /interface ethernet switch shaper add port=ether8 rate=10M target=queue1 If the CRS switch supports Access Control List, this configuration is simpler: /interface ethernet switch acl policer add name=policer1 yellow-burst=100k yellow-rate=10M /interface ethernet switch acl add mac-dst-address=E7:16:34:A1:CD:18 policer=policer1 VLAN-based traffic scheduling + shaping using internal Priorities The best practice is to assign lower internal QoS Priority for traffic limited by shaper to make it also less important in the Strict Priority scheduler. (higher priority should be more important and unlimited) In this example: Switch port ether6 is using a shaper to limit the traffic that comes from ether7 and ether8. When the link has reached its capacity, the traffic with the highest priority will be sent out first. VLAN10 -> QoS group0 = lowest priority VLAN20 -> QoS group1 = normal priority VLAN30 -> QoS group2 = highest priority

/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create QoS groups for use in the VLAN table. /interface ethernet switch qos-group add name=group0 priority=0 add name=group1 priority=1 add name=group2 priority=2 Add VLAN entries to apply QoS groups for certain VLANs. /interface ethernet switch vlan add ports=ether6,ether7,ether8 qos-group=group0 vlan-id=10 add ports=ether6,ether7,ether8 qos-group=group1 vlan-id=20 add ports=ether6,ether7,ether8 qos-group=group2 vlan-id=30 Configure ether6, ether7, and ether8 port queues to work according to Strict Priority and QoS schemes only for VLAN-based QoS. /interface ethernet switch port set ether6 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 qos-scheme- precedence=vlan-based set ether7 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 qos-scheme- precedence=vlan-based set ether8 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 qos-scheme- precedence=vlan-based Apply bandwidth limit on ether6. /interface ethernet switch shaper add port=ether6 rate=10M PCP-based traffic scheduling By default, CRS1xx/CRS2xx series devices will ignore the PCP/CoS/802.1p value and forward packets based on FIFO (First-In-First-Out) manner. When the device's internal queue is not full, then packets are sent in a FIFO manner, but as soon as a queue is filled, then higher-priority traffic can be sent out first. Let us consider a scenario when and are forwarding data to , but when is congested, then packets are going to be ether1 ether2 ether3 ether3 scheduled, we can configure the switch to hold the lowest priority packets until all higher priority packets are sent out, this is a very common scenario for VoIP type setups, where some traffic needs to be prioritized. To achieve such a behavior, switch together , and ports: ether1 ether2, ether3 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes Enable for each internal queue on each port: Strict Policy

/interface ethernet switch port set ether1,ether2,ether3 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0" Map each PCP value to an internal priority value, for convenience reasons simply map PCP to an internal priority 1-to-1: /interface ethernet switch port set ether1,ether2,ether3 pcp-based-qos-priority-mapping=0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7 Since the switch will empty the largest queue first and you need the highest priority to be served first, then you can assign this internal priority to a queue 1- to-1: /interface ethernet switch port set ether1,ether2,ether3 priority-to-queue=0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7 Finally, set each switch port to schedule packets based on the PCP value: /interface ethernet switch port set ether1,ether2,ether3 qos-scheme-precedence=pcp-based Bandwidth Limiting Both Ingress Port policer and Shaper provide bandwidth-limiting features for CRS switches. Ingress Port Policer sets RX limit on port: /interface ethernet switch ingress-port-policer add port=ether5 meter-unit=bit rate=10M Shaper sets TX limit on port: /interface ethernet switch shaper add port=ether5 meter-unit=bit rate=10M Traffic Storm Control The same Ingress Port policer also can be used for traffic storm control to prevent disruptions on Layer 2 ports caused by broadcast, multicast, or unicast traffic storms. Broadcast storm control example on ether5 port with 500 packet limit per second: /interface ethernet switch ingress-port-policer add port=ether5 rate=500 meter-unit=packet packet-types=broadcast Example with multiple packet types which includes ARP and ND protocols and unregistered multicast traffic. Unregistered multicast is traffic that is not defined in the Multicast Forwarding Database. /interface ethernet switch ingress-port-policer add port=ether5 rate=5k meter-unit=packet packet-types=broadcast,arp-or-nd,unregistered-multicast

See also CRS1xx/2xx series switches examples CRS Router CRS1xx/2xx VLANs with Trunks Basic VLAN switching Bridge Hardware Offloading Spanning Tree Protocol IGMP Snooping DHCP Snooping and Option 82 MTU on RouterBOARD Layer2 misconfiguration

CRS3xx, CRS5xx, CCR2116, CCR2216 VLANs with Bonds Summary Bonding Port switching Management IP Invalid VLAN filtering InterVLAN routing DHCP-Server Jumbo frames Summary This page will show how to configure multiple switches to use bonding interfaces and port-based VLANs, it will also show a working example with a DHCP- Server, inter-VLAN routing, management IP, and invalid VLAN filtering configuration. For this network topology, we will be using two CRS326-24G-2S+, one CRS317-1G-16S+, and one CCR1072-1G-8S+, but the same principles can be applied to any CRS3xx, CRS5xx series devices, and a router. In this setup, SwitchA and SwitchC will tag all traffic from ports ether1-ether8 to VLAN ID 10, ether9-ether16 to VLAN ID 20, and ether17-ether24 to VLAN ID 30. Management will only be possible if a user is connecting with tagged traffic with VLAN ID 99 from ether1 on SwitchA or SwitchB, connecting to all devices will also be possible from the router using tagged traffic with VLAN ID 99. The SFP+ ports in this setup are going to be used as VLAN trunk ports while being in a bond to create a LAG interface. Bonding This article applies to CRS3xx, CRS5xx, CCR2116, and CCR2216 devices. It doesn't apply to CRS1xx/CRS2xx series.

Bonding interfaces are used when a larger amount of bandwidth is required, this is done by creating a link aggregation group, which also provides hardware automatic failover and load balancing for switches. By adding two 10Gbps interfaces to bonding, you can increase the theoretical bandwidth limit to 20Gbps. Make sure that all bonded interfaces are linked to the same speed rates. To create a 20Gbps bonding interface from sfp-sfpplus1 and sfp-sfpplus2 between SwitchA to SwitchB and between SwitchC to SwitchB, use these commands on and : SwitchA SwitchC /interface bonding add mode=802.3ad name=bond_1-2 slaves=sfp-sfpplus1,sfp-sfpplus2 To create a 40Gbps bonding interface between SwitchB and the Router and a 20Gbps bonding interface between SwitchA and SwitchC, use these commands on : SwitchB /interface bonding add mode=802.3ad name=bond_1-2 slaves=sfp-sfpplus1,sfp-sfpplus2 add mode=802.3ad name=bond_3-4 slaves=sfp-sfpplus3,sfp-sfpplus4 add mode=802.3ad name=bond_5-6-7-8 slaves=sfp-sfpplus5,sfp-sfpplus6,sfp-sfpplus7,sfp-sfpplus8 In our case the Router needs a software-based bonding interface, use these commands on : the Router /interface bonding add mode=802.3ad name=bond_1-2-3-4 slaves=sfp-sfpplus1,sfp-sfpplus2,sfp-sfpplus3,sfp-sfpplus4 Port switching All switches in this setup require that all used ports are switched together. For bonding, you should add the bonding interface as a bridge port, instead of individual bonding ports. Use these commands on and : SwitchA SwitchC CRS3xx, CRS5xx, CCR2116, and CCR2216 devices aggregate traffic using the built-in switch When using the hardware-offloaded bridge, the chip without using CPU resources. To route the traffic a router with a powerful CPU is required to handle the aggregated traffic. Interface bonding does not create an interface with a larger link speed. Interface bonding creates a virtual interface that can load balance traffic over multiple interfaces. More details can be found on the LAG interfaces and load balancing page.

/interface bridge add name=bridge vlan-filtering=no /interface bridge port add bridge=bridge interface=ether1 pvid=10 add bridge=bridge interface=ether2 pvid=10 add bridge=bridge interface=ether3 pvid=10 add bridge=bridge interface=ether4 pvid=10 add bridge=bridge interface=ether5 pvid=10 add bridge=bridge interface=ether6 pvid=10 add bridge=bridge interface=ether7 pvid=10 add bridge=bridge interface=ether8 pvid=10 add bridge=bridge interface=ether9 pvid=20 add bridge=bridge interface=ether10 pvid=20 add bridge=bridge interface=ether11 pvid=20 add bridge=bridge interface=ether12 pvid=20 add bridge=bridge interface=ether13 pvid=20 add bridge=bridge interface=ether14 pvid=20 add bridge=bridge interface=ether15 pvid=20 add bridge=bridge interface=ether16 pvid=20 add bridge=bridge interface=ether17 pvid=30 add bridge=bridge interface=ether18 pvid=30 add bridge=bridge interface=ether19 pvid=30 add bridge=bridge interface=ether20 pvid=30 add bridge=bridge interface=ether21 pvid=30 add bridge=bridge interface=ether22 pvid=30 add bridge=bridge interface=ether23 pvid=30 add bridge=bridge interface=ether24 pvid=30 add bridge=bridge interface=bond_1-2 Add all bonding interfaces to a single bridge on SwitchB by using these commands on : SwitchB /interface bridge add name=bridge vlan-filtering=no /interface bridge port add bridge=bridge interface=bond_1-2 add bridge=bridge interface=bond_3-4 add bridge=bridge interface=bond_5-6-7-8 Management IP It is very useful to create a management interface and assign an IP address to it to preserve access to the switch. This is also very useful when updating your switches since such traffic to the switch will be blocked when enabling invalid VLAN filtering. Create a routable VLAN interface on , and : SwitchA SwitchB, SwitchC /interface vlan add interface=bridge name=MGMT vlan-id=99 The Router needs a routable VLAN interface to be created on the bonding interface, use these commands to create a VLAN interface on : the Router /interface vlan add interface=bond_1-2-3-4 name=MGMT vlan-id=99 For this guide, we are going to use these addresses for each device: Device Address Router 192.168.99.1 SwitchA 192.168.99.2

SwitchB 192.168.99.3 SwitchC 192.168.99.4 Add an IP address for each switch device on the VLAN interface (change X to the appropriate number): /ip address add address=192.168.99.X/24 interface=MGMT Do not forget to add the default gateway and specify a DNS server on the switch devices: /ip route add gateway=192.168.99.1 /ip dns set servers=192.168.99.1 Add the IP address on the : Router /ip address add address=192.168.99.1/24 interface=MGMT Invalid VLAN filtering Since most ports on SwitchA and SwitchC are going to be access ports, you can set all ports to accept only certain types of packets, in this case, we will want SwitchA and SwitchC to only accept untagged packets, use these commands on and : SwitchA SwitchC /interface bridge port set [ find ] frame-types=admit-only-untagged-and-priority-tagged There is an exception for frame types on SwitchA and SwitchC, in this setup access to the management is required from ether1 and bonding interfaces, they require that tagged traffic can be forwarded. Use these commands on and : SwitchA SwitchC /interface bridge port set [find where interface=ether1] frame-types=admit-all set [find where interface=bond_1-2] frame-types=admit-only-vlan-tagged On SwitchB only tagged packets should be forwarded, use these commands on : SwitchB /interface bridge port set [ find ] frame-types=admit-only-vlan-tagged An optional step is to set on the bridge interface to disable the default untagged VLAN 1 ( ). We are frame-types=admit-only-vlan-tagged pvid=1 using the tagged VLAN on the bridge for management access, so there is no need to accept untagged traffic on the bridge. Use these commands on the S , and : witchA SwitchB SwitchC /interface bridge set [find name=bridge] frame-types=admit-only-vlan-tagged It is required to set up a bridge VLAN table. In this network setup, we need to allow VLAN 10 on ether1-ether8, VLAN 20 on ether9-ether16, VLAN 30 on ether17-ether24, VLAN 10,20,30,99 on bond_1-2, and a special case for ether1 to allow to forward VLAN 99 on SwitchA and SwitchC. Use these commands on SwitchA and SwitchC :

/interface bridge vlan add bridge=bridge tagged=bond_1-2 vlan-ids=10 add bridge=bridge tagged=bond_1-2 vlan-ids=20 add bridge=bridge tagged=bond_1-2 vlan-ids=30 add bridge=bridge tagged=bridge,bond_1-2,ether1 vlan-ids=99 Similarly, it is required to set up a bridge VLAN table for SwitchB. Use these commands on : SwitchB /interface bridge vlan add bridge=bridge tagged=bond_1-2,bond_3-4,bond_5-6-7-8 vlan-ids=10,20,30 add bridge=bridge tagged=bond_1-2,bond_3-4,bond_5-6-7-8,bridge vlan-ids=99 When everything is configured, VLAN filtering can be enabled. Use these commands on , and : SwitchA SwitchB, SwitchC /interface bridge set bridge vlan-filtering=yes InterVLAN routing To create InterVLAN routing, the VLAN interface for each customer VLAN ID must be created on the router and must have an IP address assigned to it. The VLAN interface must be created on the bonding interface created previously. Use these commands on the : Router /interface vlan add interface=bond_1-2-3-4 name=VLAN10 vlan-id=10 add interface=bond_1-2-3-4 name=VLAN20 vlan-id=20 add interface=bond_1-2-3-4 name=VLAN30 vlan-id=30 /ip address add address=192.168.10.1/24 interface=VLAN10 add address=192.168.20.1/24 interface=VLAN20 add address=192.168.30.1/24 interface=VLAN30 DHCP-Server Bridge ports with frame-types set to or admit-all admit-only-untagged-and-priority-tagged will be automatically added as untagged ports for the pvid VLAN. Double-check if port-based VLANs are set up properly. If a mistake was made, you might lose access to the switch and it can only be regained by resetting the configuration or by using the serial console. VLAN filtering is described more in the section. Bridge VLAN Filtering These commands are required for DHCP-Server. In case interVLAN routing is not desired but a DHCP-Server on a single router is required, then use Firewall Filter to block access between different subnets. Since RouterOS v7, it is possible to route traffic using the L3 HW offloading on certain devices. See more details on . L3 Hardware Offloading

To get the DHCP-Server working for each VLAN ID, the server must be set up on the previously created VLAN interfaces (one server for each VLAN ID). Preferably each VLAN ID should have its own subnet and its own IP pool. A DNS Server could be specified as the router's IP address for a particular VLAN ID or a global DNS Server could be used, but this address must be reachable. To set up the DHCP-Server, use these commands on the : Router /ip pool add name=VLAN10_POOL ranges=192.168.10.100-192.168.10.200 add name=VLAN20_POOL ranges=192.168.20.100-192.168.20.200 add name=VLAN30_POOL ranges=192.168.30.100-192.168.30.200 /ip dhcp-server add address-pool=VLAN10_POOL disabled=no interface=VLAN10 name=VLAN10_DHCP add address-pool=VLAN20_POOL disabled=no interface=VLAN20 name=VLAN20_DHCP add address-pool=VLAN30_POOL disabled=no interface=VLAN30 name=VLAN30_DHCP /ip dhcp-server network add address=192.168.10.0/24 dns-server=192.168.10.1 gateway=192.168.10.1 add address=192.168.20.0/24 dns-server=192.168.20.1 gateway=192.168.20.1 add address=192.168.30.0/24 dns-server=192.168.30.1 gateway=192.168.30.1 In case the router's DNS Server is being used, don't forget to allow remote requests and make sure DNS Servers are configured on the router. Use these commands on the : Router /ip dns set allow-remote-requests=yes servers=8.8.8.8 Don't forget to create NAT, assuming that sfp-sfpplus8 is used as WAN port, use these commands on the : Router /ip firewall nat add action=masquerade chain=srcnat out-interface=sfp-sfpplus8 Jumbo frames One can increase the total throughput in such a setup by enabling jumbo frames. This reduces the packet overhead by increasing the Maximum Transmission Unit (MTU). If a device in your network does not support jumbo frames, then it will not benefit from a larger MTU. Usually, the whole network does not support jumbo frames, but you can still benefit when sending data between devices that support jumbo frames, including all switches in the path. In this case, if clients behind SwitchA and client behind SwitchC support jumbo frames, then enabling jumbo frames will be beneficial. Before enabling jumbo frames, determine the MAX-L2MTU by using this command: [admin@SwitchA] > interface print Flags: R - RUNNING Columns: NAME, TYPE, ACTUAL-MTU, L2MTU, MAX-L2MTU, MAC-ADDRESS # NAME TYPE ACTUAL-MTU L2MTU MAX-L2MTU MAC-ADDRESS 1 R sfp-sfpplus1 ether 1500 1584 10218 64:D1:54:FF:E3:7F When MAX-L2MTU is determined, choose the MTU size depending on the traffic on your network, use this command on , and : SwitchA SwitchB, SwitchC /interface ethernet set [ find ] l2mtu=10218 mtu=10218 Make sure to secure your local DNS Server with Firewall from the outside when using allow-remote-requests set to yes since your DNS Server can be used for DDoS attacks if it is accessible from the Internet by anyone. More information can be found in MTU manual page.

Don't forget to change the MTU on your client devices too, otherwise, the above-mentioned settings will not have any effect.

Layer2 misconfiguration Introduction Bridges on a single switch chip Configuration Problem Symptoms Solution Packet flow with hardware offloading and MAC learning Configuration Problem Symptoms Solution LAG interfaces and load balancing Configuration Problem Symptoms Solution VLAN interface on a slave interface Configuration Problem Symptoms Solution VLAN on a bridge in a bridge Configuration Problem Symptoms Solution VLAN in a bridge with a physical interface Configuration Problem Symptoms Solution Bridged VLAN on physical interfaces Configuration Problem Symptoms Solution Bridged VLAN Configuration Symptoms Solution Bridge VLAN filtering on non-CRS3xx Configuration Problem Symptoms Solution VLAN filtering with multiple switch chips Configuration Problem Symptoms Solution VLAN filtering with simplified bridge VLAN table Configuration Problem Symptoms Solution MTU on the master interface Configuration Problem Symptoms Solution MTU inconsistency

Configuration Problem Symptoms Solution Bridge and reserved MAC addresses Configuration Problem Symptoms Solution Bonding between Wireless links Configuration Problem Symptoms Solution Bandwidth testing Problem Symptoms Solution Bridge split-horizon usage Configuration Problem Symptoms Solution Unsupported SFP modules Problem Symptoms Solution Introduction There are certain configurations that are known to have major flaws by design and should be avoided by all means possible. Misconfigured Layer2 can sometimes cause hard to detect network errors, random performance drops, certain segments of a network to be unreachable, certain networking services to be malfunctioning, or a complete network failure. This page will contain some common and not so very common configurations that will cause issues in your network. Bridges on a single switch chip Consider the following scenario, you have a device with a built-in switch chip and you need to isolate certain ports from each other, for this reason, you have created multiple bridges and enabled hardware offloading on them. Since each bridge is located on a different Layer2 domain, then Layer2 frames will not be forwarded between these bridges, as a result, ports in each bridge are isolated from other ports on a different bridge. Configuration /interface bridge add name=bridge1 add name=bridge2 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge2 interface=ether3 add bridge=bridge2 interface=ether4 Problem After a simple performance test, you might notice that one bridge is capable of forwarding traffic at wire speed while the second, third, etc. bridge is not able to forward as much data as the first bridge. Another symptom might be that there exists a huge latency for packets that need to be routed. After a quick inspection, you might notice that the CPU is always at full load, this is because hardware offloading is not available on all bridges, but is available only on one bridge. By checking the hardware offloading status you will notice that only one bridge has it active:

For this device, each Ethernet port is connected to the switch chip and the switch chip is connected to the CPU using the CPU port (sometimes called the s port). For packets to be visible in Sniffer or Torch tools, the packet must be sent from an Ethernet port to the CPU port, this means that the witch-cpu packet must be destined to the CPU port (destination MAC address of the packet matches the bridge's MAC address) or the packet's MAC address has not be learnt (packet is flooded to all ports), this behavior is because of · MAC learning The switch chip keeps a list of MAC addresses and ports called the · Whenever a packet needs to be forwarded, the switch chip checks the Host table packet's destination MAC address against the hosts table to find which port should it use to forward the packet. If the switch chip cannot find the destination MAC address, then the packet is flooded to all ports (including the CPU port). In situations where a packet is supposed to be forwarded from, for example, ether1 to ether2 and the MAC address for the device behind ether2 is in the host table, then the packet is never sent to the CPU and therefore will not be visible to Sniffer orTorch tool. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Packets not visible by Sniffer orTorch tool Filter rules not working Solution Packets with a destination MAC address that has been learned will not be sent to the CPU since the packets are not being flooded to all ports. If you do need to send certain packets to the CPU for a packet analyzer or a firewall, then it is possible to copy or redirect the packet to the CPU by using ACL rules. Below is an example of how to send a copy of packets that are meant for : 4C:5E:0C:4D:12:4B

/interface ethernet switch rule add copy-to-cpu=yes dst-mac-address=4C:5E:0C:4D:12:4B/FF:FF:FF:FF:FF:FF ports=ether1 switch=switch1 LAG interfaces and load balancing Consider the following scenario, you have created a LAG interface to increase total bandwidth between 2 network nodes, usually, these are switches. For testing purposes to make sure that the LAG interface is working properly you have attached two servers that transfer data, most commonly the well-known network performance measurement tool is used to test such setups. For example, you might have made a LAG interface https://en.wikipedia.org/wiki/Iperf out of two Gigabit Ethernet ports, which gives you a virtual interface that can load balance traffic over both interfaces and theoretically reach 2Gbps while the servers are connected using a 10Gbps interface, for example, SFP+. throughput, Configuration The following configuration is relevant to and : SW1 SW2 /interface bonding add mode=802.3ad name=bond1 slaves=ether1,ether2 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=bond1 add bridge=bridge1 interface=sfp-sfpplus1 Problem After initial tests, you immediately notice that your network throughput never exceeds the 1Gbps limit even though the CPU load on the servers is low as well as on the network nodes (switches in this case), but the throughput is still limited to only 1Gbps. The reason behind this is because LACP (802.ad) uses transmit hash policy in order to determine if traffic can be balanced over multiple LAG members, in this case, a LAG interface does not create a 2Gbps interface, but rather an interface that can balance traffic over multiple slave interface whenever it is possible. For each packet a transmit hash is generated, this determines through which LAG member will the packet be sent, this is needed in order to avoid packets being out of order, there is an option to select the transmit hash policy, usually, there is an option to choose between Layer2 (MAC), Layer3 (IP) and Layer4 (Port), in RouterOS, this can be selected by using the parameter. In this case, the transmit hash is the same since you are sending packets to the same transmit-hash-policy destination MAC address, as well as the same IP address and Iperf uses the same port as well, this generates the same transmit hash for all packets and load balancing between LAG members is not possible. Note that not always packets will get balanced over LAG members even though the destination is different, this is because the standardized transmit hash policy can generate the same transmit hash for different destinations, for example, 192.168.0.1 /192.168.0.2 will get balanced, but 192.168.0.2/192.168.0.4 will get balanced in case transmit hash policy is used and the NOT layer2-and-3 destination MAC address is the same. If the packet is sent to the CPU, then the packet must be processed by the CPU, this increases the CPU load.

Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Traffic going through only one LAG member Solution Choose the proper transmit hash policy and test your network's throughput properly. The simplest way to test such setups is to use multiple destinations, for example, instead of sending data to just one server, rather send data to multiple servers, this will generate a different transmit hash for each packet and will make load balancing across LAG members possible. For some setups, you might want to change the bonding interface mode to increase the total throughput, for UDP traffic mode might be sufficient, but can cause issues for TCP traffic, you can read more about selecting the right mode balance-rr for your setup . here VLAN interface on a slave interface Consider the following scenario, you have created a bridge and you want a DHCP Server to give out IP addresses only to a certain tagged VLAN traffic, for this reason, you have created a VLAN interface, specified a VLAN ID and created a DHCP Server on it, but for some reason, it is not working properly. Configuration /interface bridge add name=bridge1 /interface bridge port add interface=ether1 bridge=bridge1 add interface=ether2 bridge=bridge1 /interface vlan add name=VLAN99 interface=ether1 vlan-id=99 /ip pool add name=VLAN99_POOL range=192.168.99.100-192.168.99.200 /ip address add address=192.168.99.1/24 interface=VLAN99 /ip dhcp-server add interface=VLAN99 address-pool=VLAN99_POOL disabled=no /ip dhcp-server network add address=192.168.99.0/24 gateway=192.168.99.1 dns-server=192.168.99.1 Problem When you add an interface to a bridge, the bridge becomes the master interface and all bridge ports become slave ports, this means that all traffic that is received on a bridge port is captured by the bridge interface and all traffic is forwarded to the CPU using the bridge interface instead of the physical interface. As a result VLAN interface that is created on a slave interface will never capture any traffic at all since it is immediately forwarded to the master interface before any packet processing is being done. The usual side effect is that some DHCP clients receive IP addresses and some don't. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: DHCP Client/Server not working properly; Device is unreachable; The device behind a bridge is unreachable with tagged traffic; Solution Change the interface on which the VLAN interface will be listening for traffic, change it to the master interface: /interface vlan set VLAN99 interface=bridge1

VLAN on a bridge in a bridge Consider the following scenario, you have a set of interfaces (don't have to be physical interfaces) and you want all of them to be in the same Layer2 segment, the solution is to add them to a single bridge, but you require that traffic from one port tags all traffic into a certain VLAN. This can be done by creating a VLAN interface on top of the bridge interface and by creating a separate bridge that contains this newly created VLAN interface and an interface, which is supposed to add a VLAN tag to all received traffic. A network diagram can be found below: Configuration /interface bridge add name=bridge1 add name=bridge2 /interface vlan add interface=bridge1 name=VLAN vlan-id=99 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge2 interface=VLAN add bridge=bridge2 interface=ether3 Problem To better understand the underlying problems, let's first look at the bridge host table. [admin@switch] /interface bridge host print where !local Flags: X - disabled, I - invalid, D - dynamic, L - local, E - external # MAC-ADDRESS VID ON-INTERFACE BRIDGE 0 D CC:2D:E0:E4:B3:A1 ether1 bridge1 1 D CC:2D:E0:E4:B3:A2 ether2 bridge1 2 D CC:2D:E0:E4:B3:A1 VLAN bridge2 3 D CC:2D:E0:E4:B3:A2 VLAN bridge2 4 D CC:2D:E0:E4:B3:A3 ether3 bridge2 Devices on and need to send tagged packets with VLAN-ID 99 in order to reach the host on (other packets do not get passed towards ether1 ether2 ether3 VLAN interface and further bridged with ether3). We can see in the host table that has learned these hosts. Packets coming from to w bridge2 ether3 ether1 ill be correctly sent out tagged and traffic will not be flooded in . But since MAC learning is only possible between bridge ports and not on interfaces bridge1 that are created on top of the bridge interface, packets sent from to will be flooded in . ether2 ether3 bridge1 Also if a device behind is using (R)STP, then and will send out tagged BPDUs which violates the IEEE 802.1W standard. Because of ether3 ether1 ether2 the broken MAC learning functionality and broken (R)STP this setup and configuration must be avoided. It is also known that in some setups this kind of configuration can prevent you from connecting to the device by using MAC telnet. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Port blocked by RSTP Loops in network

Port flapping Traffic is flooded to all ports MAC telnet is unable to connect Device inaccessible Solution Use bridge VLAN filtering. The proper way to tag traffic is to assign a VLAN ID whenever traffic enters a bridge, this behavior can easily be achieved by specifying value for a bridge port and specifying which ports are (trunk) ports and which are (access) ports. Below is an example of PVID tagged untagged how such a setup should have been configured: /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 pvid=99 /interface bridge vlan add bridge=bridge1 tagged=ether1,ether2 untagged=ether3 vlan-ids=99 VLAN in a bridge with a physical interface Very similar case to . The most popular use case is when you want to bridge a physical interface with a VLAN (simplified trunk VLAN on a bridge in a bridge /access port setup). In such setup you might want to send out tagged traffic on one side and untagged on the other side. To acomplish this, you create a VLAN interface on the trunk port (the tagged side), then create a bridge and add both the VLAN interface and the physical interface (the untagged side) as bridge ports. Configuration /interface vlan add interface=ether1 name=VLAN99 vlan-id=99 /interface bridge add name=bridge1 /interface bridge port add interface=ether2 bridge=bridge1 add interface=VLAN99 bridge=bridge1 Problem This setup and configuration will work in most cases, but it violates the IEEE 802.1W standard when (R/M)STP is used. If this is the only device in your Layer2 domain, then this should not cause problems, but problems can arise when there are other vendor switches. The reason for this is that RSTP on a bridge interface is enabled by default, allowing Bridge Protocol Data Units (BPDUs) to be sent from each bridge port. While transmits BPDUs ether2 correctly without tagging, interface, being a bridge port, sends tagged BPDUs over ether1. Not all switches can understand tagged VLAN99 BPDUs. Precautions should be made with this configuration in a more complex network where there are multiple network topologies for certain (group of) VLANs, this is relevant to MSTP and PVSTP(+) with mixed vendor devices. In a ring-like topology with multiple network topologies for certain VLANs, one port from the switch will be blocked, but in MSTP and PVSTP(+) a path can be opened for a certain VLAN, in such a situation it is possible that devices that don't support PVSTP(+) will untag the BPDUs and forward the BPDU, as a result, the switch will receive its own packet, trigger a loop detection and block a port, this can happen to other protocols as well, but (R)STP is the most common case. If a switch is using a BPDU guard function, then this type of configuration can trigger it and cause a port to be blocked by STP. It has been reported that this type of configuration can prevent traffic from being forwarded over certain bridge ports over time when using 6.41 or later. This type of configuration does not only break (R/M)STP, but it can cause loop warnings, this can be caused by MNDP packets or any other packets that are directly sent out from an interface. By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port

Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Port blocked by RSTP Loops in network Port flapping Traffic stops forwarding over time BPDUs ignored by other RSTP enabled devices Solution To avoid compatibility issues you should use bridge VLAN filtering. Below you can find an example of how the same traffic tagging effect can be achieved with a bridge VLAN filtering configuration: /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 pvid=99 /interface bridge vlan add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=99 Bridged VLAN on physical interfaces A very similar case to , consider the following scenario, you have a couple of switches in your network and you are using VLAN on a bridge in a bridge VLANs to isolate certain Layer2 domains and connect these switches to a router that assigns addresses and routes the traffic to the world. For redundancy, you connect all switches directly to the router and have enabled RSTP, but to be able to setup DHCP Server you decide that you can create a VLAN interface for each VLAN on each physical interface that is connected to a switch and add these VLAN interfaces in a bridge. A network diagram can be found below: By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port

Configuration Only the router part is relevant to this case, switch configuration doesn't really matter as long as ports are switched. Router configuration can be found below: /interface bridge add name=bridge10 add name=bridge20 /interface vlan add interface=ether1 name=ether1_v10 vlan-id=10 add interface=ether1 name=ether1_v20 vlan-id=20 add interface=ether2 name=ether2_v10 vlan-id=10 add interface=ether2 name=ether2_v20 vlan-id=20 /interface bridge port add bridge=bridge10 interface=ether1_v10 add bridge=bridge10 interface=ether2_v10 add bridge=bridge20 interface=ether1_v20 add bridge=bridge20 interface=ether2_v20 Problem You might notice that the network is having some weird delays or even the network is unresponsive, you might notice that there is a loop detected (packet received with own MAC address) and some traffic is being generated out of nowhere. The problem occurs because a broadcast packet that is coming from either one of the VLAN interface created on the will be sent out the physical interface, packet will be forwarded through the physical interface, Router through a switch and will be received back on a different physical interface, in this case, broadcast packets sent out will be received on , ether1_v10 ether2 packet will be captured by , which is bridged with and will get forwarded again the same path (loop). (R)STP might not always ether2_v10 ether1_v10 detect this loop since (R)STP is not aware of any VLANs, a loop does not exist with untagged traffic, but exists with tagged traffic. In this scenario, it is quite obvious to spot the loop, but in more complex setups it is not always easy to detect the network design flaw. Sometimes this network design flaw might get unnoticed for a very long time if your network does not use broadcast traffic, usually, is broadcasting packets from Neighbor Discovery Protocol the VLAN interface and will usually trigger a loop detection in such a setup. Sometimes it is useful to capture the packet that triggered a loop detection, this can by using sniffer and analyzing the packet capture file: /tool sniffer set filter-mac-address=4C:5E:0C:4D:12:44/FF:FF:FF:FF:FF:FF \ filter-interface=ether1 filter-direction=rx file-name=loop_packet.pcap Or a more convenient way using logging: /interface bridge filter add action=log chain=forward src-mac-address=4C:5E:0C:4D:12:44/FF:FF:FF:FF:FF:FF add action=log chain=input src-mac-address=4C:5E:0C:4D:12:44/FF:FF:FF:FF:FF:FF Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Port blocked by (R)STP; Loops in network; Low throughput; Port flapping; Network inaccessible; Solution A solution is to use bridge VLAN filtering in order to make all bridges compatible with IEEE 802.1W and IEEE 802.1Q.

/interface bridge add name=bridge vlan-filtering=yes /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 /interface bridge vlan add bridge=bridge tagged=ether1,ether2,bridge vlan-ids=10 add bridge=bridge tagged=ether1,ether2,bridge vlan-ids=20 /interface vlan add name=vlan10 interface=bridge vlan-id=10 add name=vlan20 interface=bridge vlan-id=20 Bridged VLAN A more simplified scenario of , but in this case, you simply want to bridge two or more VLANs together that are Bridged VLAN on physical interfaces created on different physical interfaces. This is a very common type of setup that deserves a separate article since misconfiguring this type of setup has caused multiple network failures. This type of setup is also used for VLAN translation. Configuration /interface vlan add interface=ether1 name=ether1_v10 vlan-id=10 add interface=ether2 name=ether2_v10 vlan-id=10 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1_v10 add bridge=bridge1 interface=ether2_v10 Problem You may notice that certain parts of the network are not accessible and/or certain links keep flapping. This is due to (R)STP, this type of configuration forces the device to send out tagged BPDUs, that might not be supported by other devices, including RouterOS. Since a device receives a malformed packet (tagged BPDUs should not exist in your network when running (R)STP, this violates IEEE 802.1W and IEEE 802.1Q), the device will not interpret the packet correctly and can have unexpected behavior. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Port blocked by (R)STP; Port flapping; Network inaccessible; Solution The easiest solution is to simply disable (R)STP on the bridge: /interface bridge set bridge1 protocol-mode=none By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port

though it is still recommended to rewrite your configuration to use bridge VLAN filtering: /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 /interface bridge vlan add bridge=bridge1 tagged=ether1,ether2 vlan-ids=10 Bridge VLAN filtering on non-CRS3xx Consider the following scenario, you found out the new bridge VLAN filtering feature and you decided to change the configuration on your device, you have a very simple trunk/access port setup and you like the concept of bridge VLAN filtering. Configuration /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 pvid=20 add bridge=bridge1 interface=ether3 pvid=30 add bridge=bridge1 interface=ether4 pvid=40 /interface bridge vlan add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=20 add bridge=bridge1 tagged=ether1 untagged=ether3 vlan-ids=30 add bridge=bridge1 tagged=ether1 untagged=ether4 vlan-ids=40 Problem For example, you use this configuration on a CRS1xx/CRS2xx series device and you started to notice that the CPU usage is very high and when running a performance test to check the network's throughput you notice that the total throughput is only a fraction of the wire-speed performance that it should easily reach. The cause of the problem is that not all devices support bridge VLAN filtering on a hardware level. All devices are able to be configured with bridge VLAN filtering, but only a few of them will be able to offload the traffic to the switch chip. If an improper configuration method is used on a device with a built-in switch chip, then the CPU will be used to forward the traffic. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Missing "H" flag on bridge ports Low throughput High CPU usage Solution Before using bridge VLAN filtering check if your device supports it at the hardware level, a table with compatibility can be found at the Bridge Hardware section. Each type of device currently requires a different configuration method, below is a list of which configuration should be used on a Offloading device in order to use the benefits of hardware offloading: By enabling you will be filtering out traffic destined to the CPU, before enabling VLAN filtering you should make sure that you vlan-filtering set up a . Management port

CRS3xx series devices CRS1xx/CRS2xx series devices Other devices with a switch chip VLAN filtering with multiple switch chips Consider the following scenario, you have a device with two or more switch chips and you have decided to use a single bridge and set up VLAN filtering (by using the menu) on a hardware level to be able to reach wire-speed performance on your network. This is very /interface ethernet switch relevant for RB2011 and RB3011 series devices. In this example, let's assume that you want to have a single trunk port and all other ports are access ports, for example, is our trunk port and are our access ports. ether10 ether1-ether9 Configuration /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 add bridge=bridge1 interface=ether4 add bridge=bridge1 interface=ether5 add bridge=bridge1 interface=ether6 add bridge=bridge1 interface=ether7 add bridge=bridge1 interface=ether8 add bridge=bridge1 interface=ether9 add bridge=bridge1 interface=ether10 /interface vlan add interface=bridge1 name=VLAN10 vlan-id=10 /interface ethernet switch port set ether1,ether2,ether3,ether4,ether5,ether6,ether7,ether8,ether9 default-vlan-id=10 vlan-header=always-strip vlan-mode=secure set ether10 vlan-header=add-if-missing vlan-mode=secure set switch1-cpu,switch2-cpu vlan-mode=secure /interface ethernet switch vlan add ports=ether1,ether2,ether3,ether4,ether5,switch1-cpu switch=switch1 vlan-id=10 add ports=ether6,ether7,ether8,ether9,ether10,switch2-cpu switch=switch2 vlan-id=10 Problem After running a few tests you might notice that packets from are forwarded as expected, but packets from are not always ether6-ether10 ether1-ether5 forwarded correctly (especially through the trunk port). The most noticeable issue would be that packets from through are simply ether1-ether5 ether10 dropped, this is because these ports are located on different switch chip, this means that VLAN filtering is not possible on a hardware level since the switch chip is not aware of the VLAN table's contents on a different switch chip. Packets that are being forwarded between ports that are located on different switch chips are also processed by the CPU, which means you won't be able to achieve wire-speed performance. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Packets being dropped; Low throughput; Solution The proper solution is to take into account this hardware design and plan your network topology accordingly. To solve this issue you must create two separate bridges and configure VLAN filtering on each switch chip, this limits the possibility to forward packets between switch chip, though it is possible to configure routing between both bridges (if devices that are connected on each switch chip are using different network subnets).

There is a way to configure the device to have all ports switch together and yet be able to use VLAN filtering on a hardware level, though this solution has some caveats. The idea is to sacrifice a single Ethernet port on each switch chip that will act as a trunk port to forward packets between switch chip, this can be done by plugging an Ethernet cable between both switch chip, for example, lets plug in an Ethernet cable between and then ether5 ether6 reconfigure your device assuming that these ports are trunk ports: /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 add bridge=bridge1 interface=ether4 add bridge=bridge1 interface=ether5 add bridge=bridge2 interface=ether6 add bridge=bridge2 interface=ether7 add bridge=bridge2 interface=ether8 add bridge=bridge2 interface=ether9 add bridge=bridge2 interface=ether10 /interface ethernet switch port set ether1,ether2,ether3,ether4,ether7,ether8,ether9 default-vlan-id=10 vlan-header=always-strip vlan- mode=secure set ether5,ether6,ether10 vlan-header=add-if-missing vlan-mode=secure default-vlan-id=auto set switch1-cpu,switch2-cpu vlan-mode=secure /interface ethernet switch vlan add ports=ether1,ether2,ether3,ether4,ether5,switch1-cpu switch=switch1 vlan-id=10 add ports=ether6,ether7,ether8,ether9,ether10,switch2-cpu switch=switch2 vlan-id=10 VLAN filtering with simplified bridge VLAN table You need to create a network setup where multiple clients are connected to separate access ports and isolated by different VLANs, this traffic should be tagged and sent to the appropriate trunk port. Access ports are configured using a pvid property. As the trunk port is used on both VLANs, you decided to simplify configuration by adding a single bridge VLAN table entry and separate VLANs by a comma. This is especially useful when tagged trunk ports are used across large numbers of VLANs or even certain VLAN ranges (e.g. vlan-id=100-200). See a network diagram and configuration below. Configuration For 100Mbps switch chips, use instead of default-vlan-id=0 default-vlan-id=auto This issue has been resolved since . Dynamic VLANs are now always created as separate entries and no longer merge with RouterOS v7.15 statically configured ones.

/interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 pvid=10 add bridge=bridge1 interface=ether4 pvid=20 /interface bridge vlan add bridge=bridge1 tagged=ether2 vlan-ids=10,20 Problem Traffic is correctly forwarded and tagged from access ports to trunk port, but you might notice that some broadcast or multicast packets are actually flooded between both untagged access ports, although they should be on different VLANs. Furthermore, broadcast and multicast traffic from the tagged port is also flooded to both access ports. This might raise some security concerns as traffic from different networks can be sniffed. When you look at the bridge VLAN table, you notice that a single entry has been created for VLANs 10 and 20, and both untagged ports are part of the same VLAN group. [admin@SW1] /interface bridge vlan print where tagged=ether2 Columns: BRIDGE, VLAN-IDS, CURRENT-TAGGED, CURRENT-UNTAGGED # BRIDGE VLAN-IDS CURRENT-TAGGED CURRENT-UNTAGGED ;;; port with pvid added to untagged group which might cause problems, consider adding a separate VLAN entry 0 bridge1 10 ether2 ether3 20 ether4 Symptoms Traffic is flooded between different VLANs Red warning: port with pvid added to untagged group which might cause problems, consider adding a separate VLAN entry Solution When access ports have been configured using the pvid property, they get dynamically added to the appropriate VLAN entry. After creating a static VLAN entry with multiple VLANs or VLAN range, the untagged access port with a matching pvid also gets included in the same VLAN group or range. It might be useful to define a large number of VLANs using a single configuration line, but extra caution should be taken when access ports are configured. For this example, separate VLAN entries should be created: /interface bridge vlan add bridge=bridge1 tagged=ether2 untagged=ether3 vlan-ids=10 add bridge=bridge1 tagged=ether2 untagged=ether4 vlan-ids=20 MTU on the master interface Consider the following scenario, you have created a bridge, added a few interfaces to it and have created a VLAN interface on top of the bridge interface, but you need to increase the MTU size on the VLAN interface in order to receive larger packets. Configuration /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 /interface vlan add interface=bridge1 name=VLAN99 vlan-id=99

Problem As soon as you try to increase the MTU size on the VLAN interface, you receive an error that RouterOS . This can happen when you Could not set MTU are trying to set MTU larger than the L2MTU. In this case, you need to increase the L2MTU size on all slave interfaces, which will update the L2MTU size on the bridge interface. After this has been done, you will be able to set a larger MTU on the VLAN interface. The same principle applies to bond interfaces. You can increase the MTU on interfaces like VLAN, MPLS, VPLS, Bonding and other interfaces only when all physical slave interfaces have proper L2MTU set. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Cannot change MTU Solution Increase the L2MTU on slave interfaces before changing the MTU on a master interface. /interface ethernet set ether1,ether2 l2mtu=9018 /interface vlan set VLAN99 mtu=9000 MTU inconsistency Consider the following scenario, you have multiple devices in your network, most of them are used as a switch/bridge in your network and there are certain endpoints that are supposed to receive and process traffic. To decrease the overhead in your network, you have decided to increase the MTU size so you set a larger MTU size on both endpoints, but you start to notice that some packets are being dropped. Configuration In this case, both endpoints can be any type of device, we will assume that they are both Linux servers that are supposed to transfer a large amount of data. In such a scenario, you would have probably set interface MTU to 9000 on and nd on your you have probably have set ServerA ServerB a Switch something similar to this: /interface bridge add name=bridge1 /interface bridge port add interface=ether1 bridge=bridge1 add interface=ether2 bridge=bridge1 Problem

Problem Both devices are able to communicate with each other, but some protocols do not work properly. The reason is that as soon as you use any STP variant (STP, RSTP, MSTP), you make the bridge compliant with IEEE 802.1D and IEEE 802.1Q, these standards recommend that packets that are destined to 01 should be forwarded. In cases where there are only 2 ports added to a bridge (R/M)STP should not be used since a loop cannot :80:C2:00:00:0X NOT occur from 2 interfaces and if a loop does occur, the cause is elsewhere and should be fixed on a different bridge. Since (R/M)STP is not needed in transparent bridge setups, it can be disabled. As soon as (R/M)STP is disabled, the RouterOS bridge is not compliant with IEEE 802.1D and IEEE 802.1Q and therefore will forward packets that are destined to . 01:80:C2:00:00:0X Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: LLDP neighbors not showing up; 802.1x authentication (dot1x) not working; LACP interface not passing traffic; Solution It is possible to partly disable compliance with IEEE 802.1D and IEEE 802.1Q, this can be done by changing the bridge protocol mode. /interface bridge set bridge1 protocol-mode=none Bonding between Wireless links Consider the following scenario, you have set up multiple Wireless links and to achieve maximum throughput and yet to achieve redundancy you have decided to place Ethernet interfaces into a bond and depending on the traffic that is being forwarded you have chosen a certain bonding mode. This scenario can be applied to any case, where a bonding interface is created between links, that are not directly connected to each other. Configuration The IEEE 802.1x standard is meant to be used between a switch and a client directly. If it is possible to connect a device between the switch and the client, then this creates a security threat. For this reason, it is not recommended to disable the compliance with IEEE 802.1D and IEEE 802.1Q, but rather design a proper network topology.

The following configuration is relevant to and : R1 R2 /interface bonding add mode=802.3ad name=bond1 slaves=ether1,ether2 transmit-hash-policy=layer-2-and-3 /ip address add address=192.168.1.X/24 interface=bond1 While the following configuration is relevant to , , and , where corresponds to an IP address for each device. AP1 AP2 ST1, ST2 X /interface bridge add name=bridge1 protocol-mode=none /interface bridge port add interface=ether1 bridge=bridge1 add interface=wlan1 bridge=bridge1 /ip address add address=192.168.1.X/24 interface=bridge1 Problem While traffic is being forwarded properly between and , load balancing, link failover is working properly as well, but devices between and are R1 R2 R1 R2 not always accessible or some of them are completely inaccessible (in most cases and are inaccessible). After examining the problem you might AP2 ST2 notice that packets do not always get forwarded over the required bonding slave and as a result, never is received by the device you are trying to access. This is a network design and bonding protocol limitation. As soon as a packet needs to be sent out through a bonding interface (in this case you might be trying to send ICMP packets to or ), the bonding interface will create a hash based on the selected bonding mode and transmit-hash-policy and AP2 ST2 will select an interface, through which to send the packet out, regardless of the destination is only reachable through a certain interface. Some devices will be accessible because the generated hash matches the interface, on which the device is located on, but it might not choose the needed interface as well, which will result in inaccessible device. Only broadcast bonding mode does not have this kind of protocol limitation, but this bonding mode has a very limited use case. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Limited connectivity Unstable links (in case of balance-rr) Solution Bonding interfaces are not supposed to be connected using in-direct links, but it is still possible to create a workaround. The idea behind this workaround is to find a way to bypass packets being sent out using the bonding interface. There are multiple ways to force a packet not to be sent out using the bonding interface, but essentially the solution is to create new interfaces on top of physical interfaces and add these newly created interfaces to a bond instead of the physical interfaces. One way to achieve this is to create EoIP tunnels on each physical interface, but that creates a huge overhead and will reduce overall throughput. You should create a VLAN interface on top of each physical interface instead, this creates a much smaller overhead and will not impact overall performance noticeably. Here is an example of how and should be reconfigured: R1 R2 /interface vlan add interface=ether1 name=VLAN_ether1 vlan-id=999 add interface=ether2 name=VLAN_ether2 vlan-id=999 /interface bonding add mode=balance-xor name=bond1 slaves=VLAN_ether1,VLAN_ether2 transmit-hash-policy=layer-2-and-3 /ip address add address=192.168.1.X/24 interface=bond1 add address=192.168.11.X/24 interface=ether1 add address=192.168.22.X/24 interface=ether2 AP1 and only need updated IP addresses to the correct subnet: ST1 /ip address add address=192.168.11.X/24 interface=bridge1

Same changes must be applied to and (make sure to use the correct subnet): AP2 ST2 /ip address add address=192.168.22.X/24 interface=bridge1 With this approach, you create the least overhead and the least configuration changes are required. Bandwidth testing Consider the following scenario, you set up a link between two devices, this can be any link, an Ethernet cable, a wireless link, a tunnel or any other connection. You decide that you want to test the link's bandwidth, but for convenience reasons, you decide to start testing the link with the same devices that are running the link. Problem As soon as you start or you notice that the throughput is much smaller than expected. For very powerful routers, which Bandwidth test Traffic generator should be able to forward many Gigabits per second (Gbps) you notice that only a few Gigabits per second gets forwarded. The reason why this is happening is because of the testing method you are using, you should never test throughput on a router while using the same router for generating traffic because you are adding an additional load on the CPU that reduces the total throughput. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Low throughput; High CPU usage; Solution Use a proper testing method. Don't use Bandwidth-test to test large capacity links and don't run any tool that generates traffic on the same device you are testing. Design your network properly so you can attach devices that will generate and receive traffic on both ends. If you are familiar with , then this Iperf concept should be clear. Remember that in real-world a router or a switch does not generate large amounts of traffic (at least it shouldn't, otherwise, it might indicate an existing security issue), a server/client generates the traffic while a router/switch forwards the traffic (and does some manipulations to the traffic in appropriate cases). LACP (802.3ad) is not mean to be used in setups, where devices bonding slaves are not directly connected, in this case, it is not recommended to use LACP if there are Wireless links between both routers. LACP requires both bonding slaves to be at the same link speeds, Wireless links can change their rates at any time, which will decrease overall performance and stability. Other bonding modes should be used instead.

Bridge split-horizon usage Consider the following scenario, you have a bridge and you need to isolate certain bridge ports from each other. There are options to use a built-in switch chip to isolate certain ports on certain switch chips, you can use bridge firewall rules to prevent certain ports to be able to send any traffic to other ports, you can isolate ports in a PVLAN type of setup using port isolation, but there is also a software-based solution to use bridge split-horizon (which disables hardware offloading on all switch chips). Configuration /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 horizon=1 hw=no interface=ether1 add bridge=bridge1 horizon=2 hw=no interface=ether2 add bridge=bridge1 horizon=3 hw=no interface=ether3 add bridge=bridge1 horizon=4 hw=no interface=ether4 Problem After setting the bridge split-horizon on each port, you start to notice that each port is still able to send data between each other. The reason for this is the misuse of bridge split-horizon. A bridge port is only not able to communicate with ports that are in the same horizon, for example, horizon=1 is not able to communicate with horizon=1, but is able to communicate with horizon=2, horizon=3, and so on. Symptoms Below is a list of possible symptoms that might be a result of this kind of misconfiguration: Traffic is being forwarded on different bridge split-horizons Solution Set a proper value as the bridge split-horizon. In case you want to isolate each port from each other (a common scenario for PPPoE setups) and each port is only able to communicate with the bridge itself, then all ports must be in the same bridge split-horizon. /interface bridge port set [f] horizon=1

Loop Protect The loop protect feature can prevent Layer2 loops by sending loop protect protocol packets and shutting down interfaces in case they receive loop protect packets originating from themselves. The feature works by checking the source MAC address of the received loop-protect packet against the MAC addresses of loop-protect enabled interfaces. If the match is found, loop protect disables the interface that received the loop protect packet. Log message warns about this event and the interface is marked with a loop protect comment by the system. The RouterOS loop protect feature can be used on bridged interfaces as well as on Ethernet interfaces which are set for switching in RouterBoard switch chips. Loop Protect works on Ethernet, VLAN, EoIP, VxLAN interfaces and its packets are encapsulated with EtherType 0x9003. There the loop protect packet interval and interface disable time can be adjusted. Configuration changes or expiration of disable time, resets loop protection on an interface. Sub-menu: /interface ethernet; /interface vlan; /interface eoip; /interface eoipv6; /interface vxlan Property Description loop-protect ( ; Default: ) on | off | default default Enables or disables loop protect on the selected interface. works as turned off. default loop-protect-send-interval ( ; Default: ) time interval 5s Sets how often loop protect packets are sent on the selected interface. loop-protect-disable-time ( ; Default: ) time interval | 0 5m Sets how long the selected interface is disabled when a loop is detected. - forever. 0 Read-only properties Property Description loop-protect-status (on | off | ) disable on - loop-protect feature is turned on, the interface is sending and listening for loop protect packets off - loop-protect feature is turned off disable - loop-protect feature is turned on, the interface has received loop protect packet and disabled itself to prevent loop. Even though loop-protect can work on interfaces that are added to a bridge, it is still recommended to use (R/M)STP rather than loop-protect since (R/M)STP is compatible with most switches STP variants provide many more configuration options to fine-tune your network.

QoS with Switch Chip Introduction Queues in RouterOS are processed using CPU resources, so limiting traffic with queues on devices with relatively weak CPUs is not an effective configuration. In other words, switch-based units will be overloaded very fast, because they are meant to process layer 2 traffic by using a switch-chip, not CPU. To avoid such , RouterOS allows limiting traffic using switch chips. inefficiency CRS3xx, CRS5xx series, and CCR2116, CCR2216 devices For CRS3xx series switches, it is possible to limit ingress traffic that matches certain parameters with ACL rules and it is possible to limit ingress/egress traffic per port basis. The policer is used for ingress traffic, the shaper is used for egress traffic. The ingress policer controls the received traffic with packet drops. Everything that exceeds the defined limit will get dropped. This can affect the TCP congestion control mechanism on end hosts and the achieved bandwidth can be actually less than defined. The egress shaper tries to queue packets that exceed the limit instead of dropping them. Eventually, it will also drop packets when the output queue gets full, however, it should allow utilizing the defined throughput better. Port-based traffic police (ingress) and shaper (egress): /interface ethernet switch port set ether1 ingress-rate=10M egress-rate=5M MAC-based traffic policer: /interface ethernet switch rule add ports=ether1 switch=switch1 src-mac-address=64:D1:54:D9:27:E6/FF:FF:FF:FF:FF:FF rate=10M VLAN-based traffic policer: /interface bridge set bridge1 vlan-filtering=yes /interface ethernet switch rule add ports=ether1 switch=switch1 vlan-id=11 rate=10M Protocol-based traffic policer: /interface ethernet switch rule add ports=ether1 switch=switch1 mac-protocol=ipx rate=10M CRS1xx/CRS2xxSeries devices Configuration schemes MAC based traffic scheduling and shaping: [MAC address in UFDB] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] VLAN based traffic scheduling and shaping: [VLAN id in VLAN table] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] Protocol based traffic scheduling and shaping: [Protocol in Protocol VLAN table] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper] This paragraph applies to CCR2116, CCR2216 devices, and CRS3xx, CRS5xx series switches. It doesn't apply to CRS1xx/CRS2xx series switches. This subsection does not apply to CRS3xx series devices!

PCP/DEI based traffic scheduling and shaping: [Switch port PCP/DEI mapping] -> [Priority] -> [Queue] -> [Shaper] DSCP based traffic scheduling and shaping: [QoS DSCP mapping] -> [Priority] -> [Queue] -> [Shaper] MAC based traffic scheduling using internal Priority In Strict Priority scheduling mode, the highest priority queue is served first. The queue number represents the priority and the queue with the highest queue number has the highest priority. Traffic is transmitted from the highest priority queue until the queue is empty, and then moves to the next highest priority queue, and so on. If no congestion is present on the egress port, the packet is transmitted as soon as it is received. If congestion occurs at the port where high-priority traffic keeps coming, the lower-priority queues starve. On all CRS switches the scheme where MAC-based egress traffic scheduling is done according to internal Priority would be the following: [MAC address] - > [QoS Group] -> [Priority] -> [Queue]; In this example, host1 (E7:16:34:00:00:01) and host2 (E7:16:34:00:00:02) will have higher priority 1 and the rest of the hosts will have lower priority 0 for transmitted traffic on port ether7. Note that CRS has a maximum of 8 queues per port. /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create a QoS group for use in UFDB: /interface ethernet switch qos-group add name=group1 priority=1 Add UFDB entries to match specific MACs on ether7 and apply QoS group1: /interface ethernet switch unicast-fdb add mac-address=E7:16:34:00:00:01 port=ether7 qos-group=group1 svl=yes add mac-address=E7:16:34:00:00:02 port=ether7 qos-group=group1 svl=yes Configure ether7 port queues to work according to Strict Priority and QoS scheme only for destination address: /interface ethernet switch port set ether7 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- prior\ ity:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1 \ qos-scheme-precedence=da-based MAC based traffic shaping using internal Priority The scheme where MAC based traffic shaping is done according to internal Priority would be following: [MAC address] -> [QoS Group] -> [Priority] -> [Queue] -> [Shaper]; In this example, unlimited traffic will have priority 0 and limited traffic will have priority 1 with a bandwidth limit of 10Mbit. Note that CRS has a maximum of 8 queues per port. Create a group of ports for switching: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create a QoS group for use in UFDB:

/interface ethernet switch qos-group add name=group1 priority=1 Add UFDB entry to match specific MAC on ether8 and apply QoS group1: /interface ethernet switch unicast-fdb add mac-address=E7:16:34:A1:CD:18 port=ether8 qos-group=group1 svl=yes Configure ether8 port queues to work according to Strict Priority and QoS scheme only for destination address: /interface ethernet switch port set ether8 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- prior\ ity:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1 \ qos-scheme-precedence=da-based Apply bandwidth limit for queue1 on ether8: /interface ethernet switch shaper add port=ether8 rate=10M target=queue1 If the CRS switch supports Access Control List, this configuration is simpler: /interface ethernet switch acl policer add name=policer1 yellow-burst=100k yellow-rate=10M /interface ethernet switch acl add mac-dst-address=E7:16:34:A1:CD:18 policer=policer1 VLAN-based traffic scheduling + shaping using internal Priorities A best practice is to assign lower internal QoS Priority for traffic limited by shaper to make it also less important in the Strict Priority scheduler. (higher priority should be more important and unlimited) In this example: Switch port ether6 is using a shaper to limit the traffic that comes from ether7 and ether8. When a link has reached its capacity, the traffic with the highest priority will be sent out first. VLAN10 -> QoS group0 = lowest priority VLAN20 -> QoS group1 = normal priority VLAN30 -> QoS group2 = highest priority /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether6 hw=yes add bridge=bridge1 interface=ether7 hw=yes add bridge=bridge1 interface=ether8 hw=yes Create QoS groups for use in the VLAN table: /interface ethernet switch qos-group add name=group0 priority=0 add name=group1 priority=1 add name=group2 priority=2 Add VLAN entries to apply QoS groups for certain VLANs:

/interface ethernet switch vlan add ports=ether6,ether7,ether8 qos-group=group0 vlan-id=10 add ports=ether6,ether7,ether8 qos-group=group1 vlan-id=20 add ports=ether6,ether7,ether8 qos-group=group2 vlan-id=30 Configure ether6, ether7, ether8 port queues to work according to Strict Priority and QoS scheme only for VLAN-based QoS: /interface ethernet switch port set ether6 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- prior\ ity:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 \ qos-scheme-precedence=vlan-based set ether7 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- prior\ ity:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 \ qos-scheme-precedence=vlan-based set ether8 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict- prior\ ity:0,strict-priority:0,strict-priority:0,strict-priority:0" priority-to-queue=0:0,1:1,2:2 \ qos-scheme-precedence=vlan-based Apply bandwidth limit on ether6: /interface ethernet switch shaper add port=ether6 rate=10M PCP based traffic scheduling By default, CRS1xx/CRS2xx series devices will ignore the PCP/CoS/802.1p value and forward packets based on FIFO (First-In-First-Out) manner. When the device's internal queue is not full, then packets are in a FIFO manner, but as soon as a queue is filled, then higher-priority traffic will be sent out first. Let's consider a scenario when and are forwarding data to , but when is congested, then packets are going to be scheduled, we ether1 ether2 ether3 ether3 can configure the switch to hold lowest priority packets until all higher priority packets are sent out, this is a very common scenario for VoIP type setups, where some traffic needs to be prioritized. To achieve such a behavior, switch together , , and ports: ether1 ether2 ether3 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 hw=yes add bridge=bridge1 interface=ether2 hw=yes add bridge=bridge1 interface=ether3 hw=yes Enable for each internal queue on each port: Strict Policy /interface ethernet switch port set ether1,ether2,ether3 per-queue-scheduling="strict-priority:0,strict-priority:0,strict-priority:0,strict- priority:0,strict-priority:0,strict-priority:0,strict-priority:0,strict-priority:0" Map each PCP value to an internal priority value, for convenience reasons simply map PCP to an internal priority 1-to-1: /interface ethernet switch port set ether1,ether2,ether3 pcp-based-qos-priority-mapping=0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7 Since the switch will empty the largest queue first and you need the highest priority to be served first, then you can assign this internal priority to a queue 1- to-1:

/interface ethernet switch port set ether1,ether2,ether3 priority-to-queue=0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7 Finally, set each switch port to schedule packets based on the PCP value: /interface ethernet switch port set ether1,ether2,ether3 qos-scheme-precedence=pcp-based Bandwidth Limiting Both Ingress Port policer and Shaper provide bandwidth limiting features for CRS switches: Ingress Port Policer sets RX limit on port: /interface ethernet switch ingress-port-policer add port=ether5 meter-unit=bit rate=10M Shaper sets TX limit on port: /interface ethernet switch shaper add port=ether5 meter-unit=bit rate=10M Traffic Storm Control The same Ingress Port policer also can be used for traffic storm control to prevent disruptions on Layer 2 ports caused by broadcast, multicast, or unicast traffic storms. Broadcast storm control example on ether5 port with 500 packet limit per second: /interface ethernet switch ingress-port-policer add port=ether5 rate=500 meter-unit=packet packet-types=broadcast Example with multiple packet types that include ARP and ND protocols and unregistered multicast traffic. Unregistered multicast is the traffic which is not defined in the Multicast Forwarding database: /interface ethernet switch ingress-port-policer add port=ether5 rate=5k meter-unit=packet packet-types=broadcast,arp-or-nd,unregistered-multicast

Spanning Tree Protocol Summary Monitoring STP and RSTP Default values Election process Examples Root path cost example STP example Multiple Spanning Tree Protocol MSTP Regions Election process MST Instance MST Override Monitoring MSTP example Summary The purpose of the spanning tree protocol is to provide the ability to create loop-free Layer 2 topologies while having redundant links. While connecting multiple bridges or just cross-connecting bridge ports, it's possible to create network loops that can severely impact the stability of the network. Spanning tree protocol aims to resolve this problem by introducing the concept of the root bridge, all bridges in the same Layer 2 domain will exchange information about the shortest path to the root bridge. Afterward, each bridge will negotiate which ports to use to reach the root bridge. This information exchange is done with the help of Bridge Protocol Data Units (BPDUs). STP will disable certain ports for each bridge to avoid loops, while still ensuring that all bridges can communicate with each other. For an in-depth description of protocol please refer to IEEE 802.1D. As a best practice, it is always recommended to manually set up each bridge's priority, port priority, and port path cost to ensure proper Layer2 functionality at all times. Leaving STP related values to defaults is acceptable for a network that consists of 1 to 2 bridges running with (R/M)STP enabled, but it is highly recommended to manually set these values for larger networks. Since STP elects a root bridge and root ports by checking STP related values from bridges over the network, then leaving STP settings to automatic may elect an undesired root bridge and root ports and in case of a hardware failure can result in an inaccessible network. Monitoring You can check the STP status of a bridge by using the command, for example: /interface bridge monitor /interface bridge monitor bridge1 state: enabled current-mac-address: B8:69:F4:30:19:FE root-bridge: no root-bridge-id: 0x1000.B8:69:F4:30:19:FD root-path-cost: 4000 root-port: sfp-sfpplus2 port-count: 2 designated-port-count: 1 fast-forward: yes Note that the root bridge doesn't have any root ports, only designated ports. You can check the STP status of a bridge port by using the /interface bridge port monitor command, for example: RouterOS bridge does not work with PVST and its variants. The PVST BPDUs (with a MAC destination 01 :00:0C:CC:CC:CD) are treated by RouterOS bridges as typical multicast packets. In simpler terms, they undergo RouterOS bridge/switch forwarding logic and may get tagged or untagged.

/interface bridge port monitor [find interface=sfp-sfpplus2] interface: sfp-sfpplus2 status: in-bridge port-number: 1 role: root-port edge-port: no edge-port-discovery: yes point-to-point-port: yes external-fdb: no sending-rstp: yes learning: yes forwarding: yes path-cost: 2000 root-path-cost: 4000 designated-bridge: 0x8000.DC:2C:6E:9E:11:1C designated-cost: 2000 designated-port-number: 2 Note that consists of the bridge priority and the bridge's MAC address, for non-root bridges the root bridge will be shown as root-bridge-id designate . d-bridge STP and RSTP STP and Rapid STP are used widely across many networks, but almost all networks have switched over to using only RSTP because of its benefits. STP is a very old protocol and has a convergence time (the time needed to fully learn network topology changes and to continue properly forwarding traffic) of up to 50 seconds. RSTP has a lot of smaller convergence time, a few seconds or even a few milliseconds. It is recommended to use RSTP instead of STP since it is a lot faster and is also backward compatible with STP. One of the reasons why RSTP is faster is because of reduced possible port states, below is a list of possible STP port states: Forwarding - port participates in traffic forwarding and is learning MAC addresses, and is receiving BPDUs. Listening - port does not participate in traffic forwarding and is not learning MAC addresses, is receiving BPDUs. Learning - port does not participate in traffic forwarding but is learning MAC addresses. Blocking - port is blocked since it is causing loops but is receiving BPDUs. Disabled - port is disabled or inactive. In RSTP the disabled, listening, and blocking port states are replaced with just one state called the state: Discarding Forwarding - port participates in traffic forwarding and is learning MAC addresses, is receiving BPDUs (forwarding=yes). Learning - port does not participate in traffic forwarding but is learning MAC addresses (learning=yes). Discarding - port does not participate in traffic forwarding and is not learning MAC addresses, is receiving BPDUs (forwarding=no). In STP ports are primarily categorized by states (e.g., Forwarding, Listening, Learning, Blocking, Disabled). Port behavior is determined dynamically based on the spanning tree algorithm but without explicitly assigning roles. The logic of forwarding or blocking traffic is derived from the calculation of Root Bridge, Root Ports, and Designated Ports, but these are considered part of the spanning tree topology rather than formalized port roles. RSTP explicitly defined port roles and introduces the concept of backup paths, which are explicitly represented through the Alternate Port and Backup Port roles. These roles did not exist in STP because STP treated blocked ports generically, without distinguishing their function as potential backups. Here is a breakdown of the port roles for RSTP protocols: Root Port - port that is facing towards the root bridge and has the best (lowest cost) path to the root bridge. Only one root port is elected per bridge (except the root bridge itself). Designated Port - port that is facing away from the root bridge and forwards traffic away from the root bridge to downstream devices. Alternate Port - port that is facing towards the root bridge, but is not going to forward traffic. Port provides a backup path to the root bridge if the current root port fails. Backup Port - port that is facing away from the root bridge, but is going to forward traffic. Port that serves as a backup for a designated port on the same segment. Disabled Port - disabled or inactive port. When using bridges that are set to use 802.1Q as EtherType, they will send out BPDUs to 01:80:C2:00:00:00, which are used by MSTP, RSTP, and STP. When using 802.1ad as bridge VLAN protocol, the BPDUs are not compatible with 802.1Q bridges and they are sent to 01:80:C2:00: 00:08. (R/M)STP will not function properly if there are different bridge VLAN protocols across the Layer2 network.

In STP connectivity between bridges is determined by sending and receiving BPDUs between neighbor bridges. Designated ports are sending BPDUs to root ports. If a BPDU is not received 3 times the in a row, then the connection is considered as unavailable and network topology convergence HelloTime will commence. IT is possible to reduce STP convergence time in certain scenarios by reducing the timer, which is responsible for how forward-delay long can the port be in the learning/listening state. In RouterOS, it is possible to specify which bridge ports are edge ports. Edge ports are ports that are not supposed to receive any BPDUs, this is beneficial since this allows STP to skip the learning and the listening state and directly go to the forwarding state. This feature is sometimes called · You can PortFast leave this parameter to the default value, which is , but you can also manually specify it, you can set a port as an edge port manually for ports that auto should not have any more bridges behind it, usually these are access ports. Additionally, bridge port , point-to-point specifies if a bridge port is connected to a bridge using a point-to-point link for faster convergence in case of failure. By setting this property to yes, you are forcing the link to be a point-to-point link, which will skip the checking mechanism, which detects and waits for BPDUs from other devices from this single link, by setting this property to no, you are implying that a link can receive BPDUs from multiple devices. By setting the property to yes, you are significantly improving (R/M)STP convergence time. In general, you should only set this property to noif it is possible , that another device can be connected between a link, this is mostly relevant to Wireless mediums and Ethernet hubs. If the Ethernet link is full-duplex, auto enables point-to-point functionality. This property has no effect when protocol-mode is set to none . Default values When creating a bridge or adding a port to the bridge the following are the default values that are assigned by RouterOS: Default bridge priority: / 32768 0x8000 Default bridge port path cost: based on interface speed Default bridge port priority: 0x80 BPDU message age increment: 1 HelloTime: 2 Default max message age: 20 The bridge interface setting changes the port and mode for bridged ports, utilizing automatic port-cost-mode path-cost internal-path-cost values based on interface speed. This setting does not impact bridged ports with manually configured path-cost or internal-path-cost properties. Below are examples illustrating the path-costs corresponding to specific data rates (with proportionate calculations for intermediate rates): Data rate Long Short 10 Mbps 2,000,000 100 100 Mbps 200,000 19 1 Gbps 20,000 4 10 Gbps 2,000 2 25 Gbps 800 1 40 Gbps 500 1 50 Gbps 400 1 100 Gbps 200 1 For bonded interfaces, the highest among all bonded member ports is applied, this value remains unaffected by the total link speed of the path-cost bonding. For virtual interfaces ( VLAN, EoIP, VXLAN), as well as wifi, wireless, and 60GHz interfaces, a of 20,000 is assigned for long such as path-cost mode, and 10 for short mode. For dynamically bridged interfaces (e.g. wifi, wireless, PPP, VPLS), the defaults to 20,000 for long mode and 10 path-cost for short mode. However, this can be manually overridden by the service that dynamically adds interfaces to bridge, for instance, by using the CAPsMAN d setting. RouterOS versions prior to 7.13 does not change port path cost based on the link speed, for 10M, 100M, 1000M, and atapath.bridge-cost 10000M link speeds the default path cost value when a port is added to a bridge was always . 10 The age of a BPDU is determined by how many bridges have the BPDU passed times the message age since RouterOS uses as the message age 1 increment, then the BPDU packet can pass as many bridges as specified in the parameter. By default this value is set to , this max-message-age 20 means that after the 20th bridge the BPDU packet will be discarded and the next bridge will become a root bridge, note that if is =20 max-message-age set, then it is hard to predict which ports will be the designated port on the 21st bridge and may result in traffic not being able to be forwarded properly. In case bridge filter rules are used, make sure you allow packets with DST-MAC address 01:80:C2:00:00:00 since these packets carry BPDUs that are crucial for STP to work properly.

1. 2. 1. 2. 3. Election process To properly configure STP in your network you need to understand the election process and which parameters are involved in which order. In RouterOS, the root bridge will be elected based on the smallest priority and the smallest MAC address in this particular order: Bridge priority (lowest) Bridge MAC address (lowest) In RouterOS root ports are elected based on the lowest Root port path cost, lowest bridge identifier, and lowest bridge port ID in this particular order: Root port path cost (lowest) Bridge identifier (lowest) Bridge port ID (lowest) First, when the device considers which of its ports to elect as the root port, it will check the seen by its ports. If the root path cost is the same root path cost for two or more ports then the of the device will be checked and the port connected to the lowest bridge identifier will become the Bridge identifier upstream root port. If the same bridge identifier is seen on two or more ports, then of device will be checked. the Bridge port ID the upstream Explanation of attributes: Root path cost, all bridges have a Root Path Cost. The root bridge has a root path cost of 0. For all other Bridges, it is the sum of the Port Path Costs on the least-cost path to the Root Bridge. You can modify the local port path cost under " ". /interface bridge port The bridge identifier is a combination of "bridge priority" and "bridge MAC", configurable under " " /interface bridge Bridge port ID is a combination of "unique ID" and "bridge port priority", the unique ID is automatically assigned to the bridge port upon adding it to the bridge, it cannot be edited. It can be seen in WinBox under the "Bridge Port" "Port Number" column, or with " ", as " /interface bridge port monitor ". port-number Examples Root path cost example Make sure you are using path cost and priority on the right ports. For example, setting path cost on ports that are in a root bridge has no effect, only port priority affects them. Root path cost affects ports that are facing towards the root bridge and port priority affects ports that are facing away from the root bridge. And bridge identifier doesn’t impact the device's own root port election, instead, it affects the root port election for downstream devices. In RouterOS it is possible to set any value for bridge priority between 0 and 65535, the IEEE 802.1W standard states that the bridge priority must be in steps of 4096. This can cause incompatibility issues between devices that do not support such values. To avoid incompatibility issues, it is recommended to use only these priorities: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152, 53248, 57344, 61440.

This example outlines how the root path cost works. SW1 will be the root bridge, due to it having the lowest priority of 0x1000, as the root bridge. Each bridge will calculate the path cost to the root bridge. When calculating root path cost bridges take into account the configured path cost on their ports + root path cost advertised by neighboring bridges. SW1 : due to it being the root bridge, it advertises a root path cost of 0 to its neighbors, even though it has a configured path cost of 10. SW2: ether1 . has a root path cost of 0 + 25= . On the path cost will be 10+10+10+0= 25 ether2 30 SW3: , has a root path cost of 0 + 10= . On the path cost will be 10+5+25+0= ether2 10 ether4 40 SW4: , has a root path cost of 0+25+5= . On path cost will be 10+10+0= ether1 30 ether4 20 The Port with the lowest path cost will be elected as the root port. Every bridge in STP topology needs a path to the root bridge, after the best path has been found, the redundant path will be blocked, in this case, the path between SW2 and SW4. STP example You can configure path cost on the root bridge, but it will only be taken into account when the bridge loses its root status.

In this example, we want to ensure Layer2 redundancy for connections from ServerA to ServerB. If a port is connected to a device that is not a bridge and not running (R)STP, then this port is considered as an edge port, in this case, ServerA and ServerB are connected to an edge port. This is possible by using STP in a network. Below are configuration examples for each switch. Configuration for SW1: /interface bridge add name=bridge priority=0x1000 /interface bridge port add bridge=bridge interface=ether1 priority=0x60 add bridge=bridge interface=ether2 priority=0x50 add bridge=bridge interface=ether3 priority=0x40 add bridge=bridge interface=ether4 priority=0x30 add bridge=bridge interface=ether5 Configuration for SW2: /interface bridge add name=bridge priority=0x2000 /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 add bridge=bridge interface=ether3 Configuration for SW3: /interface bridge add name=bridge priority=0x3000 /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 add bridge=bridge interface=ether3 Configuration for SW4:

/interface bridge add name=bridge priority=0x4000 /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 path-cost=20 add bridge=bridge interface=ether3 In this example, is the root bridge since it has the lowest bridge priority. and have ether1,ether2 connected to the root bridge, and ether3 is SW1 SW2 SW3 connected to . When all switches are working properly, the traffic will be flowing from ServerA through SW1_ether2, through SW2, and through SW4 SW4 to ServerB. In the case of failure, the becomes the root bridge because of the next lowest priority, indicated by the dotted line in the diagram. SW1 SW2 Below is a list of ports and their role for each switch: root-port - SW2_ether2, SW3_ether2, SW4_ether1 alternate-port - SW2_ether1, SW3_ether1, SW4_ether2 designated-port - SW1_ether1, SW1_ether2, SW1_ether3, SW1_ether4, SW1_ether5, SW2_ether3, SW2_ether3, SW4_ether3 Multiple Spanning Tree Protocol Multiple Spanning Tree Protocol (MSTP) is used on a bridge interface to ensure loop-free topology across multiple VLANs, MSTP can also provide Layer2 redundancy and can be used as a load balancing technique for VLANs since it has the ability to have different paths across different VLANs. MSTP is operating very similarly to (R)STP and many concepts from (R)STP can be applied to MSTP and it is highly recommended to understand the principles behind (R)STP before using MSTP, but there are some differences that must be taken into account when designing an MSTP enabled network. In case (R)STP is used, the BPDUs are sent across all physical interfaces in a bridge to determine loops and stop ports from being able to forward traffic if it causes a loop. In case there is a loop inside a certain VLAN, (R)STP might not be able to detect it. Some STP variants solve this problem by running an STP instance on every single VLAN (PVST), but this has been proven to be inefficient and some STP variants solve this problem by running a single STP instance across all VLANs (CST), but it lacks the possibility to do load balancing for each VLAN or VLAN group. MSTP tends to solve both problems by using MST instances that can define a group of VLANs (VLAN mapping) that can be used for load balancing and redundancy, this means that each VLAN group can have a different root bridge and a different path. Note that it is beneficial to group multiple VLANs in a single instance to reduce the amount of CPU cycles for each network topology change. MSTP Regions MSTP works in groups called regions, for each region there will be a regional root bridge, and between regions, there will be a root bridge elected. MSTP will use an Internal Spanning Tree (IST) to build the network topology inside a region and a Common Spanning Tree (CST) outside a region to build the network topology between multiple regions, MSTP combines these two protocols into Common and Internal Spanning Tree (CIST), which holds information about topology inside a region and between regions. From CST's perspective, a region will seemingly be as a single virtual bridge, because of this MSTP is considered very scalable for large networks. For bridges to be in the same region, their configuration must match, BPDUs will not include VLAN mappings since they can be large, rather a computed hash is being transmitted. If a bridge receives a BPDU through a port and the configuration does not match, then MSTP will consider that port as a boundary port and that it can be used to reach other regions. Below is a list of parameters that need to match for MSTP to consider a BPDU from the same region: Region name Region revision VLAN mappings to MST Instance IDs (computed hash) Note: By the 802.1Q recommendations, you should use bridge priorities in steps of 4096. To set a recommended priority it is more convenient to use hexadecimal notation, for example, 0 is 0x0000, 4096 is 0x1000, 8192 is 0x2000, and so on (0..F). In RouterOS with MSTP enabled the bridge priority is the CIST's root bridge priority, as stated in the IEEE 802.1Q standard the bridge priority must be in steps of 4096, the 12 lowest bits are ignored. These are valid bridge priorities: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152, 53248, 57344, 61440. When setting an invalid bridge priority, RouterOS will warn you about it and trunk the value to a valid value, but will save the original value in the configuration since invalid bridge priority values can still be used in (R)STP between devices running RouterOS, though it is recommended to use valid a bridge priority instead.

It is possible to create MSTP enabled network without regions, though to be able to do load balancing per VLAN group it is required for a bridge to receive a BPDU from a bridge that is connected to it with the same parameters mentioned above. In RouterOS the default region name is empty and the region revision is 0, which are valid values, but you must make sure that they match to get multiple bridges in a single MSTP region. A region cannot exist if its bridges are scattered over the network, these bridges must be connected at least in one way, in which they can send and receive BPDUs without leaving the region, for example, if a bridge with different region related parameters is between two bridges that have the same region related parameters, then there will exist at least 3 different MSTP regions. The downside of running every single bridge in a single MSTP region is the excess CPU cycles. In comparison, PVST(+) creates a Spanning Tree Instance for each VLAN ID that exists on the network, since there will be very limited paths that can exist in a network, then this approach creates a lot of overhead and unnecessary CPU cycles, this also means that this approach does not scale very well and can overload switches with not very powerful CPUs. MSTP solves this problem by dividing the network into MSTP regions, where each bridge inside this region will exchange and process information about VLANs that exist inside the same region, but will run a single instance of Spanning Tree Protocol in the background to maintain the network topology between regions. This approach has been proven to be much more effective and much more scalable, this means that regions should be used for larger networks to reduce CPU cycles. In regions, you can define MST Instances, which are used to configure load balancing per VLAN group and to elect the regional root bridge. It is worth mentioning that in each region there exists a pre-defined MST Instance, in most documentations, this is called as · This MST Instance is considered MSTI0 as the default MST Instance, there are certain parameters that apply to this special MST Instance. When traffic passes through an MSTP enabled bridge, MSTP will look for an MST Instance that has a matching VLAN mapping, but if a VLAN mapping does not exist for a certain VLAN ID, then traffic will fall under . MSTI0 Election process The election process in MSTP can be divided into two sections, intra-region and inter-region. For MSTP to work properly there will always need to be a regional root, that is the root bridge inside a region, and a CIST root, that is the root bridge between regions. A regional root is the root bridge inside a region, regional root bridge will be needed to properly set up load balancing for VLAN groups inside a region. CIST root will be used to configure which ports will be alternate/backup ports (inactive) and which ports will be root ports (active). The following parameters are involved in electing a regional root bridge or root ports inside a MSTP region: Property Description priority (integer: 0..65535 decimal format or 0x0000-0xffff ; Default: ) hex format 32768 / 0x8000/interface bridge msti, MST Instance priority, used to elect a regional root inside an MSTP region. internal-path-cost ( ; Default: ) integer: 1..200000000 /interface bridge port, path cost to the regional root for unknown VLAN IDs (MSTI0), used on a root port inside an MSTP region. priority ( ; Default: ) integer: 0..240 128 /interface bridge port mst-override, MST port priority for a defined MST Instance, used on a bridge port on the regional root bridge. internal-path-cost ( ; Default: ) integer: 1..200000000 /interface bridge port mst-override, MST port path cost for a defined MST Instance, used on a non-root bridge port inside an MSTP region. Since MSTP requires VLAN filtering on the bridge interface to be enabled, then make sure that you have allowed all required VLAN IDs in /inte rface bridge vlan , otherwise, the traffic will not be forwarded and it might seem as if MSTP is misconfigured, although this is a VLAN filtering misconfiguration. Between regions, there is no load balancing per VLAN group, root port election process, and port blocking between MSTP regions is done the same way as in (R)STP. If CIST has blocked a port that is inside an MSTP region to prevent traffic loops between MSTP regions, then this port can still be active for IST to do load balancing per VLAN group inside an MSTP region.

The following parameters are involved in electing a CIST root bridge or CIST root ports: Property Description priority ( ; integer: 0..65535 decimal format or 0x0000-0xffff hex format Default: ) 32768 / 0x8000/interface bridge, CIST bridge priority, used to elect a CIST root bridge. priority ( ; Default: ) integer: 0..240 128 /interface bridge port, CIST port priority, used on a CIST root bridge to elect CIST root ports. path-cost ( ; Default: ) integer: 1..200000000 /interface bridge port, CIST port path cost, used on a CIST non-root bridge port to elect CIST root ports. MST Instance Sub-menu: /interface bridge msti This section is used to group multiple VLAN IDs into a single instance to create a different root bridge for each VLAN group inside an MSTP region. Property Description bridge (; Default: )text Bridge to which assigns an MST instance. identifier ( ; Default: ) integer: 1..31 MST instance identifier. priority (integer: 0..65535 decimal format or ; Default: ) 0x0000-0xffff hex format 32768 / 0x8000MST instance priority, is used to determine the root bridge for a group of VLANs in an MSTP region. vlan-mapping ( ; Default: ) integer: 1..4094 The list of VLAN IDs to assign to MST instance. This setting accepts the VLAN ID range, as well as comma, separated values. E.g. =100-115,120,122,128-130 vlan-mapping MST Override Sub-menu: /interface bridge port mst-override This section is used to select the desired path for each VLAN mapping inside an MSTP region. Property Description disabled ( ; Default: ) yes | no no Whether the entry is disabled. internal-path-cost (integer: 1.. ; Default: ) 200000000Path cost for an MST instance's VLAN mapping, used on VLANs that are facing towards the root bridge to manipulate path selection, lower path cost is preferred. identifier ( ; Default: ) integer: 1..31 MST instance identifier. priority ( ; Default: integer: 0..240 128 )The priority of an MST instance's VLAN, used on VLANs that are facing away from the root bridge to manipulate path selection, lower priority is preferred. interface ( ; Default: ) name Name of the port on which use configured MST instance's VLAN mappings and defined path cost and priority. Monitoring Similarly to (R)STP, it is also possible to monitor MSTP status. By monitoring the bridge interface itself it is possible to see the current CIST root bridge and the current regional root bridge for MSTI0, it is also possible to see the computed hash of MST Instance identifiers and VLAN mappings, this is useful when making sure that certain bridges are in the same MSTP region. Below you can find an example of monitoring an MSTP bridge: The sequence of parameters in which MSTP checks to elect root bridge/ports is the same as in (R)STP, you can read more about it in the (R) STP Election Process section.

/interface bridge monitor bridge state: enabled current-mac-address: 6C:3B:6B:7B:F0:AA root-bridge: no root-bridge-id: 0x1000.64:D1:54:24:23:72 regional-root-bridge-id: 0x4000.6C:3B:6B:7B:F0:AA root-path-cost: 10 root-port: ether4 port-count: 5 designated-port-count: 3 mst-config-digest: 74edbeefdbf82cf63a70cf60e43a56f3 In MSTP it is possible to monitor the MST Instance, this is useful to determine the current regional root bridge for a certain MST Instance and VLAN group, below you can find an example to monitor an MST Instance: /interface bridge msti monitor 1 state: enabled identifier: 2 current-mac-address: 6C:3B:6B:7B:F0:AA root-bridge: no root-bridge-id: 0.00:00:00:00:00:00 regional-root-bridge-id: 0x1002.6C:3B:6B:7B:F9:08 root-path-cost: 0 root-port: ether2 port-count: 5 designated-port-count: 1 It is also possible to monitor a certain MST Override entry, this is useful to determine the port role for a certain MST Instance when configuring root ports and alternate/backup ports in an MSTP region, below you can find an example to monitor an MST Override entry: /interface bridge port mst-override monitor 1 port: ether3 status: active identifier: 2 role: alternate-port learning: no forwarding: no internal-root-path-cost: 15 designated-bridge: 0x1002.6C:3B:6B:7B:F9:08 designated-internal-cost: 0 designated-port-number: 130 MSTP example Let's say that we need to design topology and configure MSTP in a way that VLAN 10,20 will be forwarded in one path, but VLAN 30,40 will be forwarded in a different path, while all other VLAN IDs will be forwarded in one of those paths. This can easily be done by setting up MST Instances and assigning port path costs, below you can find a network topology that needs to do load balancing per VLAN group with 3 separate regions as an example:

The topology of an MSTP-enabled network with load balancing per VLAN group Start by adding each interface to a bridge, initially, you should create a (R)STP bridge without VLAN filtering enabled, this is to prevent losing access to the CPU. Each device in this example is named by the region that it is in (Rx) and a device number (_x). For larger networks configuring MSTP can be confusing because of the number of links and devices, we recommend using The Dude to monitor and design a network topology. Use the following commands on , , , , , : R1_1 R1_3 R2_1 R2_3 R3_1 R3_3 /interface bridge add name=bridge protocol-mode=rstp vlan-filtering=no /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 add bridge=bridge interface=ether3 add bridge=bridge interface=ether4 Use the following commands on R1_2 , R2_2 , R3_2 : /interface bridge add name=bridge protocol-mode=rstp vlan-filtering=no /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=ether2 Make sure you allow the required VLAN IDs on these devices, here we will consider that each device will receive tagged traffic that needs to be load balanced per VLAN group, use these commands on , , , , , : R1_1 R1_3 R2_1 R2_3 R3_1 R3_3 /interface bridge vlan add bridge=bridge tagged=ether1,ether2,ether3,ether4 vlan-ids=10,20,30,40 Use the following commands on , , : R1_2 R2_2 R3_2 /interface bridge vlan add bridge=bridge tagged=ether1,ether2 vlan-ids=10,20,30,40 Make sure you add all the needed VLAN IDs and ports to the bridge VLAN table, otherwise, your device will not forward all required VLANs, and /or you will lose access to the device.

We need to assign a region name for each bridge that we want to be in a single MSTP region, you can also specify the region revision, but it is optional, though they need to match. In this example, if all bridges will have the same region name, then they will all be in a single MSTP bridge. In this case, we want to separate a group of 3 bridges in a different MSTP region to do load balancing per VLAN group and to create diversity and scalability. Set the appropriate region name (and region revision) for each bridge, and use the following commands on each device ( ): change the region name! /interface bridge set bridge region-name=Rx region-revision=1 After we have created 3 different MSTP regions, we need to decide which device is going to be a regional root for each VLAN group. For consistency, we are going to set the first device (_1) in each region as the regional root for VLAN 10,20 and the third device (_3) in each region as the regional root for VLAN 30,40. This can be done by creating an MST Instance for each VLAN group and assigning a bridge priority to it. The MST Instance identifier is only relevant inside an MSTP region, outside an MSTP region these identifiers can be different and mapped to a different VLAN group. Use the following commands on , , : R1_1 R2_1 R3_1 /interface bridge msti add bridge=bridge identifier=1 priority=0x1000 vlan-mapping=10,20 add bridge=bridge identifier=2 priority=0x3000 vlan-mapping=30,40 Use the following commands on , , : R1_3 R2_3 R3_3 /interface bridge msti add bridge=bridge identifier=1 priority=0x3000 vlan-mapping=10,20 add bridge=bridge identifier=2 priority=0x1000 vlan-mapping=30,40 Use the following commands on , , : R1_2 R2_2 R3_2 /interface bridge msti add bridge=bridge identifier=1 priority=0x2000 vlan-mapping=10,20 add bridge=bridge identifier=2 priority=0x2000 vlan-mapping=30,40 Now we need to override the port and/or port priority for each MST Instance. This can be done by adding an MST-Override entry for each path-cost port and each MST Instance. To achieve that for a certain MST Instance the traffic flow path is different, we simply need to make sure that the port path cost and/or priority is larger. We can either increase the port path cost or decrease the port path cost to ports that are facing toward the regional root bridge. It doesn't matter if you increase or decrease all values, it is important that in the end, one port's path cost is larger than the other's. Use the following commands on , , : R1_1 R2_1 R3_1 /interface bridge port mst-override add identifier=2 interface=ether1 internal-path-cost=5 add identifier=2 interface=ether2 internal-path-cost=15 Use the following commands on , , : R1_2 R2_2 R3_2 /interface bridge port mst-override add identifier=1 interface=ether1 internal-path-cost=5 add identifier=2 interface=ether2 internal-path-cost=9 Use the following commands on , , : R1_3 R2_3 R3_3 /interface bridge port mst-override add identifier=1 interface=ether2 internal-path-cost=5 add identifier=1 interface=ether3 internal-path-cost=9

In this case for VLAN 10,20 to reach the third device from the first device, it would choose between ether1 and ether2, one port will be blocked and set as an alternate port, and ether1 will have path cost as and ether2 will have path cost as , ether2 will be elected as the root port for MSTI1 on the 5+9=14 10 third device. In case for VLAN 30,40 to reach the first device from the third device, ether1 will have path cost as and ether2 will have path cost as 5+9=14 15 , ether1 will be elected as the root port for MSTI2 on the third device. Now we can configure the root ports for , which will fall under all VLANs that are not assigned to a specific MST Instance, like in our example VLAN MSTI0 10,20, and VLAN 30,40. To configure this special MST Instance, you will need to specify to a bridge port. This value is only internal-path-cost relevant to MSTP regions, it does not have any effect outside an MSTP region. In this example will choose that all unknown VLANs will be forwarded over the same path as VLAN 30,40, we will simply increase the path cost on one of the ports. Use the following commands on , , : R1_3 R2_3 R3_3 /interface bridge port set [find where interface=ether3] internal-path-cost=25 At this point, a single region MSTP can be considered as configured, and in general, MSTP is fully functional. It is highly recommended to configure the CIST part, but for testing purposes, it can be left with the default values. Before doing any tests, you need to enable MSTP on all bridges. Use the following commands on devices: all /interface bridge set bridge protocol-mode=mstp vlan-filtering=yes When MSTP regions have been configured, you can check if they are properly configured by forwarding traffic, for example, send tagged traffic from the first device to the third device and change the VLAN ID for the tagged traffic to observe different paths based on VLAN ID. When this is working as expected, then you can continue to configure CIST related parameters to elect a CIST root bridge and CIST root ports. For consistency we will choose the first device in the first region to be the CIST root bridge and to ensure consistency in case of failure we can set a higher priority to all other bridges. Use the following commands on R1_1: /interface bridge set bridge priority=0x1000 Use the following commands on : R1_2 /interface bridge set bridge priority=0x2000 ... Use the following commands on : R3_3 /interface bridge set bridge priority=0x9000 We also need to elect a root port on each bridge, for simplicity we will choose the port that is closest to as the root port and has the least hops. At this Ŗ1_1 point, the procedure to elect root ports is the same as the procedure in (R)STP. Use the following commands on R3_3: /interface bridge port set [find where interface=ether2] path-cost=30 set [find where interface=ether3] path-cost=40 set [find where interface=ether4] path-cost=20 Use the following commands on and R1_3 R2_3:

/interface bridge port set [find where interface=ether2] path-cost=20 set [find where interface=ether3] path-cost=30 Use the following commands on : R1_2 /interface bridge port set [find where interface=ether1] path-cost=30

Wireless VLAN Trunk Summary A very common task is to forward only a certain set of VLANs over a Wireless Point-to-Point (PtP) link. This can be done using bridge VLAN filtering and should be used instead of any other methods (including bridging VLAN interfaces). Let's say we need to forward over a Wireless link to 2 different VLANs and all other VLAN IDs should be dropped. VLAN 10 is going to be our Internet traffic while VLAN 99 is going to be for our management traffic. Below you can find the network topology: Configuration Start by creating a new bridge on and and add and ports to it: AP ST ether1 wlan1 /interface bridge add name=bridge protocol-mode=none /interface bridge port add bridge=bridge interface=ether1 add bridge=bridge interface=wlan1 For security reasons you should enable ingress-filtering since you are expecting only tagged traffic, then you can set the bridge to filter out all untagged traffic. Do the following on and : AP ST /interface bridge port set [find where interface=ether1 or interface=wlan1] frame-types=admit-only-vlan-tagged ingress-filtering=yes Set up the bridge VLAN table. Since VLAN99 is going to be our management traffic, then we need to allow this VLAN ID to be able to access the bridge interface, otherwise, the traffic will be dropped as soon as you will try to access the device. VLAN10 does not need to access the bridge since it is only meant to be forwarded to the other end. To achieve such functionality add these entries to the bridge VLAN table on and : AP ST /interface bridge vlan add bridge=bridge tagged=ether1,wlan1 vlan-ids=10 add bridge=bridge tagged=ether1,wlan1,bridge vlan-ids=99 You can enable RSTP if it is required, but generally, RSTP is not required for PtP links since there should not be any way for a loop to occur.

All devices ( , , and ) need a VLAN interface created to be able to access the device through the specific VLAN ID. For and create the R1R2AP, ST AP ST VLAN interface on top of the bridge interface and assign an IP address to it: /interface vlan add interface=bridge name=MGMT vlan-id=99 /ip address add address=192.168.99.X/24 interface=MGMT For and do the same, but the interface, on which you need to create the VLAN interface, will probably change, depending on your setup: R1 R2 /interface vlan add interface=ether1 name=MGMT vlan-id=99 /ip address add address=192.168.99.X/24 interface=MGMT Setup the Wireless link on :AP /interface wireless security-profiles add authentication-types=wpa2-psk mode=dynamic-keys name=wlan_sec wpa2-pre-shared-key=use_a_long_password_here /interface wireless set wlan1 band=5ghz-a/n/ac channel-width=20/40/80mhz-Ceee disabled=no mode=bridge scan-list=5180 security- profile=wlan_sec ssid=ptp_test Setup the Wireless link on :ST /interface wireless security-profiles add authentication-types=wpa2-psk mode=dynamic-keys name=wlan_sec wpa2-pre-shared-key=use_a_long_password_here /interface wireless set wlan1 band=5ghz-a/n/ac channel-width=20/40/80mhz-Ceee disabled=no mode=station-bridge scan-list=5180 security-profile=wlan_sec ssid=ptp_test When links are set up, you can enable bridge VLAN filtering on and : AP ST You can limit from which interfaces it will be allowed to access the device. For example, if you don't want the device to be accessible from wlan1 , then you can remove the interface from the corresponding bridge VLAN entry. For devices with and wireless interface support (e.g. RB4011 with LtAP with hardware offloaded VLAN filtering RTL8367 switch chip, or MT7621 ), more attention needs to be paid. Packets going from HW offloaded ports to wireless can be filtered, if the VLAN access to the CPU switch chip is not allowed. It is possible to allow CPU access for a certain VLAN by adding the bridge interface as a VLAN member (similar to the VLAN99 example) or disabling HW offloading on bridge ports. To allow more VLANs to be forwarded, you simply need to specify more VLAN IDs in the bridge VLAN table, you can specify multiple VLANs divided by coma or even VLAN ranges. For each type of setup, there are different requirements, for PtP links NV2 wireless protocol is commonly used. You can read more about NV2 on the page. NV2 Manual

/interface bridge set bridge vlan-filtering=yes Double-check the bridge VLAN table before enabling VLAN filtering. A misconfigured bridge VLAN table can lead to the device being inaccessible and a configuration reset might be required.

This essentially means that if it is not possible or wanted to classify packets by rules, the configuration of the network must be such that the router can extract ingress priority from incoming frames. Remember there are currently 2 sources for this - VLAN tag in packets and received WMM packets. Set VLAN or WMM priority based on specific matchers It is possible to change the VLAN and WMM priorities based on specific matchers in IP mangle or bridge filter/nat rules. In this example, all outgoing ICMP packets will be sent with a VLAN or WMM priority using the IP mangle rule: /ip firewall mangle add action=set-priority chain=output new-priority=2 protocol=icmp Custom priority mapping Sometimes certain VLAN or WMM priorities need to be changed or cleared to a default value. We can use the matcher in IP mangle ingress-priority or bridge firewall/nat rules to filter only the needed priorities and change them to a different value using the action setting. For example, new-priority forwarded VLAN tagged packets over a bridge with a priority of 5, need to be changed to 0. /interface bridge filter add action=set-priority chain=forward ingress-priority=5 new-priority=0 Translating WMM priority to VLAN priority inside a bridge When a wireless packet is received with an already set WMM priority, the RouterOS bridge does not automatically translate it to a VLAN header. It means, that received wireless packets with WMM priority that get VLAN tagged by the bridge will be forwarded with a VLAN priority of 0. However, we can use a bridge filter rule with setting to keep the priority in VLAN packets. For example, we would like to forward wireless packets over ether2 with from-ingress a VLAN 10 header and keep the already set WMM priority (set by the wireless client). /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=wlan2 pvid=10 /interface bridge vlan add bridge=bridge1 tagged=ether2 vlan-ids=10 # translates WMM priority to VLAN priority /interface bridge filter add action=set-priority chain=forward new-priority=from-ingress out-interface=ether2 The same situation applies when wireless packets are VLAN tagged by the wireless interface using the and settings. You vlan-mode=use-tag vlan-id still need to use the same bridge filter rule to translate WMM priority to VLAN priority: Do not mix the priority of queues with the priority assigned to packets. Priorities of queues work separately and specify the "importance" of the queue and have meaning only within a particular queue setup. Think of packet priority as some kind of mark, that gets attached to the packet by rules. Also, take into account that this mark currently is only used for outgoing packets when going over WMM enabled link, and in case VLAN tagged packet is sent out (no matter if that packet is tagged locally or bridged).

/interface wireless set [ find default-name=wlan2 ] vlan-mode=use-tag vlan-id=10 /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=wlan2 # translates WMM priority to VLAN priority /interface bridge filter add action=set-priority chain=forward new-priority=from-ingress out-interface=ether2 Priority from DSCP Another way of setting VLAN or WMM priority is by using the DSCP field in the IP header, this can only be done by the IP firewall mangle rule with new- or settings and action property. Note that DSCP in the IP header priority= from-dscp new-priority=from-dscp-high-3-bits set-priority can have values 0-63, but priority only 0-7. When using the setting, the priority will be 3 low bits of the DSCP value, but new-priority= from-dscp when using the priority will be 3 high bits of DSCP value. new-priority=from-dscp-high-3-bits Remember that DSCP can only be accessed on IP packets and the DSCP value in the IP header should be set somewhere (either by client devices or IP mangle rules). It is best to set the DSCP value in the IP header of packets on some border router (e.g. main router used for connection to the Internet), based on traffic type e.g. set DSCP value for packets coming from the Internet belonging to SIP connections to 7, and 0 for the rest. This way packets must be marked only in one place. Then all APs on the network can set packet priority from the DSCP value with just one rule. Set VLAN or WMM priority from DSCP In this example, the AP device will set WMM priority from DSCP when packets are routed through the wireless interface. /ip firewall mangle add action=set-priority chain=forward new-priority=from-dscp out-interface=wlan2 DSCP from Priority Similarly, the DSCP value can be set if the received packet contains VLAN or WMM priority. This can be achieved with IP mangle rules with new- or settings and action property. Note that priority in VLAN or dscp=from-priority new-dscp=from-priority-to-high-3-bits change-dscp WMM packets can have values 0-7, but DSCP in IP headers are 0-63. When using the setting, the value of priority will set new-dscp=from-priority the 3 low bits of the DSCP, but when using the value of priority will set the 3 high bits of the DSCP. new-dscp=from-priority-to-high-3-bits However, this setting cannot directly use ingress priority from received VLAN or WMM packets. You first need to set priority using IP mangle or bridge filter /nat rules (ingress priority can be used in this case), and only then apply the DSCP rule. The same principles apply in the other direction. RouterOS does not automatically translate VLAN priority to WMM priority. The same rule new- can be used to translate VLAN priority to WMM priority. priority=from-ingress The RouterOS bridge forwards VLAN tagged packets unaltered, which means that received VLAN tagged packets with a certain VLAN priority will leave the bridge with the same VLAN priority. The only exception is when the bridge untags the packet, in this situation VLAN priority is not preserved due to the missing VLAN header. When packets are forwarded through a bridge, it is possible to pass packets through IP mangle rules with under the use-ip-firewall=yes bridge settings.

Set DSCP from VLAN or WMM priority In this example, the AP device needs to set DSCP from WMM priority when packets are routed. First, add a rule to set priority, it will be needed for the DSCP rule to correctly change the DSCP value. This rule can take priority from ingress. Then add the DSCP rule to change its value. /ip firewall mangle add action=set-priority chain=prerouting in-interface=wlan2 new-priority=from-ingress add action=change-dscp chain=prerouting in-interface=wlan2 new-dscp=from-priority Combining priority setting and handling solutions Complex networks and different situations can be handled by combining different approaches of carrying priority information to ensure QoS and optimize the use of resources, based on the "building blocks" described above. Several suggestions: The fewer number of filter rules in the whole network, the better (faster). Try classifying packets only when necessary, prefer to do that on fast routers as most probably connection tracking will be required. Use DSCP to carry priority information in IP packets forwarded in your network, this way you can use it when needed. Use VLANs where necessary, as they also carry priority information, make sure Ethernet bridges and switches in the way are not clearing priority information in the VLAN tag. Remember that QoS does not improve the throughput of links, it just treats different packets differently, and also that WMM traffic over the wireless link will discriminate regular traffic in the air. See also Packet Flow in RouterOS IP mangle Bridge firewall When packets are forwarded through a bridge, it is possible to pass packets through IP mangle rules with under the use-ip-firewall=yes bridge settings.

Firewall and Quality of Service In This Section:

Connection tracking Introduction Connection states FastTrack Requirements Example Connection tracking settings Properties Connection List Properties Introduction Connection tracking allows the kernel to keep track of all logical network connections or sessions, and thereby relate all of the packets which may make up that connection. NAT relies on this information to translate all related packets in the same way. Because of connection tracking you can use stateful firewall functionality even with stateless protocols such as UDP. Firewall features affected by connection tracking: NAT firewall: connection-bytes connection-mark connection-type connection-state connection-limit connection-rate layer7-protocol new-connection-mark tarpit List of tracked connections can be seen in /ip firewall connection for IPv4 and /ipv6 firewall connection for IPv6. [admin@3C22-atombumba] /ip firewall connection> print Flags: S - seen-reply, A - assured # PR.. SRC-ADDRESS DST-ADDRESS TCP-STATE TIMEOUT 0 udp 10.5.8.176:5678 255.255.255.255:5678 0s 1 udp 10.5.101.3:646 224.0.0.2:646 5s 2 ospf 10.5.101.161 224.0.0.5 9m58s 3 udp 10.5.8.140:5678 255.255.255.255:5678 8s 4 SA tcp 10.5.101.147:48984 10.5.101.1:8291 established 4m59s [admin@3C22-atombumba] /ipv6 firewall connection> print Flags: S - seen reply, A - assured # PRO.. SRC-ADDRESS DST-ADDRESS TCP-STATE 0 udp fe80::d6ca:6dff:fe77:3698 ff02::1 1 udp fe80::d6ca:6dff:fe98:7c28 ff02::1 2 ospf fe80::d6ca:6dff:fe73:9822 ff02::5 Connection states Based on connection table entries arrived packet can get assigned one of the connection states: or . new, invalid, established, related, untracked

There are two different methods when the packet is considered . The first one is in the case of stateless connections (like UDP) when there is no new connection entry in the connection table. The other one is in the case of a stateful protocol (TCP). In this case, a new packet that starts a new connection is always a TCP packet with an flag.SYN If a packet is not new it can belong to either an or connection or not belong to any connection making it . A packet with an established related invalid establis state, as most of you already guessed, belongs to an existing connection from the connection tracking table. A state is very similar, except that hed related the packet belongs to a connection that is related to one of the existing connections, for example, ICMP error packets or FTP data connection packets. Connection state is a special case when firewall rules are used to exclude connection from connection tracking. This rule would make all notrack RAW forwarded traffic bypass the connection tracking, improving packet processing speed through the device. Any other packet is considered and in most cases should be dropped. invalid Based on this information we can set a basic set of filter rules to speed up packet filtering and reduce the load on the CPU by accepting established/related packets, dropping packets, and working on more detailed filtering only for packets. invalid new ip firewall filter add chain=input connection-state=invalid action=drop comment="Drop Invalid connections" add chain=input connection-state=established,related,untracked action=accept comment="Allow Established/Related /Untracked connections FastTrack IPv4 FastTrack is a special handler that bypasses Linux facilities allowing for faster packet forwarding. The handler is used for and connections TCP UDP marked with " " action. IPv4 FastTrack handler supports NAT (SNAT, DNAT, or both). fasttrack-connection Note that not all packets of the connection can be FastTracked, so it is likely to see some packets going through a slow path even though the connection is marked for FastTrack. This is the reason why is usually followed by an identical " " rule. fasttrack-connection action=accept FastTrack-ed packets are bypassing: firewall, connection tracking, simple queues, queue tree with , parent=global IP accounting, IPSec, hotspot universal client, VRF assignment It is up to the administrator to make sure FastTrack does not interfere with other configuration. Requirements IPv4 FastTrack is active if the following conditions are met: nomesh, metarouter interface configuration; sniffer, torch, or traffic generator is not running; /tool mac-scan is not actively used; /tool ip-scan is not actively used; FastPath and Route cache is enabled under IP/Settings Example For example, for SOHO routers with factory default configuration, you could FastTrack all LAN traffic with this one rule placed at the top of the Firewall Filter. The same configuration accept rule is required: Such a rule set must not be applied on routers with asymmetric routing, because asymmetrically routed packets may be considered invalid and dropped.

/ip firewall filter add chain=forward action=fasttrack-connection connection-state=established,related /ip firewall filter add chain=forward action=accept connection-state=established,related Connection tracking settings Connection tracking settings are managed from /ip firewall connection tracking menu. Properties Property Description enabled (yes | no | auto ; Default: ) autoAllows to disable or enable connection tracking. With disabled connection tracking firewall features listed above will stop working. If set to " " connection tracking is disabled until at least one firewall rule is added.auto loose-tcp-tracking (;yes Default: ) yes In case loose-tcp-tracking=yes, the 2nd part (SYN,ACK) and 3rd part (ACK) of the handshake without having seen the first initial SYN will be considered ESTABLISHED In case loose-tcp-tracking=no, the 2nd part (SYN,ACK) and 3rd part (ACK) without having seen the first initial SYN will be considered INVALID tcp-syn-sent-timeout (ti ; Default: ) me 5sTCP SYN timeout. tcp-syn-received- timeout ( ; Default:time )5sTCP SYN timeout. tcp-established-timeout ( ; Default: ) time 1dTime after which established TCP connection times out. tcp-fin-wait-timeout (time ; Default: ) 10s tcp-close-wait-timeout ( ; Default: ) time 10s tcp-last-ack-timeout (ti ; Default: ) me 10s tcp-time-wait-timeout (ti ; Default: ) me 10s tcp-close-timeout ( ;time Default: ) 10s udp-timeout ( ; time Default: ) 30sSpecifies the timeout for UDP connections that have seen packets in one direction udp-stream-timeout (ti ; Default: ) me 3mSpecifies the timeout of UDP connections that have seen packets in both directions Connection is FastTracked until the connection is closed, timed-out, or router is rebooted. Dummy rules will disappear only after FastTrack firewall rules will be deleted/disabled and the router rebooted. While FastPath and FastTrack both are enabled on the device only one can be active at a time. Queues (except Queue Trees parented to interfaces), firewall filter, and mangle rules will not be applied for FastTracked traffic.

icmp-timeout ( ; time Default: ) 10sICMP connection timeout generic-timeout ( ; time Default: ) 10mTimeout for all other connection entries Read-only properties Property Description max-entries ( ) integerMax amount of entries that the connection tracking table can hold. This value depends on the installed amount of RAM. Note that the system does not create a maximum-size connection tracking table when it starts, it may increase if the situation demands it and the system still has free RAM, but the size will not exceed 1048576 total-entries ( ) integerAmount of connections that the connection table currently holds Connection List List of tracked connections ban be seen in /ip firewall connection for ipv4 and /ipv6 firewall connection for IPv6. Properties All properties in the connection list are read-only Property Description assured ( ) yes | no Indicates that this connection is assured and that it will not be erased if the maximum possible tracked connection count is reached. confirmed ( ) yes | no Connection is confirmed and a packet is sent out from the device. only.IPv4 connection-mark ( ) string Connection mark that was set by mangle rule. the connection-type ( ) pptp | ftp Type of connection, the property is empty if connection tracking is unable to determine a predefined connection type. dst-address ( ) ip[:port] Destination address and port (for if a protocol is port-based).IPv4 dst-port ( ) integer Destination port if protocol is port-based. only.IPv6 dstnat ( ) yes | no A connection has gone through DST-NAT (for example, port forwarding). dying ( ) yes | no The connection is dying due to a connection timeout. only.IPv4 expected ( ) yes | no Connection is set up using connection helpers (pre-defined service rules). only.IPv4 fasttrack ( ) yes | no Whether the connection is FastTracked. only.IPv4 gre-key ( ) integer Contents of the GRE Key field. gre-protocol ( ) string Protocol of the encapsulated payload. gre-version ( ) string A version of the GRE protocol was used in the connection. hw-offload ( ) yes | no IPv4 only. icmp-code ( ) string ICMP Code Field icmp-id ( ) integer Contains the ICMP ID icmp-type ( ) integer ICMP Type Number

orig-bytes ( ) integer Amount of bytes sent out from the source address using the specific connection. only.IPv4 orig-fasttrack-bytes ( ) integer Amount of FastTracked bytes sent out from the source address using the specific connection. only.IPv4 orig-fasttrack-packets (integ )erAmount of FastTracked packets sent out from the source address using the specific connection. only.IPv4 orig-packets ( ) integer Amount of packets sent out from the source address using the specific connection. only.IPv4 orig-rate ( ) integer The data rate at which packets are sent out from the source address using the specific connection. only.IPv4 protocol ( ) string IP protocol type repl-bytes ( ) integer Amount of bytes received from the destination address using the specific connection. only.IPv4 repl-fasttrack-bytes ( ) string Amount of FastTracked bytes received from the destination address using the specific connection. only.IPv4 repl-fasttrack-packets (integ )erAmount of FastTracked packets received from the destination address using the specific connection. only.IPv4 repl-packets ( ) integer Amount of packets received from the destination address using the specific connection. only.IPv4 repl-rate ( ) string The data rate at which packets are received from the destination address using the specific connection. only.IPv4 reply-dst-address ( ) ip[:port] Destination address (and port for ) expected of return packets. Usually the same as "src-address: port"IPv4 reply-dst-port ( ) integer IPv6 only. reply-src-address ( ) ip[:port] Source address (and port for ) expected of return packets. Usually the same as "dst-address: port"IPv4 seen-reply ( ) yes | no The destination address has replied to the source address. src-address ( ) ip[:port] The source address and port (for if a protocol is port-based).IPv4 src-port ( ) integer IPv6 only. srcnat ( ) yes | no Connection is going through SRC-NAT, including packets that were masqueraded through NAT. tcp-state ( ) string The current state of TCP connection : "established" "time-wait" "close" "syn-sent" "syn-received" timeout ( )time Time after connection will be removed from the connection list.

For example, a packet should be matched against the IP address:port pair. Of course, it could be achieved by adding as many rules with IP address:port match as required to the forward chain, but a better way could be to add one rule that matches traffic from a particular IP address. Then rules that perform matching against separate ports can be added to " " chain without specifying the IP addresses. mychain /ip firewall filter add chain=mychain protocol=tcp dst-port=22 action=accept add chain=mychain protocol=tcp dst-port=23 action=accept add chain=input src-address=1.1.1.2/32 jump-target="mychain" When processing a chain, rules are taken from the chain in the order they are listed, from top to bottom. If a packet matches the criteria of the rule, then the specified action is performed on it, and no more rules are processed in that chain (the exception is the action). passthrough If a packet has not matched any rule within the chain, then it is accepted. Each firewall module has its own pre-defined chains: raw: prerouting output filter input forward output mangle prerouting input forward output postrouting nat srcnat dstnat More detailed packet processing in RouterOS is described in the diagram. Packet Flow in the RouterOS

Filter Introduction Firewall Example IPv4 firewall Protect the router itself Protect the LAN devices IPv6 firewall Protect the router itself Protect the LAN devices Matchers Actions RAW Filtering Basic RAW Example Read More Introduction Firewall filters are used to allow or block specific packets forwarded to your local network, originating from your router, or destined to the router. There are two methods on how to set up filtering: allow specific traffic and drop everything else drop only malicious traffic, everything else is allowed. Both methods have pros and cons, for example, from a security point of view first method is much more secure, but requires administrator input whenever traffic for a new service needs to be accepted. This strategy provides good control over the traffic and reduces the possibility of a breach because of service misconfiguration. On the other hand, when securing a customer network it would be an administrative nightmare to accept all possible services that users may use. Therefore careful planning of the firewall is essential in advanced setups. A firewall filter consists of three predefined chains that cannot be deleted: - input used to process packets through one of the interfaces with the destination IP address which is one of the router's entering the router addresses. Packets passing through the router are not processed against the rules of the input chain forward - used to process packets passing through the router output - used to process packets and leaving it through one of the interfaces. Packets passing through the router are originating from the router not processed against the rules of the output chain Firewall filter configuration is accessible from menu for IPv4 and menu for IPv6. ip/firewall/filter ipv6/firewall/filter Firewall Example Lets look at basic firewall example to protect router itself and clients behind the router, for both IPv4 and IPv6 protocols.

IPv4 firewall Protect the router itself Rules of thumb followed to set up the firewall: work with connections to decrease the load on a router;new accept what you need drop everything else, could be set to log some attackers, but keep in mind that it may add some load to he CPU on heavy attacks. log=yes We always start by accepting already known and accepted connections, so the first rule should be to accept "established" and "related" connections. /ip firewall filter add action=accept chain=input comment="default configuration" connection-state=established,related Now we can proceed by accepting some new connections, in our example we want to allow access ICMP protocol from any address and everything else only from 192.168.88.2-192.168.88.254 address range. For that we create an address list and two firewall rules. /ip firewall address-list add address=192.168.88.2-192.168.88.254 list=allowed_to_router /ip firewall filter add action=accept chain=input src-address-list=allowed_to_router add action=accept chain=input protocol=icmp And lastly we drop everything else: add action=drop chain=input Complete set of just created rules: /ip firewall filter add action=accept chain=input comment="default configuration" connection-state=established,related add action=accept chain=input src-address-list=allowed_to_router add action=accept chain=input protocol=icmp add action=drop chain=input /ip firewall address-list add address=192.168.88.2-192.168.88.254 list=allowed_to_router Protect the LAN devices Concept in protecting the users is very similar, except that in this case we are blocking unwanted traffic and accepting everythign else. At first we will create with the name "not_in_internet" which we will use for the firewall filter rules: address-list

/ip firewall address-list add address=0.0.0.0/8 comment=RFC6890 list=not_in_internet add address=172.16.0.0/12 comment=RFC6890 list=not_in_internet add address=192.168.0.0/16 comment=RFC6890 list=not_in_internet add address=10.0.0.0/8 comment=RFC6890 list=not_in_internet add address=169.254.0.0/16 comment=RFC6890 list=not_in_internet add address=127.0.0.0/8 comment=RFC6890 list=not_in_internet add address=224.0.0.0/4 comment=Multicast list=not_in_internet add address=198.18.0.0/15 comment=RFC6890 list=not_in_internet add address=192.0.0.0/24 comment=RFC6890 list=not_in_internet add address=192.0.2.0/24 comment=RFC6890 list=not_in_internet add address=198.51.100.0/24 comment=RFC6890 list=not_in_internet add address=203.0.113.0/24 comment=RFC6890 list=not_in_internet add address=100.64.0.0/10 comment=RFC6890 list=not_in_internet add address=240.0.0.0/4 comment=RFC6890 list=not_in_internet add address=192.88.99.0/24 comment="6to4 relay Anycast [RFC 3068]" list=not_in_internet Brief firewall filter rule explanation: packets with added to FastTrack for faster data throughput, the firewall will work with new connections only; connection-state=established,related drop connection and log them with prefix "invalid"; invalid drop attempts to reach not public addresses from your local network, apply before, "bridge" is local network interface, address-list=not_in_internet log=yes attempts with prefix "!public_from_LAN"; drop incoming packets that are not NAT`ed, ether1 is public interface, log attempts with "!NAT" prefix; jump to ICMP chain to drop unwanted ICMP messages drop incoming packets from the Internet, which are not public IP addresses, ether1 is a public interface, log attempts with prefix "!public"; drop packets from LAN that does not have LAN IP, 192.168.88.0/24 is local network used subnet; /ip firewall filter add action=fasttrack-connection chain=forward comment=FastTrack connection-state=established,related add action=accept chain=forward comment="Established, Related" connection-state=established,related add action=drop chain=forward comment="Drop invalid" connection-state=invalid log=yes log-prefix=invalid add action=drop chain=forward comment="Drop tries to reach not public addresses from LAN" dst-address- list=not_in_internet in-interface=bridge log=yes log-prefix=!public_from_LAN out-interface=!bridge add action=drop chain=forward comment="Drop incoming packets that are not NAT`ted" connection-nat-state=!dstnat connection-state=new in-interface=ether1 log=yes log-prefix=!NAT add action=jump chain=forward protocol=icmp jump-target=icmp comment="jump to ICMP filters" add action=drop chain=forward comment="Drop incoming from internet which is not public IP" in-interface=ether1 log=yes log-prefix=!public src-address-list=not_in_internet add action=drop chain=forward comment="Drop packets from LAN that do not have LAN IP" in-interface=bridge log=yes log-prefix=LAN_!LAN src-address=!192.168.88.0/24 Allow only needed ICMP codes in "icmp" chain: /ip firewall filter add chain=icmp protocol=icmp icmp-options=0:0 action=accept \ comment="echo reply" add chain=icmp protocol=icmp icmp-options=3:0 action=accept \ comment="net unreachable" add chain=icmp protocol=icmp icmp-options=3:1 action=accept \ comment="host unreachable" add chain=icmp protocol=icmp icmp-options=3:4 action=accept \ comment="host unreachable fragmentation required" add chain=icmp protocol=icmp icmp-options=8:0 action=accept \ comment="allow echo request" add chain=icmp protocol=icmp icmp-options=11:0 action=accept \ comment="allow time exceed" add chain=icmp protocol=icmp icmp-options=12:0 action=accept \ comment="allow parameter bad" add chain=icmp action=drop comment="deny all other types" IPv6 firewall

Protect the router itself Very similar to IPv4 setup, except that we have to deal with more protocols required for IPv6 to function properly. At first we create an from which you allow access to the device: address-list /ipv6 firewall address-list add address=fd12:672e:6f65:8899::/64 list=allowed Brief IPv6 firewall filter rule explanation: work with packets, accept packets; new established/related drop addresses from Internet(public) interface/interface-list; link-local accept access to a router from addresses, accept addresses for management purposes, accept your source for link-local multicast address-list router access; drop anything else; /ipv6 firewall filter add action=accept chain=input comment="allow established and related" connection-state=established,related add chain=input action=accept protocol=icmpv6 comment="accept ICMPv6" add chain=input action=accept protocol=udp port=33434-33534 comment="defconf: accept UDP traceroute" add chain=input action=accept protocol=udp dst-port=546 src-address=fe80::/10 comment="accept DHCPv6-Client prefix delegation." add action=drop chain=input in-interface=in_interface_name log=yes log-prefix=dropLL_from_public src- address=fe80::/10 add action=accept chain=input comment="allow allowed addresses" src-address-list=allowed add action=drop chain=input /ipv6 firewall address-list add address=fe80::/16 list=allowed add address=xxxx::/48 list=allowed add address=ff02::/16 comment=multicast list=allowed Protect the LAN devices This step is more important than it is for IPv4. In IPv4 setups clients mostly have addresses from local address range and are NATed to public IP, that way they are not directly reachable from the public networks. IPv6 is a different story. In most common setups, enabled IPv6 makes your clients available from the public networks, so proper firewall filter rules to protect your customers are mandatory. In brief we will very basic LAN protection should: accept and work with packets; established/related new drop packets; invalid accept ICMPv6 packets; accept connections originated only from your clients to the public network;new drop everything else. /ipv6 firewall filter add action=accept chain=forward comment=established,related connection-state=established,related add action=drop chain=forward comment=invalid connection-state=invalid log=yes log-prefix=ipv6,invalid add action=accept chain=forward comment=icmpv6 in-interface=!in_interface_name protocol=icmpv6 add action=accept chain=forward comment="local network" in-interface=!in_interface_name src-address-list=allowed add action=drop chain=forward log-prefix=IPV6 In certain setups where the DHCPv6 relay is used, the src address of the packets may not be from the link-local range. In that case, the src- address parameter of rule #4 must be removed or adjusted to accept the relay address.

Matchers All matcher properties are common and listed .here Actions Tables below shows list of filter specific actions and associated properties. Other actions are listed .here Property Description action ( ; Default: ) action name accept drop - silently drop the packet fasttrack-connection - process packets from a connection using FastPath by enabling for the connection. FastTrack IP only.v4 reject - drop the packet and send an ICMP reject message; this action allows ICMP reply specification, such as: prohibit or unreachable admin/host/network/port tarpit - captures and holds TCP connections (replies with SYN/ACK to the inbound TCP SYN packet). only.IPv4 reject-with (icmp-no-route | icmp-admin-prohibited | icmp-not-neighbour | icmp- address-unreachable | icmp-port-unreachable | tcp-reset | icmp-err-src-routing- ; Default: ) header | icmp-headers-too-long icmp-no-routeSpecifies to be sent back if the packet is rejected. ICMP error Applicable if action=reject icmp-no-route: sends ICMP address no-route message. ICMP type 2, code 0 icmp-admin-prohibited: sends ICMP address prohibited message. ICMP type 2, code 1 icmp-not-neighbour: sends ICMP address not-member message. ICMP type 2, code 2 icmp-address-unreachable: sends ICMP address unreachable message. ICMP type 2, code 3 icmp-port-unreachable: sends ICMP port unreachable message. ICMP type 2, code 4 tcp-reset: sends ICMP resetting a TCP connection. ICMP type 2, code 6 icmp-err-src-routing-header: sends ICMP Error in Source Routing Header message. ICMP type 2, code 7 icmp-headers-too-long: sends ICMP Headers too long message. ICMP type 2, code 8 RAW Filtering The firewall RAW table allows to selectively bypass or drop packets before connection tracking, that way significantly reducing the load on the CPU. The tool is very useful for DoS/DDoS attack mitigation. RAW filter configuration is accessible from menu for IPv4 and menu for IPv6. ip/firewall/raw ipv6/firewall/raw The RAW table does not have matchers that depend on connection tracking ( like connection-state, layer7, etc.). If a packet is marked to bypass the connection tracking packet de-fragmentation will not occur. Also RAW firewall can have rules only in two chains: prerouting - used to process any packet entering the router output - used to process packets originated from the router and leaving it through one of the interfaces. Packets passing through the router are not processed against the rules of the output chain

And has one specific action: Property Description action ( ; action name Default: ) accept notrack - do not send a packet to connection tracking. Useful when you still need to use regular firewall, but do not require connection tracking. Basic RAW Example Let's assume that we have OSPF configuration, but due to connection tracking OSPF have adjacency problems. We can use RAW rules to fix this, by not sending OSPF packets to connection tracking. /ip firewall raw add chain=prerouting protocol=ospf action=notrack add chain=output protocol=ospf action=notrack Read More Building advanced firewall Connection Rate SSH bruteforce protection Syn/DoS protection

Mangle Introduction Configuration example Change MSS Marking Connections Mangle Actions Introduction Mangle is a kind of 'marker' that marks packets for future processing with special marks. Many other facilities in RouterOS make use of these marks, e.g. queue trees, NAT, routing. They identify a packet based on its mark and process it accordingly. The mangle marks exist only within the router, they are not transmitted across the network. Additionally, the mangle facility is used to modify some fields in the IP header, like TOS (DSCP) and TTL fields. Firewall mangle rules consist of five predefined chains that cannot be deleted: The chain: Rules in this chain apply to packets as they just arrive on the network interface; PREROUTING The chain: Rules in this chain apply to packets just before they’re given to a local process; INPUT The chain: The rules here apply to packets just after they’ve been produced by a process; OUTPUT The chain: The rules here apply to any packets that are routed through the current host; FORWARD The chain: The rules in this chain apply to packets as they just leave the network interface; POSTROUTING Configuration example Change MSS It is a known fact that VPN links have a smaller packet size due to encapsulation overhead. A large packet with MSS that exceeds the MSS of the VPN link should be fragmented before sending it via that kind of connection. However, if the packet has a flag set, it cannot be fragmented and Don't Fragment should be discarded. On links that have broken path MTU discovery (PMTUD), it may lead to a number of problems, including problems with FTP and HTTP data transfer and e-mail services. In the case of a link with broken PMTUD, a decrease of the MSS of the packets coming through the VPN link resolves the problem. The following example demonstrates how to decrease the MSS value via mangle: /ip firewall mangle add out-interface=pppoe-out protocol=tcp tcp-flags=syn action=change-mss new-mss=1300 chain=forward tcp-mss=1301-65535

Marking Connections Sometimes it is necessary to perform some actions on the packets belonging to specific connection (for example, to mark packets from/to specific host for queues), but inspecting each packets IP header is quite expensive task. We can use connection marks to optimize the setup a bit. /ip firewall mangle add chain=forward in-interface=local src-address=192.168.88.123 connection-state=new action=mark-connection new- connection-mark=client_conn add chain=forward connection-mark=client_conn action=mark-packet new-packet-mark=client_p Mangle Actions Table list mangle actions and associated properties. Other actions are listed .here Property Description action ( ; Default: action name ) accept change-dscp - change the Differentiated Services Code Point (DSCP) field value specified by the new-dscp parameter change-mss - change the Maximum Segment Size field value of the packet to a value specified by the new- parametermss change-ttl - change the Time to Live field value of the packet to a value specified by the new-ttl parameter clear-df - clear 'Do Not Fragment' Flag fasttrack-connection - shows fasttrack counters, useful for statistics mark-connection - place a mark specified by the new-connection-mark parameter on the entire connection that matches the rule mark-packet - place a mark specified by the new-packet-mark parameter on a packet that matches the rule mark-routing - place a mark specified by the new-routing-mark parameter on a packet. This kind of mark is used for policy routing purposes only. Do not apply any other routing marks besides "main" for the packets processed by FastTrack, since FastTrack can only work in the main routing table. route - forces packets to a specific gateway IP by ignoring normal routing decisions (prerouting chain only) set-priority - set priority specified by the new-priority parameter on the packets sent out through a link that is capable of transporting priority (VLAN or WMM-enabled wireless interface). Read more sniff-pc - send a packet to a remote RouterOS CALEA server. sniff-tzsp - send a packet to a remote TZSP compatible system (such as Wireshark). Set remote target with and parameters (Wireshark recommends port 37008) sniff-target sniff-target-port strip-ipv4-options - strip IPv4 option fields from IP header, the action does not actually remove IPv4 options but rather replaces all option octets with NOP, further matcher with will still ipv4-options=any match the packet. new-dscp ( ; integer: 0..63 Default: )Sets a new DSCP value for a packet new-mss ( ; Default: ) integer Sets a new MSS for a packet. new-packet-mark ( ; string Default: )Sets a new value packet-mark new-priority (integer | from- dscp | from-dscp-high-3-bits ; Default: ) | from-ingressSets a new priority for a packet. This can be the VLAN, WMM, DSCP or MPLS EXP priority . This Read more property can also be used to set an internal priority. Clamp-to-pmtu feature sets (DF) bit in the IP header to dynamically discover the PMTU of a path. Host sends all datagrams on that path with the DF bit set until receives ICMP Destination Unreachable messages with a code meaning "fragmentation needed and DF set". Upon receipt of such a message, the source host reduces its assumed PMTU for the path.

new-routing-mark ( ; string Default: )Sets a new value (in RouterOS v7 routing mark must be created before as a new ) routing-mark Routing table new-ttl (decrement | ; increment | set:integer Default: )Sets a new Time to live value route-dst ( ) IP, Default: Matches packets with a specific gateway

NAT Introduction Types of NAT: Destination NAT Source NAT Masquerade CGNAT (NAT444) Hairpin NAT Endpoint-Independent NAT NAT Helpers Introduction Network Address Translation is an Internet standard that allows hosts on local area networks to use one set of IP addresses for internal communications and another set of IP addresses for external communications. A LAN that uses NAT is ascribed as a network. For NAT to function, there should be natted a NAT gateway in each network. The NAT gateway (NAT router) performs IP address rewriting on the way while packets travel from/to LAN. In natted RouterOS NAT is supported for IPv4. RouterOS does not support NAT64. Nat matches only the first packet of the connection, connection tracking remembers the action and performs on all other packets belonging to the same connection. Types of NAT: There are two types of NAT: source NAT or srcnat. This type of NAT is performed on from a natted network. A NAT router replaces the private packets that are originated source address of an IP packet with a new public IP address as it travels through the router. A reverse operation is applied to the reply packets traveling in the other direction. destination NAT or dstnat. This type of NAT is performed on for the natted network. It is most commonly used to make packets that are destined hosts on a private network to be accessible from the Internet. A NAT router performing dstnat replaces the destination IP address of an IP packet as it travels through the router toward a private network. Since RouterOS v7 the firewall NAT has two new INPUT and OUTPUT chains which are traversed for packets delivered to and sent from applications : running on the local machine input - used to process packets through one of the interfaces with the destination IP address which is one of the router's entering the router addresses. Packets passing through the router are not processed against the rules of the input chain. Whenever NAT rules are changed or added, the connection tracking table should be cleared otherwise NAT rules may seem to be not functioning correctly until the connection entry expires.

Every time when interface disconnects and/or its IP address changes, the router will clear all masqueraded connection tracking entries related to the interface, this way improving system recovery time after public IP change. If is used instead of connection tracking entries remain srcnat masquerade , and connections can simply resume after a link failure. Unfortunately, this can lead to some issues with unstable links when the connection gets routed over different links after the primary link goes down. In such a scenario following things can happen: on disconnect, all related connection tracking entries are purged; next packet from every purged (previously masqueraded) connection will come into the firewall as , and, if a primary interface is not back, a new packet will be routed out via an alternative route (if you have any) thus creating a new masqueraded connection; the primary link comes back, routing is restored over the primary link, so packets that belong to existing connections are sent over the primary interface without being masqueraded, that way leaking local IPs to a public network. To work around this situation route can be created as an alternative to the route that might disappear on disconnect. blackhole Hosts behind a NAT-enabled router do not have true end-to-end connectivity. Therefore some Internet protocols might not work in scenarios with NAT. Services that require the initiation of TCP connection from outside the private network or stateless protocols such as UDP, can be disrupted. To overcome these limitations RouterOS includes a number of so-called NAT helpers, that enable NAT traversal for various protocols. When action=src is used instead, connection tracking entries remain and connections can simply resume.nat CGNAT ( NAT444) To combat IPv4 address exhaustion, a new RFC 6598 was deployed. The idea is to use shared 100.64.0.0/10 address space inside the carrier's network and perform NAT on the carrier's edge router to a single public IP or public IP range. Because of the nature of such a setup, it is also called NAT444, as opposed to a NAT44 network for a 'normal' NAT environment, three different IPv4 address spaces are involved. CGNAT configuration on RouterOS does not differ from any other regular source NAT configuration: /ip firewall nat add chain=src-nat action=srcnat src-address=100.64.0.0/10 to-address=2.2.2.2 out-interface=<public_if> Where: 2.2.2.2 - public IP address, public_if - interface on provider's edge router connected to the internet The advantage of NAT444 is obvious, fewer public IPv4 addresses are used. But this technique comes with major drawbacks: The service provider router performing CGNAT needs to maintain a state table for all the address translations: this requires a lot of memory and CPU resources. Console gaming problems. Some games fail when two subscribers using the same outside public IPv4 address try to connect to each other. Tracking users for legal reasons means extra logging, as multiple households go behind one public address. Though Source NAT and masquerading perform the same fundamental function: mapping one address space into another one, the details differ slightly. Most noticeably, masquerading chooses the source IP address for the outbound packet from the IP bound to the interface through which the packet will exit.

Anything requiring incoming connections is broken. While this already was the case with regular NAT, end-users could usually still set up port forwarding on their NAT router. CGNAT makes this impossible. This means no web servers can be hosted here, and IP Phones cannot receive incoming calls by default either. Some web servers only allow a maximum number of connections from the same public IP address, as a means to counter DoS attacks like SYN floods. Using CGNAT this limit is reached more often and some services may be of poor quality. 6to4 requires globally reachable addresses and will not work in networks that employ addresses with a limited topological span. Packets with Shared Address Space source or destination addresses MUST NOT be forwarded across Service Provider boundaries. Service Providers MUST filter such packets on ingress links. In RouterOS this can be easily done with firewall filters on edge routers: /ip firewall filter add chain=input src-address=100.64.0.0/10 action=drop in-interface=<public_if> add chain=output dst-address=100.64.0.0/10 action=drop out-interface=<public_if> add chain=forward src-address=100.64.0.0/10 action=drop in-interface=<public_if> add chain=forward src-address=100.64.0.0/10 action=drop out-interface=<public_if> add chain=forward dst-address=100.64.0.0/10 action=drop out-interface=<public_if> Service providers may be required to log of MAPed addresses, in a large CGN deployed network which may be a problem. Fortunately, RFC 7422 suggests a way to manage CGN translations in such a way as to significantly reduce the amount of logging required while providing traceability for abuse response. RFC states that instead of logging each connection, CGNs could deterministically map customer private addresses (received on the customer-facing interface of the CGN, a.k.a., internal side) to public addresses extended with port ranges. That means that separate NAT rules have to be added to achieve individual mappings such as the ones seen in the below example: Inside IP Outside IP/Port range 100.64.0.1 2.2.2.2:5000-5199 100.64.0.2 2.2.2.2:5200-5399 100.64.0.3 2.2.2.2:5400-5599 100.64.0.4 2.2.2.2:5600-5799 100.64.0.5 2.2.2.2:5800-5999 Instead of writing the rules by hand, it is suggested to use a script instead. The following example could be adapted to any requirements of your setup. { ######## Adjustable values ######### :local StartingAddress 100.64.0.1 :local ClientCount 5 :local AddressesPerClient 2 :local PublicAddress 2.2.2.2 :local StartingPort 5000 :local PortsPerAddress 200 #################################### # All client chain jump /ip firewall nat add chain=srcnat action=jump jump-target=clients \ src-address="$StartingAddress-$($StartingAddress + ($ClientCount * $AddressesPerClient) - 1)" :local currentPort $StartingPort :for c from=1 to=$ClientCount do={ # Specific client chain jumps :if ($AddressesPerClient > 1) do={ /ip firewall nat add chain=clients action=jump jump-target="client-$c" \ src-address="$($StartingAddress + ($AddressesPerClient * ($c - 1)))-$($StartingAddress + ($AddressesPerClient * $c -1))" } else={ /ip firewall nat add chain=clients action=jump jump-target="client-$c" \ src-address="$($StartingAddress + ($AddressesPerClient * ($c - 1)))" }

1. 2. 3. 4. 5. protocol=udp src-address=100.64.0.6 [...] Hairpin NAT Hairpin network address translation ( ) is where the device on the LAN can access another machine on the LAN via the public IP address of NAT Loopback the gateway router. In the above example, the gateway router has the following configuration rule: dst-nat /ip firewall nat add chain=dstnat action=dst-nat dst-address=172.16.16.1 dst-port=443 to-addresses=10.0.0.3 to- ports=443 protocol=tcp When a user from the PC at home establishes a connection to the web server, the router performs DST NAT as configured: the client sends a packet with a source IP address of 192.168.88.1 to a destination IP address of 172.16.16.1 on port 443 to request some web resources; the router destination NAT`s the packet to 10.0.0.3 and replaces the destination IP address in the packet accordingly. The source IP address stays the same: 192.168.88.1; the server replies to the client's request and the reply packet has a source IP address of 10.0.0.3 and a destination IP address of 192.168.88.1. the router determines that the packet is part of a previous connection and undoes the destination NAT, and puts the original destination IP address into the source IP address field. The destination IP address is 192.168.88.1, and the source IP address is 172.16.16.1; The client receives the reply packet it expects, and the connection is established;

1. 2. 3. 4. 1. 2. 3. 4. But, there will be a , when a client on the same network as the web server requests a connection to the web server's IP address: problem public the client sends a packet with a source IP address of 10.0.0.2 to a destination IP address of 172.16.16.1 on port 443 to request some web resources; the router destination NATs the packet to 10.0.0.3 and replaces the destination IP address in the packet accordingly. The source IP address stays the same: 10.0.0.2; the server replies to the client's request. However, the source IP address of the request is on the same subnet as the web server. The web server does not send the reply back to the router but sends it back directly to 10.0.0.2 with a source IP address in the reply of 10.0.0.3; The client receives the reply packet, but it discards it because it expects a packet back from 172.16.16.1, and not from 10.0.0.3; To resolve this issue, we will configure a new rule (the hairpin NAT rule) as follows: src-nat /ip firewall nat add action=masquerade chain=srcnat dst-address=10.0.0.3 out-interface=LAN protocol=tcp src-address=10.0.0.0/24 After configuring the rule above: the client sends a packet with a source IP address of 10.0.0.2 to a destination IP address of 172.16.16.1 on port 443 to request some web resources; the router destination NATs the packet to 10.0.0.3 and replaces the destination IP address in the packet accordingly. It also source NATs the packet and replaces the source IP address in the packet with the IP address on its LAN interface. The destination IP address is 10.0.0.3, and the source IP address is 10.0.0.1; the web server replies to the request and sends the reply with a source IP address of 10.0.0.3 back to the router's LAN interface IP address of 10.0.0.1; the router determines that the packet is part of a previous connection and undoes both the source and destination NAT, and puts the original destination IP address of 10.0.0.3 into the source IP address field, and the original source IP address of 172.16.16.1 into the destination IP address field Endpoint-Independent NAT Endpoint-independent NAT creates mapping in the source NAT and uses the same mapping for all subsequent packets with the same source IP and port. This mapping is created with the following rule: /ip firewall nat add action=endpoint-independent-nat chain=srcnat out-interface=WAN protocol=udp This mapping allows running source-independent filtering, which allows forwarding packets from any source from WAN to mapped internal IP and port. The following rule enables filtering: /ip firewall nat add action=endpoint-independent-nat chain=dstnat in-interface=WAN protocol=udp Additionally, endpoint-independent-nat can take a few other parameters: randomize-port - randomize to which public port connections will be mapped. More info section 2.2.3 and 2.2.5 https://www.ietf.org/rfc/rfc5128.txt Endpoint-independent NAT works only with UDP protocol.

NAT Helpers Hosts behind a NAT-enabled router do not have true end-to-end connectivity. Therefore some Internet protocols might not work in scenarios with NAT. To overcome these limitations RouterOS includes a number of NAT helpers, that enable NAT traversal for various protocols. Nat helpers can be managed from /ip firewall service-ports menu. List of available nat helpers: Helper Description FTP FTP service helper H323 H323 service helper IRC IRC service helper PPTP PPTP (GRE) tunneling helper UDPLITE UDP-Lite service helper DCCP DCCP service helper SCTP SCTP service helper SIP SIP helper. Additional options: sip-direct-media allows redirecting the RTP media stream to go directly from the caller to the callee. The default value is . yes sip-timeout allows adjusting TTL of SIP UDP connections. Default: 1 hour. In some setups, you have to reduce that. TFTP TFTP service helper RSTP RTSP service helper NAT Actions Table lists NAT actions and their associated properties. Other actions are listed .here Property Description action ( ; action name Default: ) accept dst-nat - replaces the destination address and/or port of an IP packet with values specified by a to-addresses nd parameters to-ports masquerade - replaces the source port of an IP packet with one specified by parameter and replace to-ports the source address of an IP packet to the IP determined by the routing facility. netmap - creates a static 1:1 mapping of one set of IP addresses to another one. Often used to distribute public IP addresses to hosts on private networks redirect - replaces the destination port of an IP packet with one specified by parameter and to-ports destination address to one of the router's local addresses If connection tracking is not enabled then firewall service ports will be shown as inactive udplite , , and are built-in services of the connection tracking. Since these are not separately loaded modules, they cannot be disabled dccp sctp separately, they got disabled together with the connection tracking.

same - gives a particular client the same source/destination IP address from a supplied range for each connection. This is most frequently used for services that expect the same client address for multiple connections from the same client. onlyIPv4 src-nat - replaces the source address of an IP packet with values specified by and to-addresses to-ports parameters endpoint-independent-nat - uses endpoint-independent mapping and filtering. Works only with UDP protocol. only.IPv4 same-not-by-dst (yes | ; Default: )noSpecifies whether to take into account or not the destination IP address when selecting a new source IP address. Applicable if action=same to-addresses (IP address ; Default: [-IP address] 0. ) 0.0.0Replace the original address with the specified one. Applicable if action is , , , dst-nat netmap samesrc-nat to-ports (integer[- ; integer]: 0..65535 Default: )Replace the original port with the specified one. Applicable if action is , , , , dst-nat redirect masquerade netmap sa , mesrc-nat

Common Firewall Matchers and Actions Common Actions and Associated properties Stats Other Useful Commands Matchers Stateless Properties Stateful Properties Common Actions and Associated properties Property Description action ( ; Default: action name acce )ptAction to take if a packet is matched by the rule: accept - accept the packet. A packet is not passed to the next firewall rule. add-dst-to-address-list - add destination address to address list specified by parameter address-list add-src-to-address-list - add source address to address list specified by parameter address-list jump - jump to the user-defined chain specified by the value of parameter jump-target log - add a message to the system log containing the following data: in-interface, out-interface, src-mac, protocol, src-ip:port->dst-ip:port and length of the packet. After a packet is matched it is passed to the next rule in the list, similar as passthrough passthrough - if a packet is matched by the rule, increase counter and go to next rule (useful for statistics) return - passes control back to the chain from where the jump took place address-list ( ; Default: ) name Name of the address list to be used. Applicable if action is add-dst- to-address-list or add-src-to-address-list address-list-timeout (none- ; dynamic | none-static | time Default: ) none-dynamicTime interval after which the address will be removed from the address list specified by parameter. address-list Used in conjunction with or actions add-dst-to-address-list add-src-to-address-list Value of ( ) will leave the address in the address list till reboot none-dynamic 00:00:00 Value of will leave the address in the address list forever and will be included in the none-static configuration export/backup jump-target ( ; Default: ) name Name of the target chain to jump to. Applicable only if action=jump log ( ) yes | no; Default: no Add a message to the system log containing the following data: in-interface, out-interface, src-mac, protocol, src-ip: port->dst-ip:port, and length of the packet. Allows to log packets even if action is not " ", useful for debugging log firewall. log-prefix ( ; Default: ) string Adds specified text at the beginning of every log message. Applicable if or configured. action=loglog=yes Stats To view matching statistics by firewall rules, run /ip firewall filter print stats command or /ipv6 firewall filter print stats for IPv6 firewall. Property Description bytes ( ) integer The total amount of bytes matched by the rule packets ( ) integer The total amount of packets matched by the rule

In/Out interface lists IP Range Address type Address list TTL DSCP Length TLS IPv4 Options Dst Port Src Port Any Port TCP Options TCP MSS ICMP Codes Ingress Priority Priority Packet Mark Realm (routing table) Hotsopot Connection Mark Connection State Connection NAT State Connection Bytes Connection Limit Connection Rate Ipsec Policy Helper String (content) PSD Layer7 Random Nth PCC Limit Dst Limit Log For IPv6: Address type Address list Source MAC Address In/Out interfaces In/Out interface lists Hop Limit DSCP Length TLS IPv6 Header Dst Port Src Port Any Port TCP Options TCP MSS ICMPv6 Codes Ingress Priority Priority Packet Mark Connection Mark Connection State Connection NAT State Connection Bytes Connection Limit Connection Rate Ipsec Policy

Helper Match String (content) Random Nth PCC Limit Dst Limit Log Properties are split in two parts: stateless - properties do not require connection tracking to function and can be used in stateless RAW firewall matching. stateful - properties either require connection tracking to function or is available only in stateful firewall config. Stateless Properties Property Description chain ( ; Default: ) name Specifies to which chain rule will be added. If the input does not match the name of an already defined chain, a new chain will be created comment ( ; Default: ) string Descriptive comment for the rule content ( ; Default: ) string Match packets that contain specified text dscp ( ; Default: ) integer: 0..63 Matches DSCP IP header field. dst-address ( ; Default: ) IP/netmask | IP range Matches packets whose destination is equal to the specified IP or falls into the specified IP range. dst-address-list ( ; Default: ) name Matches the destination address of a packet against a user-defined address-list. dst-address-type ( ) unicast | local | broadcast | multicast Matches destination address type: unicast - IP address used for point to point transmission local - if dst-address is assigned to one of the router's interfaces broadcast - packet is sent to all devices in a subnet multicast - packet is forwarded to a defined group of devices dst-limit (integer[/time],integer,dst-address | dst-port | src- ; Default: ) address[/time]Matches packets until a given rate is exceeded. Rate is defined as packets per time interval. As opposed to the limitmatcher, every flow has its own limit. Flow is defined by a mode parameter. Parameters are written in the following format: rate[/time],burst, . mode[/expire] rate - packet count per time interval per-flow to match time - specifies the time interval in which the packet count rate per flow cannot be exceeded (optional, 1s will be used if not specified) burst - initial number of packets per flow to match: this number gets recharged by one every / , up to this number timerate mode - this parameter specifies what unique fields define flow (src-address, dst- address, src-and-dst-address, dst-address-and-port, addresses-and-dst-port) expire - specifies interval after which flow with no packets will be allowed to be deleted (optional) dst-port ( ; Default: ) integer[-integer]: 0..65535 List of destination port numbers or port number ranges fragment ( ; Default: ) yes|no Matches fragmented packets. The first (starting) fragment does not count. If connection tracking is enabled there will be no fragments as the system automatically assembles every packet. IPv4 only.

( header Type[:Mode]; Mode=contains|exact; Type=hop|dst|route|frag|ah|esp|none|proto )Matches IPv6 next-header. Two types of header matching are possible controlled by "mode" parameter: contains - soft matching, matches at least selected headers exact - matches exact set of selected headers IPv6 only. hop-limit (Mode:Value; Mode=equal | greater-than | less- than | not-equal; Value=0..255)Matches hop limit field in the IPv6 header. IPv6 only. hotspot ( ; auth | from-client | http | local-dst | to-client Default: )Matches packets received from HotSpot clients against various HotSpot matchers. auth - matches authenticated HotSpot client packets from-client - matches packets that are coming from the HotSpot client http - matches HTTP requests sent to the HotSpot server local-dst - matches packets that are destined to the HotSpot server to-client - matches packets that are sent to the HotSpot client IPv4 Only. icmp-options ( ; Default: ) integer:integer Matches ICMP type: code fields in-bridge-port ( ; Default: ) name Actual interface the packet has entered the router if the incoming interface is a bridge. Works only if is enabled in bridge settings. use-ip-firewall in-bridge-port-list ( ; Default: ) name Set of interfaces defined in interface list. Works the same as in-bridge-port in-interface ( ; Default: ) name Interface the packet has entered the router in-interface-list ( ; Default: ) name Set of interfaces defined in interface list. Works the same as in-interface ingress-priority ( ; Default: ) integer: 0..63 Matches the priority of an ingress packet. Priority may be derived from VLAN, WMM, DSCP, or MPLS EXP bit. read more ipsec-policy ( ; Default: ) in | out, ipsec | none Matches the policy used by IPsec. Value is written in the following format: direction, . The direction is Used to select whether to match the policy used for policy decapsulation or the policy that will be used for encapsulation. in - valid in the PREROUTING, INPUT, and FORWARD chains out - valid in the POSTROUTING, OUTPUT, and FORWARD chains ipsec - matches if the packet is subject to IPsec processing; none - matches packets that are not subject to IPsec processing (for example, IPSec transport packet). For example, if a router receives an IPsec encapsulated Gre packet, then rule ipsec- will match Gre packet, but a rule will policy=in,ipsec ipsec-policy=in,none match the ESP packet. ipv4-options (any | loose-source-routing | no-record-route | no-router-alert | no-source-routing | no-timestamp | none | record-route | router-alert | strict-source-routing | timestamp ; Default: )Matches IPv4 header options. any - match packet with at least one of the ipv4 options loose-source-routing - match packets with a loose source routing option. This option is used to route the internet datagram based on information supplied by the source no-record-route - match packets with no record route option. This option is used to route the internet datagram based on information supplied by the source no-router-alert - match packets with no router alter option no-source-routing - match packets with no source routing option no-timestamp - match packets with no timestamp option record-route - match packets with record route option router-alert - match packets with router alter option strict-source-routing - match packets with a strict source routing option timestamp - match packets with a timestamp IPv4 only.

limit ( ; Default: ) integer,time,integer Matches packets up to a limited rate (packet rate or bit rate). A rule using this matcher will match until this limit is reached. Parameters are written in the following format: rate[ . /time],burst:mode rate - packet or bit count per time interval to match time - specifies the time interval in which the packet or bit rate cannot be exceeded (optional, 1s will be used if not specified) burst - initial number of packets or bits to match: this number gets recharged every 10ms so burst should be at least 1/100 of a rate per second mode - packet or bit mode nth ( ; Default: ) integer,integer Matches every nth packet: rule will match every first packet of 2, hence, 50% of nth=2,1 all the traffic that is matched by the rule out-bridge-port ( ; Default: ) name Actual interface the packet leaves the router if the outgoing interface is a bridge. Works only if is enabled in bridge settings. use-ip-firewall out-bridge-port-list ( ; Default: ) name Set of interfaces defined in interface list. Works the same as out-bridge-port out-interface (; Default: ) Interface the packet is leaving the router out-interface-list ( ; Default: ) name Set of interfaces defined in interface list. Works the same as out-interface packet-mark ( ; Default: ) no-mark | string Matches packets marked via mangle facility with particular packet mark. If is no-mark set, the rule will match any unmarked packet. packet-size ( ; Default: ) integer[-integer]:0..65535 Matches packets of specified size or size range in bytes. per-connection-classifier (ValuesToHash:Denominator ; Default: ) /RemainderPCC matcher ( or Per Stream Classifier) allows dividing traffic into equal streams with the ability to keep packets with a specific set of options in one particular stream. Streams are hashed based on selected values to hash: both-addresses both-addresses-and-ports both-ports dst-address dst-address-and-port dst-port src-address src-address-and-port src-port Read more >> port ( ; Default: ) integer[-integer]: 0..65535 Matches if any (source or destination) port matches the specified list of ports or port ranges. Applicable only if is TCP or UDP protocol priority ( ; Default:) integer: 0..63 Matches the packet's priority after a new priority has been set. Priority may be derived from VLAN, WMM, DSCP, MPLS EXP bit, or from the priority that has been set using the s et-priority action. Read more protocol ( ; Default: ) name or protocol ID tcp Matches particular IP protocol specified by protocol name or number psd ( ; Default: ) integer,time,integer,integer Attempts to detect TCP and UDP scans. Parameters are in the following format WeightTh , , , reshold DelayThreshold LowPortWeight HighPortWeight WeightThreshold - total weight of the latest TCP/UDP packets with different destination ports coming from the same host to be treated as port scan sequence DelayThreshold - delay for the packets with different destination ports coming from the same host to be treated as possible port scan subsequence LowPortWeight - the weight of the packets with privileged (<1024) destination port HighPortWeight - the weight of the packet with a non-privileged destination port IPv4 only. random ( ; Default: ) integer: 1..99 Matches packets randomly with a given probability

src-address ( ; Default: ) Ip/Netmask, Ip range Matches packets whose source is equal to a specified IP or falls into a specified IP range src-address-list ( ; Default: ) name Matches the source address of a packet against a user-defined address list src-address-type (unicast | local | broadcast | multicast | Default: ) blackhole | prohibit | unreachable ;mote{ta{tableMatches source address type: unicast - IP address used for point to point transmission local - if an address is assigned to one of the router's interfaces broadcast - packet is sent to all devices in the subnet multicast - packet is forwarded to a defined group of devices src-port ( ; Default: ) integer[-integer]: 0..65535 List of source ports and ranges of source ports. Applicable only if a protocol is TCP or UDP src-mac-address ( ; Default: ) MAC address Matches the source MAC address of the packet tcp-flags ( ; Default: ) ack | cwr | ece | fin | psh | rst | syn | urg Matches specified TCP flags ack - acknowledging data cwr - congestion window reduced ece - ECN-echo flag (explicit congestion notification) fin - close connection psh - push function rst - drop connection syn - new connection urg - urgent data tcp-mss ( ; Default: ) integer[-integer]: 0..65535 Matches TCP MSS value of an IP packet time ( ; Default: time-time,sat | fri | thu | wed | tue | mon | sun )Allows to create a filter based on the packets' arrival time and date or, for locally generated packets, departure time and date tls-host ( ; Default: ) string Allows matching HTTPS traffic based on TLS SNI hostname. Accepts for GLOB syntax wildcard matching. Note that the matcher will not be able to match the hostname if the TLS handshake frame is fragmented into multiple TCP segments (packets). Watch our . video about this value ttl ( ; Default: ) integer: 0..255 Matches packets TTL value. Only.IPv4 Stateful Properties Property Description connection-bytes ( ; integer-integer Default: )Matches packets only if a given amount of bytes has been transferred through the particular connection. 0 - means infinity, for example means that the rule matches if more than 2MB has been connection-bytes=2000000-0 transferred through the relevant connection connection-limit (i ; nteger,netmask Default: )Matches connections per address or address block after a given value is reached. Should be used together with connection- and/or with because matcher is very resource-intensive state=new tcp-flags=syn connection-mark ( ; no-mark | string Default: )Matches packets marked via mangle facility with particular connection mark. If is set, the rule will match any unmarked no-mark connection connection-nat- state (srcnat | ; Default: ) dstnatCan match connections that are srcnatted, distracted, or both. Note that connections connection- connection-state=related nat-state is determined by the direction of the first packet. and if connection tracking needs to use dst-nat to deliver this connection to the same hosts as the main connection it will be in connection-nat-state=dstnat even if there are no dst-nat rules at all

connection-rate (I nteger 0.. ; 4294967295 Default: )Connection Rate is a firewall matcher that allows capturing traffic based on the present speed of the connection connection-state ( established | invalid | new | related | ; untracked Default: )Interprets the connection tracking analytics data for a particular packet: established - a packet that belongs to an existing connection invalid - a packet that does not have a determined state in connection tracking (usually - severe out-of-order packets, packets with wrong sequence/ack number, or in case of a resource over usage on the router), for this reason, an invalid packet will not participate in NAT (as only connection-state=new packets do), and will still contain original source IP address when routed. We strongly suggest dropping all packets in the firewall filter forward and input chains connection-state=invalid new - the packet has started a new connection or is otherwise associated with a connection that has not seen packets in both directions. related - a packet that is related to, but not parts of an existing connection, such as ICMP errors or a packet that begins an FTP data connection untracked - packet that was set to bypass connection tracking in firewall tables. RAW connection-type (f tp | h323 | irc | pptp | quake3 | ; Default: ) sip | tftpMatches packets from related connections based on information from their connection tracking helpers. A relevant connection helper must be enabled under the: /ip firewall service-port layer7-protocol (n ; Default: )ameLayer7 filter name defined in layer7 protocol menu. . Read more>> p2p () Matches some unencrypted P2P protocols. Deprecated in modern days since mostly everything is encrypted and requires deep packet inspection to identify. IPv4 only. realm (integer: 0.. ; 4294967295 Default: )IPv4 only. routing-mark (string ; Default: )Matches packets marked by mangle facility with particular routing mark

Layer7 Summary Properties Examples Simple L7 usage example L7 in the input chain Youtube Matcher Summary Layer7-protocol is a method of searching for patterns in ICMP/TCP/UDP streams. L7 matcher collects the first of a connection or the first of a connection and searches for the pattern in the collected data. If the pattern is 10 packets 2KB not found in the collected data, the matcher stops inspecting further. Allocated memory is freed and the protocol is considered . You should take unknown into account that a lot of connections will significantly increase memory and CPU usage. To avoid this, add regular firewall matchers to reduce the amount of data passed to layer-7 filters repeatedly. An additional requirement is that the layer7 matcher must see both directions of traffic (incoming and outgoing). To satisfy this requirement l7 rules should be set in chain. If the rule is set in chain then the same rule be also set in chain, otherwise, the the forward the input/prerouting must the output/postrouting collected data may not be complete resulting in an incorrectly matched pattern. Example L7 patterns compatible with RouterOS can be found on . the l7-filter project page Properties /ip firewall layer7-protocol Property Description name ( ; Default: ) string Descriptive name of l7 pattern used by configuration in firewall rules. See example . >> regexp ( ; Default: ) string POSIX compliant regular expression is used to match a pattern. Examples Simple L7 usage example First, add Regexp strings to the protocols menu, to define the strings you will be looking for. In this example, we will use a pattern to match RDP packets. The L7 matcher is very resource-intensive. Use this feature only for very specific traffic. It is not recommended to use the L7 matcher for generic traffic, such as for blocking web pages. This will almost never work correctly and your device will exhaust its resources, trying to catch all the traffic. Use other features to block webpages by URL. Layer 7 matcher is case insensitive! In some cases when layer 7 regular expression cannot be performed, RouterOS will log with an error message stating topic=firewall, warning the problem in the message!

/ip firewall layer7-protocol add name=rdp regexp="rdpdr.*cliprdr.*rdpsnd" Then, use the defined protocols in the firewall. /ip firewall filter # add few known protocols to reduce mem usage add action=accept chain=forward comment="" disabled=no port=80 protocol=tcp add action=accept chain=forward comment="" disabled=no port=443 protocol=tcp # add l7 matcher add action=accept chain=forward comment="" disabled=no layer7-protocol=\ rdp protocol=tcp As you can see before the l7 rule we added several regular rules that will match known traffic thus reducing memory usage. L7 in the input chain In this example, we will try to match the telnet protocol connecting to our router. /ip firewall layer7-protocol add comment="" name=telnet regexp="^\\xff[\\xfb-\\xfe].\\xff[\\xfb-\\xfe].\\xff [\\xfb-\\xfe]" Note that we need both directions which is why we need also the l7 rule in the output chain that sees outgoing packets. /ip firewall filter add action=accept chain=input comment="" disabled=no layer7-protocol=telnet \ protocol=tcp add action=passthrough chain=output comment="" disabled=no layer7-protocol=telnet \ protocol=tcp Youtube Matcher /ip firewall layer7-protocol add name=youtube regexp="(GET \\/videoplayback\\\?|GET \\/crossdomain\\.xml)" When a user is logged in YouTube will use HTTPS, meaning that L7 will not be able to match this traffic. Only unencrypted HTTP can be matched.

Address-lists Summary Properties Summary /ip firewall address-list Firewall address lists allow a user to create lists of IP addresses grouped together under a common name. Firewall filter, mangle, and NAT facilities can then use those address lists to match packets against them. The address list records can also be updated dynamically via the or item action=add-src-to-address-list action=add-dst-to-address-list s found in NAT, Mangle, andFilter facilities. Firewall rules with action or work in passthrough mode, which means that the matched add-src-to-address-list add-dst-to-address-list packets will be passed to the next firewall rules. Properties Property Description address (DNS Name | IP ; Default: address/netmask | IP-IP )A single IP address or range of IPs to add to the address list or DNS name. You can input for example, '192.168.0.0-192.168.1.255' and it will auto modify the typed entry to 192.168.0.0/23 on saving. dynamic ( no) yes, Allows creating data entry with dynamic form. list ( ; Default: ) string Name for the address list of the added IP address. timeout ( ; Default: ) time Time after address will be removed from the address list. If the timeout is not specified, the address will be stored in the address list permanently. creation-time ( ; Default: ) time The time when the entry was created. Example The following example creates a dynamic address list of people who are connecting to port 23 (telnet) on the router and drops all further traffic from them for 5 minutes. Additionally, the address list will also contain one static address list entry of 192.0.34.166/32 ( ): www.example.com /ip firewall address-list add list=drop_traffic address=192.0.34.166/32 /ip firewall address-list print Flags: X - disabled, D - dynamic # LIST ADDRESS 0 drop_traffic 192.0.34.166 If the timeout parameter is not specified, then the address will be saved to the list permanently on the disk. If a timeout is specified, the address will be stored on the RAM and will be removed after a system's reboot.

/ip firewall mangle add action=add-src-to-address-list address-list=drop_traffic address-list-timeout=5m chain=prerouting dst-port=23 protocol=tcp /ip firewall filter add action=drop chain=input src-address-list=drop_traffic /ip firewall address-list print Flags: X - disabled, D - dynamic # LIST ADDRESS 0 drop_traffic 192.0.34.166 1 D drop_traffic 1.1.1.1 2 D drop_traffic 10.5.11.8 As seen in the output of the last print command, two new dynamic entries appeared in the address list (marked with a status of 'D'). Hosts with these IP addresses tried to initialize a telnet session to the router and were then subsequently dropped by the filter rule.

Packet Flow in RouterOS Understanding Packet Flow Overall Packetflow Diagram Chains Flow of Routed Packet Forward Input Output Flow of Bridged Packet Bridge Forward Bridge Input Bridge Output Forward With Firewall Enabled Flow of Hardware Offloaded Packet Switch Forward Switch to CPU Input CPU Output to Switch Flow of MPLS Packet Pop Label Switch Label Push Label MPLS IP VPN Logical Interfaces IPSec Policies Fast Path How Fast Path Works FastTrack Configuration example: excluding specific host, from being Fast-Tracked Requirements Packet flow for the visually impaired Understanding Packet Flow More advanced firewall setups, or complicated tasks, such as traffic prioritization, routing policies, where it is necessary to utilize more than one RouterOS facility, require knowledge: How do these facilities work together? What happens when and why? RouterOS packet flow diagram and flow examples will try to answer these questions. It would be very complicated to represent what is going on with the packet in one diagram, therefore a packet flow diagram is divided into three parts: overall diagram; detailed bridging, routing, and MPLS flow diagram; a diagram that shows what facilities and in what order are included in prerouting, input, forward, output, and postrouting. Overall Packetflow Diagram Let's look at the overall diagram. It looks complicated at first, but after we go through the diagram with examples it will become much clearer. There are 4 boxes in the center of the diagram: Bridging, Routing, Mpls decisions, and local router processes. So for example, if the packet needs to be routed over the router, a packet will flow as illustrated in the image below. Without looking deeper into each facility, the packet enters the in-interface, the router determines that it is IP traffic and needs to be routed, the packet goes through all routing processes and exits the out-interface.

Let's take a look at another example that will illustrate what happens if the packet's destination is a router. For example, the in-interface receives ICMP (ping) packet, its destination is the router itself, so the packet will go for processing. After the packet is processed ICMP (ping) reply is generated local-in inside the router processing) and will be sent out over the out-interface. (local-out A simple explanation of each box before we go further with examples: physical in-interface - the starting point of the packet received by the router; logical in-interface - the starting point of the decapsulated packet (from tunnels, IPsec, etc); local in - the last point of a packet destined to router itself; interface HTB (Hierarchical Token Bucket) - interface queue; physical out-interface - last point of the packet before it is actually sent out; logical out-interface - last point of the packet before encapsulation (to tunnels, IPsec, etc); local out - the starting point of a packet generated by the router; Now it is time to take a deeper look at what is happening inside bridging, MPLS, and routing flows. A simple explanation of each box before we go further with examples:

routing decision - go through routes in the routing table to find a match for the destination IP address of the packet. When a match is found - the packet will be processed further, in case of no match - the packet will be discarded.; mpls decision - what to do with the packet based on MPLS forwarding tables; bridging decision - bridge goes through the MAC address table to find a match for the destination MAC address of the packet. When a match is found - the packet will be processed further, in case of no match - multiple copies of the packet will be created and packets will be flooded (sent out via all bridge ports). A single packet copy will also reach a bridge input chain as the bridge interface itself is one of the many destinations. When using , packets that are not allowed due to the "/interface bridge vlan" table, will be dropped at this stage. vlan-filtering=yes use-ip-firewall - whether a ' option is enabled in bridge settings; use-ip-firewall' ipsec-policy - whether a packet matches any of configured IPsec policies; Chains RouterOS consist of a few default chains. These chains allow you to filter packets at various points: The chain: Rules in this chain apply to packets as they just arrive on the network interface. This chain is present in the , PREROUTING natmangle and tables.raw The chain: Rules in this chain apply to packets just before they’re given to a local process. This chain is present in the and INPUT mangle filter tables. The chain: The rules here apply to packets just after they’ve been produced by a process. This chain is present in the , , nat, OUTPUT raw mangle and tables.filter The chain: The rules here apply to any packets that are routed through the current host. This chain is only present in the and FORWARD mangle fi tables.lter The chain: The rules in this chain apply to packets as they just leave the network interface. This chain is present in the and POSTROUTING nat m tables. angle Each of the prerouting, input, forward, output, and postrouting blocks contains even more facilities, which are illustrated in the third part of the packet flow diagram: A simple explanation of each box before we go further with examples: Hotspot-in - allows to capture traffic that otherwise would be discarded by connection tracking - this way our Hotspot feature is able to provide connectivity even if networks settings are an incomplete mess ; RAW Prerouting - RAW table prerouting chain; Connection tracking - packet is processed by connection tracking; Mangle Prerouting - Mangle prerouting chain; Mangle Input - Mangle input chain; Filter Input - Firewall filter input chain; HTB Global - Queue tree; Simple Queues - ; is a feature that can be used to limit traffic for a particular target TTL - indicates an exact place where the Time To Live (TTL) of the routed packet is reduced by 1 if TTL becomes 0, a packet will be discarded; Mangle Forward - Mangle forward chain; Filter Forward - Filter forward chain; Accounting - Authentication, Authorization, and Accounting feature processing; RAW Output - RAW table output chain; Mangle Output - Mangle output chain; Filter Output - Firewall filter output chain; Routing Adjustment - this is a workaround that allows to set up policy routing in mangle chain output (routing-mark) ;

1. a. b. c. d. e. 2. 3. a. b. c. d. 4. a. b. c. d. e. 5. 1. a. b. c. d. e. 2. 3. a. b. c. Mangle Postrouting - Mangle postrouting chain; Src Nat - Network Address Translation srcnat chain; Dst Nat - Network Address Translation dstnat chain; Hotspot-out - undo all that was done by hotspot-in for the packets that are going back to the client; Flow of Routed Packet Forward Now, let's take our first example where the packet gets routed over the router and look deeper through what facilities packet goes: We already learned that packet goes into the in-interface, the router determines that it is an IP packet and needs to be routed, and here starts the complicated process: The packet enters prerouting processing: check if there is a hotspot and modify the packet for hotspot use process packet through RAW prerouting chain; send the packet through connection tracking; process packet through Mangle prerouting chain; process packet through NATs dst-nat chain; Run packet through routing table to make routing decision; The packet enters the forward process; check TTL value; process packet through Mangle forward chain; process packet through the Filter forward chain; send the packet to accounting processes; A packet enters postrouting process; process packet through Mangle postrouting chain; process packet through NATs src-nat chain; if there is a hotspot undo any modifications made in hotspot-in; process packet through queue tree (HTB Global); process packet through simple queues; Check if there is IPsec and then process through IPsec policies; Input We already learned that packet goes into the in-interface, the router determines that it is an IP packet and needs to be routed, and here starts the complicated process: A very similar process happens when a packet's destination is a router (routing input): Packet enters prerouting processing: - check if there is a hotspot and modify the packet for hotspot use; - process packet through RAW prerouting chain; - send a packet through connection tracking; - process packet through Mangle prerouting chain; - process packet through NATs dst-nat chain; Run packet through routing table to make routing decision; A Packet enters the input process; - process packet through Mangle input chain; - process packet through Filter input chain; - process packet through queue tree (HTB Global);

3. d. 4. - process packet through simple queues; Check if there is IPsec and then process through IPsec policies.

1. Output Or when a packet is originated from the router (routing output):

1. a. 2. a. b. c. d. e. 3. a. b. c. d. e. 4. The packet is originated from the router itself the packet goes through the routing table to make a routing decision A packet enters the output process process packet through the Bridge decision; send the packet through connection tracking; process packet through the Mangle output chain; process packet through the Filter output chain; send the packet to routing adjustment ( policy routing) The packet enters postrouting process; - process packet through Mangle postrouting chain; - process packet through NATs src-nat chain; - if there is a hotspot undo any modifications made in hotspot-in; - process packet through queue tree (HTB Global); - process packet through simple queues; Check if there is IPsec and then process through IPsec policies; Flow of Bridged Packet

1. 2. 3. 4. Below is discussed a general bridging process in RouterOS. Most of the packets will always follow the same processing path, but in certain configurations (e.g. with enabled VLAN filtering, horizon, STP, DHCP, or IGMP snooping) some packets can be treated differently. Please visit the bridging manual for more specific information. Bridge Forward Bridge forward is a process that takes place when a packet is forwarded from one bridge port to another, essentially connecting multiple devices on the same network. After receiving a packet on the in-interface, the device determines that the in-interface is a bridge port, so it gets passed through the bridging process: A packet goes through the bridge NAT dst-nat chain, where MAC destination and priority can be changed, apart from that, a packet can be simply accepted, dropped, or marked; Checks whether the use-ip-firewall option is enabled in the bridge settings; Run packet through the bridge host table to make a forwarding decision. A packet that ends up being flooded (e.g. broadcast, multicast, unknown unicast traffic), gets multiplied per bridge port and then processed further in the bridge forward chain. When using , packets that are not allowed due vlan-filtering=yes to the "/interface bridge vlan" table, will be dropped at this stage.

4. 5. 6. 7. A packet goes through the bridge filter forward chain, where priority can be changed or the packet can be simply accepted, dropped, or marked; Checks whether the use-ip-firewall option is enabled in the bridge settings; A packet goes through the bridge NAT src-nat chain, where MAC source and priority can be changed, apart from that, a packet can be simply accepted, dropped, or marked; Checks whether the use-ip-firewall option is enabled in the bridge settings; For RouterOS v6: When bridge is enabled, received untagged packets might get encapsulated into the VLAN header before the "DST-NAT" vlan-filtering block, which means these packets can be filtered using the and settings. Encapsulation can happen if the mac-protocol=vlan vlan-encap outgoing interface has set to or . frame-types admit-all admit-only-untagged-and-priority-tagged Tagged packets might get decapsulated on the "BRIDGING DECISION" block, which means these packets will no longer match the mac- and settings. Decapsulation can happen if the packet's VLAN ID matches the outgoing port's untagged VLAN protocol=vlan vlan-encap membership. For RouterOS v7 and newer:

1. 2. 3. 4. Bridge Input Bridge input is a process that takes place when a packet is destined for the bridge interface. Most commonly this happens when you need to reach some services that are running on the bridge interface (e.g. a DHCP server) or you need to route traffic to other networks. The very first steps are similar to the bridge forward process - after receiving a packet on the in-interface, the device determines that the in-interface is a bridge port, so it gets passed through the bridging process: A packet goes through the bridge NAT dst-nat chain, where MAC destination and priority can be changed, apart from that, a packet can be simply accepted, dropped, or marked; Checks whether the use-ip-firewall option is enabled in the bridge settings; Run packet through the bridge host table to make a forwarding decision. A packet where the destination MAC address matches the bridge MAC address will be passed to the bridge input chain. A packet that ends up being flooded (e. g. broadcast, multicast, unknown unicast traffic), also reaches the bridge input chain as the bridge interface itself is one of the many destinations; A packet goes through the bridge filter input chain, where priority can be changed or the packet can be simply accepted, dropped, or marked; When bridge is enabled, received untagged packets might get encapsulated into the VLAN header on the "BRIDGING- vlan-filtering DECISION" block, which means these packets can be filtered using the and settings. Encapsulation can mac-protocol=vlan vlan-encap happen if the outgoing interface has set to or . frame-types admit-all admit-only-untagged-and-priority-tagged Tagged packets might get decapsulated on the "BRIDGING DECISION" block, which means these packets will no longer match the mac- and settings. Decapsulation can happen if the packet's VLAN ID matches the outgoing port's untagged VLAN protocol=vlan vlan-encap membership.

1. 2. 3. 4. Bridge Output Bridge output is a process that takes place when a packet should exit the device through one or multiple bridge ports. Most commonly this happens when a bridge interface itself tries to reach a device connected to a certain bridge port (e.g. when a DHCP server running on a bridge interface is responding to a DHCP client). After a packet is processed on other higher-level RouterOS processes and the device finally determines that the output interface is a bridge, the packet gets passed through the bridging process: Run packet through the bridge host table to make a forwarding decision. A packet that ends up being flooded (e.g. broadcast, multicast, unknown unicast traffic), gets multiplied per bridge port and then processed further in the bridge output chain. A packet goes through the bridge filter output chain, where priority can be changed or the packet can be simply accepted, dropped, or marked; A packet goes through the bridge NAT src-nat chain, where MAC source and priority can be changed, apart from that, a packet can be simply accepted, dropped, or marked; Checks whether the use-ip-firewall option is enabled in the bridge settings;

1. 2. 3. 4. 5. 6. 7. 8. 9. 10. Forward With Firewall Enabled In certain network configurations, you might need to enable additional processing on routing chains for bridged traffic, for example, to use simple queues or an IP firewall. This can be done when the use-ip-firewall is enabled under the bridge settings. Note that additional processing will consume more CPU resources to handle these packets. All the steps were already discussed in previous points, below is a recap: A packet goes through the bridge NAT dst-nat chain; With the use-ip-firewall option enabled, the packet will be further processed in the prerouting chain; A packet enters prerouting processing; Run packet through the bridge host table to make forwarding decision; A packet goes through the bridge filter forward chain; With the use-ip-firewall option enabled, the packet will be further processed in the routing forward chain; A packet enters routing forward processing; A packet goes through the bridge NAT src-nat chain; With the use-ip-firewall option enabled, the packet will be further processed in the postrouting chain; A packet enters postrouting processing;

Flow of Hardware Offloaded Packet

1. 2. The hardware offloading, however, does not restrict a device to only hardware limited features, rather it is possible to take advantage of the hardware and software processing at the same time. This does require a profound understanding of how packets travel through the switch chip and when exactly they are passed to the main CPU. Switch Forward We will further discuss a packet flow when bridge hardware offloading is enabled and a packet is forwarded between two switched ports on a single switch chip. This is the most common and also the simplest example: The switch checks whether the in-interface is a hardware offloaded interface; Run a packet through the switch host table to make a forwarding decision. If the switch finds a match for the destination MAC address, the packet is sent out through the physical interface. A packet that ends up being flooded (e.g. broadcast, multicast, unknown unicast traffic) gets multiplied and sent out to every hardware offloaded switch port. Switch to CPU Input This process takes place when a packet is received on a physical interface and it is destined to switch-cpu port for further software processing. There are two paths to the switch-cpu. One where hardware offloading and switching is not even used (e.g. a standalone interface for routing or a bridged interface but with deliberately disabled HW offloading), so the packet is simply passed further for software processing. Another path is taken when hardware offloading is active on the in-interface. This will cause the packet to pass through the switching decision and there are various reasons why the switch might forward the packet to the switch-cpu port: a packet's destination MAC address match with a local MAC address, e.g. when a packet is destined to a local bridge interface; a packet might get flooded to all switch ports including the switch-cpu port, e.g. when broadcast, multicast, or unknown unicast traffic is received; Switch features found in the "/interface/ethernet/switch" menu and its sub-menus, like ACL rules, mirroring, ingress/egress rate limiters, QoS, and L3HW ( inter-VLAN routing) may not rely on bridge hardware offloading. Therefore, they can be applied to interfaces not except potentially configured within a hardware-offloaded bridge.

1. 2. 3. 1. 2. 3. a switch might have learned that some hosts can only be reached through the CPU (switch-cpu port learning is discussed in the next section), e. g. when a bridge contains HW and non-HW offloaded interfaces, such as wireless, EoIP, and even Ethernet interfaces; a packet is intentionally copied to the switch-cpu, e.g. for a packet inspection; a packet is triggered by the switch configuration and should be processed in software, e.g. a DHCP or IGMP snooping. See the packet walkthrough when an in-interface is hardware offloaded: The switch checks whether the in-interface is a hardware offloaded interface; Run a packet through the switch host table to make a forwarding decision. In case any of the above-mentioned points are true, the packet gets forwarded to the switch-cpu port. The packet exits through the switch-cpu port and it will be further processed by the RouterOS packet flow. CPU Output to Switch This process takes place when a packet exits the RouterOS software processing and is received on the switch-cpu port. Again, there are two paths the packet can take. One where hardware offloading and switching are not even used (e.g. a standalone interface for routing or a bridged interface but with deliberately disabled HW offloading), so the packet is simply sent out through the physical out-interface. Another path is taken when hardware offloading is active on the out-interface. This will cause the packet to pass through the switching decision. Just like any other switch port, the switch will learn the source MAC addresses from packets that are received on the switch-cpu port. This does come in handy when a bridge contains HW and non-HW offloaded interfaces, so the switch can learn which frames should be forwarded to the CPU. See the packet walkthrough when an out-interface is hardware offloaded: A packet that exits the RouterOS software processing is received on the switch-cpu port; The switch checks whether the out-interface is a hardware offloaded interface; Run a packet through the switch host table to make a forwarding decision. If the switch finds a match for the destination MAC Any received packet that was flooded by the switch chip will not get flooded again by the software bridge to the same HW offloaded switch group. This prevents the formation of duplicate packets.

3. address, the packet is sent out through the physical interface. A packet that ends up being flooded (e.g. broadcast, multicast, unknown unicast traffic) gets multiplied and sent out to every hardware offloaded switch port. Flow of MPLS Packet A software bridge that sends a flooded packet through HW offloaded interfaces, will only send a single packet copy per HW offloaded switch group rather than per HW offloaded interface. The actual flooding will be done by the switch chip, this prevents the formation of duplicate packets.

Pop Label Switch Label Push Label

MPLS IP VPN In VPNv4 setups packet arriving at PE router that needs to be forwarded to the CE router is not a typical "forward". If incoming label and destination is bound to the VRF Then after MPLS label is popped and: destination address is local to the router, then packet is moved to LOCAL_IN destination address is in the CE network, then packet is moved to LOCAL_OUT For example traffic from src:111.15.0.1 to dst:111.13.0.1 [admin@CCR2004_2XS] /mpls/forwarding-table> print Flags: L - LDP, P - VPN Columns: LABEL, VRF, PREFIX, NEXTHOPS # LABEL VRF PREFIX NEXTHOPS 0 P 17 myVrf 111.13.0.0/24 4 L 20 main 203.0.113.2 { label=impl-null; nh=111.11.0.1; interface=sfp-sfpplus1 } [admin@CCR2004_2XS] /mpls/forwarding-table> ... [admin@CCR2004_2XS] /ip/route> print detail Flags: D - dynamic; X - disabled, I - inactive, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, i - is-is, d - dhcp, v - vpn, m - modem, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp DAc dst-address=111.11.0.0/24 routing-table=main gateway=sfp-sfpplus1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 suppress-hw-offload=no local-address=111.11.0.2%sfp-sfpplus1 DAc dst-address=203.0.113.1/32 routing-table=main gateway=lo immediate-gw=lo distance=0 scope=10 suppress- hw-offload=no local-address=203.0.113.1%lo DAo dst-address=203.0.113.2/32 routing-table=main gateway=111.11.0.1%sfp-sfpplus1 immediate-gw=111.11.0.1% sfp-sfpplus1 distance=110 scope=20 target-scope=10 suppress-hw-offload=no DAc dst-address=111.13.0.0/24 routing-table=myVrf gateway=sfp-sfpplus2@myVrf immediate-gw=sfp-sfpplus2 distance=0 scope=10 suppress-hw-offload=no local-address=111.13.0.2%sfp-sfpplus2@myVrf DAy dst-address=111.15.0.0/24 routing-table=myVrf gateway=203.0.113.2 immediate-gw=111.11.0.1%sfp-sfpplus1 distance=200 scope=40 target-scope=30 suppress-hw-offload=no [admin@CCR2004_2XS] /ip/route> Packet will be seen in the output and postrouting chains, because now it is locally originated packet with source MAC address equal to vrfInterface: 08:10:55 firewall,info output: in:(unknown 0) out:sfp-sfpplus2, connection-state:established src-mac f2:b5:e9: 17:18:3b, proto ICMP (type 8, code 0), 111.15.0.1->111.13.0.1, len 56 08:10:55 firewall,info postrouting: in:myVrf out:sfp-sfpplus2, connection-state:established src-mac f2:b5:e9:17: 18:3b, proto ICMP (type 8, code 0), 111.15.0.1->111.13.0.1, len 56 Forwarded packets from MPLS cloud to the CE network will not show up in the forward.

On the other hand, for packets routed in the direction CE→PE will be seen in the "forward" as any other routed IP traffic before being sent to the MPLS: 08:10:55 firewall,info prerouting: in:sfp-sfpplus2 out:(unknown 0), connection-state:established src-mac dc:2c: 6e:46:f8:93, proto ICMP (type 0, code 0), 111.13.0.1->111.15.0.1, len 56 08:10:55 firewall,info forward: in:sfp-sfpplus2 out:sfp-sfpplus1, connection-state:established src-mac dc:2c: 6e:46:f8:93, proto ICMP (type 0, code 0), 111.13.0.1->111.15.0.1, len 56 08:10:55 firewall,info postrouting: in:sfp-sfpplus2 out:sfp-sfpplus1, connection-state:established src-mac dc: 2c:6e:46:f8:93, proto ICMP (type 0, code 0), 111.13.0.1->111.15.0.1, len 56 But there can be an exception. If destination IP of reply packet is local to the router and connection tracking is performing NAT translation then connection tracking will "force" packet to move through the firewall prerouting/forward/postrouting chains. Logical Interfaces So far we looked at examples when in or out interfaces are actual physical interfaces (Ethernet, wireless), but how packets will flow if the router receives tunnel encapsulated packets? Let's assume that there is an IPIP packet coming into the router. Since it is a regular ipv4 packet it will be processed through all routing-related facilities ( until "J" in the diagram). Then the router will look if the packet needs to be decapsulated., in this case, it is an IPIP packet so "yes" send the packet to decapsulation. After that packet will go another loop through all the facilities but this time as a decapsulated IPv4 packet. It is very important because the packet actually travels through the firewall twice, so if there is a strict firewall, then there should be "accept" rules for IPIP encapsulated packets as well as decapsulated IP packets. IPSec Policies Let's take a look at another tunnel type - IPSec. This type of VPN does not have logical interfaces but is processed in a similar manner. Instead of logical interfaces packets are processed through IPSec policies. After routing decision (2) and input firewall processing (3), the router tries to match the source and Packet encapsulation and decapsulation using a bridge with enabled do not relate to logical interfaces. See more details in vlan-filtering the bridging section.

destination to the IPsec policy. When policy matches the packet it is sent to decryption (5). After the decryption packet enters PREROUTING processing again (6) and starts another processing loop, but now with the decapsulated packet. The same process is with encapsulation but in reverse order. The first IP packet gets processed through facilities, then matched against IPsec policies (5), encapsulated (6), and then sent to processing on the second loop (7-10).

Fast Path From what we learned so far, it is quite obvious that such packet processing takes a lot of CPU resources. To fast things up FastPath was introduced in the first RouterOS v6. What it does is it skips processing in the Linux kernel, basically trading some RouterOS functionality for performance. For FastPath to work, interface driver support and specific configuration conditions are required. How Fast Path Works FastPath is an interface driver extension, that allows a driver to talk directly to specific RouterOS facilities and skip all others. The packet can be forwarded by a fast path handler only if at least the source interface supports a fast path. For complete fast-forwarding, destination interface support is also required. Currently, RouterOS has the following FastPath handlers: IPv4 IPv4 FastTrack Traffic Generator MPLS Bridge IPv4 FastPath handler is used if the following conditions are met: firewall rules are not configured; simple queue or queue trees with are not configured; parent=global no mesh, metarouter interface configuration; sniffer or torch is not running; connection tracking is not active; IP accounting is disabled; VRFs are not configured ( is empty); /ip route vrf

A hotspot is not used ( has no interfaces); /ip hotspot IPSec policies are not configured; /tool mac-scan is not actively used; /tool ip-scan is not actively used. Traffic Generator automatically use FastPath if the interface supports this feature. Currently, MPLS fast-path applies to MPLS switched traffic (frames that enter router as MPLS and must leave router as MPLS) and VPLS endpoint that do VPLS encap/decap. Other MPLS ingress and egress will operate as before. A Bridge handler is used if the following conditions are met: there are no bridge Calea, filter, NAT rules; use-ip-firewall is disabled; no mesh, MetaRouter interface configuration; sniffer, torch, and traffic generator are not running; bridge vlan-filtering is disabled (condition is removed since RouterOS 7.2 version); bridge dhcp-snooping is disabled. Interfaces that support FastPath: RouterBoard Interfaces RB6xx series ether1,2 RB800 ether1,2 RB1100 series ether1-11 All devices Ethernet interfaces wireless interfaces bridge interfaces VLAN, VRRP interfaces bonding interfaces (RX only) PPPoE, L2TP interfaces EoIP, GRE, IPIP, VXLAN interfaces. VPLS (starting from v7.17) EoIP, Gre, IPIP, VXLAN and L2TP interfaces have per-interface setting Allowing a fast path on these interfaces has a side effect of allow-fast-path. bypassing firewall, connection tracking, simple queues, queue tree with parent=global, IP accounting, IPsec, hotspot universal client, vrf assignment for encapsulated packets that go through a fast-path. Also, packet fragments cannot be received in FastPath. Packets will travel the FastPath way if FastTrack is used no matter if the above conditions are met. FastPath on the vlan-filtering bridge does NOT support priority-tagged packets (packets with VLAN header but VLAN ID = 0). Those packets are redirected via a slow path. Whether FastPath is being used can be verified with /interface print stats-detail

Only interface queue that guarantees FastPath is only-hardware-queue. If you need an interface queue other than hardware then the packet will not go fully FastPath, but there is not a big impact on performance, as "interface queue" is the last step in the packet flow. The packet may go Half-FastPath by switching from FastPath to SlowPath, but not the other way around. So, for example, if the receiving interface has FastPath support, but the out interface does not, then the router will process the packet by FastPath handlers as far as it can and then proceed with SlowPath. If the receiving interface does not support FastPath but the out interface does, the packet will be processed by SlowPath all the way through the router. FastTrack Fasttrack can be decoded as Fast Path + Connection Tracking. It allows marking connections as "fast-tracked", marking packets that belong to fast- tracked connection will be sent fast-path way. The connection table entry for such a connection now will have a fast-tracked flag.

To mark a connection as fast-tracked new action was implemented " for firewall filter and mangle. Currently, only IPv4 TCP and UDP fasttrack-connection" connections can be fast-tracked and to maintain connection tracking entries some random packets will still be sent to a slow path. This must be taken into consideration when designing firewalls with enabled "fasttrack". FastTrack handler also supports source and destination NAT, so special exceptions for NATed connections are not required. The easiest way to start using this feature on home routers is to enable "fasttrack" for all connections: established, related /ip firewall filter add chain=forward action=fasttrack-connection connection-state=established,related \ comment="fasttrack established/related" add chain=forward action=accept connection-state=established,related \ comment="accept established/related" Notice that the first rule marks established/related connections as fast-tracked, the second rule is still required to accept packets belonging to those connections. The reason for this is that, as was mentioned earlier, some random packets from fast-tracked connections are still sent the slow pathway and only UDP and TCP are fast-tracked, but we still want to accept packets for other protocols. After adding the "FastTrack" rule special dummy rule appeared at the top of the list. This is not an actual rule, it is for visual information showing that some of the traffic is traveling FastPath and will not reach other firewall rules. FastTrack packets bypass firewall, connection tracking, simple queues, queue tree with parent=global, ip traffic-flow, IP accounting, IPSec, hotspot universal client, VRF assignment, so it is up to the administrator to make sure FastTrack does not interfere with other configuration! Traffic that belongs to a fast-tracked connection travels in FastPath, which means that it will not be visible by other router L3 facilities (firewall, queues, IPsec, IP accounting, VRF assignment, etc). Fasttrack lookups route before routing marks have been set, so it works only with the main routing table.

These rules appear as soon as there is at least one fast-tracked connection tracking entry and will disappear after the last fast-tracked connection times out in the connection table. Configuration example: excluding specific host, from being Fast-Tracked /ip firewall filter add action=accept chain=forward connection-state=established,related src-address=192.168.88.111 add action=accept chain=forward connection-state=established,related dst-address=192.168.88.111 add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=no add action=accept chain=forward connection-state=established,related In this example, we exclude host 192.168.88.111, from being Fast-tracked, by first accepting it with the firewall rule, both for source and destination. The idea is - not allowing the traffic to reach the FastTrack action. Note: the "exclusion" rules, must be placed before fasttrack filters, order is important. Requirements IPv4 FastTrack is active if the following conditions are met: nomesh, metarouter interface configuration; sniffer, torch, andtraffic generator are not running; "/tool mac-scan" is not actively used; "/tool ip-scan" is not actively used; FastPath and Route cache are enabled under IP/Settings (route cache condition does not apply to RouterOS v7 or newer); bridge FastPath is enabled if a connection is going over the bridge interface; Packet flow for the visually impaired The following document in DOCX format describes the diagram in a way optimized for visually impaired people. The descriptions are by Apex CoVantage care of Benetech. They are not being updated. Packet flow, optimized document. FastTrack can process packets only in the main routing table so it is the system administrator duty to not FastTrack connections that are going through non-main routing table (thus connections that are processed with mangle action=mark-routing rules). Otherwise packets might be misrouted though the main routing table. The connection is FastTracked until a connection is closed, timed out or the router is rebooted.

As you can see in the first case all traffic exceeds a specific rate and is dropped. In another case, traffic exceeds a specific rate and is delayed in the queue and transmitted later when it is possible, but note that the packet can be delayed only until the queue is not full. If there is no more space in the queue buffer, packets are dropped. For each queue we can define two rate limits: CIR (Committed Information Rate) – ( in RouterOS) worst-case scenario, the flow will get this amount of traffic rate regardless of other limit-at traffic flows. At any given time, the bandwidth should not fall below this committed rate. MIR (Maximum Information Rate) – ( in RouterOS) best-case scenario, the maximum available data rate for flow, if there is free any part max-limit of the bandwidth. Simple Queue /queue simple A simple queue is a plain way how to limit traffic for a particular target. Also, you can use simple queues to build advanced QoS applications. They have useful integrated features: peer-to-peer traffic queuing; applying queue rules on chosen time intervals; prioritization; using multiple packet marks from /ip firewall mangle traffic shaping (scheduling) of bidirectional traffic (one limit for the total of upload + download) Configuration example In the following example, we have one SOHO device with two connected units PC and Server. Simple queues have a - each packet must go through every queue until it reaches one queue which conditions fit packet parameters strict order or until the end of the queues list is reached. For example, In the case of 1000 queues, a packet for the last queue will need to proceed through 999 queues before it will reach the destination.

We have a 15 Mbps connection available from ISP in this case. We want to be sure the server receives enough traffic, so we will configure a simple queue with a parameter to guarantee a server receives 5Mbps: limit-at /queue simple add limit-at=5M/5M max-limit=15M/15M name=queue1 target=192.168.88.251/32 That is all. The server will get 5 Mbps of traffic rate regardless of other traffic flows. If you are using the default configuration, be sure the FastTrack rule is disabled for this particular traffic, otherwise, it will bypass Simple Queues and they will not work. Queue Tree /queue tree The queue tree creates only a one-directional queue in one of the HTBs. It is also the only way how to add a queue on a separate interface. This way it is possible to ease mangle configuration - you don't need separate marks for download and upload - only the upload will get to the Public interface and only the download will get to a Private interface. The main difference from Simple Queues is that the - all traffic passes it together. Queue tree is not ordered Configuration example In the following example, we will mark all the packets coming from preconfigured and will limit the traffic with a queue tree based on in-interface-list=LAN these packet marks. Let`s create a firewall address-list:

Random Early Drop is a queuing mechanism that tries to avoid network congestion by controlling the . The average queue size is average queue size compared to two thresholds: a minimum (min ) and a maximum (max ) threshold. If the average queue size (avg ) is less than the minimum threshold, no th th q packets are dropped. When the average queue size is greater than the maximum threshold, all incoming packets are dropped. But if the average queue size is between the minimum and maximum thresholds packets are randomly dropped with probability P where probability is exact a function of the d average queue size: P = P (avg – min )/ (max - min ). If the average queue grows, the probability of dropping incoming packets grows too. P - d max q th th th max ratio, which can adjust the packet discarding probability abruptness, (the simplest case P can be equal to one. The 8.2 diagram shows the packet drop max probability in the RED algorithm. SFQ Stochastic Fairness Queuing (SFQ) is ensured by hashing and round-robin algorithms. SFQ is called "Stochastic" because it does not really allocate a queue for each flow, it has an algorithm that divides traffic over a limited number of queues (1024) using a hashing algorithm. Traffic flow may be uniquely identified by 4 options ( and ), so these parameters are used by the SFQ hashing src-address, dst-address, src-port, dst-port algorithm to classify packets into one of 1024 possible sub-streams. Then round-robin algorithm will start to distribute available bandwidth to all sub- streams, on each round giving bytes of traffic. The whole SFQ queue can contain 128 packets and there are 1024 sub-streams available. The 8.3 sfq-allot diagram shows the SFQ operation: PCQ PCQ algorithm is very simple - at first, it uses selected classifiers to distinguish one sub-stream from another, then applies individual FIFO queue size and limitation on every sub-stream, then groups all sub-streams together and applies global queue size and limitation. PCQ parameters:

pcq-classifier (dst-address | dst-port | src-address | src-port; default: "") : selection of sub-stream identifiers pcq-rate (number): maximal available data rate of each sub-steam pcq-limit (number): queue size of single sub-stream (in KiB) pcq-total-limit (number): maximum amount of queued data in all sub-streams (in KiB) It is possible to assign a speed limitation to sub-streams with the option. If "pcq-rate=0" sub-streams will divide available traffic equally. pcq-rate For example, instead of having 100 queues with 1000kbps limitation for download, we can have one PCQ queue with 100 sub-streams PCQ has burst implementation identical to Simple Queues and Queue Tree: pcq-burst-rate (number): maximal upload/download data rate which can be reached while the burst for substream is allowed pcq-burst-threshold (number): this is the value of burst on/off switch pcq-burst-time (time): a period of time (in seconds) over which the average data rate is calculated. (This is NOT the time of the actual burst) PCQ also allows using different size IPv4 and IPv6 networks as sub-stream identifiers. Before it was locked to a single IP address. This is done mainly for IPv6 as customers from an ISP point of view will be represented by /64 network, but devices in customers network will be /128. PCQ can be used for both of these scenarios and more. PCQ parameters: pcq-dst-address-mask (number): the size of the IPv4 network that will be used as a dst-address sub-stream identifier pcq-src-address-mask (number): the size of the IPv4 network that will be used as an src-address sub-stream identifier pcq-dst-address6-mask (number): the size of the IPV6 network that will be used as a dst-address sub-stream identifier pcq-src-address6-mask (number): the size of the IPV6 network that will be used as an src-address sub-stream identifier CoDel CoDel (Controlled-Delay Active Queue Management) algorithm uses the local minimum queue as a measure of the persistent queue, similarly, it uses a minimum delay parameter as a measure of the standing queue delay. Queue size is calculated using packet residence time in the queue. Properties The following queue kinds CoDel, FQ-Codel, and CAKE available since RouterOS version 7.1beta3.

Property Description codel-ce-threshold ( : ) default Marks packets above a configured threshold with ECN. codel-ecn ( : ) default no An option is used to mark packets instead of dropping them. codel-interval ( : ) default 100ms Interval should be set on the order of the worst-case RTT through the bottleneck giving endpoints sufficient time to react. codel-limit ( : ) default 1000 Queue limit, when the limit is reached, incoming packets are dropped. codel-target ( : ) default 5ms Represents an acceptable minimum persistent queue delay. FQ-Codel CoDel - Fair Queuing (FQ) with Controlled Delay (CoDel) uses a model to classify incoming packets into different flows and is used randomly determined to provide a fair share of the bandwidth to all the flows using the queue. Each flow is managed using CoDel queuing discipline which internally uses a FIFO algorithm. Properties Property Description fq-codel-ce-threshold (def : )aultMarks packets above a configured threshold with ECN. fq-codel-ecn ( : ) default yes An option is used to mark packets instead of dropping them. fq-codel-flows (default: 10 )24A number of flows into which the incoming packets are classified. fq-codel-interval ( : default 1 ) 00msInterval should be set on the order of the worst-case RTT through the bottleneck giving endpoints sufficient time to react. fq-codel-limit ( : default 102 )40Queue limit, when the limit is reached, incoming packets are dropped. fq-codel-memlimit (default: ) 32.0MiBA total number of bytes that can be queued in this FQ-CoDel instance. Will be enforced from the parameter. fq-codel-limit fq-codel-quantum ( : default ) 1514A number of bytes used as 'deficit' in the fair queuing algorithm. Default (1514 bytes) corresponds to the Ethernet MTU plus the hardware header length of 14 bytes. fq-codel-target ( : default 5 )msRepresents an acceptable minimum persistent queue delay. CAKE CAKE - Common Applications Kept Enhanced (CAKE) COBALT (AQM algorithm implemented as a queue discipline (qdisc) for the Linux kernel uses combining Codel and BLUE) and a variant of DRR++ for flow isolation. In other words, All settings are Cake’s fundamental design goal is user-friendliness. optional; the default settings are chosen to be practical in most common deployments. In most cases, the configuration requires only a bandwidth parameter to get useful results, Properties Property Description cake-ack-filter ) (default: none cake-atm ) (default: Compensates for ATM cell framing, which is normally found on ADSL links. cake-autorate-ingress (yes/no, ) default:Automatic capacity estimation based on traffic arriving at this qdisc. This is most likely to be useful with cellular links, which tend to change quality randomly. The Bandwidth Limit parameter can be used in conjunction to specify an initial estimate. The shaper will periodically be set to a bandwidth slightly below the estimated rate. This estimator cannot estimate the bandwidth of links downstream of itself.

cake-bandwidth ) (default: Sets the shaper bandwidth. cake-diffserv ) (default: diffserv3 CAKE can divide traffic into "tins" based on the Diffserv field: diffserv4 Provides a general-purpose Diffserv implementation with four tins: Bulk (CS1), 6.25% threshold, generally low priority. Best Effort (general), 100% threshold. Video (AF4x, AF3x, CS3, AF2x, CS2, TOS4, TOS1), 50% threshold. Voice (CS7, CS6, EF, VA, CS5, CS4), 25% threshold. diffserv3 (default) Provides a simple, general-purpose Diffserv implementation with three tins: Bulk (CS1), 6.25% threshold, generally low priority. Best Effort (general), 100% threshold. Voice (CS7, CS6, EF, VA, TOS4), 25% threshold, reduced Codel interval. cake-flowmode (dsthost/dual- dsthost/dual-srchost/flowblind /flows/hosts/srchost/triple- ) isolate, default: triple-isolateflowblind - Disables flow isolation; all traffic passes through a single queue for each tin. srchost - Flows are defined only by source address. dsthost Flows are defined only by destination address. hosts - Flows are defined by source-destination host pairs. This is host isolation, rather than flow isolation. flows - Flows are defined by the entire 5-tuple of source address, a destination address, transport protocol, source port, and destination port. This is the type of flow isolation performed by SFQ and fq_codel. dual-srchost Flows are defined by the 5-tuple, and fairness is applied first over source addresses, then over individual flows. Good for use on egress traffic from a LAN to the internet, where it'll prevent any LAN host from monopolizing the uplink, regardless of the number of flows they use. dual-dsthost Flows are defined by the 5-tuple, and fairness is applied first over destination addresses, then over individual flows. Good for use on ingress traffic to a LAN from the internet, where it'll prevent any LAN host from monopolizing the downlink, regardless of the number of flows they use. triple-isolate - Flows are defined by the 5-tuple, and fairness is applied over source *and* destination addresses intelligently (ie. not merely by host-pairs), and also over individual flows. nat Instructs Cake to perform a NAT lookup before applying flow- isolation rules, to determine the true addresses and port numbers of the packet, to improve fairness between hosts "inside" the NAT. This has no practical effect in "flowblind" or "flows" modes, or if NAT is performed on a different host. nonat (default) The cake will not perform a NAT lookup. Flow isolation will be performed using the addresses and port numbers directly visible to the interface Cake is attached to. cake-memlimit ) (default: Limit the memory consumed by Cake to LIMIT bytes. By default, the limit is calculated based on the bandwidth and RTT settings. cake-mpu ) ( -64 ... 256, default: Rounds each packet (including overhead) up to a minimum length BYTES. cake-nat (default: no) Instructs Cake to perform a NAT lookup before applying a flow-isolation rule. cake-overhead ( -64 ... 256, ) default:Adds BYTES to the size of each packet. BYTES may be negative. cake-overhead-scheme (default: ) cake-rtt ) (default: 100ms Manually specify an RTT. Default 100ms is suitable for most Internet traffic. cake-rtt-scheme (datacentre /internet/interplanetary/lan /metro/none/oceanic/regional ) /satellite, default:datacentre - For extremely high-performance 10GigE+ networks only. Equivalent to RTT 100us. lan - For pure Ethernet (not Wi-Fi) networks, at home or in the office. Don't use this when shaping for an Internet access link. Equivalent to RTT 1ms. metro - For traffic mostly within a single city. Equivalent to For traffic mostly within a RTT 10ms. regional European-sized country. Equivalent to RTT 30ms. internet (default) This is suitable for most Internet traffic. Equivalent to RTT 100ms. oceanic - For Internet traffic with generally above-average latency, such as that suffered by Australasian residents. Equivalent to RTT 300ms. satellite - For traffic via geostationary satellites. Equivalent to RTT 1000ms. interplanetary - So named because Jupiter is about 1 light-hour from Earth. Use this to (almost) completely disable AQM actions. Equivalent to RTT 3600s. cake-wash ) (default: no Apply the wash option to clear all extra DiffServ (but not ECN bits), after priority queuing has taken place. Interface Queue

HTB (Hierarchical Token Bucket) Introduction Token Bucket algorithm (Red part of the diagram) Packet queue (Blue part of the diagram) Token rate selection (Black part of the diagram) The Diagram Bucket Size in action Default Queue Bucket Large Queue Bucket Large Child Queue Bucket, Small Parent Queue Bucket Configuration Dual Limitation Priority Examples Structure Example 1: Usual case Result of Example 1 Example 2: Usual case with max-limit Result of Example 2 Example 3: Inner queue limit-at Result of Example 3 Example 4: Leaf queue limit-at Result of Example 4 Introduction HTB (Hierarchical Token Bucket) is a classful queuing method that is useful for handling different kinds of traffic. This article will concentrate on the "Token Bucket" part of (HTB) - an algorithm inside the single queue and configuration examples. Hierarchical Token Bucket Token Bucket algorithm (Red part of the diagram) The Token Bucket algorithm is based on an analogy to a bucket where tokens, represented in bytes, are added at a specific rate. The bucket itself has a specified capacity. If the bucket fills to capacity, newly arriving tokens are dropped Bucket capacity = bucket-size * max-limit bucket size (0..10, Default:0.1) - queue option was added in RouterOS v6.35, before that it was hard-coded to a value of "0.1". Before allowing any packet to pass through the queue, the queue bucket is inspected to see if it already contains sufficient tokens at that moment. If yes, the appropriate number of tokens are removed ("cashed in") and the packet is permitted to pass through the queue. If not, the packets stay at the start of the packet waiting queue until the appropriate amount of tokens is available. In the case of a multi-level queue structure, tokens used in a child queue are also 'charged' to their parent queues. In other words - child queues 'borrow' tokens from their parent queues. Packet queue (Blue part of the diagram) The size of this packet queue, the sequence, how packets are added to this queue, and when packets are discarded is determined by: queue-type - Queue queue-size - Queue Size Token rate selection (Black part of the diagram) The maximal token rate at any given time is equal to the highest activity of these values:

limit-at ( ): guaranteed upload/download data rate to a target NUMBER/NUMBER max-limit ( ): maximal upload/download data rate that is allowed for a target NUMBER/NUMBER burst-limit ( ): maximal upload/download data rate that is allowed for a target while the 'burst' is active NUMBER/NUMBER burst-limit is active only when 'burst' is in the allowed state - more info here: Queue Burst In a case where is the highest value, extra tokens need to be issued to compensate for all missing tokens that were not borrowed from its parent limit-at queue. The Diagram Bucket Size in action Let's have a simple setup where all traffic from and to one IP address is marked with a packet-mark: /ip firewall mangle add chain=forward action=mark-connection connection-mark=no-mark src-address=192.168.88.101 new-connection- mark=pc1_conn add chain=forward action=mark-connection connection-mark=no-mark dst-address=192.168.88.101 new-connection- mark=pc1_conn add chain=forward action=mark-packet connection-mark=pc1_conn new-packet-mark=pc1_traffic Default Queue Bucket /queue tree add name=download parent=Local packet-mark=PC1-traffic max-limit=10M add name=upload parent=Public packet-mark=PC1-traffic max-limit=10M In this case bucket-size=0.1, so bucket-capacity= 0.1 x 10M = 1M

If the bucket is full (that is, the client was not using the full capacity of the queue for some time), the next 1Mb of traffic can pass through the queue at an unrestricted speed. Large Queue Bucket /queue tree add name=download parent=Local packet-mark=PC1-traffic max-limit=10M bucket-size=10 add name=upload parent=Public packet-mark=PC1-traffic max-limit=10M bucket-size=10 Let's try to apply the same logic to a situation when bucket size is at its maximal value: In this case bucket-size=10, so bucket-capacity= 10 x 10M = 100M If the bucket is full (that is, the client was not using the full capacity of the queue for some time), the next 100Mb of traffic can pass through the queue at an unrestricted speed. So you can have: 20Mbps transfer speed for 10s 60Mbps transfer burst for 2s 1Gbps transfer burst for approximately 100ms You can therefore see that the bucket permits a type of 'burstiness' of the traffic that passes through the queue. The behavior is similar to the normal burst feature but lacks the upper limit of the burst. This setback can be avoided if we utilize bucket size in the queue structure: Large Child Queue Bucket, Small Parent Queue Bucket /queue tree add name=download_parent parent=Local max-limit=20M add name=download parent=download_parent packet-mark=PC1-traffic max-limit=10M bucket-size=10 add name=upload_parent parent=Public max-limit=20M add name=upload parent=upload_parent packet-mark=PC1-traffic max-limit=10M bucket-size=10 In this case: parent queue bucket-size=0.1, bucket-capacity= 0.1 x 20M = 2M child queue bucket-size=10, bucket-capacity= 10 x 10M = 100M The parent will run out of tokens much faster than the child queue and as its child queue always borrows tokens from the parent queue the whole system is restricted to token-rate of the parent queue - in this case to max-limit=20M. This rate will be sustained until the child queue runs out of tokens and will be restricted to its token rate of 10Mbps. In this way, we can have a burst at 20Mbps for up to 10 seconds. Configuration We have to follow three basic steps to create HTB: Match and mark traffic – classify traffic for further use. Consists of one or more matching parameters to select packets for the specific class; Create rules (policy) to mark traffic – put specific traffic classes into specific queues and define the actions that are taken for each class; Attach a policy for specific interface(-s) – append policy for all interfaces (global-in, global-out, or global-total), for a specific interface, or for a specific parent queue; HTB allows to create of a hierarchical queue structure and determines relations between queues, like "parent-child" or "child-child". As soon as the queue has at least one child it becomes an queue, all queues without children - queues. queues make actual traffic inner are leaf Leaf consumption, queues are responsible only for traffic distribution. All queues are treated on an equal basis. Inner leaf In RouterOS, it is necessary to specify option to assign a queue as a child to another queue. the parent

Dual Limitation Each queue in HTB has two rate limits: CIR (Committed Information Rate) – ( in RouterOS) worst case scenario, the flow will get this amount of traffic no matter what (assuming limit-at we can actually send so much data); MIR (Maximal Information Rate) – ( in RouterOS) best case scenario, a rate that flow can get up to if their queue's parent has spare max-limit bandwidth; In other words, at first () of all queues will be satisfied, only then child queues will try to borrow the necessary data rate from their parents in limit-at CIR order to reach their ( ). max-limit MIR That is why, to ensure optimal (as designed) usage of the dual limitation feature, we suggest sticking to these rules: The Sum of committed rates of all children must be less or equal to the amount of traffic that is available to parents; CIR(parent)* ≥ CIR(child1) +...+ CIR(childN)*in case if parent is main parent CIR(parent)=MIR(parent) The maximal rate of any child must be less or equal to the maximal rate of the parent MIR (parent) ≥ MIR(child1) & MIR (parent) ≥ MIR(child2) & ... & MIR (parent) ≥ MIR(childN) Queue colors in Winbox: 0% - 50% available traffic used - green 51% - 75% available traffic used - yellow 76% - 100% available traffic used - red Priority We already know that () to all queues will be given out no matter what. limit-at CIR Priority is responsible for the distribution of remaining parent queues traffic to child queues so that they are able to reach max-limit The queue with higher priority will reach its before the queue with lower priority. 8 is the lowest priority, and 1 is the highest. max-limit Make a note that priority only works: for queues - priority in queue has no meaning. leaf the inner if is specified (not 0) max-limit Examples In this section, we will analyze HTB in action. To do that we will take one HTB structure and will try to cover all the possible situations and features, by changing the amount of incoming traffic that HTB has to recycle. and changing some options. Structure Our HTB structure will consist of 5 queues: Queue01 inner queue with two children - and Queue02 Queue03 Queue02 inner queue with two children - and Queue04 Queue05 Queue03 leaf queue Queue04 leaf queue Queue05 leaf queue Queue03 , and are clients who require 10Mbps all the time Outgoing interface is able to handle 10Mbps of traffic. Queue04, Queue05 Example 1: Usual case CIR will be assigned to the corresponding queue no matter what. (even if max-limit of the parent is exceeded)

Queue01 limit-at=0Mbps max-limit=10Mbps Queue02 limit-at=4Mbps max-limit=10Mbps Queue03 limit-at=6Mbps max-limit=10Mbps priority=1 Queue04 limit-at=2Mbps max-limit=10Mbps priority=3 Queue05 limit-at=2Mbps max-limit=10Mbps priority=5 Result of Example 1 Queue03 will receive 6Mbps Queue04 will receive 2Mbps Queue05 will receive 2Mbps Clarification: HTB was built in a way, that, by satisfying all s, the main queue no longer has throughput to distribute. limit-at Example 2: Usual case with max-limit

Queue01 limit-at=0Mbps max-limit=10Mbps Queue02 limit-at=4Mbps max-limit=10Mbps Queue03 limit-at=2Mbps max-limit=10Mbps priority=3 Queue04 limit-at=2Mbps max-limit=10Mbps priority=1 Queue05 limit-at=2Mbps max-limit=10Mbps priority=5 Result of Example 2 Queue03 will receive 2Mbps Queue04 will receive 6Mbps Queue05 will receive 2Mbps Clarification: After satisfying all s HTB will give throughput to the queue with the highest priority. limit-at Example 3: Inner queue limit-at

Queue01 limit-at=0Mbps max-limit=10Mbps Queue02 limit-at=8Mbps max-limit=10Mbps Queue03 limit-at=2Mbps max-limit=10Mbps priority=1 Queue04 limit-at=2Mbps max-limit=10Mbps priority=3 Queue05 limit-at=2Mbps max-limit=10Mbps priority=5 Result of Example 3 Queue03 will receive 2Mbps Queue04 will receive 6Mbps Queue05 will receive 2Mbps Clarification: After satisfying all s HTB will give throughput to the queue with the highest priority. But in this case, queue had limit-at inner Queue02 l specified, by doing so, it reserved 8Mbps of throughput for queues and . Of these two has the highest priority, imit-at Queue04 Queue05 Queue04 which is why it gets additional throughput. Example 4: Leaf queue limit-at

Queue01 limit-at=0Mbps max-limit=10Mbps Queue02 limit-at=4Mbps max-limit=10Mbps Queue03 limit-at=6Mbps max-limit=10Mbps priority=1 Queue04 limit-at=2Mbps max-limit=10Mbps priority=3 Queue05 limit-at=12Mbps max-limit=15Mbps priority=5 Result of Example 4 Queue03 will receive ~3Mbps Queue04 will receive ~1Mbps Queue05 will receive ~6Mbps Clarification: Only by satisfying all s HTB was forced to allocate 20Mbps - 6Mbps to , 2Mbps to , and 12Mbps to limit-at Queue03 Queue04 Queue05 , but our output interface is able to handle 10Mbps. As the output interface queue is usually FIFO throughput allocation will keep the ratio 6:2:12 or 3:1:6

Queue size Example 100% Shaper 100% Scheduler Default-small queue type Default queue type Example This example was created to highlight the queue size impact on traffic that was queued by a specific queue. In Mikrotik RouterOS, queue size can be specified in the " " menu. Each queue type has a different option for specifying queue size (pfifo- /queue type limit, bfifo-limit, pcq-limit, pcq-total-limit, red-limit), but all principles are the same - queue size is the main option that decides should the package be dropped or scheduled for a later time. In a real-time environment, this process is happening continuously without any stops, steps, or other interruptions, but to show it as an example, we will divide it into steps, where it is possible to know exactly how many packets will be received/transited in every step. We will not go into specific details of TCP and dropped packet retransmission - consider these packets as simple UDP streams. As you can see in the picture above there are and there are a total of over this time frame. 25 steps 1610 incoming packets 100% Shaper A queue is 100% shaper when every packet that is over the allowed limits will be dropped immediately. This way all packages that are not dropped will be sent out without any delay. Let's apply limitation to our example: packets per step max-limit=100

With this type of limitation, only 1250 out of 1610 packets were able to pass the queue ( ), but all packets arrive without delay. 22,4% packet drop 100% Scheduler A queue is 100% Scheduler when there are no packet drops at all, all packets are queued and will be sent out at the first possible moment. In each step, the queue must send out queued packets from previous steps first and only then send out packets from this step, this way it is possible to keep the right sequence of packets. We will again use the same limit ( ). 100 packets per step There was no packet loss, but 630 , and the other 170 . (delay = latency) (39,1%) packets had 1 step delay (10,6%) packets had 2 step delay Default-small queue type It is also possible to choose the middle way when the queue uses both of these queuing aspects (shaping and scheduling). By default, most of the queues in RouterOS have a queue size of 10.

There were 320 and 80 . (19,9%) packets dropped (5,0%) packets had 1 step delay Default queue type Another popular queue size in RouterOS is 50. There were 190 and 400 . (11,8%) packets dropped (24,8%) packets had 1 step delay

1. 2. 3. 4. 5. Queue Burst Introduction Example Burst-time=16s Burst-time=8s Introduction Burst is a feature that allows satisfying queue requirements for additional bandwidth even if the required rate is bigger than ( ) for a limited MIR max-limit period of time. Burst can occur only if of the queue for the last seconds is smaller than . Burst will stop if of the queue average-rate burst-time burst-threshold average-rate for the last seconds is bigger or equal to burst-time burst-threshold. The burst mechanism is simple - if a burst is allowed value is replaced by value. When the burst is disallowed value max-limit the burst-limit max-limit remains unchanged. burst-limit (NUMBER) : maximal upload/download data rate which can be reached while the burst is allowed; burst-time (TIME) : period of time, in seconds, over which the average data rate is calculated. (This is NOT the time of actual burst); burst-threshold (NUMBER) : this is value of burst on/off switch; average-rate (read-only) : Every 1/16 part of the , the router calculates the average data rate of each class over the last secon burst-time burst-time ds; actual-rate (read-only) : actual traffic transfer rate of the queue; Example Values: , , , limit-at=1M max-limit=2M burst-threshold=1500k burst-limit=4M The client will try to download two 4MB (32Mb) blocks of data, the first download will start at zero seconds, and the second download will start at 17th second. Traffic was unused at the last minute. Burst-time=16s

As we can see as soon as the client requested bandwidth it was able to get 4Mpbs burst for 6 seconds. This is longest possible burst with given values (lon . As soon as the burst runs out rest of the data will be downloaded with 2Mbps. This way block of gest-burst-time = burst-threshold * burst-time / burst-limit) data was downloaded in 9 seconds - without burst, it would take 16 seconds. Burst has 7 seconds to recharge before the next download will start.

Note that burst is still disallowed when download started and it kicks in only afterward - in the middle of a download. So with this example, we proved that a burst may happen in the middle of a download. The burst was ~4 seconds long and the second block was downloaded 4 seconds faster than without burst. The average rate is calculated every 1/16 of burst time so in this case 1s Time average-rate burst actual-rate 0 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+0+0)/16=0Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 1 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+0+4)/16=250Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 2 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+4+4)/16=500Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 3 (0+0+0+0+0+0+0+0+0+0+0+0+0+4+4+4)/16=750Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 4 (0+0+0+0+0+0+0+0+0+0+0+0+4+4+4+4)/16=1000Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 5 (0+0+0+0+0+0+0+0+0+0+0+4+4+4+4+4)/16=1250Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 6 (0+0+0+0+0+0+0+0+0+0+4+4+4+4+4+4)/16=1500Kbps average-rate = burst-threshold → Burst allowed not 2Mbps 7 (0+0+0+0+0+0+0+0+0+4+4+4+4+4+4+2)/16=1625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 8 (0+0+0+0+0+0+0+0+4+4+4+4+4+4+2+2)/16=1750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 9 (0+0+0+0+0+0+0+4+4+4+4+4+4+2+2+2)/16=1875Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 10 (0+0+0+0+0+0+4+4+4+4+4+4+2+2+2+2)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 11 (0+0+0+0+0+4+4+4+4+4+4+2+2+2+2+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 12 (0+0+0+0+4+4+4+4+4+4+2+2+2+2+0+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 13 (0+0+0+4+4+4+4+4+4+2+2+2+2+0+0+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 14 (0+0+4+4+4+4+4+4+2+2+2+2+0+0+0+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 15 (0+4+4+4+4+4+4+2+2+2+2+0+0+0+0+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 16 (4+4+4+4+4+4+2+2+2+2+0+0+0+0+0+0)/16=2Mbps average-rate > burst-threshold → Burst not allowed 0Mbps 17 (4+4+4+4+4+2+2+2+2+0+0+0+0+0+0+0)/16=1750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 18 (4+4+4+4+2+2+2+2+0+0+0+0+0+0+0+2)/16=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps 19 (4+4+4+2+2+2+2+0+0+0+0+0+0+0+2+2)/16=1375Kbps average-rate < burst-threshold → Burst allowed is 4Mbps 20 (4+4+2+2+2+2+0+0+0+0+0+0+0+2+2+4)/16=1375Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 21 (4+2+2+2+2+0+0+0+0+0+0+0+2+2+4+4)/16=1375Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 22 (2+2+2+2+0+0+0+0+0+0+0+2+2+4+4+4)/16=1375Kbps average-rate < burst-threshold → Burst is allowed 4Mbps 23 (2+2+2+0+0+0+0+0+0+0+2+2+4+4+4+4)/16=1500Kbps average-rate = burst-threshold → Burst allowed not 2Mbps 24 (2+2+0+0+0+0+0+0+0+2+2+4+4+4+4+2)/16=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps 25 (2+0+0+0+0+0+0+0+2+2+4+4+4+4+2+2)/16=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps 26 (0+0+0+0+0+0+0+2+2+4+4+4+4+2+2+2)/16=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps 27 (0+0+0+0+0+0+2+2+4+4+4+4+2+2+2+2)/16=1625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 28 (0+0+0+0+0+2+2+4+4+4+4+2+2+2+2+2)/16=1750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps 29 (0+0+0+0+2+2+4+4+4+4+2+2+2+2+2+2)/16=1875Kbps average-rate > burst-threshold → Burst not allowed 0Mbps 30 (0+0+0+2+2+4+4+4+4+2+2+2+2+2+2+0)/16=1875Kbps average-rate > burst-threshold → Burst not allowed 0Mbps 31 (0+0+2+2+4+4+4+4+2+2+2+2+2+2+0+0)/16=1875Kbps average-rate > burst-threshold → Burst not allowed 0Mbps Burst-time=8s

If we decrease burst-time to 8 seconds - we are able to see that in this case, bursts are only at the beginning of downloads The average rate is calculated every 1/16th of burst time, so in this case every 0.5 seconds.

Time average-rate burst actual-rate 0.0 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+0+0)/8=0Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 0.5 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+0+2)/8=250Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 1.0 (0+0+0+0+0+0+0+0+0+0+0+0+0+0+2+2)/8=500Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 1.5 (0+0+0+0+0+0+0+0+0+0+0+0+0+2+2+2)/8=750Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 2.0 (0+0+0+0+0+0+0+0+0+0+0+0+2+2+2+2)/8=1000Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 2.5 (0+0+0+0+0+0+0+0+0+0+0+2+2+2+2+2)/8=1250Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 3.0 (0+0+0+0+0+0+0+0+0+0+2+2+2+2+2+2)/8=1500Kbps average-rate = burst-threshold → Burst allowed not 2Mbps (1Mb per 0,5sek) 3.5 (0+0+0+0+0+0+0+0+0+2+2+2+2+2+2+1)/8=1625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 4.0 (0+0+0+0+0+0+0+0+2+2+2+2+2+2+1+1)/8=1750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 4.5 (0+0+0+0+0+0+0+2+2+2+2+2+2+1+1+1)/8=1875Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 5.0 (0+0+0+0+0+0+2+2+2+2+2+2+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 5.5 (0+0+0+0+0+2+2+2+2+2+2+1+1+1+1+1)/8=2125Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 6.0 (0+0+0+0+2+2+2+2+2+2+1+1+1+1+1+1)/8=2250Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 6.5 (0+0+0+2+2+2+2+2+2+1+1+1+1+1+1+1)/8=2375Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 7.0 (0+0+2+2+2+2+2+2+1+1+1+1+1+1+1+1)/8=2500Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 7.5 (0+2+2+2+2+2+2+1+1+1+1+1+1+1+1+1)/8=2625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 8.0 (2+2+2+2+2+2+1+1+1+1+1+1+1+1+1+1)/8=2750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 8.5 (2+2+2+2+2+1+1+1+1+1+1+1+1+1+1+1)/8=2625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 9.0 (2+2+2+2+1+1+1+1+1+1+1+1+1+1+1+1)/8=2500Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 9.5 (2+2+2+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2375Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 10.0 (2+2+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2250Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 10.5 (2+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2125Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 11.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 11.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 12.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 12.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 13.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 13.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+0)/8=1875Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 14.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+0+0)/8=1750Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 14.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+0+0+0)/8=1625Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 15.0 (1+1+1+1+1+1+1+1+1+1+1+1+0+0+0+0)/8=1500Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 15.5 (1+1+1+1+1+1+1+1+1+1+1+0+0+0+0+0)/8=1375Kbps average-rate < burst-threshold → Burst allowed is 0Mbps (0Mb per 0,5sek) 16.0 (1+1+1+1+1+1+1+1+1+1+0+0+0+0+0+0)/8=1250Kbps average-rate < burst-threshold → Burst is allowed 0Mbps (0Mb per 0,5sek) 16.5 (1+1+1+1+1+1+1+1+1+0+0+0+0+0+0+0)/8=1125Kbps average-rate < burst-threshold → Burst is allowed 0Mbps (0Mb per 0,5sek) 17.0 (1+1+1+1+1+1+1+1+0+0+0+0+0+0+0+0)/8=1000Kbps average-rate < burst-threshold → Burst is allowed 2Mbps (1Mb per 0,5sek) 17.5 (1+1+1+1+1+1+1+0+0+0+0+0+0+0+0+1)/8=1000Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 18.0 (1+1+1+1+1+1+0+0+0+0+0+0+0+0+1+2)/8=1125Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 18.5 (1+1+1+1+1+0+0+0+0+0+0+0+0+1+2+2)/8=1250Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 19.0 (1+1+1+1+0+0+0+0+0+0+0+0+1+2+2+2)/8=1375Kbps average-rate < burst-threshold → Burst is allowed 4Mbps (2Mb per 0,5sek) 19.5 (1+1+1+0+0+0+0+0+0+0+0+1+2+2+2+2)/8=1500Kbps average-rate = burst-threshold → Burst allowed not 2Mbps (1Mb per 0,5sek) 20.0 (1+1+0+0+0+0+0+0+0+0+1+2+2+2+2+1)/8=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek)

20.5 (1+0+0+0+0+0+0+0+0+1+2+2+2+2+1+1)/8=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 21.0 (0+0+0+0+0+0+0+0+1+2+2+2+2+1+1+1)/8=1500Kbps average-rate = burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 21.5 (0+0+0+0+0+0+0+1+2+2+2+2+1+1+1+1)/8=1625Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 22.0 (0+0+0+0+0+0+1+2+2+2+2+1+1+1+1+1)/8=1750Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 22.5 (0+0+0+0+0+1+2+2+2+2+1+1+1+1+1+1)/8=1875Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 23.0 (0+0+0+0+1+2+2+2+2+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 23.5 (0+0+0+1+2+2+2+2+1+1+1+1+1+1+1+1)/8=2125Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 24.0 (0+0+1+2+2+2+2+1+1+1+1+1+1+1+1+1)/8=2250Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 24.5 (0+1+2+2+2+2+1+1+1+1+1+1+1+1+1+1)/8=2375Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 25.0 (1+2+2+2+2+1+1+1+1+1+1+1+1+1+1+1)/8=2500Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 25.5 (2+2+2+2+1+1+1+1+1+1+1+1+1+1+1+1)/8=2500Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 26.0 (2+2+2+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2375Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 26.5 (2+2+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2250Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 27.0 (2+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2125Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 27.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 28.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 28.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 29.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 29.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 30.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 2Mbps (1Mb per 0,5sek) 30.5 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1)/8=2000Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek) 31.0 (1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+0)/8=1875Kbps average-rate > burst-threshold → Burst not allowed 0Mbps (0Mb per 0,5sek)

PCQ example Per Connection Queue (PCQ) is a queuing discipline that can be used to dynamically equalize or shape traffic for multiple users, using little administration. It is possible to divide PCQ scenarios into three major groups: equal bandwidth for a number of users, certain bandwidth equal distribution between users, and unknown bandwidth equal distribution between users. Equal Bandwidth for a Number of Users Use PCQ type queue when you need to equalize the bandwidth [and set max limit] for a number of users. We will set the 64kbps download and 32kbps upload limits. There are two ways how to make this: using mangle and queue trees, or, using simple queues. 1. Mark all packets with packet-marks upload/download: (let's consider that ether1-WAN is the public interface to the Internet and ether2-LAN is a local interface where clients are connected): /ip firewall mangle add chain=prerouting action=mark-packet \ in-interface=ether2-LAN new-packet-mark=client_upload /ip firewall mangle add chain=prerouting action=mark-packet \ in-interface=ether1-WAN new-packet-mark=client_download 2. Set up two PCQ queue types - one for download and one for upload. is a classifier for the user's download traffic, for dst-address and src-address upload traffic: /queue type add name="PCQ_download" kind=pcq pcq-rate=64000 pcq-classifier=dst-address /queue type add name="PCQ_upload" kind=pcq pcq-rate=32000 pcq-classifier=src-address 3. Finally, two queue rules are required, one for download and one for upload:

/queue tree add parent=global queue=PCQ_download packet-mark=client_download /queue tree add parent=global queue=PCQ_upload packet-mark=client_upload If you don't like using mangle and queue trees, you can skip step 1, do step 2, and step 3 would be to create one simple queue as shown here: /queue simple add target=192.168.0.0/24 queue=PCQ_upload/PCQ_download

1. 2. 3. 4. 5. 6. 7. 8. Queue types Overview Queue type (also known as a queuing discipline) refers to the policy by which various data packets are managed in a network queue. This policy determines which packet to send next from the queue when a data transmission has been completed. The queue type impacts how the network handles data traffic, which in turn affects factors such as the distribution of bandwidth among different flows, latency, and the handling of congestion. Queue types can be simple or complex, and different types have different strengths and weaknesses. For example, a First In, First Out (FIFO) queue is simple and ensures fairness in the order of packet processing, but it can lead to issues such as head-of-line blocking. More complex queue types, such as those that implement fair queuing or congestion avoidance, can help manage network performance more effectively, but they may require more resources and configuration. Therefore, the choice of queue type depends on the specific needs and characteristics of the network. Queue type introduction BFIFO (Byte-oriented First In, First Out): Features: BFIFO is a simple byte-oriented queuing discipline that sends out packets in the order they arrived and based on their size. Advantages: Simplicity and fairness in packet management. Disadvantages: BFIFO can lead to head-of-line blocking, where a large packet can delay all the smaller packets behind it. Also, there is no mechanism to prevent congestion or prioritize packets. PFIFO (Packet-oriented First In, First Out): Features: Like BFIFO but operates on a packet basis rather than bytes. Advantages: Easy to implement and understand. It's fair in terms of packet numbers. Disadvantages: Like BFIFO, it suffers from head-of-line blocking and doesn't have any congestion management mechanism. CAKE (Common Applications Kept Enhanced): Features: A comprehensive queue management system designed to combat bufferbloat and ensure fair queuing. It combines CoDel, FQ, and other technologies. Advantages: Excellent at managing latency under any network condition. It's particularly useful in consumer broadband connections. Disadvantages: More complex to configure than simpler queuing disciplines. Not ideal for all use cases, particularly where fine-tuned control is required. CoDel (Controlled Delay): Features: CoDel aims to improve bufferbloat by dropping packets to control queue delay. Advantages: Good at managing latency and avoiding bufferbloat. Disadvantages: CoDel on its own does not provide fair queuing. FQ_CoDel (Fair Queuing Controlled Delay): Features: Combines the latency management of CoDel with fair queuing. Advantages: Excellent latency management and fair distribution of bandwidth among flows. Generally considered a good default choice. Disadvantages: More complex than simpler queue disciplines, which can make it harder to configure. MQ_PFIFO (Multiqueue Packet First In, First Out): Features: MQ_PFIFO is an extension of PFIFO that supports multiple queues. Advantages: Allows different queues for different types or priorities of traffic. Disadvantages: Still suffers from head-of-line blocking and lacks a built-in congestion management mechanism. RED (Random Early Detection): Features: RED aims to anticipate and prevent congestion by randomly dropping packets before the queue becomes full. Advantages: Helps to prevent congestion and can improve overall network performance. Disadvantages: Configuration can be complex and needs to be tuned for the network's specific characteristics. Misconfiguration can lead to reduced performance. SFQ (Stochastic Fairness Queuing): Features: SFQ aims to ensure a fair distribution of resources among flows by assigning them to different dynamic queues. Advantages: Helps to prevent a single flow from dominating the connection. Disadvantages: SFQ does not manage latency or congestion. The number of queues can also increase memory usage. In choosing a queue discipline, you'll need to consider the characteristics of your network and what you prioritize most, such as latency, fairness, simplicity, or congestion management.

CAKE CAKE (Common Applications Kept Enhanced) Description: CAKE (Common Applications Kept Enhanced) is a modern, advanced queue management algorithm designed to cope with varying network conditions and different types of traffic. It was developed to address the limitations of older algorithms and provide an all-in-one solution to several common network problems. CAKE's approach is to maintain fairness, minimize bufferbloat, and manage different types of traffic with minimal configuration and tuning. This is achieved through various techniques including flow isolation, bandwidth shaping, and prioritization of small packets. Property Description Bandwith Limit: This allows you to manually set the bandwidth limit for the CAKE shaper. For instance, if you're aware that your ISP provides you with a 100Mbps connection, you could set the rate to 100Mbps to prevent CAKE from trying to use more bandwidth than available. Autorate IngressThis is useful in situations where the connection quality varies. For example, if you're on a cellular data connection that can fluctuate wildly based on signal strength, this option allows CAKE to adjust the shaper bandwidth dynamically to match the estimated capacity of the link. Overhead The overhead parameter in the CAKE queue discipline allows you to specify the per-packet overhead (in bytes) to account for when shaping traffic. This is particularly important when dealing with technologies such as DSL, where protocol encapsulation adds additional bytes to each packet. Accurately accounting for these overheads will lead to more precise control of the actual bandwidth being used. MPU The Minimum Packet Unit (MPU) parameter allows you to round up the size of each packet to a specified minimum. This is useful for link layer technologies that have a minimum packet size. For example, if your link layer technology has a minimum packet size of 64 bytes, you can configure CAKE with . mpu 64 ATM This is for Asynchronous Transfer Mode, a type of network technology often used in DSL broadband connections. ATM uses fixed 53-byte cells, each of which can carry 48 bytes of payload. The keyword compensates for this overhead. atm Overhead SchemeThe overhead compensation feature in CAKE allows it to account for the extra bytes added by various link layer technologies, which can be significant in some cases. This is important because CAKE operates on the packet sizes reported by the Linux kernel, which do not include these extra bytes. If the overhead is not accounted for, CAKE's shaper might allow more data onto the link than it can actually handle, leading to unexpected packet loss. RTT Manually specify an RTT. This is for advanced users who know the exact RTT they want to use. RTT SchemeThe CAKE queue discipline allows you to specify the Round Trip Time (RTT) it should consider when managing traffic. This is important because the time it takes for a packet to travel from a source to a destination and back impacts how CAKE manages network congestion. If the actual RTT of your network is close to the value you specify, both the throughput and latency of your network should be well managed. Diffserv Diffserv (Differentiated Services) is a mechanism used to prioritize and classify network traffic based on the Diffserv field in the IP packet header. CAKE (Common Applications Kept Enhanced) provides Diffserv support, allowing traffic to be divided into "tins" (traffic classes) and applying different treatment to each tin. Flow ModeWhen flow isolation is enabled, CAKE puts packets from different flows into different queues. Each queue maintains its own Active Queue Management (AQM) state, and packets are delivered from each queue fairly using a DRR++ (Deficit Round Robin++) algorithm. This algorithm works to minimize latency for "sparse" flows, or flows that contain fewer packets. ACK Filter ACK or acknowledgment filters are a feature of the Cake algorithm that allows for the handling of TCP ACK (acknowledgment) packets. TCP ACK packets are essential to the function of the TCP protocol; they acknowledge the receipt of TCP segments, providing a form of flow control. However, these packets can consume a significant portion of your upload bandwidth, especially when downloading large files. By implementing ACK filtering, Cake can compress these ACKs, reducing their impact on upload bandwidth. NAT These options control how CAKE handles traffic when Network Address Translation (NAT) is being used. makes CAKE consider the nat post-NAT addresses and ports when isolating flows, which can be useful when you're shaping traffic on a router that is also performing NAT for its connected devices. Wash The "wash" option in the CAKE queue discipline is used to address the issue of frequently mis-marked traffic entering or exiting a DiffServ (Differentiated Services) domain. When traffic passes through networks or providers, there is a chance that the DSCP (Differentiated Services Code Point) markings could be modified or incorrectly assigned.

1. 2. 3. 4. 5. 6. 7. 8. 9. 1. 2. 3. 4. 5. 6. 7. 8. 9. Overhead Schemes The overhead compensation feature in CAKE allows it to account for the extra bytes added by various link layer technologies, which can be significant in some cases. This is important because CAKE operates on the packet sizes reported by the Linux kernel, which do not include these extra bytes. If the overhead is not accounted for, CAKE's shaper might allow more data onto the link than it can actually handle, leading to unexpected packet loss. : You can manually specify the overhead in bytes. For instance, if you know your link layer adds 18 bytes of Manual Overhead Specification overhead to each packet, you can configure CAKE with . Negative values are also accepted, within a range of -64 to 256 bytes. overhead 18 : The Minimum Packet Unit (MPU) parameter allows you to round up the size of each packet to a specified minimum. This is useful for link MPU layer technologies that have a minimum packet size. For example, if your link layer technology has a minimum packet size of 64 bytes, you can configure CAKE with . mpu 64 : This is for Asynchronous Transfer Mode, a type of network technology often used in DSL broadband connections. ATM uses fixed 53-byte ATM cells, each of which can carry 48 bytes of payload. The keyword compensates for this overhead. atm : This is for Packet Transfer Mode, another network technology often used in VDSL2 connections. PTM uses a 64b/65b encoding scheme, PTM which effectively reduces the usable bandwidth by a small amount. The keyword compensates for this overhead. ptm : The and keywords are provided for quick-and-dirty setup. turns off all overhead Failsafe Overhead Keywords raw conservative raw compensation in CAKE, and compensates for more overhead than is likely to occur on any widely-deployed link technology. conservative : Most ADSL modems use ATM cell framing and have additional overhead due to the PPPoA or PPPoE protocol used. ADSL Overhead Keywords Keywords such as , , etc. are provided to account for these overheads. pppoa-vcmux pppoe-llc : VDSL2 uses PTM instead of ATM and may also use PPPoE. Keywords such as and are VDSL2 Overhead Keywords pppoe-ptm bridged-ptm provided to account for these overheads. : DOCSIS is the standard for providing Internet service over cable-TV infrastructure. The keyword is DOCSIS Cable Overhead Keyword docsis provided to account for the overhead of DOCSIS. : These keywords account for the overhead of Ethernet frames, including the preamble, inter-frame gap, and Frame Ethernet Overhead Keywords Check Sequence. and are provided for Ethernet and Ethernet with VLAN respectively​ ​. ethernet ether-vlan 1 RTT Schemes The CAKE queue discipline allows you to specify the Round Trip Time (RTT) it should consider when managing traffic. This is important because the time it takes for a packet to travel from a source to a destination and back impacts how CAKE manages network congestion. If the actual RTT of your network is close to the value you specify, both the throughput and latency of your network should be well managed. Here are the RTT settings you can use, what they mean, and when you might use them: : Manually specify an RTT. This is for advanced users who know the exact RTT they want to use. rtt TIME : This is for extremely high-performance networks, such as a 10 Gigabit Ethernet (10GigE) network in a data center. The RTT is datacentre assumed to be 100 microseconds. Example: Use this if you're managing network traffic in a high-capacity data center. : This is for pure Ethernet networks, such as those you might find in a home or office environment. The RTT is assumed to be 1 millisecond. lan Example: Use this if you're managing traffic on a wired home or office network, but not when shaping for an Internet access link. : This is for traffic mostly within a single city. The RTT is assumed to be 10 milliseconds. Example: Use this if you're managing traffic for a metro network in a single city, like a city-wide corporate network. : This is for traffic mostly within a European-sized country. The RTT is assumed to be 30 milliseconds. Example: Use this if you're regional managing traffic for a network that spans a country. : This is suitable for most Internet traffic. The RTT is assumed to be 100 milliseconds. Example: Use this if you're managing general internet Internet traffic on a typical broadband connection. : This is for Internet traffic with generally above-average latency, such as that suffered by Australasian residents. The RTT is assumed to oceanic be 300 milliseconds. Example: Use this if you're managing traffic in a location with high latency, like Australia or New Zealand. : This is for traffic via geostationary satellites. The RTT is assumed to be 1000 milliseconds (1 second). Example: Use this if you're satellite managing traffic for a network that uses a satellite internet connection. : This disables Active Queue Management (AQM) actions, because the RTT is so long (3600 seconds). It's named interplanetary "interplanetary" because the distance from Earth to Jupiter is about one light-hour. Example: This is not typically used in standard networking situations, but might be useful in extremely high latency situations, such as experimental long-distance communication scenarios. Remember, these are guidelines, and the best setting depends on the specific characteristics and requirements of your network. If you are unsure, the int setting is a good starting point for most scenarios​ ​. ernet 1 FLOW ISOLATION PARAMETER When flow isolation is enabled, CAKE puts packets from different flows into different queues. Each queue maintains its own Active Queue Management (AQM) state, and packets are delivered from each queue fairly using a DRR++ (Deficit Round Robin++) algorithm. This algorithm works to minimize latency for "sparse" flows, or flows that contain fewer packets.

1. 2. 3. 4. 5. 6. 7. 8. 1. 2. The key aspect here is the method by which CAKE determines different flows, known as "flow isolation." CAKE uses a set-associative hashing algorithm to reduce flow collisions. - This parameter disables flow isolation, and all traffic goes through a single queue for each 'tin' or traffic class. flowblind Useful in scenarios where specific flow isolation is not needed or desired, such as when you want to process all traffic the same way regardless of source or destination. Here, flows are determined solely by the source address. This could be beneficial on the outgoing path of an Internet Service Provider srchost - (ISP) backhaul. A telecom company might use this to ensure fair use of its backbone network by different regions or customers. With this parameter, flows are characterized only by their destination address. This might be beneficial on the incoming path of an ISP dsthost - backhaul. An enterprise could use this to balance incoming traffic to its different servers. In this case, flows are defined by source-destination host pairs. This is host isolation rather than flow isolation. hosts - This might be useful in a data center network, where you want to ensure that communication between specific pairs of servers is fair. - Flows are characterized by the entire 5-tuple: source address, destination address, transport protocol, source port, and destination port. flows This is the kind of flow isolation performed by SFQ and fq_codel. This could be used by a cloud provider to ensure fairness among different virtual machines communicating over various protocols and ports. - Here, flows are defined by the 5-tuple, and fairness is applied first over source addresses, then over individual flows. This is a good dual-srchost choice for outgoing traffic from a Local Area Network (LAN) to the Internet. A university might use this to prevent any single user or device from hogging the internet connection, no matter how many different connections they're using. - In this case, flows are defined by the 5-tuple, and fairness is applied first over destination addresses, then over individual flows. dual-dsthost This is suitable for incoming traffic to a LAN from the internet. A large company could use this to prevent any single server or system from overwhelming the network's incoming bandwidth. - This is the default setting where flows are defined by the 5-tuple. Fairness is applied over both source and destination addresses triple-isolate intelligently, as well as over individual flows. This prevents any one host on either side of the link from monopolizing it with a large number of flows. A Internet Service Provider (ISP) might use this to ensure fair service to all its customers, regardless of how many connections they have and whether they Ack Filter ACK or acknowledgement filters are a feature of the Cake algorithm that allows for the handling of TCP ACK (acknowledgment) packets. TCP ACK packets are essential to the function of the TCP protocol; they acknowledge the receipt of TCP segments, providing a form of flow control. However, these packets can consume a significant portion of your upload bandwidth, especially when downloading large files. By implementing ACK filtering, Cake can compress these ACKs, reducing their impact on upload bandwidth. - This enables the ACK filter feature. With this option, Cake will attempt to identify and filter out ACK packets that do not convey ack-filter significant new information or do not need to be sent immediately, helping to improve the utilization of the upload bandwidth. - This is a more aggressive version of the ack-filter option. It will result in more ACK packets being compressed or filtered ack-filter-aggressive out, which can lead to further improvements in upload bandwidth utilization but may potentially impact TCP performance.The use of the ack-filter or ack-filter-aggressive options depends on your specific network conditions and requirements. For instance, if you find that ACK packets are using a large portion of your available upload bandwidth, then enabling the ACK filter might help. On the other hand, if you're experiencing issues with TCP performance and suspect that ACK filtering might be contributing, you could try disabling it or using the less aggressive option. Wash The "wash" option in the CAKE queue discipline is used to address the issue of frequently mis-marked traffic entering or exiting a DiffServ (Differentiated Services) domain. When traffic passes through networks or providers, there is a chance that the DSCP (Differentiated Services Code Point) markings could be modified or incorrectly assigned. To illustrate this with a real-life example and analogy: Let's imagine you are running a busy airport. Different airlines have assigned different priority levels to their passengers based on their ticket classes (economy, business, first-class). These priority levels are analogous to the DSCP markings in a network. However, as passengers move through various transit airports, there is a possibility that the assigned priority levels could be changed or mis-marked due to different airline policies or inconsistencies at the transit airports. This is similar to the mis-marking of traffic in transit networks. Now, in the context of the airport, let's assume that upon arrival at your airport, passengers are divided into separate queues based on their priority levels. This division ensures that passengers in higher-priority classes are processed more quickly and receive better service. However, because the priority levels assigned at previous airports may not be reliable, it becomes necessary to "wash" or clear the assigned priority levels before the passengers enter the queues at your airport. This is similar to the "wash" option in CAKE, which clears extra DSCP markings after priority queuing has taken place.

1. 2. 3. 4. 1. 2. 3. 1. 2. 3. 4. 5. 6. 7. 8. In situations where inbound traffic's DSCP markings cannot be trusted (similar to cases like Comcast Cable), it is recommended to use a single queue "besteffort" mode with the "wash" option. This means that all incoming traffic is treated as the default "best effort" class, and any potentially unreliable or mis-marked DSCP values are cleared before further processing. In our airport analogy, using a single queue "besteffort" mode with "wash" would mean that regardless of the priority assigned at previous airports, all passengers are initially treated as standard passengers (best effort class) until their priority can be accurately determined and assigned at your airport. This approach ensures that even if the DSCP markings of incoming traffic have been mis-marked or modified during transit, the traffic is treated fairly and uniformly within your network, without relying on potentially unreliable markings from external sources. By applying the "wash" option in CAKE, network administrators can mitigate the impact of mis-marked or modified DSCP markings, providing a more consistent and reliable Quality of Service (QoS) treatment within their network domain. Diffserv RFC2474 and RFC2475 Diffserv (Differentiated Services) is a mechanism used to prioritize and classify network traffic based on the Diffserv field in the IP packet header. CAKE (Common Applications Kept Enhanced) provides Diffserv support, allowing traffic to be divided into "tins" (traffic classes) and applying different treatment to each tin. Here's a breakdown of the Diffserv presets in CAKE along with real-world examples: -The "besteffort" preset in CAKE disables priority queuing and places all traffic into a single tin. This means that all traffic is treated equally besteffort without any specific prioritization. This preset can be suitable for non-critical or low-priority traffic, such as general web browsing or background file downloads, where equal treatment is sufficient. - The "precedence" preset enables the legacy interpretation of the TOS (Type of Service) "Precedence" field. However, its usage on the precedence modern internet is discouraged, as it is an outdated mechanism. In the past, this field was used to indicate different levels of priority, such as high, medium, or low, but it is no longer widely used or recommended. - The "diffserv4" preset provides a general-purpose Diffserv implementation with four tins: diffserv4 : This tin corresponds to CS1 (Class Selector 1) or LE (Low Extra), and it has a threshold of 6.25%. Traffic in this tin typically has a low Bulk priority. : This tin is for general traffic that doesn't fall into any specific Diffserv class. It has a threshold of 100%, meaning it receives all Best Effort remaining bandwidth. : This tin encompasses AF4x, AF3x, CS3, AF2x, CS2, TOS4, and TOS1. It has a threshold of 50%, providing a moderate priority for video Video traffic. : This tin covers CS7, CS6, EF (Expedited Forwarding), VA (Voice Admit), CS5, and CS4. It has a threshold of 25%, giving high priority to Voice voice traffic. In a network where video streaming, voice over IP (VoIP), and general internet traffic coexist, this preset can ensure that video and voice traffic receive appropriate priority, while bulk and best-effort traffic are handled accordingly. (default) - The "diffserv3" preset is the default Diffserv implementation in CAKE, providing three tins: diffserv3 : Similar to the "diffserv4" preset, this tin represents CS1 or LE with a 6.25% threshold, serving as a low-priority traffic class.Bulk This tin is for general traffic and has a threshold of 100%, treating all remaining traffic equally. Best Effort: : This tin covers CS7, CS6, EF, VA, and TOS4. It has a threshold of 25% and applies a reduced CoDel (Controlled Delay) interval, giving Voice high priority to voice traffic. In a network where voice traffic requires high priority, such as a VoIP system, while other traffic falls into a general category, the "diffserv3" preset can ensure appropriate priority for voice packets while maintaining fairness for other traffic. - is an more advances purpuse diffserver with 8 tins: diffserv8 The 8 classes in DiffServ8 are mapped to different types of network traffic based on their importance, using decimal values for Differentiated Services Code Point (DSCP): Network Control (48-63): Highest priority, often used for critical network traffic like routing information. Telephony (46): Traffic sensitive to latency, such as VoIP. Signaling (32-47): Control signals for real-time applications. Multimedia Conferencing (24-31): Video conferencing traffic. Real-time Interactive (40): Interactive applications, such as gaming. Multimedia Streaming (16-23): Streaming video and audio. Low Latency Data (8-15): Traffic requiring low latency, like financial transactions. Best Effort (0): Default traffic class with no special priority.

1. 2. 3. 4. "unlimited" or "autorate-ingress" When using the "unlimited" or "autorate-ingress" option in the CAKE queue discipline, CAKE automatically determines the download speed based on observed packet arrival times. Here's how it works: Monitoring Packet Arrival Times: CAKE continuously monitors the arrival times of incoming packets. It keeps track of the time intervals between consecutive packets to estimate the rate at which packets are being received. Calculating Average Packet Arrival Rate: CAKE calculates the average packet arrival rate based on the observed arrival times. By dividing the number of received packets by the total time elapsed, it determines the average rate at which packets are arriving. Deriving Download Speed: From the average packet arrival rate, CAKE infers the download speed or throughput of the network connection. It assumes that the packet arrival rate corresponds to the download speed, given that each packet represents a certain amount of data. Dynamic Adjustment: As CAKE continues to monitor packet arrival times, it adjusts the download speed estimation dynamically. If the arrival rate increases, CAKE will update the download speed estimate to reflect the higher throughput. Conversely, if the arrival rate decreases, CAKE will adjust the estimate accordingly. By automatically determining the download speed, CAKE adapts to changes in the network conditions and ensures that traffic shaping and queuing algorithms are adjusted to optimize the utilization of available bandwidth. It's worth noting that while CAKE can estimate the download speed based on packet arrival times, it does not have direct knowledge of the link capacity or the true download speed as reported by the network equipment or service provider. Instead, it relies on observed packet arrival rates to approximate the download speed for traffic shaping purposes.

PFIFO,BFIFO PFIFO (Packet First-In, First-Out) Description: PFIFO (Packet First-In, First-Out) is a queue management strategy that follows the basic queue logic. The main principle of PFIFO is that the first packet to arrive is the first packet to be transmitted out. This method is simple, and straightforward, and ensures that no packet receives preferential treatment over the others. When packets enter the queue, they are placed at the end (tail) of the queue. As space becomes available for transmission, the packets at the front (head) of the queue are transmitted first. If the queue is full when a packet arrives, the packet is dropped or other policies are followed, depending on the overall queue management strategy in place. Characteristics: Simplicity: PFIFO is one of the simplest forms of queue management. It doesn't require complex algorithms or significant computational resources. This makes it easy to implement and understand. Fairness: All packets are treated equally, regardless of their source, destination, or content. The first packet in is the first one out. No Prioritization: There's no inherent capability to prioritize certain types of traffic over others. While this ensures fairness, it can be a drawback when dealing with different types of network traffic that might need prioritization. Examples: Imagine a line at the post office. Each person (packet) waiting in line represents a data packet waiting in the queue. The first person in line gets served first, then the next, and so on. If the post office is too busy and the line is full, any new person arriving would have to wait or leave (the packet is dropped). Conclusion: While PFIFO is simple and straightforward, its lack of traffic prioritization capabilities can be a downside, especially when managing network traffic that contains different types of data. In these situations, more complex queue management algorithms, such as Priority Queuing (PQ), Class-Based Weighted Fair Queuing (CBWFQ), or Low Latency Queuing (LLQ), might be more suitable. BFIFO (Byte First-In, First-Out) Description: BFIFO (Byte First-In, First-Out) is another queue management strategy, similar to PFIFO in its principle of operation, but with a key difference: BFIFO operates based on the size of packets, or bytes, rather than on the number of packets. In a BFIFO system, when packets enter the queue, they are still placed at the end, and packets at the front are transmitted first. However, the queue size is calculated in bytes, not in number of packets. When the queue reaches its maximum byte size, any new packets that arrive are dropped, or other policies are followed. Characteristics: Byte-Based: Unlike PFIFO, BFIFO calculates the queue size based on bytes, which allows for more precise control of bandwidth usage. Fairness: BFIFO also ensures fairness as it treats all packets equally, regardless of their source, destination, or content. No Prioritization: Similar to PFIFO, there's no inherent capability in BFIFO to prioritize certain types of traffic over others. Examples: Consider a public bus as an example of a BFIFO system. The bus has a maximum capacity of passengers it can carry (similar to the byte size of the queue). Even if there is a line of people waiting (packets), if the bus is full, new passengers cannot get on (packets are dropped).

Comparison: PFIFO vs. BFIFO While both PFIFO and BFIFO are FIFO (First-In, First-Out) strategies and follow the basic queue logic, there are some differences: Queue Size: PFIFO considers the queue size in terms of the number of packets, while BFIFO calculates the queue size in bytes. This means that BFIFO takes into account the size of each packet, which can allow for more accurate control of bandwidth usage. Packet Dropping: In PFIFO, packets are dropped when the queue is full in terms of the number of packets. In BFIFO, packets are dropped when the byte size of the queue is exceeded, even if this means dropping a packet that is larger than the remaining space in the queue. Fairness: Both PFIFO and BFIFO are fair in terms of the order of packet transmission – the first in is the first out. However, in a situation where packets are of different sizes, PFIFO could lead to a situation where a large packet takes up a lot of resources but is treated the same as a smaller packet. On the other hand, BFIFO's byte-based approach can provide more balanced resource usage. Complexity: Both strategies are simple compared to more complex queuing strategies that prioritize certain types of traffic. However, BFIFO is slightly more complex than PFIFO because it requires tracking the total size of all packets in the queue. Overall, the choice between PFIFO and BFIFO depends on the specific requirements of your network and the characteristics of your traffic.

Firewall and QoS Case Studies

Building Advanced Firewall Overview Interface Lists Protect the Device Protect the Clients Masquerade Local Network RAW Filtering IPv4 Address Lists IPv4 RAW Rules IPv6 Address Lists IPv6 RAW Rules Overview From everything we have learned so far, let's try to build an advanced firewall. In this firewall building example, we will try to use as many firewall features as we can to illustrate how they work and when they should be used the right way. Most of the filtering will be done in the RAW firewall, a regular firewall will contain just a basic rule set to accept and established, related , untracked connections as well as dropping everything else not coming from LAN to fully protect the router. Interface Lists Two interface lists will be used and for easier future management purposes. Interfaces connected to the global internet should be added to the WAN LAN WAN list, in this case, it is ! ether1 /interface list add comment=defconf name=WAN add comment=defconf name=LAN /interface list member add comment=defconf interface=bridge list=LAN add comment=defconf interface=ether1 list=WAN Protect the Device The main goal here is to allow access to the router only from LAN and drop everything else. Notice that ICMP is accepted here as well, it is used to accept ICMP packets that passed RAW rules. /ip firewall filter add action=accept chain=input comment="defconf: accept ICMP after RAW" protocol=icmp add action=accept chain=input comment="defconf: accept established,related,untracked" connection- state=established,related,untracked add action=drop chain=input comment="defconf: drop all not coming from LAN" in-interface-list=!LAN IPv6 part is a bit more complicated, in addition, UDP traceroute, DHCPv6 client PD, and IPSec (IKE, AH, ESP) are accepted as per RFC recommendations. /ipv6 firewall filter add action=accept chain=input comment="defconf: accept ICMPv6 after RAW" protocol=icmpv6 add action=accept chain=input comment="defconf: accept established,related,untracked" connection- state=established,related,untracked add action=accept chain=input comment="defconf: accept UDP traceroute" dst-port=33434-33534 protocol=udp add action=accept chain=input comment="defconf: accept DHCPv6-Client prefix delegation." dst-port=546 protocol=udp src-address=fe80::/10 add action=accept chain=input comment="defconf: accept IKE" dst-port=500,4500 protocol=udp add action=accept chain=input comment="defconf: accept IPSec AH" protocol=ipsec-ah add action=accept chain=input comment="defconf: accept IPSec ESP" protocol=ipsec-esp add action=drop chain=input comment="defconf: drop all not coming from LAN" in-interface-list=!LAN

Protect the Clients Before the actual set of rules, let's create a necessary that contains all IPv4/6 addresses that cannot be forwarded. address-list Notice that in this list multicast address range is added. It is there because in most cases multicast is not used. If you intend to use multicast forwarding, then this address list entry should be disabled. /ip firewall address-list add address=0.0.0.0/8 comment="defconf: RFC6890" list=no_forward_ipv4 add address=169.254.0.0/16 comment="defconf: RFC6890" list=no_forward_ipv4 add address=224.0.0.0/4 comment="defconf: multicast" list=no_forward_ipv4 add address=255.255.255.255/32 comment="defconf: RFC6890" list=no_forward_ipv4 In the same case for IPv6, if multicast forwarding is used then the multicast entry should be disabled from the address-list. /ipv6 firewall address-list add address=fe80::/10 comment="defconf: RFC6890 Linked-Scoped Unicast" list=no_forward_ipv6 add address=ff00::/8 comment="defconf: multicast" list=no_forward_ipv6 Forward chain will have a bit more rules than input: accept and connections; established, related untracked FastTrack and connections (currently only IPv4); established related drop connections; invalid drop bad forward IPs, since we cannot reliably determine in RAW chains which packets are forwarded drop connections initiated from the internet (from the WAN side which is not destination NAT`ed); drop bogon IPs that should not be forwarded. We are dropping all non-dstnated IPv4 packets to protect direct attacks on the clients if the attacker knows the internal LAN network. Typically this rule would not be necessary since RAW filters will drop such packets, however, the rule is there for double security in case RAW rules are accidentally messed up. /ip firewall filter add action=accept chain=forward comment="defconf: accept all that matches IPSec policy" ipsec-policy=in,ipsec disabled=yes add action=fasttrack-connection chain=forward comment="defconf: fasttrack" connection-state=established, related add action=accept chain=forward comment="defconf: accept established,related, untracked" connection- state=established,related,untracked add action=drop chain=forward comment="defconf: drop invalid" connection-state=invalid add action=drop chain=forward comment="defconf: drop all from WAN not DSTNATed" connection-nat-state=!dstnat connection-state=new in-interface-list=WAN add action=drop chain=forward src-address-list=no_forward_ipv4 comment="defconf: drop bad forward IPs" add action=drop chain=forward dst-address-list=no_forward_ipv4 comment="defconf: drop bad forward IPs" IPv6 chain is very similar, except that IPsec and HIP are accepted as per RFC recommendations, and ICMPv6 with is dropped. forward hop-limit=1 In certain setups where the DHCPv6 relay is used, the src address of the packets may not be from the link-local range. In that case, the src- address parameter of rule #4 must be removed or adjusted to accept the relay address.

/ipv6 firewall filter add action=accept chain=forward comment="defconf: accept established,related,untracked" connection- state=established,related,untracked add action=drop chain=forward comment="defconf: drop invalid" connection-state=invalid add action=drop chain=forward src-address-list=no_forward_ipv6 comment="defconf: drop bad forward IPs" add action=drop chain=forward dst-address-list=no_forward_ipv6 comment="defconf: drop bad forward IPs" add action=drop chain=forward comment="defconf: rfc4890 drop hop-limit=1" hop-limit=equal:1 protocol=icmpv6 add action=accept chain=forward comment="defconf: accept ICMPv6 after RAW" protocol=icmpv6 add action=accept chain=forward comment="defconf: accept HIP" protocol=139 add action=accept chain=forward comment="defconf: accept IKE" protocol=udp dst-port=500,4500 add action=accept chain=forward comment="defconf: accept AH" protocol=ipsec-ah add action=accept chain=forward comment="defconf: accept ESP" protocol=ipsec-esp add action=accept chain=forward comment="defconf: accept all that matches IPSec policy" ipsec-policy=in,ipsec add action=drop chain=forward comment="defconf: drop everything else not coming from LAN" in-interface-list=!LAN Notice the IPsec policy matcher rules. It is very important that IPsec encapsulated traffic bypass fast-track. That is why as an illustration we have added a disabled rule to accept traffic matching IPsec policies. Whenever IPsec tunnels are used on the router this rule should be enabled. For IPv6 it is much more simple since it does not have fast-track support. Another approach to solving the IPsec problem is to add RAW rules, we will talk about this method later in the RAW section Masquerade Local Network For local devices behind the router to be able to access the internet, local networks must be masqueraded. In most cases, it is advised to use src-nat instead of masquerade, however in this case when the WAN address is dynamic it is the only option. /ip firewall nat add action=accept chain=srcnat comment="defconf: accept all that matches IPSec policy" ipsec-policy=out,ipsec disabled=yes add action=masquerade chain=srcnat comment="defconf: masquerade" out-interface-list=WAN Notice the disabled policy matcher rule, the same as in firewall filters IPSec traffic must be excluded from being NATed (except in specific scenarios where IPsec policy is configured to match NAT`ed address). So whenever IPsec tunnels are used on the router this rule must be enabled. RAW Filtering IPv4 Address Lists Before setting RAW rules, let's create some address lists necessary for our filtering policy. RFC 6890 will be used as a reference. First, contains all IPv4 addresses that cannot be used as src/dst/forwarded, etc. (will be dropped immediately if such address is seen) address-list /ip firewall address-list add address=127.0.0.0/8 comment="defconf: RFC6890" list=bad_ipv4 add address=192.0.0.0/24 comment="defconf: RFC6890" list=bad_ipv4 add address=192.0.2.0/24 comment="defconf: RFC6890 documentation" list=bad_ipv4 add address=198.51.100.0/24 comment="defconf: RFC6890 documentation" list=bad_ipv4 add address=203.0.113.0/24 comment="defconf: RFC6890 documentation" list=bad_ipv4 add address=240.0.0.0/4 comment="defconf: RFC6890 reserved" list=bad_ipv4 Another address list contains all IPv4 addresses that cannot be routed globally.

/ip firewall address-list add address=0.0.0.0/8 comment="defconf: RFC6890" list=not_global_ipv4 add address=10.0.0.0/8 comment="defconf: RFC6890" list=not_global_ipv4 add address=100.64.0.0/10 comment="defconf: RFC6890" list=not_global_ipv4 add address=169.254.0.0/16 comment="defconf: RFC6890" list=not_global_ipv4 add address=172.16.0.0/12 comment="defconf: RFC6890" list=not_global_ipv4 add address=192.0.0.0/29 comment="defconf: RFC6890" list=not_global_ipv4 add address=192.168.0.0/16 comment="defconf: RFC6890" list=not_global_ipv4 add address=198.18.0.0/15 comment="defconf: RFC6890 benchmark" list=not_global_ipv4 add address=255.255.255.255/32 comment="defconf: RFC6890" list=not_global_ipv4 And last two address lists for addresses that cannot be as destination or source address. /ip firewall address-list add address=224.0.0.0/4 comment="defconf: multicast" list=bad_src_ipv4 add address=255.255.255.255/32 comment="defconf: RFC6890" list=bad_src_ipv4 add address=0.0.0.0/8 comment="defconf: RFC6890" list=bad_dst_ipv4 add address=224.0.0.0/4 comment="defconf: RFC6890" list=bad_dst_ipv4 IPv4 RAW Rules Raw IPv4 rules will perform the following actions: add disabled "accept" rule - can be used to quickly disable RAW filtering without disabling all RAW rules; accept DHCP discovery - most of the DHCP packets are not seen by an IP firewall, but some of them are, so make sure that they are accepted; drop packets that use bogon IPs; drop from invalid SRC and DST IPs; drop globally unroutable IPs coming from WAN; drop packets with source-address not equal to 192.168.88.0/24 (default IP range) coming from LAN; drop packets coming from WAN to be forwarded to 192.168.88.0/24 network, this will protect from attacks if the attacker knows the internal network; drop bad ICMP, UDP, and TCP; accept everything else coming from WAN and LAN; drop everything else, to make sure that any newly added interface (like PPPoE connection to service provider) is protected against accidental misconfiguration. /ip firewall raw add action=accept chain=prerouting comment="defconf: enable for transparent firewall" disabled=yes add action=accept chain=prerouting comment="defconf: accept DHCP discover" dst-address=255.255.255.255 dst- port=67 in-interface-list=LAN protocol=udp src-address=0.0.0.0 src-port=68 add action=drop chain=prerouting comment="defconf: drop bogon IP's" src-address-list=bad_ipv4 add action=drop chain=prerouting comment="defconf: drop bogon IP's" dst-address-list=bad_ipv4 add action=drop chain=prerouting comment="defconf: drop bogon IP's" src-address-list=bad_src_ipv4 add action=drop chain=prerouting comment="defconf: drop bogon IP's" dst-address-list=bad_dst_ipv4 add action=drop chain=prerouting comment="defconf: drop non global from WAN" src-address-list=not_global_ipv4 in-interface-list=WAN add action=drop chain=prerouting comment="defconf: drop forward to local lan from WAN" in-interface-list=WAN dst-address=192.168.88.0/24 add action=drop chain=prerouting comment="defconf: drop local if not from default IP range" in-interface- list=LAN src-address=!192.168.88.0/24 add action=drop chain=prerouting comment="defconf: drop bad UDP" port=0 protocol=udp add action=jump chain=prerouting comment="defconf: jump to ICMP chain" jump-target=icmp4 protocol=icmp add action=jump chain=prerouting comment="defconf: jump to TCP chain" jump-target=bad_tcp protocol=tcp add action=accept chain=prerouting comment="defconf: accept everything else from LAN" in-interface-list=LAN add action=accept chain=prerouting comment="defconf: accept everything else from WAN" in-interface-list=WAN add action=drop chain=prerouting comment="defconf: drop the rest" Notice that we used some optional chains, the first chain to drop packets known to be TCP TCP invalid.

/ip firewall raw add action=drop chain=bad_tcp comment="defconf: TCP flag filter" protocol=tcp tcp-flags=!fin,!syn,!rst,!ack add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=fin,syn add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=fin,rst add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=fin,!ack add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=fin,urg add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=syn,rst add action=drop chain=bad_tcp comment=defconf protocol=tcp tcp-flags=rst,urg add action=drop chain=bad_tcp comment="defconf: TCP port 0 drop" port=0 protocol=tcp And another chain for . Note that if you want a very strict firewall then such strict filtering can be used, but in most cases, it is not necessary ICMP ICMP and simply adds more load on the router's CPU. ICMP rate limit in most cases is also unnecessary since the Linux kernel is already limiting ICMP packets to 100pps. /ip firewall raw add action=accept chain=icmp4 comment="defconf: echo reply" icmp-options=0:0 limit=5,10:packet protocol=icmp add action=accept chain=icmp4 comment="defconf: net unreachable" icmp-options=3:0 protocol=icmp add action=accept chain=icmp4 comment="defconf: host unreachable" icmp-options=3:1 protocol=icmp add action=accept chain=icmp4 comment="defconf: protocol unreachable" icmp-options=3:2 protocol=icmp add action=accept chain=icmp4 comment="defconf: port unreachable" icmp-options=3:3 protocol=icmp add action=accept chain=icmp4 comment="defconf: fragmentation needed" icmp-options=3:4 protocol=icmp add action=accept chain=icmp4 comment="defconf: echo" icmp-options=8:0 limit=5,10:packet protocol=icmp add action=accept chain=icmp4 comment="defconf: time exceeded " icmp-options=11:0-255 protocol=icmp add action=drop chain=icmp4 comment="defconf: drop other icmp" protocol=icmp IPv6 Address Lists List of IPv6 addresses that should be dropped instantly /ipv6 firewall address-list add address=::1/128 comment="defconf: RFC6890 lo" list=bad_ipv6 add address=::ffff:0:0/96 comment="defconf: RFC6890 IPv4 mapped" list=bad_ipv6 add address=2001::/23 comment="defconf: RFC6890" list=bad_ipv6 add address=2001:db8::/32 comment="defconf: RFC6890 documentation" list=bad_ipv6 add address=2001:10::/28 comment="defconf: RFC6890 orchid" list=bad_ipv6 add address=::/96 comment="defconf: ipv4 compat" list=bad_ipv6 List of IPv6 addresses that are not globally routable /ipv6 firewall address-list add address=100::/64 comment="defconf: RFC6890 Discard-only" list=not_global_ipv6 add address=2001::/32 comment="defconf: RFC6890 TEREDO" list=not_global_ipv6 add address=2001:2::/48 comment="defconf: RFC6890 Benchmark" list=not_global_ipv6 add address=fc00::/7 comment="defconf: RFC6890 Unique-Local" list=not_global_ipv6 List of addresses as an invalid destination address /ipv6 firewall address-list add address=::/128 comment="defconf: unspecified" list=bad_dst_ipv6 List of addresses as an invalid source address /ipv6 firewall address-list add address=::/128 comment="defconf: unspecified" list=bad_src_ipv6 add address=ff00::/8 comment="defconf: multicast" list=bad_src_ipv6 IPv6 RAW Rules Raw IPv6 rules will perform the following actions:

add disabled accept rule - can be used to quickly disable RAW filtering without disabling all RAW rules; drop packets that use bogon IPs; drop from invalid SRC and DST IPs; drop globally unroutable IPs coming from WAN; drop bad ICMP; accept everything else coming from WAN and LAN; drop everything else, to make sure that any newly added interface (like PPPoE connection to service provider) is protected against accidental misconfiguration. /ipv6 firewall raw add action=accept chain=prerouting comment="defconf: enable for transparent firewall" disabled=yes add action=accept chain=prerouting comment="defconf: RFC4291, section 2.7.1" src-address=::/128 dst- address=ff02:0:0:0:0:1:ff00::/104 icmp-options=135 protocol=icmpv6 add action=drop chain=prerouting comment="defconf: drop bogon IP's" src-address-list=bad_ipv6 add action=drop chain=prerouting comment="defconf: drop bogon IP's" dst-address-list=bad_ipv6 add action=drop chain=prerouting comment="defconf: drop packets with bad SRC ipv6" src-address-list=bad_src_ipv6 add action=drop chain=prerouting comment="defconf: drop packets with bad dst ipv6" dst-address-list=bad_dst_ipv6 add action=drop chain=prerouting comment="defconf: drop non global from WAN" src-address-list=not_global_ipv6 in-interface-list=WAN add action=jump chain=prerouting comment="defconf: jump to ICMPv6 chain" jump-target=icmp6 protocol=icmpv6 add action=accept chain=prerouting comment="defconf: accept local multicast scope" dst-address=ff02::/16 add action=drop chain=prerouting comment="defconf: drop other multicast destinations" dst-address=ff00::/8 add action=accept chain=prerouting comment="defconf: accept everything else from WAN" in-interface-list=WAN add action=accept chain=prerouting comment="defconf: accept everything else from LAN" in-interface-list=LAN add action=drop chain=prerouting comment="defconf: drop the rest" Notice that the optional chain was used. If you want a very strict firewall then such strict filtering can be used, but in most cases, it is not ICMP ICMP necessary and simply adds more load on the router's CPU. ICMP rate limit in most cases is also unnecessary since the Linux kernel is already limiting ICMP packets to 100pps /ipv6 firewall raw # Be aware that different operating systems originate packets with different default TTL values add action=drop chain=icmp6 comment="defconf: rfc4890 drop ll if hop-limit!=255" dst-address=fe80::/10 hop- limit=not-equal:255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: dst unreachable" icmp-options=1:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: packet too big" icmp-options=2:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: limit exceeded" icmp-options=3:0-1 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: bad header" icmp-options=4:0-2 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: Mobile home agent address discovery" icmp-options=144:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: Mobile home agent address discovery" icmp-options=145:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: Mobile prefix solic" icmp-options=146:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: Mobile prefix advert" icmp-options=147:0-255 protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: echo request limit 5,10" icmp-options=128:0-255 limit=5,10: packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: echo reply limit 5,10" icmp-options=129:0-255 limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 router solic limit 5,10 only LAN" hop-limit=equal:255 icmp-options=133:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 router advert limit 5,10 only LAN" hop-limit=equal:255 icmp-options=134:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 neighbor solic limit 5,10 only LAN" hop-limit=equal:255 icmp-options=135:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 neighbor advert limit 5,10 only LAN" hop-limit=equal: 255 icmp-options=136:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 inverse ND solic limit 5,10 only LAN" hop-limit=equal: 255 icmp-options=141:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=accept chain=icmp6 comment="defconf: rfc4890 inverse ND advert limit 5,10 only LAN" hop-limit=equal: 255 icmp-options=142:0-255 in-interface-list=LAN limit=5,10:packet protocol=icmpv6 add action=drop chain=icmp6 comment="defconf: drop other icmp" protocol=icmpv6

Port knocking All available public IP addresses are constantly being port scanned by bots and services like shodan.io and anyone can use this information to perform brute-force attacks and execute any known exploits. Port knocking is a cost-effective way to defend against this by not exposing any ports and simply listening to connection attempts - if the correct sequence of port connection attempts is made, the client is considered safe and added to a list of secured address list that bypass the WAN firewall rules. Setup example We are assuming you have already set up a firewall that drops all connection attempts from the WAN port, so you will need to add additional rules before that. First, create a firewall rule that listens on a given port and adds the connected source IP to an address list - this is the first knock. /ip/firewall/filter add action=add-src-to-address-list address-list=888 address-list-timeout=30s chain=input dst-port=888 in-interface-list=WAN protocol=tcp Then add a rule that does the same on another port, but only approves IPs that are already in the first list. You can repeat this step as many times as you like. /ip/firewall/filter add action=add-src-to-address-list address-list=555 address-list-timeout=30s chain=input dst-port=555 in-interface-list=WAN protocol=tcp src-address-list=888 Finally, the last knock will be added to an IP list that is trusted and any input is accepted. /ip/firewall/filter add action=add-src-to-address-list address-list=secured address-list-timeout=30m chain=input dst-port=222 in-interface-list=WAN protocol=tcp src-address-list=555 /ip/firewall/filter add action=accept chain=input in-interface-list=WAN src-address-list=secured Knock to gain access To access the board from WAN, a port-knocking client could be used, but a simple bash one-liner with nmap can do the job. for x in 888,555,222; do nmap -p $x -Pn xx.xx.xx.xx; done Blacklists Unless you are using a lot of knocks, a simple port scan could accidentally trigger the correct ports in the correct order, so it is advisable to add a blacklist as well. At the very top of your firewall stack add a drop rule for the blacklist. /ip/firewall/filter add action=drop chain=input disabled=yes in-interface-list=WAN src-address-list=blacklist Then add suspicious IPs to the blacklist. Bad ports - ones that will never be used by a trusted user and hence have a high timeout penalty. /ip/firewall/filter add action=add-src-to-address-list address-list=blacklist address-list-timeout=1000m chain=input disabled=yes dst-port=666 in-interface-list=WAN protocol=tcp Ports that slow down the port scanning process significantly to the point where it is pointless, but will never lock out a real user for too long. This could include every single port apart from the 'knock' ports, the key is that the source IP is not already in the secure list and hence those ports can be used after a successful knock.

/ip/firewall/filter add action=add-src-to-address-list address-list=blacklist address-list-timeout=1m chain=input disabled=yes dst-port=21,22,23,8291,10000-60000 in-interface-list=WAN protocol=tcp src-address- list=!secured Use a passphrase for each knock You could go even further by sending a passphrase with each knock. Then create a layer7 regex check that can be requested on the knock rule. /ip firewall layer7-protocol add name=pass regexp="^passphrase/$" /ip firewall filter add action=add-src-to-address-list address-list=888 address-list-timeout=30s chain=input dst-port=888 in-interface-list=WAN protocol=udp layer7- protocol=pass Blacklist rules from this section are added in order to avoid locking out the user. Enable the filter rules, once the alternative access disabled=yes available or use <Safe Mode> Warning Layer7 rules are very resource-intensive. Do not use it unless you know what you are doing. For additional security layer see the Bruteforse prevention article: Bruteforce prevention

Building Your First Firewall Should be deleted

DDoS Protection Introduction A denial-of-service (DoS) or distributed denial-of-service (DDoS) attack is a malicious attempt to disrupt normal traffic of a targeted server, service, or network by overwhelming the target or its surrounding infrastructure with a flood of Internet traffic. There are several types of DDoS attacks, for example, HTTP flood, SYN flood, DNS amplification, etc. Protection against DDoS Configuration lines /ip firewall address-list add list=ddos-attackers add list=ddos-targets /ip firewall filter add action=return chain=detect-ddos dst-limit=32,32,src-and-dst-addresses/10s add action=add-dst-to-address-list address-list=ddos-targets address-list-timeout=10m chain=detect-ddos add action=add-src-to-address-list address-list=ddos-attackers address-list-timeout=10m chain=detect-ddos /ip firewall raw add action=drop chain=prerouting dst-address-list=ddos-targets src-address-list=ddos-attackers Configuration Explained First, we will send every new connection to the specific firewall chain where we will detect DDoS: /ip/firewall/filter/add chain=forward connection-state=new action=jump jump-target=detect-ddos These rules are only an improvement for firewall, do not forget to properly secure your device.

In the newly created chain, we will add the following rule with the "dst-limit" parameter. This parameter is written in the following format : dst-limit= count[ . We will match 32 packets with 32 packet burst based on destination and source address flow, which renews every 10 seconds. /time],burst,mode[/expire] The rule will work until a given rate is exceeded. /ip/firewall/filter/add chain=detect-ddos dst-limit=32,32,src-and-dst-addresses/10s action=return So far all the legitimate traffic should go through the "action=return", but in the case of DoS/DDoS "dst-limit" buffer will be fulfilled and a rule will not "catch" any new traffic. Here come the next rules, which will deal with the attack. Let`s start with creating a list for attackers and victims which we will drop: ip/firewall/address-list/add list=ddos-attackers ip/firewall/address-list/add list=ddos-targets ip/firewall/raw/add chain=prerouting action=drop src-address-list=ddos-attackers dst-address-list=ddos-targets With the firewall filter section, we will add attackers in the "DDoS-attackers" and victims in list "ddos-targets" list: /ip/firewall/filter/ add action=add-dst-to-address-list address-list=ddos-targets address-list-timeout=10m chain=detect-ddos add action=add-src-to-address-list address-list=ddos-attackers address-list-timeout=10m chain=detect-ddos SYN Attack SYN Flood An SYN flood is a form of DoS attack in which an attacker sends a succession of SYN requests to a target's system in an attempt to consume enough server resources to make the system unresponsive to legitimate traffic. Fortunately, in RouterOS we have a specific feature for such an attack: /ip/settings/set tcp-syncookies=yes The feature works by sending back ACK packets that contain a little cryptographic hash, which the responding client will echo back with as part of its SYN- ACK packet. If the kernel doesn't see this "cookie" in the reply packet, it will assume the connection is bogus and drop it. SYN-ACK Flood An SYN-ACK flood is an attack method that involves sending a target server spoofed SYN-ACK packet at a high rate. The server requires significant resources to process such packets out-of-order (not in accordance with the normal SYN, SYN-ACK, ACK TCP three-way handshake mechanism), it can become so busy handling the attack traffic, that it cannot handle legitimate traffic and hence the attackers achieve a DoS/DDoS condition. In RouterOS, we can configure similar rules from the previously mentioned example, but more specifically for SYN-ACK flood: /ip/firewall/filter add action=return chain=detect-ddos dst-limit=32,32,src-and-dst-addresses/10s protocol=tcp tcp-flags=syn,ack

Connection rate Introduction Theory Rule Example Application Example - Traffic Prioritization Quick Start for Impatient Explanation IP Firewall mangle Queue Introduction Connection Rate is a firewall matcher that allows capturing traffic based on the present speed of the connection. Theory Each entry in the connection tracking table represents bidirectional communication. Every time a packet gets associated with a particular entry, the packet size value (including the IP header) is added to the "connection-bytes" value for this entry. (in other words "connection-bytes" includes both - upload and download). Connection Rate calculates the speed of connection based on the change of "connection-bytes". The connection rate is recalculated every second and does not have any averages. Both options "connection-bytes" and "connection-rate" work only with TCP and UDP traffic. (you need to specify a protocol to activate these options). In the "connection-rate" you can specify a range of speed that you like to capture: ConnectionRate ::= [!]From-To From,To ::= 0..4294967295 (integer number) Rule Example These rules will capture TCP/UDP traffic that was going through the router when the connection speed was below 100kbps: /ip firewall filter add action=accept chain=forward connection-rate=0-100k protocol=tcp add action=accept chain=forward connection-rate=0-100k protocol=udp Application Example - Traffic Prioritization Connection-rate can be used in various ways, that still need to be realized, but the most common setup will be to detect and set lower priorities to the "heavy connections" (connections that maintain a fast rate for long periods (such as P2P, HTTP, FTP downloads). By doing this you can prioritize all other traffic that usually includes VoIP and HTTP browsing and online gaming. The method described in this example can be used together with other ways to detect and prioritize traffic. As the connection-rate option does not have any averages we need to determine what will be the margin that identifies "heavy connections". If we assume that a normal HTTP browsing connection is less than 500kB (4Mb) long and VoIP requires no more than 200kbps speed, then every connection that after the first 500kB still has more than 200kbps speed can be assumed as "heavy". (You might have different "connection-bytes" for HTTP browsing and different "connection-rate" for VoIP in your network - so, please, do your own research before applying this example) For this example, let's assume that we have a 6Mbps upload and download connection to ISP.

Quick Start for Impatient /ip firewall mangle add chain=forward action=mark-connection connection-mark=!heavy_traffic_conn new-connection-mark=all_conn add chain=forward action=mark-connection connection-bytes=500000-0 connection-mark=all_conn connection- rate=200k-100M new-connection-mark=heavy_traffic_conn protocol=tcp add chain=forward action=mark-connection connection-bytes=500000-0 connection-mark=all_conn connection- rate=200k-100M new-connection-mark=heavy_traffic_conn protocol=udp add chain=forward action=mark-packet connection-mark=heavy_traffic_conn new-packet-mark=heavy_traffic passthrough=no add chain=forward action=mark-packet connection-mark=all_conn new-packet-mark=other_traffic passthrough=no /queue tree add name=upload parent=public max-limit=6M add name=other_upload parent=upload limit-at=4M max-limit=6M packet-mark=other_traffic priority=1 add name=heavy_upload parent=upload limit-at=2M max-limit=6M packet-mark=heavy_traffic priority=8 add name=download parent=local max-limit=6M add name=other_download parent=download limit-at=4M max-limit=6M packet-mark=other_traffic priority=1 add name=heavy_download parent=download limit-at=2M max-limit=6M packet-mark=heavy_traffic priority=8 Explanation In mangle, we need to separate all connections into two groups, and then mark packets from their 2 groups. As we are talking about client traffic most logical place for marking would be the mangle chain forward. Keep in mind that as soon as a "heavy" connection will have lower priority and queue will hit max-limit - heavy connection will drop speed, and connection- rate will be lower. This will result in a change to a higher priority and the connection will be able to get more traffic for a short while, when again connection- rate will rise and that again will result in a change to lower priority). To avoid this we must make sure that once detected "heavy connections" will remain marked as "heavy connections" for all times. IP Firewall mangle This rule will ensure that that "heavy" connections will remain heavy". and mark the rest of the connections with the default connection mark: /ip firewall mangle add chain=forward action=mark-connection connection-mark=!heavy_traffic_conn new-connection-mark=all_conn These two rules will mark all heavy connections based on our standards, that every connection that after the first 500kB still has more than 200kbps speed can be assumed as "heavy": add chain=forward action=mark-connection connection-bytes=500000-0 \ connection-mark=all_conn connection-rate=200k-100M new-connection-mark=heavy_traffic_conn protocol=tcp add chain=forward action=mark-connection connection-bytes=500000-0 \ connection-mark=all_conn connection-rate=200k-100M new-connection-mark=heavy_traffic_conn protocol=udp The last two rules in mangle will simply mark all traffic from corresponding connections: add chain=forward action=mark-packet connection-mark=heavy_traffic_conn new-packet-mark=heavy_traffic passthrough=no add chain=forward action=mark-packet connection-mark=all_conn new-packet-mark=other_traffic passthrough=no Queue This is a simple queue tree that is placed on the Interface HTB - "public" is an interface where your ISP is connected, and "local" is where are your clients. If you have more than 1 "public" or more than 1 "local" you will need to mangle upload and download separately and place the queue tree in global-out:

/queue tree add name=upload parent=public max-limit=6M add name=other_upload parent=upload limit-at=4M max-limit=6M packet-mark=other_traffic priority=1 add name=heavy_upload parent=upload limit-at=2M max-limit=6M packet-mark=heavy_traffic priority=8 add name=download parent=local max-limit=6M add name=other_download parent=download limit-at=4M max-limit=6M packet-mark=other_traffic priority=1 add name=heavy_download parent=download limit-at=2M max-limit=6M packet-mark=heavy_traffic priority=8

Bruteforce prevention Here is an example of how to defend against bruteforce attacks on an SSH port. Please note, that ssh allows 3 login attempts per connection, and the address lists are not cleared upon a successful login, so it is possible to blacklist yourself accidentally. /ip firewall filter add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=1d chain=input comment=Blacklist connection-state= new dst-port= 22 protocol=tcp src-address-list=connection3 add action=add-src-to-address-list address-list=connection3 address-list-timeout=1h chain=input comment= "Third attempt" connection-state= new dst-port= 22 protocol=tcp src-address-list=connection2 add action=add-src-to-address-list address-list=connection2 address-list-timeout=15m chain=input comment= "Second attempt" connection-state= new dst-port= 22 protocol=tcp src-address-list=connection1 add action=add-src-to-address-list address-list=connection1 address-list-timeout=5m chain=input comment= "First attempt" connection-state= new dst-port= 22 protocol=tcp add action=accept chain=input dst-port= 22 protocol=tcp src-address-list=!bruteforce_blacklist If the timeouts were kept at 1min for all three lists - connection1/2/3 - then someone could perform 9 guesses every minute, with the above structure they can do a maximum of 3 guesses per 5min. Address list naming is following the naming of the article. Similar naming scheme is used, trusted address list is named as Port knocking "secured".

Kid Control Summary Property Description Devices Application example Summary Sub-menu: /ip kid-control "Kid control" is a parental control feature to limit internet connectivity for LAN devices. Property Description In this menu, it is possible to create a profile for each Kid and restrict internet accessibility. Property Description name ( ) string Name of the Kid's profile mon,tue,wed,thu,fri,sat,sun ( )time Each day of the week. Time of day, when internet access should be allowed disabled ( ) yes | no Whether restrictions are enabled rate-limit ( ) string The maximum available data rate for flow tur-mon,tur-tue,tur-wed,tur-thu,tur-fri,tur-sat,tur-sun ( )time Time unlimited rate. Time of day, when internet access should be unlimited Time unlimited rate parameters have higher priority than rate-limit parameter. Devices Sub-menu: /ip kid-control device This sub-menu contains information if there are multiple connected devices to the internet (phone, tablet, gaming console, tv etc.). The device is identified by the MAC address that is retrieved from the ARP table. The appropriate IP address is taken from there. Property Description name ( ) string Name of the device mac-address ( ) string Devices mac-address user ( ) string To which profile append the device reset-counters ( ) [id, name] Reset bytes-up and bytes-down counters. Application example With the following example we will restrict access for Peter's mobile phone: Disabled internet access on Monday, Wednesday and Friday Allowed unlimited internet access on: Tuesday Thursday from 11:00-22:00 Sunday 15:00-22:00 Limited bandwidth to 3Mbps for Peter's mobile phone on Saturday from 18:30-21:00

interface ( ; Default: ) string Interface name on which uPnP will be running type ( ; Default: ) external | internal no UPnP interface type: external - the interface a global IP address is assigned to internal - router's local interface the clients are connected to forced-external-ip (; Default: )Ip Allow specifying what public IP to use if the external interface has more than one IP available. Configuration Example In more complex setups with VLANs, where the VLAN interface is considered as the LAN interface, the VLAN interface itself should be specified as the internal interface for UPnP to work properly.

NAT-PMP Introduction NAT Port Mapping Protocol (NAT-PMP) is a protocol used for transparent peer-to-peer network connectivity of personal computers and network-enabled intelligent devices or appliances. Protocol operates by retrieving the external IPv4 address of a NAT gateway, thus allowing a client to make its external IPv4 address and port known to peers who may wish to communicate with it by creating dynamic NAT rules. NAT-PMP uses UDP port number 5350 - on the client, and 5351 on the server side. There are two interface types for PMP: (the one local clients are connected to) and (the one the Internet is connected to).A router may internal external only have one active external interface with a 'public' IP address on it For more details on NAT PMP see RFC 6886 NAT-PMP configuration is accessible from menu. /ip nat-pmp Configuration Example A router can have only one active interface with a 'public' IP address on it. NAT-PMP interface can create NAT mapping for any external internal subnet, not just the subnet present on the internal interface, so caution must be used when setting interfaces. internal

Let's consider that we already have this basic home setup illustrated above. Before enabling PMP-NAT we need to masquerade outgoing LAN packets. /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 Now we can enable PMP and add internal, external interfaces: /ip nat-pmp set enable=yes /ip nat-pmp interfaces> add interface=ether1 type=external disabled=no /ip nat-pmp interfaces> add interface=ether2 type=internal disabled=no When the client from the internal interface side sends PMP request, dynamic NAT rules are created on the router:

High Availability Solutions In This Section:

Load Balancing Failover (WAN Backup) OSPF Load Balancing (restricted) Per connection classifier Introduction Network load balancing is the ability to balance traffic across two or more links without using dynamic routing protocols. There are two type of balancing methods: per-packet - each packet of a single stream can be forwarded over different links. This method will work reliably especially on TCP and secure connections only when you are able to control both balancing endpoints. per-connection - all packets of the same connection (stream) is always sent over one link. This method is mandatory in setups where only one end of the balancing is under our control, for example, home router with multiple WAN connections. Method Per-connection Per-packet Firewall MangleNth Yes Yes PCC (Per Connection Classifier)Yes No Other matchers Yes Yes ECMP (Equal Cost Multi-Path) Yes No Bonding No Yes OSPF Yes No BGP Yes No Simple Failover Example Simplest failover setup would be to use multiple gateways when one gateway is active and another one takes over when the first one fails. To make this work, configure larger value for the secondary one, and for the first one: distance check-gateway /ip route add gateway=192.168.1.1 distance=1 check-gateway=ping /ip route add gateway=192.168.2.1 distance=2 The will make sure the gateway is up only when actual traffic can reach the gateway. When the ping fails the first gateway will become check-gateway inactive and the second one will take over, and when the first gateway recovers it will become active and make the second gateway to work again as a backup.

Failover (WAN Backup) Introduction In this article, we will look at another advanced method of failover using recursive routing and scopes from the routing section. Recursive routing occurs when a route (either static or dynamically learned) has a next-hop that is not directly connected to the local router. It is necessary to restrict a set of routes that can be used to look up immediate next-hops. Nexthop values of RIP or OSPF routes, for example, are supposed to be directly reachable and should be looked up only using connected routes. This is achieved using a scope and target-scope properties. Setup Overview Let's assume that our gateway has two public network uplinks ("ISP1", "ISP2"). First uplink should be preferred and second one should act as a backup. Then we mark traffic in two parts, one with the name "ISP1" and the second as "ISP2" which goes through the ether1 and ether2 accordingly. In this setup, we want to monitor two hosts: Host1 and Host2. We will use Google DNS servers with IP 8.8.8.8 (Host1) and 8.8.4.4 (Host2), but it is not mandatory to use specifically these addresses. Configuration Basic failover First things first, since we have a local address space we need to masquerade LAN traffic on both uplinks: /ip/firewall/nat add chain=srcnat action=masquerade out-interface=ether1 add chain=srcnat action=masquerade out-interface=ether2 Next we want to pick tow hosts on the internet and make them reachable each on its own uplink. Generally you would pick hosts that are always supposed to be reachable, accepts ICMP, in this example we will use google DNS servers (8.8.8.8 and 8.8.4.4). /ip/route/ add dst-address=8.8.8.8 scope=10 gateway=10.111.0.1 add dst-address=8.8.4.4 scope=10 gateway=10.112.0.1 And add default routes recursively resolved over both hosts with ISP1 being the primary one (by having smaller distance):

/ip/route/ add distance=1 gateway=8.8.8.8 target-scope=11 check-gateway=ping add distance=2 gateway=8.8.4.4 target-scope=11 check-gateway=ping Improve detection reliability At this point we are relying link reachability on a single host. Even though google services are very rarely down we can still improve reliability by adding a second host on each link. /ip/route add dst-address=208.67.222.222 gateway=10.111.0.1 scope=10 add dst-address=208.67.220.220 gateway=10.112.0.1 scope=10 add distance=1 gateway=208.67.222.222 target-scope=11 check-gateway=ping add distance=2 gateway=208.67.220.220 target-scope=11 check-gateway=ping Essentially what it does is creates ECMP default route and if only one of the gateways is not reachable default route on the first link will still be active. Complete switchover to second link will happen only if all the gateways become unreachable.

OSPF Load Balancing (restricted)

Per connection classifier PCC matcher will allow you to divide traffic into equal streams with the ability to keep packets with specific set of options in one particular stream (you can specify this set of options from src-address, src-port, dst-address, dst-port) Theory Example How PCC works Configuration Example IP Addresses Policy routing NAT Theory PCC takes selected fields from IP header, and with the help of a hashing algorithm converts selected fields into 32-bit value. This value then is divided by a specified Denominator and the remainder then is compared to a specified Remainder , if equal then the packet will be captured. You can choose from src- address, dst-address, src-port, dst-port from the header to use in this operation. per-connection-classifier= PerConnectionClassifier ::= [!]ValuesToHash:Denominator/Remainder Remainder ::= 0..4294967295 (integer number) Denominator ::= 1..4294967295 (integer number) ValuesToHash ::= both-addresses|both-ports|dst-address-and-port| src-address|src-port|both-addresses-and-ports|dst-address|dst-port|src-address-and-port Example This configuration will divide all connections into 3 groups based on the source address and port /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=1st_conn per-connection-classifier=src-address-and-port:3/0 /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=2nd_conn per-connection-classifier=src-address-and-port:3/1 /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=3rd_conn per-connection-classifier=src-address-and-port:3/2 How PCC works This article aims to explain in simple terms how PCC works. The definition from the official manual wiki page reads: "PCC takes selected fields from IP header, and with the help of a hashing algorithm converts selected fields into 32-bit value. This value then is divided by a specified Denominator and the remainder then is compared to a specified Remainder, if equal then packet will be captured. You can choose from src-address, dst-address, src-port, dst- port from the header to use in this operation.", with the full number of fields available being: "both-addresses|both-ports|dst-address-and-port|src- address|src-port|both-addresses-and-ports|dst-address|dst-port|src-address-and-port". If you understand that definition, there'll be nothing interesting in this article for you. First, here are the terms necessary to understand the definition. IP packets have a header that contains several fields, two of those fields are the IP address of the source of the packet and the IP address of the destination of the packet. TCP and UDP packets also have headers that contain the source port and the destination port. Denominators and remainders are parts of modulus operations. A modulus operation produces the integer left over when you divide two numbers and only accept the whole number portion of the result. It is represented by a % sign. Here are some examples: 3 % 3 = 0, because 3 divides cleanly by 3. 4 % 3 = 1, because the next smallest number to 4 that cleanly divides by 3 is 3, and 4 - 3 = 1. 5 % 3 is 2, because the next smallest number to 5 that divides cleanly by 3 is 3, and 5 - 3 = 2. 6 % 3 = 0, because 6 divides cleanly by 3. PCC is not a valid method, in case of Hotspot(captive portal) - due to the fact that Hotspot uses web-proxy and it uses only the default routing table, at the moment.

A hash is a function that is fed input, and produces output. Hashes have many interesting properties, but the only important one for the purpose of this article is that hash functions are deterministic. That means that when you feed a hash function an input that reads 'hello' and it produces the output '1', you can rely on the fact that if you feed it 'hello' a second time it will produce the output '1' again. When you feed a hash function the same input, it will always produce the same output. What exact hashing algorithm is used by PCC is not important, so for this discussion let's assume that when you feed it IP addresses and ports, it just adds up the octets of the IP addresses as decimal numbers as well as the ports, and then takes the last digit and produces it as the output. Here an example: The hash function is fed 1.1.1.1 as the source IP address, 10000 as the source TCP port, 2.2.2.2 as the destination IP address and 80 as the destination TCP port. The output will be 1+1+1+1+10000+2+2+2+2+80 = 10092, the last digit of that is 2, so the hash output is 2. It will produce 2 every time it is fed that combination of IP addresses and ports. At this point it's important to note that even though PCC is most often used for spreading load across circuits, PCC itself has absolutely nothing to do with routing, routing marks or spreading load. PCC is simply a way to match packets, and not directly related to the action of then marking those matched packets even if that is its main purpose. Here are three lines often used for PCC, with their explanation: /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=1st_conn per-connection-classifier=src-address-and-port:3/0 /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=2nd_conn per-connection-classifier=src-address-and-port:3/1 /ip firewall mangle add chain=prerouting action=mark-connection \ new-connection-mark=3rd_conn per-connection-classifier=src-address-and-port:3/2 Here are what the different field options mean for the purpose of packet matching, these are the fields that will be fed into the hashing algorithm (and, for the purpose of spreading load across links, decide what link a packet will be put on). Remember that a hash function will always produce the same input when it's fed the same output: src-address: The source address of a client will always be the same, so all traffic from a particular client will always match the same PCC matcher, and will always be put on the same link. dst-address: The destination address of a specific server will always be the same, so all traffic to that server (say, the Mikrotik Wiki) will always match the same PCC matcher, and will always be put on the same link. both-addresses: The source and destination IP pair between the same client and server will always be the same, so all traffic between one specific client and a specific server (say, your laptop and the Mikrotik Wiki) will always match the same PCC matcher, and will always be put on the same link. src-port: Source ports of clients are usually randomly chosen when the connection is created, so across many connections different source ports will be fed into the hash function, and different PCC matchers will match and traffic will go across different links. However, some client protocols always choose the same source port, and servers behind your router will mostly likely always use the same service port to send traffic back to their clients. A web server behind your router would send most traffic from its HTTP (80) and HTTPS (443) ports, and that traffic would always match the same PCC matcher and would be put on the same link. dst-port: Destination ports of clients are usually well defined service ports, all HTTP (80) traffic between your clients and servers on the Internet would always match the same PCC matcher, and would be put on the same link. However, the same clients doing HTTPS (443) traffic could match a different PCC matcher, and would go across a different link. both-ports: Since the client port is (usually) randomly chosen, the combination of the two ports is (usually) random and will spread load across links. src-address-and-port: Same caveat as src-port. dst-address-and-port: Same caveat as dst-port. both-addresses-and-ports: This is the most random way to spread traffic across links, since it has the most number of variables. It's important to note that even though the hash function discussed in this article is greatly simplified and not what is used in real life, it nicely demonstrates another property of hash functions: two completely different inputs can produce the same output. In our example, 3 % 3 = 0, and 6 % 3 = 0; we get back 0 when we feed it a 3 as well as when we feed it a 6. The same is true for the actual function used for PCC, even though I don't know what it is we do know from the definition that it produces a 32 bit value as output. IP addresses are 32 bit, and ports are 16 bit, so assuming that we're using both-addresses-and- ports, we'd be feeding it 32+32+16+16 = 96 bits of input and would only receive 32 bits back, so it must be producing the same output for different inputs. This means that two completely unrelated connections could match the same PCC matcher, and would be put on the same line. PCC works better the more connections you put across it so that the hash function has more chances to produce different outputs. Configuration Example Let's assume this configuration:

IP Addresses /ip address add address=10.10.4.100/24 interface=ether_ISP1 network=10.10.4.0 add address=10.10.5.100/24 interface=ether_ISP2 network=10.10.5.0 add address=192.168.100.1/24 interface=ether_LAN network=192.168.100.0 The router has two upstream (ISP) interfaces with the addresses of 10.10.4.100/24 and 10.10.5.100/24. The LAN interface has IP address of 192.168.0.1 /24. We are adding two new Routing tables, which will be used later: /routing table add disabled=no fib name=ISP1_table add disabled=no fib name=ISP2_table Policy routing /ip firewall mangle add action=accept chain=prerouting dst-address=10.10.4.0/24 in-interface=ether_LAN add action=accept chain=prerouting dst-address=10.10.5.0/24 in-interface=ether_LAN With policy routing it is possible to force all traffic to the specific gateway, even if traffic is destined to the host (other that gateway) from the connected networks. This way routing loop will be generated and communications with those hosts will be impossible. To avoid this situation we need to allow usage of default routing table for traffic to connected networks.

add action=mark-connection chain=input connection-state=new in-interface=ether_ISP1 new-connection-mark=ISP1 add action=mark-connection chain=input connection-state=new in-interface=ether_ISP2 new-connection-mark=ISP2 add action=mark-connection chain=output connection-mark=no-mark connection-state=new new-connection-mark=ISP1 passthrough=yes per-connection-classifier=both-addresses:2/0 add action=mark-connection chain=output connection-mark=no-mark connection-state=new new-connection-mark=ISP2 per-connection-classifier=both-addresses:2/1 First it is necessary to manage connection initiated from outside - replies must leave via same interface (from same Public IP) request came. We will mark all new incoming connections, to remember what was the interface. add action=mark-connection chain=prerouting connection-mark=no-mark connection-state=new dst-address-type=! local in-interface=ether_LAN new-connection-mark=ISP1 per-connection-classifier=both-addresses:2/0 add action=mark-connection chain=prerouting connection-mark=no-mark connection-state=new dst-address-type=! local in-interface=ether_LAN new-connection-mark=ISP2 per-connection-classifier=both-addresses:2/1 Action mark-routing can be used only in mangle chain output and prerouting, but mangle chain prerouting is capturing all traffic that is going to the router itself. To avoid this we will use dst-address-type=!local. And with the help of the new PCC we will divide traffic into two groups based on source and destination addressees. add action=mark-routing chain=output connection-mark=ISP1 new-routing-mark=ISP1_table add action=mark-routing chain=prerouting connection-mark=ISP1 in-interface=ether_LAN new-routing-mark=ISP1_table add action=mark-routing chain=output connection-mark=ISP2 new-routing-mark=ISP2_table add action=mark-routing chain=prerouting connection-mark=ISP2 in-interface=ether_LAN new-routing-mark=ISP2_table Then we need to mark all packets from those connections with a proper mark. As policy routing is required only for traffic going to the Internet, do not forget to specify in-interface option. /ip route add check-gateway=ping disabled=no dst-address=0.0.0.0/0 gateway=10.10.4.1 routing-table=ISP1_table suppress-hw- offload=no add check-gateway=ping disabled=no dst-address=0.0.0.0/0 gateway=10.10.5.1 routing-table=ISP2_table suppress-hw- offload=no Create a route for each routing-mark add distance=1 dst-address=0.0.0.0/0 gateway=10.10.4.1 add distance=2 dst-address=0.0.0.0/0 gateway=10.10.5.1 To enable failover, it is necessary to have routes that will jump in as soon as others will become inactive on gateway failure. (and that will happen only if check-gateway option is active) NAT /ip firewall nat add action=masquerade chain=srcnat out-interface=ether_ISP1 add action=masquerade chain=srcnat out-interface=ether_ISP2 As routing decision is already made we just need rules that will fix src-addresses for all outgoing packets. If this packet will leave via ether_ISP1 it will be NATed to 10.10.4.100, if via ether_ISP2 then NATed to 10.10.5.100

1. 2. 3. 4. Bonding Summary Quick Setup Guide Link monitoring ARP Monitoring MII monitoring Bonding modes 802.3ad balance-xor balance-rr active-backup broadcast balance-tlb Configuration example balance-alb Bonding monitoring Property Description See also Summary Bonding is a technology that allows aggregation of multiple ethernet-like interfaces into a single virtual link, thus getting higher data rates and providing failover. Quick Setup Guide Let us assume that we have two Ethernet interfaces on each router (Router1 and Router2) and want to get the maximum data rate between these two routers. To make this possible, follow these steps: Make sure that you do not have IP addresses on interfaces that will be enslaved for bonding interface. Add bonding interface and IP address on the Router1: /interface bonding add slaves=ether1,ether2 name=bond1 /ip address add address=172.16.0.1/24 interface=bond1 Do the same thing on the Router2: /interface bonding add slaves=ether1,ether2 name=bond1 /ip address add address=172.16.0.2/24 interface=bond1 Test the link from Router1: Interface bonding does not create an interface with a larger link speed. Interface bonding creates a virtual interface that can load balance traffic over multiple interfaces. More details can be found in the page. LAG interfaces and load balancing CRS3xx, CRS5xx series switches, CCR2116, CCR2216 routers and 88E6393X, 88E6191X, 88E6190 switch chips support bridge hardware offloading with bonding interfaces. Only 802.3ad and balance-xor bonding modes are hardware offloaded, other bonding modes will use the CPU's resources. T he built-in switch chip will always use Layer2+Layer3+Layer4 for a transmit hash policy, changing the transmit hash policy manually will have no effect. See more details on . CRS3xx, CRS5xx, CCR2116, CCR2216 switch chip features

MII monitoring MII monitoring monitors only the state of the local interface. - a device driver determines whether a link is up or down. If the device driver does MII Type 1 not support this option then the link will appear as always up. The main disadvantage is that MII monitoring can't tell if the link can actually pass packets or not, even if the link is detected as being up. MII monitoring is configured by setting the variables - link-monitoring and mii-interval. To enable MII Type1 monitoring on Router1 and Router2: /interface bonding set [find name=bond1] link-monitoring=mii We will leave mii-interval to its default value (100ms). When unplugging one of the cables, the failure will be detected almost instantly compared to ARP link monitoring. Bonding modes 802.3ad 802.3ad mode is an IEEE standard also called LACP (Link Aggregation Control Protocol). It includes automatic configuration of the aggregates, so minimal configuration of the switch is needed. This standard also mandates that frames will be delivered in order and connections should not see misordering of packets. The standard also mandates that all devices in the aggregate must operate at the same speed and duplex mode. LACP balances outgoing traffic across the active ports based on hashed protocol header information and accepts incoming traffic from any active port. The hash includes the Ethernet source and destination address and if available, the VLAN tag, and the IPv4/IPv6 source and destination address. How this is calculated depends on transmit-hash-policy parameter. The ARP link monitoring is not recommended, because the ARP replies might arrive only on one slave port due to transmit hash policy on the LACP peer device. This can result in unbalanced transmitted traffic, so MII link monitoring is the recommended option. balance-xor This mode balances outgoing traffic across the active ports based on the hashed protocol header information and accepts incoming traffic from any active port. The mode is very similar to except that it is not standardized and works with hash policy. The mode can work together with LACP layer-3-and-4 static Link Aggregation Group (LAG) interfaces. balance-rr If this mode is set, packets are transmitted in sequential order from the first available slave to the last. The balance-rr is the only mode that will send packets across multiple interfaces that belong to the same TCP/IP connection. When utilizing multiple sending and multiple receiving links, packets are often received out of order, which results in segment retransmission, for other protocols such as UDP it is not a problem if a client software can tolerate out- of-order packets. If a switch is used to aggregate links together, then appropriate switch port configuration is required, however many switches do not support balance-rr. demonstrates the usage of the balance-rr bonding mode. As you can see, it is quite simple to set up. Balance-rr is Quick setup guide also useful for bonding several wireless links, however, it requires equal bandwidth for all bonded links. If the bandwidth of one bonded link drops, then the total bandwidth of bond will be equal to the bandwidth of the slowest bonded link. active-backup This mode uses only one active slave to transmit packets. The additional slave only becomes active if the primary slave fails. The MAC address of the bonding interface is presented onto the active port to avoid confusing the switch. Active-backup is the best choice in high availability setups with multiple switches that are interconnected. When ARP monitoring is used, bonding slaves will send out ARP requests without a VLAN tag, even if an IP address is set on a VLAN interface in the same subnet as the arp-ip-targets The layer-3-and-4 transmit hash mode is not fully compatible with LACP. More details can be found in https://www.kernel.org/doc/Documentation /networking/bonding.txt

broadcast When ports are configured with broadcast mode, all slave ports transmit the same packets to the destination to provide fault tolerance. This mode does not provide load balancing. balance-tlb This mode balances outgoing traffic by peer. Each link can be a different speed and duplex mode and no specific switch configuration is required as for the other modes. The downside of this mode is that only MII link monitoring is supported (ARP link monitoring is ignored when configured) and incoming traffic is not balanced. Incoming traffic will use the link that is configured as "primary". Configuration example Let's assume that the router has two links - max bandwidth is 10Mbps and max bandwidth is 5Mbps. The first link has more bandwidth so we ether1 ether2 set it as a primary link: /interface bonding add mode=balance-tlb slaves=ether1,ether2 primary=ether1 No additional configuration is required for the switch. The image above illustrates how balance-tlb mode works. As you can see router can communicate to all the clients connected to the switch with a total bandwidth of both links (15Mbps). But as you already know, balance-tlb is not balancing incoming traffic. In our example, clients can communicate to the router with a total bandwidth of primary link which is 10Mbps in our configuration. balance-alb The ARP monitoring in this mode will not work correctly if both routers are directly connected. In such setups, MIImonitoring must be used or a switch should be put between routers.

The mode is basically the same as balance-tlb but incoming IPv4 traffic is also balanced. The receive load balancing is achieved by ARP negotiation. The bonding driver intercepts locally generated ARP messages on their way out and overwrites the source hardware address with the unique address of one of the slaves in the bond such that different peers use different hardware addresses. Only MII link monitoring is supported (ARP link monitoring is ignored when configured), the additional downside of this mode is that it requires device driver capability to change MAC address. The mode is not compatible with l setting. ocal-proxy-arp The image above illustrates how balance-alb mode works. Compared to balance-tlb mode, traffic from clients can also use the secondary link to communicate with the router. Bonding monitoring Since RouterOS 6.48 version, it is possible to monitor the bonding interface and bonding ports. For the bonding mode, more detailed monitoring 802.3ad options are available. /interface bonding monitor [find] mode: 802.3ad active-backup active-ports: ether4 ether6 ether5 inactive-ports: ether7 lacp-system-id: CC:2D:E0:11:22:33 lacp-system-priority: 65535 lacp-partner-system-id: B8:69:F4:44:55:66 Property Description mode (802.3ad | active-backup | balance-alb | balance-rr | balance-tlb | balance-xor | ) broadcastUsed bonding mode active-ports ( ) interface Shows the active bonding ports inactive-ports ( ) interface Shows the inactive bonding ports (e.g. a disabled or backup interface) lacp-system-id ( ) MAC address Shows the local LACP system ID

lacp-system-priority ( ) integer Shows the local LACP priority lacp-partner-system-id ( ) MAC address Shows the partner LACP system ID To monitor individual bonding ports, use a command. monitor-slaves /interface bonding monitor-slaves bond1 Flags: A - active, P - partner AP port=ether4 key=17 flags="A-GSCD--" partner-sys-id=D4:CA:6D:12:06:65 partner-sys-priority=65535 partner- key=9 partner-flags="A-GSCD--" AP port=ether5 key=17 flags="A-GSCD--" partner-sys-id=D4:CA:6D:12:06:65 partner-sys-priority=65535 partner- key=9 partner-flags="A-GSCD--" Property Description port( ) interface Used bonding port key( ) integer Shows the local LACP aggregation key. The lower 6 bits are automatically assigned based on individual port link speed and duplex. The upper 10 bits can be manually specified using the setting (available only since RouterOS v7.3). lacp-user-key flags ( ) string Shows the local LACP flags: A - activity (link is active, otherwise passive) T - timeout (link is using short 1-second timeout, otherwise using 30-second timeout) G - aggregation (link can be aggregatable) S - synchronization (link is synchronized) C - collecting (link is able to collect incoming frames) D - distributing (link is able to distribute outgoing frames) F - defaulted (link is using defaulted partner information, indicated that no LACPDU has been received from the partner) E - expired (link has expired state) partner-sys-id ( ) MAC addressShows the partner LACP system ID partner-sys- priority (integer )Shows the partner LACP priority partner-key (in ) tegerShows the partner LACP aggregation key partner-flags ( ) stringShows the partner LACP flags Property Description This section describes the available bonding settings. Property Description arp (disabled | enabled ; | proxy-arp | reply-only Default: ) enabledAddress Resolution Protocol for the interface. disabled - the interface will not use ARP enabled - the interface will use ARP proxy-arp - the interface will use the ARP proxy feature reply-only - the interface will only reply to requests originated from matching IP address/MAC address combinations which are entered as static entries in the "/ip arp" table. No dynamic entries will be automatically stored in the "/ip arp" table. Therefore for communications to be successful, a valid static entry must already exist. arp-interval ( ; time Default: ) 00:00:00.100Time in milliseconds defines how often to monitor ARP requests

arp-ip-targets (IP ; Default: ) addressIP target address which will be monitored if link-monitoring is set to arp. You can specify multiple IP addresses, separated by a comma comment ( ; string Default: )Short description of the interface disabled ( ; yes | no Default: ) noChanges whether the bonding interface is disabled down-delay ( ; time Default: ) 00:00:00If a link failure has been detected, the bonding interface is disabled for down-delay time. The value should be a multiple of mi a i-interval, otherwise, it will be rounded down to the nearest value. This property only has an effect when is link-monitoring set to .mii forced-mac-address (M ; Default: AC address n )oneBy default, the bonding interface will use the MAC address of the first selected slave interface. This property allows to configure static MAC address for the bond interface (all zeros, broadcast or multicast addresses will not apply). RouterOS will automatically change the MAC address for slave interfaces and it will be visible in configuration /interface ethernet export lacp-rate (1sec | ; Default: 30secs 30secs )Link Aggregation Control Protocol rate specifies how often to exchange with LACPDUs between bonding peers. Used to determine whether a link is up or other changes have occurred in the network. LACP tries to adapt to these changes providing failover. lacp-user-key (integer: ; Default: ) 0..1023 0Specifies the upper 10 bits of the port key. The lower 6 bits are automatically assigned based on individual port link speed and duplex. The setting is available only since RouterOS v7.3. link-monitoring (arp | ; Default: ) mii | none miiMethod to use for monitoring the link (whether it is up or down) arp- uses Address Resolution Protocol to determine whether the remote interface is reachable mii- uses Media Independent Interface to determine link status. Link status determination relies on the device driver. none - no method for link monitoring is used. some bonding modes require specific link monitoring to work properly. Note: min-links (integer: 0.. ; Default: ) 4294967295 0How many active slave links needed for bonding to become active mii-interval ( ; time Default: ) 00:00:00.100How often to monitor the link for failures (the parameter used only if link-monitoring is mii) mlag-id (integer: 0.. ) 4294967295 ; Default:Changes MLAG ID for bonding interface. The same MLAG ID should be used on both peer devices to successfully create a single MLAG. See more details on . MLAG mode (802.3ad | active-backup | balance-alb | balance- rr | balance-tlb | balance-xor | broadcast ; Default: ) balance-rrSpecifies one of the bonding policies 802.3ad - IEEE 802.3ad dynamic link aggregation. In this mode, the interfaces are aggregated in a group where each slave shares the same speed. It provides fault tolerance and load balancing. Slave selection for outgoing traffic is done according to the transmit-hash-policy more> active-backup - provides link backup. Only one slave can be active at a time. Another slave only becomes active, if the first one fails. more> balance-alb - adaptive load balancing. The same as balance-tlb but received traffic is also balanced. The device driver should have support for changing it's MAC address. more> balance-rr - round-robin load balancing. Slaves in a bonding interface will transmit and receive data in sequential order. It provides load balancing and fault tolerance. more> balance-tlb - Outgoing traffic is distributed according to the current load on each slave. Incoming traffic is not balanced and is received by the current slave. If receiving slave fails, then another slave takes the MAC address of the failed slave. more> balance-xor - Transmit based on the selected transmit-hash-policy. This mode provides load balancing and fault tolerance. more> broadcast - Broadcasts the same data on all interfaces at once. This provides fault tolerance but slows down traffic throughput on some slow machines. more> mtu ( ; Default: integer 1 )500Maximum Transmit Unit in bytes. Must be smaller or equal to the smallest L2MTU value of a bonding slave. L2MTU of a bonding interface is determined by the lowest L2MTU value among its slave interfaces name ( ; Default: ) string Name of the bonding interface

primary ( ; string Default: ) noneControls the primary interface between active slave ports, works only for active-backup, balance-tlb and balance-alb modes. For active-backup mode, it controls which running interface is supposed to send and receive the traffic. For balance-tlb mode, it controls which running interface is supposed to receive all the traffic, but for balance-alb mode, it controls which interface is supposed to receive the unbalanced traffic (the non-IPv4 traffic). When none of the interfaces are selected as primary, device will automatically select the interface that is configured as the first one. slaves ( ; Default: string ) noneAt least two ethernet-like interfaces separated by a comma, which will be used for bonding up-delay ( ; Default:time ) 00:00:00If a link has been brought up, the bonding interface is disabled for up-delay time and after this time it is enabled. The value should be a multiple of mii-interval , otherwise, it will be rounded down to the nearest value. This property only has an effect when is set to . link-monitoring mii transmit-hash-policy (e ncap-2-and-3 | encap- 3-and-4 | ayer-2 | layer- 2-and-3 | layer-3-and-4 ; Default: ) layer-2Selects the transmit hash policy to use for slave selection in balance-xor and 802.3ad modes encap-2-and-3 - This policy works like the layer-2-and-3 method for distributing traffic, but uses a process to also analyze the encapsulated packet headers. If an encapsulation protocol (like tunneling) is used, it may select the inner headers instead of the outer ones. RouterOS can use this feature when tunnels like 6to4, GRE, GRE6, IPIP, IPIP6, PPPoE, or PPTP are run over a bonding interface. encap-3-and-4 - This policy works like the layer-3-and-4 method for distributing traffic, but uses a process to also analyze the encapsulated packet headers. If an encapsulation protocol (like tunneling) is used, it may select the inner headers instead of the outer ones. RouterOS can use this feature when tunnels like 6to4, GRE, GRE6, IPIP, IPIP6, PPPoE, or PPTP are run over a bonding interface. layer-2 - Uses XOR of hardware MAC addresses to generate the hash. This algorithm will place all traffic to a particular network peer on the same slave. This algorithm is 802.3ad compliant. layer-2-and-3 - This policy uses a combination of layer2 and layer3 protocol information to generate the hash. Uses XOR of hardware MAC addresses and IP addresses to generate the hash. This algorithm will place all traffic to a particular network peer on the same slave. For non-IP traffic, the formula is the same as for the layer2 transmit hash policy. This policy is intended to provide a more balanced distribution of traffic than layer2 alone, especially in environments where a layer3 gateway device is required to reach most destinations. This algorithm is 802.3ad compliant. layer-3-and-4 - This policy uses upper layer protocol information, when available, to generate the hash. This allows for traffic to a particular network peer to span multiple slaves, although a single connection will not span multiple slaves. For fragmented TCP or UDP packets and all other IP protocol traffic, the source and destination port information is omitted. For non-IP traffic, the formula is the same as for the layer2 transmit hash policy. This algorithm is not fully 802.3ad compliant. See also Bonding presentation at the MUM Bonding Examples

Bonding Examples Bonding EoIP tunnels over two wireless links Network Diagram Configuration Test the configuration Link Monitoring Bonding EoIP tunnels over two wireless links This is an example of aggregating multiple network interfaces into a single pipe. In particular, it is shown how to aggregate multiple virtual (EoIP) interfaces to get maximum throughput (MT) with emphasis on availability. Network Diagram Two routers R1 and R2 are interconnected via wireless links. Wireless interfaces on both sides have assigned IP addresses. Configuration Bonding could be used only on OSI layer 2 (Ethernet level) connections. Thus we need to create EoIP interfaces on each of the wireless links. This is done as follows: on router R1: /interface eoip add remote-address=10.0.1.1/24 tunnel-id=1 /interface eoip add remote-address=10.2.2.1/24 tunnel-id=2 and on router R2:

/interface eoip add remote-address=10.0.1.2/24 tunnel-id=1 /interface eoip add remote-address=10.2.2.2/24 tunnel-id=2 The second step is to add a bonding interface and specify EoIP interfaces as slaves: R1: /interface bonding add slaves=eoip-tunnel1,eoip-tunnel2 mode=balance-rr R2: /interface bonding add slaves=eoip-tunnel1,eoip-tunnel2 mode=balance-rr The last step is to add IP addresses to the bonding interfaces: R1: /ip address add address 192.168.0.1/24 interface=bonding1 R2: /ip address add address 192.168.0.2/24 interface=bonding1 Test the configuration Now two routers are able to reach each other using addresses from the 192.168.0.0/24 network. To verify bonding interface functionality, do the following: R1: /interface monitor-traffic eoip-tunnel1,eoip-tunnel2 R2: /tool bandwidth-test 192.168.0.1 direction=transmit You should see that traffic is distributed equally across both EoIP interfaces:

/int monitor-traffic eoip-tunnel1,eoip-tunnel2 received-packets-per-second: 685 685 received-bits-per-second: 8.0Mbps 8.0Mbps sent-packets-per-second: 21 20 sent-bits-per-second: 11.9kbps 11.0kbps received-packets-per-second: 898 899 received-bits-per-second: 10.6Mbps 10.6Mbps sent-packets-per-second: 20 21 sent-bits-per-second: 11.0kbps 11.9kbps received-packets-per-second: 975 975 received-bits-per-second: 11.5Mbps 11.5Mbps sent-packets-per-second: 22 22 sent-bits-per-second: 12.4kbps 12.3kbps received-packets-per-second: 980 980 received-bits-per-second: 11.6Mbps 11.6Mbps sent-packets-per-second: 21 21 sent-bits-per-second: 11.9kbps 11.8kbps received-packets-per-second: 977 977 received-bits-per-second: 11.6Mbps 11.5Mbps sent-packets-per-second: 21 21 sent-bits-per-second: 11.9kbps 11.8kbps -- [Q quit|D dump|C-z pause] Link Monitoring It is easy to notice that with the configuration above as soon as any individual link fails, the bonding interface throughput collapses. That's because no link monitoring is performed, consequently, the bonding driver is unaware of problems with the underlying links. Enabling link monitoring is a must in most bonding configurations. To enable ARP link monitoring, do the following: R1: /interface bonding set bonding1 link-monitoring=arp arp-ip-targets=192.168.0.2 R2: /interface bonding set bonding1 link-monitoring=arp arp-ip-targets=192.168.0.1

HA Case Studies

Multi-chassis Link Aggregation Group Introduction Quick setup MLAG settings and monitoring Introduction MLAG (Multi-chassis Link Aggregation Group) implementation in RouterOS allows configuring LACP bonds on two separate devices, while the client device believes to be connected to the same machine. This provides a physical redundancy in case of switch failure. All CRS3xx, CRS5xx series switches, and CCR2116, CCR2216 devices can be configured with MLAG using RouterOS version 7. Both peers establish the MLAG interfaces and update the bridge host table over using ICCP (Inter Chassis Control Protocol). RouterOS ICCP peer-port does not require an IP configuration, but it should be isolated from the rest of the network using a dedicated untagged VLAN. This untagged VLAN can be configured with and . Peer ports can also be configured as LACP bonding interfaces. vlan-filtering pvid When is running and ICCP is established, the primary device election happens and will be selected. The peer with the lowest peer-port system-id pri will act as the primary device. If the priorities are the same, the peer with the lowest bridge MAC address will become the primary. This ority system-id is used for STP BPDU bridge identifier and LACP system ID. The MLAG requires enabled STP, RSTP or MSTP protocol. Use the same STP priority and the same STP configuration on dual-connected bridge ports on both nodes. When MLAG bridges are elected as STP root, then both devices will show as root bridges under the bridge monitor. The MLAG is not compatible with . When using MLAG, the L3 hardware offloading must be disabled. L3 hardware offloading

Quick setup in this example, CRS317 and CRS309 devices are used as MLAG peers and any device with two SFP+ interfaces can be used as an LACP client. The SFP+1 interface is used on both peer nodes to create , and it is used for ICCP, s peer-port ee a network scheme below.

Below are configuration commands to create a regular in RouterOS for the Client device: LACP bonding /interface bonding add mode=802.3ad name=bond1 slaves=sfp-sfpplus1,sfp-sfpplus2 Next, configure bonding interfaces for MLAG on Peer1 and Peer2 devices, use a matching setting on both peer devices: mlag-id # Peer1 /interface bonding add mlag-id=10 mode=802.3ad name=client-bond slaves=sfp-sfpplus2 # Peer2 /interface bonding add mlag-id=10 mode=802.3ad name=client-bond slaves=sfp-sfpplus2 Configure bridge with enabled , and add needed interfaces as bridge ports. A dedicated untagged VLAN should be applied for the inter- vlan-filtering chassis communication on a peer port, thus a different setting is used. Below are configuration commands for Peer1 and Peer2 devices:pvid

active-role (primar y | secondary )The peer with the lowest will act as the primary device. If the priorities are the same, the peer with the lowest bridge priority MAC address will become the primary. The of the primary device is used for sending the (R/M)STP BPDU bridge system-id identifier and LACP system ID. Sub-menu: /interface bonding Property Description mlag-id (integer: 0.. ) 4294967295 ; Default:Changes MLAG ID for bonding interface. The same MLAG ID should be used on both peer devices to successfully create a single LAG for the client device. The should not be configured with the MLAG ID. peer-port LACP bonding interface and bonding slave ports can be monitored with and commands. See more details on monitor monitor-slaves Bonding . monitoring The " " : error will occur, if the bridge or bridge/port does not utilize Layer 2 hardware offloading. MLAG setup must be done not hw offloaded using single bridge as well as bridge port hw=yes

VRRP Summary Protocol Overview Virtual Router (VR) Virtual MAC address Owner Master Backup Virtual Address IPv4 ARP IPv6 ND VRRP state machine Init state Backup state Master state Connection tracking synchronization Configuring VRRP IPv4 IPV6 Parameters Summary This chapter describes the Virtual Router Redundancy Protocol (VRRP) support in RouterOS. Mostly on larger LANs dynamic routing protocols (OSPF orRIP) are used, however, there are a number of factors that may make it undesirable to use dynamic routing protocols. One alternative is to use static routing, but if the statically configured first hop fails, then the host will not be able to communicate with other hosts. In IPv6 networks, hosts learn about routers by receiving Router Advertisements used by Neighbor Discovery (ND) protocol. ND already has a built-in the mechanism to determine unreachable routers. However, it can take up to 38 seconds to detect an unreachable router. It is possible to change parameters and make detection faster, but it will increase the overhead of ND traffic especially if there are a lot of hosts. VRRP allows the detection of unreachable routers within 3 seconds without additional traffic overhead. Virtual Router Redundancy Protocol (VRRP) provides a solution by combining a number of routers into a logical group called (VR). VRRP Virtual Router implementation in RouterOS is based on VRRPv2 RFC 3768 and VRRPv3 RFC 5798. It is recommended to use the same version of RouterOS for all devices with the same VRID used to implement VRRP. Protocol Overview According to RFC authentication is deprecated for VRRP v3

The purpose of the VRRP is to communicate to all VRRP routers associated with the Virtual Router ID and support router redundancy through a prioritized election process among them. All messaging is done by IPv4 or IPv6 multicast packets using protocol 112 (VRRP). The destination address of an IPv4 packet is and for IPv6 224.0.0.18 it is . The source address of the packet is always the primary IP address of an interface from which the packet is being sent. In IPv6 FF02:0:0:0:0:0:0:12 networks, the source address is the link-local address of an interface. These packets are always sent with TTL=255 and are not forwarded by the router. If for any reason the router receives a packet with lower TTL, a packet is discarded. Each VR node has a single assigned MAC address. This MAC address is used as a source for all periodic messages sent by Master. Virtual Router is defined by VRID and mapped set of IPv4 or IPv6 addresses. The master router is said to be the of mapped IPv4/IPv6 addresses. owner There are no limits to using the same VRID for IPv4 and IPv6, however, these will be two different Virtual Routers. Only the Master router is sending periodic Advertisement messages to minimize the traffic. A backup will try to preempt the Master only if it has the higher priority and preemption is not prohibited.

Virtual Router (VR) A Virtual Router (VR) consists of one Owner router and one or more backup routers belonging to the same network. VR includes: VRID configured on each VRRP router the same virtual IP on each router Owner and Backup configured on each router. On a given VR there can be only one Owner. Virtual MAC address VRRP automatically assigns MAC address to VRRP interface based on standard MAC prefix for VRRP packets and VRID number. The first five octets are 00:00:5E:00:01 and the last octet is configured VRID. For example, if Virtual Routers VRID is 49, then the virtual MAC address will be . 00:00:5E:00:01:31 Owner An Owner router for a VR is the default Master router and operates as the Owner for all subnets included in the VR. Priority on an owner router must be the highest value (255) and virtual IP is the same as real IP (owns the virtual IP address). Master A master router in a VR operates as the physical gateway for the network for which it is configured. The selection of the Master is controlled by priority value. Master state describes the behavior of the Master router. For example network, is the Master router. When R1 is no longer available R2 The R1 becomes master. Backup VR must contain at least one Backup router. A backup router must be configured with the same virtual IP as the Master for that VR. The default priority for Backup routers is 100. When the current master router is no longer available, a backup router with the highest priority will become a current master. Every time when a router with higher priority becomes available it is switched to master. Sometimes this behavior is not necessary. To override it preemption mode should be disabled. Virtual Address All VRRP routers belonging to the same VR must be configured with the same advertisement interval. If the interval does not match router will discard the received advertisement packet. Virtual mac addresses can not be manually set or edited. RouterOS can not be configured as Owner. The Pure virtual IP configuration is the only valid configuration unless a non-RouterOS device is set as the owner.

Virtual IP associated with VR must be identical and set on all VR nodes. All virtual and real addresses should be from the same network. If the Master of VR is associated with multiple IP addresses, then Backup routers belonging to the same VR must also be associated with the same set of virtual IP addresses. If the virtual address on the Master is not also on Backup a misconfiguration exists and VRRP advertisement packets will be discarded. All Virtual Router members can be configured so that virtual IP is not the same as physical IP. Such a virtual address can be called a floating or pure virtual IP address. The advantage of this setup is the flexibility given to the administrator. Since the virtual IP address is not the real address of any one of the participant routers, the administrator can change these physical routers or their addresses without any need to reconfigure the virtual router itself. In IPv6 networks, the first address is always a link-local address associated with VR. If multiple IPv6 addresses are configured, then they are added to the advertisement packet after the link-local address. IPv4 ARP The Master for a given VR responds to ARP requests with the VR's assigned MAC address. The virtual MAC address is also used as the source MAC address for advertisement packets sent by the Master. To ARP requests for non-virtual IP, addresses router responds with the system MAC address. Backup routers are not responding to ARP requests for Virtual IPs. IPv6 ND As you may know, in IPv6 networks, the Neighbor Discovery protocol is used instead of ARP. When a router becomes the Master, an unsolicited ND Neighbor Advertisement with the Router Flag is sent for each IPv6 address associated with the virtual router. VRRP state machine RouterOS can not be configured as Owner. VRRP address and real IP address should not be the same.

As you can see from the diagram, each VRRP node can be in one of three states: Init state Backup state Master state Init state The purpose of this state is to wait for a Startup event. When this event is received, the following actions are taken: if priority is 255, * for IPv4 send advertisement packet and broadcast ARP requests * for IPv6 send an unsolicited ND Neighbor Advertisement for each IPv6 address associated with the virtual router and set target address to link- local address associated with VR. * transit to MASTER state; else transit to BACKUP state. Backup state When in the backup state, in IPv4 networks, a node is not responding to ARP requests and is not forwarding traffic for the IP associated with the VR. in IPv6 networks, a node is not responding to ND Neighbor Solicitation messages and is not sending ND Router Advertisement messages for VR- associated IPv6 addresses. Routers' main task is to receive advertisement packets and check if the master node is available. The backup router will transmit itself to the master state in two cases: If priority in advertisement packet is 0; When Preemption_Mode is set to yes and Priority in the ADVERTISEMENT is lower than the local Priority After the transition to Master state node is: in IPv4 broadcasts gratuitous ARP request; in IPv6 sends an unsolicited ND Neighbor Advertisement for every associated IPv6 address. In other cases, advertisement packets will be discarded. When the shutdown event is received, transit to Init state. Master state When the MASTER state is set, the node functions as a forwarding router for IPv4/IPv6 addresses associated with the VR. In IPv4 networks, the Master node responds to ARP requests for the IPv4 address associated with the VR. In IPv6 networks Master node: responds to ND Neighbor Solicitation message for the associated IPv6 address; Preemption mode is ignored if the Owner router becomes available.

sends ND Router Advertisements for the associated IPv6 addresses. If the advertisement packet is received by master node: If priority is 0, send advertisement immediately; If priority in advertisement packet is greater than nodes priority then transit to backup state the If priority in advertisement packet is equal to nodes priority and primary IP Address of the sender is greater than the local primary IP Address, then transit to backup state the Ignore advertisement in other cases When the shutdown event is received, send the advertisement packet with priority=0 and transit to Init state. Connection tracking synchronization Similar to different High availability features, RouterOS v7 supports VRRP connection tracking synchronization. The VRRP connection tracking synchronization requires that RouterOS is running. By default, connection tracking is working in connection tracking auto mode. If VRRP devices do not contain any firewall rules, you need to manually enable connection tracking: /ip/firewall/connection/tracking/set enabled=yes To sync connection tracking entries configure the device as follows: /interface/vrrp/set vrrp1 sync-connection-tracking=yes Verify configuration in the logging section: 16:14:06 vrrp,info vrrp1 now MASTER, master down timer 16:14:06 vrrp,info vrrp1 stop CONNTRACK 16:14:06 vrrp,info vrrp1 starting CONNTRACK MASTER Connection tracking entries are synchronized only from the Master to the Backup device. When both sync-connection-tracking and preemption-mode are enabled, and a router with higher VRRP priority becomes online, the connections get synchronized first, and only then the router with higher priority becomes the VRRP master. Configuring VRRP IPv4 Setting up Virtual Router is quite easy, only two actions are required - create VRRP interface and set Virtual Routers IP address. For example, add VRRP to ether1 and set VRs address to 192.168.1.1 /interface vrrp add name=vrrp1 interface=ether1 /ip address add address=192.168.1.2/24 interface=ether1 /ip address add address=192.168.1.1/32 interface=vrrp1 Notice that only the 'interface' parameter was specified when adding VRRP. It is the only parameter required to be set manually, other parameters if not specified will be set to their defaults: and . vrid=1, priority=100 authentication=none If multiple VRRP interfaces are configured between two units, then it is enough to enable sync-connection-tracking=yes on one (preferably master) VRRP interface.

Before VRRP can operate correctly correct IP address is required on ether1. In this example, it is 192.168.1.2/24 IPV6 To make VRRP work in IPv6 networks, several additional options must be enabled - v3 support is required and the protocol type should be set to IPv6: /interface vrrp add name=vrrp1 interface=ether1 version=3 v3-protocol=ipv6 Now when the VRRP interface is set, we can add a global address and enable ND advertisement: /ipv6 address add address=FEC0:0:0:FFFF::1/64 advertise=yes interface=vrrp1 No additional address configuration is required as it is in the IPv4 case. IPv6 uses link-local addresses to communicate between nodes. Parameters Property Description arp (disabled | enabled | proxy- ; arp | reply-only Default: ) enabledARP resolution protocol mode arp-timeout (integ er; Default: auto) authentication (ah ; | none | simple Default: ) noneAuthentication method to use for VRRP advertisement packets. none - should be used only in low-security networks (e.g., two VRRP nodes on LAN). ah- IP Authentication Header. This algorithm provides strong protection against configuration errors, replay attacks, and packet corruption/modification. Recommended when there is limited control over the administration of nodes on a LAN. HMAC-MD5 is used. simple - uses a clear-text password. Protects against accidental misconfiguration of routers on a local network. group-authority (in Default: terface; n )oneAllows combining multiple VRRP interfaces to maintain the same VRRP status within the group. For example, VRRP instances run on LAN and WAN networks with NAT in-between. If one VRRP instance is Master and the other is Backup on the same device, the entire network malfunctions due to NAT failure. Grouping LAN and WAN VRRP interfaces ensures that both are either VRRP Master or Backup. In a VRRP group, VRRP control traffic gets sent only by the group authority. That's why in a typical WAN+LAN setup, it is recommended to use the LAN network as the group master to keep VRRP control traffic in the internal network. /interface vrrp add name=vrrp-wan interface=sfp-sfpplus1 vrid=1 priority=100 add name=vrrp-lan interface=bridge1 vrid=2 priority=100 set [find] group-authority=vrrp-lan Group-authority was previously called "group-master", "group-master" is kept for compatibility with scripts, but if both are set only "group-authority" will be taken into account. interface ( ; string Default: ) Interface name on which VRRP instance will be running Address on the VRRP interface must have /32 netmask if the address configured on VRRP is from the same subnet as on the router's any other interface.

interval (time ; [10ms..4m15s] Default: ) 1sVRRP update interval in seconds. Defines how often the master sends advertisement packets. mtu ( ; integer Default: ) 1500Layer3 MTU size. Since RouterOS v7.7, the VRRP interface always uses slave interface MTU name ( ; string Default: ) VRRP interface name on-backup ( ; string Default: ) Script to execute when the node is switched to the backup state on-master ( ; string Default: ) Script to execute when the node is switched to master state on-fail ( ; string Default: ) Script to execute when the node fails password ( ; string Default: ) Password required for authentication. Can be ignored if authentication is not used. preemption-mode ( ; Default: yes | no y )esWhether the master node always has the priority. When set to 'no' the backup node will not be elected to be a master until the current master fails, even if the backup node has higher priority than the current master. This setting is ignored if wner the o router becomes available priority (integer: ; Default: 1..254 100 )Priority of VRRP node used in Master election algorithm. A higher number means higher priority. '255' is reserved for the router that owns VR IP and '0' is reserved for the Master router to indicate that it is releasing responsibility. remote-address (I Default: )Pv4;Specifies the remote address of the other VRRP router for syncing connection tracking. If not set, the system autodetects the remote address via VRRP. The remote address is used only if sync-connection-tracking=yes. Explicitly setting a remote address has the following benefits: Connection syncing starts faster since there is no need to wait for VRRP's initial message exchange to detect the remote address. Faster VRRP Master election. Allows sending connection tracking data via a different network interface (e.g., a dedicated secure line between two routers). Sync connection tracking uses UDP port 8275. v3-protocol (ipv4 | ; Default: ) ipv6 ipv4A protocol that will be used by VRRPv3. Valid only if is 3. the version version (integer ; Default: ) [2, 3] 3Which VRRP version to use. vrid (integer: 1.. ; Default: ) 255 1Virtual Router identifier. Each Virtual router must have a unique id number sync-connection- tracking ( ; string Default: )noSynchronize connection tracking entries from Master to Backup device. The VRRP connection tracking synchronization requires that RouterOS is running. connection tracking

VRRP Configuration Examples Basic Setup Configuration Testing Load sharing Configuration VRRP without Preemption Configuration Testing Basic Setup This is the basic VRRP configuration example. Note It is recommended to use the same version of RouterOS for all devices with the same VRID used to implement VRRP.

According to this configuration, as long as the master, R1, is functional, all traffic destined to the external network gets directed to R1. But as soon as R1 fails, R2 takes over as the master and starts handling packets forwarded to the interface associated with IP(R1). In this setup router "R2" is completely idle during the Backup period. Configuration R1 configuration: /ip address add address=192.168.1.10/24 interface=ether1 /interface vrrp add interface=ether1 vrid=49 priority=254 /ip address add address=192.168.1.1/32 interface=vrrp1 R2 configuration:

/ip address add address=192.168.1.20/24 interface=ether1 /interface vrrp add interface=ether1 vrid=49 /ip address add address=192.168.1.1/32 interface=vrrp1 Testing First of all, check if both routers have correct flags at VRRP interfaces. On router R1 it should look like this /interface vrrp print detail 0 RM name="vrrp1" mtu=1500 mac-address=00:00:5E:00:01:31 arp=enabled interface=ether1 vrid=49 priority=254 interval=1 preemption-mode=yes authentication=none password="" on-backup="" on-master="" version=3 v3-protocol=ipv4 and on router R2: /interface vrrp print detail 0 B name="vrrp1" mtu=1500 mac-address=00:00:5E:00:01:31 arp=enabled interface=ether1 vrid=49 priority=100 interval=1 preemption-mode=yes authentication=none password="" on-backup="" on-master=" version=3 v3-protocol=ipv4 As you can see VRRP interface MAC addresses are identical on both routers. Now to check if VRRP is working correctly, try to ping the virtual address from a client and check ARP entries: [admin@client] > /ping 192.168.1.1 192.168.1.254 64 byte ping: ttl=64 time=10 ms 192.168.1.254 64 byte ping: ttl=64 time=8 ms 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 8/9.0/10 ms [admin@client] /ip arp> print Flags: X - disabled, I - invalid, H - DHCP, D - dynamic # ADDRESS MAC-ADDRESS INTERFACE ... 1 D 192.168.1.1 00:00:5E:00:01:31 bridge1 Now unplug the ether1 cable on router R1. R2 will become VRRP master, and the ARP table on a client will not change but traffic will start to flow over the R2 router. Load sharing In the basic configuration example, R2 is completely idle during the Backup state. This behavior may be considered a waste of valuable resources. In such circumstances, the R2 router can be set as the gateway for some clients. The obvious advantage of this configuration is the establishment of a load-sharing scheme. But by doing so R2 router is not protected by the current VRRP setup. To make this setup work we need two virtual routers. In case VRRP is used with Reverse Path Filtering, then it is recommended that is set to , otherwise, the VRRP interface rp-filter loose might not be reachable.

Configuration for V1 virtual router will be identical to a configuration in basic example - R1 is the Master and R2 is the Backup router. In V2 Master is R2 and Backup is R1. With this configuration, we establish load-sharing between R1 and R2; moreover, we create a protection setup by having two routers acting as backups for each other. Configuration R1 configuration: /ip address add address=192.168.1.1/24 interface=ether1 /interface vrrp add interface=ether1 vrid=49 priority=254 /interface vrrp add interface=ether1 vrid=77 /ip address add address=192.168.1.253/32 interface=vrrp1 /ip address add address=192.168.1.254/32 interface=vrrp2 R2 configuration:

/ip address add address=192.168.1.2/24 interface=ether1 /interface vrrp add interface=ether1 vrid=49 /interface vrrp add interface=ether1 vrid=77 priority=254 /ip address add address=192.168.1.253/32 interface=vrrp1 /ip address add address=192.168.1.254/32 interface=vrrp2 VRRP without Preemption Each time when the router with a higher priority becomes available it becomes the Master router. Sometimes this is not the desired behavior and can be turned off by setting in VRRP configuration. preemption-mode=no Configuration We will be using the same setup as in the basic example. The only difference is during configuration set preemption-mode=no. It can be done easily by modifying the existing configuration: /interface vrrp set [find] preemption-mode=no Testing Try turning off the R1 router, R2 will become the Master router because it has the highest priority among available routers. Now turn the R1 router on and you will see that the R2 router continues to be the Master even if R1 has the higher priority.

Mobile Networking In This Section:

GPS Summary Configuration Properties Monitoring Status Basic examples Troubleshooting Summary Package requirement: gps Sub-menu: /system gps Standards: GPS, NMEA 0183, Simple Text Output Protocol Global Positioning System (GPS) is used for determining the precise location of a GPS receiver. Configuration Properties Property Description channel ( ; Default: ) integer [0..4294967295] 0 Port channel used by the device coordinate-format ( ; Default: ) dd | dms | ddmm no Which coordinate format to use, "Decimal Degrees", "Degrees Minutes Seconds" or "NMEA format DDDMM.MM[MM]" enabled ( ; Default: ) yes | no no Whether GPS is enabled gps-antenna-select ( ; Default: external | internal i ) nternalDepending on the model. Internal antenna can be selected, if the device has one installed. init-channel ( ; Default: ) integer [0..4294967295] Channel for init-string execution init-string ( ; Default: ) string AT init string for GPS initialization port ( ; Default: ) string Name of the USB/Serial port where the GPS receiver is connected set-system-time ( ; Default: ) yes | no no Whether to set the router's date and time to one received from GPS. Monitoring Status Command: /system gps monitor This command is used for monitoring the data received from a GPS receiver. Parameters: Property Description date-and-time ( )date Date and time received from GPS latitude ( ) none | string Latitude in DM (Degrees Minute decimal) format longitude ( ) none | string Longitude in DM (Degrees Minute decimal) format altitude ( ) none | string Altitude based on GPS data speed ( ) none | string The current moving speed of the GPS unit destination-bearing ( ) none | string The direction toward which a GPS is moving Starting with the 7.1rc3 firmware release, a new parameter was added, called "data-age" (measured in seconds). This parameter displays the time that has passed since the device received the last NMEA message.

GPS-tracking using HTTP POST The following article explains how to create a simple vehicle tracking system using the RouterOS GPS function and scripting. Method This approach uses HTTP POST capability of RouterOS Fetch tool. It allows you to POST any kind of data to a webserver, right from the RouterOS command line. Of course, you can use scripting, to fill the POST data with variables. The posted data will be written to an SQLITE3 database (file is created, if it doesn't exist) and then, read from the database and fed into a Leaflet.js PolyLine array. This is a proof of concept example, there is no authentication, security, or error handling. Requirements Web server of your choice PHP SQLite3 module for PHP RouterOS device with a working GPS module RouterOS Set GPS format in RouterOS to dd RouterOS script You can run this script in the Scheduler tool, with an interval of 1s, to have your coordinates sent every 1 second. { :global lat :global lon /system gps monitor once do={ :set $lat $("latitude") :set $lon $("longitude") } tool fetch mode=http url="http://YOURSERVER.com/index.php" port=80 http-method=post http-data=("{\"lat\":\"" . $lat . "\",\"lon\":\"" . $lon . "\"}") http-header-field="Content-Type: application/json" :put ("{\"lat\":\"" . $lat . "\",\"lon\":\"" . $lon . "\"}") } index.php file Create an empty directory called next to the index.php file. Make sure that directory and files are writable by the group with sqlite_db chmod -R a+w sqlite_db/

<?php $loc = dirname(__FILE__).'/sqlite_db/coord.db'; $db = new SQLite3($loc,SQLITE3_OPEN_READWRITE | SQLITE3_OPEN_CREATE); $raw = file_get_contents('php://input'); $raw = preg_replace('/\\x00/','',$raw); $data = json_decode($raw); if (!empty($data) && is_object($data) && property_exists($data,'lat') && property_exists($data,'lon')){ if(file_exists($loc)) echo 'exists!'.chr(0xa); $src = 'SELECT name FROM sqlite_master WHERE type=\'table\' AND name=\'coordinates\''; $res = $db->querySingle($src); if (count($res)==0){ $db->exec('CREATE TABLE coordinates (latitude TEXT, longitude TEXT, time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, added TIMESTAMP DEFAULT CURRENT_TIMESTAMP ) '); } $regex = '/^(|\-)([0-9]{2,3}\.[0-9]{0,8})$/'; if (preg_match($regex,$data->lat) && preg_match($regex,$data->lon) ) { $lat = $data->lat; $lon = $data->lon; } $ins = 'INSERT INTO coordinates (latitude,longitude) VALUES (\''.SQLite3::escapeString($lat).'\',\''. SQLite3::escapeString($lon).'\')'; $db->exec($ins); die(); } ?> <!DOCTYPE html> <html> <head> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512- Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/> <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512- /Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin="">< /script> </head> <body> <div id="map" style="width: 800px; height: 600px;"></div> <script> var map = L.map('map').setView([0,0], 4); L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '<a href="http://osm.org/copyright">OSM< /a>'}).addTo(map); <?php if($result = $db->query('SELECT latitude,longitude FROM coordinates')){ echo ' var latlngs = [ '; while($obj = $result->fetchArray()){ if (!is_array($obj) || !isset($obj['latitude']) || !isset($obj['longitude']) || empty($obj ['latitude']) || empty($obj['longitude'])) continue; echo '["'. $obj['latitude'].'","'.$obj['longitude'].'"],'; } echo ']; '; } else echo('//'.$db->lastErrorMsg().chr(0xa)); echo($data); ?> var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map); map.fitBounds(polyline.getBounds()); </script> </body> </html> Result

GPS-tracking using MQTT and ThingsBoard Introduction Configuration ThingsBoard preparation MQTT broker configuration MQTT publish Result verification Data visualization using maps Introduction Many RouterOS devices have support. It allows RouterOS to determine the precise location of its GPS receiver. GPS coordinates will indicate the GPS latitude and the longitude values (among other parameters) of the current position. Let's say, you have (or any other RouterOS device with GPS support) and you wish to track its location. You want the router to send this data to a LTAP server, where the data will be stored and integrated into a map, as it is more convenient to monitor. In this guide, we will showcase how you can do that. This scenario will utilize MQTT protocol communication with a platform called . ThingsBoard ThingsBoard has a cloud solution and different local installation options (on different OS). Since we've added a feature, it became possible to also run the platform within the RouterOS. Meaning, you can build this scenario, solely on container RouterOS units → devices with GPS support that you wish to track (for example, cars equipped with s → RouterOS devices that act as LTAP MQTT ), and a ThingsBoard server run within a more powerful RouterOS device (like a machine → RouterOS device that acts as an ). publishers CHR MQTT broker If you want to choose this route (container route), make sure to pick the devices that you plan on using as a "server" carefully, because this implementation can be heavy on RAM usage (it is suggested to have a device that has at least or and is either or 2 GB RAM 1 GB RAM with minimal load ARM64 AMD64 architecture). Configuration In this guide, we will demonstrate how to configure a GPS receiver (MQTT publisher) and how to set up ThingsBoard. In case you want to use the container feature to run the ThingsBoard instance (MQTT broker), check the guide . General guidelines on over here ThingsBoard and MQTT configuration can be found in the guide . Make sure to explore both guides as they will have additional useful information. over here Before proceeding, make sure that the ThingsBoard is up and running and that you can access its WEB management portal. Confirm that the MQTT port is open and/or port-forwarded properly. ThingsBoard preparation Navigate to the " " menu and add a new device via the " " button → name it and create it (for example, LTAP): Devices Add new device Package requirement: gps, iot This example will showcase and scenarios for simplicity reasons, but you can use access-token one-way SSL communication via access-token other available options as well.

Click on the device you've just added, go to the " " section, and generate an access token under the " " setting: Details Manage credentials/Device Credentials MQTT broker configuration In case it is a local test or the broker is available through the VPN, you can use non-SSL MQTT: /iot/mqtt/brokers/add name=tb address=x.x.x.x port=1883 username=access_token Where: name is the name that you wish to give to the broker and this name will be used later in the script; address is the IP address of the broker; port is the TCP port that the broker is listening for → for non-SSL it is typically TCP 1883; username is dictated by the MQTT broker and, in our case, it is an "access token" that was generated in the ThingsBoard management portal. In case it is public access (when you want to access the broker via its public IP address), : we advise you to use SSL MQTT /iot/mqtt/brokers/add name=tb address=x.x.x.x port=8883 username=access_token ssl=yes Where: name is the name that you wish to give to the broker and this name will be used later in the script; address is the IP address of the broker; port is the TCP port that the broker is listening for → for SSL it is typically TCP 8883; username is dictated by the MQTT broker, and, in our case, it is an "access token" that was generated in the ThingsBoard management portal; ssl enables SSL MQTT communication. MQTT publish You can test MQTT publish with a static message by using the command:

/iot/mqtt/publish broker="tb" topic="v1/devices/me/telemetry" message="{\"test\":\"123\"}" To post GPS coordinates, import the script shown below: /system/script/add dont-require-permissions=no name=mqttgps owner=admin policy="ftp,re\ boot,read,write,policy,test,password,sniff,sensitive,romon" \ source=" ###Configuration###\r\ \n #Enter pre-configured broker's name within \"\":\r\ \n :local broker \"tb\"\r\ \n #Enter the topic name within \"\", per the broker's config\ uration:\r\ \n :local topic \"v1/devices/me/telemetry\"\r\ \n\r\ \n ###Variables####\r\ \n :global lat\r\ \n :global lon\r\ \n :global alt1\r\ \n :global alt2\r\ \n\r\ \n ###GPS####\r\ \n :put (\"[*] Capturing GPS coordinates...\")\r\ \n /system gps monitor once do={\r\ \n :set \$lat \$(\"latitude\");\r\ \n :set \$lon \$(\"longitude\");\r\ \n :set \$alt1 \$(\"altitude\")}\r\ \n ###remove \"meters\" from the value because JSON format wi\ ll not understand it###\r\ \n :set \$alt2 [:pick \$alt1 0 [find \$alt1 \" m\"]]\r\ \n\r\ \n :local message \\\r\ \n \"{\\\"latitude\\\":\$lat,\\\r\ \n \\\"longitude\\\":\$lon,\\\r\ \n \\\"altitude\\\":\$alt2}\"\r\ \n\r\ \n ###MQTT###\r\ \n :if (\$lat != \"none\") do={\\\r\ \n :put (\"[*] Sending message to MQTT broker...\");\r\ \n /iot mqtt publish broker=\$broker topic=\$topic message=\$\ message} else={:put (\"[*] Lattitude=none, not posting anything!\ \");:log info \"Latitude=none, not posting anything!\"}" In short, the script captures GPS information, specifically the latitude, longitude, and altitude values. Then it structures a JSON message out of them. In case, at the moment when the script is initiated, the latitude value equals anything other than "none" (equals any actual value-number) → it sends the JSON message via MQTT to the broker named " ". In case, the GPS data can not be captured → "latitude" is recognized as "none" → the script just logs tb that nothing could be captured and does nothing else. This is a very basic example. Feel free to alter the script and add your own "if" (maybe an email notification if there is no GPS signal) and additional parameters (any other RouterOS captured value, like, maybe, its firmware version) per your requirements. Run the script with the command:

/system/script/run mqttgps [*] Capturing GPS coordinates... date-and-time: feb/01/2023 10:39:37 latitude: 56.969862 longitude: 24.162425 altitude: 31.799999 m speed: 1.000080 km/h destination-bearing: none true-bearing: 153.089996 deg. True magnetic-bearing: 0.000000 deg. Mag valid: yes satellites: 6 fix-quality: 1 horizontal-dilution: 1.42 data-age: 0s [*] Sending message to MQTT broker... To automate the process, add a (to run the script, for example, every 30 seconds): scheduler /system/scheduler/add name=mqttgpsscheduler interval=30s on-event="/system/script/run mqttgps" Result verification Go the the "Latest telemetry" section under your created device and confirm that the data was posted: Data visualization using maps ThingsBoard allows you to use to create visually appealing dashboards. In our case, we want to track our LTAP GPS coordinates, so we will need Widgets a map widget. Select the latitude and longitude values and click on the " " button: Show on widget

Find the " " bundle and click on the " ": Maps Add to dashboard Select an existing dashboard or create a new one and name it however you like: Run the script via the scheduler or manually and check the result:

Now, we can install it on a moving target and track its location:

LTE Summary LTE Client Properties APN profiles LTE settings Scanner User Info command Properties (Up to 6.40) Modem firmware-upgrade command Modems with firmware update support and connectivity required Modem firmware-upgrade command examples: User at-chat command Quick setup example Passthrough Example Dual SIM Boards with switchable SIM slots Usage Example Tips and Tricks Find device location using Cell information Using Cell lock Cell Monitor Troubleshooting Locking band on Huawei and other modems mPCIe modems with RB9xx series devices Boards with USB-A port and mPCIe Avoiding tethering speed throttling Unlocking SIM card after multiple wrong PIN code attempts Summary Package: system Optional lte-mipsbe.npk package is only required for SXT 3-7 built-in modem. Support for Direct-IP mode type cards only. MBIM support is available in RouterOS v7 releases and the MBIM driver is loaded automatically. If the modem is not recognized in RouterOS v6 - Please test it in v7 releases before asking for support in RouterOS v6. To enable access via a PPP interface instead of a LTE Interface, change the operational mode to "serial" with /interface lte settings set CLI command and issue a reboot. Note that using PPP emulation mode you may not get the same throughput speeds as using the LTE mode=serial interface emulation type. LTE Client Sub-menu: /interface lte Properties Property Description For RouterOS v7 the parameter was renamed to " " and moved to menu. ignore-direct-modem mode /interface lte settings

allow-roaming (y ; Default: es | no )noEnable data roaming for connecting to other countries' data-providers. Not all LTE modems support this feature. Some modems, that do not fully support this feature, will connect to the network but will not establish an IP data connection with allow-roaming set to no. apn-profiles (stri ; Default: ng defa )ultWhich APN profile to use for this interface band (integer list ; Default: )""LTE Frequency band used in communication LTE Bands and bandwidths nr-band (integer ; Default: "")list5G NR Frequency band used in communication 5G NR Bands and bandwidths comment ( ; string Default: )""Descriptive name of an item disabled (yes | ; Default: ) no yesWhether the interface is disabled or not. By default it is disabled. modem-init (string ; Default: )""Modem init string (AT command that will be executed at modem startup) mtu ( ; integer Default: ) 1500Maximum Transmission Unit. Max packet size that the LTE interface will be able to send without packet fragmentation. name ( ; string Default: )""Descriptive name of the interface. network-mode (3 ) g | gsm | lte | 5gSelect/force mode for LTE interface to operate with operator (integer ; Default: )""used to lock the device to a specific operator full PLMN number is used for the lock consisting of MCC+MNC. PLMN codes pin ( ; integer Default: )""SIM Card's PIN code. sms-protocol (at | auto | mbim)SMS functionality. : uses MBIM driver. : uses AT-Commands. : selects the appropriate option depending on the mbim at auto modem. APN profiles All network-related settings are under profiles Sub-menu: /interface lte apn Property Description add-default-route (yes | )noWhether to add a default route to forward all traffic over the LTE interface. apn ( ) string Service Provider's Access Point Name authentication (pap | ; Default: chap | none none )Allowed protocol to use for authentication default-route-distance (in ; Default: ) teger 2Sets distance value applied to auto-created default route, if add-default-route is also selected. LTE route by default is with distance 2 to prefer wired routes over LTE ip-type (ipv4 | ipv4-ipv6 | ; Default: )ipv6Requested PDN type

ipv6-interface (; Default: )Interface on which to advertise IPv6 prefix name ( ; Default: ) string APN profile name number ( ; integer Default: )APN profile number passthrough-interface (; Default: )Interface to passthrough IP configuration (activates passthrough) passthrough-mac ( ; MAC Default: )autoIf set to auto, then will learn MAC from the first packet passthrough-subnet- selection ( ; auto / p2p Default: ) auto"auto" selects the smallest possible subnet to be used for the passthrough interface. "p2p" sets the passthrough interface subnet as /32 and picks gateway address from 10.177.0.0/16 range. The gateway address stays the same until the apn configuration is changed. password ( ; string Default: )Password used if any of the authentication protocols are active use-network-apn (yes | ; Default: ) no yesParameter is available starting from RouterOS v7 and used only for MBIM modems. If set to yes, uses network provided APN. use-peer-dns ( ; yes | no Default: )yesIf set to yes, uses DNS received from LTE interface user ( ) integer Username used if any of the authentication protocols are active LTE settings LTE and router-specific LTE settings. The menu is available starting from RouterOS v7. Sub-menu: /interface lte settings Property Description mode ( / ; auto | mbim | serial user Default: )autoOperation mode setting. auto - automatically select the operation mode. serial - provide only serial ports mbim - switch modem into MBIM mode if possible user - OS will not attempt to automatically switch the modem mode. (Available from RouterOS 7.16) firmware-path ( ) string Firmware path in host OS. Modem gobi firmware external-antenna (auto | both | div | main ; Default: ) | none autoThis setting is only available for "Chateau" routers, except for Chateau 5G versions. auto - measures the signal levels on both internal and external antennas and selects the antennas with the best signal(RSRP). both - both antennas are set to external div - diversity antenna set to external main - main antenna set to external none - no external antenna selected(using internal antennas) external-antenna-selected () This setting is only available for "Chateau" routers, except for Chateau 5G versions. Shows the currently selected antenna if " " is set to "auto" external-antenna sim-slot () This setting is available for routers that have switchable SIM slots (LtAP, SXT). Selection options differ between products. Scanner

Property Description current-operator ( ; Default: ) integer Contains MCC and MNC. For example: current-operator: 24701 breaks to: MCC=247 MNC=01 lac ( ; Default: ) integer location area code (LAC) current-cellid ( ; Default: ) integer Station identification number Values can be used to find location in databases: Cell Id Finder Using Cell lock It is possible to lock R11e-LTE, R11e-LTE6 and R11e-4G modems and equipped devices to the exact LTE tower. LTE info command provides currently used cellular tower information: phy-cellid: 384 earfcn: 1300 (band 3, bandwidth 20Mhz) Property Description phy-cellid ( ; Default: ) integer Physical Cell Identification (PCI) of currently used cell tower. earfcn ( ; Default: ) integer Absolute Radio Frequency Channel Number Exact tower location as well as available bands and other information can be acquired from mobile carrier or by using online services: CellMapper By using those acquired variables it's possible to send the AT command to modem for locking to tower in the current format: for R11e-LTE and R11e-LTE6 AT*Cell=<mode>,<NetworkMode>,<band>,<EARFCN>,<PCI> where <mode> : 0 – Cell/Frequency disabled 1 – Frequency lock enabled 2 – Cell lock enabled <NetworkMode> 0 – GSM 1 – UMTS_TD 2 – UMTS_WB 3 – LTE <band> Not in use, leave this blank <EARFCN> earfcn from lte info <PCI> phy-cellid from lte info To lock modem at previously used tower at-chat can be used: /interface lte at-chat lte1 input="AT*Cell=2,3,,1300,384" For R11e-LTE all set on locks are lost after reboot or modem reset. Cell data can be also gathered from "cell-monitor". For R11e-LTE6 cell lock works only for the primary band, this can be useful if you have multiple channels on the same band and you want to lock it to a specific earfcn. Note, that cell lock is not band-specific and for ca-band it can also use other frequency bands, unless you use band lock. Use cell lock to set the primary band to the 1300 earfcn and use the second channel for the ca-band: /interface lte at-chat lte1 input="AT*Cell=2,3,,1300,138" Now it uses the earfcn: 1300 for the primary channel:

primary-band: B3@20Mhz earfcn: 1300 phy-cellid: 138 ca-band: B3@5Mhz earfcn: 1417 phy-cellid: 138 You can also set it the other way around: /interface lte at-chat lte1 input="AT*Cell=2,3,,1417,138" Now it uses the earfcn: 1417 for the primary channel: primary-band: B3@5Mhz earfcn: 1417 phy-cellid: 138 ca-band: B3@20Mhz earfcn: 1300 phy-cellid: 138 For R11e-LTE6 modem cell lock information will not be lost after reboot or modem reset. To remove cell lock use at-chat command: /interface lte at-chat lte1 input="AT*Cell=0" for R11e-4G AT%CLCMD=<mode>,<mode2>,<EARFCN>,<PCI>,<PLMN> AT%CLCMD=1,1,3250,244,\"24705\" where <mode> : 0 – Cell/Frequency disabled 1 – Cell lock enabled <mode2> : 0 - Save lock for first scan 1 - Always use lock (after each reset modem will clear out previous settings no matter what is used here) <EARFCN> earfcn from lte info <PCI> phy-cellid from lte info <PLMN> Mobile operator code All PLMN codes available this variable can be also left blankhere To lock the modem to the cell - modem needs to be in non operating state, the easiest way for modem is to add CellLock line to "modem-init" R11e-4G string: /interface lte set lte1 modem-init="AT%CLCMD=1,1,3250,244,\"24705\"" Multiple cells can also be added by providing a list instead of one tower information in the following format: AT%CLCMD=<mode>,<mode2>,<EARFCN_1>,<PCI_1>,<PLMN_1>,<EARFCN_2>,<PCI_2>,<PLMN_2> For example to lock to two different PCIs within the same band and operator: /interface lte set lte1 modem-init="AT%CLCMD=1,1,6300,384,\"24701\",6300,385,\"24701\"" for Chateau LTE12, Chateau LTE18, Chateau 5G, LHG LTE18 and ATL LTE18 AT+QNWLOCK="common/4g",<num of cells>,[[<freq>,<pci>],...] AT+QNWLOCK=\"common/4g\",1,6300,384 where <num of cells> number of cells to cell lock <freq> earfcn from lte info <pci> phy-cellid from lte info

mPCIe modems with RB9xx series devices In case your modem is not being recognized after a soft reboot, then you might need to add a delay before the USB port is initialized. This can be done using the following command: /system routerboard settings set init-delay=5s Boards with USB-A port and mPCIe Some devices such as specific RB9xx's and the RBLtAP-2HnD share the same USB lines between a single mPCIe slot and a USB-A port. If auto switch is not taking place and a modem is not getting detected, you might need to switch manually to either use the USB-A or mini-PCIe: /system routerboard usb set type=mini-PCIe Avoiding tethering speed throttling Some operators (TMobile, YOTA etc.) allow unlimited data only for the device the SIM card is used on, all other data coming from mobile hotspots or tethering is highly limited by volume or by throughput speed. have found out that this limitation is done by monitoring TTL (Time To Live) Some sources values from packets to determine if limitations need to be applied (TTL is decreased by 1 for each "hop" made). RouterOS allows changing the TTL parameter for packets going from the router to allow hiding sub networks. Keep in mind that this may conflict with fair use policy. IPv4 mangle rule: /ip firewall mangle add action=change-ttl chain=postrouting new-ttl=set:65 out-interface=lte1 passthrough=yes IPv6 mangle rule: /ipv6 firewall mangle add action=change-hop-limit chain=postrouting new-hop-limit=set:65 passthrough=yes More information: , YOTA TMobile Unlocking SIM card after multiple wrong PIN code attempts After locking the SIM card, unlock can be done through "at-chat" Check current PIN code status: /interface lte at-chat lte1 input="at+cpin\?" If card is locked - unlock it by providing: /interface lte at-chat lte1 input="AT+CPIN=\"PUK_code\",\"NEW_PIN\"" Replace PUK_code and NEW_PIN with matching values. The command for sim slot selection changes in v6.45.1 and again in v7. Some device models like SXT, have SIM slots named "a" and "b" instead of "up" and down"

1. 2. 3. PPP Overview Introduction PPP Client PPP Client example PPP Server Overview The Point-to-Point Protocol (PPP) provides a standard method for transporting multi-protocol datagrams over point-to-point links. PPP in RouterOS is based on RFC 1661 standard. Introduction The basic purpose of PPP at this point is to transport Layer-3 packets across a Data Link layer point-to-point link. Packets between both peers are assumed to deliver in order. PPP is comprised of three main components: A method for encapsulating multi-protocol datagrams. A Link Control Protocol (LCP) for establishing, configuring, and testing the data-link connection. A family of Network Control Protocols (NCPs) for establishing and configuring different network-layer protocols. Detailed PPP packet processing in RouterOS you can see in the . Packet Flow Diagram PPP Client /interface ppp-client PPP Client example This is an example of how to add a client using an exposed serial port from an LTE modem. /interface ppp-client add apn=yourapn dial-on-demand=no disabled=no port=usb2 The dial-on-demand should to be set to 'no' for a continuous connection. PPP Server /interface ppp-server

SMS Summary Sending Example USSD messages Example Receiving Inbox Syntax Examples Debugging Implementation details Summary It is possible to connect the GSM modem to the RouterOS device and use it to send and receive SMS messages. RouterOS lists such modem as a serial port that appears in the ' ' listing. GSM standard defines AT commands for sending SMS messages and defines how messages should be /port print encoded in these commands. uses standard GSM AT commands to send SMS. ' ' /tool sms send Sending /tool sms send Example Sending command for ppp interface: /tool sms send usb3 "20000000" \ message="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#\$%^&*(){}[] \"'~" For LTE interface use LTE interface name in the port field: /tool sms send lte1 "20000000" \ message="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#\$%^&*(){}[] \"'~" Parameter Description port ( ) string Name of port from that GSM modem is attached to. /port phone-number ( ) string Recipient phone number. Allowed characters are "0123456789*#abc". If the first character is "+" then the phone number type is set to , otherwise, it is set to . international unknown channel ( ) integer Which modem channel to use for sending. message ( ) string Message contents. It is encoded using GSM 7 encoding (UCS2 currently is not supported), so the message length is limited to 160 characters (characters ^{}\[]~ smsc ( ) string type ( ) string If set to , then send class 0 SMS message. It is displayed immediately and not stored in the phone. class-0 sms-storage ( ) string Select storage where to save received SMS (modem/sim) status-report-request (yes | ; Default: yes)noSet "no" to not request a confirmation message indicating whether a text message was successfully sent to the recipient.

USSD messages USSD (Unstructured Supplementary Service Data) messages can be used to communicate with mobile network provider to receive additional information, enabling additional services or adding funds to prepaid cards. USSD messages can be processed by using AT commands (commands can differ or even may be blocked on some modems). 3G or GSM network modes must be activated to use this functionality , as it's not supported under LTE only mode ( modem auto switches to 3G R11e-LTE mode to send out USSD message). PDU (Protocol Data Unit) message and its decrypted version are printed under LTE debug logging. Example Check if LTE debug logging is active: /system logging print Flags: X - disabled, I - invalid, * - default # TOPICS ACTION PREFIX 0 * info memory 1 * error memory 2 * warning memory 3 * critical echo If there is no logging entry add it by running this command: /system logging add topics=lte,!raw /system logging print Flags: X - disabled, I - invalid, * - default # TOPICS ACTION PREFIX 0 * info memory 1 * error memory 2 * warning memory 3 * critical echo 4 lte,!raw memory To receive account status from *245# /interface lte at-chat lte1 input="AT+CUSD=1,\"*245#\",15" output: OK /log print 11:51:20 lte,async lte1: sent AT+CUSD=1,"*245#",15 11:51:20 lte,async lte1: rcvd OK 11:51:23 lte,async,event +CUSD: 0,"EBB79B1E0685E9ECF4BADE9E03", 0 11:51:23 gsm,info USSD: konta atlikums Receiving RouterOS also supports receiving of SMS messages, can execute scripts, and even respond to the sender. Before the router can receive SMS, the relevant configuration is required in the menu. The following parameters are configurable: /tool sms Parameter Description allowed-number (st ; Default: "")ringThe sender number that will be allowed to run commands, must specify the country code ie. +371XXXXXXX channel ( ; integer Default: )0Which modem channel to use for receiving.

keep-max-sms (int ; Default: ) eger 0Maximum number of messages that will be saved. If you set this bigger than SIM supports, new messages will not be received. Replaced with parameter starting from RouterOS v6.44.6 auto-erase auto-erase (yes | ; Default: ) no noSIM storage size is read automatically. When new SMS will not be received if storage is full. Set auto-erase=no auto- to delete the oldest received SMS to free space for new ones automatically. Available starting from v6.44.6 erase=yes port ( ; string Default: ( )) unknownModem port (modem can be used only by one process "/port> print" ) receive-enabled (y ; Default: ) es | no noMust be turned on to receive messages secret ( ; string Default: "")the secret password, mandatory polling ( ; yes | no Default: )nochecking the modem for new SMS every 10s, instead of updating the inbox only after receiving the command from the modem. Available starting from v7.16 Basic Example configuration to be able to view received messages: /tool sms set receive-enabled=yes port=lte1 /tool/sms/print status: running receive-enabled: yes port: lte1 channel: 0 secret: allowed-number: auto-erase: no sim-pin: last-ussd: Inbox /tool sms inbox If you have enabled the reader, you will see incoming messages in this submenu: Read-only properties: Property Description phone ( ) string Senders phone number. message ( ) string Message body timestamp ( )time The time when the message was received. It is the time sent by the operator, not the router's local time. type ( ) string Message type Syntax :cmd SECRET script NAME [[ VAR[=VAL] ] ... ] SECRET - the password NAME - the name of the script that's available in " " /system script VAR - variables that will be passed to the script (can be passed as VAR or as VAR=value), separated by spaces. Other things to remember: *Parameters can be put into quotes "VAR"="VAL" if necessary.

*Escaping of values is not supported (VAR="\""). *Combined SMS are not supported, every SMS will be treated separately * 16Bit unicode messages are not supported * SMS are decoded with the standard GSM7 alphabet, so you can't send in other encodings, otherwise it will be decoded incorrectly Examples Wrong: :cmd script mans_skripts :cmd slepens script mans skripts :cmd slepens script mans_skripts var= :cmd slepens script mans_skripts var= a :cmd slepens script mans_skripts var=a a Right: :cmd slepens script mans_skripts :cmd slepens script "mans skripts" :cmd slepens script mans_skripts var :cmd slepens script mans_skripts var=a :cmd slepens script mans_skripts var="a a" Debugging /tool sms send command is logging data that is written and read. It is logged with tags gsm,debug,write and gsm,debug,read For more information see system logging . Implementation details AT+CMGS and AT+CMGF commands are used. Port is acquired for the duration of the command and cannot be used concurrently by another RouterOS component. Message sending process can take a long time, it times out after a minute and after two seconds during the initial AT command exchange.

Dual SIM Application Summary Initial settings Roaming script example Failover script example Setting up scheduler Summary The first script example shows how to switch between SIM slots in case mobile roaming is detected for LtAP mini devices. This could be useful for mobile vehicle applications, where cars, buses or trains could drive abroad and should use two SIM cards (one for a home network, other for a roaming network). Since RouterOS has a roaming status in the LTE monitor (displayed only when roaming) we can use this in RouterOS scripts to change SIM cards accordingly. The second script example shows how to switch between the SIM cards in case a mobile connection is lost on the currently selected one. Note: Keep in mind that these are just examples of how to utilize dual SIM slots. For real-life production environments, proper testing should be carried out, so try to optimize them and add new features according to your needs. Initial settings First, make sure you have correctly set up LTE network parameters (provided by the mobile network operator) for each SIM card. You can use the default APN profile or create two separate ones, follow this link - . This example uses the default APN profile. LTE#Quicksetupexample After that, enable data roaming for connecting to other countries data-providers with the following command. This allows us to keep track of roaming status. /interface lte set [find name=lte1] allow-roaming=yes Then, choose which SIM slots will be used for home and roaming networks. In this example, we use slot "down" for home and slot "up" for roaming network. Use the following command to switch between active slots. command for sim slot selection changes in v6.45.1. And some device models like SXT, have SIM slots named "a" and "b" instead of "up" and down" Note: Command for pre 6.45.1: /system routerboard sim set sim-slot=down Command after 6.45.1: /system routerboard modem set sim-slot=down Command in RouterOS v7 version: /interface lte settings set sim-slot=down After changing SIM slots, LTE modem will be restarted. It can take some time (depending on the modem and board around 30 seconds) to fully initialize it, so make sure you test your modem. Roaming script example Now create a script that will run with a scheduler. This script will go through a few key points: Check if the LTE interface is initialized (shown in ), otherwise, try a power reset /interface lte Check if an LTE connection is established (the interface is in a "running" state), otherwise create a log entry and simply wait for the next scheduler Read the currently used LTE slot and decide whether to change SIM slots based on roaming status Let's call this script "roamingScript", and see below the source:

{ # Setup and read current values, "up" SIM slot will be used for roaming, "down" for home network :global simSlot [/system routerboard sim get sim-slot] :global timeoutLTE 60 :global timeoutConnect 60 # Wait for LTE to initialize for maximum "timeoutLTE" seconds :local i 0 :local isLTEinit false :while ($i<$timeoutLTE) do={ :foreach n in=[/interface lte find] do={:set $isLTEinit true} :if ($isLTEinit=true) do={ :set $i $timeoutLTE } :set $i ($i+1) :delay 1s } # Check if LTE is initialized, or try power-reset the modem :if ($isLTEinit=true) do={ # Wait for LTE interface to connect to mobile network for maximum "timeoutConnet" seconds :local isConnected false :set $i 0 :while ($i<$timeoutConnect) do={ :if ([/interface lte get [find name="lte1"] running]=true) do={ :set $isConnected true :set $i $timeoutConnect } :set $i ($i+1) :delay 1s } # Check if LTE is connected if ($isConnected=true) do={ :local Info [/interface lte monitor lte1 once as-value] :local isRoaming ($Info->"roaming") # Check which SIM slot is used :if ($simSlot="down") do={ # If "down" (home) slot, check roaming status :if ($isRoaming=true) do={ :log info message="Roaming detected, switching to SIM UP (Roaming)" /system routerboard sim set sim-slot=up } } else={ # Else "up" (roaming) slot, check roaming status :if (!$isRoaming=true) do={ :log info message="Not roaming, switching to SIM DOWN (Home)" /interface lte settings set sim-slot=down } } } else={ :log info message="LTE interface did not connect to network, wait for next scheduler" } } else={ :log info message="LTE modem did not appear, trying power-reset" /system routerboard usb power-reset duration=5s } } Failover script example Now create a script that will run with a scheduler. This script will go through a few key points: Check if the LTE interface is initialized (shown in ), otherwise, try a power reset /interface lte Check if an LTE connection is established (the interface is in a "running" state), otherwise, create a log entry and simply wait for the next scheduler Read the currently used LTE slot and make a decision whether to change SIM slots based on interface status Note: Keep in mind that the SIM slot will only be changed if the current one is not able to connect to the network if you need to switch back to the main SIM card you need to schedule another action that does it at a certain time. It is not possible to know if the other SIM card is in service without switching back to it. Let's call this script "failoverScript", and see below the source:

{ # Setup and read current values :global simSlot [/system routerboard modem get sim-slot] :global timeoutLTE 60 :global timeoutConnect 60 # Wait for LTE to initialize for maximum "timeoutLTE" seconds :local i 0 :local isLTEinit false :while ($i<$timeoutLTE) do={ :foreach n in=[/interface lte find] do={:set $isLTEinit true} :if ($isLTEinit=true) do={ :set $i $timeoutLTE } :set $i ($i+1) :delay 1s } # Check if LTE is initialized, or try power-reset the modem :if ($isLTEinit=true) do={ # Wait for LTE interface to connect to mobile network for maximum "timeoutConnet" seconds :local isConnected false :set $i 0 :while ($i<$timeoutConnect) do={ :if ([/interface lte get [find name="lte1"] running]=true) do={ :set $isConnected true :set $i $timeoutConnect } :set $i ($i+1) :delay 1s } # Check if LTE is connected if ($isConnected=false) do={ # Check which SIM slot is used :if ($simSlot="down") do={ # If "down" slot, switch to up :log info message="LTE down, switching slot to UP" /interface lte settings set sim-slot=up } :if ($simSlot="up") do={ # If "up" slot, switch to down :log info message="LTE down, switching slot to DOWN" /interface lte settings set sim-slot=down } } else={ # Else "running" :if ($isConnected=true) do={ :log info message="LTE UP" } else={ :log info message="LTE interface did not connect to network, wait for next scheduler" } } } else={ :log info message="LTE modem did not appear, trying power-reset" /system routerboard usb power-reset duration=5s } } Setting up scheduler Last, create your scheduler that will run the previously created script. Choose a proper scheduler interval, so two or more events do not overlap with each other. For this example above, 3 minutes will be enough. /system scheduler add interval=3m on-event=roamingScript name=Roaming /system scheduler add interval=3m on-event=failoverScript name=Failover Keep in mind that a "home" SIM card will consume some roaming data because changing SIM slots does not happen instantly.

Multi Protocol Label Switching - MPLS In This Section:

MPLS Overview Overview Supported Features Overview MPLS stands for MultiProtocol Label Switching. It kind of replaces IP routing - packet forwarding decision (outgoing interface and next-hop router) is no longer based on fields in IP header (usually destination address) and routing table, but on labels that are attached to packet. This approach speeds up the forwarding process because next-hop lookup becomes very simple compared to routing lookup (finding the longest matching prefix). The efficiency of the forwarding process is the main benefit of MPLS, but it must be taken into account that MPLS forwarding disables the processing of network layer (e.g. IP) headers, therefore no network layer-based actions like NAT and filtering can be applied to MPLS forwarded packets. Any network- layer-based actions should be taken on ingress or egress of MPLS cloud, with the preferred way being ingress - this way, e.g. traffic that is going to be dropped anyway does not travel through the MPLS backbone. In the simplest form, MPLS can be thought of as improved routing - labels are distributed by means of LDP protocol for routes that are active and a labeled packet takes the same path it would take if it was not labeled. A router that routes unlabeled packets using some route for which it has received a label from the next hop, imposes a label on the packet, and sends it to the next hop - gets MPLS switched further along its path. A router that receives a packet with a label it has assigned to some route changes the packet label with one received from the next hop of a particular route and sends a packet to the next hop. Label switched path ensures delivery of data to the MPLS cloud egress point. Applications of MPLS are based on this basic MPLS concept of label switched paths. Another way of establishing label switching paths is traffic engineering tunnels (TE tunnels) by means of the RSVP-TE protocol. Traffic engineering tunnels allow explicitly routed LSPs and constraint-based path selection (where constraints are interface properties and available bandwidth). Taking into account the complexity, new protocols, and applications that MPLS introduces and the differences of concepts that MPLS adds to routed /bridged networks, it is recommended to have an in-depth understanding of MPLS concepts before implementing MPLS in a production network. Some suggested reading material: Multiprotocol Label Switching http://en.wikipedia.org/wiki/Multiprotocol_Label_Switching RFC3031 Multiprotocol Label Switching Architecture http://www.ietf.org/rfc/rfc3031.txt MPLS Fundamentals by Luc De Ghein http://www.amazon.com/MPLS-Fundamentals-Luc-Ghein/dp/1587051974 Supported Features Currently, RouterOS supports the following MPLS related features: MPLS switching with penultimate hop popping support static local label bindings for IPv4 and IPv6 static remote label bindings for IPv4 and IPv6 Label Distribution Protocol (RFC 3036, RFC 5036 ) for IPv4 and IPv6 , and RFC 7552 downstream unsolicited label advertisement independent label distribution control liberal label retention targeted session establishment optional loop detection ECMP support Virtual Private Lan Service VPLS LDP signaling (RFC 4762) Cisco style static VPLS pseudowires (RFC 4447 FEC type 0x80) VPLS pseudowire fragmentation and reassembly (RFC 4623) VPLS MP-BGP based autodiscovery and signaling (RFC 4761) Cisco VPLS BGP-based auto-discovery (draft-ietf-l2vpn-signaling-08) support for multiple import/export route-target extended communities for BGP based VPLS (both, RFC 4761 and draft-ietf-l2vpn- signaling-08) RSVP-TE Tunnels tunnel head-end Feature is not supported on SMIPS devices (hAP lite, hAP lite TC and hAP mini).

explicit paths OSPF extensions for TE tunnels CSPF path selection forwarding of VPLS and MPLS IP VPN traffic on TE tunnels Ingress TE tunnel rate limit and automatic reserved bandwidth adjustment, see TE Tunnel Bandwidth Control all tunnel bandwidth settings are specified and displayed in bits per second MP-BGP based MPLS IP VPN Per-prefix and per-vrf label distribution policies for MP-BGP based MPLS VPN OSPF extensions for MPLS TE support for OSPF as CE-PE protocol ping and traceroute for specified VRF control over network-layer TTL propagation in MPLS RIP as CE-PE protocol per-VRF BGP instance redistribution settings MPLS features that RouterOS DOES NOT HAVE yet: LDP features: downstream on-demand label advertisement ordered label distribution control conservative label retention TE features fast-reroute link/node protection Support for BGP as label distribution protocol

MPLS MTU, Forwarding and Label Bindings Label Range and TTL From the menu it is possible to assign specific dynamic label range and TTL propagation. If for some reason static label mapping is /mpls settings used then the dynamic range can be adjusted to exclude statically assigned label numbers from being dynamically assigned by any of the label distribution protocols. Property Description dynamic-label-range (range of ; Default: integer[16..1048575] ) 16-1048575Range of Label numbers used for dynamic allocation. The first 16 labels are reserved for special purposes (as defined in RFC). If you intend to configure labels statically then adjust the dynamic default range not to include numbers that will be used in a static configuration. propagate-ttl ( ; Default: yes | no )yesWhether to copy TTL values from IP header to MPLS header. If this option is set to then hops inside the MPLS no cloud will be invisible from traceroutes. allow-fast-path( yes | no ; Default: yes)Enable/disable MPLS fast-path support. MPLS MTU Configuration of MPLS MTU (path MTU + MPLS tag size) is useful in cases when there is a large variety of possible MTUs along the path. Configuring MPLS MTU to a minimum value that can pass all the hops will ensure that the MPLS packet will not be silently dropped on the devices that do not support big enough MTU. MPLS MTUs are configured from the menu. /mpls interface [admin@rack1_b35_CCR1036] /mpls/interface> print Flags: X - disabled; * - builtin 0 ;;; router-test interface=ether1 mpls-mtu=1580 input=yes 1 ;;; router-test interface=ether2 mpls-mtu=1580 input=yes 2 interface=all mpls-mtu=1500 Properties Property Description comment ( ; Default: ) string Short description of the interface disabled ( ; Default: ) yes | no no If set to then this configuration is ignored. yes interface ( ; Default:) name Name of the interface or interface-list to match. input ( ; Default: ) yes | no yes Whether to allow MPLS input on the interface mpls-mtu ( ; Default: ) integer [512..65535] 1508 The option represents how big packets can be carried over the interface with added MPLS labels. The order of the entries is important due to the possibility that different interface lists can contain the same interface and in addition, that interface can be referenced directly. Listed entries are ordered, and the first entry (iterating from the top to the bottom) that matches the interface will be used.

Selection of the MPLS MTU happens in the following manner: If the interface matched the entry from this table, then try to use configured MPLS MTU value If the interface does not match any entry then consider MPLS MTU equal to L2MTU If the interface does not support L2MTU, then consider MPLS MTU equal to L3 MTU On the MPLS ingress path, MTU is chosen by min(MPLS MTU - tagsize, l3mtu). This means that on interfaces that do not support L2MTU and default L3 MTU is set to 1500, max path MTU will be 1500 - tag size (the interface will not be able to pass full IP frame without fragmentation). In such scenarios, L3MTU must be increased by max observed tag size. Read more on MTUs in the article. MTU in RouterOS Forwarding Table Entries in the menu show label bindings for specific routes that will be used in MPLS label switching. Properties in this menu /mpls forwarding-table are read-only. [admin@rack1_b35_CCR1036] /mpls/forwarding-table> print Flags: L, V - VPLS Columns: LABEL, VRF, PREFIX, NEXTHOPS # LABEL VRF PREFIX NEXTHOPS 0 L 16 main 10.0.0.0/8 { nh=10.155.130.1; interface=ether12 } 1 L 18 main 111.111.111.3 { label=impl-null; nh=111.12.0.1; interface=ether2 } 2 L 17 main 111.111.111.2 { label=impl-null; nh=111.11.0.1; interface=ether1 } Property Description prefix ( ) IP/Mask Destination prefix for which labels are assigned label ( ) integer Ingress MPLS label ldp ( ) yes | no Whether labels are signaled LDP nexthops () An array of the next-hops, each entry in the array represents one ECMP next-hop. Array entry can contain several parameters: label - egress MPLS label nh - out next-hop IP address interface - out the interface out-label ( ) integer Label number which is added or switched to for outgoing packet. packets ( ) integer Number of packets matched by this entry te-sender te-session traffic-eng Shows whether the entry is signaled by RSVP-TE (Traffic Engineering) type (string) Type of the entry, for example, "vpls", etc. vpls ( ) yes | no Shows whether the entry is used for tunnels. VPLS vpn vrf Name of the VRF table this entry belongs to

EXP bit and MPLS Queuing Overview When the MPLS label is attached to the packet, it increases packet length by 32 bits (4 bytes). These 32 bits are broken down as follows: label value itself (20 bits) EXP ("experimental") field (3 bits) time to live field (8 bits) bottom of stack field (1 bit) The use of "experimental" bits is not specified by MPLS standards, but the most common use is to carry QoS information, similar to 802.1q priority in the VLAN tag. Note that the EXP field is 3 bits only therefore it can carry values from 0 to 7 only, which allows having 8 traffic classes. EXP field treatment in RouterOS When RouterOS receives an MPLS packet, it sets the "ingress priority" value for the packet to that carried inside the top label. Note that "ingress priority" is a field inside packet headers - it can be thought of as an additional mark assigned to a packet while being processed by the router. When RouterOS not labels an MPLS packet, it sets EXP bits to "priority" (not "ingress priority"!) assigned to the packet. When RouterOS switches MPLS packet, "ingress priority" is automatically copied to "priority", this way regular MPLS switching communicates priority info over the whole label switched path. Additional info on "ingress priority" and "priority" handling is also in . WMM and VLAN priority Therefore what happens to the EXP field depends based on what action is taken on the packet: if the packet is MPLS switched (by popping the label off the packet and pushing on the new one), the EXP field in the new label will be the same as in the received label, because: RouterOS sets "ingress priority" to EXP bits in the received label Switching automatically sets "priority" to "ingress priority" RouterOS labels the packet with a new label and sets its EXP bits to value in "priority". if the packet is MPLS switched by using penultimate-hop-popping (the received label is popped off and no new one is pushed on), the EXP field of received priority stays in the "priority" field of the packet and may be used by some other MAC protocol, e.g. WMM or 802.1q VLAN, for example: RouterOS sets "ingress priority" to EXP bits in the received label Switching automatically sets "priority" to "ingress priority" RouterOS switches the packet to the next hop (without pushing on the label) and that happens over the VLAN interface VLAN interface sets 802.1q priority in the VLAN header to the "priority" value of the packet. Note that penultimate-hop-popping can therefore lose QoS information carried over label switched path at the last hop. In cases where this is not desirable, penultimate-hop-popping behavior should be disabled by using the Explicit NULL label instead of the Implicit NULL label for the last hop in the label switched path. Using an Explicit NULL label for the last hop is the default behavior for MPLS TE tunnels. if a packet is supposed to be sent over label switched path (the first label will get pushed on the packet), EXP bits will be set to value in "priority", which in turn can be set up properly using firewall rules or other means (e.g. from DSCP field in IP header) if a packet is received for local processing, "ingress priority" is set to the EXP field of the received packet and can therefore be used to update the DSCP field of the packet or set "priority" from "ingress priority" using firewall rules MPLS Mangle and Queuing RouterOS firewall works only with IP traffic, which means that it is not possible to mark MPLS packets directly in mangle and limit by queues. Queuing had to be done on ingress edge router before MPLS header is added or on egress edge router after MPLS label is removed. Starting from ROS v7.17 MPLS Mangle is added. This allows to add packet mark based on exp bit, or change the assigned exp bit on label switching (P) routers or on PE output after MPLS encapsulation. This configuration is accessible from menu. /mpls/mangle Basic Example Lets look at very basic example where on the label switching router (P) along the LSP we want to mark packets with exp bit 0, limit the bandwidth and change exp bit to 3:

/mpls mangle add chain=forward exp=0 set-exp=3 set-mark=m0 /queue tree add limit-at=10M max-limit=10M name=mpls_queue packet-mark=m0 parent=sfp-sfpplus2 Keep in mind that MPLS packets cannot be queued with queues that are using IMQ interfaces (simple queue, queue tree global), so we need to use queue tree with "real" interface as a parent. MPLS Mangle table also shows matched packet count that is useful for setup debugging: [admin@CCR2004_2XS_111] /mpls/mangle> print Flags: X - DISABLED Columns: CHAIN, EXP, SET-EXP, SET-MARK, PACKETS # CHAIN EXP SET-EXP SET-MARK PACKETS 0 forward 0 3 m0 221 654 Another important thing is that MPLS mangle rules are not executed line by line like regular firewall mangle rules, MPLS Mangle is a set of actions that are applied in one go. For example, lets look at the set of rules /mpls mangle add chain=forward exp=0 set-mark=m0 add chain=forward exp=0 set-exp=3 add chain=forward exp=3 set-mark=m3 In this example, if incoming packet has exp bit 0, third rule will have no effect. And once the action is set for specific exp bit it cannot be modified by another rules: [admin@CCR2004_2XS_111] /mpls/mangle> add chain=forward exp=0 set-mark=m4 failure: conflicting forward set-mark rule

As LDP distributes labels for active routes, the essential requirement is properly configured IP routing. LDP by default distributes labels for active IGP routes (that is - connected, static, and routing protocol learned routes, except BGP). For instructions on how to set up properly IGP refer to appropriate documentation sections: OSPF Static Routing etc LDP supports ECMP routes. You should be able to reach any loopback address from any location of your network before continuing with the LDP configuration. Connectivity can be verified with the ping tool running from loopback address to loopback address. Example Setup Let's consider that we have already existing four routers setup, with working IP connectivity. (lo:111.111.111.1) (lo:111.111.111.2) (lo:111.111.111.3) (lo:111.111.111.4) |---------R1-----(111.11.0.0/24)-----R2-----(111.12.0.0/24)-----R3-----(111.13.0.0/24)-----R4---------| Ip Reachability Not going deep into routing setup here is the quit export of the IP and OSPF configurations:

Verify that IP connectivity and routing are working properly [admin@R4] /ip/address> /tool traceroute 111.111.111.1 src-address=111.111.111.4 Columns: ADDRESS, LOSS, SENT, LAST, AVG, BEST, WORST, STD-DEV # ADDRESS LOSS SENT LAST AVG BEST WORST STD-DEV 1 111.13.0.1 0% 4 0.6ms 0.6 0.6 0.6 0 2 111.12.0.1 0% 4 0.5ms 0.6 0.5 0.6 0.1 3 111.111.111.1 0% 4 0.6ms 0.6 0.6 0.6 0 LDP Setup In order to start distributing labels, LDP is enabled on interfaces that connect other LDP routers and not enabled on interfaces that connect customer networks. On R1 it will look like this: /mpls ldp add afi=ip lsr-id=111.111.111.1 transport-addresses=111.111.111.1 /mpls ldp interface add interface=ether2 Other routers are set up similarly. R2: /mpls ldp add afi=ip lsr-id=111.111.111.2 transport-addresses=111.111.111.2 /mpls ldp interface add interface=ether2 add interface=ether3 On R3: /mpls ldp add afi=ip lsr-id=111.111.111.3 transport-addresses=111.111.111.3 /mpls ldp interface add interface=ether2 add interface=ether3 On R4: /mpls ldp add afi=ip lsr-id=111.111.111.4 transport-addresses=111.111.111.4 /mpls ldp interface add interface=ether2 Note that the transport address gets set to 111.111.111.1. This makes the router originate LDP session connections with this address and also advertise this address as a transport address to LDP neighbors.

After LDP sessions are established, R2 should have two LDP neighbors: [admin@R2] /mpls/ldp/neighbor> print Flags: D, I - INACTIVE; O, T - THROTTLED; p - PASSIVE Columns: TRANSPORT, LOCAL-TRANSPORT, PEER, ADDRESSES # TRANSPORT LOCAL-TRANSPORT PEER ADDRESSES 0 DO 111.111.111.1 111.111.111.2 111.111.111.1:0 111.11.0.1 111.111.111.1 1 DOp 111.111.111.3 111.111.111.2 111.111.111.3:0 111.12.0.2 111.13.0.1 111.111.111.3 The local mappings table shows what label is assigned to what route and peers the router have distributed labels to. [admin@R2] /mpls/ldp/local-mapping> print Flags: I - INACTIVE; D - DYNAMIC; E - EGRESS; G - GATEWAY; L - LOCAL Columns: VRF, DST-ADDRESS, LABEL, PEERS # VRF DST-ADDRESS LABEL PEERS 0 D G main 10.0.0.0/8 16 111.111.111.1:0 111.111.111.3:0 1 IDE L main 10.155.130.0/25 impl-null 111.111.111.1:0 111.111.111.3:0 2 IDE L main 111.11.0.0/24 impl-null 111.111.111.1:0 111.111.111.3:0 3 IDE L main 111.12.0.0/24 impl-null 111.111.111.1:0 111.111.111.3:0 4 IDE L main 111.111.111.2 impl-null 111.111.111.1:0 111.111.111.3:0 5 D G main 111.111.111.1 17 111.111.111.1:0 111.111.111.3:0 6 D G main 111.111.111.3 18 111.111.111.1:0 111.111.111.3:0 7 D G main 111.111.111.4 19 111.111.111.1:0 111.111.111.3:0 8 D G main 111.13.0.0/24 20 111.111.111.1:0 111.111.111.3:0 Remote mappings table on the other hand shows labels that are allocated for routes by neighboring LDP routers and advertised to this router:

[admin@R2] /mpls/ldp/remote-mapping> print Flags: I - INACTIVE; D - DYNAMIC Columns: VRF, DST-ADDRESS, NEXTHOP, LABEL, PEER # VRF DST-ADDRESS NEXTHOP LABEL PEER 0 ID main 10.0.0.0/8 16 111.111.111.1:0 1 ID main 10.155.130.0/25 impl-null 111.111.111.1:0 2 ID main 111.11.0.0/24 impl-null 111.111.111.1:0 3 ID main 111.12.0.0/24 17 111.111.111.1:0 4 D main 111.111.111.1 111.11.0.1 impl-null 111.111.111.1:0 5 ID main 111.111.111.2 19 111.111.111.1:0 6 ID main 111.111.111.3 20 111.111.111.1:0 7 ID main 111.111.111.4 21 111.111.111.1:0 8 ID main 111.13.0.0/24 18 111.111.111.1:0 9 ID main 0.0.0.0/0 impl-null 111.111.111.3:0 10 ID main 111.111.111.2 16 111.111.111.3:0 11 ID main 111.111.111.1 18 111.111.111.3:0 12 D main 111.111.111.3 111.12.0.2 impl-null 111.111.111.3:0 13 D main 111.111.111.4 111.12.0.2 19 111.111.111.3:0 14 ID main 10.155.130.0/25 impl-null 111.111.111.3:0 15 ID main 111.11.0.0/24 17 111.111.111.3:0 16 ID main 111.12.0.0/24 impl-null 111.111.111.3:0 17 D main 111.13.0.0/24 111.12.0.2 impl-null 111.111.111.3:0 We can observe that router has received label bindings for all routes from both its neighbors - R1 and R3. The remote mapping table will have active mappings only for the destinations that have direct next-hop, for example, let's take a closer look at 111.111.111.4 mappings. The routing table indicates that the network 111.111.111.4 is reachable via 111.12.0.2 (R3): [admin@R2] /ip/route> print where dst-address=111.111.111.4 Flags: D - DYNAMIC; A - ACTIVE; o, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAo 111.111.111.4/32 111.12.0.2%ether3 110 And if we look again at the remote mapping table, the only active mapping is the one received from R3 with assigned label 19. This implies that when R2 when routing traffic to this network, will impose label 19. 17 D main 111.111.111.4 111.12.0.2 19 111.111.111.3:0 Label switching rules can be seen in the forwarding table: [admin@R2] /mpls/forwarding-table> print Flags: L, V - VPLS Columns: LABEL, VRF, PREFIX, NEXTHOPS # LABEL VRF PREFIX NEXTHOPS 0 L 16 main 10.0.0.0/8 { nh=10.155.130.1; interface=ether1 } 1 L 18 main 111.111.111.3 { label=impl-null; nh=111.12.0.2; interface=ether3 } 2 L 19 main 111.111.111.4 { label=19; nh=111.12.0.2; interface=ether3 } 3 L 20 main 111.13.0.0/24 { label=impl-null; nh=111.12.0.2; interface=ether3 } 4 L 17 main 111.111.111.1 { label=impl-null; nh=111.11.0.1; interface=ether2 } If we take a look at rule number 2, the rule says that when R2 received the packet with label 19, it will change the label to new label 19 (assigned by the R3). As you can see from this example it is not mandatory that labels along the path should be unique.

Now if we look at the forwarding table of R3: [admin@R3] /mpls/forwarding-table> print Flags: L, V - VPLS Columns: LABEL, VRF, PREFIX, NEXTHOPS # LA VRF PREFIX NEXTHOPS 0 L 19 main 111.111.111.4 { label=impl-null; nh=111.13.0.2; interface=ether3 } 1 L 17 main 111.11.0.0/24 { label=impl-null; nh=111.12.0.1; interface=ether2 } 2 L 16 main 111.111.111.2 { label=impl-null; nh=111.12.0.1; interface=ether2 } 3 L 18 main 111.111.111.1 { label=17; nh=111.12.0.1; interface=ether2 } Rule number 0, shows that the out label is " ". The reason for this is that R3 is the last hop before 111.111.111.4 will be reachable and there is no impl-null need to swap to any real label. It is known that R4 is the egress point for the 111.111.111.4 network (router is the egress point for directly connected networks because the next hop for traffic is not MPLS router), therefore it advertises the "implicit null" label for this route. This tells R3 to forward traffic for the destination 111.111.111.4/32 to R4 unlabelled, which is exactly what R3 forwarding table entry tells. Using traceroute in MPLS networks RFC4950 introduces extensions to the ICMP protocol for MPLS. The basic idea is that some ICMP messages may carry an MPLS "label stack object" (a list of labels that were on the packet when it caused a particular ICMP message). ICMP messages of interest for MPLS are Time Exceeded and Need Fragment. MPLS label carries not only label value, but also TTL field. When imposing a label on an IP packet, MPLS TTL is set to value in the IP header, when the last label is removed from the IP packet, IP TTL is set to value in MPLS TTL. Therefore MPLS switching network can be diagnosed by means of a traceroute tool that supports MPLS extension. For example, the traceroute from R4 to R1 looks like this: [admin@R1] /mpls/ldp/neighbor> /tool traceroute 111.111.111.4 src-address=111.111.111.1 Columns: ADDRESS, LOSS, SENT, LAST, AVG, BEST, WORST, STD-DEV, STATUS # ADDRESS LOSS SENT LAST AVG BEST WORST STD-DEV STATUS 1 111.11.0.2 0% 2 0.7ms 0.7 0.7 0.7 0 <MPLS:L=19,E=0> 2 111.12.0.2 0% 2 0.4ms 0.4 0.4 0.4 0 <MPLS:L=19,E=0> 3 111.111.111.4 0% 2 0.5ms 0.5 0.5 0.5 0 Traceroute results show MPLS labels on the packet when it produced ICMP Time Exceeded. The above means: that when R3 received a packet with MPLS TTL 1, it had label 18 on it. This match advertised label by R3 for 111.111.111.4. In the same way, R2 observed label 17 on the packet on the next traceroute iteration - R3 switched label 17 to label 17, as explained above. R1 received packet without labels - R2 did penultimate hop popping as explained above. Drawbacks of using traceroute in MPLS network Label switching ICMP errors One of the drawbacks of using traceroute in MPLS networks is the way MPLS handles produced ICMP errors. In IP networks ICMP errors are simply routed back to the source of the packet that caused the error. In an MPLS network, it is possible that a router that produces an error message does not even have a route to the source of the IP packet (for example in the case of asymmetric label switching paths or some kind of MPLS tunneling, e.g. to transport MPLS VPN traffic). Due to this produced ICMP errors are not routed to the source of the packet that caused the error but switched further along the label switching path, assuming that when the label switching path endpoint will receive an ICMP error, it will know how to properly route it back to the source. Action, when the label is not swapped to any real label, is called it ensures that routers do not have to do Penultimate hop popping, unnecessary label lookup when it is known in advance that the router will have to route the packet.

This causes the situation, that traceroute in MPLS network can not be used the same way as in IP network - to determine failure point in the network. If the label switched path is broken anywhere in the middle, no ICMP replies will come back, because they will not make it to the far endpoint of the label switching path. Penultimate hop popping and traceroute source address A thorough understanding of penultimate hop behavior and routing is necessary to understand and avoid problems that penultimate hop popping causes to traceroute. In the example setup, a regular traceroute from R5 to R1 would yield the following results: [admin@R5] > /tool traceroute 9.9.9.1 ADDRESS STATUS 1 0.0.0.0 timeout timeout timeout 2 2.2.2.2 37ms 4ms 4ms mpls-label=17 3 9.9.9.1 4ms 2ms 11ms compared to: [admin@R5] > /tool traceroute 9.9.9.1 src-address=9.9.9.5 ADDRESS STATUS 1 4.4.4.3 15ms 5ms 5ms mpls-label=17 2 2.2.2.2 5ms 3ms 6ms mpls-label=17 3 9.9.9.1 6ms 3ms 3ms The reason why the first traceroute does not get a response from R3 is that by default traceroute on R5 uses source address 4.4.4.5 for its probes because it is the preferred source for a route over which next-hop to 9.9.9.1/32 is reachable: [admin@R5] > /ip route print Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit # DST-ADDRESS PREF-SRC G GATEWAY DISTANCE INTERFACE ... 3 ADC 4.4.4.0/24 4.4.4.5 0 ether1 ... 5 ADo 9.9.9.1/32 r 4.4.4.3 110 ether1 ... When the first traceroute probe is transmitted (source: 4.4.4.5, destination 9.9.9.1), R3 drops it and produces an ICMP error message (source 4.4.4.3 destination 4.4.4.5) that is switched all the way to R1. R1 then sends ICMP error back - it gets switched along the label switching path to 4.4.4.5. R2 is the penultimate hop popping router for network 4.4.4.0/24 because 4.4.4.0/24 is directly connected to R3. Therefore R2 removes the last label and sends ICMP error to R3 unlabelled: [admin@R2] > /mpls forwarding-table print # IN-LABEL OUT-LABELS DESTINATION INTERFACE NEXTHOP ... 3 19 4.4.4.0/24 ether2 2.2.2.3 ... R3 drops the received IP packet because it receives a packet with its own address as a source address. ICMP errors produced by following probes come back correctly because R3 receives unlabelled packets with source addresses 2.2.2.2 and 9.9.9.1, which are acceptable to a route. Command: [admin@R5] > /tool traceroute 9.9.9.1 src-address=9.9.9.5 ... produces expected results, because the source address of traceroute probes is 9.9.9.5. When ICMP errors are traveling back from R1 to R5, the penultimate hop popping for the 9.9.9.5/32 network happens at R3, therefore it never gets to route packet with its own address as a source address. Optimizing label distribution Label binding filtering

During the implementation of the given example setup, it has become clear that not all label bindings are necessary. For example, there is no need to exchange IP route label bindings between R1 and R3 or R2 and R4, as there is no chance they will ever be used. Also, if the given network core is providing connectivity only for mentioned customer ethernet segments, there is no real use to distribute labels for networks that connect routers between themselves, the only routes that matter are /32 routes to endpoints or attached customer networks. Label binding filtering can be used to distribute only specified sets of labels to reduce resource usage and network load. There are 2 types of label binding filters: which label bindings should be advertised to LDP neighbors, configured in the menu /mpls ldp advertise-filter which label bindings should be accepted from LDP neighbors, configured in menu /mpls ldp accept-filter Filters are organized in the ordered list, specifying prefixes that must include the prefix that is tested against the filter and neighbor (or wildcard). In the given example setup all routers can be configured so that they advertise labels only for routes that allow reaching the endpoints of tunnels. For this 2 advertise filters need to be configured on all routers: /mpls ldp advertise-filter add prefix=111.111.111.0/24 advertise=yes /mpls ldp advertise-filter add prefix=0.0.0.0/0 advertise=no This filter causes routers to advertise only bindings for routes that are included by the 111.111.111.0/24 prefix which covers loopbacks (111.111.111.1/32, 111.111.111.2/32, etc). The second rule is necessary because the default filter results when no rule matches are to allow the action in question. In the given setup there is no need to set up accept filter because by convention introduced by 2 abovementioned rules no LDP router will distribute unnecessary bindings. Note that filter changes do not affect existing mappings, so to take the filter into effect, connections between neighbors need to be reset. either by removing neighbors from the LDP neighbor table or by restarting the LDP instance. So on R2, for example, we get: [admin@R2] /mpls/ldp/remote-mapping> print Flags: I - INACTIVE; D - DYNAMIC Columns: VRF, DST-ADDRESS, NEXTHOP, LABEL, PEER # VRF DST-ADDRESS NEXTHOP LABEL PEER 0 ID main 111.111.111.2 17 111.111.111.3:0 1 ID main 111.111.111.1 16 111.111.111.3:0 2 D main 111.111.111.3 111.12.0.2 impl-null 111.111.111.3:0 3 D main 111.111.111.4 111.12.0.2 18 111.111.111.3:0 4 ID main 111.111.111.2 16 111.111.111.1:0 5 D main 111.111.111.1 111.11.0.1 impl-null 111.111.111.1:0 6 ID main 111.111.111.3 17 111.111.111.1:0 7 ID main 111.111.111.4 18 111.111.111.1:0 LDP on Ipv6 and Dual-Stack links RouterOS implements RFC 7552 to support LDP on dual-stack links. Supported AFIs can be selected by LDP instance, as well as explicitly configured per LDP interface. /mpls ldp add afi=ip,ipv6 lsr-id=111.111.111.1 preferred-afi=ipv6 /mpls ldp interface add interface=ether2 afi=ip add interface=ether3 afi=ipv6

1. 2. 3. 4. 5. 6. The example above enables LDP instance to use IPv4 and IPv6 address families and sets the preference to IPv6 with parameter. LDP preferred-afi interface configuration on the other hand explicitly sets that supports only IPv4 and supports only IPv6. ether2 ether3 The main question occurs how AFI is selected when there are a mix of different AFIs and what if one of the supported AFIs flaps. The logic behind sending hellos is as follows: if an interface has only one AFI: dual-stack element is not sent sends hello only if there is an IP address on the interface from the corresponding AFI. If an interface has both AFIs: dual-stack element is always sent and contains the value from preferred-afi sends hellos on each AFI if a corresponding address is present on the interface. From all received hellos peer determines which AFI to use for connection and for which AFIs to bind and send labels. For LDP to be able to use a specific AFI, receiving hello for that specific AFI is mandatory. Hello packet contains the transport address necessary for proper LDP operation. By comparing received AFI addresses, is determined active/passive role. The logic behind receiving and processing hellos is as follows: if the LDP instance has only one AFI (it means that all interfaces can have only that specific AFI operational): drop hellos from not supported AFI ignore/forget the dual-stack element for the hello packet the role is determined only for this one specific AFI labels are sent only for this one specific AFI if the LDP instance has both AFIs (interfaces can have different combinations of supported AFIs): drop hellos from AFI that are not configured as supported on the interface. ignore/forget the dual-stack element (preference is not taken into account) for hello packets, if an interface has only one supported AFI. drop hello if received preference in dual-stack element does not match configured . preferred-afi If there are changes in hello packets, the existing session is terminated only in case if address family used by labels is changed, otherwise, the session is preserved. Dual-stack element in hello packets is set only if an interface is determined to be dual-stack compatible: Normally such an interface should be able to receive hellos from both AFIs, Before proceeding LDP should wait for hello from the preferred AFI. if hello is received only from one AFI: if hello from preferred AFI is not received then it is considered an error. otherwise, wait for missing hello for x seconds (x = 3 * hello-interval) if missing hello appears within a time interval consider peer to be dual-stack if missing hello did not appear, then consider peer to be single-stack if missing hello appeared after the time interval then restart the session. the dual-stack element indicates that LDP wants to distribute labels for both AFIs. In summary, the following combinations of AFIs and dual-stack element (ds6) are possible assuming that preferred-afi=ipv6: ipv4 - wait X seconds, if no changes, then use the IPv4 LDP session and distribute IPv4 labels ipv4+ds6 - wait for IPv6 hello, dual-stack element indicates that there should be IPv6 ipv6 - wait X seconds, if no changes, then use the IPv6 LDP session and distribute IPv6 labels ipv6+ds6 - use IPv6 LDP session and distribute IPv6 labels ipv4,ipv6 - use IPv6 LDP session and distribute IPv4 and IPv6 labels ipv4,ipv6+ds6 - use IPv6 LDP session and distribute IPv4 and IPv6 labels Property Reference LDP Instance

Sub-menu: /mpls Properties Property Description afi( ip | ipv6 ; Default: ) Determines supported address families by the instance. comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no distribute-for-default ( ; yes | no Default: no) Defines whether to map label for the default route. hop-limit ( ; integer[0..255] Default: )Max hop limit used for loop detection. Works in combination with the loop-detect property. loop-detect ( ; Default: ) yes | no Defines whether to run LSP loop detection. Will not work correctly if not enabled on all LSRs. Should be used only on non-TTL networks such as ATMs. lsr-id (; Default: )IP Unique label switching router's ID. path-vector-limit (; Default: )IP Max path vector limit used for loop detection. Works in combination with the loop-detect property. preferred-afi (ip | ipv6; Default: i )pv6Determining which address family connection is preferred. Value is also set in dual-stack element (if used). transport-addresses (; IP Default: )Specifies LDP session connections origin addresses and also advertises these addresses as transport addresses to LDP neighbors. use-explicit-null ( ; yes | no Default: no) Whether to distribute explicit-null label bindings. vrf( name ; Default: main ) Name of the VRF table this instance will operate on. Interface Sub-menu: /mpls ldp interface Property Description afi( ip | ipv6 ; Default: ) Determines interface address family. Only AFIs that are configured as supported by the instance is taken into account. If the value is not explicitly specified then it is considered to be equal to the instance-supported AFIs. accept-dynamic- neighbors ( ; yes | no Default:)Defines whether to discover neighbors dynamically or use only statically configured in LDP neighbors menu comments ( ; string Default: )Short description of the entry disabled ( ; yes | no Default: ) no hello-interval ( ; string Default: )The interval between hello packets that the router sends out on specified interface/s. The default value is 5s. hold-time ( ; string Default: )Specifies the interval after which a neighbor discovered on the interface is declared as not reachable. The default value is 15s. interface ( ; string Default: )Name of the interface or interface list where LDP will be listening.

transport-addresses (List of ; Default: )IPsUsed transport addresses if differs from LDP Instance settings. Neighbors Sub-menu: /mpls ldp neighbor List of discovered and statically configured LDP neighbors. Properties Property Description comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no send-targeted ( ; Default: ) yes | no Specifies whether to try to send targeted hellos, used for targeted (not directly connected) LDP sessions. transport (; Default: )IP Remote transport address. Read-only Properties Property Description active-connect ( ) yes | no Indicates that active role have been selected and the router is trying to establish the session. addresses ( ) list of IPs List of discovered addresses on the neighbor inactive ( ) yes | no Whether binding is active and can be selected as a candidate for forwarding. dynamic ( ) yes | no Whether entry was dynamically added local-transport ()IP Selected local transport address. on-demand ( ) yes | no Downstream On Demand label distribution operational ( ) yes | no Indicates whether the peer is operational. passive ( ) yes | no Indicates whether the peer is in a passive role. passive-wait ( ) yes | no Indicates whether the peer is in a passive role and currently is waiting for the session to be initialized. path-vector-limit ( ) integer peer ( ) IP:integer LSR-ID and label space of the neighbor sending-targeted-hello ( ) yes | no Whether targeted hellos are being sent to the neighbor. throttled ( ) yes | no Indicates whether session is in throttled state. Session is throttled after initialization failure, max throttle time 120s. used-afi ( ) yes | no Used transport AFI vpls ( ) yes | no Whether neighbor is used by VPLS tunnel Accept Filter Sub-menu: /mpls ldp accept-filter List of label bindings that should be accepted from LDP neighbors. Property Description

accept ( ; Default: ) yes | no no Whether to accept label bindings from the neighbors for the specified prefix. comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no neighbor ( ; Default: ) string Neighbor to which this filter applies. prefix ( ; Default: ) IP/mask Prefix to match. vrf (name; Default: ) Advertise Filter Sub-menu: /mpls ldp advertise-filter List of label bindings that should be advertised to LDP neighbors. Property Description advertise ( ; Default: ) yes | no no Whether to advertise label bindings to the neighbors for the specified prefix. comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no neighbor ( ; Default: ) string Neighbor to which this filter applies. prefix ( ; Default: ) IP/mask Prefix to match. vrf (name; Default: ) Local Mapping Sub-menu: /mpls local-mapping This sub-menu shows labels bound to the routes locally in the router. In this menu also static mappings can be configured if there is no intention to use LDP dynamically. Properties Property Description comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no dst-address ( ; Default: ) IP/Mask Destination prefix the label is assigned to. label ( ; Default: ) integer[0..1048576] | alert | expl-null | expl-null6 | impl-null | none Label number assigned to destination. vrf( name ; Default: main ) Name of the VRF table this mapping belongs to. Read-only Properties Property Description adv-path () inactive ( ) yes | no Whether binding is active and can be selected as a candidate for forwarding. dynamic ( ) yes | no Whether entry was dynamically added

egress ( ) yes | no gateway ( ) yes | no Whether the destination is reachable through the gateway. local ( ) yes | no Whether the destination is locally reachable on the router peers ( ) IP:label_space IP address and label space of the peer to which this entry was advertised. Remote Mapping Sub-menu: /mpls remote-mapping Sub-menu shows label bindings for routes received from other routers. Static mapping can be configured if there is no intention to use LDP dynamically. This table is used to build Forwarding Table Properties Property Description comments ( ; Default: ) string Short description of the entry disabled ( ; Default: ) yes | no no dst-address ( ; Default: ) IP/Mask Destination prefix the label is assigned to. label ( ; Default: ) integer[0..1048576] | alert | expl-null | expl-null6 | impl-null | none Label number assigned to destination. nexthop ( IP; Default: ) vrf( name ; Default: main ) Name of the VRF table this mapping belongs to. Read-only Properties Property Description inactive ( ) yes | no Whether binding is active and can be selected as a candidate for forwarding. dynamic ( ) yes | no Whether entry was dynamically added path ( ) string

arp (disabled | enabled | proxy-arp | ; Default: ) reply-only enabledAddress Resolution Protocol arp-timeout ( ; time interval | auto Default: auto) bridge ( ; Default:) name bridge-cost ( ; integer [1.. ] 200000000 Default: ) Cost of the bridge port. bridge-horizon ( ; none | integer Default: ) noneIf set to bridge horizon will not be used. none bridge-pvid (integer 1..4094) Used to assign port VLAN ID (pvid) for dynamically bridged interface. cisco-static-id (integer [0.. ; Default: ) 4294967295] 0Cisco-style VPLS tunnel ID. comment ( ; Default: ) string Short description of the item disable-running-check ( ; yes | no Default: ) noSpecifies whether to detect if an interface is running or not. If set to interface will always have no the running flag. disabled ( ; Default: ) yes | no yes Defines whether an item is ignored or used. By default VPLS interface is disabled. mac-address ( ; Default: ) MAC mtu ( ; Default: integer [32..65536] 15 )00 name ( ; Default: ) string Name of the interface pw-l2mtu ( ; integer [0..65536] Default: ) 1500L2MTU value advertised to a remote peer. pw-type (raw-ethernet | tagged- ; Default: ) ethernet | vpls raw-ethernetPseudowire type. peer (; Default: )IP The IP address of the remote peer. pw-control-word (disabled | enabled ; Default: ) | default defaultEnables/disables Control Word usage. Default values for regular and cisco style VPLS tunnels differ. Cisco style by default has control word usage disabled. Read more in the article. VPLS Control Word vpls-id ( ; Default: ) AsNum | AsIp A unique number that identifies the VPLS tunnel. Encoding is 2byte+4byte or 4byte+2byte number. Read-only properties Property Description cisco-bgp-signaled ( ) yes | no vpls ( ) string name of the used to create dynamic vpls interface bgp-vpls instance bgp-signaled bgp-vpls bgp-vpls-prfx dynamic ( ) yes | no l2mtu (integer) running ( ) yes | no Monitoring

Command will display the current VPLS interface status /interface vpls monitor [id] For example: [admin@10.0.11.23] /interface vpls> monitor vpls2 remote-label: 800000 local-label: 43 remote-status: transport: 10.255.11.201/32 transport-nexthop: 10.0.11.201 imposed-labels: 800000 Available read-only properties: Property Description imposed-label ( ) integer VPLS imposed label local-label ( ) integer Local VPLS label remote-group () remote-label ( ) integer Remote VPLS label remote-status ( ) integer transport-nexthop ( ) IP prefix Shows used transport address (typically Loopback address). transport ( ) string Name of the transport interface. Set if VPLS is running over the Traffic Engineering tunnel.

VPLS Control Word Summary VPLS allows remote sites to share an Ethernet broadcast domain by connecting sites through tunnels over a packet switching network pseudo-wires(PW) (PSN). Since VPLS encapsulation adds additional overhead, each interface in LSP should be able to transmit a large enough packet. Each ethernet chipset has hardware limitations on the maximum packet size that it can transmit. Even now there are Ethernets that support only one Vlan tag, meaning that the maximum packet size without Ethernet header and checksum (L2MTU) is 1504 bytes. Obviously, it is not enough to forward VPLS encapsulated Ethernet frame without fragmentation (at least 1524 L2MTU support is required). See for maximum supported L2MTUs on MTU in RouterOS RouterBOADs. Since not even all RouterBOARDs support enough L2MTU to transmit VPLS encapsulated packet without fragmentation, RouterOS has added Pseudowire Fragmentation and Reassembly (PWE3) support according to RFC 4623 using 4-byte . Control Word (CW) Control Word Usage In RouterOS, Control Word is used for packet fragmentation and reassembly inside the VPLS tunnel and is done by utilizing optional Control Word (CW) . CW is added between PW label (demultiplexor) and packet payload and adds an additional 4-byte overhead. CW usage is controlled by the of parameter in VPLS configuration. use-control-word As you can see is divided into 5 fields: Control Word 0000 - 4-bits identifies that the packet is PW (not IP) Flags - 4bits Frag - 2bits value that indicates payload fragmentation. Len - 6bits Seq - 16bits sequence number used to detect packet loss / misordering. Reordering OOO packets are not implemented, out of order fragments will be dropped

According to RFC generation and processing of sequence numbers is optional.

Traffic Eng Properties Sub-menu: /interface traffic-eng Property Description affinity-exclude ( ; Default: integer not )setDo not use interface if matches any of specified bits. resource-class affinity-include-all ( ; Default: integer no )t setUse interface only if matches all of specified bits. resource-class affinity-include-any ( ; Default: integer n ) ot setUse interface if matches any of specified bits. resource-class auto-bandwidth-avg-interval ( ; time Default: ) 5mInterval in which actual amount of data is measured, from which average bandwidth is calculated. auto-bandwidth-range (Disabled | Min ; Default: ) [bps][-Max[bps]] 0bpsAuto bandwidth adjustment range. Read more >> auto-bandwidth-reserve ( ; integer[%] Default: ) 0%Specifies percentage of additional bandwidth to reserve. Read more >> auto-bandwidth-update-interval ( ; time Default: ) 1hInterval during which tunnel keeps track of highest average rate. bandwidth ( ; Default: ) integer[bps] 0bps How much bandwidth to reserve for TE tunnel. Value is in bits per second. Read more >> bandwidth-limit ( ; disabled | integer[%] Default: ) disabledDefines actual bandwidth limitation of TE tunnel. Limit is configured in percent of specified tunnel bandwidth . Read more >> comment ( ; Default: ) string Short description of the item disable-running-check ( ; yes | no Default: ) noSpecifies whether to detect if interface is running or not. If set to interface will always have flag. no running disabled ( ; Default: ) yes | no yes Defines whether item is ignored or used. from-address ( ; Default: ) auto | IP auto Ingress address of the tunnel. If set to least IP address is picked. auto holding-priority ( ; Default: integer [0..7] ) not setIs used to decide whether this session can be preempted by another session. 0 sets the highest priority. mtu ( ; Default: ) integer 1500 Layer3 Maximum Transmission Unit name ( ; Default: ) string Name of the interface primary-path ( ; Default: ) string Primary label switching paths defined in menu. /mpls traffic-eng tunnel-path primary-retry-interval ( ; Default:time 1m )Interval after which tunnel will try to use primary path. record-route ( ; Default: ) yes | no not set If enabled, the sender node will receive information about the actual route that the LSP tunnel traverses. Record Route is analogous to a path vector, and hence can be used for loop detection. reoptimize-interval ( ; Default:time not )setInterval after which tunnel will re-optimize current path. If current path is not the best path then after optimization best path will be used. Read more >> secondary-paths ( ; string[,string] Default: )List of label switching paths used by TE tunnel if primary path fails. Paths are defined in /mpls traffic- menu. eng tunnel-path

setup-priority ( ; Default: integer[0..7] n ) ot setParameter is used to decide whether this session can preempt another session. 0 sets the highest priority. to-address (; Default: ) IP 0.0.0.0 Remote end of TE tunnel. Monitoring To verify TE tunnel's status command can be used. monitor /interface traffic-eng monitor 0 tunnel-id: 12 primary-path-state: on-hold secondary-path-state: established secondary-path: static active-path: static active-lspid: 3 active-label: 66 explicit-route: "S:192.168.55.10/32,L:192.168.55.13/32,L:192.168.55.17/32" recorded-route: "192.168.55.13[66],192.168.55.17[59],192.168.55.18[3]" reserved-bandwidth: 5.0Mbps Reoptimization Path can be re-optimized manually by entering the command (where [id] is an item number or interface /interface traffic-eng reoptimize [id] name). It allows network administrators to reoptimize the LSPs that have been established based on changes in bandwidth, traffic, management policy, or other factors. Let's say TE tunnel chose another path after a link failure on best path. You can verify optimization by looking at or v explicit-route recorded-route alues if parameter is enabled. record-route /interface traffic-eng monitor 0 tunnel-id: 12 primary-path-state: established primary-path: dyn secondary-path-state: not-necessary active-path: dyn active-lspid: 1 active-label: 67 explicit-route: "S:192.168.55.10/32,S:192.168.55.13/32,S:192.168.55.14/32, S:192.168.55.17/32,S:192.168.55.18/32" recorded-route: "192.168.55.13[67],192.168.55.17[60],192.168.55.18[3]" reserved-bandwidth: 5.0Mbps Whenever the link comes back, TE tunnel will use the same path even it is not the best path (unless is configured). To fix it we can reoptimize-interval manually reoptimize the tunnel path. /interface traffic-eng reoptimize 0

/interface traffic-eng monitor 0 tunnel-id: 12 primary-path-state: established primary-path: dyn secondary-path-state: not-necessary active-path: dyn active-lspid: 2 active-label: 81 explicit-route: "S:192.168.55.5/32,S:192.168.55.2/32,S:192.168.55.1/32" recorded-route: "192.168.55.2[81],192.168.55.1[3]" reserved-bandwidth: 5.0Mbps Notice how explicit-route and recorded-route changed to a shorter path.

MPLS Reference

MPLS Case Studies

Network Management In This Section:

ARP Summary Properties ARP Modes Disabled Enabled Proxy ARP Reply Only Local Proxy Arp Gratuitous ARP Summary Sub-menu: /ip arp Even though IP packets are addressed using IP addresses, hardware addresses must be used to transport data from one host to another. Address Resolution Protocol is used to map OSI level 3 IP addresses to OSI level 2 MAC addresses. A router has a table of currently used ARP entries. Normally the table is built dynamically, but to increase network security, it can be partially or completely built statically by adding static entries. Properties This section describes the ARP table configuration options. Property Description address (; IP Default: ) IP address to be mapped interface (string ; Default: ) Interface name the IP address is assigned to mac-address ( ; Default: MAC 0 0:00:00:00:00: )00MAC address to be mapped to published (yes ; Default: ) | no noStatic proxy-arp entry for individual IP addresses. When an ARP query is received for the specific IP address, the device will respond with its own MAC address. No need to set proxy-arp on the interface itself for all the MAC addresses to be proxied. The interface will respond to an ARP request only when the device has an active route towards the destination Read-only properties: Property Description complete ( ) yes | no Complete flag is included in ARP entries when the ARP is permanent, reachable, stale, probe, status or delay dhcp ( ) yes | no Whether the ARP entry is added by DHCP server disabled ( ) yes | no Whether the ARP entry is disabled dynamic ( ) yes | no Whether the entry is dynamically created invalid ( ) yes | no Whether the entry is not valid

status (delay | failed | incomplete | ) permanent | probe | reachable | stale Shows the ARP entry state: delay - neighbor entry validation is currently delayed failed - ARP resolution has failed, the system was not able to obtain the MAC address for the given IP address incomplete - system does not have the MAC address information for the IP address, it has not yet been resolved permanent - ARP entry is considered permanent and will not be removed from the table, even if it is not actively being used. This is set for manually configured ARP entries probe - neighbor is being probed reachable - ARP resolution is successful, and the MAC address associated with the IP address is know, the entry is valid until the reachability timeout expires stale - entry is still valid, but it is aged. This means that the system has not recently communicated with the device associated with the IP address. ARP Modes It is possible to set several ARP modes on the interface configuration. disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originated from matching IP address/MAC address combinations which are entered as static entries in the IP/ARP table. No dynamic entries will be automatically stored in the IP/ARP table. Therefore for communications to be successful, a valid static entry must already exist. Disabled If the ARP feature is turned off on the interface, i.e., is used, ARP requests from clients are not answered by the router. Therefore, a static arp=disabled ARP entry should be added to the clients as well. For example, the router's IP and MAC addresses should be added to the Windows workstations using the arp command: C:\> arp -s 10.5.8.254 00-aa-00-62-c6-09 Enabled This mode is enabled by default on all interfaces. ARPs will be discovered automatically and new dynamic entries will be added to the ARP table. Proxy ARP A router with a properly configured proxy ARP feature acts as a transparent ARP proxy between different networks. This behavior can be useful, for example, if you want to assign dial-in (ppp, pppoe, pptp) clients' IP addresses from the same address space as used on the connected LAN. Proxy ARP can be enabled on each interface individually with the command : arp=proxy-arp Setup proxy ARP: The default maximum number of ARP entries depends on the installed amount of RAM. It can be adjusted with the command " /ip settings x", see more details on . set max-neighbor-entries= IPv4 Settings

DHCP DHCP Client Summary DHCP Options Properties Configuration Examples Simple DHCP client Lease script example Resolve default gateway when 'router' (option3) is from a different subnet DHCPv6 Client Summary Properties Script IAID Configuration Examples Simple DHCPv6 client Use received prefix for local RA DHCP Server Summary DHCP Server Properties Leases Menu specific commands Store Configuration Rate limiting Network RADIUS Support Alerts DHCP Options DHCP Option Sets Example Vendor Classes Example Generic matcher Configuration Examples Setup Manual configuration DHCPv6 Server Summary General DHCPv6 Server Properties Bindings Rate limiting RADIUS Support Configuration Example Enabling IPv6 Prefix delegation Enabling IPv6 Address delegation DHCP Relay Summary Properties Configuration Example DHCP Relay with VRF (introduced in 7.15) DHCP Client Summary /ip dhcp-client

host-name ( ; string Default: )The hostname of the client is sent to a DHCP server. If not specified, the client's system identity will be used. interface ( ; string Default: )The interface on which the DHCP client will be running. script ( ; Default: ) script Execute script when DHCP client obtains a new lease or loses an existing one, received gateway address or DNS server list is changed. Variables that are accessible for the event script: bound - 1 - lease is added/changed; 0 - lease is removed server-address - server address lease-address - lease address provided by a server interface - name of the interface on which the client is configured gateway-address - gateway address provided by a server vendor-specific - stores value of option 43 received from DHCP server lease-options - an array of received options Example >> use-peer-dns ( ; yes | no Default: )yesWhether to accept the settings advertised by . (Will override the settings put in the submenu. DNS DHCP Server /ip dns use-peer-ntp ( ; yes | no Default: )yesWhether to accept the settings advertised by . (Will override the settings put in the NTP DHCP Server /system ntp submenu) client Read-only properties Property Description address ( ) IP/Netmask IP address and netmask, which is assigned to DHCP Client from the Server dhcp-server ()IP The IP address of the DHCP server. expires-after ( )time A time when the lease expires (specified by the DHCP server). gateway ()IP The IP address of the gateway which is assigned by the DHCP server invalid ( ) yes | no Shows whether a configuration is invalid. netmask ()IP primary-dns ()IP The IP address of the first DNS resolver, which was assigned by the DHCP server primary-ntp ()IP The IP address of the primary NTP server, assigned by the DHCP server secondary-dns ()IP The IP address of the second DNS resolver, assigned by the DHCP server secondary-ntp ()IP The IP address of the secondary NTP server, assigned by the DHCP server status (bound | error | rebinding... | requesting... | searching... | ) stoppedShows the status of the DHCP Client Menu specific commands Property Description release (nu ) mbersRelease current binding and restart the DHCP client renew (num )bersRenew current leases. If the renewal operation was not successful, the client tries to reinitialize the lease (i.e. it starts the lease request procedure (rebind) as if it had not received an IP address yet) Configuration Examples

To fix this we need to add /32 route to resolve the gateway over ether1, which can be done by the running script below each time the DHCP client gets an address /system script add name="dhcpL" source={ /ip address add address=($"lease-address" . "/32") network=$"gateway- address" interface=$interface } Now we can further extend the script, to check if the address already exists, and remove the old one if changes are needed /system script add name="dhcpL" source={ /ip address { :local ipId [find where comment="dhcpL address"] :if ($ipId != "") do={ :if (!([get $ipId address] = ($"lease-address" . "/32") && [get $ipId network]=$"gateway-address" )) do={ remove $ipId; add address=($"lease-address" . "/32") network=$"gateway-address" \ interface=$interface comment="dhcpL address" } } else={ add address=($"lease-address" . "/32") network=$"gateway-address" \ interface=$interface comment="dhcpL address" } } } DHCPv6 Client Summary Sub-menu: /ipv6 dhcp-client DHCP-client in RouterOS is capable of being a DHCPv6-client and DHCP-PD client. So it is able to get a prefix from the DHCP-PD server as well as the DHCPv6 stateful address from the DHCPv6 server. Properties Property Description add-default-route ( ; Default: yes | no )noWhether to add default IPv6 route after a client connects. comment ( ; string Default: )Short description of the client disabled (yes | no ; Default: ) no interface ( ; string Default: )The interface on which the DHCPv6 client will be running. pool-name ( ; string Default: )Name of the in which received IPv6 prefix will be added IPv6 pool pool-prefix-length ( ; Default: ) stringPrefix length parameter that will be set for in which received IPv6 prefix is added. IPv6 pool Prefix length must be greater or , otherwise, prefix-length will be set to received prefix length + 8 bits. equal as the length of received prefix prefix-address- lists ( ; string Default: )Names of the firewall address lists to which received prefix will be added.

prefix-hint ( ; string Default: )Include a preferred prefix length. request (prefix, ; Default: address )to choose if the DHCPv6 request will ask for the address or the IPv6 prefix, or both. script ( ; string Default: )Run this script on the DHCP-client status change. Available variables: pd-valid - if the prefix is acquired by the client; pd-prefix - the prefix acquired by the client if any; na-valid - if the address is acquired by the client; na-address - the address acquired by the client if any. options - array of received options (only ROSv7) use-peer-dns (yes ; Default: ) | no yesWhether to accept the DNS settings advertised by the IPv6 DHCP Server. use-interface-duid ( ; Default: yes | no )noAccording to RFC DHCPv6 client generate DUID based on the router first interface MAC address, not the interface on which client is configured. With this option enabled you will override this requirement and MAC address from "interface" specified on client will be used. Read-only properties Property Description duid ( ) string Auto-generated DUID that is sent to the server. DUID is generated using one of the MAC addresses available on the router. request ()list specifies what was requested - prefix, address, or both. dynamic ( ) yes | no expires-after ( )time A time when the IPv6 prefix expires (specified by the DHCPv6 server). invalid ( ) yes | no Shows whether a configuration is invalid. prefix ( ) IPv6 prefix Shows received IPv6 prefix from DHCPv6-PD server status (stopped | searching | requesting... | bound | renewing ) | rebinding | error | stoppingShows the status of DHCPv6 Client: stopped - dhcpv6 client is stopped searching - sending "solicit" and trying to get "advertise" requesting - sent "request" waiting for "reply" bound - received "reply". Prefix assigned. renewing - sent "renew", waiting for "reply" rebinding - sent "rebind", waiting for "reply" error - reply was not received in time or some other error occurred. stopping - sent "release" Menu specific commands Property Description release (nu ) mbersRelease current binding and restart DHCPv6 client renew (nu ) mbersRenew current leases. If the renewal operation was not successful, the client tries to reinitialize the lease (i.e. it starts the lease request procedure (rebind) as if it had not received an IP address yet) Script

ISP is routing prefix 2001:DB8::/62 to the router R1 Router R1 runs DHCPv6 server to delegate /64 prefixes to the customer routers CE1 CE2 DHCP client on routers CE1 and CE2 receives delegated /64 prefix from the DHCP server (R1). Client routers uses received prefix to set up RA on the local interface Configuration R1 /ipv6 route add gateway=fe80::1:1%to-ISP /ipv6 pool add name=myPool prefix=2001:db8::/62 prefix-length=64 /ipv6 dhcp-server add prefix-pool=myPool disabled=no interface=to-CE-routers lease-time=3m name=server1 CE1 /ipv6 dhcp-client add interface=to-R1 request=prefix pool-name=my-ipv6 /ipv6 address add address=::1/64 from-pool=my-ipv6 interface=to-clients advertise=yes

CE2 /ipv6 dhcp-client add interface=to-R1 request=prefix pool-name=my-ipv6 /ipv6 address add address=::1/64 from-pool=my-ipv6 interface=to-clients advertise=yes Check the status After configuration is complete we can verify that each CE router received its own prefix On server: [admin@R1] /ipv6 dhcp-server binding> print Flags: X - disabled, D - dynamic # ADDRESS DUID IAID SERVER STATUS 1 D 2001:db8:1::/64 0019d1393536 566 server1 bound 2 D 2001:db8:2::/64 0019d1393535 565 server1 bound On client: [admin@CE1] /ipv6 dhcp-client> print Flags: D - dynamic, X - disabled, I - invalid # INTERFACE STATUS REQUEST PREFIX 0 to-R1 bound prefix 2001:db8:1::/64 [admin@CE1] /ipv6 dhcp-client> /ipv6 pool print Flags: D - dynamic # NAME PREFIX PREFIX-LENGTH 0 D my-ipv6 2001:db8:1::/64 64 We can also see that IPv6 address was automatically added from the prefix pool: [admin@CE1] /ipv6 address> print Flags: X - disabled, I - invalid, D - dynamic, G - global, L - link-local # ADDRESS FROM-POOL INTERFACE ADVERTISE 0 G 2001:db8:1::1/64 to-clients yes .. And pool usage shows that 'Address' is allocating the pool [admin@CE1] /ipv6 pool used> print POOL PREFIX OWNER INFO my-ipv6 2001:db8:1::/64 Address to-clients DHCP Server Summary

always-broadcast ( ; yes | no Default: ) noChanges whether to force broadcast DHCP replies: no - replies are sent based on the client's broadcast flag. If the server sends three consecutive offers, the third and forth offer will be sent as a broadcast; yes - replies are always broadcasted even when the client has not specified the broadcast flag. authoritative (after-10sec- delay | after-2sec-delay | yes ; Default: ) | no yesOption changes the way how a server responds to DHCP requests: yes- replies to clients' requests for an address that is not available from this server, DHCP server will send a negative acknowledgment (DHCPNAK); no- DHCP server ignores clients' requests for addresses that are not available from this server; after-10sec-delay - requests with "secs < 10" will be processed as in "no" setting case and requests with "secs >= 10" will be processed as in "yes" case; after-2sec-delay - requests with "secs < 2" will be processed as in "no" setting case and requests with "secs >= 2" will be processed as in "yes" case; If all requests with "secs < x" should be ignored, then setting should be used. delay-threshold=x bootp-lease-time (forever | ; Default: lease-time | time for )everAccepts two predefined options or time value: forever - lease never expires lease-time - use time from lease-time parameter bootp-support (none | static | ; Default: ) dynamic staticSupport for BOOTP clients: none - do not respond to BOOTP requests static - offer only static leases to BOOTP clients dynamic - offer static and dynamic leases for BOOTP clients client-mac-limit (integer | ; Default: ) unlimited unlimitedSpecifies whether to limit a specific number of clients per single MAC address or leave unlimited. Note that this setting should not be used in relay setups. conflict-detection ( ; yes | no Default: ) yesAllows disabling/enabling conflict detection. If the option is enabled, then whenever the server tries to assign a lease it will send ICMP and ARP messages to detect whether such an address in the network already exists. If any of the above get a reply address is considered already used. delay-threshold ( ; time | none Default: ) noneIf the sec's field in the DHCP packet is smaller than the delay threshold, then this packet is ignored. If set to - there none is no threshold (all DHCP packets are processed) dhcp-option-set (name | none ; Default: ) noneUse a custom set of DHCP options defined in the option sets menu. insert-queue-before (bottom ; Default: ) | first | name firstSpecify where to place dynamic simple queue entries for static DCHP leases with rate-limit parameter set. a interface ( ; Default: ) string The interface on which the DHCP server will be running. lease-script ( ; Default: string "" )A script that will be executed after a lease is assigned or de-assigned. Internal "global" variables that can be used in the script: leaseBound - set to "1" if bound, otherwise set to "0" leaseServerName - DHCP server name leaseActMAC - active mac address leaseActIP - active IP address lease-hostname - client hostname lease-options - an array of received options lease-time ( ; Default:time 30m )The time that a client may use the assigned address. The client will try to renew this address after half of this time and will request a new address after the time limit expires. name ( ; Default: ) string Reference name

( ; parent-queue string | none Default: ) noneA dynamically created queue for this lease will be configured as a child queue of the specified parent queue. relay (; Default: ) IP 0.0.0.0 The IP address of the relay this DHCP server should process requests from: 0.0.0.0 - the DHCP server will be used only for direct requests from clients (no DHCP relay allowed) 255.255.255.255 - the DHCP server should be used for any incoming request from a DHCP relay except for those, which are processed by another DHCP server that exists in the submenu. /ip dhcp-server (; Default: server-address IP 0 ) .0.0.0The IP address of the server to use in the next step of the client's bootstrap process (For example, to assign a specific server address in case several addresses are assigned to the interface) use-framed-as-classless (yes ; Default: ) | no yesForward RADIUS Framed-Route as a DHCP Classless-Static-Route to DHCP-client. Whenever both Framed-Route and Classless-Static-Route are received Classless-Static-Route is preferred. use-radius (yes | no | ; Default: ) accounting noWhether to use RADIUS server: no- do not use RADIUS; yes- use RADIUS for accounting and lease; accounting - use RADIUS for accounting only. Leases Sub-menu: /ip dhcp-server lease DHCP server lease submenu is used to monitor and manage server leases. The issued leases are shown here as dynamic entries. You can also add static leases to issue a specific IP address to a particular client (identified by MAC address). Generally, the DHCP lease is allocated as follows: an unused lease is in the "waiting" state if a client asks for an IP address, the server chooses one if the client receives a statically assigned address, the lease becomes offered, and then bound with the respective lease time if the client receives a dynamic address (taken from an IP address pool), the router sends a ping packet and waits for an answer for 0.5 seconds. During this time, the lease is marked testing in the case where the address does not respond, the lease becomes offered and then bound with the respective lease time in other cases, the lease becomes busy for the lease time (there is a command to retest all busy addresses), and the client's request remains unanswered (the client will try again shortly) A client may free the leased address. The dynamic lease is removed, and the allocated address is returned to the address pool. But the static lease becomes busy until the client reacquires the address. Property Description address (; Default: ) IP 0.0.0.0 Specify IP address (or ip pool) for static lease. If set to - a pool from the DHCP server will be used 0.0.0.0 address-list ( ; Default: ) string none Address list to which address will be added if the lease is bound. allow-dual-stack-queue ( ; yes | no Default: ) yesCreates a single simple queue entry for both IPv4 and IPv6 addresses, and uses the MAC address and DUID for identification. Requires to have this option enabled as well to work properly. IPv6 DHCP Server always-broadcast ( ; yes | no Default: )noChanges whether to force broadcast DHCP replies: no - replies are sent based on the client's broadcast flag. If the server sends three consecutive offers, the third and forth offer will be sent as a broadcast; yes - replies are always broadcasted even when the client has not specified the broadcast flag. IP addresses assigned statically are not probed!

block-access ( ; Default: yes | no no )Block access for this client client-id ( ; Default: ) string none If specified, must match the DHCP 'client identifier' option of the request dhcp-option ( ; Default: ) string none Add additional DHCP options from . option list dhcp-option-set ( ; Default: string n )oneAdd an additional set of DHCP options. insert-queue-before (bottom | ; Default: ) first | name firstSpecify where to place dynamic simple queue entries for static DCHP leases with rate-limit parameter set. lease-time ( ; Default: ) time 0s Time that the client may use the address. If set to lease will never expire. 0s mac-address ( ; Default: MAC 00: ) 00:00:00:00:00If specified, must match the MAC address of the client ( ; parent-queue string | none Default: ) noneA dynamically created queue for this lease will be configured as a child queue of the specified parent queue. ( queue-type default, ethernet- default, multi-queue-ethernet- default, pcq-download-default, synchronous-default, default- small, hotspot-default, only- hardware-queue, pcq-upload- ) default, wireless-defaultQueue type that can be assigned to the specific lease ( rate-limit integer[/integer] [integer [/integer] [integer[/integer] [integer ; Default: ) [/integer]]]];Adds a dynamic simple queue to limit IP's bandwidth to a specified rate. Requires the lease to be static. Format is: rx-rate[/tx-rate] [rx-burst-rate[/tx-burst-rate] [rx-burst-threshold[/tx-burst-threshold] [rx-burst-time[/tx-burst- time]]]]. All rates should be numbers with optional 'k' (1,000s) or 'M' (1,000,000s). If tx-rate is not specified, rx- rate is as tx-rate too. Same goes for tx-burst-rate and tx-burst-threshold and tx-burst-time. If both rx-burst- threshold and tx-burst-threshold are not specified (but burst-rate is specified), rx-rate and tx-rate is used as burst thresholds. If both rx-burst-time and tx-burst-time are not specified, 1s is used as default. ([dst-address/mask] routes [gateway] [distance]; Default: none )Routes that appear on the server when the client is connected. It is possible to specify multiple routes separated by commas. This setting will be ignored for OpenVPN. server ( ) string Server name which serves this client use-src-mac ( ; Default: no) yes | no When this option is set server uses the source MAC address instead of the received CHADDR to assign the address. Menu specific commands check-status ()id Check the status of a given busy (status is conflict or declined) dynamic lease, and free it in case of no response make-static ()id Convert a dynamic lease to a static one Store Configuration Sub-menu: /ip dhcp-server config Store Leases On Disk: The configuration of how often the DHCP leases will be stored on disk. If they would be saved on a disk on every lease change, a lot of disk writes would happen which is very bad for Compact Flash (especially, if lease times are very short). To minimize writes on disk, all changes are saved on disk every store-leases-disk seconds. Additionally, leases are always stored on disk on graceful shutdown and reboot. Manual changes to leases - addition/removal of a static lease, removal of a dynamic lease will cause changes to be pushed for this lease to storage. Accounting: The accounting parameter in the DHCP server configuration enables or disables accounting for DHCP leases. When accounting is enabled, the DHCP server logs information about IP address assignments and lease renewals. This information can be useful for tracking and monitoring network usage, analyzing traffic patterns, or generating reports on IP address allocations.

reset-alert ()id Clear all alerts on an interface DHCP Options Sub-menu: /ip dhcp-server option With the help of the DHCP Option list, it is possible to define additional custom options for DHCP Server to advertise. Option precedence is as follows: radius, lease, server, network. This is the order in which the client option request will be filled in. According to the DHCP protocol, a parameter is returned to the DHCP client only if it requests this parameter, specifying the respective code in the DHCP request Parameter-List (code 55) attribute. If the code is not included in the Parameter-List attribute, the DHCP server will not send it to the DHCP client, but from the server-side even if the DHCP-client does not request such parameter: since RouterOS v7.1rc5 it is possible to force the DHCP option ip/dhcp-server/option/set force=yes Properties Property Description code ( ; integer:1..254 Default: ) dhcp option code. All codes are available at http://www.iana.org/assignments/bootp-dhcp-parameters name ( ; Default: ) string Descriptive name of the option value ( ; Default: ) string Parameter's value. Available data types for options are: 'test' -> ASCII to Hex 0x74657374 '10.10.10.10' -> Unicode IP to Hex 0x0a0a0a0a s'10.10.10.10' -> ASCII to hex 0x31302e31302e31302e3130 s'160' -> ASCII to hex 0x313630 '10' -> Decimal to Hex 0x0a 0x0a0a -> No conversion $(VARIABLE) -> hardcoded values RouterOS has predefined variables that can be used: HOSTNAME - client hostname RADIUS_MT_STR1 - from radius MT attr nr. 24 RADIUS_MT_STR2 - from radius MT attr nr. 25 REMOTE_ID - agent remote-id NETWORK_GATEWAY - the first gateway from ' ', note that this option won't work if /ip dhcp-server network used from lease Now it is also possible to combine data types into one, for example: "0x01'vards'$(HOSTNAME)" For example if HOSTNAME is 'kvm', then raw value will be 0x0176617264736b766d. raw-value ( ) HEX string Read-only field which shows raw DHCP option value (the format actually sent out) DHCP Option Sets Sub-menu: /ip dhcp-server option sets This menu allows combining multiple options in option sets, which later can be used to override the default DHCP server option set. Example

/ip dhcp-server add address-pool=default-dhcp disabled=no interface=bridge name=defconf /ip dhcp-server network add address=192.168.88.0/24 comment=defconf gateway=192.168.88.1 /ip dhcp-server vendor-class-id add address-pool=pool-for-VID name=samsung server=defconf vid=android-dhcp-9 Connect your mobile phone to the device to receive an IP address from the 172.16.16.0 network [admin@mikrotik] > /ip dhcp-server lease print detail Flags: X - disabled, R - radius, D - dynamic, B - blocked 0 D address=172.16.16.120 mac-address=30:07:4D:F5:07:49 client-id="1:30:7:4d:f5:7:49" address-lists="" server=defconf dhcp-option="" status=bound expires-after=8m55s last-seen=1m5s active-address=172.16.16.120 active-mac-address=30:07:4D: F5:07:49 active-client-id="1:30:7:4d:f5:7:49" active-server=defconf host-name="Galaxy-S8" If you do not know your devices Vendor Class ID, you can turn on DHCP debug logs with . Then in the logging /system logging add topics=dhcp entries, you will see Class-ID 10:30:31 dhcp,debug,packet defconf received request with id 4238230732 from 0.0.0.0 10:30:31 dhcp,debug,packet secs = 3 10:30:31 dhcp,debug,packet ciaddr = 0.0.0.0 10:30:31 dhcp,debug,packet chaddr = 30:07:4D:F5:07:49 10:30:31 dhcp,debug,packet Msg-Type = request 10:30:31 dhcp,debug,packet Client-Id = 01-30-07-4D-F5-07-49 10:30:31 dhcp,debug,packet Address-Request = 172.16.16.120 10:30:31 dhcp,debug,packet Server-Id = 192.168.88.1 10:30:31 dhcp,debug,packet Max-DHCP-Message-Size = 1500 10:30:31 dhcp,debug,packet Class-Id = "android-dhcp-9" 10:30:31 dhcp,debug,packet Host-Name = "Galaxy-S8" 10:30:31 dhcp,debug,packet Parameter-List = Subnet-Mask,Router,Domain-Server,Domain-Name,Interface-MTU, Broadcast-Address,Address-Time,Ren ewal-Time,Rebinding-Time,Vendor-Specific 10:30:31 dhcp,info defconf assigned 172.16.16.120 to 30:07:4D:F5:07:49 10:30:31 dhcp,debug,packet defconf sending ack with id 4238230732 to 172.16.16.120 10:30:31 dhcp,debug,packet ciaddr = 0.0.0.0 10:30:31 dhcp,debug,packet yiaddr = 172.16.16.120 10:30:31 dhcp,debug,packet siaddr = 192.168.88.1 10:30:31 dhcp,debug,packet chaddr = 30:07:4D:F5:07:49 10:30:31 dhcp,debug,packet Msg-Type = ack 10:30:31 dhcp,debug,packet Server-Id = 192.168.88.1 10:30:31 dhcp,debug,packet Address-Time = 600 10:30:31 dhcp,debug,packet Domain-Server = 192.168.88.1,10.155.0.1,10.155.0.126 Generic matcher Since RouterOS 7.4beta4 (2022-Jun-15 14:04) the vendor-id matcher is converted to a generic matcher. The generic matcher allows matching any of the DHCP options. And an example to match DHCP option 60 similar to vendor-id-class matcher: /ip dhcp-server matcher add address-pool=pool1 code=60 name=test value=android-dhcp-11 Match the client-id with option 61 configured as hex value:

To configure the DHCP server manually to respond to local requests you have to configure the following: An for addresses to be given out, make sure that your gateway/DHCP server address is not part of the pool. IP pool /ip pool add name=dhcp_pool0 ranges=192.168.88.2-192.168.88.254 A network indicating subnets that DHCP-server will lease addresses from, among other information, like a gateway, DNS-server, NTP-server, DHCP options, etc. /ip dhcp-server network add address=192.168.88.0/24 dns-server=192.168.88.1 gateway=192.168.88.1 In our case, the device itself is serving as the gateway, so we'll add the address to the bridge interface: /ip address add address=192.168.88.1/24 interface=bridge1 network=192.168.88.0 And finally, add DHCP Server , here we will add the previously created address pool , and specify on which interface the DHCP server should work on /ip dhcp-server add address-pool=dhcp_pool0 disabled=no interface=bridge1 name=dhcp1 DHCPv6 Server Summary Standards: RFC 3315, RFC 3633 Single DUID is used for client and server identification, only IAID will vary between clients corresponding to their assigned interface. Client binding creates a dynamic pool with a timeout set to binding's expiration time (note that now dynamic pools can have a timeout), which will be updated every time binding gets renewed. When a client is bound to a prefix, the DHCP server adds routing information to know how to reach the assigned prefix. Client bindings in the server do not show MAC address anymore (as it was in v5.8), DUID (hex) and IAID are used instead. After upgrade, MAC addresses will be converted to DUIDs automatically, but due to unknown DUID type and unknown IAID, they should be further updated by the user; General Sub-menu: /ipv6 dhcp-server This sub-menu lists and allows to configure DHCP-PD servers. DHCPv6 Server Properties Property Description address-pool (enum | static- ; Default: ) only static-onlyIPv6 pool , from which to take IPv6 address for the clients, pool prefix-length must be specified as /128. preffix-pool ( enum | static- ; Default: static-only) only IPv6 pool , from which to take IPv6 prefxies for the clients. RouterOS DHCPv6 server can only delegate IPv6 prefixes, not addresses.

allow-dual-stack-queue (yes | no; Default: yes)Creates a single simple queue entry for both IPv4 and IPv6 addresses, and uses the MAC address and DUID for identification. Requires IPv6 DHCP Server to have this option enabled as well to work properly. binding-script ( ; string Default: )A script that will be executed after binding is assigned or de-assigned. Internal "global" variables that can be used in the script: bindingBound - set to "1" if bound, otherwise set to "0" bindingServerName - dhcp server name bindingDUID - DUID bindingAddress - active address bindingPrefix - active prefix dhcp-option (string ; Default: n one)Add additional DHCP options from option list . disabled ( ; Default: yes | no no )Whether DHCP-PD server participates in the prefix assignment process. interface ( ; Default: ) string The interface on which server will be running. lease-time ( ; Default: ) time 3d The time that a client may use the assigned address. The client will try to renew this address after half of this time and will request a new address after the time limit expires. name ( ; Default: ) string Reference name address-list ( ; Default: string ) noneAddress list to which address will be added if the lease is bound. Read-only Properties Property Description dynamic ( ) yes | no invalid ( ) yes | no Bindings Sub-menu: /ipv6 dhcp-server binding DUID is used only for dynamic bindings, so if it changes then the client will receive a different prefix than previously. Property Description address (IPv6 ; Default: ) prefixIPv6 prefix that will be assigned to the client allow-dual-stack- queue ( ; yes | no Default: ) yesCreates a single simple queue entry for both IPv4 and IPv6 addresses, uses the MAC address and DUID for identification. Requires I Pv4 DHCP Server to have this option enabled as well to work properly. comment ( ; string Default: )Short description of an item. disabled (yes | ; Default: ) no noWhether an item is disabled dhcp-option (stri ; Default: )ngAdd additional DHCP options from option list. the dhcp-option-set ( ; Default: ) stringAdd an additional set of DHCP options. life-time ( ; time Default: ) 3dThe time period after which binding expires.

duid ( ; hex string Default: )DUID value. Should be specified only in hexadecimal format. iaid (integer [0.. ; 4294967295] Default: )Identity Association Identifier, part of the Client ID. prefix-pool (string ; Default: )Prefix pool that is being advertised to the DHCPv6 Client. rate-limit (integer [/integer] [integer [/integer] [integer [/integer] [integer ; [/integer]]]] Default: )Adds a dynamic simple queue to limit IP's bandwidth to a specified rate. Requires the lease to be static. Format is: rx-rate[/tx-rate] [rx- burst-rate[/tx-burst-rate] [rx-burst-threshold[/tx-burst-threshold] [rx-burst-time[/tx-burst-time]]]]. All rates should be numbers with optional 'k' (1,000s) or 'M' (1,000,000s). If tx-rate is not specified, rx-rate is as tx-rate too. Same goes for tx-burst-rate and tx-burst- threshold and tx-burst-time. If both rx-burst-threshold and tx-burst-threshold are not specified (but burst-rate is specified), rx-rate and tx-rate is used as burst thresholds. If both rx-burst-time and tx-burst-time are not specified, 1s is used as default. server (string | ; Default: ) all allName of the server. If set to , then binding applies to all created DHCP-PD servers. all Read-only properties Property Description dynamic (yes | )noWhether an item is dynamically created. expires-after (ti )meThe time period after which binding expires. last-seen ( )time Time period since the client was last seen. status (waiting | offered | ) boundThree status values are possible: waiting - Shown for static bindings if it is not used. For dynamic bindings this status is shown if it was used previously, the server will wait 10 minutes to allow an old client to get this binding, otherwise binding will be cleared and prefix will be offered to other clients. offered - if message was received, and the server responded with message, but was not received. solicit advertise a the request During this state client have 2 minutes to get this binding, otherwise, it is freed or changed status to for static bindings. waiting bound - currently bound. For example, dynamically assigned /62 prefix [admin@RB493G] /ipv6 dhcp-server binding> print detail Flags: X - disabled, D - dynamic 0 D address=2a02:610:7501:ff00::/62 duid="1605fcb400241d1781f7" iaid=0 server=local-dhcp life-time=3d status=bound expires-after=2d23h40m10s last-seen=19m50s 1 D address=2a02:610:7501:ff04::/62 duid="0019d1393535" iaid=2 server=local-dhcp life-time=3d status=bound expires-after=2d23h43m47s last-seen=16m13s Menu specific commands Property Description make-static ()Set dynamic binding as static. Rate limiting It is possible to set the bandwidth to a specific IPv6 address by using DHCPv6 bindings. This can be done by setting a rate limit on the DHCPv6 binding itself, by doing this a dynamic simple queue rule will be added for the IPv6 address that corresponds to the DHCPv6 binding. By using the rate-limit parameter you can conveniently limit a user's bandwidth.the

INSERT INTO `radcheck` (`username`, `attribute`, `op`, `value`) VALUES ('000c4200d464', 'Auth-Type', ':=', 'Accept'), INSERT INTO `radreply` (`username`, `attribute`, `op`, `value`) VALUES ('000c4200d464', 'Delegated-IPv6-Prefix', '=', 'fdb4:4de7:a3f8:418c::/66'), ('000c4200d464', 'Mikrotik-Rate-Limit', '=', '10M'); Configuration Example Enabling IPv6 Prefix delegation Let's consider that we already have a running DHCP server. To enable IPv6 prefix delegation, first, we need to create an address pool: /ipv6 pool add name=myPool prefix=2001:db8:7501::/60 prefix-length=62 Notice that prefix-length is 62 bits, which means that clients will receive /62 prefixes from the /60 pool. The next step is to enable DHCP-PD: /ipv6 dhcp-server add name=myServer prefix-pool=myPool interface=local To test our server we will set up wide-dhcpv6 on an ubuntu machine: install wide-dhcpv6-client edit "/etc/wide-dhcpv6/dhcp6c.conf" as above interface eth2{ send ia-pd 0; }; id-assoc pd { prefix-interface eth3{ sla-id 1; sla-len 2; }; }; Run DHCP-PD client: sudo dhcp6c -d -D -f eth2 Verify that prefix was added to the: By default allow-dual-stack-queue is enabled and will add a single dynamic queue entry if the MAC address from the IPv4 lease (or DUID, if the DHCPv4 Client supports from RFC4361), but DUID from DHCPv6 Client is not always based on the Node-specific Client Identifiers MAC address from the interface on which the DHCPv6 client is running on, DUID is generated on a per-device basis. For this reason, a single dynamic queue entry might not be created, separate dynamic queue entries might be created instead. You can use also RouterOS as a DHCP-PD client.

local-address (; IP Default: ) 0.0.0.0The unique IP address of this DHCP relay needed for DHCP server to distinguish relays. If set to - the IP address will 0.0.0.0 be chosen automatically relay-info-remote-id (st ; Default: )ringspecified string will be used to construct Option 82 instead of client's MAC address. Option 82 consist of: interface from which packets was received + client mac address or relay-info-remote-id name ( ; Default: ) string Descriptive name for the relay local-address-as-src-ip (yes | no; Default: no)Use local address as source address for Discover/Request packets sent to the DHCP server Configuration Example Let us consider that you have several IP networks 'behind' other routers, but you want to keep all DHCP servers on a single router. To do this, you need a DHCP relay on your network which will relay DHCP requests from clients to the DHCP server. This example will show you how to configure a DHCP server and a DHCP relay that serves 2 IP networks - 192.168.1.0/24 and 192.168.2.0/24 that are behind a router DHCP-Relay.

IP Address Configuration IP addresses of DHCP-Server: [admin@DHCP-Server] ip address> print Flags: X - disabled, I - invalid, D - dynamic # ADDRESS NETWORK BROADCAST INTERFACE 0 192.168.0.1/24 192.168.0.0 192.168.0.255 To-DHCP-Relay 1 10.1.0.2/24 10.1.0.0 10.1.0.255 Public [admin@DHCP-Server] ip address> IP addresses of DHCP-Relay: [admin@DHCP-Relay] ip address> print Flags: X - disabled, I - invalid, D - dynamic # ADDRESS NETWORK BROADCAST INTERFACE 0 192.168.0.2/24 192.168.0.0 192.168.0.255 To-DHCP-Server 1 192.168.1.1/24 192.168.1.0 192.168.1.255 Local1 2 192.168.2.1/24 192.168.2.0 192.168.2.255 Local2 [admin@DHCP-Relay] ip address> DHCP Server Setup To setup 2 DHCP Servers on the DHCP-Server router add 2 pools. For networks 192.168.1.0/24 and 192.168.2.0: /ip pool add name=Local1-Pool ranges=192.168.1.11-192.168.1.100 /ip pool add name=Local2-Pool ranges=192.168.2.11-192.168.2.100 [admin@DHCP-Server] ip pool> print # NAME RANGES 0 Local1-Pool 192.168.1.11-192.168.1.100 1 Local2-Pool 192.168.2.11-192.168.2.100 [admin@DHCP-Server] ip pool> Create DHCP Servers: /ip dhcp-server add interface=To-DHCP-Relay relay=192.168.1.1 \ address-pool=Local1-Pool name=DHCP-1 disabled=no /ip dhcp-server add interface=To-DHCP-Relay relay=192.168.2.1 \ address-pool=Local2-Pool name=DHCP-2 disabled=no [admin@DHCP-Server] ip dhcp-server> print Flags: X - disabled, I - invalid # NAME INTERFACE RELAY ADDRESS-POOL LEASE-TIME ADD-ARP 0 DHCP-1 To-DHCP-Relay 192.168.1.1 Local1-Pool 3d00:00:00 1 DHCP-2 To-DHCP-Relay 192.168.2.1 Local2-Pool 3d00:00:00 [admin@DHCP-Server] ip dhcp-server> Configure respective networks:

/ip dhcp-server network add address=192.168.1.0/24 gateway=192.168.1.1 \ dns-server=159.148.60.20 /ip dhcp-server network add address=192.168.2.0/24 gateway=192.168.2.1 \ dns-server 159.148.60.20 [admin@DHCP-Server] ip dhcp-server network> print # ADDRESS GATEWAY DNS-SERVER WINS-SERVER DOMAIN 0 192.168.1.0/24 192.168.1.1 159.148.60.20 1 192.168.2.0/24 192.168.2.1 159.148.60.20 [admin@DHCP-Server] ip dhcp-server network> DHCP Relay Config Configuration of DHCP-Server is done. Now let's configure DHCP-Relay: /ip dhcp-relay add name=Local1-Relay interface=Local1 \ dhcp-server=192.168.0.1 local-address=192.168.1.1 disabled=no /ip dhcp-relay add name=Local2-Relay interface=Local2 \ dhcp-server=192.168.0.1 local-address=192.168.2.1 disabled=no [admin@DHCP-Relay] ip dhcp-relay> print Flags: X - disabled, I - invalid # NAME INTERFACE DHCP-SERVER LOCAL-ADDRESS 0 Local1-Relay Local1 192.168.0.1 192.168.1.1 1 Local2-Relay Local2 192.168.0.1 192.168.2.1 [admin@DHCP-Relay] ip dhcp-relay> DHCP Relay with VRF (introduced in 7.15) Let's take the previous setup but we'll consider that the interface to the DHCP server and interfaces to DHCP clients are added in VRF: /ip vrf add interfaces=To-DHCP-Server name=vrf_server add interfaces=Local2 name=vrf2 add interfaces=Local1 name=vrf1 In the DHCP-relay configuration dhcp-server-vrf should be added: /ip dhcp-relay/set dhcp-server-vrf=vrf_server numbers=0,1 Due to VRF configuration there are several routing-tables - we should add additional routes: /ip route add disabled=no distance=1 dst-address=192.168.0.0/24 gateway=To-DHCP-Server@vrf_server pref-src="" routing- table=vrf1 scope=10 suppress-hw-offload=no \ target-scope=10 add disabled=no distance=1 dst-address=192.168.0.0/24 gateway=To-DHCP-Server@vrf_server pref-src="" routing- table=vrf2 scope=10 suppress-hw-offload=no \ target-scope=10 add disabled=no dst-address=192.168.1.0/24 gateway=Local1@vrf1 routing-table=vrf_server suppress-hw-offload=no add disabled=no distance=1 dst-address=192.168.2.0/24 gateway=Local2@vrf2 pref-src="" routing-table=vrf_server scope=30 suppress-hw-offload=no \ target-scope=10 To achieve successful DHCP-server - DHCP-relay communication we should add NAT rules:

/ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.2.1 dst-port=67 in-interface=To-DHCP-Server protocol=udp src-address=192.168.0.1 to-addresses=\ 192.168.0.2 add action=dst-nat chain=dstnat dst-address=192.168.1.1 dst-port=67 in-interface=To-DHCP-Server protocol=udp src-address=192.168.0.1 to-addresses=\ 192.168.0.2

address-list (string ) Name of the Firewall address list to which address must be dynamically added when some request matches the entry. Entry will be removed from the address list when TTL expires. comment (string ) Comment about the domain name record. disabled ( |; Default: yes) yes no Whether the DNS record is active. match-subdomain ( |; Default: no) yes no Whether the record will match requests for subdomains. mx-preference (integer ; Default: 0) Preference of the particular MX record. ns (string ) Name of the authoritative domain name server for the particular record. regexp (regex) Regular expression against which domain names should be verified. srv-priority (integer ; Default: 0) Priority of the particular SRV record. srv-weight ( 0 integer ; Default: ) Weight of the particular SRV record. ttl ( ; Default: ) time 24h Maximum time-to-live for cached records. DNS over HTTPS (DoH) Starting from RouterOS version v6.47 it is possible to use DNS over HTTPS (DoH). DoH uses HTTPS protocol to send and receive DNS requests for better data integrity. The main goal is to provide privacy by eliminating "man-in-the-middle" attacks (MITM). Video: DoH setup There are various ways to find out what root CA certificate is necessary. The easiest way is by using your WEB browser, navigating to the DoH site, and checking the security of the website. You can download the certificate straight from the browser or fetch the certificate from a trusted source. Download the certificate, upload it to your router and import it: /certificate import file-name=CertificateFileName Configure the DoH server: /ip dns set use-doh-server=DoH_Server_Query_URL verify-doh-cert=yes Note that you need at least one regular DNS server configured for the router to resolve the DoH hostname itself. If you do not have any dynamical or static DNS server configured, add a static DNS entry for the DoH server domain name like this: For each static A and AAAA record, in cache automatically is added a PTR record. Regexp is case-sensitive, but DNS requests are not case sensitive, RouterOS converts DNS names to lowercase before matching any static entries. You should write regex only with lowercase letters. Regular expression matching is significantly slower than plain text entries, so it is advised to minimize the number of regular expression rules and optimize the expressions themselves. Be careful when you configure regex through mixed user interfaces - CLI and GUI. Adding the entry itself might require escape characters when added from CLI. It is recommended to add an entry and the execute print command in order to verify that regex was not changed during addition. It is strongly recommended to import the root CA certificate of the DoH server you have chosen to use for increased security. We strongly suggest not using third-party download links for certificate fetching. Use the Certificate Authority's own website.

/ip dns set servers=1.1.1.1 If you do not have any dynamical or static DNS server configured, add a static DNS entry for the DoH server domain name like this: /ip dns static add address=IP_Address name=Domain_Name Known compatible/incompatible DoH services Compatible DoH services: Cloudflare Google NextDNS OpenDNS Incompatible DoH services: Mullvad Yandex UncensoredDNS Adlist Adlist is an integral component of network-level ad blocking, comprising a curated collection of domain names known for serving advertisements. This feature operates by utilizing Domain Name System (DNS) resolution to intercept A and AAAA requests to these domains. When a client device queries a DNS server for a domain listed on the adlist, the DNS resolution process is altered. Instead of returning the actual IP address of the ad-serving domain, the DNS server responds with the IP address 0.0.0.0. This effectively null-routes the request, as 0.0.0.0 is a non-routable meta-address used to denote an invalid, unknown, or non-applicable target. By redirecting ad-related requests in this manner, the adlist feature ensures that advertisement content is not loaded, enhancing network performance and improving the user experience by reducing unwanted ad traffic. Video: Adlist setup Property Description url Used to specify the URL of an adlist. ssl-verify Specifies whether to validate the server's SSL certificate when connecting to an online resource. Will use the "/certificate" list to verify server validity. If DoH server is being used (DoH DNS name can be resolved) then it will be the only DNS service working at the time and standard DNS servers from IP/DNS servers list will not be used. If is set to RouterOS will check CRL for each certificate in a certificate chain, therefore, an entire certificate /certificate/settings/set crl-use yes, chain should be installed into a device - starting from Root CA, intermediate CA (if there are such), and certificate that is used for specific service. For example, Google DoH, Cloudflare, and OpenDNS full chain contain three certificates, NextDNS has four certificates. Before configuring, increase the DNS cache as it's used to store adlist entries. If limit is reached and error in DNS,error topic is printed " adlist d" read: max cache size reache Adlist is stored on device's internal memory. Ensure that there is enough free space to save the desired adlist.

file Used to specify a local file path from which to read adlist data pause Temporarily pause the use of all adlist. reload Checks for updates for all lists, if updates are found, the list is updated, removing or adding entries as needed, the lists are not redownloaded in whole when issuing a reload, instead only necessary updates are done. Whitelist for Adlist To exempt certain domains from Adlist, you need to create a static DNS FWD entry, for example, /ip/dns/static/add name=bar.test type=FWD , if such entry is present, the query will be forwarded to the next DNS, either dynamic or one configured under " /ip/dns/set servers= " , FWD entries are supported by DoH as well. Whitelist support was added in 7.17beta1. Configuration examples: URL based adlist: /ip/dns/adlist add url=https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts ssl-verify=no To see how many domain names are present and matched, you can run: /ip/dns/adlist/print Flags: X - disabled 0 url="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts" ssl-verify=no match-count=122 name- count=164769 Locally hosted adlist: To create your adlist, you can create a Txt file with the domains. Example: 0.0.0.0 example1.com 0.0.0.0 eu1.example.com 0.0.0.0 ex.com 0.0.0.0 com.example.com To add file to adlist : /ip/dns/adlist/add file=host.txt It's not mandatory to use reload to update the lists, Adlist checks for new updates once every hour. You can create the txt file on your PC, but it is also possible to create it in RouterOS, with following commands "/file/add name=host.txt", and then you can run "file/edit host.txt contents" after adding entries, press "ctrl o" to save the entries. You can verify that file is formatted correctly with "/ip/dns/adlist/print" ,the results will show how many hostnames you have added, the hostname format must match the format given in previous example.

/ip/dns/adlist/print Flags: X - disabled 0 file=host.txt match-count=0 name-count=4 Forwarders (available from RouterOS 7.17) DNS Forwarders allows a user to configure a named DNS forwarder that can be used for static FWD entries as value. forward-to For each is possible to configure multiple regular upstream and DoH servers. Configured servers will be used by round-robin Forwarder forwarder algorithm - for each new query, next configured server will be used to resolve DNS name. Forwarder configuration In section, can added, modified or removed. /ip/dns/forwaders forwarders Property Description name (string; Default: ) Forwarder name. dns-servers ( ; Default: ) string An IP address or DNS name of a domain name server. Can contain multiple records, for example, dns-servers=1. 1.1.1,8.8.8.8,local.dns doh-servers ( Default: ) string; A URL of DoH server. Can contain multiple records. ( | verify-doh-cert yes no; Default: )yesSpecifies whether to validate the DoH server, when one is being used. Will use the "/certificate" list in order to verify server validity. Configuration example Configure/add a : forwarder /ip dns forwarders add dns-servers=1.1.1.1,local.dns doh-servers=https://dns.google/dns-query name=forwarder1 Configure/add a statis DNS FWD entry: /ip dns static add forward-to=forwarder1 name=mikrotik.com type=FWD Now each time when a router will receive request to resolve , request using round-robin algorithm will be forwarded to , or mikrotik.com 1.1.1.1 local.dns Goo server. gle DoH

SOCKS Introduction Property Description Access List Active Connections Example Application Examples Introduction SOCKS ( is a proxy server that allows TCP-based application data to relay across the firewall, even if the firewall would block the packets. Socket Secure) The SOCKS protocol is independent of application protocols, so it can be used for many services, e.g, WWW, FTP, TELNET, and others. At first, an application client connects to the SOCKS proxy server, then the proxy server looks in its access list to see whether the client is permitted to access the remote application resource or not, if it is permitted, the proxy server relies on the packet to the application server and creates a connection between the application server and client. Remember to configure your application client to use SOCKS!. You should secure the SOCKS proxy using its access list and/or firewall to disallow access from outside. Failing to secure the proxy server may introduce security issues to your network, and may provide a way for spammers to send junk mail through the router. Property Description Property Description connection-idle-timeout (time; default: 2m) time after which idle connections are terminated enabled (yes | no; default: no) whether to enable or no the SOCKS proxy max-connections (integer: 1..500; default: 200) maxumum number of simultaneous connections port (integer: 1..65535; default: 1080) TCP port on which the SOCKS server listens for connections Access List /ip socks access In the SOCKS access list, you can add rules which will control access to the SOCKS server. This list is similar to firewall lists. Property Description action (allow | deny; default: allow) allow - allow packets, matching this rule, to be forwarded for further processing deny - deny access for packets, matching this rule dst-address (IP address/netmask) destination (server's) address dst-port (port) destination TCP port src-address (IP address/netmask) source (client's) address for a packet src-port (port) source TCP port Active Connections The Active Connection list shows all established TCP connections, which are maintained through the SOCKS proxy server.

/ip proxy access add dst-host=:mail action=deny This statement will block all websites which contain the word “mail” in the URL. Like , , , etc. www.mail.com www.hotmail.com mail.yahoo.com We can also stop downloading specific types of files like .flv, .avi, .mp4, .mp3, .exe, .dat, …etc. /ip proxy access add path=*.flv action=deny add path=*.avi action=deny add path=*.mp4 action=deny add path=*.mp3 action=deny add path=*.zip action=deny add path=*.rar action=deny Here are available also different wildcard characters, to create specific conditions and to match them by proxy access list. Wildcard properties (dst-host and dst-path) match a complete string (i.e., they will not match " " if they are set to "example"). Available wildcards are '*' (match any number example.com of any characters) and '?' (match any one character). Regular expressions are also accepted here, but if the property should be treated as a regular expression, it should start with a colon (':'). To show that no symbols are allowed before the given pattern, we use the ^ symbol at the beginning of the pattern. To specify that no symbols are allowed after the given pattern, we use the $ symbol at the end of the pattern. Enabling RAM or Store-based caching. In this example, it will presume that you already have the proxy configured and working and you just want to enable caching. If a command/parameter detailed description is required check the reference section which is located right below the example section. RAM-based caching: Good if you have a device with a considerable amount of RAM for caching. Enabling this on a device with RAM 256MB or less will not give your network any benefit. Way faster cache writes/read than one that is stored on USB or SATA connected mediums. Store-based caching: Larger proxy caches are available simply due to medium capacity differences. RAM proxy cache: Important commands: max-cache-size= max-cache-object-size= cache-on-disk=

parent-proxy ( ; Ip4 | ip6 Default: ) 0.0.0.0IP address and port of another HTTP proxy to redirect all requests to. If set to parent proxy is not used. 0.0.0.0 parent-proxy-port (integ ; Default: ) er: 0..65535 0Port that parent proxy is listening on. port ( ; integer: 0..65535 Default: ) 8080TCP port the proxy server will be listening on. This port has to be specified on all clients that want to use the server as an HTTP proxy. A transparent (with zero configuration for clients) proxy setup can be made by redirecting HTTP requests to this port in the IP firewall using the destination NAT feature serialize-connections (y ; Default: ) es | no noDo not make multiple connections to the server for multiple client connections, if possible (i.e. server supports persistent HTTP connections). Clients will be served on the FIFO principle; the next client is processed when the response transfer to the previous one is completed. If a client is idle for too long (max 5 seconds by default), it will give up waiting and open another connection to the server src-address ( ; Ip4 | Ip6 Default: ) 0.0.0.0A proxy will use a specified address when connecting to the parent proxy or website. If set to then the appropriate 0.0.0.0 IP address will be taken from the routing table. Access List /ip/proxy/access An access list is configured like regular firewall rules. Rules are processed from the top to the bottom. The first matching rule specifies the decision of what to do with this connection. There is a total of 6 classifiers that specify matching constraints. If none of these classifiers is specified, the particular rule will match every connection. If a connection is matched by a rule, the action property of this rule specifies whether a connection will be allowed or not. If the particular connection does not match any rule, it will be allowed. Property Description action ( ; Default: ) allow | deny allow Specifies whether to pass or deny matched packets dst-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The destination address of the target server. dst-host ( ; Default: ) string IP address or DNS name used to make a connection to the target server (this is the string user wrote in a browser before specifying the port and path to a particular web page dst-port (integer[-integer[,integer[,...]]]: 0.. ; Default: ) 65535 List or range of ports the packet is destined to local-port ( ; Default: ) integer: 0..65535 Specifies the port of the web proxy via which the packet was received. This value should match one of the ports the web proxy is listening on. method (any | connect | delete | get | head | ; Default: ) options | post | put | trace The HTTP method used in the request (see HTTP Methods section at the end of this document) path ( ; Default: ) string Name of the requested page within the target server (i.e. the name of a particular web page or document without the name of the server it resides on) redirect-to ( ; Default: ) string In case of access is denied by this rule, the user shall be redirected to the URL specified here src-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The source address of the connection originator. Read-only properties: Property Description hits ( ) integer Count of requests that were matched by this rule

Wildcard properties (dst-host and dst-path) match a complete string (i.e., they will not match " " if they are set to "example"). Available example.com wildcards are '*' (match any number of any characters) and '?' (match any one character). Regular expressions are also accepted here, but if the property should be treated as a regular expression, it should start with a colon (':'). Small hints in using regular expressions: \\ symbol sequence is used to enter \ character in the console; \. pattern means. only (in regular expressions single dot in a pattern means any symbol); to show that no symbols are allowed before the given pattern, we use the ^ symbol at the beginning of the pattern; to specify that no symbols are allowed after the given pattern, we use the $ symbol at the end of the pattern; to enter [ or ] symbols, you should escape them with backslash "\."; It is strongly recommended to deny all IP addresses except those behind the router as the proxy still may be used to access your internal-use-only (intranet) web servers. Also, consult examples in Firewall Manual on how to protect your router. Direct Access /ip/proxy/direct If a parent-proxy property is specified, it is possible to tell the proxy server whether to try to pass the request to the parent proxy or to resolve it by connecting to the requested server directly. The direct Access List is managed just like the Proxy Access List described in the previous chapter except for the action argument. Unlike the access list, the direct proxy access list has a default action equal to deny. It takes place when no rules are specified or a particular request did not match any rule. Property Description action ( ; Default: ) allow | deny allow Specifies the action to perform on matched packets: allow - always resolve matched requests directly bypassing the parent router deny - resolve matched requests through the parent proxy. If no one is specified this has the same effect as . allow dst-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The destination address of the target server. dst-host ( ; Default: ) string IP address or DNS name used to make a connection to the target server (this is the string user wrote in a browser before specifying port and path to a particular web page dst-port (integer[-integer[,integer[,...]]]: 0.. ; Default: ) 65535 List or range of ports used by connection to the target server. local-port ( ; Default: ) integer: 0..65535 Specifies the port of the web proxy via which the packet was received. This value should match one of the ports the web proxy is listening on. method (any | connect | delete | get | head | ; Default: ) options | post | put | trace The HTTP method used in the request (see section at the end of this document) HTTP Methods path ( ; Default: ) string Name of the requested page within the target server (i.e. the name of a particular web page or document without the name of the server it resides on) src-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The source address of the connection originator. Read-only properties: Property Description hits ( ) integer Count of requests that were matched by this rule

Cache Management /ip/proxy/cache The cache access list specifies, which requests (domains, servers, pages) have to be cached locally by web proxy, and which do not. This list is implemented exactly the same way as the web proxy access list. The default action is to cache an object (if no matching rule is found). Property Description action ( ; Default: ) allow | deny allow Specifies the action to perform on matched packets: allow - cache objects from matched request deny - do not cache objects from matched request dst-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The destination address of the target server dst-host ( ; Default: ) string IP address or DNS name used to make a connection to the target server (this is the string user wrote in a browser before specifying port and path to a particular web page dst-port (integer[-integer[,integer[,...]]]: 0.. ; Default: ) 65535 List or range of ports the packet is destined to. local-port ( ; Default: ) integer: 0..65535 Specifies the port of the web proxy via which the packet was received. This value should match one of the ports the web proxy is listening on. method (any | connect | delete | get | head | ; Default: ) options | post | put | trace The HTTP method used in the request (see HTTP Methods section at the end of this document) path ( ; Default: ) string Name of the requested page within the target server (i.e. the name of a particular web page or document without the name of the server it resides on) src-address ( ; Ip4[-Ip4 | /0..32] | Ip6/0..128 Default: ) The source address of the connection originator Read-only properties: Property Description hits ( ) integer Count of requests that were matched by this rule Connections /ip/proxy/connections This menu contains the list of current connections the proxy is serving. Read-only properties: Property Description client () dst-address ( ) Ip4 | Ip6 IPv4/Ipv6 destination address of the connection protocol ( ) string Protocol name

rx-bytes ( ) integer The number of bytes received by the client server () src-address ( ) Ip4 | Ip6 Ipv4/ipv6 address of the connection originator state (closing | connecting | converting | hotspot | idle | resolving | rx-header | tx- ) body | tx-eof | tx-header | waitingConnection state: closing - the data transfer is finished, and the connection is being finalized connecting - establishing toe connection converting - replacing header and footer fields in response or request packet hotspot - check if hotspot authentication allows continuing (for hotspot proxy) idle- staying idle resolving - resolving the server's DNS name rx-header - receiving HTTP header tx-body - transmitting HTTP body to the client tx-eof - writing chunk-end (when converting to chunked response) tx-header - transmitting HTTP header to the client waiting - waiting for transmission from a peer tx-bytes ( ) integer The number of bytes sent by the client Cache Inserts /ip/proxy/inserts This menu shows statistics on objects stored in a cache (cache inserts). Read-only properties: Property Description denied ( ) integer A number of inserts were denied by the caching list. errors ( ) integer Number of disk or other system-related errors no-memory ( ) integer Number of objects not stored because there was not enough memory successes ( ) integer A number of successful cache inserts. too-large ( ) integer Number of objects too large to store Cache Lookups /ip/proxy/lookup This menu shows statistics on objects read from cache (cache lookups). Read-only properties: Property Description denied ( ) integer Number of requests denied by the access list. expired ( ) integer Number of requests found in cache, but expired, and, thus, requested from an external server

no-expiration-info (integ )erConditional request received for a page that does not have the information to compare the request with non-cacheable ( ) integer Number of requests requested from the external servers unconditionally (as their caching is denied by the cache access list) not-found ( ) integer Number of requests not found in the cache, and, thus, requested from an external server (or parent proxy if configured accordingly) successes ( ) integer Number of requests found in the cache. Cache Contents /ip/proxy/cache-contents This menu shows cached contents. Read-only properties: Property Description file-size ( ) integer Cached object size last-accessed ( )time last-accessed-time ( )time last-modified ( )time last-modified-time ( )time uri ( ) string HTTP Methods Options This method is a request for information about the communication options available on the chain between the client and the server identified by the Request . The method allows the client to determine the options and (or) the requirements associated with a resource without initiating any resource retrieval-URI GET This method retrieves whatever information identified by the Request-URI. If the Request-URI refers to a data processing process then the response to the GET method should contain data produced by the process, not the source code of the process procedure(-s), unless the source is the result of the process. The GET method can become a conditional GET if the request message includes an If-Modified-Since, If-Unmodified-Since, If-Match, If-None-Match, or If- Range header field. The conditional GET method is used to reduce the network traffic specifying that the transfer of the entity should occur only under circumstances described by conditional header field(-s). The GET method can become a partial GET if the request message includes a Range header field. The partial GET method intends to reduce unnecessary network usage by requesting only parts of entities without transferring data already held by the client. The response to a GET request is cacheable if and only if it meets the requirements for HTTP caching. HEAD This method shares all features of GET method except that the server must not return a message-body in the response. This retrieves the metainformation of the entity implied by the request which leads to its wide usage of it for testing hypertext links for validity, accessibility, and recent modification. The response to a HEAD request may be cacheable in the way that the information contained in the response may be used to update the previously cached entity identified by that Request-URI.

POST This method requests that the origin server accept the entity enclosed in the request as a new subordinate of the resource identified by the Request-URI. The actual action performed by the POST method is determined by the origin server and usually is Request-URI dependent. Responses to POST method are not cacheable, unless the response includes appropriate Cache-Control or Expires header fields. PUT This method requests that the enclosed entity be stored under the supplied Request-URI. If another entity exists under specified Request-URI, the enclosed entity should be considered as an updated (newer) version of that residing on the origin server. If the Request-URI is not pointing to an existing resource, the origin server should create a resource with that URI. If the request passes through a cache and the Request-URI identifies one or more currently cached entities, those entries should be treated as stale. Responses to this method are not cacheable. TRACE This method invokes a remote, application-layer loop-back of the request message. The final recipient of the request should reflect the message received back to the client as the entity-body of a 200 (OK) response. The final recipient is either the origin server or the first proxy or gateway to receive a Max- Forwards value of 0 in the request. A TRACE request must not include an entity. Responses to this method MUST NOT be cached.

Routing In This Section:

Routing Protocol Overview Feature Status Performance Status One Peer Receive Only Two Peers Receive Only Multi-homing Sim Memory Usage: Feature Status N/A - Feature not yet available OK - Initial tests successful NOK - initial tests not successful Highlight Colors: Yellow - partially working Green - Working Red - Not working at the moment Feature v7.1 v7.2 v7. 3v7.6 v7.10 v7. 12v7. 14v7. 15v7. 17v7. 18 Winbox BGP support OSPF support RIP support Router ID support Routing filter support Generic /31 address support N/A Convert route rules after upgrade from v6.x Static IPv6 upgrade from ROS v6 IPv4 Route Rules IPv6 Route Rules ECMP flags dst@table gateway@table gateway%interface recursive route over ipv6 LL address 3 level recursive gateway with ECMP IPV6 ECMP IPv6 connected ECMP Addresses from same subnet to multiple interfacesN/A Show time when route was last updatedN/A Check Gateway BFD not ready Scope and target scope IPv4 Mangle routing-mark

IPv6 Mangle routing-mark Packet SRC address Does not work correctly with /32 addresses Routing-table parameter for ping and telnet Show if route is hardware accelerated Shows if route is candidate for HW acceleration Custom route selection policy IPv4 with IPv6 nexthops for RFC5549 Routing id VRF Management services support for VRFs telnet, ssh, api, www services can be set to listen on specific VRF Dynamically import/export routes from one vrf to another within the same routerN/A BFD N/A Initial support OSPF Convert OSPF config from v6 to v7 after upgradeKnown conversion problems: NBMA neighbors place in backbone ospf-v2 networks + interface may have issues dynamic interfaces may have issues MPLS PE CE features are not converted OSPF neighbors in NSSA Area OSPF in broadcast network OSPF with routing filters OSPF Virtual Link OPSF input filtering HMAC-SHA auth RFC5709 N/A Initial support OSPF SNMP monitoring N/A BGP SNMP monitoring For ipv4 sessions IS-IS IPv4 Initial suppo rt IPv6 Traffic Engineering BGP Convert BGP config from v6 to v7 after upgrade BGP Templates and dynamic peers BGP connect listen on a network BGP guess remote.as Show from which peer route received OK ( /routing/route/print detail -- ) > belongs-to BGP Address Families

BGP input.accept-* eBGP nexthop self Input Filter Output Filter BGP Local address auto selection BGP route reflect BGP route server BGP Roles https://datatracker.ietf.org/doc/draft-ietf- idr-bgp-open-policy/?include_text=1rfc roles not fully implemented BGP session uptime in "established" state BGP session last established time BGP Flow Spec Flow spec attributes are forwarded BGP Selection BGP Selection (Multipath) N/A BGP Confederation BGP Aggregation N/A BGP ORF N/A Discard prefix RFC 6666 RTBH N/A AS-wide Unique BGP Identifier RFC 6286N/A Exported PDU PCAP saver Exported PDU PCAP loader BGP Advertisement monitoring Initial implementation by dumping to pcapAdvertise ments rework BGP Prefix limit Initial suppo rt BGP advertise IPv4 prefix with IPv6 nexthop (RFC5549) BGP VPNv6 support Prerequisites are made, need to add actual BGP Afi MPLS Static label mapping Static mapping upgrade from v6 LDP IPv4 mapping LDP IPv6 mapping LDP signaled VPLS LDP config upgrade from v6 LDP Dual Stack TE TE Config upgrade from v6 VPLS Encap to TE BGP signaled VPLS VPLS config upgrade from v6 RSVP Fast reroute N/A FRR/RI-RSVP ( ) RFC 8370 N/A

MPLS ECMP One label per VRF Ability to use MPLS EXP-bit in Queues N/A MPLS Fast-Path N/A RPKI session RPKI possibility to view received info of specific prefix RPKI show connection status Filters Convert routing filters after upgrade from v6.x Syntax completion Routing filter chain drop by default without rules Routing filter prefix match Routing filter protocol match Routing filter append communities Routing filter append large community Routing filter set weight Routing filter set local pref Routing filter set MED Routing filter set origin Routing filter set igp metric from OSPF cost Routing filter match prefix with address list Routing filter match community/large community lists Routing filter add a prefix to address list N/A Routing filter validate prefix with RPKI Multicast IGMP-Proxy PIM-SM Initial support Performance Status Used hardware: CCR1036, 16GB RAM (tile) CCR2004(arm64) CCR1100AHx4(arm) Intel(R) Core(TM) i7-4790 CPU @ 3.60GHz 32GB RAM (as a host for CHRs) The simulated upstream peer is a CHR router running ROSv6 with a copy of the global IPv4 routing table (585K routes loaded from MRT dump). One Peer Receive Only

DUT establishes a connection to simulated upstream peers, receives routes, and installs them in FIB. v6.44 v7.1beta3 v7. 1rc7v7.15.3 (1008427 routes)v7.16 (1008427 routes) CCR 0:40 - 2:12 0:46 RB1100x4 1.4GHz 0:32-0:38 0:23 CCR2004 0:32 0:18 x86 (CHR) 0:20 RB450G (in/out affinity=alone) after trying for 9min - ran out of memory at 558K routes2:02 (121MB free) RB450G (in/out affinity=main) - 1:54 RB450G (affinity in=alone out=input)- 2:12 CCR2116 0:36 0:34 CCR2216 0:39 0:34 CCR2216 (150 regexp as-path rules)2:09 Two Peers Receive Only DUT establishes a connection to two simulated upstream peers, receives routes, picks the best route, and installs in FIB. On ROSv7 affinity settings are set to "alone".

v6.44 FRR v7.1beta3 v7.1rc7 (846k routes per peer) CCR 1:01 - 2:45 1:11 RB1100x4 1.4GHz 0:51 0:30 CCR2004 0:51 0:29 0:33 router x 0:40 x86 (CHR) 0:25 x86 (virtual) 0:26(4cores) 0:46(2cores) 0:30(2cores no LDP) Multi-homing Sim Two DUT devices establish eBGP sessions to simulated x86 upstream routers. Both DUTs are interconnected with the iBGP session. Each DUT receives routes from upstream and readvertises routes over iBGP. On ROSv7 affinity, settings are set to "alone" and early-cut disabled. Route Provider: CHR (ROSv6 585K routes) DUT_1: CCR1036 DUT_2: CCR1036 v7.1beta3 1:11 v7.1beta2 1:29 v6.xx 1:02 - 8:30 Route Provider: CHR (ROSv6 585K routes) DUT_1: CCR2004 DUT_2: RB1100AHx2

v7.1beta3 0:36 v6.xx 0:59 Route Provider: CCR2216 (ROSv7.16 1008427 routes) DUT_1: CCR2216 DUT_2: CCR2116 Time M em v7.15.3 0:59 28 5 MB v7.16 0:48 29 7 MB Route Server Time M em v7.15.3 - - MB v7.16 - - MB Memory Usage:

Columns: TASKS, PRIVATE-MEM-BLOCKS, SHARED-MEM-BLOCKS, PSS, RSS, VMS, RETIRED, ID, PID, RPID, PROCESS-TIME, KERNEL-TIME, CUR-BUSY, MAX-BU> # TASKS PRIVATE-M SHARED-M P R V RE ID PID R PROCESS- KERNEL- CUR MAX-BUS CUR MAX-CALC 0 routing tables 12.0MiB 30.2MiB 0 0 0 12 main 111 0 8s980ms 2s60ms 0ms 1s320ms 0ms 10s700ms rib connected networks 1 fib 2816.0KiB 0 0 0 0 fib 130 1 3s 4s660ms 7s220ms 7s220ms 2 ospf 512.0KiB 256.0KiB 0 0 0 ospf 137 1 1s220ms 130ms 980ms 1s40ms connected networks 3 fantasy 256.0KiB 0 0 0 0 fantasy 138 1 60ms 80ms 40ms 40ms 4 configuration and reporting 3840.0KiB 512.0KiB 0 0 0 static 139 1 1s270ms 110ms 260ms 260ms 5 rip 512.0KiB 0 0 0 0 rip 136 1 120ms 70ms 60ms 120ms connected networks 6 routing policy configuration 768.0KiB 768.0KiB 0 0 0 policy 133 1 2s290ms 3s170ms 80ms 80ms 7 BGP service 768.0KiB 0 0 0 0 bgp 134 1 2s760ms 5s480ms 20ms 60ms connected networks 8 BFD service 512.0KiB 0 0 0 0 12 135 1 100ms 90ms 40ms 120ms connected networks 9 BGP Input 10.155.101.186 3072.0KiB 6.2MiB 0 0 0 20 183 1 1s350ms 1s190ms 20ms 20ms 10 BGP Output 10.155.101.186 5.5MiB 0 0 0 0 21 184 1 5s400ms 500ms 3s880ms 3s880ms 11 BGP Input 10.155.101.232 3072.0KiB 6.2MiB 0 0 0 22 187 1 970ms 740ms 20ms 20ms 12 BGP Output 10.155.101.232 8.2MiB 0 0 0 0 23 188 1 10s830ms 960ms 7s 7s 13 Global memory 256.0KiB global 0 0

Moving from ROSv6 to v7 with examples Routing Tables Use of Routing Tables and Policy Routing OSPF Configuration BGP Configuration Monitoring Advertisements Networks Routing Filters RPKI RIP Configuration Routing Tables By default, all routes are added to the "main" routing table as it was before. From a configuration point of view, the biggest differences are routing table limit increase, routing table monitoring differences, and how routes are added to specific routing tables (see next example) v7 introduces a new menu /routing route, which shows all address family routes as well as all filtered routes with all possible route attributes. a /ip route nd menus are used to add static routes and for simplicity show only basic route attributes. /ipv6 route For more in-depth information on routing see this article ( ). IP Routing Another new change is that most common route print requests are processed by the routing process which significantly improves the speed compared to v6. Use of Routing Tables and Policy Routing The main difference from v6 is that the routing table must be added to the menu before actually referencing it anywhere in the /routing table configuration. And parameter should be specified if the routing table is intended to push routes to the FIB.fib The routing rule configuration is the same except for the menu location (instead of , now it is ). /ip route rule /routing rule Let's consider a basic example where we want to resolve 8.8.8.8 only in the routing table named myTable to the gateway 172.16.1.1: /routing table add name=myTable fib /routing rule add dst-address=8.8.8.8 action=lookup-only-in-table table=myTable /ip route add dst-address=8.8.8.8 gateway=172.16.1.1@main routing-table=myTable Instead of routing rules, you could use mangle to mark packets with routing-mark, the same way as it was in ROSv6. OSPF Configuration OSPFv3 and OSPFv2 are now merged into one single menu . At the time of writing this article, there are no default instances and areas. /routing ospf To start both OSPFv2 and OSPF v3 instances, first, you need to create an instance for each and then add an area to the instance. /routing ospf instance add name=v2inst version=2 router-id=1.2.3.4 add name=v3inst version=3 router-id=1.2.3.4 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=backbone_v3 area-id=0.0.0.0 instance=v3inst At this point, you are ready to start OSPF on the network interface. In the case of IPv6, you add either interface on which you want to run OSPF (the same as ROSv6) or the IPv6 network. In the second case, OSPF will automatically detect the interface. Here are some interface configuration examples:

/routing ospf interface-template add network=192.168.0.0/24 area=backbone_v2 add network=2001:db8::/64 area=backbone_v3 add network=ether1 area=backbone_v3 ROSv7 uses templates to match the interface against the template and apply configuration from the matched template. OSPF menus and interface ne contains read-only entries purely for status monitoring. ighbor All route distribution control is now done purely with routing filter select, no more redistribution knobs in the instance (Since the v7.1beta7 redistribution knob is back, you still need to use routing filters to set route costs and type if necessary). This gives greater flexibility on what routes from which protocols you want to redistribute. For example, let's say you want to redistribute only static IPv4 routes from the 192.168.0.0/16 network range. /routing ospf instance set backbone_v2 out-filter-chain=ospf_out redistribute=static /routing filter rule add chain=ospf_out rule="if (dst in 192.168.0.0/16) {accept}" BGP Configuration There is a complete redesign of the BGP configuration compared to ROSv6. The first biggest difference is that there is no more and conf instance peer iguration menus. Instead, we have , and menus. connection templatesession The reason for such a structure is to strictly split parameters that are responsible for connection and parameters that are BGP protocol specific. Let's start with the Template. It contains all BGP protocol-related configuration options. It can be used as a template for dynamic peers and apply a similar config to a group of peers. Note that this is not the same as peer groups on Cisco devices, where the group is more than just a common configuration. By default, there is a default template that requires you to set your own AS. /routing/bgp/template set default as=65533 Most of the parameters are similar to ROSv6 except that some are grouped in the output and input section making the config more readable and easier to understand whether the option is applied on input or output. If you are familiar with CapsMan then the syntax is the same, for example, to specify the output selection chain you set . =myBgpChain output.filter-chain You can even inherit template parameters from another template, for example: /routing/bgp/template add name=myAsTemplate as=65500 output.filter-chain=myAsFilter set default template=myAsTemplate Another important aspect of the new routing configuration is the global Router ID, which sets router-id and group peers in one instance. RouterOS adds a default ID which picks instance-id from any interface's highest IP. The default BGP template by default is set to use the "default" ID. If for any reason you need to tweak or add new instances it can be done in menu. /routing id Very interesting parameters are , they allow control in which process input and output of active session will be input.affinity and output.affinity processed: The default action of the routing filter chain is "drop" Starting from v7.1beta4 template parameters are exposed in the "connection" configuration. This means that the template is not mandatory anymore, allowing for an easier basic BGP connection setup, similar to what it was in ROSv6.

alone - input and output of each session are processed in its own process, most likely the best option when there are a lot of cores and a lot of peers afi, instance, vrf, remote-as - try to run input/output of new session in process with similar parameters main - run input/output in the main process (could potentially increase performance on single-core even possibly on multicore devices with small amount of cores) input - run output in the same process as input (can be set only for output affinity) Now that we have parameters set for the template we can add BGP connections. A minimal set of parameters are , remote.address template, conne , and ctlisten local.role Connect and listen to parameters specify whether peers will try to connect and listen to a remote address or just connect or just listen. It is possible that in setups where peer uses the multi-hop connection local.address must be configured too (similar as it was with update-source in ROSv6). Peer role is now a mandatory parameter, for basic setups, you can just use ibgp, ebgp (more information on available roles can be found in the corresponding RFC draft ), keep in mind that at the moment capabilities, https://datatracker.ietf.org/doc/draft-ietf-idr-bgp-open-policy/?include_text=1 communities, and filtering described in the draft is not implemented. Very basic iBGP set up to listen on the whole local network for connections: /routing/bgp/connection add remote.address=10.155.101.0/24 listen=yes template=default local.role=ibgp Now you can monitor the status of all connected and disconnected peers from menu. /routing bgp session Other great debugging information on all routing processes can be monitored from menu /routing stats [admin@v7_ccr_bgp] /routing/stats/process> print interval=1 Columns: TASKS, PRIVATE-MEM-BLOCKS, SHARED-MEM-BLOCKS, PSS, RSS, VMS, RETIRED, ID, PID, RPID, PROCESS-TIME, KERNEL-TIME, CUR-B> # TASKS PRIVATE-M SHARED-ME PSS RSS VMS RET ID PID R PROCESS-TI KERN> 0 routing tables 12.2MiB 20.0MiB 18.7MiB 42.2MiB 83.4MiB 8 main 319 0 19s750ms 8s50> rib > connected networks > 1 fib 512.0KiB 0 7.4MiB 30.9MiB 83.4MiB fib 384 1 5s160ms 22s5> 2 ospf 1024.0KiB 1024.0KiB 5.9MiB 25.9MiB 83.4MiB 382 ospf 388 1 1m42s170ms 1m31> connected networks > 3 fantasy 512.0KiB 0 2061.0KiB 5.9MiB 83.4MiB fantasy 389 1 1s410ms 870m> 4 configuration and reporting 40.0MiB 512.0KiB 45.0MiB 64.8MiB 83.4MiB static 390 1 12s550ms 1s17> 5 rip 768.0KiB 0 5.3MiB 24.7MiB 83.4MiB rip 387 1 1s380ms 1s20> connected networks > 6 routing policy configuration 512.0KiB 256.0KiB 2189.0KiB 6.0MiB 83.4MiB policy 385 1 1s540ms 1s20> 7 BGP service 768.0KiB 0 2445.0KiB 6.2MiB 83.4MiB bgp 386 1 6s170ms 9s38> 8 BGP Input 10.155.101.217 8.8MiB 6.0MiB 15.6MiB 38.5MiB 83.4MiB 20 21338 1 25s170ms 3s23> BGP Output 10.155.101.217 > 9 Global memory 256.0KiB global 0 0 > -- [Q quit|D dump|C-z pause|right] Route filtering differs a bit from ROSv6. In the BGP template, you can now specify , as well as several output.filter-chain, output.filter-select input.filter input. * options. accept- Now * allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory input.accept- usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in table as "not active, /routing route filtered", A very basic example of a BGP input filter to accept prefixes from 192.168.0.0/16 subnet without modifying any attributes. For other prefixes subtract 1 from the received local pref value and set IGP metric to value from OSPF ext. Additionally, we will accept only specific prefixes from the address list to reduce memory usage /ip/firewall/address-list add list=bgp_list dst-address=192.168.1.0/24 add list=bgp_list dst-address=192.168.0.0/24 add list=bgp_list dst-address=172.16.0.0/24 It is not mandatory to specify a remote AS number. ROS v7 can determine remote ASN from an open message. You should specify the remote AS only when you want to accept a connection from that specific AS.

/routing/bgp/template set default input.filter=bgp_in .accept-nlri=bgp_list /routing/filter/rule add chain=bgp_in rule="if (dst in 192.168.0.0/16) {accept}" add chain=bgp_in rule="set bgp-local-pref -1; set bgp-igp-metric ospf-ext-metric; accept" Monitoring Advertisements RouterOS v7 by default disables monitoring of the BGP output. This allows to significantly reduce resource usage on setups with large routing tables. To be able to see output advertisements several steps should be taken: enable "output.keep-sent-attributes" in BGP connection configuration run "dump-saved-advertisements" from BGP session menu view saved output from "/routing/stats/pcap" menu [admin@arm-bgp] /routing/bgp/connection> set 0 output.keep-sent-attributes=yes [admin@arm-bgp] /routing/bgp/session> print Flags: E - established 0 E remote.address=10.155.101.183 .as=444 .id=192.168.44.2 .refused-cap-opt=no .capabilities=mp,rr,gr,as4 .afi=ip,ipv6 .messages=4 .bytes=219 .eor="" local.address=10.155.101.186 .as=456 .id=10.155.255.186 .capabilities=mp,rr,gr,as4 .afi=ip,ipv6 .messages=1 .bytes=19 .eor="" output.procid=66 .filter-chain=bgp_out .network=bgp-nets .keep-sent-attributes=yes input.procid=66 ebgp hold-time=3m keepalive-time=1m uptime=4s30ms [admin@arm-bgp] /routing/bgp/session> dump-saved-advertisements 0 save-to=test_out.pcap Networks Lastly, you might notice that the menu is missing and probably wondering how to advertise your own networks. Now networks are added to the network firewall address-list and referenced in the BGP configuration. Following ROSv6 network configuration: /routing bgp network add network=192.168.0.0/24 synchronize=yes /ip route add dst-address=192.168.0.0/24 type=blackhole would translate to v7 as: /ip/firewall/address-list/ add list=bgp-networks address=192.168.0.0/24 /ip/route add dst-address=192.168.0.0/24 blackhole /routing/bgp/connection set peer_name output.network=bgp-networks If the routing filter chain is not specified BGP will try to advertise every active route it can find in the routing table The default action of the routing filter chain is "drop"

There is more configuration to be done when adding just one network but offers simplicity when you have to deal with a large number of networks. v7 even allows specifying for each BGP connection its own set of networks. Routing Filters Starting from ROSv7.1beta4, the routing filter configuration is changed to a script-like configuration. The rule now can have "if .. then" syntax to set parameters or apply actions based on conditions from the "if" statement. Multiple rules without action are stacked in a single rule and executed in order like a firewall, the reason is that the "set" parameter order is important and writing one "set"s per line, allows for an easier understanding from top to bottom on what actions were applied. For example, match static default route and apply action accept can be written in one config rule: /routing/filter/rule add chain=ospf_in rule="if (dst==0.0.0.0/0 && protocol static) { accept }" For example, ROSv6 rule "/routing filter add chain=ospf_in prefix=172.16.0.0/16 prefix-length=24 protocol=static action=accept" converted to ROSv7 would be: /routing/filter/rule add chain=ospf_in rule="if (dst in 172.16.0.0/16 && dst-len==24 && protocol static) { accept }" Another example, to match prefixes from the 172.16.0.0/16 range with prefix length equal to 24 and set BGP med and prepend values /routing/filter/rule add chain=BGP_OUT rule="if (dst-len==24 && dst in 172.16.0.0/16) { \n set bgp-med 20; set bgp-path-prepend 2; accept }" It is also possible to match prefix length range like this /routing/filter/rule add chain=BGP_OUT rule="if (dst-len>13 && dst-len<31 && dst in 172.16.0.0/16) { accept }" Filter rules now can be used to match or set communities, large communities, and extended communities from the community list: /routing/filter/rule add chain=bgp_in rule="set bgp-large-communities 200001:200001:10 " If there are a lot of community sets, that need to be applied in multiple rules, then it is possible to define community sets and use them to match or set: /routing/filter/large-community-set add set=myLargeComSet communities=200001:200001:10 /routing/filter/rule add chain=bgp_in rule="append bgp-large-communities myLargeComSet " Since route-target is encoded in extended community attribute to change or match RT you need to operate on extended community attribute, for example: In v7 it is not possible to turn off synchronization with IGP routes (the network will be advertised only if the corresponding IGP route is present in the routing table).

/routing/filter/rule add chain=bgp_in rule="set bgp-ext-communities rt:327824:20 " RPKI RouterOS implements an RTR client. You connect to the server which will send route validity information. This information then can be used to validate routes in route filters against a group with "rpki-validate" and further in filters "match-rpki" can be used to match the exact state. For more info refer to the documentation. RPKI RIP Configuration To start RIP, the instance should be configured. There you should select which routes will be redistributed by RIP and if it will redistribute the default route. /routing/rip/instance add name=instance1 originate-default=never redistribute=connected,static Then interface-template should be configured. There is no need to define networks in ROS version 7 as it was in version 6. /routing/rip/interface-template add interfaces=ether1 instance=instance1 Now the basic configuration is completed on one router. RIP neighbor router should be configured in a similar way. In ROS v7 the neighbors will appear only when there are routes to be sent or/and to be received. Prefix lists from ROSv6 are deprecated, now all the filtering must be done by the routing filters.

Routing Protocol Multi-core Support Overview RouterOS v7 is capable of splitting tasks between multiple processes. There is one " " task, which can start/stop sub-tasks and process data between those sub-tasks. Each sub-task can allocate "private" (only accessible main by this particular task) and "shared" memory (accessible by all route tasks). List of tasks that run in separate processes (if multiprocess routing is enabled): Handling of "print" command; Entire OSPF protocol handling; Entire RIP protocol handling; Entire ISIS protocol handling; Static configuration handling; Routing Policy configuration; BGP connections and configuration handling; BGP receive (one task per peer or grouped by specific parameters); BGP send (one task per peer or grouped by specific parameters); FIB update. BGP Sub-Tasks BGP receive and send can be split into sub-tasks by specific parameters, for example, it is possible to run input per each peer or group all peer inputs and run them in the main process. This split by sub-tasks is controlled with and parameter configuration in input.affinity output.affinity /routing .It is possible to boost performance by playing with affinity values on devices with fewer cores since sharing data between tasks is a bit /bgp/template slower than processing the same data within one task. For example, on single-core or two-core devices running input and output in the main or instance process will boost performance. All currently used tasks and their allocated private/shared memory can be monitored using the command: /routing/stats/process/print Sample Output: BGP can have up to 100 unique processes.

[admin@BGP_MUM] /routing/stats/process> print interval=1 Columns: TASKS, PRIVATE-MEM-BLOCKS, SHARED-MEM-BLOCKS, PSS, RSS, VMS, RETIRED, ID, PID, RPID, PROCESS-TIME, KERNEL-TIME, CUR-BUSY, MAX-BUSY, CUR-CALC, MAX-CALC # TASKS PRIVATE-M SHARED-M PSS RSS VMS R ID PID R PROCESS- KERNEL-TI CUR- MAX-BUSY CUR- MAX-CALC 0 routing tables 11.8MiB 20.0MiB 19.8MiB 42.2MiB 51.4MiB 7 main 195 0 15s470ms 2s50ms 20ms 1s460ms 20ms 35s120ms rib connected networks 1 fib 2816.0KiB 0 8.1MiB 27.4MiB 51.4MiB fib 255 1 5s730ms 7m4s790ms 23s350ms 23s350ms 2 ospf 512.0KiB 0 3151.0KiB 14.6MiB 51.4MiB ospf 260 1 20ms 100ms 20ms 20ms connected networks 3 fantasy 256.0KiB 0 1898.0KiB 5.8MiB 51.4MiB fantasy 261 1 40ms 60ms 20ms 20ms 4 configuration and reporting 4096.0KiB 512.0KiB 9.2MiB 28.4MiB 51.4MiB static 262 1 3s210ms 40ms 220ms 220ms 5 rip 512.0KiB 0 3151.0KiB 14.6MiB 51.4MiB rip 259 1 50ms 90ms 20ms 20ms connected networks 6 routing policy configuration 768.0KiB 768.0KiB 2250.0KiB 6.2MiB 51.4MiB policy 256 1 70ms 50ms 20ms 20ms 7 BGP service 768.0KiB 0 3359.0KiB 14.9MiB 51.4MiB bgp 257 1 4s260ms 8s50ms 30ms 30ms connected networks 8 BFD service 512.0KiB 0 3151.0KiB 14.6MiB 51.4MiB 12 258 1 80ms 40ms 20ms 20ms connected networks 9 BGP Input 10.155.101.232 8.2MiB 6.8MiB 17.0MiB 39.1MiB 51.4MiB 20 270 1 24s880ms 3s60ms 18s550ms 18s550ms BGP Output 10.155.101.232 10 Global memory 256.0KiB global 0 0 Routing Table Update Mechanism Illustration below tries to explain in more user friendly form on how routing table update mechanism is working.

Routing protocols continuously loop through following procedures: " " process waits for updates from other sub tasks (1); main " " starts to calculate new routes (2..4) if: main update from sub task is received; protocol has not published all routes; configuration has changed or link state has changed. during new route calculation (5) following event occur: all received updates are applied to the route; gateway reachability is being determined; recursive route is being resolved; " " event is called where " " routes are being published. During this phase, " " routes will not change, but protocols can still publish current current receive and send updates (6). Do cleanup and free unused memory (7). In this step everything that is no longer used in new " " table is removed (routes, attributes, etc.). current Consider " " and " " as two copies of routing table, where " " table (2) is the one used at the moment and " " (1) is table of updated current current updated candidate routes to be published in the next publish event (3 and 4). This method prevents protocols to fill memory with buffered updates while " " main process is doing " ", instead protocols sends the newest update directly to "main" process which then copies new update in " " table. A bit publish updated more complicated is OSPF, it internally has similar process to select current OSPF routes which then are sent to the " " for further processing. main

Policy Routing Overview Policy routing is the method to steer traffic matching certain criteria to a certain gateway. This can be used to force some customers or specific protocols from the servers (for example HTTP traffic) to always be routed to a certain gateway. It can even be used to steer local and overseas traffic to different gateways. RouterOS implements several components that can be used to achieve said task: routing tables routing rules firewall mangle marking Routing Tables A router can have multiple routing tables with its own set of routes routing the same destination to different gateways. Tables can be seen and configured from the menu. /routing/table By default, RouterOS has only the ' ' routing table: main [admin@rack1_b33_CCR1036] /routing/table> print Flags: D - dynamic; X - disabled, I - invalid; U - used 0 D name="main" fib If a custom routing table is required, it should be defined in this menu prior to using it anywhere in the configuration. Let's consider a basic example where we have two gateways 172.16.1.1 and 172.16.2.1 and we want to resolve 8.8.8.8 only in the routing table named ' my ' to the gateway 172.16.2.1: Table /routing table add name=myTable fib /ip route add dst-address=8.8.8.8 gateway=172.16.1.1 /ip route add dst-address=8.8.8.8 gateway=172.16.2.1@main routing-table=myTable In our example, the routing table should also have a route to destination 8.8.8.8 or at least a default route, since the default route is dynamically main added by the DHCP for safety reasons it is better to add 8.8.8.8 also in the main table. For a user-created table to be able to resolve the destination, the main routing table should be able to resolve the destination too.

[admin@rack1_b33_CCR1036] /ip/route> print detail Flags: D - dynamic; X - disabled, I - inactive, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, y - cop y; H - hw-offloaded; + - ecmp DAd dst-address=0.0.0.0/0 routing-table=main pref-src="" gateway=172.16.1.1 immediate-gw=172.16.1.1%ether8 distance=1 scope=30 target-scope=10 vrf-interface=ether8 suppress-hw-offload=no 0 As dst-address=8.8.8.8/32 routing-table=main pref-src="" gateway=172.16.1.1 immediate-gw=172.16.1.1%ether8 distance=1 scope=30 target-scope=10 suppress-hw-offload=no DAc dst-address=172.16.1.0/24 routing-table=main gateway=ether8 immediate-gw=ether8 distance=0 scope=10 suppress-hw-offload=no local-address=172.16.1.2%ether8 DAc dst-address=172.16.2.0/24 routing-table=main gateway=ether7 immediate-gw=ether7 distance=0 scope=10 suppress-hw-offload=no local-address=172.16.2.2%ether7 1 As dst-address=8.8.8.8/32 routing-table=myTable pref-src="" gateway=172.16.2.1 immediate-gw=172.16.2.1%ether7 distance=1 scope=30 target-scope=10 suppress-hw-offload=no But configuration above is not enough, we need a method to force the traffic to actually use our newly created table. RouterOS gives you two options to choose from: firewall mangle - it gives more control over the criteria to be used to steer traffic, for example, per connection or per packet balancing, etc. For more info on how to use mangle marking see examples. Firewall Marking routing rules - a basic set of parameters that can be used to quickly steer traffic. This is the method we are going to use for our example. It is not recommended to use both methods at the same time or you should know exactly what you are doing. If you really do need to use both mangle and routing rules in the same setup then keep in mind that mangle has higher priority, meaning if the mangle marked traffic can be resolved in the table then route rules will never see this traffic. Routing Rules Routing rules allow steering traffic based on basic parameters like a source address, a destination address, or in-interface as well as other parameters. For our example, we want to select traffic with destination 8.8.8.8 and do not fall back to the table: main /routing rule add dst-address=8.8.8.8 action=lookup-only-in-table table=myTable Lets's say that we know that customer is connected to ether4 and we want only that customer to route 8.8.8.8 to a specific gateway. We can use the following rule: /routing rule add dst-address=8.8.8.8 action=lookup-only-in-table table=myTable interface=ether4 If for some reason the gateway used in our table goes down, the whole lookup will fail and the destination will not be reachable. In active-backup setups we want the traffic to be able to fall back to the table. To do that change the action from to . main lookup-only-in-table lookup Also, routing rules can be used as a very "basic firewall". Let's say we do not want to allow a customer connected to ether4 to be able to access the 192.168.1.0/24 network: /routing rule add dst-address=192.168.1.0/24 interface=ether4 action=drop Routing table count is limited to 4096 unique tables.

List of all the parameters that can be used by routing rules: Property Description action (drop | lookup | lookup-only-in-table ) | unreachableAn action to take on the matching packet: drop - silently drop the packet. lookup - perform a lookup in routing tables. lookup-only-in-table - perform lookup only in the specified routing table (see parameter). table unreachable - generate ICMP unreachable message and send it back to the source. comment ( ) string disabled ( ) yes | no The disabled rule is not used. dst-address () The destination address of the packet to match. interface ( ) string Incoming interface to match. min-prefix ( ) integer [0..4294967295] Equivalent to Linux IP rule . For example to suppress the default route in the suppress_prefixlength routing decision set the value to 0. routing-mark ( ) string Match specific routing mark. src-address ( ) string The source address of the packet to match. table ( ) name Name of the routing table to use for lookup.

Virtual Routing and Forwarding - VRF Description Configuration Supported features VRF interfaces in firewall Examples Simple VRF-Lite setup Static inter-VRF routes Static VRF-Lite Connected route leaking Dynamic Vrf-Lite route leaking Dynamic Vrf-Lite route leaking (old workaround) The simplest MPLS VPN setup CE1 Router CE2 Router PE1 Router PE2 Router (Cisco) A more complicated setup (changes only) CE1 Router, cust-one CE2 Router, cust-one PE1 Router Variation: replace the Cisco with another MT PE2 Mikrotik config References Description RouterOS allows to create multiple Virtual Routing and Forwarding instances on a single router. This is useful for BGP-based MPLS VPNs. Unlike BGP VPLS, which is OSI Layer 2 technology, BGP VRF VPNs work in Layer 3 and as such exchange IP prefixes between routers. VRFs solve the problem of overlapping IP prefixes and provide the required privacy (via separated routing for different VPNs). It is possible to set up vrf-lite setups or use multi-protocol BGP with VPNv4 address family to distribute routes from VRF routing tables - not only to other routers, but also to different routing tables in the router itself. Configuration VRF table is created in menu. After the VRF config is created routing table mapping is added (a dynamic table with the same name is created). /ip vrf Each active VRF will always have a mapped routing table. [admin@arm-bgp] /ip/vrf> print Flags: X - disabled; * - builtin 0 * name="main" interfaces=all [admin@arm-bgp] /routing/table> print Flags: D - dynamic; X - disabled, I - invalid; U - used 0 D name="main" fib Note that the order of the added VRFs is significant. To properly match which interface will belong to the VRF care must be taken to place VRFs in the correct order (matching is done starting from the top entry, just like firewall rules). Let's look at the following example: Since each VRF has mapped routing table, count of max unique VRFs is also limited to 4096.

[admin@arm-bgp] /ip/vrf> print Flags: X - disabled; * - builtin 0 * name="main" interfaces=all 1 name="myVrf" interfaces=lo_vrf Since the first entry is matching all the interfaces, the second VRF will not have any interfaces added. To fix the problem order of the entries must be changed. [admin@arm-bgp] /ip/vrf> move 1 0 [admin@arm-bgp] /ip/vrf> print Flags: X - disabled; * - builtin 0 name="myVrf" interfaces=lo_vrf 1 * name="main" interfaces=all Connected routes from the interfaces assigned to the VRF will be installed in the right routing table automatically. For example, let's make an SSH service to listen for connections on the interfaces belonging to the VRF: [admin@arm-bgp] /ip/service> set ssh vrf=myVrf [admin@arm-bgp] /ip/service> print Flags: X, I - INVALID Columns: NAME, PORT, CERTIFICATE, VRF # NAME PORT CERTIFICATE VRF 0 telnet 23 main 1 ftp 21 2 www 80 main 3 ssh 22 myVrf 4 X www-ssl 443 none main 5 api 8728 main 6 winbox 8291 main 7 api-ssl 8729 none main Adding routes to the VRF is as simple as specifying the routing-table parameter when adding the route and specifying in which routing table to resolve the gateway by specifying after the gateway IP: @name /ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@myVrf routing-table=myVrf Traffic leaking between VRFs is possible if the gateway is explicitly set to be resolved in another VRF, for example: # add route in the myVrf, but resolve the gateway in the main table /ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@main routing-table=myVrf # add route in the main table, but resolve the gateway in the myVrf /ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@myVrf Supported features Different services can be placed in specific VRF on which the service is listening for incoming or creating outgoing connections. By default, all services are using the table, but it can be changed with a separate parameter or by specifying the VRF name separated by "@" at the end of the IP address. main vrf When the interface is assigned to the VRF as well as connected routes it does not mean that RouterOS services will magically know which VRF to use just by specifying the IP address in the configuration. Each service needs VRF support to be added and explicit configuration. Whether the service has VRF support and has VRF configuration options refer to appropriate service documentation. If the gateway configuration does not have an explicitly configured table to be resolved in, then it is considered, that gateway should be resolved in the "main" table.

Below is the list of supported services. Feature Support Comment BGP +/routing bgp template add name=bgp-template1 vrf=vrf1 /routing bgp vpls add name=bgp-vpls1 site-id=10 vrf=vrf1 /routing bgp vpn add label-allocation-policy=per-vrf vrf=vrf1 E-mail +/tool e-mail set address=192.168.88.1 vrf=vrf1 IP Services+ VRF is supported for , , , , , , services. The service does not telnet wwwsshwww-ssl apiwinbox api-ssl ftp support changing the VRF. /ip service set telnet vrf=vrf1 L2TP Client+/interface l2tp-client add connect-to=192.168.88.1@vrf1 name=l2tp-out1 user=l2tp-client MPLS +/mpls ldp add vrf=vrf1 Netwatch +/tool netwatch add host=192.168.88.1@vrf1 NTP +/system ntp client set vrf=vrf1 /system ntp server set vrf=vrf1 OSPF +/routing ospf instance add disabled=no name=ospf-instance-1 vrf=vrf1 ping +/ping 192.168.88.1 vrf=vrf1 RADIUS +/radius add address=192.168.88.1@vrf1 /radius incoming set vrf=vrf1

RIP +/routing rip instance add name=rip-instance-1 vrf=vrf1 RPKI +/routing rpki add vrf=vrf1 SNMP +/snmp set vrf=vrf1 EoIP +/interface eoip add remote-address=192.168.1.1@vrf1 IPIP +/interface ipip add remote-address=192.168.1.1@vrf1 GRE +/interface gre add remote-address=192.168.1.1@vrf1 SSTP- client+/interface sstp-client add connect-to=192.168.1.1@vrf1 OVPN- client+/interface ovpn-client add connect-to=192.168.1.1@vrf1 L2TP- ether+/interface l2tp-ether add connect-to=192.168.2.2@vrf VXLAN +/interface vxlan add vni=10 vrf=vrf1 Fetch +/tool/fetch address=10.155.28.236@vrf1 mode=ftp src-path=my_file.pcap user=admin password="" DNS + Starting from RouterOS v7.15/ip dns set vrf=vrf1 DHCP- Relay+ Starting from RouterOS v7.15/ip dhcp-relay set dhcp-server-vrf=vrf1 If dhcp-client is in vrf - special parameter in "ip dhcp-relay" configuration is not needed

VRF interfaces in firewall Started from version 7.14 when interfaces are added in VRF - virtual VRF interface is created automatically. If it is needed to match traffic which belongs to VRF interface, VRF virtual interface should be used in firewall filters, for example: /ip vrf add interfaces=ether5 name=vrf5 /ip firewall filter add chain=input in-interface=vrf5 action=accept If there are several interfaces in one VRF but it is needed to match only one of these interfaces - marks should be used. For example: /ip vrf add interface=ether15,ether16 vrf=vrf1516 /ip firewall mangle add action=mark-connection chain=prerouting connection-state=new in-interface=ether15 new-connection- mark=input_allow passthrough=yes /ip firewall filter add action=accept chain=input connection-mark=input_allow Examples Simple VRF-Lite setup Let's consider a setup where we need two customer VRFs that require access to the internet: /ip address add address=172.16.1.2/24 interface=public add address=192.168.1.1/24 interface=ether1 add address=192.168.2.1/24 interface=ether2 /ip route add gateway=172.16.1.1 # add VRF configuration /ip vrf add name=cust_a interface=ether1 place-before 0 add name=cust_b interface=ether2 place-before 0 # add vrf routes /ip route add gateway=172.16.1.1@main routing-table=cust_a add gateway=172.16.1.1@main routing-table=cust_b # masquerade local source /ip firewall nat add chain=srcnat out-interface=public action=masquerade It might be necessary to ensure that packets coming in the "public" interface can actually reach the correct VRF. This can be solved by marking new connections originated by the VRF customers and steering the traffic by routing marks of incoming packets on the "public" interface. Before RouterOS version 7.14, firewall filter rules with the property in/out-interface would apply to interfaces within a VRF instance. Starting from RouterOS version 7.14, these rules no longer target individual interfaces within a VRF, but rather the VRF interface as a whole.

/ip address add address=10.11.0.1/24 interface=sfp-sfpplus1 add address=10.12.0.1/24 interface=sfp-sfpplus2 # add VRF configuration /ip vrf add name=vrfTest1 interface=sfp-sfpplus1 place-before 0 add name=vrfTest2 interface=sfp-sfpplus2 place-before 0 We can say that connected network is reachable on specific vrf by setting gateway "interface@vrf" # add vrf routes /ip route add dst-address=10.11.0.0/24 gateway="sfp-sfpplus1@vrfTest1" routing-table=vrfTest2 add dst-address=10.12.0.0/24 gateway="sfp-sfpplus2@vrfTest2" routing-table=vrfTest1 Verify routes and reachability: [admin@CCR2004_2XS] /ip/route> print detail Flags: D - dynamic; X - disabled, I - inactive, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, i - is-is, d - dhcp, v - vpn, m - modem, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp DAc dst-address=111.11.0.0/24 routing-table=vrfTest1 gateway=sfp-sfpplus1@vrfTest1 immediate-gw=sfp- sfpplus1 distance=0 scope=10 suppress-hw-offload=no local-address=111.11.0.1%sfp-sfpplus1@vrfTest1 1 As dst-address=111.12.0.0/24 routing-table=vrfTest1 pref-src="" gateway=vrfTest2 immediate-gw=vrfTest2 distance=1 scope=30 target-scope=10 suppress-hw-offload=no 2 As dst-address=111.11.0.0/24 routing-table=vrfTest2 pref-src="" gateway=vrfTest1 immediate-gw=vrfTest1 distance=1 scope=30 target-scope=10 suppress-hw-offload=no DAc dst-address=111.12.0.0/24 routing-table=vrfTest2 gateway=sfp-sfpplus2@vrfTest2 immediate-gw=sfp- sfpplus2 distance=0 scope=10 suppress-hw-offload=no local-address=111.12.0.1%sfp-sfpplus2@vrfTest2 [admin@cl2] > /ping 111.11.0.2 src-address=111.12.0.2 SEQ HOST SIZE TTL TIME STATUS 0 111.11.0.2 56 64 67us 1 111.11.0.2 56 64 61us sent=2 received=2 packet-loss=0% min-rtt=61us avg-rtt=64u But now what if we want to access routers local address located in another vrf? Keep in mind that trying to leak overlapping networks will not work.

[admin@cl2] > /ping 111.11.0.1 src-address=111.12.0.2 SEQ HOST SIZE TTL TIME STATUS 0 111.11.0.1 timeout 1 111.11.0.1 timeout sent=2 received=0 packet-loss=100% Approach with "interface@vrf" gateways works only when router is forwarding packets. To access local vrf addresses we need to route to the vrf interface. # add vrf routes /ip route add dst-address=10.11.0.0/24 gateway=vrfTest1@vrfTest1 routing-table=vrfTest2 add dst-address=10.12.0.0/24 gateway=vrfTest2@vrfTest2 routing-table=vrfTest1 [admin@cl2] > /ping 111.11.0.1 src-address=111.12.0.2 SEQ HOST SIZE TTL TIME STATUS 0 111.11.0.1 56 64 67us 1 111.11.0.1 56 64 61us sent=2 received=2 packet-loss=0% min-rtt=61us avg-rtt=64u Dynamic Vrf-Lite route leaking With large enough setups static route leaking is not sufficient. Let's consider we have the same setup as in static route leaking example plus ipv6 addresses, just for demonstration. /ip address add address=10.11.0.1/24 interface=sfp-sfpplus1 add address=10.12.0.1/24 interface=sfp-sfpplus2 # add VRF configuration /ip vrf add name=vrfTest1 interface=sfp-sfpplus1 place-before 0 add name=vrfTest2 interface=sfp-sfpplus2 place-before 0 /ipv6 address add address=2001:1::1 advertise=no interface=sfp-sfpplus1 add address=2001:2::1 advertise=no interface=sfp-sfpplus2 We can use BGP VPN to leak local routes without actually establishing BGP session. /routing bgp vpn add export.redistribute=connected .route-targets=1:1 import.route-targets=1:2 label-allocation-policy=per-vrf name=bgp-mpls-vpn-1 \ route-distinguisher=1.2.3.4:1 vrf=vrfTest1 add export.redistribute=connected .route-targets=1:2 import.route-targets=1:1 label-allocation-policy=per-vrf name=bgp-mpls-vpn-2 \ route-distinguisher=1.2.3.4:1 vrf=vrfTest2 Be careful with import/export route targets, if not set up properly local vrf routes from itself will be imported.

Now we can see that connected routes between VRFs are exchanged [admin@CCR2004_2XS] > /routing route print where dst-address in 111.0.0.0/8 && afi=ip4 ... Ac afi=ip4 contribution=active dst-address=111.11.0.0/24 routing-table=vrfTest1 gateway=sfp- sfpplus1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 belongs-to="connected" local-address=111.11.0.1%sfp-sfpplus1@vrfTest1 debug.fwp-ptr=0x202421E0 Ay afi=ip4 contribution=best-candidate dst-address=111.12.0.0/24 routing-table=vrfTest1 label=17 gateway=vrfTest2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=200 scope=40 target-scope=10 belongs-to="bgp-mpls-vpn-1-bgp-mpls-vpn-2-connected-export-import" bgp.ext-communities=rt:1:2 .atomic-aggregate=no .origin=incomplete debug.fwp-ptr=0x202425A0 Ay afi=ip4 contribution=best-candidate dst-address=111.11.0.0/24 routing-table=vrfTest2 label=16 gateway=vrfTest1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=200 scope=40 target-scope=10 belongs-to="bgp-mpls-vpn-2-bgp-mpls-vpn-1-connected-export-import" bgp.ext-communities=rt:1:1 .atomic-aggregate=no .origin=incomplete debug.fwp-ptr=0x202424E0 Ac afi=ip4 contribution=active dst-address=111.12.0.0/24 routing-table=vrfTest2 gateway=sfp- sfpplus2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=0 scope=10 belongs-to="connected" local-address=111.12.0.1%sfp-sfpplus2@vrfTest2 debug.fwp-ptr=0x20242240 And IPv6 too: [admin@CCR2004_2XS] /routing/route> print detail where dst-address in 2001::/8 && afi=ip6 ... Ac afi=ip6 contribution=active dst-address=2001:1::/64 routing-table=vrfTest1 gateway=sfp-sfpplus1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 belongs-to="connected" local-address=2001:1::1%sfp-sfpplus1@vrfTest1 debug.fwp-ptr=0x20242300 Ay afi=ip6 contribution=active dst-address=2001:2::/64 routing-table=vrfTest1 label=17 gateway=vrfTest2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=200 scope=40 target-scope=10 belongs-to="bgp-mpls-vpn-1-bgp-mpls-vpn-2-connected-export-import" bgp.ext-communities=rt:1:2 .atomic-aggregate=no .origin=incomplete debug.fwp-ptr=0x202425A0 Ay afi=ip6 contribution=active dst-address=2001:1::/64 routing-table=vrfTest2 label=16 gateway=vrfTest1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=200 scope=40 target-scope=10 belongs-to="bgp-mpls-vpn-2-bgp-mpls-vpn-1-connected-export-import" bgp.ext-communities=rt:1:1 .atomic-aggregate=no .origin=incomplete debug.fwp-ptr=0x202424E0 Ac afi=ip6 contribution=active dst-address=2001:2::/64 routing-table=vrfTest2 gateway=sfp-sfpplus2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=0 scope=10 belongs-to="connected" local-address=2001:2::1%sfp-sfpplus2@vrfTest2 debug.fwp-ptr=0x20242360 Dynamic Vrf-Lite route leaking (old workaround) Before ROS v7.14 there were no mechanism to leak routes from one VRF instance to another within the same router. As a workaround, it was possible to create a tunnel between two locally configure loopback addresses and assign each tunnel endpoint to its own VRF. Then it is possible to run either dynamic routing protocols or set up static routes to leak between both VRFs. The downside of this approach is that tunnel must be created between each VRF where routes should be leaked (create a full mesh), which significantly complicates configuration even if there are just several VRFs, not to mention more complicated setups. For example, to leak routes between 5 VRFs it would require n * ( n – 1) / 2 connections, which will lead to the setup with 20 tunnel endpoints and 20 OSPF instances on one router. Example config with two VRFs of this method:

/interface bridge add name=dummy_custC add name=dummy_custB add name=lo1 add name=lo2 /ip address add address=111.255.255.1 interface=lo1 network=111.255.255.1 add address=111.255.255.2 interface=lo2 network=111.255.255.2 add address=172.16.1.0/24 interface=dummy_custC network=172.16.1.0 add address=172.16.2.0/24 interface=dummy_custB network=172.16.2.0 /interface ipip add local-address=111.255.255.1 name=ipip-tunnel1 remote-address=111.255.255.2 add local-address=111.255.255.2 name=ipip-tunnel2 remote-address=111.255.255.1 /ip address add address=192.168.1.1/24 interface=ipip-tunnel1 network=192.168.1.0 add address=192.168.1.2/24 interface=ipip-tunnel2 network=192.168.1.0 /ip vrf add interfaces=ipip-tunnel1,dummy_custC name=custC add interfaces=ipip-tunnel2,dummy_custB name=custB /routing ospf instance add disabled=no name=i2_custB redistribute=connected,static,copy router-id=192.168.1.1 routing-table=custB vrf=custB add disabled=no name=i2_custC redistribute=connected router-id=192.168.1.2 routing-table=custC vrf=custC /routing ospf area add disabled=no instance=i2_custB name=custB_bb add disabled=no instance=i2_custC name=custC_bb /routing ospf interface-template add area=custB_bb disabled=no networks=192.168.1.0/24 add area=custC_bb disabled=no networks=192.168.1.0/24 Result: [admin@rack1_b36_CCR1009] /routing/ospf/neighbor> print Flags: V - virtual; D - dynamic 0 D instance=i2_custB area=custB_bb address=192.168.1.1 priority=128 router-id=192.168.1.2 dr=192.168.1.1 bdr=192.168.1.2 state="Full" state-changes=6 adjacency=41m28s timeout=33s 1 D instance=i2_custC area=custC_bb address=192.168.1.2 priority=128 router-id=192.168.1.1 dr=192.168.1.1 bdr=192.168.1.2 state="Full" state-changes=6 adjacency=41m28s timeout=33s [admin@rack1_b36_CCR1009] /ip/route> print where routing-table=custB Flags: D - DYNAMIC; A - ACTIVE; c, s, o, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAo 172.16.1.0/24 192.168.1.1%ipip-tunnel2@custB 110 DAc 172.16.2.0/24 dummy_custB@custB 0 DAc 192.168.1.0/24 ipip-tunnel2@custB 0 [admin@rack1_b36_CCR1009] > /ip route/print where routing-table=custC Flags: D - DYNAMIC; A - ACTIVE; c, o, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAc 172.16.1.0/24 dummy_custC@custC 0 DAo 172.16.2.0/24 192.168.1.2%ipip-tunnel1@custC 110 DAc 192.168.1.0/24 ipip-tunnel1@custC 0

The simplest MPLS VPN setup In this example, a rudimentary MPLS backbone (consisting of two Provider Edge (PE) routers PE1 and PE2) is created and configured to forward traffic between Customer Edge (CE) routers CE1 and CE2 routers that belong to VPN. cust-one CE1 Router /ip address add address=10.1.1.1/24 interface=ether1 # use static routing /ip route add dst-address=10.3.3.0/24 gateway=10.1.1.2 CE2 Router /ip address add address=10.3.3.4/24 interface=ether1 /ip route add dst-address=10.1.1.0/24 gateway=10.3.3.3 PE1 Router

/interface bridge add name=lobridge /ip address add address=10.1.1.2/24 interface=ether1 /ip address add address=10.2.2.2/24 interface=ether2 /ip address add address=10.5.5.2/32 interface=lobridge /ip vrf add name=cust-one interfaces=ether1 /mpls ldp add enabled=yes transport-address=10.5.5.2 lsr-id=10.5.5.2 /mpls ldp interface add interface=ether2 /routing bgp template set default as=65000 /routing bgp vpn add vrf=cust-one \ route-distinguisher=1.1.1.1:111 \ import.route-targets=1.1.1.1:111 \ import.router-id=cust-one \ export.redistribute=connected \ export.route-targets=1.1.1.1:111 \ label-allocation-policy=per-vrf /routing bgp connection add template=default remote.address=10.5.5.3 address-families=vpnv4 local.address=10.5.5.2 # add route to the remote BGP peer's loopback address /ip route add dst-address=10.5.5.3/32 gateway=10.2.2.3 PE2 Router (Cisco) ip vrf cust-one rd 1.1.1.1:111 route-target export 1.1.1.1:111 route-target import 1.1.1.1:111 exit interface Loopback0 ip address 10.5.5.3 255.255.255.255 mpls ldp router-id Loopback0 force mpls label protocol ldp interface FastEthernet0/0 ip address 10.2.2.3 255.255.255.0 mpls ip interface FastEthernet1/0 ip vrf forwarding cust-one ip address 10.3.3.3 255.255.255.0 router bgp 65000 neighbor 10.5.5.2 remote-as 65000 neighbor 10.5.5.2 update-source Loopback0 address-family vpnv4 neighbor 10.5.5.2 activate neighbor 10.5.5.2 send-community both exit-address-family address-family ipv4 vrf cust-one redistribute connected exit-address-family ip route 10.5.5.2 255.255.255.255 10.2.2.2

Results Check that VPNv4 route redistribution is working: [admin@PE1] /routing/route> print detail where afi="vpn4" Flags: X - disabled, F - filtered, U - unreachable, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l dp-mapping, g - slaac, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp, B - blackhole Ab afi=vpn4 contribution=active dst-address=111.16.0.0/24&1.1.1.1:111 routing-table=main label=16 gateway=111.111.111.4 immediate-gw=111.13.0.2%ether9 distance=200 scope=40 target-scope=30 belongs-to="bgp-VPN4-111.111.111.4" bgp.peer-cache-id=*2C00011 .as-path="65511" .ext-communities=rt:1.1.1.1:111 .local-pref=100 .atomic-aggregate=yes .origin=igp debug.fwp-ptr=0x202427E0 [admin@PE1] /routing/bgp/advertisements> print 0 peer=to-pe2-1 dst=10.1.1.0/24 local-pref=100 origin=2 ext-communities=rt:1.1.1.1:111 atomic-aggregate=yes Check that the 10.3.3.0 is installed in IP routes, in the cust-one route table: [admin@PE1] > /ip route print where routing-table="cust-one" Flags: D - DYNAMIC; A - ACTIVE; c, b, y - BGP-MPLS-VPN Columns: DST-ADDRESS, GATEWAY, DISTANCE # DST-ADDRESS GATEWAY DISTANCE 0 ADC 10.1.1.0/24 ether1@cust-one 0 1 ADb 10.3.3.0/24 10.5.5.3 20 Let's take a closer look at IP routes in cust-one VRF. The 10.1.1.0/24 IP prefix is a connected route that belongs to an interface that was configured to belong to cust-one VRF. The 10.3.3.0/24 IP prefix was advertised via BGP as a VPNv4 route from PE2 and is imported in this VRF routing table, because our configured matched the BGP extended communities attribute it was advertised with. import-route-targets

[admin@PE1] /routing/route> print detail where routing-table="cust-one" Flags: X - disabled, F - filtered, U - unreachable, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l dp-mapping, g - slaac, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp, B - blackhole Ac afi=ip4 contribution=active dst-address=10.1.1.0/24 routing-table=cust-one gateway=ether1@cust-one immediate-gw=ether1 distance=0 scope=10 belongs-to="connected" local-address=10.1.1.2%ether1@cust-one debug.fwp-ptr=0x202420C0 Ay afi=ip4 contribution=active dst-address=10.3.3.0/24 routing-table=cust-one label=16 gateway=10.5.5.3 immediate-gw=10.2.2.3%ether2 distance=20 scope=40 target-scope=30 belongs-to="bgp-mpls-vpn-1-bgp-VPN4-10.5.5.3-import" bgp.peer-cache-id=*2C00011 .ext-communities=rt:1.1.1.1:111 .local-pref=100 .atomic-aggregate=yes .origin=igp debug.fwp-ptr=0x20242840 [admin@PE1] /routing/route> print detail where afi="vpn4" Flags: X - disabled, F - filtered, U - unreachable, A - active; c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l dp-mapping, g - slaac, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp, B - blackhole Ay afi=vpn4 contribution=active dst-address=10.1.1.0/24&1.1.1.1:111 routing-table=main label=19 gateway=ether1@cust-one immediate-gw=ether1 distance=200 scope=40 target-scope=10 belongs-to="bgp-mpls-vpn-1-connected-export" bgp.ext-communities=rt:1.1.1.1:1111 .atomic-aggregate=no .origin=incomplete debug.fwp-ptr=0x202426C0 Ab afi=vpn4 contribution=active dst-address=10.3.3.0/24&1.1.1.1:111 routing-table=main label=16 gateway=10.5.5.3 immediate-gw=10.2.2.3%ether2 distance=200 scope=40 target-scope=30 belongs-to="bgp-VPN4-10.5.5.3" bgp.peer-cache-id=*2C00011 .ext-communities=rt:1.1.1.1:111 .local-pref=100 .atomic-aggregate=yes .origin=igp debug.fwp-ptr=0x202427E0 The same for Cisco: PE2#show ip bgp vpnv4 all BGP table version is 5, local router ID is 10.5.5.3 Status codes: s suppressed, d damped, h history, * valid, > best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 1.1.1.1:111 (default for vrf cust-one) *>i10.1.1.0/24 10.5.5.2 100 0 ? *> 10.3.3.0/24 0.0.0.0 0 32768 ? PE2#show ip route vrf cust-one Routing Table: cust-one Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 E1 - OSPF external type 1, E2 - OSPF external type 2 i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 ia - IS-IS inter area, * - candidate default, U - per-user static route o - ODR, P - periodic downloaded static route Gateway of last resort is not set 10.0.0.0/24 is subnetted, 1 subnets B 10.1.1.0 [200/0] via 10.5.5.2, 00:05:33 10.0.0.0/24 is subnetted, 1 subnets C 10.3.3.0 is directly connected, FastEthernet1/0

You should be able to ping from CE1 to CE2 and vice versa. [admin@CE1] > /ping 10.3.3.4 10.3.3.4 64 byte ping: ttl=62 time=18 ms 10.3.3.4 64 byte ping: ttl=62 time=13 ms 10.3.3.4 64 byte ping: ttl=62 time=13 ms 10.3.3.4 64 byte ping: ttl=62 time=14 ms 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 13/14.5/18 ms A more complicated setup (changes only) As opposed to the simplest setup, in this example, we have two customers: cust-one and cust-two. We configure two VPNs for them, cust-one and cust-two respectively, and exchange all routes between them. (This is also called "route leaking"). Note that this could be not the most typical setup, because routes are usually not exchanged between different customers. In contrast, by default, it should not be possible to gain access from one VRF site to a different VRF site in another VPN. (This is the "Private" aspect of VPNs.) Separate routing is a way to provide privacy, and it is also required to solve the problem of overlapping IP network prefixes. Route exchange is in direct conflict with these two requirements but may sometimes be needed (e.g. temp. solution when two customers are migrating to a single network infrastructure). CE1 Router, cust-one /ip route add dst-address=10.4.4.0/24 gateway=10.1.1.2 CE2 Router, cust-one /ip route add dst-address=10.4.4.0/24 gateway=10.3.3.3 CE1 Router, cust-two

/ip address add address=10.4.4.5 interface=ether1 /ip route add dst-address=10.1.1.0/24 gateway=10.3.3.3 /ip route add dst-address=10.3.3.0/24 gateway=10.3.3.3 PE1 Router # replace the old BGP VPN with this: /routing bgp vpn add vrf=cust-one \ export.redistribute=connected \ route-distinguisher=1.1.1.1:111 \ import.route-targets=1.1.1.1:111,2.2.2.2:222 \ export.route-targets=1.1.1.1:111 PE2 Router (Cisco) ip vrf cust-one rd 1.1.1.1:111 route-target export 1.1.1.1:111 route-target import 1.1.1.1:111 route-target import 2.2.2.2:222 exit ip vrf cust-two rd 2.2.2.2:222 route-target export 2.2.2.2:222 route-target import 1.1.1.1:111 route-target import 2.2.2.2:222 exit interface FastEthernet2/0 ip vrf forwarding cust-two ip address 10.4.4.3 255.255.255.0 router bgp 65000 address-family ipv4 vrf cust-two redistribute connected exit-address-family Variation: replace the Cisco with another MT PE2 Mikrotik config

/interface bridge add name=lobridge /ip address add address=10.2.2.3/24 interface=ether1 add address=10.3.3.3/24 interface=ether2 add address=10.4.4.3/24 interface=ether3 add address=10.5.5.3/32 interface=lobridge /ip vrf add name=cust-one interfaces=ether2 add name=cust-two interfaces=ether3 /mpls ldp add enabled=yes transport-address=10.5.5.3 /mpls ldp interface add interface=ether1 /routing bgp template set default as=65000 /routing bgp vpn add vrf=cust-one \ export.redistribute=connected \ route-distinguisher=1.1.1.1:111 \ import.route-targets=1.1.1.1:111,2.2.2.2:222 \ export.route-targets=1.1.1.1:111 \ add vrf=cust-two \ export.redistribute=connected \ route-distinguisher=2.2.2.2:222 \ import.route-targets=1.1.1.1:111,2.2.2.2:222 \ export.route-targets=2.2.2.2:222 \ /routing bgp connection add template=default remote.address=10.5.5.2 address-families=vpnv4 local.address=10.5.5.3 # add route to the remote BGP peer's loopback address /ip route add dst-address=10.5.5.2/32 gateway=10.2.2.2 Results The output of now is interesting enough to deserve detailed observation. /ip route print [admin@PE2] /ip route> print Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit # DST-ADDRESS PREF-SRC GATEWAY DISTANCE 0 ADb 10.1.1.0/24 10.5.5.2 recurs... 20 1 ADC 10.3.3.0/24 10.3.3.3 ether2 0 2 ADb 10.4.4.0/24 20 3 ADb 10.1.1.0/24 10.5.5.2 recurs... 20 4 ADb 10.3.3.0/24 20 5 ADC 10.4.4.0/24 10.4.4.3 ether3 0 6 ADC 10.2.2.0/24 10.2.2.3 ether1 0 7 A S 10.5.5.2/32 10.2.2.2 reacha... 1 8 ADC 10.5.5.3/32 10.5.5.3 lobridge 0 The route 10.1.1.0/24 was received from a remote BGP peer and is installed in both VRF routing tables. The routes 10.3.3.0/24 and 10.4.4.0/24 are also installed in both VRF routing tables. Each is a connected route in one table and a BGP route in another table. This has nothing to do with their being advertised via BGP. They are simply being "advertised" to the local VPNv4 route table and locally reimported after that. Import and export determine in which tables they will end up. route-targets This can be deduced from its attributes - they don't have the usual BGP properties. (Route 10.4.4.0/24.)

[admin@PE2] /routing/route> print detail where routing-table=cust-one ... References RFC 4364: BGP/MPLS IP Virtual Private Networks (VPNs) MPLS Fundamentals, chapter 7, , Cisco Press 2006 Luc De Ghein

OSPF Overview OSPF Terminology Basic Configuration Example Routing Table Calculation SPT Calculation Forwarding Address Neighbour Relationship and Adjacency Communication Between OSPF Routers Neighbors Discovery Discovery on Broadcast Subnets Discovery on NBMA Subnets Discovery on PTMP Subnets Master-Slave Relation Database Synchronization Synchronization on Broadcast Subnets DR Election Synchronization on NBMA Subnets Synchronization on PTMP Subnets Understanding OSPF Areas LSA Types Standard Area Stub Area Totally Stubby Area NSSA External Routing Information and Default Route Route Summarisation Virtual Link Partitioned Backbone No physical connection to a backbone Property Reference Instance Notes Area Area Range Interface Interface Templates Matchers Assigned Parameters Lsa Neighbors Static Neighbour configuration Overview OSPF is Interior Gateway Protocol (IGP) designed to distribute routing information between routers belonging to the same Autonomous System (AS). The protocol is based on link-state technology that has several advantages over distance-vector protocols such as RIP: no hop count limitations; multicast addressing is used to send routing information updates; updates are sent only when network topology changes occur; the logical definition of networks where routers are divided into areas transfers and tags external routes injected into AS. However, there are a few disadvantages: OSPF is quite CPU and memory intensive due to the SPF algorithm and maintenance of multiple copies of routing information; more complex protocol to implement compared to RIP; RouterOS implements the following standards:

RFC - OSPF Version 2 2328 RFC - The OSPF Not-So-Stubby Area (NSSA) Option 3101 RFC - Traffic Engineering (TE) Extensions to OSPF Version 2 3630 RFC - OSPF as the Provider/Customer Edge Protocol for BGP/MPLS IP Virtual Private Networks (VPNs) 4577 RFC - Traffic Engineering Extensions to OSPF Version 3 5329 RFC - OSPF for IPv6 5340 RFC - Management Information Base for OSPFv3 5643 RFC - OSPFv2 Multi-Instance Extensions 6549 RFC - OSPFv3 as a Provider Edge to Customer Edge (PE-CE) Routing Protocol 6565 RFC - OSPF Hybrid Broadcast and Point-to-Multipoint Interface Type 6845 RFC - OSPF Traffic Engineering (TE) Metric Extensions 7471 OSPF Terminology Before we move on let's familiarise ourselves with terms important for understanding the operation of the OSPF. These terms will be used throughout the article. Neighbor - connected (adjacent) router that is running OSPF with the adjacent interface assigned to the same area. Neighbors are found by Hello packets (unless manually configured). Adjacency - logical connection between a router and its corresponding DR and BDR. No routing information is exchanged unless adjacencies are formed. Link - link refers to a network or router interface assigned to any given network. Interface - physical interface on the router. The interface is considered a link when it is added to OSPF. Used to build link database. LSA - Link State Advertisement, data packet contains link-state and routing information, that is shared among OSPF Neighbors. DR - Designated Router, chosen router to minimize the number of adjacencies formed. The option is used in broadcast networks. BDR -Backup Designated Router, hot standby for the DR. BDR receives all routing updates from adjacent routers, but it does not flood LSA updates. Area - areas are used to establish a hierarchical network. ABR - Area Border Router, router connected to multiple areas. are responsible for and between ABRs summarization update suppression connected areas. ASBR - Autonomous System Boundary Router, router connected to an external network (in a different AS). If you import other protocol routes into OSPF from the router it is now considered ASBR. NBMA - Non-broadcast multi-access, networks allow multi-access but have no broadcast capability. Additional OSPF neighbor configuration is required for those networks. Broadcast - Network that allows broadcasting, for example, Ethernet. Point-to-point - Network type eliminates the need for DRs and BDRs Router-ID - IP address used to identify the OSPF router. If the OSPF Router-ID is not configured manually, a router uses one of the IP addresses assigned to the router as its Router-ID. Link State - The term link-state refers to the status of a link between two routers. It defines the relationship between a router's interface and its neighboring routers. Cost - Link-state protocols assign a value to each link called cost. the cost value depends on the speed of the media. A cost is associated with the outside of each router interface. This is referred to as interface output cost. Autonomous System - An autonomous system is a group of routers that use a common routing protocol to exchange routing information. Basic Configuration Example To start OSPF v2 and v3 instances, the first thing to do is to add the instance and the backbone area: /routing ospf instance add name=v2inst version=2 router-id=1.2.3.4 add name=v3inst version=3 router-id=1.2.3.4 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=backbone_v3 area-id=0.0.0.0 instance=v3inst At this point, we can add a template. The template is used to match interfaces on which OSPF should be running, it can be done either by specifying the network or interface directly.

/routing ospf interface-template add networks=192.168.0.0/24 area=backbone_v2 add networks=2001:db8::/64 area=backbone_v3 add interfaces=ether1 area=backbone_v3 Routing Table Calculation Link state database describes the routers and links that interconnect them and are appropriate for forwarding. It also contains the cost (metric) of each link. This metric is used to calculate the shortest path to the destination network. Each router can advertise a different cost for the router's own link direction, making it possible to have asymmetric links (packets to the destination travel over one path, but the response travels a different path). Asymmetric paths are not very popular, because it makes it harder to find routing problems. The value of the cost can be changed in the , for example, to add an ether2 interface with a cost of 100: OSPF interface template configuration menu /routing ospf interface-template add interfaces=ether2 cost=100 area=backbone_v2 The cost of an interface on Cisco routers is inversely proportional to the bandwidth of that interface. A higher bandwidth indicates a lower cost. If similar costs are necessary on RouterOS, then use the following formula: Cost = 100000000/bw in bps. OSPF router is using Dijkstra's Shortest Path First (SPF) algorithm to calculate the shortest path. The algorithm places the router at the root of a tree and calculates the shortest path to each destination based on the cumulative cost required to reach the destination. Each router calculates its own tree even though all routers are using the same link-state database. SPT Calculation Assume we have the following network. The network consists of 4(four) routers. OSPF costs for outgoing interfaces are shown near the line that represents the link. In order to build the shortest-path tree for router R1, we need to make R1 the root and calculate the smallest cost for each destination.

As you can see from the image above multiple shortest paths have been found to the 172.16.1.0 network, allowing load balancing of the traffic to that destination called . After the shortest-path tree is built, a router starts to build the routing table accordingly. Networks are equal-cost multipath (ECMP) reached consequently to the cost calculated in the tree. Routing table calculation looks quite simple, however, when some of the OSPF extensions are used or OSPF areas are calculated, routing calculation gets more complicated. Forwarding Address OSPF router can set the to something other than itself which indicates that an alternate next-hop is possible. Mostly forwarding forwarding-address address is set to suggesting that the route is reachable only via the advertising router. 0.0.0.0 The forwarding address is set in LSA if the following conditions are met: OSPF must be enabled on the next-hop interface Next-hop address falls into the network provided by OSPF networks A router that receives such LSA can use a forwarding address if OSPF is able to resolve the forwarding address. If forwarding address is not resolved directly - router sets nexthop for forwading address from LSA as a gateway, if forwarding address is not resolved at all - the gateway will be originator-id. Resolve happens only using OSPF instance routes, not the whole routing table. Let's look at the example setup below:

Router has a static route to the external network . OSPF is running between R1, R2, and R3, and the static route is distributed across R1 192.168.0.0/24 the OSPF network. The problem in such a setup is obvious, R2 can not reach the external network directly. Traffic going to the LAN network from will be forwarded over R2 the router , but if we look at the network diagram we can see that more R2 can directly reach the router where the LAN network i located.R1 So knowing the forwarding address conditions, we can make router to set the forwarding address. We simply need to add 10.1.101.0/24 network to R1 OSPF networks in the router's configuration:R1 /routing/ospf/interface-template add area=backbone_v2 networks=10.1.101.0/24 Now lets verify that forwarding address is actually working: [admin@r2] /ip/route> print where dst-address=192.168.0.0/24 Flags: D - DYNAMIC; A - ACTIVE; o, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAo 192.168.0.0/24 10.1.101.1%ether1 110 On all OSPF routers you will see LSA set with forwarding address other than 0.0.0.0 [admin@r2] /routing/ospf/lsa> print where id=192.168.0.0 Flags: S - self-originated, F - flushing, W - wraparound; D - dynamic 1 D instance=default_ip4 type="external" originator=10.1.101.10 id=192.168.0.0 sequence=0x80000001 age=19 checksum=0xF336 body= options=E netmask=255.255.255.0 forwarding-address=10.1.101.1 metric=10 type-1 route-tag=0 OSPF adjacency between routers in the 10.1.101.0/24 network is not required

Neighbour Relationship and Adjacency OSPF is a link-state protocol that assumes that the interface of the router is considered an OSPF link. Whenever OSPF is started, it adds the state of all the links in the local . link-state database There are several steps before the OSPF network becomes fully functional: Neighbors discovery Database Synchronization Routing calculation Link-state routing protocols are distributing and replicating database that describes the routing topology. The link-state protocol's flooding algorithm ensures that each router has an identical link-state database and the routing table is calculated based on this database. After all the steps above are completed link-state database on each neighbor contains full routing domain topology (how many other routers are in the network, how many interfaces routers have, what networks link between router connects, cost of each link, and so on). Communication Between OSPF Routers OSPF operates over the IP network layer using protocol number 89. A destination IP address is set to the neighbor's IP address or to one of the OSPF multicast addresses AllSPFRouters (224.0.0.5) or AllDRRouters (224.0.0.6). The use of these addresses is described later in this article. Every OSPF packet begins with a standard 24-byte header. Field Description Packet typeThere are several types of OSPF packets: Hello packet, Database Description (DD) packet, Link state request packet, Link State Update packet, and Link State Acknowledgement packet. All of these packets except the Hello packet are used in link-state database synchronization. Router IDone of the router's IP addresses unless configured manually Area ID Allows OSPF router to associate the packet to the proper OSPF area. Checksum Allows receiving router to determine if a packet was damaged in transit. Authenti cation fieldsThese fields allow the receiving router to verify that the packet's contents were not modified and that packet really came from the OSPF router whose Router ID appears in the packet. There are five different OSPF packet types used to ensure proper LSA flooding over the OSPF network. Hello packet - used to discover OSPF neighbors and build adjacencies. Database Description (DD) - check for Database synchronization between routers. Exchanged after adjacencies are built. Link-State Request (LSR) - used to request up-to-date pieces of the neighbor's database. Out-of-date parts of the routing database are determined after the DD exchange.

Link-State Update (LSU) - carries a collection of specifically requested link-state records. Link-State Acknowledgment (LSack) - is used to acknowledge other packet types that way introducing reliable communication. Neighbors Discovery OSPF discovers potential neighbors by periodically sending Hello packets out of configured interfaces. By default are sent out at 10-second Hello packets intervals which can be changed by setting in OSPF interface settings. The router learns the existence of a neighboring router when it receives hello-interval the neighbor's Hello in return with matching parameters. The transmission and reception of Hello packets also allow a router to detect the failure of the neighbor. If Hello packets are not received within dead- (which by default is 40 seconds) router starts to route packets around the failure. "Hello" protocol ensures that the neighboring routers agree on the interval Hello interval and Dead interval parameters, preventing situations when not in time received Hello packets mistakenly bring the link down. Field Description network mask The IP mask of the originating router's interface IP address. hello interval the period between Hello packets (default 10s) options OSPF options for neighbor information router priority an 8-bit value used to aid in the election of the DR and BDR. (Not set in p2p links) router dead interval time interval has to be received before considering the neighbor is down. ( By default four times bigger than the Hello interval) DR the router-id of the current DR BDR the router-id of the current BDR Neighbor router IDs a list of router ids for all the originating router's neighbors On each type of network segment Hello protocol works a little differently. It is clear that on point-to-point segments only one neighbor is possible and no additional actions are required. However, if more than one neighbor can be on the segment additional actions are taken to make OSPF functionality even more efficient. Two routers do not become neighbors unless the following conditions are met. Two-way communication between routers is possible. Determined by flooding Hello packets. The interface should belong to the same area; The interface should belong to the same subnet and have the same network mask unless it has network-type configured as ; point-to-point Routers should have the same authentication options, and have to exchange the same password (if any); Hello and Dead intervals should be the same in Hello packets; External routing and NSSA flags should be the same in Hello packets. Discovery on Broadcast Subnets Network mask, Priority, DR, and BDR fields are used only when the neighbors are connected by a broadcast or NBMA network segment.

The attached node to the broadcast subnet can send a single packet and that packet is received by all other attached nodes. This is very useful for auto- configuration and information replication. Another useful capability in broadcast subnets is multicast. This capability allows sending a single packet which will be received by nodes configured to receive multicast packets. OSPF is using this capability to find OSPF neighbors and detect bidirectional connectivity. Each OSPF router joins the IP multicast group (224.0.0.5), then the router periodically multicasts its Hello packets to the IP address AllSPFRouters 224.0.0.5. All other routers that joined the same group will receive a multicasted Hello packet. In that way, OSPF routers maintain relationships with all other OSPF routers by sending a single packet instead of sending a separate packet to each neighbor on the segment. This approach has several advantages: Automatic neighbor discovery by multicasting or broadcasting Hello packets. Less bandwidth usage compared to other subnet types. On the broadcast segment, there are n*(n-1)/2 neighbor relations, but those relations are maintained by sending only n Hellos. If the broadcast has the multicast capability, then OSPF operates without disturbing non-OSPF nodes on the broadcast segment. If the multicast capability is not supported all routers will receive broadcasted Hello packets even if the node is not an OSPF router. Discovery on NBMA Subnets Non-broadcast multiaccess (NBMA) segments are similar to broadcast. Support more than two routers, the only difference is that NBMA does not support a data-link broadcast capability. Due to this limitation, OSPF neighbors must be discovered initially through configuration. On RouterOS static neighbor configuration is set in the menu. To reduce the amount of Hello traffic, most routers attached to the NBMA subnet /routing ospf static-neighbor should be assigned a Router Priority of 0 (set by default in RouterOS). Routers that are eligible to become Designated Routers should have priority values other than 0. It ensures that during the election of DR and BDR Hellos are sent only to eligible routers. Discovery on PTMP Subnets Point-to-MultiPoint treats the network as a collection of point-to-point links. By design, PTMP networks should not have broadcast capabilities, which means that OSPF neighbors (the same way as for NBMA networks) must be discovered initially through configuration and all communication happens by sending unicast packets directly between neighbors. On RouterOS static neighbor configuration is set in the menu. Designated Routers and Backup Designated Routers are not elected on /routing ospf static-neighbor Point-to-multipoint subnets. For PTMP networks that do support broadcast, a hybrid type named " " can be used. This network type uses multicast Hellos to discover ptmp-broadcast neighbors automatically and detect bidirectional communication between neighbors. After neighbor detection " " sends unicast packets ptmp-broacast directly to the discovered neighbors. This mode is compatible with the RouterOS v6 " " type. ptmp Master-Slave Relation Before database synchronization can begin, a hierarchy order of exchanging information must be established, which determines which router sends Databa ( ) packets first ( ). The master router is elected based on the and if priority is not set then the will be used. se Descriptor DD Master highest priority router ID Note that it is a router priority-based relation to arranging the exchanging data between neighbors which does not affect DR/BDR election (meaning that DR does not always have to be ). Master Database Synchronization Link-state Database synchronization between OSPF routers is very important. Unsynchronized databases may lead to incorrectly calculated routing tables which could cause routing loops or black holes. There are two types of database synchronizations: initial database synchronization reliable flooding. When the connection between two neighbors first comes up, will happen. OSPF is using explicit database download when initial database synchronization neighbor connections first come up. This procedure is called . Instead of sending the entire database, the OSPF router sends only its Database exchange LSA headers in a sequence of OSPF packets. The router will send the next DD packet only when the previous packet is Database Description (DD) acknowledged. When an entire sequence of DD packets has been received, the router knows which LSAs it does not have and which LSAs are more recent. The router then sends packets requesting desired LSAs, and the neighbor responds by flooding LSAs in Link-State Request (LSR) Link-State packets. After all the updates are received neighbors are said to be . Update (LSU) fully adjacent

Reliable flooding is another database synchronization method. It is used when adjacencies are already established and the OSPF router wants to inform other routers about LSA changes. When the OSPF router receives such Link State Update, it installs a new LSA in the link-state database, sends an acknowledgment packet back to the sender, repackages LSA in new LSU, and sends it out to all interfaces except the one that received the LSA in the first place. OSPF determines if LSAs are up to date by comparing sequence numbers. Sequence numbers start with 0×80000001, the larger the number, the more recent the LSA is. A sequence number is incremented each time the record is flooded and the neighbor receiving the update resets the Maximum age timer. LSAs are refreshed every 30 minutes, but without a refresh, LSA remains in the database for the maximum age of 60 minutes. Databases are not always synchronized between all OSPF neighbors, OSPF decides whether databases need to be synchronized depending on the network segment, for example, on point-to-point links databases are always synchronized between routers, but on Ethernet networks databases are synchronized between certain neighbor pairs. Synchronization on Broadcast Subnets On the broadcast segment, there are n*(n-1)/2 neighbor relations, it will be a huge amount of Link State Updates and Acknowledgements sent over the subnet if the OSPF router will try to synchronize with each OSPF router on the subnet. This problem is solved by electing one and one for each broadcast subnet. All other routers are Designated Router Backup Designated Router synchronizing and forming adjacencies only with those two elected routers. This approach reduces the number of adjacencies from n*(n-1)/2 to only 2n-3. The image on the right illustrates adjacency formations on broadcast subnets. Routers R1 and R2 are Designated Routers and Backup Designated routers respectively. For example, if R3 wants to flood Link State Update (LSU) to both R1 and R2, a router sends LSU to the IP multicast address AllDRouters (224.0.0.6) and only DR and BDR listen to this multicast address. Then Designated Router sends LSU addressed to AllSPFRouters, updating the rest of the routers. DR Election

DR and BDR routers are elected from data received in the Hello packet. The first OSPF router on a subnet is always elected as Designated Router, when a second router is added it becomes Backup Designated Router. When an existing DR or BDR fails new DR or BDR is elected to take into account configured . The router with the highest priority becomes the new DR or BDR. router priority Being Designated Router or Backup Designated Router consumes additional resources. If Router Priority is set to 0, then the router is not participating in the election process. This is very useful if certain slower routers are not capable of being DR or BDR. Synchronization on NBMA Subnets Database synchronization on NBMA networks is similar to that on broadcast networks. DR and BDR are elected, databases initially are exchanged only with DR and BDR routers and flooding always goes through the DR. The only difference is that Link State Updates must be replicated and sent to each adjacent router separately. Synchronization on PTMP Subnets On PTMP subnets OSPF router becomes adjacent to all other routes with which it can communicate directly. Understanding OSPF Areas A distinctive feature of OSPF is the possibility to divide AS into multiple routing Areas which contain their own set of neighbors. Imagine a large network with 300+ routers and multiple links between them. Whenever link flaps or some other topology change happens in the network, this change will be flooded to all OSPF devices in the network resulting in a quite heavy load on the network and even downtime since network convergence may take some time for such a large network. A large single-area network can produce serious issues: Each router recalculates the database every time whenever network topology change occurs, the process takes CPU resources. Each router holds an entire link-state database, which shows the topology of the entire network, it takes memory resources. A complete copy of the routing table and a number of routing table entries may be significantly greater than the number of networks, which can take even more memory resources. Updating large databases requires more bandwidth. The introduction of areas allows for better resource management since topology change inside one area is not flooded to other areas in the network. The concept of areas enables simplicity in network administration as well as routing summarization between areas significantly reducing the database size that needs to be stored on each OSPF neighbor. This means that each area has its own link-state database and corresponding shortest-path tree. The structure of an area is invisible to other areas. This isolation of knowledge makes the protocol more scalable if multiple areas are used; routing table calculation takes fewer CPU resources and routing traffic is reduced. However, multi-area setups create additional complexity. It is not recommended to separate areas with fewer than 50 routers. The maximum number of routers in one area is mostly dependent on the CPU power you have for routing table calculation.

OSPF area has unique 32-bit identification (Area ID) and the area with an Area ID of 0.0.0.0 (called the Backbone area) is the main one where any other area should connect. Routers that connect to more than one area are called (Area Border Routers), and their main responsibility is summarization ABR and update suppression between connected areas. The router connecting to another routing domain is called (Autonomous System Boundary ASBR Router). Each area has its own link-state database, consisting of router-LSAs and network-LSAs describing how all routers within that area are interconnected. Detailed knowledge of the area's topology is hidden from all other areas; router-LSAs and network-LSAs are not flooded beyond the area's borders. Area Border Routers ( s) leak addressing information from one area into another in OSPF summary-LSAs. This allows one to pick the best area border ABR router when forwarding data to destinations from another area and is called . intra-area routing Routing information exchange between areas is essentially a Distance Vector algorithm and to prevent algorithm convergence problems, such as counting to infinity, all areas are required to attach directly to the making a simple hub-and-spoke topology. The area-ID of the backbone area is backbone area always 0.0.0.0 and can not be changed. RouterOS area configuration is done in the menu. For example, a configuration of an ABR router with multiple attached areas, /routing/ospf/area one Stub area, and one default area: /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=stub_area area-id=1.1.1.1 instance=v2inst type=stub add name=another_area area-id=2.2.2.2 instance=v2inst type=default OSPF can have 5 types of areas. Each area type defines what type of LSAs the area supports: standard/default - OSPF packets can normally be transmitted in this area, it supports types 1,2,3,4 and 5 LSAs backbone - as already mentioned this is the main area where any other area connects. It is basically the same as the standard area but identified with ID 0.0.0.0 stub - this area does not accept any external routes totally stubby - a variation of the stub area not-so-stubby (NSSA) - a variation of the stub area LSA Types Before we continue a detailed look at each area type, let's get familiar with LSA types: type 1 - (Router LSA) Sent by routers within the Area, including the list of directly attached links. Do not cross the ABR or ASBR. type 2 - (Network LSA) Generated for every "transit network" within an area. A transit network has at least two directly attached OSPF routers. Ethernet is an example of a Transit Network. A Type 2 LSA lists each of the attached routers that make up the transit network and is generated by the DR. type 3 - (Summary LSA) The ABR sends Type 3 Summary LSAs. A Type 3 LSA advertises any networks owned by an area to the rest of the areas in the OSPF AS. By default, OSPF advertises Type 3 LSAs for every subnet defined in the originating area, which can cause flooding problems, so it´s a good idea to use a manual summarization at the ABR. type 4 - (ASBR-Summary LSA) It announces the ASBR address, it shows “where” the ASBR is located, announcing its address instead of its routing table. type 5 - (External LSA) Announces the Routes learned through the ASBR, are flooded to all areas except Stub areas. This LSA divides into two sub-types: and . external type 1 external type 2 type 6 - (Group Membership LSA) This was defined for Multicast extensions to OSPF and is not used by RouterOS. type 7 - type 7 LSAs are used to tell the ABRs about these external routes imported into the NSSA area. Area Border Router then translates these LSAs to external LSAs and floods as normal to the rest of the OSPF network type 5 type 8 - External Attributes LSA (OSPFv2) / link-local LSA (OSPFv3) type 9 - Link-Local Scope Opaque (OSPFv2) / Intra Area Prefix LSA (OSPFv3). LSA of this type is not flooded beyond the local (sub)network. type 10 - Area Local Scope Opaque. LSA of this type is not flooded beyond the scope of its associated area. type 11 - Opaque LSA which is flooded throughout the AS (scope is the same as ). It is not flooded in stub areas and NSSAs. type 5 Standard Area If we do not have any ASBR, there are no LSA Types 4 and 5 in the network.

This area supports 1, 2, 3, 4, and 5 LSAs. Simple multi-area network using default area. In this example, all networks from area1 are flooded to the backbone and all networks from the backbone are flooded to area1. R1: /ip address add address=10.0.3.1/24 interface=ether1 /ip address add address=10.0.2.1/24 interface=ether2 /routing ospf instance add name=v2inst version=2 router-id=1.0.0.1 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=area1 area-id=1.1.1.1 type=default instance=v2inst /routing ospf interface-template add networks=10.0.2.0/24 area=backbone_v2 add networks=10.0.3.0/24 area=area1 R2: /ip address add address=10.0.1.1/24 interface=ether2 /ip address add address=10.0.2.2/24 interface=ether1 /routing ospf instance add name=v2inst version=2 router-id=1.0.0.2 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 /routing ospf interface-template add networks=10.0.2.0/24 area=backbone_v2 add networks=10.0.1.0/24 area=backbone_v2 R3:

/ip address add address=10.0.3.2/24 interface=ether2 /ip address add address=10.0.4.1/24 interface=ether1 /routing ospf instance add name=v2inst version=2 router-id=1.0.0.3 /routing ospf area add name=area1 area-id=1.1.1.1 type=stub instance=v2inst /routing ospf interface-template add networks=10.0.3.0/24 area=area1 add networks=10.0.4.0/24 area=area1 Stub Area The main purpose of stub areas is to keep such areas from carrying external routes. Routing from these areas to the outside world is based on a default route. A stub area reduces the database size inside an area and reduces the memory requirements of routers in the area. The stub area has a few restrictions, ASBR routers cannot be internal to the area, stub area cannot be used as a transit area for virtual links. The restrictions are made because the stub area is mainly configured not to carry external routes. This area supports 1, 2, and 3 LSAs. Let's consider the example above. Area1 is configured as a stub area meaning that routers R2 and R3 will not receive any routing information from the backbone area except the default route. R1:

/routing ospf instance add name=v2inst version=2 router-id=1.0.0.1 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=area1 area-id=1.1.1.1 type=stub instance=v2inst /routing ospf interface-template add networks=10.0.0.0/24 area=backbone_v2 add networks=10.0.1.0/24 area=area1 add networks=10.0.3.0/24 area=area1 R2: /routing ospf instance add name=v2inst version=2 router-id=1.0.0.2 /routing ospf area add name=area1 area-id=1.1.1.1 type=stub instance=v2inst /routing ospf interface-template add networks=10.0.1.0/24 area=area1 R3: /routing ospf instance add name=v2inst version=2 router-id=1.0.0.3 /routing ospf area add name=area1 area-id=1.1.1.1 type=stub instance=v2inst /routing ospf interface-template add networks=10.0.3.0/24 area=area1 Totally Stubby Area Totally stubby area is an extension of the stub area. A totally stubby area blocks external routes and summarized (inter-area) routes from going into the area. Only intra-area routes are injected into the area. Totally stubby area is configured as a stub area with an additional flag. This area no-summaries supports Type 1, Type 2 LSAs, and Type 3 LSAs with default routes. /routing ospf area add name=totally_stubby_area area-id=1.1.1.1 instance=v2inst type=stub no-summaries NSSA Not-so-stubby area (NSSA) is useful when it is required to inject external routes, but injection of type 5 LSA routes is not required.

The illustration shows two areas (backbone and area1) and RIP connection to the router located in "area1". We need "area1" to be configured as a stub area, but it is also required to inject external RIP routes in the backbone. Area1 should be configured as NSSA in this case. The configuration example does not cover configuration.RIP R1: /routing ospf instance add name=v2inst version=2 router-id=1.0.0.1 /routing ospf area add name=backbone_v2 area-id=0.0.0.0 instance=v2inst add name=area1 area-id=1.1.1.1 type=nssa instance=v2inst /routing ospf interface-template add networks=10.0.0.0/24 area=backbone_v2 add networks=10.0.1.0/24 area=area1 R2: /routing ospf instance add name=v2inst version=2 router-id=1.0.0.2 /routing ospf area add name=area1 area-id=1.1.1.1 type=nssa instance=v2inst /routing ospf interface-template add networks=10.0.1.0/24 area=area1 External Routing Information and Default Route On the edge of an OSPF routing domain, you can find routers called that run one of the other routing protocols. The job of AS boundary routers (ASBRs) those routers is to import routing information learned from other routing protocols into the OSPF routing domain. External routes can be imported at two separate levels depending on the metric type. Virtual links cannot be used over NSSA areas.

type1 - OSPF metric is the sum of the internal OSPF cost and the external route cost type2 - OSPF metric is equal only to the external route cost. External routes can be imported via the instance parameter. The example below will pick and redistribute all static and RIP routes: redistribute /routing ospf instance add name=v2inst version=2 router-id=1.2.3.4 redistribute=static,rip Redistribution of default route is a special case where the the parameter should be used: originate-default /routing ospf instance set v2inst originate-default=if-installed Since redistribution is controlled by " " and " " parameter, it introduces some corner-cases for default route filtering. originate-default redistribute if is enabled, then pick all routes matching redistribute parameters redistribute If , a default route will be rejected = originate-default never run selected routes through (if configured) out-select-chain run selected routes through (if configured) out-filter-chain if is set to or : originate-default always if-installed OSPF creates a fake default route without attributes; runs this route through where attributes can be applied, but action is ignored (always accept); out-filter-chain For a complete list of redistribution values, see the reference manual. Route Summarisation Route summarization is a consolidation of multiple routes into one single advertisement. It is normally done at the area boundaries (Area Border Routers). It is better to summarise in the direction of the backbone. That way the backbone receives all the aggregated routes and injects them into other areas already summarized. There are two types of summarization: inter-area and external route summarization. Inter-area route summarization works on area boundaries (ABRs), it does not apply to external routes injected into OSPF via redistribution. By default, ABR creates a summary LSA for each route in a specific area and advertises it in adjacent areas. Using ranges allows for creating only one summary LSA for multiple routes and sending only a single advertisement into adjacent areas, or suppressing advertisements altogether. If a range is configured with the ' ' parameter, a single summary LSA is advertised for each range if there are any routes under the range in the advertise specific area. Otherwise (when ' ' parameter disabled) no summary LSAs are created and advertised outside area boundaries at all. advertise Inter-area route summarization can be configured from the menu. OSPF area range Let's consider that we have two areas backbone and area1, area1 has several /24 routes from the 10.0.0.0/16 range and there is no need to flood the backbone area with each /24 subnet if it can be summarized. On the router connecting area1 with the backbone we can set up the area range: /routing ospf area range add prefix=10.0.0.0/16 area=area1 advertise=yes cost=10 External route summarization can be achieved using routing filters. Let's consider the same example as above except that area1 has redistributed /24 routes from other protocols. To send a single summarised LSA, a blackhole route must be added and an appropriate routing filter to accept only summarised route: For an active range (i.e. one that has at least one OSPF route from the specified area falling under it), a route with the type 'blackhole' is created and installed in the routing table.

/ip route add dst-address=10.0.0.0/16 blackhole /routing ospf instance set v2inst out-filter-chain=ospf_out /routing filter rule add chain=ospf_out rule="if (dst == 10.0.0.0/16) {accept} else {reject}" Virtual Link As it was mentioned previously all OSPF areas have to be attached to the backbone area, but sometimes the physical connection is not possible. To overcome this, areas can be attached logically by using virtual links . There are two common scenarios when virtual links can be used: to glue together the fragmented backbone area to connect remote are without direct connection to the backbone Partitioned Backbone OSPF allows to linking of discontinuous parts of the backbone area using virtual links. This might be required when two separate OSPF networks are merged into one large network. Virtual links can be configured between separate ABRs that touch the backbone area from each side and have a common area. The additional area could be created to become a transit area when a common area does not exist, it is illustrated in the image above. Virtual Links are not required for non-backbone areas when they get partitioned. OSPF does not actively attempt to repair area partitions, each component simply becomes a separate area, when an area becomes partitioned. The backbone performs routing between the new areas. Some destinations are reachable via routing, the area partition requires routing. intra-area inter-area However, to maintain full routing after the partition, an address range has not to be split across multiple components of the area partition.

No physical connection to a backbone The area may not have a physical connection to the backbone, a virtual link is used to provide a logical path to the backbone of the disconnected area. A link has to be established between two ABRs that have a common area with one ABR connected to the backbone. We can see that both R1 and R2 routers are ABRs and R1 is connected to the backbone area. Area2 will be used as a and R1 is the transit area entry point into the backbone area. A virtual link has to be configured on both routers. Virtual link configuration is added in OSPF interface templates. If we take the example setup from the "no physical connection" illustration, then the virtual link configuration would look like this: R1: /routing ospf interface-template add vlink-transit-area=area2 area=backbone_v2 type=virtual-link vlink-neighbor-id=2.2.2.2 R2: /routing ospf interface-template add vlink-transit-area=area2 area=backbone_v2 type=virtual-link vlink-neighbor-id=1.1.1.1 Property Reference Instance Sub-menu: /routing/ospf/instance Property Description domain-id (Hex | ) AddressMPLS-related parameter. Identifies the OSPF domain of the instance. This value is attached to OSPF routes redistributed in BGP as VPNv4 routes as BGP extended community attribute and used when BGP VPNv4 routes are redistributed back to OSPF to determine whether to generate inter-area or AS-external LSA for that route. By default Null domain-id is used, as described in RFC 4577. domain-tag (integer ) [0..4294967295]if set, then used in route redistribution (as route-tag in all external LSAs generated by this router), and in route calculation (all external LSAs having this route tag are ignored). Needed for interoperability with older Cisco systems. By default not set. in-filter ( ) string name of the chain used for incoming prefixes routing filter mpls-te-address (string )the area used for MPLS traffic engineering. TE Opaque LSAs are generated in this area. No more than one OSPF instance can have mpls-te-area configured. mpls-te-area ( ) string the area used for MPLS traffic engineering. TE Opaque LSAs are generated in this area. No more than one OSPF instance can have mpls-te-area configured. originate-default (alwa ys | if-installed | never ; )Specifies default route (0.0.0.0/0) distribution method. out-filter-chain ( ) name name of the chain used for outgoing prefixes filtering. Output operates only with "external" routes. routing filter out-filter-select ( ) name name of the routing filter select chain, used for output selection. Output operates only with "external" routes. redistribute (bgp, connected,copy,dhcp, fantasy,modem,ospf, ) rip,static,vpn ; Enable redistribution of specific route types. router-id ( ; IP | name Default: ) mainOSPF Router ID. Can be set explicitly as an IP address, or as the name of the router-id instance.

version ( Default: 2 | 3; 2 )OSPF version this instance will be running (v2 for IPv4, v3 for IPv6). vrf (name of a routing ; Default: ) table mainthe VRF table this OSPF instance operates on use-dn ( ) yes | no Forces to use or ignore DN bit. Useful in some CE PE scenarios to inject intra-area routes into VRF. If a parameter is unset then the DN bit is used according to RFC. Available since v6rc12. Notes OSPF protocol supports two types of metrics: type1 - OSPF metric is the sum of the internal OSPF cost and the external route cost type2 - OSPF metric is equal only to the external route cost. Area Sub-menu: /routing/ospf/area Property Description area-id (IP ; address Default: 0. ) 0.0.0OSPF area identifier. If the router has networks in more than one area, then an area with area-id=0.0.0.0 (the backbone) must always be present. The backbone always contains all area border routers. The backbone is responsible for distributing routing information between non-backbone areas. The backbone must be contiguous, i.e. there must be no disconnected segments. However, area border routers do not need to be physically connected to the backbone - connection to it may be simulated using a virtual link. default- cost (integ ; ) erunsetDefault cost of injected LSAs into the area. If the value is not set, then stub area type-3 default LSA will not be originated. instance ( ; name ma ) ndatoryName of the OSPF instance this area belongs to. no- summaries ()Flag parameter, if set then the area will not flood summary LSAs in the stub area. name (stri )ngthe name of the area nssa- translate ( yes | no | ) candidateThe parameter indicates which ABR will be used as a translator from type7 to type5 LSA. Applicable only if area type is NSSA yes - the router will be always used as a translator no - the router will never be used as a translator candidate - OSPF elects one of the candidate routers to be a translator type (defa ult | nssa ; | stub Default: d ) efaultThe area type. Read more on the area types in the OSPF case studies. Type 1 external paths are always preferred over type 2 external paths. When all paths are type 2 external paths, the paths with the smallest advertised type 2 metric are always preferred. (RFC2328)

Area Range Sub-menu: /routing/ospf/area/range Property Description advertise ( ; Default: yes) yes | no Whether to create a summary LSA and advertise it to the adjacent areas. area ( ; ) name mandatory the OSPF area associated with this range cost ( ) integer [0..4294967295] the cost of the summary LSA this range will create default - use the largest cost of all routes used (i.e. routes that fall within this range) prefix ( ; ) IP prefix mandatory the network prefix of this range Interface Sub-menu: /routing/ospf/interface Read-only matched interface menu Interface Templates Sub-menu: /routing/ospf/interface-template The interface template defines common network and interface matches and what parameters to assign to a matched interface. Matchers Property Description interfaces ( name )Interfaces to match. Accepts specific interface names or the name of the interface list. network (I ) P prefixthe network prefix associated with the area. OSPF will be enabled on all interfaces that have at least one address falling within this range. Note that the network prefix of the address is used for this check (i.e. not the local address). For point-to-point interfaces, this means the address of the remote endpoint. Assigned Parameters Property Description area ( ; ) name mandatory The OSPF area to which the matching interface will be associated. auth (simple | md5 | sha1 | ) sha256 | sha384 | sha512Specifies authentication method for OSPF protocol messages. simple - plain text authentication md5 - keyed Message Digest 5 authentication sha - HMAC-SHA authentication RFC5709 If the parameter is unset, then authentication is not used. auth-id ( ) integer The key id is used to calculate message digest (used when MD5 or SHA authentication is enabled). The value should match all OSPF routers from the same region. authentication-key (string) The authentication key to be used, should match on all the neighbors of the network segment. comment (string) cost(integer [0..65535]) Interface cost expressed as link state metric.

dead-interval ( ; Default:time 40s )Specifies the interval after which a neighbor is declared dead. This interval is advertised in hello packets. This value must be the same for all routers on a specific network, otherwise, adjacency between them will not form disabled (yes | no) hello-interval ( ; Default:time 10s )The interval between packets that the router sends out this interface. The smaller this interval is, the faster HELLO topological changes will be detected, the tradeoff is more OSPF protocol traffic. This value must be the same for all the routers on a specific network, otherwise, adjacency between them will not form. instance-id (i ; nteger [0..255] Default: ) 0 passive () If enabled, then do not send or receive OSPF traffic on the matching interfaces prefix-list (name) Name of the address list containing networks that should be advertised to the v3 interface. priority ( ; integer: 0..255 Default: ) 128Router's priority. Used to determine the designated router in a broadcast network. The router with the highest priority value takes precedence. Priority value 0 means the router is not eligible to become a designated or backup designated router at all. retransmit-interval ( ; time Default: ) 5sTime interval the lost link state advertisement will be resent. When a router sends a link state advertisement (LSA) to its neighbor, the LSA is kept until the acknowledgment is received. If the acknowledgment was not received in time (see ), the router will try to retransmit the LSA. transmit-delay transmit-delay ( ; Default:time 1s )Link-state transmit delay is the estimated time it takes to transmit a link-state update packet on the interface. type (broadcast | nbma | ptp | ptmp | ptp-unnumbered | ; Default: ) virtual-link broadcastthe OSPF network type on this interface. Note that if interface configuration does not exist, the default network type is 'point-to-point' on PtP interfaces and 'broadcast' on all other interfaces. broadcast - network type suitable for Ethernet and other multicast capable link layers. Elects designated router nbma - Non-Broadcast Multiple Access. Protocol packets are sent to each neighbor's unicast address. Requires manual configuration of neighbors. Elects designated router ptp- suitable for networks that consist only of two nodes. Do not elect designated router ptmp - Point-to-Multipoint. Easier to configure than NBMA because it requires no manual configuration of a neighbor. Do not elect a designated router. This is the most robust network type and as such suitable for wireless networks, if 'broadcast' mode does not work well enough for them ptp-unnumbered - works the same as ptp, except that the remote neighbor does not have an associated IP address to a specific PTP interface. For example, in case an IP unnumbered is used on Cisco devices. virtual-link - for virtual link setups. vlink-neighbor-id ()IP Specifies the of the neighbor which should be connected over the virtual link. router-id vlink-transit-area ( ) name A non-backbone area the two routers have in common over which the virtual link will be established. Virtual links can not be established through stub areas. Lsa Sub-menu: /routing/ospf/lsa Read-only list of all the LSAs currently in the LSA database. Property Description age ( ) integer How long ago (in seconds) the last update occurred area ( ) string The area this LSA belongs to. body ( ) string checksum ( ) string LSA checksum ROS v7 default value is 128 (defined in RFC), and the default value in ROS v6 was 1, keep this in mind when if you had strict priorities set for DR/BDR election.

dynamic ( ) yes | no flushing ( ) yes | no id ()IP LSA record ID instance ( ) string The instance name this LSA belongs to. link ( ) string link-instance-id ()IP originator ()IP An originator of the LSA record. self-originated ( ) yes | no Whether LSA originated from the router itself. sequence ( ) string A number of times the LSA for a link has been updated. type ( ) string wraparound ( ) string Neighbors Sub-menu: /routing/ospf/neighbor Read-only list of currently active OSPF neighbors. Property Description address ()IP An IP address of the OSPF neighbor router adjacency ( )time Elapsed time since adjacency was formed area ( ) string bdr ( ) string An IP address of the Backup Designated Router comment ( ) string db-summaries ( ) integer dr ()IP An IP address of the Designated Router dynamic ( ) yes | no inactive ( ) yes | no instance ( ) string ls-requests ( ) integer ls-retransmits ( ) integer priority ( ) integer Priority configured on the neighbor router-id ()IP neighbor router's RouterID

state (down | attempt | init | 2- way | ExStart | Exchange | ) Loading | fullDown - No Hello packets have been received from a neighbor. Attempt - Applies only to NBMA clouds. The state indicates that no recent information was received from a neighbor. Init - Hello packet received from the neighbor, but bidirectional communication is not established (Its own RouterID is not listed in the Hello packet). 2-way - This state indicates that bi-directional communication is established. DR and BDR elections occur during this state, routers build adjacencies based on whether the router is DR or BDR, and the link is point-to- point or a virtual link. ExStart - Routers try to establish the initial sequence number that is used for the packet information exchange. The router with a higher ID becomes the master and starts the exchange. Exchange - Routers exchange database description (DD) packets. Loading - In this state actual link state information is exchanged. Link State Request packets are sent to neighbors to request any new LSAs that were found during the Exchange state. Full - Adjacency is complete, and neighbor routers are fully adjacent. LSA information is synchronized between adjacent routers. Routers achieve the full state with their DR and BDR only, an exception is P2P links. state-changes ( ) integer Total count of OSPF state changes since neighbor identification Static Neighbour configuration Sub-menu: /routing/ospf/static-neighbor Static configuration of the OSPF neighbors. Required for non-broadcast multi-access networks. Property Description address ( ; IP%iface ma ) ndatoryThe unicast IP address and an interface, that can be used to reach the IP of the neighbor. For example, = address 1.2.3.4% indicates that a neighbor with IP is reachable on the interface. ether1 1.2.3.4 ether1 area ( ; name mandatory )Name of the area the neighbor belongs to. comment (string) disabled (yes | no) instance-id (integer [0. ; Default: ) .255] 0 poll-interval ( ; time Default: ) 2mHow often to send hello messages to the neighbors which are in a "down" state (i.e. there is no traffic from them)

Property Description name name of the instance instance which to useVRF interfaces specifies which afi to use. source-addresses input filter chain cost (Default: ) output filter chain split-horizon ( ) no| yes poison-reverse ( ) no| yes mode ( ) passive| strict key-chain ( ) name name of key-chain password password Sub-menu: /routing rip interface Read-only properties: Property Description instance ( ) name name of the instance address ( ) address%interface IP address and interface name Neighbor Sub-menu: /routing rip neighbor This submenu is used to define a neighboring routers to exchange routing information with. Normally there is no need to add the neighbors, if multicasting is working properly within the network. If there are problems with exchanging routing information, neighbor routers can be added to the list. It will force the router to exchange the routing information with the neighbor using regular unicast packets. Read-only properties: Property Description address ( ) IP address IP address of neighboring router routes amount of routes packets-total amount of all packets packets-bad amount of bad packets entries-bad amount of bad entries last-update ( )time time from last update

Sub-menu: /routing rip static-neighbor Property Description instance (name) name of used instance address ( ) IP address IP address of neighboring router Keys Sub-menu: /routing rip keys MD5 authentication key chains. Property Description chain ( ; Default: ) string "" chain name to place this key in. key ( ; Default: ) string "" authentication key. Maximal length 16 characters key-id ( ; Default: ) integer:0..255 key identifier. This number is included in MD5 authenticated RIP messages, and determines witch key to use to check authentication for a specific message. valid-from ( ; Default: today's date and time date and time: ) 00:00:00key is valid from this date and time valid-till ( ; Default: today's date and time date and time: 00:00:00)key is valid until this date and time

BGP Summary BGP Terminology BGP Basics Connection Menu Session Menu Template Menu Best-Path Selection Routing Filter Notes Running More than One Instance VPLS VPN Route Distinguisher Properties Summary The Border Gateway Protocol (BGP) allows setting up an inter-domain dynamic routing system that automatically updates routing tables of devices running BGP in case of network topology changes. BGP is an inter-autonomous system routing protocol based on the distance-vector algorithm. It is used to exchange routing information across the Internet and is the only protocol that is designed to deal with a network of the Internet's size and the only protocol that can deal well with having multiple connections to unrelated routing domains. BGP is designed to allow for sophisticated administrative routing policies to be implemented. It does not exchange information about network topology but rather reachability information. As such, BGP is better suited to inter-AS environments and special cases like informational feeds. If you just need to enable dynamic routing in your network, consider OSPF instead. Standards and Technologies: RFC 4271 Border Gateway Protocol 4 RFC 4456 BGP Route Reflection RFC 5065 Autonomous System Confederations for BGP RFC 1997 BGP Communities Attribute RFC 8092 BGP Large Communities RFC 4360 , BGP Extended Communities 5668 RFC 2385 TCP MD5 Authentication for BGPv4 RFC 5492 Capabilities Advertisement with BGP-4 RFC 2918 Route Refresh Capability RFC 4760 Multiprotocol Extensions for BGP-4 RFC 2545 Use of BGP-4 Multiprotocol Extensions for IPv6 Inter-Domain Routing RFC 4893 BGP Support for Four-octet AS Number Space RFC 4364 BGP/MPLS IP Virtual Private Networks (VPNs) RFC 4761 Virtual Private LAN Service (VPLS) Using BGP for Auto-Discovery and Signalling - AS-wide Unique BGP Identifier for BGP-4 RFC 6286 - SNMP peer table monitoring (OID ) (IPv4 only) RFC 4273 1.3.6.1.2.1.15.3.1 - 4-byte ASN support and Aggregator attribute. RFC 6793 BGP Terminology AS - Autonomous System ASN - Autonomous System Number NLRI - Network Layer Reachability Information is what is being exchanged between BGP peers and represents how to reach the prefixes. IGP - Interior Gateway Protocol The feature is not supported on SMIPS devices (hAP lite, hAP lite TC, and hAP mini).

EGP - Exterior Gateway protocol RR - Route reflector is the router in the BGP network that reflects advertisements to all the neighbors, avoiding the requirement for full BGP mesh. Route server - is the BGP router that does not participate in traffic forwarding. Routes are typically not even installed in the FIB. loopback address - a /32 address configured on a dummy bridge interface, that can act as a loopback. BGP Basics BGP routers exchange reachability information by means of a transport protocol, which in the case of BGP is TCP (port 179). Upon forming a TCP connection these routers exchange messages to negotiate and confirm supported capabilities. OPEN After agreeing on capabilities to use, the session is considered to be established and peers can start to exchange NLRIs via messages. This UPDATE information contains an indication of what sequence of full paths (BGP AS numbers) the route should take in order to reach the destination network (NLRI prefix). The peers initially exchange their full routing tables and after the initial exchange, incremental updates are sent as the routing tables change. Thus, BGP does not require a periodic refresh of the entire BGP routing table. BGP maintains the routing table version number which must be the same between any two given peers for the duration of the connection. KEEPALIVE messages are sent periodically to ensure that the connection is up and running, if messages are not received within the KEEPALIVE Hold interval, the connection will be closed. Time To respond to errors or special conditions, messages can be generated and sent to the remote peer, notification message type also NOTIFICATION indicates whether the connection should be immediately closed. There can be two types of BGP connections: iBGP - is an "internal" link connecting peers from the same AS eBGP - is an "external" link connecting peers belonging to two different AS-es A particular AS might have multiple BGP speakers and provide transit service to other AS-es. This implies that BGP speakers must maintain a consistent view of routing within the AS. A consistent view of the routes exterior to the AS is provided by having all BGP routers within the AS establish direct iBGP connections with each other (full mesh) or by utilizing a Router Reflector setup. Using a set of administrative policies BGP speakers within the AS come to an agreement as to which entry/exit point to use for a particular destination. This information is communicated to the interior routers of the AS using the interior routing protocol (IGP), for example, OSPF, RIP, or static routing. In certain setups, iBGP can take the IGP protocol role as well. For certain BGP attributes handling behavior may change depending on what type of connection is set up, for example, the LOCAL-PREF attribute is not advertised to eBGP peers. RouterOS divides configuration and session monitoring into three menus: connection menu ( ) /routing/bgp/connection sessions menu( ) /routing/bgp/session template menu ( ) /routing/bgp/template Connection Menu Let's look at a very basic eBGP configuration example assuming, that Router1 IP is 192.168.1.1, AS 65531 and Router2 IP 192.168.1.2, AS 65532: #Router1 /routing/bgp/connection add name=toR2 remote.address=192.168.1.2 as=65531 local.role=ebgp #Router2 /routing/bgp/connection add name=toR1 remote.address=192.168.1.1 as=65532 local.role=ebgp The BGP connection menu defines BGP outgoing connections as well as acts as a template matcher for incoming BGP connections. parameter is used to indicate that this connection will be the eBGP. Also, notice that the connection does not require a remote AS number local.role to be specified, RouterOS can determine a remote AS number dynamically from the first received message. OPEN

The parameter equivalent to other vendors and older RouterOS "update-source" is " ". In most cases, it can be left unconfigured, and let local.address the router determine the address. When a local address is not specified, BGP will try to guess the local address depending on the current setup: if the peer is iBGP if loopback available pick the highest loopback address if loopback is not available pick any highest IP address on the router if the peer is eBGP if a remote peer's IP is not from a directly connected network: and multihop is not set, then throw an error and multihop is enabled: if loopback available pick the highest loopback address if loopback is not available pick any highest IP address on the router if a remote peer's IP is from a directly connected network: : and multihop is not set pick the local routers IP address from that connected network and multihop is set: if loopback available pick the highest loopback address if loopback is not available pick any highest IP address on the router In addition to connection-specific parameters, template-specific parameters are also directly exposed in this menu, for easier configuration in simple scenarios (when templates are not necessary). A list of all connection-specific parameters can be seen in the table below: Property Description name ( ; Default: ) string Name of the BGP connection connect ( ; Default: ) yes | no yes Whether to allow the router to initiate the connection. listen ( ; Default: yes) yes | no Whether to listen for incoming connections. local - a group of parameters associated with the local side of the connection .address ( ; Default: ::) IPv4/6 Local connection address. .port( ; Default:179 ) integer [0..65535] Local connection port. .role(ebgp | ebgp-customer | ebgp-peer | ebgp-provider | ebgp-rs | ebgp-rs-client | ibgp | ibgp-rr; Default: )BGP role, in most common scenarios it should be set to iBGP or eBGP. More information on BGP roles can be found in the corresponding RFC draft https://datatracker.ietf.org/doc/draft-ietf-idr-bgp- open-policy/?include_text=1 ) .ttl ( ; Default:) integer [1..255] Time To Live (hop limit) that will be recorded in sent TCP packets. remote - a group of parameters associated with the remote side of the connection .address ( ; Default: ::) IPv4/6 Remote address used to connect and/or listen to. .port( ; Default:179 ) integer [0..65535] Local connection port. .as( ; Default: ) integer [] Remote AS number. If not specified BGP will determine remote AS automatically from the OPEN message. .allowed-as () List of remote AS numbers that are allowed to connect. Useful for dynamic peer configuration. .ttl ( ; Default:) integer [1..255] Acceptable minimum Time To Live, the hop limit for this TCP connection. For example, if 'ttl=255' then only single-hop neighbors will be able to establish the connection. This property only affects EBGP peers.

The template contains all BGP protocol-related configuration options. It can be used as a template for dynamic peers and to apply a similar configuration to a group of peers. Note that this is not the same as peer groups on Cisco devices, where the group is more than just a common configuration. List of available template parameters: Property Description add-path-out (all ; Default: ) |none address-families (ip | ipv6 | ; l2vpn | l2vpn-cisco | vpnv4 Default: ) ipList of address families about which this peer will exchange routing information. The remote peer must support (they usually do) BGP capabilities optional parameter to negotiate any other families than IP. as ( ; integer [0..4294967295] Default: )32-bit BGP autonomous system number. Value can be entered in AS-Plain and AS-Dot formats. The parameter is also used to set up the BGP confederation, in the following format: . For example, if your confederation_as/as AS is 34 and your confederation AS is 43, then as configuration should be . =43/34as as-override ( ; yes | no Default: ) noIf set, then all instances of the remote peer's AS number in the BGP AS-PATH attribute are replaced with the local AS number before sending a route update to that peer. Happens before routing filters and prepending. cisco-vpls-nlri-len-fmt (auto- ; bits | auto-bytes | bits | bytes Default: )VPLS NLRI length format type. Used for compatibility with Cisco VPLS. [[Read more>>]]. cluster-id ( ; IP address Default: )In case this instance is a route reflector: the cluster ID of the router reflector cluster to this instance belongs. This attribute helps to recognize routing updates that come from another route reflector in this cluster and avoid routing information looping. Note that normally there is only one route reflector in a cluster; in this case, 'cluster-id' does not need to be configured and BGP router ID is used instead disabled ( ; Default: yes | no no )Whether the template is disabled. hold-time (time[3s..1h] | ; Default: ) infinity 3mSpecifies the BGP Hold Time value to use when negotiating with peers. According to the BGP specification, if the router does not receive successive and/or and/or KEEPALIVE UPDATE NO messages within the period specified in the Hold Time field of the message, then the BGP TIFICATION OPEN connection to the peer will be closed. The minimal hold-time value of both peers will be used (note that the special value 0 or 'infinity' is lower than any other value) infinity - never expire the connection and never send keepalive messages. input - a group of parameters associated with BGP input .accept-comunities (string ; Default: )A quick way to filter incoming updates with specific communities. It allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in /routing route table as "not active, filtered". Changes to be applied required session refresh. .accept-ext-communities ( ; Default: ) stringA quick way to filter incoming updates with specific extended communities. It allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in /routing route table as "not active, filtered". Changes to be applied required session refresh. .accept-large-comunities ( ; Default: ) stringA quick way to filter incoming updates with specific large communities. It allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in /routing route table as "not active, filtered". Changes to be applied required session refresh.

.accept-nlri ( ; string Default: )Name of the ipv4/6 address-list. A quick way to filter incoming updates with specific NLRIs. It allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in /routing route table as "not active, filtered". Changes to be applied required session restart. .accept-unknown ( ; string Default: )A quick way to filter incoming updates with specific "unknown" attributes. It allows filtering incoming messages directly before they are even parsed and stored in memory, that way significantly reducing memory usage. Regular input filter chain can only reject prefixes which means that it will still eat memory and will be visible in /routing route table as "not active, filtered". Changes to be applied required session refresh. .affinity (afi | alone | instance | main | remote- as | vrf; Default: alone )Configure input multi-core processing. Read more in article. Routing Protocol Multi-core Support alone - input and output of each session are processed in its own process, most likely the best option when there are a lot of cores and a lot of peers afi, instance, vrf, remote-as - try to run input/output of new session in process with similar parameters main - run input/output in the main process (could potentially increase performance on single-core even possibly on multi-core devices with a small amount of cores) input - run output in the same process as input (can be set only for output affinity) .allow-as ( ; integer [0..10] Default: )Indicates how many times to allow your own AS number in AS-PATH, before discarding a prefix. .filter ( ; Default: ) name Name of the routing filter chain to be used on input prefixes. This happens after NLRIs are processed. If the chain is not specified, then BGP by default accepts everything. .ignore-as-path-len (yes ; Default: ) | no noWhether to ignore attribute in the BGP route selection algorithm the AS_PATH ( .limit-nlri-diversity integer ; Default: ) .limit-process-routes- ( ; Default: ) ipv4 integerTry to limit the amount of received IPv4 routes to the specified number. This number does not represent the exact number of routes going to be installed in the routing table by the peer. command must be used BGP session "clear" to reset the flag if the limit is reached. .limit-process-routes- ( ; Default: ) ipv6 integerTry to limit the amount of received IPv6 routes to the specified number. This number does not represent the exact number of routes going to be installed in the routing table by the peer. BGP session "clear" command must be used to reset the flag if the limit is reached. keepalive-time (time [1s.. ; Default: ) 30m]The interval between keepalive messages, if not set by default keepalive is 1/3 of the . hold-time multihop ( ; Default: yes | no no )Specifies whether the remote peer is more than one hop away. This option affects outgoing next-hop selection as described in RFC 4271 (for EBGP only, excluding EBGP peers local to the confederation). It also affects: whether to accept connections from peers that are not in the same network (the remote address of the connection is used for this check); whether to accept incoming routes with NEXT_HOP attribute that is not in the same network as the address used to establish the connection; the target-scope of the routes installed from this peer; routes from multi-hop or IBGP peers resolve their next- hops through IGP routes by default. name ( ; Default: ) string Name of the BGP template nexthop-choice (default | ; force-self | propagate Default: ) defaultAffects the outgoing attribute selection. Note that next-hops set in filters always take precedence. Also NEXT_HOP note that the next-hop is not changed on route reflection, except when it's set in the filter. default - select the next-hop as described in RFC 4271 force-self - always use a local address of the interface that is used to connect to the peer as the next-hop; propagate - try to propagate further the next-hop received; i.e. if the route has BGP attribute, then NEXT_HOP use it as the next-hop, otherwise, fall back to the default case output - a group of parameters associated with BGP output

.affinity (afi | alone | instance | main | remote- as | vrf; Default: )Configure output multicore processing. Read more in article. Routing Protocol Multi-core Support alone - input and output of each session is processed in its own process, the most likely best option when there are a lot of cores and a lot of peers afi, instance, vrf, remote-as - try to run input/output of new session in process with similar parameters main - run input/output in the main process (could potentially increase performance on single-core even possibly on multicore devices with small amount of cores) input - run output in the same process as input (can be set only for output affinity) .default-originate (alway ; s | if-installed | never Default: ) neverSpecifies default route (0.0.0.0/0) distribution method. default-prepend (integer ; Default: ) [0..255] .filter-chain ( ; name Default: )Name of the routing filter chain to be used on the output prefixes. If the chain is not specified, then BGP by default accepts everything. .filter-select ( ; name Default: )Name of the routing select chain to be used for prefix selection. If not specified, then default selection is used. .keep-sent-attributes (ye ; Default: no) s | noStore in memory sent prefix attributes, required for " " command to work. By default, dump-saved-advertisements sent-out prefixes are not stored to preserve the router's memory. An option should be enabled only for debugging purposes when necessary to see currently advertised prefixes. .network ( ; Default: name )Name of the address list used to send local networks. The network is sent only if a matching IGP route exists in the routing table. .no-client-to-client- reflection (yes | no; Default: )Disable client-to-client route reflection in Route Reflector setups. .no-early-cut (yes | no; Default: )The early cut is the mechanism, to guess (based on default RFC behavior) what would happen with the sent NPLRI when received by the remote peer. If the algorithm determines that the NLRI is going to be dropped, a peer will not even try to send it. However such behavior may not be desired in specific scenarios, then then this option should be used to disable the early cut feature. redistribute (bgp, connected, bgp-mpls- vpn , dhcp, fantasy, modem, ospf, rip, static, ; Default:)vpnEnable redistribution of specified route types. remove-private-as ( ; yes | no Default: noIf set, then the BGP attribute is removed before sending out route updates if the attribute contains only AS-PATH private AS numbers. The removal process happens before routing filters are applied and before the local, AS number is prepended to the AS path. router-id ( ; Default: IP | name main )BGP Router ID to be used. Use the ID from the configuration by specifying the reference name, or /routing/router-id set the ID directly by specifying IP. Equal r outer-ids are also used to group peers into one instance. routing-table ( ; Default: string )Name of the routing table, to install routes in. save-to ( ; Default: ) string Filename to be used to save BGP protocol-specific packet content (Exported PDU) into pcap file. This method allows much simpler peer-specific packet capturing for debugging purposes. Pcap files in this format can also be loaded to create virtual BGP peers to recreate conditions that happened at the time when packet capture was running. templates ( ; name[,name] Default: )List of template names from which to inherit parameters. Useful feature, to easily configure groups with overlapping configuration options. use-bfd ( ; Default: ) yes | no no Whether to use the protocol for faster connection state detection. BFD vrf ( ; Default: main ) name Name of the VRF BGP connections operates on. By default always use the "main" routing table.

1. 2. 3. 4. 5. 6. 7. 8. 9. 10. 11. 12. Best-Path Selection BGP routers can receive multiple copies of the global routing table from multiple providers. There should be some way to compare those multiple BGP routing tables and select the best route to the destination, the solution is the BGP Best Path Selection Algorithm. The route is evaluated by the algorithm only if it is valid. In general, the route is considered valid if: NEXT_HOP of the route is valid and reachable AS_PATH received from external peers does not contain the local AS the route is not rejected by routing filters For more information read . nexthop selection and validation The best path algorithm also compares routes received only by a . Routes installed by different BGP instances are compared by the single BGP instance general algorithm, i.e. route distances are compared and the route with a lower distance is preferred. If all the criteria are met, then the following actions take place: The first path received is automatically considered the 'best path'. Any further received paths are compared to the first received to determine if the new path is better. Prefer the path with the highest . WEIGHT This parameter is not a part of the BGP standard, it is invented to quickly locally select the best route. A parameter is local to the router (assigned with routing filters in the BGP input) and cannot be advertised. A route without assigned WEIGHT has a default value of 0. Prefer the path with the highest . LOCAL_PREF This attribute is used only within an AS. A path without the LOCAL_PREF attribute has a value of 100 by default. Prefer the path with the shortest . (skipped if set to ). AS_PATH input.ignore-as-path-len yes Each AS_SET counts as 1, regardless of the set size. The AS_CONFED_SEQUENCE and AS_CONFED_SET are not included in the AS_PATH length. Prefer the path that was locally originated via aggregate or BGP network Prefer the path with the lowest type. ORIGIN Interior Gateway Protocol (IGP) is lower than Exterior Gateway Protocol (EGP), and EGP is lower than INCOMPLETE in other words IGP < EGP < INCOMPLETE Prefer the path with the lowest (MED). multi-exit discriminator The router compares the MED attribute only for paths that have the same neighboring (leftmost) AS unless is input.always-compare-med enabled. Paths without explicit MED value are treated with MED of 0. Prefer over paths eBGP iBGP Prefer lowest . IGP metric Prefer the route that comes from the BGP router with the lowest . If a route carries the attribute, then the router ID ORIGINATOR_ID ORIGINATOR is used instead of the router ID._ID Prefer the route with the shortest . Routes without a cluster list are considered to have a cluster list of length 0. route reflection cluster list Prefer the path that comes from the lowest neighbor address Routing Filter Notes On BGP output routing filters are executed before BGP itself is modifying attributes, for example, if is set to , then the nexthop-choice force-self gateway set in the routing filters will be overridden. On BGP input routing filters are applied to the received attributes, which means that, for example, setting the gateway will work no matter what nexhop- value is set. choice Running More than One Instance

As we already know for best path selection to work properly, BGP routes must be received from the same instance. But in certain scenarios it is necessary to run multiple BGP instances with their own separate tables. BGP determines whether sessions belongs to the same instance by comparing configured local router IDs. For example config below will run each peer in its own BGP instance /routing/bgp/connection add name=inst1_peer remote.address=192.168.1.1 as=1234 local.role=ebgp router-id=1.1.1.1 add name=inst2_peer remote.address=192.168.1.2 as=5678 local.role=ebgp router-id=2.2.2.2 When is not specified BGP will pick the "default" ID from . router-id /routing id VPLS Sub Menu: /routing/bgp/vpls This menu lists all the configured BGP-based VPLS instances. These instances allow the router to advertise VPLS BGP NLRI and indicate that the router belongs to a specific customer VPLS network. MP-BGP-based autodiscovery and signaling (RFC 4761). Cisco VPLS BGP-based auto-discovery (draft-ietf-l2vpn-signaling-08). Support for multiple import/export route target extended communities for BGP-based VPLS (both, RFC 4761 and draft-ietf-l2vpn-signaling-08). Property Description bridge (na me)The name of the bridge where dynamically created VPLS interfaces should be added as ports. bridge- cost (integ er [0.. 42949672 95]) bridge- horizon (n one | integer [0.. 42949672 95])If set to none bridge horizon will not be used. bridge- pvid (integ er 1.. 4094)Used to assign port VLAN ID (pvid) for dynamically bridged interface. cisco-id () Unique identifier. A parameter must be set for cisco-style VPLS signaling. In most cases this should not be used, any modern software supports RFC 4761 style signaling (see site-id parameter). Parameter is a merge of l2-router-id and RD, for example: 10.155.155.1&6550: 123 comment ( string )Short description of the item. disabled ( yes | no )Defines whether an item is ignored or used. export- route- target (list of RTs)The setting is used to tag BGP NLRI with one or more route targets which on the remote side is used by . import-route-targets

import- route- targets (lis t of RTs )The setting is used to determine if BGP NLRI is related to a particular VPLS, by comparing route targets received from BGP NLRI. local-pref ( integer[0.. 42949672 95]) name (stri ng; Default: ) pw- control- word (defa ult | disabled | enabled )Enables/disables Control Word usage. Read more in the article. VPLS Control Word pw-l2mtu ( integer [32.. 65535] )Advertised pseudowire MTU value. pw-type (r aw- ethernet | tagged- ethernet | vpls)The parameter is available starting from v5.16. It allows choosing advertised encapsulation in NLRI used only for comparison. It does not affect the functionality of the tunnel. See pw-type usage example >> rd (string )Specifies the value that gets attached to VPLS NLRI so that receiving routers can distinguish advertisements that may otherwise look the same. This implies that a unique route-distinguisher for every VPLS must be used. It is not necessary to use the same route distinguisher for some VPLS on all routers forming that VPLS as distinguisher is not used for determining if some BGP NLRI is related to a particular VPLS (Route Target attribute is used for this), but it is mandatory to have different distinguishers for different VPLSes. Accepts 3 types of formats. Read more>> site-id (int eger [0.. 65535] )Unique site identifier. Each site must have a unique site-id. A parameter must be set for RFC 4761 style VPLS signaling. vrf (name )Name of the VRF table. VPN Sub Menu: /routing/bgp/vpn Route Distinguisher Route Distinguisher is a 64-bit integer, which is divided into three parts: type (always 2 bytes), administrator subfield, value or service provider subfield. Currently, there are three format types defined. 2bytes 2bytes 2bytes 2bytes Type1ASN 4byte value Type24-byte IP value

Type34-byte ASN value Properties disabled ( ) yes | no export - a group of parameters associated with the vpnv4 export .filter-chain ( ) name The name of the routing filter chain that is used to filter prefixes before exporting. .filter-select ( ) name The name of the select filter chain that is used to select prefixes to be exported exporting. .redistribute (bgp | connected | dhcp | fantasy | ) modem | ospf | rip | static | vpnEnable redistribution of specified route types from VRF to VPNv4. .route-targets ( )rt[,rt] List of route targets added when exporting VPNv4 routes. The accepted RT format is similar to the one for Route Distinguishers. import - a group of parameters associated with the vpnv4 import .filter-chain ( ) name The name of the routing filter chain that is used to filter prefixes during import. .route-targets ( )rt[,rt] List of route targets that will be used to import VPNv4 routes. The accepted RT format is similar to the one for Route Distinguishers. .router-id ( ) name | ip The router ID of the BGP instance that will be used for the BGP best path selection algorithm. label-allocation-policy ( ) per-prefix | per-vrf name route-distinguisher (rd) Helps to distinguish between overlapping routes from multiple VRFs. Should be unique per VRF. Accepts 3 types of formats. Read more>> vrf ( ) name Name of the VRF table that this VPN instance will use.

RPKI Overview RouterOS implements the Resource Public Key Infrastructure (RPKI) to Router Protocol defined in . RTR is a very lightweight low memory RFC8210 footprint protocol, to reliably get prefix validation data from RPKI validators. More information on RPKI and how to set up validators can be found in the RIPE blog: https://blog.apnic.net/2019/10/28/how-to-installing-an-rpki-validator/ Basic Example Let's consider that we have our own RTR server on our network with IP address 192.168.1.1: /routing/bgp/rpki add group=myRpkiGroup address=192.168.1.1 port=8282 refresh-interval=20 If the connection is established and a database from the validator is received, we can check prefix validity: [admin@rack1_b33_CCR1036] /routing> rpki-check group=myRpkiGroup prfx=70.132.18.0/24 origin-as=16509 valid Now the cached database can be used by routing filters to accept/reject prefixes based on RPKI validity. At first, we need to set up a filter rule which defines against which RPKI group performs the verification. After that filters are ready to match the status from the RPKI database. Status can have one of three values: valid - database has a record and origin AS is valid. invalid - the database has a record and origin AS is invalid. unknown - database does not have information of prefix and origin AS. unverified - set when none of the RPKI sessions of the RPKI group has synced database. This value can be used to handle the total failure of the RPKI. /routing/filter/rule add chain=bgp_in rule="rpki-verify myRpkiGroup" add chain=bgp_in rule="if (rpki invalid) { reject } else { accept }" Configuration Options Sub-Menu: /routing/rpki Property Description address ( ) IPv4/6 mandatory Address of the RTR server disabled ( ; Default: ) yes | no no Whether the item is ignored. expire-interval ( ; integer [600..172800] Default: 7200)Time interval [s] polled data is considered valid in the absence of a valid subsequent update from the validator. group ( ) string mandatory Name of the group a database is assigned to. port ( ; Default: 323) integer [0..65535] Connection port number

preference ( ; integer [0..4294967295] Default: 0)If there are multiple RTR sources, the preference number indicates a more preferred one. A higher number is preferred. If preference is not configured then lowest remote IP within a group is preferred, if IPs are equal then lowest remote port is preferred. refresh-interval ( ; integer [1..86400] Default: 3600)Time interval [s] to poll the newest data from the validator. retry-interval ( ; Default: integer [1..7200] 600)Time Interval [s] to retry after the failed data poll from the validator. vrf( ; Default: main) name Name of the VRF table used to bind the connection to.

Route Selection and Filters Route Filtering Filter Syntax The routing filter rule implements script-like syntax. The example below is a quick demonstration of a routing filter that matches prefixes with a prefix length greater than 24 from subnet 192.168.1.0/24 and increments the default distance by 1. If there is no match then subtract the default distance by one. /routing filter rule add chain=myChain \ rule="if (dst in 192.168.1.0/24 && dst-len>24) {set distance +1; accept} else {set distance -1; accept}" Filter rule may consist of multiple matchers and actions: if ( [matchers] ) { [actions] } else { [actions] } There are two types of properties: only readable - ones that value is only readable and cannot be rewritten, these properties can be used only by matchers readable/writable - ones that value is readable and writeable, used by filter actions, and also can be used by matchers Readable properties can be matched by other readable properties (for numeric properties only) or constant values using boolean operators. [matchers]: [prop readable] [bool operator] [prop readable] [actions]: [action] [prop writeable] [value] The boolean operator is not used if there is only one possible operation. Example without boolean operator: if ( protocol connected ) { accept } Example with boolean operator: if ( bgp-med < 30 ) { accept } With readable flag properties, matcher is used without specified boolean operator and without value if ( ospf-dn ) { reject }Error rendering macro 'toc' java.lang.RuntimeException: com.ctc.wstx.exc.WstxUnexpectedCharException: Unexpected character ';' (code 59) expected '=' at [row,col {unknown-source}]: [51,1641]

Only Readable Properties Property Type Description Numeric properties dst-len Destination prefix length bgp-path-len The current length of the BGP AS-PATH bgp-input- local-asAS number of the local peer to which the prefix was sent bgp-input- remote-asAS number of the remote peer from which the prefix was received bgp-output- local-asAS number of the peer that will advertise the prefix bgp-output- remote-asAS number of the peer to which the prefix will be advertised ospf-metric Current OSPF metric ospf-tag Current OSPF tag rip-metric Current RIP metric rip-tag Current RIP tag Flag properties active indicates whether the route is active bgp-atomic- aggregate bgp- communities- emptyindicates if the BGP Communities attribute is empty bgp-ext- communities- emptyindicates if the BGP Extended Communities attribute is empty bgp-large- communities- emptyindicates if the BGP Large Communities attribute is empty bgp-network Indicates if the prefix is originated from BGP networks ospf-dn Indicates if the OSPF route has DN bit set. Prefix properties dst Destination ospf-fwd Current OSPF forwarding address bgp-input- local-addrThe IP address of the local peer to which the prefix was sent Be aware that the default action of the routing filter chain is "reject"

bgp-input- remote-addrThe IP address of the remote peer from which the prefix was received bgp-output- local-addrThe IP address of the peer that will advertise the prefix bgp-output- remote-addrThe IP address of the peer to which the prefix will be advertised Other Properties afi ipv4 | ipv6 | l2vpn | l2vpn-cisco | vpnv4 | vpnv6The address family of the route. bgp-as-path numeric_regexp AS path matching, read more>> bgp-as-path- slow-legacystring_regexp Deprecated . Extremely slow old-style AS path matching. This parameter should be used only as a temporary matcher while migrating from an old ROS v6 config. Read more>> chain chain_name ospf-type ext1 | ext2 | inter | intra | nssa1 | nssa2Type of the OSPF route: ext1 - external (Type 5 LSA) with type1 metric ext2 - external (Type 5 LSA) with type2 metric inter - inter-area-route (Type 3 LSA) intra - intra-area-route (Type 4 LSA) nssa1 - Type 7 LSA with type1 metric nssa2 - Type 7 LSA with type1 metric protocol bgp | connected | dhcp | fantasy | modem | ospf | rip | static | vpnProtocol type from which the route was imported. rpki invalid | unknown | valid | unverified RPKI validation status of the prefix rtab routing_table_name Name of the routing table the route was imported from vrf vrf_name Name of the VRF the route was imported from Writeable Properties Property Type Description Numeric properties distance route distance scope scope- targettarget scope bgp- weightBGP WEIGHT attribute bgp-med BGP MED attribute is local to the router. It is also used in the output of iBGP peers. bgp-out- medBGP MED attribute to be sent to a remote peer. Should be used in the output chain of eBGP peers. bgp-local- prefBGP LOCALPREF attribute bgp-igp- metricBGP IGP METRIC

bgp-path- peer- prependPrepend last received remote peers ASN. If the prefix is originated from the router, then this parameter will not do anything on the router's output, because ASN does not exist yet. If used as a matcher in BGP input, it is possible to filter prefixes exceeding a certain number of prepends. For example, if a remote peer prepends its ASN 5 times, but we want to allow max 4 times prepended ASN, then we can use: " " if ( > 4) {reject} bgp-path-peer-prepend This parameter also overrides any prepends received from the remote peer, for example, if the remote peer prepended it's AS 3 times, we can remove this prepend by setting " 1" in BGP input bgp-path-peer-prepend bgp-path- prependPrepend routers ASN, should be used in BGP output. ospf-ext- metricOSPF External route metric ospf-ext- tagOSPF external route tag rip-ext- metricRIP External route metric rip-ext-tag RIP External route tag Flag properties ospf-ext- dnDN bit for external OSPF routes blackhole suppress- hw-offloadWhether to suppress L3 HW offloading use-te- nexthop Other properties gw ipv4/6 address IPv4/IPv6 address or interface name. In the case of BGP output, a gateway can be adjusted in the following setups: is BGP reflector nexthop-choice is set to propagate is not eBGP and nexthop-choice=force-self is not set. gw- interfaceinterface_name Interface part of the gateway. Should be used if it is required to attach a specific interface for next-hop, like (1.2.3.4% ether1) gw-checknone|arp|icmp |bfd|bfd-mh pref-src ipv4/6 address bgp-originigp|egp|incom plete ospf-ext- fwdipv4/6 address Forwarding address of External OSPF route ospf-ext- typetype1|type2 OSPF External route type comment string

bgp- communiti esinline_community _set | community_list_n ameBGP Communities attribute is defined in RFC 1997. Each community is 32-bit in size. bgp-ext- communiti esinline_ext_commu nity_set | ext_community_li st_nameBGP Extended Communities attribute is defined in RFC 4360. RouterOS parses site-of-origin (prefixed with soo:) and route-target (prefixed with rt:) extended communities. For example, "set bgp-ext-communities rt:1111:2.3.4.5;". It is possible to set/match RAW extended communities value in 64-bit hex, for example, "set bgp-ext-community 0x.........;" bgp-large- communiti esinline_large_com munity_set | large_community _list_nameBGP Large Communities attribute is defined in RFC 8092. Suitable for use with all ASNs including 32-bit ASNs. Each community is 12-bytes in length and consists of 3 parts: "global_admin:locap_part_1:local_part_2". Commands Command Params Description accept accept matched prefix reject reject matched prefix, the prefix will be stored in the memory as "filtered" and will not be the candidate to be selected as the best path. return return to the parent chain jumpjump chain_n amejump to a specified chain unsetunset prop_na meused to unset the value of the following properties: pref-src|bgp-med|bgp-out-med|bgp-local-pref append append at the end of the list or string. Following property values can be appended: bgp-communities, bgp-ext- communities, bgp-large-communities, comment filter Inverse of the delete action (Delete everything except the specified values). Values of the following properties can be filtered: bgp-communities, bgp-ext-communities, bgp-large-communities delete Delete the value of the specified property. Values of the following properties can be deleted: bgp-communities, bgp- ext-communities, bgp-large-communities setset prop_wr iteable valueThe command is used to set a new value to writeable properties. Value can be set from other readable properties of matching types. For numeric properties, it is possible to prefix the value with +/- which will increment or decrement the current property value by a given amount. For example, " " will increment current LOCAL_PREF set +1 bgp-local-ref by one, or extract value from other readable num property, " " set + distance ospf-ext-metric rpki-verifyrpki- verify rpki_gr oup_nameEnable RPKI verification in the current chain from the specified RPKI group. Operators Matcher Operators Operator Description Example && Logical AND operator if (dst in 192.168.0.0/16 && dst-len in 16-32) {reject;} || Logical OR operator not Logical NOT operator if ( not bgp-network) {reject; }

Num Prop Operators Operator Description in return true if the value is in provided numeric range. Numeric range can be written in following formats: {int..int}, {int-int} == return true if numeric values are equal != return true if numeric values are not equal > return true if the left numeric value is greater than the right numeric value < return true if the left numeric value is less than the right numeric value >= return true if the left numeric value is greater than or equal to the right numeric value <= return true if the left numeric value is less than or equal to the right numeric value Prefix Operators Operator Description in Return true if the prefix is the subnet of the provided network. If an operator is used to match prefixes from the address list (e.g " dst in "), then it will match only the exact prefix. list_name != Return true if the prefix is not equal to the provided value == Return true if the prefix is equal to the provided value BGP Community Operators Operator Description Example equal return true if provided communities are equal to the routes property value equal-list return true if communities from provided community-list are equal to the route's property value any returns true if the route's property value contains at least one of provided communities any-list returns true if the route's property value contains at least one community from the provided list includes returns true if the route's property value includes specified communities includes-list returns true if the route's property value includes all communities from the specified communities-list subset returns true if route community subset matches communities from the list 1:1,3:3 will match 1:1,2:2,3:3 subset-list the same as "subset", but matches communities form the community list. any-regexp the same as "any", but matched by regexp subset-regexp the same as "subset", but matched by regexp String Operators Operator Description find Check if provided substring is part of the property value regexp Match string regexp of the property value Deleting BGP Communities Routing filters allow to clear BGP communities by using "delete" command. Delete command accepts several parameters based on the type of the community type:

communities : "" - will match and remove well known communitieswk " " - will match and remove other communities that are not well known other " " - regexp pattern to match communities that should be deleted regexp "<community-list name>" - deletes communities from specified community-list ext-communities : "" - will match and remove rt RouteTarget "" - will match and remove soo Site-of-Origin " " - will match and remove other ext communities that are not RT or SSO other " " - regexp pattern to match ext communities that should be deleted regexp "<community-ext-list name>" - deletes communities from specified community-ext-list large-communities : "" - removes everythingall " " - regexp pattern to match large communities that should be deleted regexp "<community-large-list name>" - deletes large communities from specified community-large-list It is possible to specify multiple community types, for example delete all SSOs, other type of ext communities and specific RTs from the community-ext list: /routing/filter/community-ext-list add list=myRTList communities="rt:1.1.1.1:222" /routing/filter/rule add chain=myChain rule="delete bgp-ext-communities sso,other,myRTList;" AS-PATH Regexp Matching AS Path is the sequence of autonomous system numbers (ASNs), for example AS Path 123 456 789 would indicate, that route originated from AS with the number 789, and to reach the destination, the packet would need to travel through two autonomous systems: 456 and 789. To apply specific routing policies administrator might want to match specific AS numbers or set of numbers in the AS Path (for example, reject prefixes that travel through AS 456), which can be achieved using regular expression (regexp). There are two common ways how to operate with AS Path data: convert whole AS path to string and let regexp operate on the string (ROS v6 or Cisco style) let regexp operate on each entry in the AS path as a number (ROS v7, Juniper style) Basically, the first method is performing the match per character, the second method is performing the match per whole AS number. As you would imagine the latter method is much faster and less resource-intensive than the string matching approach. This change would require administrators to implement new Regex strategies. Old Regex patterns from RouterOS v6 cannot be directly copied/pasted as they will result either in syntax errors or unexpected results. Let us take a very basic AS Path filter rule. /routing/filter/rule add chain=myChain rule="if (bgp-as-path .1234.) {accept}" In ROS v7 this Regex pattern will match ASN 1234 anywhere in the middle of the AS-path, the same pattern in ROS v6 would match any AS path that contains ASN consisting of at least 6 characters and contains a string of "1234". Obviously, if we directly copy/paste the Regex pattern from one implementation to another it will lead to unexpected/dangerous results. An equivalent pattern in ROS v6 would look something like this: "._1234_.". Let's take another example from ROS v6, say we have a pattern "1234[5-9]" what it does is it matches 12345 to 12349 anywhere in the string, which means that valid matches are AS-path "12345 3434", "11 9123467 22" and so on. If you enter the same pattern in ROS v7 it will match AS path containing exact ASN 1234 followed by ASN in a range from 5 to 9 (matching AS-paths would be "1234 7 111", "111 1234 5 222" etc., it will not match "12345 3434"). Do not copy Regex patterns directly from ROS v6 or Cisco configurations, they are not directly compatible. It can lead to unexpected or even dangerous configurations in some scenarios.

Regex Testing Tool RouterOS now has a built-in regex checking tool to simplify the hard life of the administrators. This tool supports also num-list so now exact regex can be tested against any as-path before applying it to the routing filters. /routing/filter/num-list add list=test range=100-1500 /routing/filter/test-as-path-regexp regexp="[[:test:]]5678\$" as-path="1234,5678" Supported Operators Operator Description Example Example Explained Example Matches ^ Represents the beginning of the path ^1234 will match AS-path starting with ASN 1234 $ Represents the end of the path 1234$ will match AS-path of origin ASN 1234 * Zero or more occurrences of the listed ASN ^1234*$ will match Null as-path or as-path where ASN 1234 may or may not appear multiple timesMatch: 1234 1234 1234 1234 Null path No Match: 1234 5678 + One or more occurrences of the listed ASN 1234+ will match AS-path where ASN 1234 appears at least once Match: 1234 3 1234 6 No match: 12345 678 ? Zero or one occurrence of the listed ASN ^1234? 5678will match AS-path that may or may not start with ASN 1234 appearing once.Match : 5678 1234 5678 No match: 1234 1234 5678 12345 5678 . One occurrence of any ASN ^.$ will match any AS-path with the length of one. Match: 12345 45678 No match: 1234 5678

| Match one of two ASNs on each side ^ (1234|5678) will match AS-path starting with ASN 1234 or 5678 Match : 1234 5678 1234 5678 No Match: 91011 [ ] [^ ]Represents the set of AS numbers where one AS number from the list must match. Use ^ after opening the bracket to negate the set. It is also possible to reference the pre-defined num-lists from n with [[:numset_name:]] um-list^[1234 5678 1-100]will match the AS-path that starts with 1234 or 5678 or from the range of 1 to 100Match: 1234 99 5678 No Match: 101 () Group of regexp terms to match ^ (1234$|567 8)will match AS-path that starts and ends with 1234 or AS- path that starts with 5678Match: 1234 5678 9999 No Match: 1234 5678 Community and Num Lists A list of commonly used numbers can be configured from the menu. These lists of numbers can be used in the filter rules /routing/filter/num-list to simplify the filter setup process. In a similar manner, you are allowed to define also community, extended community, and large community lists. Community sets can be used for matching, appending, and setting. For example match communities from the list and clear the attribute: /routing/filter/community-list add communities=111:222 list=myCommunityList /routing/filter/rule add chain=myChain rule="if (bgp-communities equal-list myCommunityList) {delete bgp-communities wk,other; accept;}" /routing/filter/community-list Property Description comment ( ; Default: ) string Repetition ranges {} are not supported.

communities ( ; list of communities Default: ) List of communities expressed either as name or in the following format: " , where each well-known as:number" section can be integer [0..65535]. Accepted well known names: accept-own graceful-shutdown no-advertise no-llgr route-filter-6 accept-own-nh internet no-export no-peer route-filter-xlate-4 blackhole llgr-stale local-as route-filter-4 route-filter-xlate-6 disabled (yes ) | no name ( ; Default: ) integer [string Reference name. regexp (string) Regexp matcher to match communities. The community set with only the regexp parameter cannot be used to append communities. /routing/filter/community-ext-list Property Description comment ( ; Default: ) string communities ( ; list of ext communities Default: ) List of extended communities expressed as integer value or in the typed format: " ", where raw type:value type can be: rt - route-target soo - site of origin Value depends on the type, for more info on RT and SoO values ask google. disabled (yes ) | no name ( ; Default: ) integer [string Reference name. regexp (string) Regexp matcher to match communities. The community set with only the regexp parameter cannot be used to append communities. /routing/filter/community-large-list Property Description comment ( ; Default: ) string communities ( ; list of large communities Default: ) List of large communities expressed in following format: " ", where each section can be admin:value1:value2 integer [0..4294967295]. disabled (yes ) | no name ( ; Default: ) integer [string Reference name. regexp (string) Regexp matcher to match communities. The community set with only the regexp parameter cannot be used to append communities. Route Selection Route selection rules allow controlling how output routes are selected from available candidate routes. By default, (if no selection rules are set) output always picks the best route. For example, if we look at the routing table below, we can see that there are 2 candidate routes and one best route. By default when BGP selects which route to send out, it will pick the active route.

[admin@4] /routing/route> print where dst-address=1.0.0.0/24 Flags: A - ACTIVE; b, y - COPY Columns: DST-ADDRESS, GATEWAY, AFI, DISTANCE, SCOPE, TARGET-SCOPE, IMMEDIATE-GW DST-ADDRESS GATEWAY AFI DISTANCE SCOPE TARGET-SCOPE IMMEDIATE-GW b 1.0.0.0/24 10.155.101.217 ip4 19 40 30 10.155.109.254%ether1 Ab 1.0.0.0/24 10.155.101.232 ip4 20 40 30 10.155.109.254%ether1 b 1.0.0.0/24 10.155.101.231 ip4 20 40 30 10.155.109.254%ether1 But there might be cases where you would want preference for other routes, not the active ones, and here come in-play selection rules. Selection rules in RouterOS are configured from menu. /routing/filter/select-rule Select rules can also call routing filters where routes get selected based on filter rules. For example, to mimic default output selection we can set up the following rule sets: /routing filter rule add chain=get_active rule="if (active) {accept}" /routing filter select-rule add chain=my_select_chain do-where=get_active Property Reference /routing/filter/chain Dynamic list of filter rule chains that can be referenced in BGP/OSPF configuration. Read-only properties: Property Description dynamic ( ) yes | no inactive (yes ) | no name ( ) string /routing/filter/select-chain Dynamic list of filter select chains that can be referenced in BGP/OSPF configuration. Read-only properties: Property Description dynamic ( ) yes | no inactive (yes ) | no name ( ) string

Multicast In This Section:

Group Management Protocol Introduction Configuration options Examples Introduction The Group Management Protocol allows any of the interfaces to become a receiver for the multicast stream. It allows testing the multicast routing and switching setups without using dedicated IGMP or MLD clients. The option is available since RouterOS v7.4 and it supports IGMP v1, v2, v3 and MLD v1, v2 protocols. Interfaces are using IGMP v3 and MLD v2 by default. In case IGMP v1, v2 or MLD v1 queries are received, the interfaces will fall back to the appropriate version. Once Group Management Protocol is created on the interface, it will send an unsolicited membership report (join) packet and respond to query messages. If the configuration is removed or disabled, the interface will send a leave message. Configuration options This section describes the Group Management Protocol configuration options. Sub-menu: /routing gmp Property Description groups (IPv4 | IPv6 ; Default: )The multicast group address to be used by the interface, multiple group addresses are supported. interfaces ( ; name Default: ) Name of the interface, multiple interfaces and interface lists are supported. exclude (Default: ) When is set, the interface expects to reject multicast data from the configured . When this option is not used, exclude sources the interfaces will emit source specific join for the configured . sources sources (IPv4 | ; Default: )IPv6The source address list used by the interface, multiple source addresses are supported. This setting has an effect when IGMPv3 or MLDv2 protocols are active. Examples This example shows how to configure a simple multicast listener on the interface. First, add an IP address on the interface: /ip address add address=192.168.10.10/24 interface=ether1 network=192.168.10.0 Then configure Group Management Protocol on the same interface: /routing gmp add groups=229.1.1.1 interfaces=ether1 It is now possible to check your multicast network to see if routers or switches have created the appropriate multicast forwarding entries and whether multicast data is being received on the interface (see the interface stats, or use a and ). Packet Sniffer Torch

IGMP Proxy Summary Configuration options Examples Summary Internet Group Management Protocol (IGMP) proxy can implement multicast routing. It is forwarding IGMP frames and is commonly used when there is no need for a more advanced protocol like PIM. IGMP proxy features: The simplest way how to do multicast routing; Can be used in topologies where PIM-SM is not suitable for some reason; It takes slightly less resources than PIM-SM; Ease of configuration. On the other hand, IGMP proxy is not well suited for complicated multicast routing setups. Compared to PIM-based solutions, IGMP proxy does not support more than one upstream interface and routing loops are not detected or avoided. By default, IGMP proxy upstream interface will send IGMPv3 membership reports and it will detect what IGMP version the upstream device (e.g. multicast router) is using based on received queries. In case IGMPv1/v2 queries are received, the upstream port will fall back to the lower IGMP version. It will convert back to IGMPv3 when IGMPv1/v2 querier present timer (400s) expires. Downstream interfaces of IGMP proxy will only send IGMPv2 queries. Configuration options General IGMP proxy configuration. Sub-menu: /routing igmp-proxy Property Description query-interval (time: 1s ; Default: ) ..1h 2m5sHow often to send out IGMP Query messages over downstream interfaces. query-response- interval ( ; time: 1s..1h Default: )10sHow long to wait for responses to an IGMP Query message. quick-leave Specifies action on IGMP Leave message. If quick-leave is on, then an IGMP Leave message is sent upstream as soon as a leave message is received from the first client on the downstream interface. Use yesonly in case there is only one subscriber behind the proxy. Configure what interfaces will participate as IGMP proxy interfaces on the router. If an interface is not configured as an IGMP proxy interface, then all IGMP traffic received on it will be ignored. Sub-menu: /routing igmp-proxy interface Property Description alternative- subnets (IP/Mask ; ) Default: By default, only packets from directly attached subnets are accepted. This parameter can be used to specify a list of alternative valid packet source subnets, both for data or IGMP packets. Has an effect only on the upstream interface. Should be used when the source of multicast data often is in a different IP network. RouterOS v7 has IGMP proxy configuration available in the main package. Older RouterOS versions need an additional system multicast package installed in order to use IGMP proxy. See more details about . Packages

PIM-SM Summary Basic multicast routing on single device Multicast routing with static RP Property Reference Instance Interface template Interface Neighbor Static RP Upstream Information Base Summary IP Multicast is a technology that allows data to be efficiently shared with many recipients over the Internet. Senders transmit their data to a specific multicast IP address, and receivers indicate their interest in receiving data sent to that address. The network then takes care of delivering the data from senders to receivers. If both the sender and receiver for a multicast group are on the same local network segment, routers are not required for the process. Communication can happen directly, and this can be enhanced with the use of switches. However, if the sender and receiver are on different network IGMP snooping segments, a multicast routing protocol must be used to establish the path for data transmission between them. Protocol Independent Multicast - Sparse Mode (PIM-SM or PIM) enables RouterOS to support multicast streaming over the network area. PIM stands for Platform Independent Multicast, meaning it's not tied to any particular unicast routing. SM stands for Sparse-Mode, which means that specific control messages ensure that data is delivered only to network segments where there are receivers that want it. In addition to the routing protocols that manage data transmission between network segments, routers need a way to discover local receivers on their directly connected network segment. For IPv4, this is achieved through the Internet Group Management Protocol (IGMP), and Multicast Listener Discovery (MLD) for IPv6. Basic multicast routing on single device Picture this scenario, you have got a router with two interfaces, namely ether1 and ether2, and each of them is set up in separate networks. Normally, the router will create connected routes and hosts on both networks will be able to communicate using unicast traffic. However, if you want to enable multicast communication between these networks, you'll need to configure multicast routing separately because it won't work otherwise. In this scenario, we are going to create a simple configuration. This involves creating a PIM instance and configuring the required interfaces. RouterOS v7 has PIM-SM configuration available in the main package. Older RouterOS versions need an additional package system multicast installed in order to use PIM-SM. See more details about . Packages The feature is not supported on SMIPS devices (hAP lite, hAP lite TC and hAP mini).

Begin by ensuring that IP addresses are set up on the router's interfaces. /ip address add address=192.168.10.1/24 interface=ether1 network=192.168.10.0 add address=192.168.20.1/24 interface=ether2 network=192.168.20.0 Configure PIM instance. For this example, the default settings should work fine. /routing pimsm instance add name=pimsm-instance-1 Last, add interfaces and specify the PIM instance you created earlier. /routing pimsm interface-template add interfaces=ether1,ether2 instance=pimsm-instance-1 Now router starts listening to IGMP membership reports (client join messages) and will route multicast traffic to clients interested in receiving it. To test the configuration, you can configure a multicast sender using RouterOS and IGMP client using . traffic-generator GMP # Multicast Sender /ip address add address=192.168.10.10/24 interface=ether1 network=192.168.10.0 /tool traffic-generator packet-template add interface=ether1 ip-dst=229.1.1.2 mac-dst=01:00:5E:01:01:02/FF:FF:FF:FF:FF:FF name=multicast /tool traffic-generator quick tx-template=multicast mbps=10 # Multicast Client /ip address add address=192.168.20.10/24 interface=ether1 network=192.168.20.0 /routing gmp add disabled=no groups=229.1.1.2 interfaces=ether1 To verify whether multicast traffic is being properly routed, monitor the received packet counters on the client interface or use tools like or a Torch Packet . Sniffer It is also possible to monitor active multicast group on router:

/routing pimsm uib-g print Columns: INSTANCE, GROUP # INSTANCE GROUP 0 pimsm-instance-1 229.1.1.2 /routing pimsm uib-sg print Flags: K - KEEPALIVE; S - SPT-BIT Columns: INSTANCE, GROUP, SOURCE # INSTANCE GROUP SOURCE 0 KS pimsm-instance-1 229.1.1.2 192.168.10.10 Multicast routing with static RP In the upcoming example, we'll be working with multiple PIM routers, as shown in the diagram below. PIM-SM uses shared trees and to make this work, we need to designate a specific node as the multicast root distribution point. In PIM, this router is called the Rendezvous Point, or RP. There are various methods for selecting an RP in PIM, such as the Bootstrap Router (BSR) method. However, for this example, we'll be using a straightforward approach known as static RP configuration. This means that the administrator can manually specify one or more RPs for specific multicast groups. To get started, we'll need to configure IP addresses and set up unicast routing. In this example, we'll use OSPF to exchange routing information between the routers. See more details about . OSFP

rp-static-override ( ; yes | no Default: ) noChanges the selection priority for static RP. When disabled, the bootstrap RP set has a higher priority. When enabled, static RP has a higher priority. ssm-range (IPv4 | IPv6 ; Default: ) Currently not implemented. switch-to-spt ( ; Default: yes | no y )esWhether to switch to Shortest Path Tree (SPT) if multicast data bandwidth threshold is reached. The router will not proceed from protocol phase one (register encapsulation) to native multicast traffic flow if this option is disabled. It is recommended to enable this option. switch-to-spt-bytes (integer: 0.. ) 4294967295 ; Default: 0Multicast data bandwidth threshold. Switching to Shortest Path Tree (SPT) happens if this threshold is reached in the specified time interval. If a value of 0 is configured, switching will happen immediately. switch-to-spt-interval (time; Default: )Time interval in which to account for multicast data bandwidth, used in conjunction with to switch-to-spt-bytes determine if the switching threshold is reached. vrf (name ; Default: main) Name of the VRF. Interface template The interface template menu defines which interfaces will participate in PIM and what per-interface configuration will be used. Sub-menu: /routing pimsm interface-template Property Description hello-delay ( ; time Default: ) 5sRandomized interval for the initial Hello message on interface startup or detecting new neighbor. hello-period ( ; time Default: 30s )Periodic interval for Hello messages. instance (n ; ame Default: ) Name of the PIM instance this interface template belongs to. interfaces ( ; name Default: ) allList of interfaces that will participate in PIM. join-prune- period (time ; Default: 1m ) join- tracking- support (ye ; s | no Default: ) yesSets the value of a Tracking (T) bit in the LAN Prune Delay option in the Hello message. When enabled, a router advertises its willingness to disable Join suppression. it is possible for upstream routers to explicitly track the join membership of individual downstream routers if Join suppression is disabled. Unless all PIM routers on a link negotiate this capability, explicit tracking and the disabling of the Join suppression mechanism are not possible. override- interval (time ; Default: 2 ) s500msSets the maximum time period over which to randomize when scheduling a delayed override Join message on a network that has join suppression enabled. priority (inte ger: 0.. 4294967295 ) ; Default: 1The Designated Router (DR) priority. A single Designated Router is elected on each network. The p riority is used only if all neighbors have advertised a priority option. Numerically largest priority is preferred. In case of a tie or if priority is not used - the numerically largest IP address is preferred.

propagation -delay (time ; Default: 5 ) 00msSets the value for a prune pending timer. It is used by upstream routers to figure out how long they should wait for a Join override message before pruning an interface that has join suppression enabled. source- addresses ( IPv4 | IPv6 ; Default: ) Interface The interface menu shows all interfaces that are currently participating in PIM and their statuses. This menu contains dynamic and read-only entries that get created by defined interface templates. Sub-menu: /routing pimsm interface Property Description address ( ) IP%interface@vrf Shows IP address, interface, and VRF. designated-router ( ) yes | no dr ( ) yes | no dynamic ( ) yes | no instance ( ) name Name of the PIM instance this interface template belongs to. join-tracking ( ) yes | no override-interval ( )time priority ( ) integer: 0..4294967295 propagation-delay ( )time Neighbor The neighbor menu shows all detected neighbors that are running PIM and their statuses. This menu contains dynamic and read-only entries. Sub-menu: /routing pimsm neighbor Property Description address ( ) IP%interface Shows the neighbor's IP address and local interface the neighbor is detected on. designated-router (yes )| noShows whether the neighbor is elected as Designated Router (DR). instance ( ) name Name of the PIM instance this neighbor is detected on. join-tracking ( ) yes | no Indicates the neighbor's value of a Tracking (T) bit in the LAN Prune Delay option in the Hello message. override-interval ( )time Indicates the neighbor's value of the override interval in the LAN Prune Delay option in the Hello message. priority (integer: 0.. ) 4294967295Indicates the neighbor's priority value. propagation-delay ( )time Indicates the neighbor's value of the propagation delay in the LAN Prune Delay option in the Hello message. timeout (time) Shows the reminding time after the neighbor is removed from the list if no new Hello message is received. The hold time equals to neighbor's * 3.5. hello-period Static RP

The static-rp menu allows manually defining the multicast group to RP mappings. Such a mechanism is not robust to failures but does at least provide a basic interoperability mechanism. Sub-menu: /routing pimsm static-rp Property Description address ( ) IPv4 | IPv6 ; Default: The IP address of the static RP. group ( ) IPv4 | IPv6 ; Default: 224.0.0.0/4 The multicast group that belongs to a specific RP. instance ( ; Default: ) name Name of the PIM instance this static RP belongs to. Upstream Information Base The upstream information base menus show the any-source multicast (*,G) and source-specific multicast (S,G) groups and their statuses. These menus contain only read-only entries. Sub-menu: /routing pimsm uib-g Property Description group ( ) IPv4 | IPv6 The multicast group address. instance ( ) name Name of the PIM instance the multicast group is created on. rp ( ) IPv4 | IPv6 The address of the Rendezvous Point for this group. rp-local ( ) yes | no Indicates whether the multicast router itself is RP. rpf ( ) IP%interface The Reverse Path Forwarding (RPF) indicates the router address and outgoing interface that a Join message for that group is directed to. Sub-menu: /routing pimsm uib-sg Property Description group (IPv ) 4 | IPv6The multicast group address. instance ( ) nameName of the PIM instance the multicast group is created on. keepalive ( ) yes | no register (jo in | join- pending | ) prune rpf (IP% ) interfaceThe Reverse Path Forwarding (RPF) indicates the router address and outgoing interface that a Join message for that group is directed to. source (IP ) v4 | IPv6The source IP address of the multicast group. spt-bit (ye ) s | noThe Shortest Path Tree (SPT) bit indicates whether forwarding is taking place on the (S,G) Shortest Path Tree or on the (*,G) tree. A router can have an (S,G) state and still be forwarding on a (*,G) state during the interval when the source-specific tree is being constructed. When SPT bit is false, only the (*,G) forwarding state is used to forward packets from S to G. When SPT bit is true, both (*,G) and (S,G) forwarding states are used.

Routing Debugging Tools Routing stats. /routing/stats/origin /routing/stats/process This menu allows to monitor debugging information of all the routing processes. [admin@rack1_b35_CCR1036] /routing/stats/process> print interval=1 Columns: TASKS, PRIVATE-MEM-BLOCKS, SHARED-MEM-BLOCKS, PSS, RSS, VMS, RETIRED, ID, PID, RPID, PROCESS-TIME, KERNEL-TIME, CUR-BUSY, MAX-BUSY, CUR-CALC, MAX-CALC # TASKS PRIVATE- SHARED-ME PSS RSS VMS RETIRED ID PID RPID PROCESS KERNEL-TIME CUR-BUSY MAX-BUSY CUR-CALC MAX-CALC 0 routing tables 768.0KiB 1792.0KiB 2399.0KiB 6.4MiB 22.1MiB 34 main 317 0 2s260ms 1s940ms 10ms 170ms 20ms 1s210ms rib 1 fib 0 0 2263.0KiB 6.2MiB 22.3MiB fib 351 1 250ms 1s720ms 1s210ms 1s210ms 2 ospf 256.0KiB 256.0KiB 2559.0KiB 6.6MiB 22.3MiB ospf 384 1 4s710ms 5s210ms 20ms 20ms 3 pimsm 256.0KiB 0 2252.0KiB 5.8MiB 22.3MiB pim 386 1 200ms 450ms 10ms 10ms 4 fantasy 0 0 2031.0KiB 5.1MiB 22.3MiB fantasy 388 1 270ms 390ms 10ms 10ms 5 configuration and reporting 0 512.0KiB 2351.0KiB 6.4MiB 22.3MiB static 389 1 310ms 430ms 10ms 10ms 6 ldp 256.0KiB 256.0KiB 2455.0KiB 6.4MiB 22.3MiB mpls 387 1 340ms 350ms 40ms 40ms Copy 7 rip 256.0KiB 0 2230.0KiB 5.7MiB 22.3MiB rip 377 1 230ms 380ms 10ms 10ms 8 routing policy configuration 512.0KiB 512.0KiB 2355.0KiB 5.6MiB 22.3MiB policy 358 1 240ms 390ms 10ms 10ms 9 BGP service 512.0KiB 0 2592.0KiB 6.3MiB 22.3MiB bgp 364 1 360ms 600ms 10ms 10ms 10 BFD service 256.0KiB 0 2206.0KiB 5.7MiB 22.3MiB 12 371 1 230ms 370ms 10ms 10ms 11 BGP Input 111.11.0.1 512.0KiB 512.0KiB 2560.0KiB 6.4MiB 22.3MiB 1 22 679 1 140ms 350ms 10ms 10ms BGP Output 111.11.0.1 12 Global memory 256.0KiB global 0 0 /routing/stats/step

/routing/fantasy Fantasy menu is a fancy way to generate large amount of routes for testing purposes. Main benefits of this approach compared to script is the generation speed and simplicity. It is easy to remove all fantasy generated routes just by disabling fantasy rule. Fantasy uses random generator from hashed route sequence number, seed and other parameters. Configuration Options Property Description comment ( ) string count ( ) integer:[0..4294967295] How many routes to generate. dealer-id (start-[end]:: integer: ) [0..4294967295] disabled ( ) yes | no ID reference is not used. dst-address ( ) Prefix Prefix from which route will be generated. gateway (string) instance-id (start-[end]:: integer: ) [0..4294967295] name ( ) string Reference name offset ( ) integer:[0..4294967295] Route sequence number offset prefix-length (start-[end]:: intege ) r:[0..4294967295] Prefix length for generated route (can be specified as integer range). For example dst-address 192.168.0.0/16 and prefix-length 24 will generate /24 routes from 192.168.0.0/16 subnet. priv-offset (start-[end]:: integer: ) [0..4294967295] priv-size (start-[end]:: integer: ) [0..100000] scope (start-[end]:: integer: [0.. )255]Scope to be set, can be set as range seed ( ) string Random generator seed target-scope (start-[end]:: intege ) r: [0..255]Target scope to be set, can be set as range use-hold ( ) yes | no

.large- communities (stri )ngvalue of the LARGE_COMMUNITIES BGP attribute .local-pref ( ) string value of the LOCAL_PREF BGP attribute .med ( ) string value of the MED BGP attribute .nexthop ( ) string .origin ( ) string .originator-id (stri )ng .out-nexthop (stri )ng .peer-cache-id (s )tringThe ID of the session that installed the route. See menu. BGP /routing/bgp/session .unknown ( ) string hex blob of unknown attributes BGP .weight ( ) string blackhole ( ) yes | no A flag indicates whether it is a blackhole route check-gateway (ping ) | arp | bfdCurrently used check-gateway option. comment ( ) string connect ( ) yes | no A flag indicates whether it is a connected network route. contribution ( ) string Shows the route status contributing to the election process, e.g "filtered, active, candidate" copy ( ) yes | no A flag indicates a copy of the route to be redistributed as the L3VPN route. VPNv4/6 related attributes are attached to this "copy" route. create-time ( ) string debug - a group of debugging parameters dhcp ( ) yes | no A flag indicates whether the route was added by the DHCP service. disabled ( ) yes | no A flag indicates whether the route is disabled. distance ( ) integer dst-address ( ) prefix Route destination. ecmp ( ) yes | no A flag indicates whether the route is added as an Equal-Cost Multi-Path route in the FIB. Read more>> filtered ( ) yes | no A flag indicates whether the route was filtered by routing filters and excluded from being used as the best route. gateway ( ) string Configured gateway, for the actually resolved gateway, see parameter. immediate-gw hw-offloaded (yes | )noIndicates whether the route is eligible to be hardware offloaded on supported hardware. immediate-gw ( ) string Shows actual (resolved) gateway and interface that will be used for packet forwarding. Displayed in format [ip% . interface] label ( ) integer ldp-address ( ) yes | no A flag indicates whether the route entry is an LDP address. ldp-mapping ( ) yes | no A flag indicates whether the route entry is the LDP mapping

ldp - a group of parameters associated with the LDP protocol .label ( ) integer LDP mapped MPLS label. .peer-id () local-address ()IP Local IP address of the connected network. modem ( ) yes | no A flag indicates whether the route is added by the LTE or 3g modems. mpls - group of generic parameters associated with the MPLS .in-label () Mapped MPLS ingress label .labels () .out-label () Mapped MPLS egress label nexthop-id () ospf ( ) yes | no A flag indicates whether the route was added by the routing protocol. OSPF ospf - group of parameters associated with the OSPF protocol .metric ( ) integer .type ( ) string pref-src () received-from () rip ( ) yes | no A flag indicates whether the route was added by the RIP routing protocol rip - group of parameters associated with the RIP protocol .metric () .route-tag () route-cost () routing-table () Routing table this route belongs to. rpki (valid | invalid | unknown)Current status of the prefix from the validation process. RPKI scope ( ) integer Scope used in the next-hop lookup process. Read more>> static ( ) yes | no A flag indicates statically added routes. target-scope ( ) integer Target scope used in next-hop lookup process. Read more>> te-tunnel-id () Traffic Engineering tunnel ID total-cost () unreachable ( ) yes | no A flag indicates whether the route next-hop is unreachable. update-time () ve-block-offset ve-block-size ve-id vpn ( ) yes | no A flag indicates whether the route was added by one of the VPN protocols (PPPoE, L2TP, SSTP, etc.) vrf-interface () Internal use only parameter which allows identifying to which VRF route should be added. Used by services that add routes dynamically, for example, DHCP client. Shown for debugging purposes.

Routing Reference

/routing/id Global Router ID election configuration. ID can be configured explicitly or set to be elected from one of the Routers IP addresses. For each VRF table RouterOS adds dynamic ID instance, that elects the ID from one of the IP addresses belonging to a particular VRF: [admin@rack1_b33_CCR1036] /routing/id> print Flags: D - DYNAMIC, I - INACTIVE Columns: NAME, DYNAMIC-ID, SELECT-DYNAMIC-ID, SELECT-FROM-VRF # NAME DYNAMIC-ID SELECT-D SELE 0 D main 111.111.111.2 only-vrf main Configuration Options Property Description comment ( ) string disabled ( ) yes | no ID reference is not used. id()IP Parameter to explicitly set the Router ID. If ID is not explicitly specified, then it can be elected from one of the configured IP addresses on the router. See parameters and . select-dynamic-id select-from-vrf name ( ) string Reference name select-dynamic-id (any | lowest | only- active | only-loopback | only-static | only- )vrfStates what IP addresses to use for the ID election: any - any address found on the router can be elected as the Router ID. lowest - pick the lowest IP address. only-active - pick an ID only from active IP addresses. only-loopback - pick an ID only from loopback addresses (loopback address is considered any non point to point /32 address). only-vrf - pick an ID only from selected VRF. Works with property. select-from-vrf select-from-vrf ( ) name VRF from which to select IP addresses for the ID election. Read-only Properties Property Description dynamic ( ) yes | no dynamic-id ()IP Currently selected ID. inactive ( ) yes | no If there was a problem to get a valid ID, then item can become inactive.

BFD Summary Bidirectional Forwarding Detection (BFD) is a low-overhead and short-duration protocol intended to detect faults in the bidirectional path between two forwarding engines, including physical interfaces, sub-interfaces, data link(s), and to the extent possible the forwarding engines themselves, with potentially very low latency. It operates independently of media, data protocols, and routing protocols. BFD is basically a hello protocol for checking bidirectional neighbor reachability. It provides sub-second link failure detection support. BFD is not routing protocol specific, unlike protocol hello timers or such. BFD Control packets are transmitted in UDP packets with destination port 3784, BFD also uses port 4784 for multihop paths. The source port is in the range 49152 through 65535. And BFD Echo packets are encapsulated in UDP packets with destination port 3785. Standards and Technologies: RFC 5880 Bidirectional Forwarding Detection (BFD) RFC 5881 BFD for IPv4 and IPv6 RFC 5882 Generic Application of BFD RFC 5883 Bidirectional Forwarding Detection (BFD) for Multihop Paths Features not yet supported echo mode enabling BFD for ip route gateways authentication Configuration Allowing or forbidding BFD sessions can be done from the menu. For example: /routing bfd configuration /routing bfd configuration add interfaces=sfp12 forbid-bfd=yes add interfaces=static Configuration entries are order sensitive, which means that in the example above we are forbidding BFD sessions explicitly on the "sfp12" interface and allowing on the rest of the interfaces belonging to the "static" interface list. To be able to filter multi-hop sessions, or properties can be used to match the destination, as well as the appropriate VRF, if addresses address-list a session is not running in the "main" VRF. /ip firewall address-list add address=10.155.255.183 list=bgp_allow_bfd add address=10.155.255.217 list=bgp_allow_bfd /routing bfd configuration add addresses=111.111.0.0/16 vrf=vrf1 add address-list=bgp_allow_bfd Everything else that is not explicitly listed in the configuration by default is forbidden.

BFD with BGP To enable the use of BFD for BGP sessions, enable for required entries in menu. use-bfd /routing bgp connection A useful feature is that the BGP session will show that the BFD session for that particular BGP session is down: [admin@dr_02_BGP_MUM] /routing/bgp/session> print Flags: E - established 0 E ;;; BFD session down name="ovpn_test1-1" remote.address=111.111.11.11@vrf1 .as=65530 .id=10.155.101.217 .capabilities=mp,rr,as4 .hold-time=infinity .messages=40717 .bytes=3436281 .eor="" local.address=111.111.11.12@vrf1 .as=555 .id=111.111.11.12 .capabilities=mp,rr,gr,as4 .messages=1 .bytes=19 .eor="" output.procid=20 input.procid=20 .filter=bgp-in ebgp hold-time=infinity use-bfd=yes uptime=3s210ms last-started=2023-05-19 09:54:04 prefix-count=3853 BFD with OSPF To enable the use of BFD for OSPF neighbors, enable for required entries in menu. use-bfd /routing ospf interface-template Session Status The status of the currently available sessions can be observed from menu: /routing bfd session [admin@dr_02_BGP_MUM] /routing/bfd/session> print Flags: U - up, I - inactive 0 I ;;; BFD forbidden for destination address multihop=yes remote-address=10.155.101.183 local-address="" desired-tx-interval=0ms required-min-rx=0ms multiplier=0 1 multihop=no remote-address=111.111.11.11%ovpn-out1@vrf1 local-address=111.111.11.12@vrf1 state=down state-changes=0 desired-tx-interval=200ms required-min-rx=200ms remote-min-rx=1us multiplier=5 packets-rx=0 packets-tx=7674 BFD is picking the highest value between the local tx interval and remote minimum rx interval as desired transmit interval. If the session is not established then desired minimum tx interval is set to 1 second.

IS-IS Overview IS-IS Terminology Basic Configuration Example Overview The IS-IS (Intermediate System - Intermediate System) protocol is an Interior Gateway Protocol (IGP) used to distribute IP routing information throughout a single Autonomous System. It was originally developed as a routing protocol for CLNP but later extended to include IP routing when IP became popular. An extended version is sometimes referred to as Integrated IS-IS. IS-IS belongs to the link-state protocol family, which exchanges topology information between nearest neighbors and floods it throughout the AS. The main advantage is that complete knowledge of the network topology allows one to choose the best path to the destination. It can also be useful for traffic engineering purposes. Neighbours periodically exchange packets, forms adjacency and selects designated IS based on the negotiation. Hello packets are sent individually Hello for and . Level-1 Level-2 Standards and Technologies: RFC 1195 Use of OSI IS-IS for Routing in TCP/IP and Dual Environments RFC 5302 Domain-Wide Prefix Distribution with Two-Level IS-IS RFC 5303 Three-Way Handshake for IS-IS Point-to-Point Adjacencies RFC 5305 IS-IS Extensions for Traffic Engineering (only wide metric support) RFC 5308 Routing IPv6 with IS-IS IS-IS Terminology IS - Intermediate System is a router capable of forwarding traffic between distantly located hosts. LSP - Link State PDU contains information on the router's local state (usable interfaces, reachable neighbours, and the cost of the interfaces) - Shortest-path-first algorithmSPF - designated intermediate system. DIS ensures that all routes in the network maintain synchronised database. DIS Separate DISs are elected for L1 and L2 routing. Election of the DIS is based on the highest interface priority. - Controls distribution of routing information within an IS-IS area. L1 routing is based on system ID. Level-1 (L1) routing - Controls distribution of routing information between IS-IS areas. L2 routing is based on area ID. Level-2 (L2) routing - link between IS-IS neighbours. The type of adjacency formed depends on the parameters exchanged in the IS-IS Hello packets. IS-IS Adjacency Each of the the adjacent routers runs the DIS election process to determine whether it is eligible to be an L1 or L2 DIS on the broadcast network. Basic Configuration Example Basic IS-IS setup between three routers. R1:

/routing isis instance add afi=ip areas=49.2222 disabled=no name=isis-instance-1 system-id=90ab.cdef.0001 /routing isis interface-template add instance=isis-instance-1 interfaces=ether1 levels=l1,l2 [] /routing/isis/neighbor> print 0 instance=isis-instance-1 interface=ether1 level-type=l2 snpa=08:00:27:22:B4:A2 srcid="1111.2222.aded" state=up 1 instance=isis-instance-1 interface=ether1 level-type=l2 snpa=D4:CA:6D:78:2F:2E srcid="1111.2222.cded" state=up 2 instance=isis-instance-1 interface=ether1 level-type=l1 snpa=08:00:27:22:B4:A2 srcid="1111.2222.aded" state=up 3 instance=isis-instance-1 interface=ether1 level-type=l1 snpa=D4:CA:6D:78:2F:2E srcid="1111.2222.cded" state=up [] /routing/route> print where is-is Flags: A - ACTIVE; i - IS-IS Columns: DST-ADDRESS, GATEWAY, AFI, DISTANCE, SCOPE, TARGET-SCOPE, IMMEDIATE-GW DST-ADDRESS GATEWAY AFI DISTANCE SCOPE TARGET-SCOPE IMMEDIATE-GW i 0.0.0.0/0 10.155.101.214%ether1 ip4 115 20 10 10.155.101.214%ether1 i 10.155.101.0/24 10.155.101.216%ether1 ip4 115 20 10 10.155.101.216%ether1 Ai 10.255.255.162/32 10.155.101.216%ether1 ip4 115 20 10 10.155.101.216%ether1 R2: /routing isis instance add afi=ip areas=49.2222 disabled=no l1.originate-default=always l2.originate-default=always name=isis-instance- 1 \ system-id=1111.2222.cded /routing isis interface-template add instance=isis-instance-1 interfaces=sfp12 levels=l1,l2 add instance=isis-instance-1 interfaces=lo levels=l2 [] /routing/isis/neighbor> print 0 instance=isis-instance-1 interface=sfp12 level-type=l1 snpa=08:00:27:22:B4:A2 srcid="1111.2222.aded" state=up 1 instance=isis-instance-1 interface=sfp12 level-type=l1 snpa=C4:AD:34:43:EA:5C srcid="90ab.cdef.0001" state=up 2 instance=isis-instance-1 interface=sfp12 level-type=l2 snpa=08:00:27:22:B4:A2 srcid="1111.2222.aded" state=up 3 instance=isis-instance-1 interface=sfp12 level-type=l2 snpa=C4:AD:34:43:EA:5C srcid="90ab.cdef.0001" state=up R3 Cisco:

interface Loopback0 ip address 10.255.255.162 255.255.255.255 ip router isis ! interface GigabitEthernet1 ip address dhcp ip router isis negotiation auto ! router isis net 49.2222.1111.2222.aded.00 ! # show isis neighbors Tag null: System Id Type Interface IP Address State Holdtime Circuit Id 90AB.CDEF.0001 L1 Gi1 10.155.101.183 UP 27 1111.2222.CDED.01 90AB.CDEF.0001 L2 Gi1 10.155.101.183 UP 27 1111.2222.CDED.01 1111.2222.CDED L1 Gi1 10.155.101.214 UP 9 1111.2222.CDED.01 1111.2222.CDED L2 Gi1 10.155.101.214 UP 9 1111.2222.CDED.01 # show ip route i*L1 0.0.0.0/0 [115/11] via 10.155.101.214, 4w5d, GigabitEthernet1 10.0.0.0/8 is variably subnetted, 5 subnets, 2 masks C 10.155.101.0/24 is directly connected, GigabitEthernet1 L 10.155.101.216/32 is directly connected, GigabitEthernet1 i L2 10.155.255.214/32 [115/10] via 10.155.101.183, 2w3d, GigabitEthernet1

Scripting Scripting language manual Line structure Command-line Physical Line Comments Example Line joining Example Whitespace between tokens Scopes Global scope Local scope Keywords Delimiters Data types Constant Escape Sequences Example Operators Arithmetic Operators Relational Operators Logical Operators Bitwise Operators Concatenation Operators Other Operators Variables Reserved variable names Commands Global commands Menu specific commands Common commands import print parameters Loops and conditional statements Loops Conditional statement Functions Catch run-time errors Operations with Arrays Script repository Environment Job See also Videos on Scripting Scripting language manual This manual provides an introduction to RouterOS's built-in powerful scripting language. Scripting host provides a way to automate some router maintenance tasks by means of executing user-defined scripts bounded to some event occurrence. Scripts can be stored in or can be written directly to . The events used to trigger script execution include, but are not the Script repository the console limited to the , the , and the generated events. System Scheduler Traffic Monitoring Tool Netwatch Tool If you are already familiar with scripting in RouterOS, you might want to see our . Tips & Tricks Line structure

The RouterOS script is divided into a number of command lines. Command lines are executed one by one until the end of the script or until a runtime error occurs. Command-line The RouterOS console uses the following command syntax: [prefix] [path] command [uparam] [param=[value]] .. [param=[value]] [prefix] - ":" or "/" character which indicates if a command is or path. It may not be required. ICE [path] - relative path to the desired menu level. It may not be required. command - one of the available at the specified menu level. commands [uparam] - unnamed parameter, must be specified if the command requires it. [params] - a sequence of named parameters followed by respective values The end of the command line is represented by the token or . Sometimes or is not required to end the command line. “;” NEWLINE “;” NEWLINE Single command inside does not require any end-of-command character. The end of the command is determined by the content of the (), [] or {} whole script :if ( true ) do={ :put "lala" } Each command line inside another command line starts and ends with square brackets "[ ]" . (command concatenation) :put [/ip route get [find gateway=1.1.1.1]]; Notice that the code above contains three command lines: :put /ip route get find gateway=1.1.1.1 Command-line can be constructed from more than one physical line by following . line joining rules Physical Line A physical line is a sequence of characters terminated by an end-of-line (EOL) sequence. Any of the standard platform line termination sequences can be used: Unix – ASCII LF; Windows – ASCII CR LF; mac – ASCII CR; Standard C conventions for newline characters can be used ( the \n character). Comments The following rules apply to a comment: A comment starts with a hash character (#) and ends at the end of the physical line. RouterOS does not support multiline comments. If a character appears inside the string it is not considered a comment.# Example # this is a comment # next line comment :global a; # another valid comment :global myStr "part of the string # is not a comment" Line joining

Two or more physical lines may be joined into logical lines using the backslash character (\). The following rules apply to using backslash as a line-joining tool: A line ending in a backslash cannot carry a comment. A backslash does not continue a comment. A backslash does not continue a token except for string literals. A backslash is illegal elsewhere on a line outside a string literal. Example :if ($a = true \ and $b=false) do={ :put "$a $b"; } :if ($a = true \ # bad comment and $b=false) do={ :put "$a $b"; } # comment \ continued - invalid (syntax error) Whitespace between tokens Whitespace can be used to separate tokens. Whitespace is necessary between two tokens only if their concatenation could be interpreted as a different token. Example: { :local a true; :local b false; # whitespace is not required :put (a&&b); # whitespace is required :put (a and b); } Whitespace characters are not allowed between '<parameter>=' between 'from=' 'to=' 'step=' 'in=' 'do=' 'else=' Example: #incorrect: :for i from = 1 to = 2 do = { :put $i } #correct syntax: :for i from=1 to=2 do={ :put $i } :for i from= 1 to= 2 do={ :put $i } #incorrect /ip route add gateway = 3.3.3.3 #correct /ip route add gateway=3.3.3.3 Scopes Variables can be used only in certain regions of the script called scopes. These regions determine the visibility of the variable. There are two types of scopes - global andlocal. A variable declared within a block is accessible only within that block and blocks enclosed by it, and only after the point of declaration. Global scope Global scope or root scope is the default scope of the script. It is created automatically and can not be turned off. Local scope User can define their own groups to block access to certain variables, these scopes are called local scopes. Each local scope is enclosed in curly braces ("{ }").

Type Description num (number) - 64bit signed integer, possible hexadecimal input; bool (boolean) - values can bee or ; true false str (string) - character sequence; ip - IP address; ip-prefix - IP prefix; ip6 - IPv6 address ip6-prefix - IPv6 prefix id (internal ID) - hexadecimal value prefixed by '*' sign. Each menu item has an assigned unique number - internal ID; time - date and time value; array - sequence of values organized in an array; nil - default variable type if no value is assigned; Constant Escape Sequences Following escape sequences can be used to define certain special characters within a string: \" Insert double quote \\ Insert backslash \n Insert newline \r Insert carriage return \t Insert horizontal tab \$ Output $ character. Otherwise, $ is used to link the variable. \? Output ? character. Otherwise ? is used to print "help" in the console. Removed since v7.1rc2 \_ - space \a - BEL (0x07) \b - backspace (0x08) \f - form feed (0xFF) \v Insert vertical tab \xx A print character from hex value. Hex numbers should use capital letters. Example :put "\48\45\4C\4C\4F\r\nThis\r\nis\r\na\r\ntest"; which will show on the display HELLO This is a test Operators Arithmetic Operators

Usual arithmetic operators are supported in the RouterOS scripting language Operator Description Example "+" binary addition :put (3+4); "-" binary subtraction :put (1-6); "*" binary multiplication :put (4*5); "/" binary division :put (10 / 2); :put ((10)/2) "%" modulo operation :put (5 % 3); "-" unary negation { :local a 1; :put (-a); } Note: for the division to work you have to use braces or spaces around the dividend so it is not mistaken as an IP address Relational Operators Operator Description Example "<" less :put (3<4); ">" greater :put (3>4); "=" equal :put (2=2); "<=" less or equal ">=" greater or equal "!=" not equal To negate an expression, you can use "expression=false". To print all interfaces that are not "ethernet", you can use expression negation like this: /interface/print where (name~"ether")=false Or to do the opposite, you can use "expression=true": /interface/print where (name~"ether")=true Logical Operators Operator Description Example “!” logical NOT :put (!true); “&&”, “and” logical AND :put (true&&true) “||”, “or” logical OR :put (true||false); “in” :put (1.1.1.1/32 in 1.0.0.0/8); Bitwise Operators Bitwise operators are working on number, IP, and IPv6 address . data types Operator Description Example “~” bit inversion :put (~0.0.0.0) :put (~::ffff)

“|” bitwise OR. Performs logical OR operation on each pair of corresponding bits. In each pair the result is “1” if one of the bits or both bits is “1”, otherwise the result is “0”.:put (192.168.88.0|0. 0.0.255) :put (2001::1|::ffff) “^” bitwise XOR. The same as OR, but the result in each position is “1” if two bits are not equal, and “0” if the bits are equal.:put (1.1.1.1^255. 255.0.0) :put (2001::ffff:1^:: ffff:0) “&” bitwise AND. In each pair, the result is “1” if the first and second bit is “1”. Otherwise, the result is “0”. :put (192.168.88.77 &255.255.255.0) :put (2001:: 1111&ffff::) “<<” left shift by a given amount of bits, not supported for IPv6 address data type :put (192.168.88.77 <<8) “>>” right shift by a given amount of bits, not supported for IPv6 address data type :put (192.168.88.77 >>24) Calculate the subnet address from the given IP and CIDR Netmask using the "&" operator: { :local IP 192.168.88.77; :local CIDRnetmask 255.255.255.0; :put ($IP&$CIDRnetmask); } Get the last 8 bits from the given IP addresses: :put (192.168.88.77&0.0.0.255); Use the "|" operator and inverted CIDR mask to calculate the broadcast address: { :local IP 192.168.88.77; :local Network 192.168.88.0; :local CIDRnetmask 255.255.255.0; :local InvertedCIDR (~$CIDRnetmask); :put ($Network|$InvertedCIDR) } Concatenation Operators Operator Description Example "." concatenates two strings :put ("concatenate" . " " . "string"); "," concatenates two arrays or adds an element to the array :put ({1;2;3} , 5 ); It is possible to add variable values to strings without a concatenation operator: :global myVar "world"; :put ("Hello " . $myVar); # next line does the same as above :put "Hello $myVar"; By using $[] and $() in the string it is possible to add expressions inside strings:

:local a 5; :local b 6; :put " 5x6 = $($a * $b)"; :put " We have $[ :len [/ip route find] ] routes"; Other Operators Operator Description Example “[]” command substitution. Can contain only a single command line :put [ :len "my test string"; ]; “()” subexpression or grouping operator :put ( "value is " . (4+5)); “$” substitution operator :global a 5; :put $a; “~” the binary operator that matches value against POSIX extended regular expressionPrint all routes whose gateway ends with 202: /ip route print where gateway~"^[0-9 \\.] *202\$" “->” Get an array element by key [admin@x86] >:global aaa {a=1;b=2} [admin@x86] > :put ($aaa->"a") 1 [admin@x86] > :put ($aaa->"b") 2 Variables The scripting language has two types of variables: global - accessible from all scripts created by the current user, defined by keyword; global local - accessible only within the current , defined by keyword. scope local There can be variables. When a variable is undefined, the parser will try to look for variables set, for example, by lease-script or o undefined DHCP Hotspot n-login Every variable, except for built-in RouterOS variables, must be declared before usage by local or global keywords. Undefined variables will be marked as undefined and will result in a compilation error. Example: # following code will result in compilation error, because myVar is used without declaration :set myVar "my value"; :put $myVar Correct code: :local myVar; :set myVar "my value"; :put $myVar; The exception is when using variables set, for example, by DHCP lease-script /system script add name=myLeaseScript policy=\ ftp,reboot,read,write,policy,test,winbox,password,sniff,sensitive,api \ source=":log info \$leaseActIP\r\ \n:log info \$leaseActMAC\r\ \n:log info \$leaseServerName\r\ \n:log info \$leaseBound" /ip dhcp-server set myServer lease-script=myLeaseScript

Valid characters in variable names are letters and digits. If the variable name contains any other character, then the variable name should be put in double quotes. Example: #valid variable name :local myVar; #invalid variable name :local my-var; #valid because double quoted :global "my-var"; If a variable is initially defined without value then is set to , otherwise, a data type is determined automatically by the scripting the variable data type nil engine. Sometimes conversion from one data type to another is required. It can be achieved using . Example: data conversion commands #convert string to array :local myStr "1,2,3,4,5"; :put [:typeof $myStr]; :local myArr [:toarray $myStr]; :put [:typeof $myArr] Variable names are case-sensitive. :local myVar "hello" # following line will generate error, because variable myVAr is not defined :put $myVAr # correct code :put $myVar Set command without value will un-define the variable (remove from environment, new in v6.2) #remove variable from environment :global myVar "myValue" :set myVar; Use quotes on the full variable name when the name of the variable contains operators. Example: :local "my-Var"; :set "my-Var" "my value"; :put $"my-Var"; Reserved variable names All built-in RouterOS properties are reserved variables. Variables that will be defined the same as the RouterOS built-in properties can cause errors. To avoid such errors, use custom designations. For example, the following script will not work: { :local type "ether1"; /interface print where name=$type; } But will work with different defined variables: { :local customname "ether1"; /interface print where name=$customname; }

serialize :serialize [<value to=>] [arg]Serialize specified value/array to JSON or dsv (delimeter separated values) format. to specifies the format - json, dsv delimeter sets the "separator". order specifies the order for variables. options specifies additional options : json.pretty - makes the JSON output more visually appealing ; json.no-string-conversion - prevents implict conversions from console string type to json number type; dsv.wrap-strings - wraps string values inside quatation marks; dsv.ignore-size - if array values have different sizes, e. g. , this option will a=(1,2);b=(3,4);c=(5,6,7) work around error and set array size mismatch "empty" values in those slots. dsv.remap - merges array of dictionaries into a single dictionary (useful when working with " print as-value "):put [:serialize value=a,b,c to=json] ["a","b","c"] :local test {a=(1,2,3);b=(4,5,6);c= (7,"text",9)}; :put [ :serialize to=dsv delimiter=";" value=$test order=("c","a","b") ] c;a;b 7;1;4 text;2;5 9;3;6 :global var ({ "string"="1234"; "number"=1234 });:put [ :serialize to=json value=$var ] {"number":1234,"string":1234.000000} :put [ :serialize to=json value=$var options=json.no-string-conversion ] {"number":1234,"string":"1234"} :put [:serialize to=dsv options=dsv. remap delimiter="#" [/ip/address /print as-value]] .id#address#comment#interface#network *1#192.168.88.1 /24#defconf#bridge#192.168.88.0 *2#192.168.69.190/24##ether1#192. 168.69.0 deserialize :deserialize [<val from=ue>] [arg]Deserialize specified value/array from JSON or dsv (delimeter separated values) format. from specifies the format - json, dsv delimeter sets the "separator". options specifies additional options : dsv.plain - deserializes every line as an array (input does not have a header or column names); dsv.array - expects a header (column names) and will return an array of dictionaries, where values are mapped to column names provided in the header. json.no-string-conversion - prevents implicit conversions from json string type to console values (number, ip, etc.).:put [:deserialize from=json value=" [\"a\",\"b\",\"c\"]"] a;b;c :put ([ :deserialize from=dsv delimiter=";" value="a;b;c\n1;findme; 3" options=dsv.plain ]->1->1) findme :put ([ :deserialize from=dsv delimiter=";" value="a;b;c\n1;findme; 3" options=dsv.plain ]->0->1) b :put ([:deserialize from=dsv "a;b; c\n1;2;3\n4;5;6" delimiter=";" options=dsv.array]->1->"b") 5 :put ([:deserialize from=dsv "a;b; c\n1;2;3\n4;5;6" delimiter=";" options=dsv.array]->0->"c") 3 :put [typeof ([:deserialize "{ \" str\": \"123\" }" from=json options=json.no-string-conversion]->" str")] str time :time <expression> return interval of time needed to execute the command :put [:time {:for i from=1 to=10 do={ : delay 100ms }}];

The import command is available from the root menu and is used to import configuration from files created by command or written manually by an export hand. Starting from 7.16.x version, its possible to catch syntax errors: [admin@admin] > do { import test.rsc } on-error={ :put "Failure" } Failure New parameter can be used: onerror [admin@admin] > onerror e in={ import test.rsc } do={ :put "Failure - $e" } Failure - Script Error: bad command name this (line 1 column 1) In addition, the command has new options in mode - the parameter is specially designed for debugging and can find multiple errors import verbose dry-run without changing the configuration. [admin@admin] > import test.rsc verbose=yes dry-run #line 1 this bad command name this (line 1 column 1) ... Script Error: found 5 error(s) in import file print parameters Several parameters are available for print command: Parameter Description Example append as-value print output as an array of parameters and its values :put [/ip address print as- value] brief print brief description detail print detailed description, the output is not as readable as brief output but may be useful to view all parameters count-only print only count of menu items file print output to a file follow print all current entries and track new entries until ctrl-c is pressed, very useful when viewing log entries/log print follow follow-only print and track only new entries until ctrl-c is pressed, very useful when viewing log entries /log print follow-only from print parameters only from specified item /user print from=admin interval continuously print output in a selected time interval, useful to track down changes where f is not acceptable ollow /interface print interval=2 terse show details in a compact and machine-friendly format value-list show values single per line (good for parsing purposes) without- pagingIf the output does not fit in the console screen then do not stop, print all information in one piece where expressions followed by where parameters can be used to filter outmatched entries /ip route print where interface="ether1"

about returns entries that have the "about" parameter, such as "managed by CAPsMAN "information or warnings/interface wifi print where about More than one parameter can be specified at a time, for example, /ip route print count-only interval=1 where interface="ether1" Loops and conditional statements Loops Command Syntax Description do..while :do { <commands> } while=( <conditions> ); :while ( <conditions> ) do={ <commands> };execute commands until a given condition is met. for :for <var> from=<int> to=<int> step=<int> do={ <commands> } execute commands over a given number of iterations foreach :foreach <var> in=<array> do={ <commands> }; execute commands for each element in a list Conditional statement Command Syntax Description if :if (<condition>) do={<commands>} else= {<commands>} <expression>If a given condition is then execute commands in the block, otherwise true do execute commands in the block if specified. else Example: { :local myBool true; :if ($myBool = false) do={ :put "value is false" } else={ :put "value is true" } } Functions Scripting language does not allow you to create functions directly, however, you could use :parse command as a workaround. Starting from v6.2 new syntax is added to easier define such functions and even pass parameters. It is also possible to return function value with co :return mmand. See examples below: #define function and run it :global myFunc do={:put "hello from function"} $myFunc output: hello from function #pass arguments to the function :global myFunc do={:put "arg a=$a"; :put "arg '1'=$1"} $myFunc a="this is arg a value" "this is arg1 value" output: arg a=this is arg a value arg '1'=this is arg1 value Notice that there are two ways how to pass arguments: pass arg with a specific name ("a" in our example) pass value without arg name, in such case arg "1", "2" .. "n" is used.

Contains a list of all currently running scripts. Read-only status properties: Property Description owner ( ) string The user who is running the script policy ( ) array List of all policies applied to the script started ( )date Local date and time when the script was started See also Scripting Examples Manual: Scripting Tips and Tricks Videos on Scripting Scripting pt1 Scripting pt2 Scripting: Data Types Scripting: Arrays

Scripting examples Introduction Create a file Check if IP on the interface has changed Strip netmask Resolve host-name Write simple queue stats in multiple files Generate backup and send it by e-mail Check bandwidth and add limitations Block access to specific websites Parse file to add ppp secrets Detect new log entry Allow use of ntp.org pool service for NTP Other scripts Introduction This section contains some useful scripts and shows all available scripting features. Script examples used in this section were tested with the latest 3.x version. Create a file it is not possible to create a file directly, however, there is a workaround: /file print file=myFile /file set myFile.txt contents="" Check if IP on the interface has changed Sometimes provider gives dynamic IP addresses. This script will compare if a dynamic IP address is changed. :global currentIP; :local newIP [/ip address get [find interface="ether1"] address]; :if ($newIP != $currentIP) do={ :put "ip address $currentIP changed to $newIP"; :set currentIP $newIP; } Strip netmask This script is useful if you need an IP address without a netmask (for example to use it in a firewall), but " " returns the /ip address get [id] address IP address and netmask. :global ipaddress 10.1.101.1/24 :for i from=( [:len $ipaddress] - 1) to=0 do={ :if ( [:pick $ipaddress $i] = "/") do={ :put [:pick $ipaddress 0 $i] } }

Another much more simple way: :global ipaddress 10.1.101.1/24 :put [:pick $ipaddress 0 [:find $ipaddress "/"]] Resolve host-name Many users are asking features to use DNS names instead of IP addresses for radius servers, firewall rules, etc. So here is an example of how to resolve the RADIUS server's IP. Let's say we have the radius server configured: /radius add address=3.4.5.6 comment=myRad And here is a script that will resolve the IP address, compare resolved IP with configured one, and replace it if not equal: /system script add name="resolver" source= { :local resolvedIP [:resolve "server.example.com"]; :local radiusID [/radius find comment="myRad"]; :local currentIP [/radius get $radiusID address]; :if ($resolvedIP != $currentIP) do={ /radius set $radiusID address=$resolvedIP; /log info "radius ip updated"; } } Add this script to the scheduler to run for example every 5 minutes /system scheduler add name=resolveRadiusIP on-event="resolver" interval=5m Write simple queue stats in multiple files Let's consider queue namings are "some text.1" so we can search queues by the last number right after the dot.

:local entriesPerFile 10; :local currentQueue 0; :local queuesInFile 0; :local fileContent ""; #determine needed file count :local numQueues [/queue simple print count-only] ; :local fileCount ($numQueues / $entriesPerFile); :if ( ($fileCount * $entriesPerFile) != $numQueues) do={ :set fileCount ($fileCount + 1); } #remove old files /file remove [find name~"stats"]; :put "fileCount=$fileCount"; :for i from=1 to=$fileCount do={ #create file /file print file="stats$i.txt"; #clear content /file set [find name="stats$i.txt"] contents=""; :while ($queuesInFile < $entriesPerFile) do={ :if ($currentQueue < $numQueues) do={ :set currentQueue ($currentQueue +1); :put $currentQueue ; /queue simple :local internalID [find name~"\\.$currentQueue\$"]; :put "internalID=$internalID"; :set fileContent ($fileContent . [get $internalID target-address] . \ " " . [get $internalID total-bytes] . "\r\n"); } :set queuesInFile ($queuesInFile +1); } /file set "stats$i.txt" contents=$fileContent; :set fileContent ""; :set queuesInFile 0; } Generate backup and send it by e-mail This script generates a backup file and sends it to a specified e-mail address. The mail subject contains the router's name, current date, and time. Note that the SMTP server must be configured before this script can be used. See for configuration options. /tool e-mail /system backup save name=email_backup /tool e-mail send file=email_backup.backup to="me@test.com" body="See attached file" \ subject="$[/system identity get name] $[/system clock get time] $[/system clock get date] Backup") The backup file contains sensitive information like passwords. So to get access to generated backup files, the script or scheduler must have a 'sensitive' policy.

Use string as a function :global printA [:parse ":local A; :put \$A;" ]; $printA Check bandwidth and add limitations This script checks if the download on an interface is more than 512kbps if true then the queue is added to limit the speed to 256kbps. :foreach i in=[/interface find] do={ /interface monitor-traffic $i once do={ :if ($"received-bits-per-second" > 0 ) do={ :local tmpIP [/ip address get [/ip address find interface=$i] address] ; # :log warning $tmpIP ; :for j from=( [:len $tmpIP] - 1) to=0 do={ :if ( [:pick $tmpIP $j] = "/") do={ /queue simple add name=$i max-limit=256000/256000 dst-address=[:pick $tmpIP 0 $j] ; } } } } } Block access to specific websites This script is useful if you want to block certain websites but you don't want to use a web proxy. This example looks at entries "Rapidshare" and "youtube" in the DNS cache and adds IPs to the address list named "restricted". Before you begin, you must set up a router to catch all DNS requests: /ip firewall nat add action=redirect chain=dstnat comment=DNS dst-port=53 protocol=tcp to-ports=53 add action=redirect chain=dstnat dst-port=53 protocol=udp to-ports=53 and add firewall /ip firewall filter add chain=forward dst-address-list=restricted action=drop Now we can write a script and schedule it to run, let's say, every 30 seconds. Script Code:

:foreach i in=[/ip dns cache find] do={ :local bNew "true"; :local cacheName [/ip dns cache all get $i name] ; # :put $cacheName; :if (([:find $cacheName "rapidshare"] >= 0) || ([:find $cacheName "youtube"] >= 0)) do={ :local tmpAddress [/ip dns cache get $i address] ; # :put $tmpAddress; # if address list is empty do not check :if ( [/ip firewall address-list find list="restricted" ] = "") do={ :log info ("added entry: $[/ip dns cache get $i name] IP $tmpAddress"); /ip firewall address-list add address=$tmpAddress list=restricted comment=$cacheName; } else={ :foreach j in=[/ip firewall address-list find list="restricted"] do={ :if ( [/ip firewall address-list get $j address] = $tmpAddress ) do={ :set bNew "false"; } } :if ( $bNew = "true" ) do={ :log info ("added entry: $[/ip dns cache get $i name] IP $tmpAddress"); /ip firewall address-list add address=$tmpAddress list=restricted comment=$cacheName; } } } } Parse file to add ppp secrets This script requires that entries inside the file are in the following format: username,password,local_address,remote_address,profile,service For example: janis,123,1.1.1.1,2.2.2.1,ppp_profile,myService juris,456,1.1.1.1,2.2.2.2,ppp_profile,myService aija,678,1.1.1.1,2.2.2.3,ppp_profile,myService

:global content [/file get [/file find name=test.txt] contents] ; :global contentLen [ :len $content ] ; :global lineEnd 0; :global line ""; :global lastEnd 0; :do { :set lineEnd [:find $content "\r\n" $lastEnd ] ; :set line [:pick $content $lastEnd $lineEnd] ; :set lastEnd ( $lineEnd + 2 ) ; :local tmpArray [:toarray $line] ; :if ( [:pick $tmpArray 0] != "" ) do={ :put $tmpArray; /ppp secret add name=[:pick $tmpArray 0] password=[:pick $tmpArray 1] \ local-address=[:pick $tmpArray 2] remote-address=[:pick $tmpArray 3] \ profile=[:pick $tmpArray 4] service=[:pick $tmpArray 5]; } } while ($lineEnd < $contentLen) Detect new log entry This script is checking if a new log entry is added to a particular buffer. In this example we will use PPPoE logs: /system logging action add name="pppoe" /system logging add action=pppoe topics=pppoe,info,!ppp,!debug Log buffer will look similar to this one: [admin@mainGW] > /log print where buffer=pppoe 13:11:08 pppoe,info PPPoE connection established from 00:0C:42:04:4C:EE Now we can write a script to detect if a new entry is added.

:global lastTime; :global currentBuf [ :toarray [ /log find buffer=pppoe ] ] ; :global currentLineCount [ :len $currentBuf ] ; :global currentTime [ :totime [/log get [ :pick $currentBuf ($currentLineCount -1) ] time ] ]; :global message ""; :if ( $lastTime = "" ) do={ :set lastTime $currentTime ; :set message [/log get [ :pick $currentBuf ($currentLineCount-1) ] message]; } else={ :if ( $lastTime < $currentTime ) do={ :set lastTime $currentTime ; :set message [/log get [ :pick $currentBuf ($currentLineCount-1) ] message]; } } After a new entry is detected, it is saved in the "message" variable, which you can use later to parse log messages, for example, to get the PPPoE client's mac addresses. Allow use of pool service for NTP ntp.org This script resolves the hostnames of two NTP servers, compares the result with the current NTP settings, and changes the addresses if they're different. This script is required as RouterOS does not allow hostnames to be used in the NTP configuration. Two scripts are used. The first defines some system variables which are used in other scripts and the second does the grunt work: # System configuration script - "GlobalVars" :put "Setting system globals"; # System name :global SYSname [/system identity get name]; # E-mail address to send notifications to :global SYSsendemail "mail@my.address"; # E-mail address to send notifications from :global SYSmyemail "routeros@my.address"; # Mail server to use :global SYSemailserver "1.2.3.4"; # NTP pools to use (check www.pool.ntp.org) :global SYSntpa "0.uk.pool.ntp.org"; :global SYSntpb "1.uk.pool.ntp.org";

/system scheduler add \ comment="Check and set NTP servers" \ disabled=no \ interval=12h \ name=CheckNTPServers \ on-event=setntppool \ policy=read,write,test \ start-date=jan/01/1970 \ start-time=16:00:00 Other scripts Dynamic_DNS_Update_Script_for_EveryDNS Dynamic_DNS_Update_Script_for_ChangeIP.com UPS Script

Scripting Tips and Tricks Do not use console numbers to get parameter values Why find does not work even if correct value is specified? How to define empty array How to remove variables Get values for properties if 'get' command is not available Always check what value and type command returns Be careful when adding array to string Get/Set unnamed elements in array Set element value in 2D array Read value of global variable defined in other script Accessing global variable from function Running function from another function Always use unique variable names Get values from looped interactive commands like "monitor" Get file content received by fetch tool Check script permissions Be careful when using dont-require-permissions Do not use console numbers to get parameter values Lets start with very basics. When you work with console to access parameters, you are used to following syntax: [admin@rack1_b34_CCR1036] /interface> print Flags: D - dynamic, X - disabled, R - running, S - slave # NAME TYPE ACTUAL-MTU L2MTU MAX-L2MTU 0 R ether1 ether 1500 1580 1022 [admin@rack1_b34_CCR1036] /interface> set 0 name=LAN What print command does is temporary saves buffer with id numbers referencing to internal ID numbers, so obviously if you are trying to use non-existent buffer values script will fail, like, for example this script: /system script add name=script1 source={ /ip route set 0 gateway=3.3.3.3 } Script does not know what you assume by "1" and will throw an error. Proper way is to use internal ID numbers, those numbers can be seen if you are doing or returned by find command, for example: print as-value [admin@rack1_b34_CCR1036] /ip route> :put [find where dst-address="10.0.0.0/8"] *1 So in this case proper script would be: /system script add name=script1 source={ /ip route set *1 gateway=3.3.3.3 } Note that it is not recommended to use internal numbers directly, since items can be removed and re-added in which case internal id number will change and script will fail again, so instead use find command directly in your code: /system script add name=script1 source={ /ip route set [find dst-address="0.0.0.0/0"] gateway=3.3.3.3 } Why find does not work even if correct value is specified? Lets say we want to print specific address: [admin@rack1_b34_CCR1036] /ip address> print where address=111.111.1.1/24 Flags: X - disabled, I - invalid, D - dynamic # ADDRESS NETWORK INTERFACE So why it does not work? Console tries to convert variable types as hard as it can, but it is not always possible to do it correctly, so lets look closely why this particular example does not work. First lets check what variable type "address" is:

Always check what value and type command returns Lets say we want to get gateway of specific route using as-value, if we execute following command it will return nothing [admin@rack1_b36_CCR1009] /ip address> :put ([/ip route print as-value where gateway="ether1"]->"gateway") Command assumes that output will be 1D array from which we could extract element gateway. At first lets check if print is actually find anything: [admin@rack1_b36_CCR1009] /ip address> :put ([/ip route print as-value where gateway="ether1"]) .id=*400ae12f;distance=255;dst-address=111.111.111.1/32;gateway=ether1;pref-src=111.111.111.1 So obviously there is something wrong with variable itself or variable type returned. Lets check it more closely: [admin@rack1_b36_CCR1009] /ip address> :global aa ([/ip route print as-value where gateway="ether1" ]) [admin@rack1_b36_CCR1009] /ip address> :environment print aa={{.id=*400ae12f; distance=255; dst-address=111.111.111.1/32; gateway={"ether1"}; pref-src=111.11 1.111.1}} Now it is clear that returned value is 2D array with one element. So the right sequence to extract gateway will be: get 2d array get first element get "gateway" from picked element [admin@rack1_b36_CCR1009] /ip address> :put ([:pick [/ip route print as-value where gateway="ether1"] 0]->" gateway") ether1 Be careful when adding array to string If you want to print an array or add an array to existing string, be very careful as it may lead to unexpected results. For example ,we have array with two elements and we want to print the array value on screen: [admin@1p_DUT_wAP ac] /> :global array {"cccc", "ddddd"} [admin@1p_DUT_wAP ac] /> :put ("array value is: " . $array ) array value is: cccc;array value is: ddddd Obviously this is not what we expected, because what . does is adds string to each array element and then prints the output. Instead you need to convert to string first: [admin@1p_DUT_wAP ac] /> :put ("array value is: " . [:tostr $array] ) array value is: cccc;ddddd Get/Set unnamed elements in array Lets say we have an array of elements { "el1"; "el2"; "el3" }. It is possible to pick elements of an array with pick command, but is not so neat as syntax below: [admin@1p_DUT_wAP ac] /> :global test { "el1"; "el2"; "el3" } [admin@1p_DUT_wAP ac] /> :put ($test->1) el2 The same syntax can be used to set values: [admin@1p_DUT_wAP ac] /> :set ($test->2) "el3_changed" [admin@1p_DUT_wAP ac] /> :environment print test={"el1"; "el2"; "el3_changed"} Set element value in 2D array Syntax used in example above can also be used to set element value in 2D array:

[admin@1p_DUT_wAP ac] /> :global test {{"11";"12";"13"};{"21";"22";"23"}} [admin@1p_DUT_wAP ac] > :set ($test->1->1) "22_changed" [admin@1p_DUT_wAP ac] > :put [($test->1->1)] 22_changed [admin@1p_DUT_wAP ac] > :environment print test={{"11"; "12"; "13"}; {"21"; "22_changed"; "23"}} Read value of global variable defined in other script Lets say we have one script that declares variable and sets the value: /system script add name=script1 source={ :global myVar "hello!" } And we want to write the value of that variable in log from another script. Simply adding will fail to return correct value, because /log info $myVar second script does not know anything about variables defined in another scripts. To make it work properly variable need to be defined, so correct second script code is: /system script add name=script2 source={ :global myVar; :log info "value is: $myvar" } Accessing global variable from function Logically you would think that globally defined variables should be accessible in functions too, but that is not really the case. Lets see an example: :global myVar "test" :global myFunc do={ :put "global var=$myVar" } [$myFunc] Output is: global var= So obviously global variable is not accessible directly. To make it work we need do declare global variable inside the function: :global myVar "test" :global myFunc do={ :global myVar; :put "global var=$myVar" } [$myFunc] Output: global var=test Running function from another function Same as above applies also to functions. If you want to run function from another function then it need to be declared. :global test do={ :return ($1 + 1) } :global testtest do={ :local x 5 :local y [$test $x] :put "typeof = $[:typeof $y]" :put "testets_res=$y" } Code above will not work as expected, output will be: typeof = nil testets_res= To fix this we need to declare global "test" in "testtest" function

:global testtest do={ :global test :local x 5 :local y [$test $x] :put "typeof = $[:typeof $y]" :put "testets_res=$y" } Always use unique variable names One of the most common scripting mistakes that most users are doing is not using unique varible names, for example, variable defined in function has the same name as globally defined variable, which leads to unexpected result: :global my2 "123" :global myFunc do={ :global my2; :put $my2; :set my2 "lala"; :put $my2 } $myFunc my2=1234 :put "global value $my2" Output will be: 1234 lala global value 123 Another common case is when user defined variable have the same name as RouterOS built in variable, for example, we want to print route with dst address defined in variable: [admin@1p_DUT_wAP ac] /ip route> :global "dst-address" "0.0.0.0/0" [admin@1p_DUT_wAP ac] /ip route> print where dst-address=$"dst-address" Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit # DST-ADDRESS PREF-SRC GATEWAY DISTANCE 0 ADS 0.0.0.0/0 10.155.136.1 1 1 ADC 10.155.136.0/24 10.155.136.41 ether1 0 Obviously result is not as expected, simple solution, use unique variable name: [admin@1p_DUT_wAP ac] /ip route> :global myDst "0.0.0.0/0" [admin@1p_DUT_wAP ac] /ip route> print where dst-address=$myDst Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit # DST-ADDRESS PREF-SRC GATEWAY DISTANCE 0 ADS 0.0.0.0/0 10.155.136.1 1 Get values from looped interactive commands like "monitor" Frequently asked question s how to get values in script returned by, for example, monitor command? First problem with such commands is that they are running infinitely until user action is applied, obviously you cannot do that from script. Instead you can run with additional parameter once, it will allow to execute command only once and stop. Another problem is getting variable value sin script, there is no as-value, there is no get, but they have do. What it does is allows to access variables returned by the command as in example below: [admin@1p_DUT_wAP ac] /interface> monitor-traffic ether1 once do={:global myBps $"rx-bits-per-second" } ... [admin@1p_DUT_wAP ac] /interface> :environment print myBps=71464 Get file content received by fetch tool Fetch tool allows for ease of use downloading file content into memory and allowing to access this data by script. To make it work use as-value parameter and output=user: [admin@rack1_b34_CCR1036] > :put ([/tool fetch ftp://admin:@10.155.136.41/test.txt output=user as-value ]->"data") my file content

Check script permissions Lets say we have a script that creates and writes content to the file: /system script add name=script1 policy=ftp,read,write source={ /file print file=test; /file set test.txt content="my content" } Now lets add scheduler that will try to execute this script: /system scheduler add interval=10s name=test on-event=script2 policy=read,write So now we wait 10 seconds, file not created, we wait another 10 seconds and still no file. What is going on? If you look closely script requires policy "ftp", to create a file, but scheduler has only "read" and "write" policies, so script will not be executed. Fix is to set scheduler to run with correct policies "read, write,ftp". This applies also if you are trying to run script from netwatch, ppp on event and so on, which are limited to specific policies "read,write,test,reboot", so you will not be able to run advanced scripts that creates backups, creates files and so on. Limitation could be fixed by using dont-require-permissions, but be very careful, read below. Be careful when using dont-require-permissions It is possible to set script with dont-require-permissions parameter. Basically it allows anyone without adequate permissions to execute the script. For example, if script has policies "read,write,test,sensitive", but user or application that executes the script has less, for example, "read,write", then by setting d will allow to run script anyway. ont-require-permissions=yes This could potentially allow to change sensitive information using script even if user doe snot have enough permissions.

System Information and Utilities In This Section:

The following commands are available in the / menu: system/device-mode Property Description get Returns value that you can assign to variable or print on the screen. print Shows the active mode and its properties. update Applies changes to the specified properties, see below. Available device-mode modes There are three device modes available for configuration (mode=advanced is default one), each mode has a subset of features that are not allowed when it is used. Note that . Certain features need to be enabled even if you have "advanced" mode enabled. See there is no mode, which has all features enabled section "Feature clarification" for more details about what each option means. So, as per the below table it can be seen that "traffic-gen, container, partitions, routerboard" features are always disabled, unless specifically enabled by the admin user. Mode Description of features disabled advanced (default)traffic-gen, container, install-any-version , partitions, routerboard basic socks, bandwidth-test, traffic-gen, proxy, hotspot, zerotier, container, , partitions, routerboard install-any-version home scheduler, socks, fetch, bandwidth-test, traffic-gen, sniffer, romon, proxy, hotspot, email, zerotier, container, install-any-version , partitions, routerboard List of available properties Property Description scheduler, socks, fetch, pptp, l2tp, bandwidth-test, traffic- gen, sniffer, ipsec, romon, proxy, hotspot, smb, email, zerotier, container, install-any-version , partitions, routerboard (yes | no )The list of available features, which can be controlled with the option. See device-mode section "Feature clarification" for more details about what each option means. activation-timeout (default: );5m The reset button or power off activation timeout can be set in range 00:00:10 .. 1d00:00:00. If the reset button is not pressed (or cold reboot is not performed) during this interval, the update will be canceled. flagging-enabled ( ; Default: ) yes | no yes Enable or disable the status. See below for a detailed description. flagged flagged ( ; Default: ) yes | no no RouterOS employs various mechanisms to detect tampering with it's system files. If the system has detected unauthorized access to RouterOS, the status "flagged" is set to yes. If "flagged" is set to yes, for your safety, certain limitations are put in place. See below chapter for more information. mode: (basic, home, advanced; default: ); advanced Allows choosing from available modes that will limit device functionality. By default, mode allows options except advanced traffic-gen, container, partitions, install- any-version So to use these features, you will need to turn it on by performing , routerboard. a device-mode update. By default, mode disables the following features: home scheduler, socks, fetch, bandwidth- test, traffic-gen, sniffer, romon, proxy, hotspot, email, zerotier, container, install-any-version , partitions, routerboard. More specific control over the available features is possible. Each of the features controlled by device-mode can be specifically turned on or off. For instance won't allow to perform any action at system scheduler. Used device-mode disables all listed features, for instance =home is scheduler mode used, but is required for your setup, device-mode update /system device-mode update zerotier=yes will be required with the physical access to zerotier device to push the button or cut the power.

E-mail Properties Sending Email Basic examples An E-mail tool is a utility that allows sending e-mails from the router. The tool can be used to send regular configuration backups and exports to a network administrator. Email tool uses only plain authentication and TLS encryption. Other methods are not supported. Properties /tool e-mail This submenu allows setting SMTP server that will be used. Property Description address ( ; Default: ) IP/IPv6 address 0.0.0.0 SMTP server's IP address. from ( ; Default: ) string <> Name or email address that will be shown as a receiver. password ( ; Default: ) string "" Password used for authenticating to an SMTP server. port ( ; Default: ) integer[0..65535] 25 SMTP server's port. tls ( ; Default: ) no|yes|starttls no Whether to use TLS encryption: yes - sends STARTTLS and drops the session if TLS is not available on the server no- do not send STARTTLS starttls - sends STARTTLS and continue without TLS if a server responds that TLS is not available user ( ; Default: ) string "" The username used for authenticating to an SMTP server. vrf ( ; default value: ) VRF name main Set VRF on which service is creating outgoing connections. Sending Email /tool e-mail send Send command takes the following parameters: Property Description body ( ; Default: ) string The actual body of the email message cc ( ; Default: ) string Send a copy to listed recipients. Multiple addresses allowed, use "," to separate entries file ( ; Default: ) File[,File] List of the file names that will be attached to the mail separated by a comma. Note: All server's configurations (if specified) can be overridden by send command.

/tool e-mail set address=smtp.gmail.com set port=465 set tls=yes set from=myuser@gmail.com set user=myuser set password=mypassword 2. send e-mail using send command: /tool e-mail send to=myuser@anotherdomain.com subject="email test" body="email test"

It is possible to use an HTTP POST request to send information to a remote server, that is prepared to accept it. In the following example, we send geographic coordinates to a PHP page: /tool/fetch http-method=post http-header-field="Content-Type:application/json" http-data="{\"lat\":\"56.12\",\" lon\":\"25.12\"}" url="https://testserver.lv/index.php" In this example, the data is uploaded as a file. Important note, since variable data comes from a file, a file can only be in size up to 4KB. This is a limitation of RouterOS variables. /export file=export.rsc :global data [/file get [/file find name=export.rsc] contents]; :global $url "https://prod-51.westeurope.logic.azure.com:443/workflows/blabla/triggers/manual/paths/invoke...."; /tool fetch mode=https http-method=put http-data=$data url=$url Return value to a variable It is possible to save the result of the fetch command to a variable. For example, it is possible to trigger a certain action based on the result that an HTTP page returns. You can find a very simple example below that disables whenever a PHP page returns "0": ether2 { :local result [/tool fetch url=https://10.0.0.1/disable_ether2.php as-value output=user]; :if ($result->"status" = "finished") do={ :if ($result->"data" = "0") do={ /interface ethernet set ether2 disabled=yes; } else={ /interface ethernet set ether2 disabled=no; } } }

file ( ; Default: ) string File name from which to read offset ( Default:) integer; Specifies offset where to start read file

1. 2. 3. Interface Lists Summary Lists Members Summary Allows defining a set of interfaces for easier interface management in the different interface-based configuration sections such as Neighbor Discovery, Firewall, Bridge, and Internet Detect. Lists Sub-menu: /interface list This menu contains information about all interface lists available on the router. There are four predefined lists - (contains all interfaces), (contain all none s no interfaces), (contains dynamic interfaces), and (contains static interfaces). It is also possible to create additional interface lists. dynamic static Property Description name ( ) string Name of the interface list include ( ) string Defines interface list which members are included in the list. It is possible to add multiple lists separated by commas exclude ( ) string Defines interface list which members are excluded from the list. It is possible to add multiple lists separated by commas Members are added to the interface list in the following order: include members are added to the interface list exclude members are removed from the list Statically configured members are added to the list Members Sub-menu: /interface list member This sub-menu contains information about statically configured interface members to each interface list. Note that dynamically added interfaces by include and exclude statements are not represented in this sub-menu. Property Description interface ( ) stringName of the interface list ( ) string Name of the interface list Dynamic interfaces are interfaces that have a "dynamic" flag. Any interface that doesn't have a dynamic flag will be part of the interface static list. Care must be taken when working with bridges and lists. Adding a bridge as a member is not the same as adding all its ports! And adding all slave ports as members is not the same as adding the bridge itself. This can particularly impact functionality of neighbor discovery.

1. a. b. c. d. 2. 3. 4. 5. uptime ( )time Uptime of remote device. Shown only to devices installed with RouterOS. version ( ) string Version number of installed software on a remote device Discovery configuration It is possible to change whether an interface participates in neighbor discovery or not using an Interface list. If the interface is included in the discovery interface list, it will send out basic information about the system and process received discovery packets broadcasted in the Layer2 network. Removing an interface from the interface list will disable both the discovery of neighbors on this interface and also the possibility of discovering this device itself on that interface. /ip neighbor discovery-settings Property Description discover- interface-list (stri ; Default:ng static )Interface list on which members the discovery protocol will run on. discover-interval (time: 5s.. ; Default: 9h6m8s )30sAdjusts the frequency at which neighbor discovery packets are transmitted. It also adjusts the Time-to-Live (TTL) TLV value for CDP and LLDP packets using the formula: ( * 4) + 1. The setting is available since RouterOS version 7.16. discover-interval lldp-dcbx (yes | ; Default: ) no noWhether to send Data Center Bridging Capabilities Exchange Protocol (DCBX) TLVs, which allows to communicate switch QoS and capabilities with other neighboring devices using LLDP. Only applies to CRS3xx, CRS5xx, CCR2116 and CCR2216 settings devices. Enabled DCBX includes the following TLVs: ETS (Enhanced Transmission Selection) Configuration TLV . This TLV is used to share the switch's ETS configuration. It includes: The willingness bit, which indicates whether the device is willing to accept QoS configuration from neighboring devices. In RouterOS, the willing bit is set to disabled, meaning the switch will not accept remote configurations and instead uses its own settings. The priority assignment table, which maps priorities to specific traffic-class. The bandwidth allocation table, where RouterOS calculates the percentage of bandwidth allocated to each queue based on the property. This applies to queues using the in the weight high-priority-group /interface/ethernet settings. /switch/qos/tx-manager/queue The Transmission Selection Algorithm (TSA) table, where queues are assigned to ETS, high-priority-group strict queues to Strict Priority, and or non-hardware offloaded queues to the Vendor -priority low-priority-group Specific Algorithm. ETS Recommendation TLV . This provides a recommendation on how neighboring devices should configure ETS. RouterOS uses the same data as in the ETS Configuration TLV to give its recommendation. Priority-based Flow Control Configuration TLV . This TLV is used to share PFC configuration. Similar to the ETS TLV, the willingness bit is set to disabled, meaning the switch does not accept remote PFC configurations. PFC is enabled for specific priorities based on settings configured under , and /interface/ethernet/switch/qos/priority-flow-control /inte . rface/ethernet/switch/qos/port Application Priority TLV . This TLV is used to communicate how different applications are prioritized in the network. Application VLAN TLV . This TLV is used to share VLAN configurations for applications. RouterOS currently does not support sending values in this TLV and will send an empty VLAN table instead. lldp-mac-phy- ( ; config yes | no Default: )noWhether to send MAC/PHY Configuration/Status TLV in LLDP, which indicates the interface capabilities, current setting of the duplex status, bit rate, and auto-negotiation. Only applies to the Ethernet interfaces. While TLV is optional in LLDP, it is mandatory when sending LLDP-MED, meaning this TLV will be included when necessary even though the property is configured as disabled. Starting from RouterOS v6.45, the number of neighbor entries are limited to (total RAM in megabytes)*16 per interface to avoid memory exhaustion.

lldp-max-frame- ( ; size yes | no Default: )noWhether to send Maximum Frame Size TLV in LLDP, which indicates the maximum frame size capability of the interface in bytes ( l2 + 18). Only applies to the Ethernet interfaces.mtu ( lldp-poe-power ; yes | no Default: )yesTwo specific TLVs facilitate Power over Ethernet (PoE) management between Power Sourcing Equipment (PSE) and Powered Devices (PD): IEEE 802.3 Organizationally Specific TLV Power Via MDI TIA-1057 (LLDP-MED) Organizationally Specific TLV Extended Power via MDI The attribute determines whether to transmit the IEEE 802.3 Organizationally Specific Power Via MDI TLV in lldp-poe-power LLDP messages. The transmission of LLDP-MED Organizationally Specific Extended Power via MDI TLV is not configurable. It is automatically included in outgoing LLDP-MED packets when the remote device has transmitted LLDP-MED capability of receiving power. These TLVs are relevant only for Ethernet interfaces that support The setting is available since RouterOS version 7.15, . PoE-Out and it replaces PoE-out por setting. t poe-lldp-enabled lldp-med-net- policy-vlan (integ ; er 0..4094 Default: ) disabledAdvertised VLAN ID for LLDP-MED Network Policy TLV. This allows assigning a VLAN ID for LLDP-MED capable devices, such as VoIP phones. The TLV will only be added to interfaces where LLDP-MED capable devices are discovered. Other TLV values are predefined and cannot be changed: Application Type - Voice VLAN Type - Tagged L2 Priority - 0 DSCP Priority - 0 When used together with the bridge interface, the (R/M)STP protocol should be enabled with setting. protocol-mode Additionally, other neighbor discovery protocols (e.g. CDP) should be excluded using setting to avoid LLDP-MED protocol misconfiguration. lldp-vlan-info (ye Default: s | no; no )Whether to send IEEE 802.1 Organizationally Specific TLVs in LLDP related to VLANs. When this setting is enabled, three TLVs are advertised: Port VLAN ID. This applies to the bridge port's property.pvid Port And Protocol VLAN ID. This TLV is not used and always indicates "not supported" and "not enabled". VLAN Name. This includes up to 10 active VLANs from the " " table. /interface/bridge/vlan These TLVs are relevant to interfaces that are added to a bridge, and the setting is available since RouterOS version vlan-filtering 7.16. mode (rx-only | tx-only | tx-and- ; Default:rx tx- ) and-rxSelects the neighbor discovery packet sending and receiving mode. The setting is available since RouterOS version 7.7. protocol (cdp | ; lldp | mndp Default: cdp,lldp, ) mndpList of used discovery protocols. Since RouterOS v6.44, neighbor discovery is working on individual slave interfaces. Whenever a master interface (e.g. bonding or bridge) is included in the discovery interface list, all its slave interfaces will automatically participate in neighbor discovery. It is possible to allow neighbor discovery only to some slave interfaces. To do that, include the particular slave interface in the list and make sure that the master interface is not included. /interface bonding add name=bond1 slaves=ether5,ether6 /interface list add name=only-ether5 /interface list member add interface=ether5 list=only-ether5 /ip neighbor discovery-settings set discover-interface-list=only-ether5

Note Summary /system note The system note feature allows you to assign arbitrary text notes or messages that will be displayed on each login right after the banner. For example, you may distribute warnings between system administrators this way, or describe what does that particular router actually do. To configure system note, you may upload a plain text file named on the router's FTP server, or, additionally, edit the settings in this menu sys-note.txt Properties Property Description note ( ; Default: ) string Note that will be displayed. show-at-login ( ; Default: ) yes | no yes Whether to show system note on each login show-at-cli-login ( | , Default: ) yes no no Whether to show system note before telnet login prompt. Example It is possible to add multi-line notes using an embedded text editor ( ), for example, add ASCII art to your home router: /system note edit note system/note/set note= .& @& @& @@ @# @@& , @@@ . @@@@@@@@@@@@@@@@@ @@@ @@@ @@@ ,@ @@@ & @@@@ @@@ @@@@ @@ @@@ @( &@@ @@@ @@@ @@@@@ @@@ &@@@& &@@@@@@@@@@@@@@@& @@@@@

NTP RouterOS version 6 SNTP Client properties: Client settings example: NTP Server settings: RouterOS version 7 NTP Client properties: NTP Server settings: Log messages RouterOS v6 implements the SNTP protocol defined in RFC4330, manycast mode is not supported. SNTP client is included in the package. To use system an NTP server, package must be . ntp installed and enabled RouterOS v7 main package includes NTP client and server functionality, which is based on RFC5905. The client configuration is located in the console path, and the (RouterOS version 6), /system ntp client "System > SNTP Client" "System > NTP Client" (RouterOS version 7) WinBox window. This configuration is shared by the SNTP client implementation in the package and the NTP client system implementation in the package. When package is installed and enabled, the SNTP client is disabled automatically. ntp ntp RouterOS version 6 SNTP Client properties: Property Description enabled (yes, no ) default: no Enable SNTP client for time synchronization mode (broadcast, unicast, filed is read- )onlyMode that the SNTP client will operate in. If no NTP servers are configured mode will be used. If there is a dynamic broadcast or static NTP server IP address or FQDN used it will automatically switch to unicast mode. primary-ntp (IP address default: 0.0.0 ).0IP address of the NTP server that has to be used for time synchronization. If both values are non-zero, then the SNTP client will alternate between the two server addresses, switching to the other when the request to the current server times out or when the "KoD" packet is received, indicating that the server is not willing to respond to requests from this client. The following formats are accepted: - ipv4 - ipv6 secondary-ntp (IP address default: 0.0.0 ).0see primary-ntp server-dns-names (C omma separated domain name list ) default: To set the NTP server using its domain name. The domain name will be resolved each time an NTP request is sent. Router has to have configured. /ip dns Status active-server (IP address; read-only property) : Currently selected NTP server address. This value is equal to or . primary-ntp secondary-ntp poll-interval (Time interval; read-only property) : Current interval between requests sent to the active server. The initial value is 16 seconds, and it is increased by doubling to 15 minutes. Last received packet information Values of the following properties are reset when the SNTP client is stopped or restarted, either because of a configuration change, or because of a network error. last-update-from (IP address; read-only property) : Source IP address of the last received NTP server packed that was successfully processed.

last-update-before (Time interval; read-only property) : Time since the last successfully received server message. last-adjustment (Time interval; read-only property) : Amount of clock adjustment that was calculated from the last successfully received NTP server message. last-bad-packet-from (IP address; read-only property) : Source IP address of last received SNTP packed that was not successfully processed. Reason of the failure and time since this packet was received is available in the next two properties. last-bad-packet-before (Time interval; read-only property) : Time since the last receive failure. last-bad-packet-reason (Text; read-only property) : Text that describes the reason of the last receive failure. Possible values are: bad-packet-length - Packet length is not in the acceptable range. server-not-synchronized - Leap Indicator field is set to "alarm condition" value, which means that clock on the server has not been synchronized yet. zero-transmit-timestamp - Transmit Timestamp field value is 0. bad-mode - Value of the Mode field is neither 'server' nor 'broadcast'. kod-ABCD - Received "KoD" (Kiss-o'-Death) response. is the short "kiss code" text from the Reference Identifier field. ABCD broadcast - Received proadcast message, but = . mode unicast non-broadcast - Received packed was server reply, but = . mode broadcast server-ip-mismatch - Received response from address that is not . active-server originate-timestamp-mismatch - Originate Timestamp field in the server response message is not the same as the one included in the last request. roundtrip-too-long - request/response roundtrip exceeded 1 second. Client settings example: To check the status of the NTP client in CLI, use the "print" command [admin@ntp-example_v6] > /system ntp client print enabled: no primary-ntp: 0.0.0.0 secondary-ntp: 0.0.0.0 server-dns-names: mode: unicast To enable the NTP client and set IP addresses or FQDN of the NTP servers: [admin@ntp-example_v6] > /system ntp client set enabled=yes [admin@ntp-example_v6] > /system ntp client print enabled: yes primary-ntp: 0.0.0.0 secondary-ntp: 0.0.0.0 server-dns-names: mode: unicast dynamic-servers: x.x.x.x, x.x.x.x poll-interval: 15s active-server: x.x.x.x last-update-from: x.x.x.x last-update-before: 6s570ms last-adjustment: -1ms786us [admin@ntp-example_v6] > /system ntp client set primary-ntp=162.159.200.123 [admin@ntp-example_v6] > /system ntp client print enabled: yes primary-ntp: 162.159.200.123 secondary-ntp: 0.0.0.0 server-dns-names: mode: unicast dynamic-servers: x.x.x.x, x.x.x.x poll-interval: 16s active-server: x.x.x.x NTP Server settings: Server configuration is located in /system ntp server Property Description

enabled ( or ; default value: ) yes no no Enable NTP server broadcast ( or ; default value: ) yes no no Enable certain NTP server mode, for this mode to work you have to set up broadcast-addresses field multicast ( or ; default value: ) yes no no Enable certain NTP server mode manycast ( or ; default value: ) yes no no Enable certain NTP server mode broadcast-addresses ( ; default value: ) IP address Set broadcast address to use for NTP server broadcast mode Example: Set up an NTP server for the local network that is 192.168.88.0/24 /system ntp server set broadcast=yes broadcast-addresses=192.168.88.255 enabled=yes manycast=no RouterOS version 7 NTP Client properties: Property Description enabled (yes, no default: )noEnable NTP client for time synchronization mode (broadcast, manycast, multicast, ) unicastMode that the NTP client will operate in NTP servers The list of NTP servers. It is possible to add static entries. The following formats are accepted: - FQDN ("Resolved Address" will appear in the "Servers"- window in an appropriate column if the address is resolved) or IP address can be used. If DHCP-Client property - the dynamic entries advertised by use-peer-ntp=yes DHCP - ipv4 - ipv4@vrf - ipv6 - ipv6@vrf - ipv6-linklocal%interface vrf ( ) default: main Virtual Routing and Forwarding ( ) Servers Button/Section A detailed table of dynamically and statically added NTP servers (Address, Resolved address, Min Poll, Max Poll, iBurst, Auth. Key) To set the NTP server using its FQDN. The domain name will be resolved each time an NTP request is sent. Router has to have configured. /ip/dns Peers Current parameter values [admin@ntp-example_v7] > /system/ntp/monitor-peers type="ucast-client" address=x.x.x.x refid="y.y.y.y" stratum=3 hpoll=10 ppoll=10 root- delay=28.869 ms root-disp=50.994 ms offset=-0.973 ms delay=0.522 ms disp=15.032 ms jitter=0.521 ms -- [Q quit|D dump|C-z pause] Keys NTP symmetric keys, used for authentication between the NTP client and server. Key Identifier (Key ID) - an integer identifying the cryptographic key used to generate the message-authentication code.

Status - Current status of the NTP client synchronized, stopped, waiting, using-local-clock - The fractional frequency drift per unit time. Frequency drift - The IP address of the NTP Server. synced-server - The accuracy of each server is defined by a number called the stratum, with the topmost level (primary servers) assigned as one synced-stratum and each level downwards (secondary servers) in the hierarchy assigned as one greater than the preceding level. system-offset - This is a signed, fixed-point number indicating the offset of the NTP server's clock relative to the local clock, in seconds. NTP Server settings: Server configuration is located in /system ntp server Property Description enabled (yes or no; default value: no)Enable NTP server broadcast ( or ; yes no default value: ) noEnable certain NTP server mode, for this mode to work you have to set up broadcast-addresses field multicast ( or ; default yes no value: no)Enable certain NTP server mode manycast ( or ; default yes no value: no)Enable certain NTP server mode broadcast-addresses (IP ; default value: ) addressSet broadcast address to use for NTP server broadcast mode vrf ( ) default: main Virtual Routing and Forwarding use-local-clock (yes or no; ) default value: noThe server will supply its local system time as valid if others are not available. local-clock-stratum Manually set stratum if use-local-clock=yes auth-key ( ) default value: none NTP symmetric key, used for authentication between the NTP client and server. Key Identifier (Key ID) - an integer identifying the cryptographic key used to generate the message-authentication code. Log messages SNTP client can produce the following log messages. See the article " " on how to set up logging and how to inspect logs.log ntp, gradually adjust by debug OFFS ntp, instantly adjust by debug OFFS ntp, Wait for seconds before sending the next message debug N ntp, Wait for seconds before restarting debug N ntp, , packet receive an error, restarting debug packet ntp, , received debug packet PKT ntp, , ignoring received debug packet PKT ntp, , error sending to , restarting debug packet IP ntp, , sending to debug packet IP PKT Explanation of log message fields OFFS - difference of two NTP timestamp values, in hexadecimal. PKT - dump of NTP packet. If the packet is shorter than the minimum 48 bytes, it is dumped as a hexadecimal string. Otherwise, the packet is dumped as a list of field names and values, one per log line. Names of fields follow RFC4330. IP - remote IP address. NOTE : the above logging rules work only with the built-in SNTP client, the separate NTP package doesn't have any logging facilities.

Partitions Summary Partitioning is supported on ARM, ARM64, MIPS, TILE, and PowerPC RouterBOARD type devices. It is possible to partition NAND flash, allowing to install own OS on each partition and specify primary and fallback partitions. If a partition should fail for some reason (failed upgrade, problematic configuration introduced, software problem), the next partition will boot instead. This can be used as an interactive backup where you keep a verified working installation and upgrade only some secondary partition. If you upgrade your configuration, and it proves to be good, you can use the "save config" button to copy it over to other partitions. Minimum partition sizes: 32MB on MIPS 40MB on PowerPC 48MB on TILE The maximum number of allowed partitions is 8. [admin@1009up] > /partitions/print Flags: A - ACTIVE; R - RUNNING Columns: NAME, FALLBACK-TO, VERSION, SIZE # NAME FALL VERSION SIZE 0 AR part0 next RouterOS v7.1beta4 Dec/15/2020 15:55:11 128MiB Commands Property Description activate ( ) <partition> Assigns another partition as Active. This option is available if the "partitions" setting is enabled in device mode (since RouterOS 7.17). repartition ( ) integer Will reboot the router and reformat the NAND, leaving only active partition. copy-to ( ) <partition> Clone OS with the config to specified partition. Previously stored data on the partition will be erased. running save-config-to ( ) <partition> Clone on a specified partition. Everything else is untouched. running-config restore-config-from (<partitio )n>Copy config from specified partition to partition running Properties Property Description name ( ; Default: ) string Name of the partition fallback-to ( ; Default: ) etherboot | next | <partition-name> next What to do if an active partition fails to boot: etherboot - switch to etherboot next' - try next partition fallback to the specified partition Read-only Repartitioning of the NAND requires the latest bootloader version

Property Description active ( ) yes | no Partition is active running ( ) yes | no Currently running partition size ( ) integer[MiB] Partition size version ( ) string Current RouterOS version installed on the partition

/system ptp port add interface=ether1 ptp=ptp1 /system ptp port add interface=ether2 ptp=ptp1 Monitoring To monitor the status and performance of the PTP profile, use the following command: /system ptp monitor 0 The output will provide detailed information about the profile's operational status: name: ptp1 clock-id: 64:D1:54:FF:FE:EB:AD:C7 priority1: 246 priority2: 248 i-am-gm: no gm-clock-id: 64:D1:54:FF:FE:EB:AE:C3 gm-priority1: 100 gm-priority2: 248 master-clock-id: 64:D1:54:FF:FE:EB:AE:C3 slave-port: ether1 freq-drift: 2690 ppb offset: 3 ns hw-offset: -889419842 ns slave-port-delay: 306 ns This information includes critical details such as the clock IDs, priority values, and timing offsets, which are essential for monitoring the accuracy and synchronization of your PTP setup. Monitor Properties Property Description clock-id: Local clock identifier, used to uniquely identify the clock within the PTP network. priority1: The priority parameter used in the election of the grandmaster clock. A lower value indicates higher priority. priority2: The priority parameter used in the election of the backup grandmaster clock. A lower value indicates higher priority. i-am-gm: ye s | noIndicates if the device is a grandmaster clock ( ) or not ( ). yes no gm-clock- id:Identifier of the grandmaster clock. This is the clock providing the primary time source. gm- priority1:The value of the grandmaster clock as seen from the slave device. priority1 gm- priority2:The value of the grandmaster clock as seen from the slave device. priority2 master- clock-id:Identifier of the master clock in the PTP communication path. This may be a grandmaster clock or a boundary clock, depending on the network topology. slave-port: The port on the device that is connected to the master or grandmaster clock. freq-drift: The frequency drift between the master and slave clocks, measured in parts per billion (ppb). This indicates how much the slave clock's frequency deviates from the master clock's frequency. offset: The time difference between the master and slave clocks, measured in nanoseconds (ns). This reflects the synchronization accuracy. hw-offset: Offset difference from the hardware clock.

slave-port- delay:The time delay for packets traveling between two devices, measured in nanoseconds (ns). This delay can be influenced by the quality of cables and transceivers used in the network. Supported Devices Important: Devices not listed in this section do not support Precision Time Protocol. CRS326-24G-2S+: Supported only on Gigabit Ethernet ports. CRS328-24P-4S+: Supported only on Gigabit Ethernet ports. CRS317-1G-16S+: Supported on all ports. CRS326-24S+2Q+: Supported on SFP+ and QSFP+ interfaces. CRS312-4C+8XG: Supported on all ports. CRS318-16P-2S+: Supported only on Gigabit Ethernet ports. CRS318-1Fi-15Fr-2S: Supported only on Gigabit Ethernet ports. PTP Support Added in RouterOS Version 7.16 and Later: CCR2116-12G-4S+: Supported on all ports. CCR2216-1G-12XS-2XQ: Supported on all ports. CRS518-16XS-2XQ: Supported on all ports. CRS504-4XQ: Supported on all ports. CRS510-8XS-2XQ: Supported on all ports. Supported on all ports. CRS520-4XS-16XQ: PTP Support Added in RouterOS Version 7.17 and Later: CRS320-8P-8B-4S+RM: Supported only on Gigabit Ethernet ports. CRS326-4C+20G+2Q+: Supported on all ports.

[admin@dzeltenais_burkaans] /ip service> set api address=10.5.101.0/24,2001:db8:fade::/64 [admin@dzeltenais_burkaans] /ip service> print Flags: X - disabled, I - invalid # NAME PORT ADDRESS CERTIFICATE 0 telnet 23 1 ftp 21 2 www 80 3 ssh 22 4 X www-ssl 443 none 5 api 8728 10.5.101.0/24 2001:db8:fade::/64 6 winbox 8291 Protocols and ports The table below shows the list of protocols and ports used by RouterOS. Proto/Port Description 20/tcp FTP data connection 21/tcp FTP control connection 22/tcp Secure Shell (SSH) remote login protocol 23/tcp Telnet protocol 53/tcp 53/udpDNS 67/udp Bootstrap protocol or DHCP Server 68/udp Bootstrap protocol or DHCP Client 80/tcp World Wide Web HTTP 123/udp Network Time Protocol ( )NTP 161/udp Simple Network Management Protocol ( ) SNMP 179/tcp Border Gateway Protocol ( ) BGP 443/tcp Secure Socket Layer (SSL) encrypted HTTP 500/udp Internet Key Exchange (IKE) protocol 520/udp 521/udpRIP routing protocol 546/udp DHCPv6 Client message 547/udp DHCPv6 Server message 646/tcp LDP transport session 646/udp LDP hello protocol 1080/tcp SOCKS proxy protocol 1698/udp 1699/udp RSVP TE Tunnels 1701/udp Layer 2 Tunnel Protocol ( ) L2TP 1723/tcp Point-To-Point Tunneling Protocol ( ) PPTP

1900/udp 2828/tcpUniversal Plug and Play ( ) uPnP 1966/udp MME originator message traffic 1966/tcp MME gateway protocol 2000/tcp Bandwidth test server 5246,5247/udp CAPsMAN 5350/udp NAT-PMP client 5351/udp NAT-PMP server 5678/udp Mikrotik Neighbor Discovery Protocol 6343/tcp Default OpenFlow port 8080/tcp HTTP Web Proxy 8291/tcp Winbox 8728/tcp API 8729/tcp API-SSL 20561/udp MAC winbox /1 ICMP /2 Multicast | IGMP /4 IPIP encapsulation /41 IPv6 (encapsulation) /46 RSVP TE tunnels /47 General Routing Encapsulation (GRE) - used for PPTP and tunnels EoIP /50 Encapsulating Security Payload for IPv4 (ESP) /51 Authentication Header for IPv4 (AH) /89 OSPF routing protocol /103 Multicast | PIM /112 VRRP

TFTP Introduction Parameters Settings Regexp Examples Introduction Trivial File Transfer Protocol or simply TFTP is a very simple protocol used to transfer files. Each nonterminal packet is acknowledged separately. ip/tftp/ This menu contains all TFTP access rules. If in this menu are no rules, the TFTP server is not started when RouterOS boots. This menu only shows 1 additional attribute compared to what you can set when creating a rule. Parameters Property Description ip-address (required)Range of IP addresses accepted as clients if empty will be used 0.0.0.0/0 allow- rollover (D efault: No)If set to TFTP server will allow the sequence number to roll over when the maximum value is reached. This is used to enable large yes downloads using the TFTP server. req- filenameRequested filename as if a field is left empty it defaults to a regular expression (regex) .* real- filenameIf and values are set and valid, the requested filename will be replaced with matched file. This field has to be req-filename real-filename set. If multiple is specified in , with this field you can set which ones should match, so this rule is validated. regex req-filename The real- format for using multiple is filename regex filename\0\5\6 allow (def ) ault: yesTo allow connection if the above fields are set. if , a connection will be interrupted no read-only ( ) default: noSets if a file can be written to, if set to "yes" write attempt will fail with error hits (read- only)How many times this access rule entry has been used (read-only) Settings /ip/tftp/settings This menu contains all TFTP settings. Property Description max-block-size (default: ) 4096Maximum accepted block size value. During the transfer negotiation phase, the RouterOS device will not negotiate a larger value than this.

Regexp Req-filename field allowed regexp, a llowed regexp in this field are: brackets () - marking subsection: example 1 will match asd or afga(sd|fg) asterisk "*" - match zero or more times preceding symbol: example 1 will match any length name consisting purely of symbols or no symbols at all a* a example 2 will match any length name, also, empty field.* example 3 will match adf, asdf, assdf, asssdf etc.as*df plus "+" will match one or more times the preceding symbol: example: as+df will match asdf, assdf etc. dot "." - matches any symbol: example will match asdf, asbf ashf etc.as.f square brackets [] - variation between: example will match and as[df] asdasf question mark "?" will match one or no symbols: example will match and asd?f asdfasf caret "^" - used at the beginning of the line means that the line starts with; dollar "$" - means at the end of the line. Examples If a file is requested return the file from the store called sata1: /ip tftp add req-filename=file.txt real-filename=/sata1/file.txt allow=yes read-only=yes If we want to give out one specific no matter what the user is requesting: file /ip tftp add req-filename=.* real-filename=/sata1/file.txt allow=yes read-only=yes If the user requests or then give them : aaa.bin bbb.bin ccc.bin /ip tftp add req-filename="(aaa.bin)|(bbb.bin)" real-filename="/sata1/ccc.bin\\0" allow=yes read-only=yes RouterOS receives TFTP requests, but the client gets a transfer timeout? Some embedded clients request large block sizes and yet do not handle fragmented packets correctly. For these clients, it is recommended to set "max-block-size" on the RouterOS side or "blksize" on Client-side to the value of the smallest MTU on your network minus 32 bytes (20 bytes for IP, 8 for UDP, and 4 for TFTP) and more if you use IP options on your network.

Virtual Private Networks In This Section:

6to4 Summary Property Description Configuration Examples Simple 6to4 tunnel encapsulation (Currently not working) Hurricane Electric Tunnel Broker Example Summary Sub-menu: /interface 6to4 6to4 is a special mechanism that allows IPv6 packets to be transmitted over IPv4 networks without the need of explicitly configured tunnel interfaces. It is especially useful for connecting two or more IPv6 networks over a network that does not have IPv6 support. There are two different ways of 6to4 mechanism. If is not configured, the router will encapsulate and send an IPv6 packet directly over IPv4 if the first 16 bits are , using remote-address 2002 the next 32 bits as the destination (IPv4 address converted to hex). In other case, the IPv6 packet will be sent directly to the IPv4 . remote-address Property Description Property Description clamp-tcp-mss ( ; yes | no Default: )yesControls whether to change MSS size for received TCP SYN packets. When enabled, a router will change the MSS size for received TCP SYN packets if the current MSS size exceeds the tunnel interface MTU (taking into account the TCP/IP overhead). The received encapsulated packet will still contain the original MSS, and only after decapsulation the MSS is changed. comment (string ; Default: )Short description of the interface. disabled (yes | ; Default: ) no noWhether an item is disabled. dont-fragment (i ; nherit | no Default: )noWhether to include DF bit in related packets: no - fragment if needed, - use Dont Fragment flag of original packet. inherit (Without Dont Fragment: inherit - packet may be fragmented). dscp (integer: 0- ; Default: 63 inhe )ritedDSCP value of packet. Inherited option means that DSCP value will be inherited from packet which is going to be encapsulated. ipsec-secret (stri ; Default: )ngWhen secret is specified, router adds dynamic IPsec peer to remote-address with pre-shared key and policy (by default phase2 uses sha1/aes128cbc). keepalive (integ er[/time],integer ; 0..4294967295 Default: )0,0Tunnel keepalive parameter sets the time interval in which the tunnel running flag will remain even if the remote end of tunnel goes down. If configured time,retries fail, interface running flag is removed. Parameters are written in following format: KeepaliveInterv where is time interval and - number of retry attempts. By al,KeepaliveRetries KeepaliveInterval KeepaliveRetries default keepalive is set to 10 seconds and 10 retries. local-address (IP ; Default: )Source address of the packets, local on the router. mtu ( ; integer Default: )autoLayer3 maximum transmission unit. name ( ; string Default: )Interface name. remote-address (; Default: )IPIP address of remote end of 6to4 tunnel. If left unspecified, IPv4 address from 2002::/16 gateway address will be . derived

Configuration Examples Simple 6to4 tunnel encapsulation (Currently not working) It is possible to simply route IPv6 packets over IPv4 network by utilizing the 2002::/16 allocated address space. All 6to4 nodes has to have reachable IPv4 addresses - if you are running this setup over the Internet, all IPv4's must be public addresses. R1 configuration: Create the 6to4 tunnel interface: /interface 6to4 add name=6to4-tunnel1 Assign an IPv6 address with '2002' as the first 16 bits and IPv4 in hex format as the next 32 bits. For example, if the router's IP address is 10.0.1.1, the IPv6 address is 2002:A00:101:: /ipv6 address add address=2002:a00:101::/128 advertise=no interface=6to4-tunnel1 Add a route to specially allocated 6to4 tunnel range over the 6to4-tunnel interface. /ipv6 route add dst-address=2002::/16 gateway=6to4-tunnel1 R2 configuration: Create the 6to4 tunnel interface: /interface 6to4 add name=6to4-tunnel1 Assign an IPv6 address that is generated by the same principles as R1. In this case, 10.0.2.1 translates to 2002:A00:201:: /ipv6 address add address=2002:a00:201::/128 advertise=no interface=6to4-tunnel1 The 6to4 route is necessary on this side as well.

/ipv6 route add dst-address=2002::/16 gateway=6to4-tunnel1 Testing: After configuring both devices, it should be possible to ping the IPv6 addresses if they were generated correctly. From R1: /ping 2002:a00:201:: Hurricane Electric Tunnel Broker Example Following example will show how to get IPv6 connectivity on a RouterOS device through IPv4 network using 6to4 tunnel. To be able to create the tunnel, you have to have a public IPv4 address and enable ping from Tunnel Broker IPv4 server. When you create a tunnel using , you will be given a routed /64 IPv6 prefix and additional information necessary for Hurricane Electric Tunnel Broker setting up the tunnel. This example presumes that your public IPv4 address is 194.105.56.170 Hurricane Electric provides ready to use commands for RouterOS in the 'Example Configurations' section: /interface 6to4 add comment="Hurricane Electric IPv6 Tunnel Broker" disabled=no local-address=194.105.56.170 mtu=1280 name=sit1 remote-address=216.66.80.90 /ipv6 route add comment="" disabled=no distance=1 dst-address=2000::/3 gateway=2001:470:27:37e::1 scope=30 target-scope=10 /ipv6 address add address=2001:470:27:37e::2/64 advertise=no disabled=no eui-64=no interface=sit1 These commands will setup the tunnel itself - the router will be able to connect to IPv6 hosts, but end-user devices (computers, tablets, phones) will not yet have IPv6 connectivity. To be able to assign IPv6 addresses to your clients you have to add the Routed IPv6 Prefix to your internal interface (by default bridge-local). /ipv6 address add address=2001:470:28:37e:: interface=bridge-local advertise=yes Enable DNS server advertising through network discovery /ipv6 nd set [ find default=yes ] advertise-dns=yes

And finally add IPv6 DNS servers (these are Google public DNS servers, you can also use the one which is provided by Hurricane Electric - 2001:470:20:: 2). /ip dns set allow-remote-requests=yes servers=2001:4860:4860::8888,2001:4860:4860::8844 Afterwards enable IPv6 on your device and you should have IPv6 connectivity. can be used to test IPv6 connectivity. http://ipv6-test.com

dscp (integer: 0- ; Default: 63 inher )itedDSCP value of packet. Inherited option means that dscp value will be inherited from packet which is going to be encapsulated. ipsec-secret (stri ; Default: )ngWhen secret is specified, router adds dynamic IPsec peer to remote-address with pre-shared key and policy (by default phase2 uses sha1/aes128cbc). keepalive (intege r[/time],integer 0.. ; 4294967295 Default: ) 10s,10Tunnel keepalive parameter sets the time interval in which the tunnel running flag will remain even if the remote end of tunnel goes down. If configured time,retries fail, interface running flag is removed. Parameters are written in following format: KeepaliveInter where is time interval and - number of retry attempts. By val,KeepaliveRetries KeepaliveInterval KeepaliveRetries default keepalive is set to 10 seconds and 10 retries. l2mtu (integer; ) read-onlyLayer2 Maximum transmission unit. Not configurable for EoIP. MTU in RouterOS local-address (;IP Default: )Source address of the tunnel packets, local on the router. loop-protect loop-protect- disable-time loop-protect- send-interval mac-address (M ; Default: )ACMedia Access Control number of an interface. The address numeration authority IANA allows the use of MAC addresses in the range from freely 00:00:5E:80:00:00 - 00:00:5E:FF:FF:FF mtu ( ; integer Default: )autoLayer3 Maximum transmission unit name ( ; string Default: )Interface name remote-address ( ; Default: )IPIP address of remote end of EoIP tunnel tunnel-id (integer: ; Default: ) 65536Unique tunnel identifier, which must match other side of the tunnel Configuration Examples Parameter tunnel-id is a method of identifying a tunnel. It must be unique for each EoIP tunnel. When bridging EoIP tunnels, it is highly recommended to set unique MAC addresses for each tunnel for the bridge algorithms to work correctly. For EoIP interfaces you can use MAC addresses that are in the range from 00:00:5E:80:00:00 - 00:00:5E:FF:FF:FF , which IANA has reserved for such cases. Alternatively, you can set the second bit of the first byte to modify the auto-assigned address into a 'locally administered address', assigned by the network administrator, and thus use any MAC address, you just need to ensure they are unique between the hosts connected to one bridge. Example Let us assume we want to bridge two networks: 'Station' and 'AP'. By using EoIP setup can be made so that Station and AP LANs are in the same Layer2 broadcast domain. Consider the following setup: EoIP tunnel adds at least 42 byte overhead (8byte GRE + 14 byte Ethernet + 20 byte IP). MTU should be set to 1500 to eliminate packet fragmentation inside the tunnel (that allows transparent bridging of Ethernet-like networks so that it would be possible to transport full-sized Ethernet frame over the tunnel).

As you know wireless stations cannot be bridged, to overcome this limitation (not involving WDS) we will create an EoIP tunnel over the wireless link and bridge it with interfaces connected to local networks. We will not cover wireless configuration in this example, let's assume that the wireless link is already established. At first, we create an EoIP tunnel on our AP: /interface eoip add name="eoip-remote" tunnel-id=0 remote-address=10.0.0.2 disabled=no Verify the interface is created: [admin@AP] > /interface eoip print Flags: X - disabled; R - running 0 R name="eoip-remote" mtu=auto actual-mtu=1458 l2mtu=65535 mac-address=FE:A5:6C:3F:26:C5 arp=enabled arp-timeout=auto loop-protect=default loop-protect-status=off loop-protect-send-interval=5s loop-protect-disable-time=5m local-address=0.0.0.0 remote-address=10.0.0.2 tunnel-id=0 keepalive=10s,10 dscp=inherit clamp-tcp-mss=yes dont-fragment=no allow-fast-path=yes Station router: /interface eoip add name="eoip-main" tunnel-id=0 remote-address=10.0.0.1 disabled=no Verify the interface is created: [admin@Station] > /interface eoip print Flags: X - disabled; R - running 0 R name="eoip-main" mtu=auto actual-mtu=1458 l2mtu=65535 mac-address=FE:4B:71:05:EA:8B arp=enabled arp-timeout=auto loop-protect=default loop-protect-status=off loop-protect-send-interval=5s loop-protect-disable-time=5m local-address=0.0.0.0 remote-address=10.0.0.1 tunnel-id=0 keepalive=10s,10 dscp=inherit clamp-tcp-mss=yes dont-fragment=no allow-fast-path=yes Next, we will bridge local interfaces with EoIP tunnel on our AP. If you already have a local bridge interface, simply add EoIP interface to it:

/interface bridge port add bridge=bridge1 interface=eoip-remote The bridge port list should list all local LAN interfaces and the EoIP interface: [admin@AP] > /interface bridge port print Flags: I - INACTIVE; H - HW-OFFLOAD Columns: INTERFACE, BRIDGE, HW, PVID, PRIORITY, PATH-COST, INTERNAL-PATH-COST, HORIZON # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH-COST HORIZON 0 H ether2 bridge1 yes 1 0x80 10 10 none 1 H ether3 bridge1 yes 1 0x80 10 10 none 2 eoip-remote bridge1 yes 1 0x80 10 10 none On Station router, if you do not have a local bridge interface, create a new bridge and add both EoIP and local LAN interfaces to it: /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether2 /interface bridge port add bridge=bridge1 interface=eoip-main Verify the bridge port section: [admin@Station] > /interface bridge port print Flags: I - INACTIVE; H - HW-OFFLOAD Columns: INTERFACE, BRIDGE, HW, PVID, PRIORITY, PATH-COST, INTERNAL-PATH-COST, HORIZON # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH-COST HORIZON 0 H ether2 bridge1 yes 1 0x80 10 10 none 2 eoip-main bridge1 yes 1 0x80 10 10 none Now both sites are in the same Layer2 broadcast domain. You can set up IP addresses from the same network on both sites.

GRE Introduction Properties Setup example Introduction Sub-menu: /interface gre Standards: RFC1701 GRE (Generic Routing Encapsulation) is a tunneling protocol that was originally developed by Cisco. It can encapsulate a wide variety of protocols creating a virtual point-to-point link. GRE is the same as IPIP andEoIP which were originally developed as stateless tunnels. This means that if the remote end of the tunnel goes down, all traffic that was routed over the tunnels will get blackholed. To solve this problem, RouterOS has added a 'keepalive' feature for GRE tunnels. Properties Property Description allow-fast-path (y ; Default: es | no y )esWhether to allow FastPath processing. Must be disabled if IPsec tunneling is used. clamp-tcp-mss (y ; Default: es | no y )esControls whether to change MSS size for received TCP SYN packets. When enabled, a router will change the MSS size for received TCP SYN packets if the current MSS size exceeds the tunnel interface MTU (taking into account the TCP/IP overhead). The received encapsulated packet will still contain the original MSS, and only after decapsulation the MSS is changed. comment ( ; string Default: )Short description of the tunnel. disabled (yes | no ; Default: )noEnables/disables tunnel. dont-fragment (in ; herit | no Default: )noWhether to include DF bit in related packets: no - fragment if needed, - use Dont Fragment flag of original packet. inherit (Without Dont Fragment: inherit - packet may be fragmented). dscp (inherit | ; integer [0-63] Default: )Set dscp value in Gre header to a fixed value or inherit from dscp value taken from tunnelled traffic ipsec-secret (string ; Default: )When secret is specified, router adds dynamic IPsec peer to remote-address with pre-shared key and policy (by default phase2 uses sha1/aes128cbc). keepalive (integer [/time],integer 0.. ; 4294967295 Default: ) 10s,10Tunnel keepalive parameter sets the time interval in which the tunnel running flag will remain even if the remote end of tunnel goes down. If configured time,retries fail, interface running flag is removed. Parameters are written in following format: KeepaliveInter where KeepaliveInterval is time interval and KeepaliveRetries - number of retry attempts. By default val,KeepaliveRetries keepalive is set to 10 seconds and 10 retries. l2mtu (integer [0.. ; Default: 65536] 6 ) 5535Layer2 Maximum transmission unit. GRE tunnel adds a 24 byte overhead (4-byte gre header + 20-byte IP header). GRE tunnel can forward only IP and IPv6 packets (ethernet type 800 and 86dd). Do not use the "Check gateway" option "arp" when a GRE tunnel is used as a route gateway.

local-address (;IP Default: ) 0.0.0.0IP address that will be used for local tunnel end. If set to 0.0.0.0 then IP address of outgoing interface will be used. mtu (integer [0.. ; Default: 65536] 1 )476Layer3 Maximum transmission unit. name ( ; string Default: )Name of the tunnel. remote-address (IP ; Default: )IP address of remote tunnel end. Setup example The goal of this example is to get Layer 3 connectivity between two remote sites over the internet We have two sites, with local network range 10.1.101.0/24 and with local network range 10.1.202.0/24. Site1 Site2 The first step is to create GRE tunnels. A router on site 1: /interface gre add name=myGre remote-address=192.168.90.1 local-address=192.168.80.1 A router on site 2: /interface gre add name=myGre remote-address=192.168.80.1 local-address=192.168.90.1 As you can see tunnel configuration is quite simple. Now we just need to set up tunnel addresses and proper routing. A router on site 1: In this example, a keepalive is not configured, so tunnel interface will have a running flag even if remote tunnel end is not reachable

/ip address add address=172.16.1.1/30 interface=myGre /ip route add dst-address=10.1.202.0/24 gateway=172.16.1.2 A router on site 2: /ip address add address=172.16.1.2/30 interface=myGre /ip route add dst-address=10.1.101.0/24 gateway=172.16.1.1 At this point, both sites have Layer 3 connectivity over the GRE tunnel.

IPsec Introduction Internet Key Exchange Protocol (IKE) Diffie-Hellman Groups IKE Traffic Setup Procedure EAP Authentication methods Authentication Header (AH) Transport mode Tunnel mode Encapsulating Security Payload (ESP) Transport mode Tunnel mode Encryption algorithms Hardware acceleration Policies Statistics Proposals Groups Peers Profiles Identities Active Peers Mode configs Installed SAs Keys Settings Application Guides RoadWarrior client with NAT Allow only IPsec encapsulated traffic IPsec policy matcher Using generic IPsec policy Manually specifying local-address parameter under Peer configuration Using different routing table Using the same routing table with multiple IP addresses Application examples Site to Site IPsec (IKEv1) tunnel Site 1 configuration Site 2 configuration NAT and Fasttrack Bypass Site to Site GRE tunnel over IPsec (IKEv2) using DNS Site 1 (server) configuration Site 2 (client) configuration Road Warrior setup using IKEv2 with RSA authentication RouterOS server configuration Identity configuration (Optional) Split tunnel configuration Generating client certificates Known limitations RouterOS client configuration Enabling dynamic source NAT rule generation Windows client configuration macOS client configuration iOS client configuration Android (strongSwan) client configuration Linux (strongSwan) client configuration Road Warrior setup using IKEv2 with EAP-MSCHAPv2 authentication handled by User Manager (RouterOS v7) RouterOS server configuration Requirements Generating Let's Encrypt certificate Configuring User Manager Configuring RADIUS client

IPsec (IKEv2) server configuration (Optional) Split tunnel configuration (Optional) Assigning static IP address to user (Optional) Accounting configuration Basic L2TP/IPsec setup RouterOS server configuration RouterOS client configuration Troubleshooting/FAQ Introduction Internet Protocol Security (IPsec) is a set of protocols defined by the Internet Engineering Task Force (IETF) to secure packet exchange over unprotected IP/IPv6 networks such as the Internet. IPsec protocol suite can be divided into the following groups: Internet Key Exchange (IKE) protocols. Dynamically generates and distributes cryptographic keys for AH and ESP. Authentication Header (AH) RFC 4302 Encapsulating Security Payload (ESP) RFC 4303 Internet Key Exchange Protocol (IKE) The Internet Key Exchange (IKE) is a protocol that provides authenticated keying material for the Internet Security Association and Key Management Protocol (ISAKMP) framework. There are other key exchange schemes that work with ISAKMP, but IKE is the most widely used one. Together they provide means for authentication of hosts and automatic management of security associations (SA). Most of the time IKE daemon is doing nothing. There are two possible situations when it is activated: There is some traffic caught by a policy rule which needs to become encrypted or authenticated, but the policy doesn't have any SAs. The policy notifies the IKE daemon about that, and the IKE daemon initiates a connection to a remote host. IKE daemon responds to remote connection. In both cases, peers establish a connection and execute 2 phases: Phase 1 - The peers agree upon algorithms they will use in the following IKE messages and authenticate. The keying material used to derive keys for all SAs and to protect following ISAKMP exchanges between hosts is generated also. This phase should match the following settings: authentication method DH group encryption algorithm exchange mode hash algorithm NAT-T DPD and lifetime (optional) Phase 2 - The peers establish one or more SAs that will be used by IPsec to encrypt data. All SAs established by the IKE daemon will have lifetime values (either limiting time, after which SA will become invalid, or the amount of data that can be encrypted by this SA, or both). This phase should match the following settings: IPsec protocol mode (tunnel or transport) authentication method PFS (DH) group lifetime There are two lifetime values - soft and hard. When SA reaches its soft lifetime threshold, the IKE daemon receives a notice and starts another phase 2 exchange to replace this SA with a fresh one. If SA reaches a hard lifetime, it is discarded. Phase 1 is not re-keyed if DPD is disabled when the lifetime expires, only phase 2 is re-keyed. To force phase 1 re-key, enable DPD.

IKE can optionally provide a Perfect Forward Secrecy (PFS), which is a property of key exchanges, that, in turn, means for IKE that compromising the long term phase 1 key will not allow to easily gain access to all IPsec data that is protected by SAs established through this phase 1. It means an additional keying material is generated for each phase 2. The generation of keying material is computationally very expensive. Exempli Gratia, the use of the modp8192 group can take several seconds even on a very fast computer. It usually takes place once per phase 1 exchange, which happens only once between any host pair and then is kept for a long time. PFS adds this expensive operation also to each phase 2 exchange. Diffie-Hellman Groups Diffie-Hellman (DH) key exchange protocol allows two parties without any initial shared secret to create one securely. The following Modular Exponential (MODP) and ECP Diffie-Hellman (also known as "Oakley") Groups are supported: Diffie-Hellman Group Name Reference Group 1 768 bits MODP group RFC 2409 Group 2 1024 bits MODP group RFC 2409 Group 5 1536 bits MODP group RFC 3526 Group 14 2048 bits MODP group RFC 3526 Group 15 3072 bits MODP group RFC 3526 Group 16 4096 bits MODP group RFC 3526 Group 17 6144 bits MODP group RFC 3526 Group 18 8192 bits MODP group RFC 3526 Group 19 256 bits random ECP group RFC 5903 Group 20 384 bits random ECP group RFC 5903 Group 21 521 bits random ECP group RFC 5903 More on standards can be found .here Larger DH groups offer better security but require more CPU power. Here are a few commonly used DH groups with varying levels of security and CPU impact: DH Group 14 (2048-bit) - Provides a reasonable balance between security and CPU usage. It offers 2048-bit key exchange, which is considered secure for most applications today and is widely supported. DH Group 5 (1536-bit) - Offers a slightly lower level of security compared to DH Group 14 but has a lower CPU impact due to the smaller key size. It is still considered secure for many scenarios. DH Group 2 (1024-bit) - Should be used with caution because it provides the least security among commonly used groups. It has a lower CPU impact but is susceptible to attacks, especially as computational power increases. It's generally not recommended for new deployments. For optimal security, it's advisable to use . It's considered fast and secure. DH Group 2 should generally be avoided unless you have legacy DH Group 19 devices that require it. PSK authentication was known to be vulnerable against Offline attacks in "aggressive" mode, however recent discoveries indicate that offline attack is possible also in the case of "main" and "ike2" exchange modes. A general recommendation is to avoid using the PSK authentication method. The correct way of calculating security for your network infrastructure would be to choose how many bits of security you want and you could see how long it would require to decrypt your data, then you have to choose algorithms. Please see information for reference https://www.keylength. com/en/4/

IKE Traffic To avoid problems with IKE packets hit some SPD rule and require to encrypt it with not yet established SA (that this packet perhaps is trying to establish), locally originated packets with UDP source port 500 are not processed with SPD. The same way packets with UDP destination port 500 that are to be delivered locally are not processed in incoming policy checks. Setup Procedure To get IPsec to work with automatic keying using IKE-ISAKMP you will have to configure policy, peer, and proposal (optional) entries. EAP Authentication methods Outer Auth Inner Auth EAP-GTC EAP-MD5 EAP-MSCHAPv2 EAP-PEAPv0 EAP-MSCHAPv2 EAP-GPSK EAP-GTC EAP-MD5 EAP-TLS EAP-SIM EAP-TLS EAP-TTLS PAP CHAP MS-CHAP MS-CHAPv2 EAP-MSCHAPv2 EAP-GTC EAP-MD5 EAP-TLS EAP-TLS on Windows is called "Smart Card or other certificates". https://help.mikrotik.com/servicedesk/projects/SUP/queues/custom/4/SUP-152482#:~:text=ROS%20v7%20(at,implies%20version%203)%2C Authentication Header (AH) IPsec is very sensitive to time changes. If both ends of the IPsec tunnel are not synchronizing time equally(for example, different NTP servers not updating time with the same timestamp), tunnels will break and will have to be established again. AES-GCM encryption support for IKEv2 authentication is not yet supported. If using IPsec with certificate X.509 must contain "SubjectKeyIdentifier" extension, which is supported only in version 3. Using ed25519 - a uthentication is not yet supported.

AH is a protocol that provides authentication of either all or part of the contents of a datagram through the addition of a header that is calculated based on the values in the datagram. What parts of the datagram are used for the calculation, and the placement of the header depends on whether tunnel or transport mode is used. The presence of the AH header allows to verify the integrity of the message but doesn't encrypt it. Thus, AH provides authentication but not privacy. Another protocol (ESP) is considered superior, it provides data privacy and also its own authentication method. RouterOS supports the following authentication algorithms for AH: SHA2 (256, 512) SHA1 MD5 Transport mode In transport mode, the AH header is inserted after the IP header. IP data and header is used to calculate authentication value. IP fields that might change during transit, like TTL and hop count, are set to zero values before authentication. Tunnel mode In tunnel mode, the original IP packet is encapsulated within a new IP packet. All of the original IP packets are authenticated. Encapsulating Security Payload (ESP) Encapsulating Security Payload (ESP) uses shared key encryption to provide data privacy. ESP also supports its own authentication scheme like that used in AH. ESP packages its fields in a very different way than AH. Instead of having just a header, it divides its fields into three components: ESP Header - Comes before the encrypted data and its placement depends on whether ESP is used in transport mode or tunnel mode. ESP Trailer - This section is placed after the encrypted data. It contains padding that is used to align the encrypted data. ESP Authentication Data - This field contains an Integrity Check Value (ICV), computed in a manner similar to how the AH protocol works, for when ESP's optional authentication feature is used. Transport mode In transport mode, the ESP header is inserted after the original IP header. ESP trailer and authentication value are added to the end of the packet. In this mode only the IP payload is encrypted and authenticated, the IP header is not secured. Tunnel mode

In tunnel mode, an original IP packet is encapsulated within a new IP packet thus securing IP payload and IP header. Encryption algorithms RouterOS ESP supports various encryption and authentication algorithms. Authentication: MD5 SHA1 SHA2 (256-bit, 512-bit) Encryption: AES - 128-bit, 192-bit, and 256-bit key AES-CBC, AES-CTR, and AES-GCM algorithms; Blowfish - added since v4.5 Twofish - added since v4.5 Camellia - 128-bit, 192-bit, and 256-bit key Camellia encryption algorithm added since v4.5 DES - 56-bit DES-CBC encryption algorithm; 3DES - 168-bit DES encryption algorithm; Hardware acceleration Hardware acceleration allows doing a faster encryption process by using a built-in encryption engine inside the CPU. List of devices with hardware acceleration is available here CPU DES and 3DES AES-CBC AES-CTR AES-GCM MD5 SHA1 SHA256 SHA512 MD5 SHA1 SHA256 SHA512 MD5 SHA1 SHA256 SHA512 MD5 SHA1 SHA256 SHA512 88F7040 no yes yes yes no yes yes yes no yes yes yes no yes yes yes AL21400 yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes AL32400 yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes AL52400 yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes AL73400 yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes yes IPQ- 4018 / IPQ- 4019no yes yes no no yes* yes* no no yes* yes* no no no no no IPQ- 5018 yes yes yes no yes yes yes no yes yes yes no no no no no IPQ- 6010no no no no no yes yes yes no yes yes yes no yes yes yes IPQ- 8064no yes yes no no yes* yes* no no yes* yes* no no no no no MT7621A yes**** yes**** yes**** no yes yes yes no no no no no no no no no P1023N SN5CFBno no no no yes** yes** yes** yes** no no no no no no no no

src-port (any | integer:0.. ; Default: ) 65535 anySource port to be matched in packets. If set to any all ports will be matched. template ( ; Default: ) yes | no no Creates a template and assigns it to a specified policy group. Following parameters are used by template: group - name of the policy group to which this template is assigned; src-address, dst-address - Requested subnet must match in both directions(for example 0.0.0.0/0 to allow all); protocol - protocol to match, if set to all, then any protocol is accepted; proposal - SA parameters used for this template; level - useful when unique is required in setups with multiple clients behind NAT. tunnel ( ; Default: ) yes | no no Specifies whether to use tunnel mode. Read-only properties Property Description active ( ) yes | no Whether this policy is currently in use. default ( ) yes | no Whether this is a default system entry. dynamic ( ) yes | no Whether this is a dynamically added or generated entry. invalid ( ) yes | no Whether this policy is invalid - the possible cause is a duplicate policy with the same src-address and dst- address. ph2-count ( ) integer A number of active phase 2 sessions associated with the policy. ph2-state (expired | no-phase2 | ) establishedIndication of the progress of key establishing. sa-dst-address ( ; Default: ) ip/ipv6 address ::SA destination IP/IPv6 address (remote peer). sa-src-address ( ; Default: ) ip/ipv6 address ::SA source IP/IPv6 address (local peer). Statistics This menu shows various IPsec statistics and errors. Read-only properties Property Description in-errors ( ) integer All inbound errors that are not matched by other counters. in-buffer-errors ( ) integer No free buffer. in-header-errors ( ) integer Header error. in-no-states ( ) integer No state is found i.e. either inbound SPI, address, or IPsec protocol at SA is wrong. in-state-protocol-errors (int )egerTransformation protocol-specific error, for example, SA key is wrong or hardware accelerator is unable to handle the number of packets. Policy order is important starting from v6.40. Now it works similarly to firewall filters where policies are executed from top to bottom (priority parameter is removed). All packets are IPIP encapsulated in tunnel mode, and their new IP header's src-address and dst-address are set to sa-src-address and sa-dst- address values of this policy. If you do not use tunnel mode (id est you use transport mode), then only packets whose source and destination addresses are the same as sa-src-address and sa-dst-address can be processed by this policy. Transport mode can only work with packets that originate at and are destined for IPsec peers (hosts that established security associations). To encrypt traffic between networks (or a network and a host) you have to use tunnel mode.

in-state-mode-errors (integ )erTransformation mode-specific error. in-state-sequence-errors (i ) ntegerA sequence number is out of a window. in-state-expired ( ) integer The state is expired. in-state-mismatches (integ )erThe state has a mismatched option, for example, the UDP encapsulation type is mismatched. in-state-invalid ( ) integer The state is invalid. in-template-mismatches (i ) ntegerNo matching template for states, e.g. inbound SAs are correct but the SP rule is wrong. A possible cause is a mismatched sa-source or sa-destination address. in-no-policies ( ) integer No policy is found for states, e.g. inbound SAs are correct but no SP is found. in-policy-blocked ( ) integer Policy discards. in-policy-errors ( ) integer Policy errors. out-errors ( ) integer All outbound errors that are not matched by other counters. out-bundle-errors ( ) integer Bundle generation error. out-bundle-check-errors (i ) ntegerBundle check error. out-no-states ( ) integer No state is found. out-state-protocol-errors (i ) ntegerTransformation protocol specific error. out-state-mode-errors (int )egerTransformation mode-specific error. out-state-sequence-errors ( ) integerSequence errors, for example, sequence number overflow. out-state-expired ( ) integer The state is expired. out-policy-blocked ( ) integer Policy discards. out-policy-dead ( ) integer The policy is dead. out-policy-errors ( ) integer Policy error. Proposals Proposal information that will be sent by IKE daemons to establish SAs for certain policies. Properties Property Description auth-algorithms ( ; Default: ) md5|null|sha1|sha256|sha512 sha1 Allowed algorithms for authorization. SHA (Secure Hash Algorithm) is stronger but slower. MD5 uses a 128-bit key, sha1-160bit key. comment ( ; Default: ) string disabled ( ; Default: ) yes | no no Whether an item is disabled.

enc-algorithms (null|des|3des|aes-128-cbc|aes-128-cbc|aes-128gcm|aes-192-cbc|aes-192-ctr|aes- 192-gcm|aes-256-cbc|aes-256-ctr|aes-256-gcm|blowfish|camellia-128|camellia-192|camellia- ; Default: ) 256|twofish aes-256-cbc,aes-192-cbc,aes-128-cbcAllowed algorithms and key lengths to use for SAs. lifetime ( ; Default: ) time 30m How long to use SA before throwing it out. name ( ; Default: ) string pfs-group (ecp256 | ecp384 | ecp521 | modp768 | modp1024 | modp1536 | modp2048 | modp3072 ; Default: ) | modp4096 | modp6144 | modp8192 | none modp1024The diffie-Helman group used for Perfect Forward Secrecy. Read-only properties Property Description default ( ) yes | no Whether this is a default system entry. Groups In this menu, it is possible to create additional policy groups used by policy templates. Properties Property Description name ( ; Default: ) string comment ( ; Default: ) string Peers Peer configuration settings are used to establish connections between IKE daemons. This connection then will be used to negotiate keys and algorithms for SAs. Exchange mode is the only unique identifier between the peers, meaning that there can be multiple peer configurations with the same remote- address as long as a different exchange-mode is used. Properties Property Description address (IP/IPv6 ; Default: Prefix 0.0.0 ).0/0If the remote peer's address matches this prefix, then the peer configuration is used in authentication and establishment of Phase . If several peer's addresses match several configuration entries, the most specific one (i.e. the one with the largest netmask) 1 will be used. comment ( ; string Default: )Short description of the peer. disabled ( ; yes | no Default: )noWhether peer is used to matching remote peer's prefix. exchange-mode (ag gressive | base | ; Default: main | ike2 ) mainDifferent ISAKMP phase 1 exchange modes according to RFC . the mode relaxes rfc2409 section 5.4, to allow pre- 2408 main shared-key authentication in the main mode. ike2 mode enables Ikev2 RFC 7296. Parameters that are ignored by IKEv2 proposal-check, compatibility-options, lifebytes, dpd-maximum-failures, nat-traversal. local-address (IP ; /IPv6 Address Default: )Routers local address on which Phase 1 should be bounded to. name ( ; string Default: )

passive ( ; yes | no Default: )noWhen a passive mode is enabled will wait for a remote peer to initiate an IKE connection. The enabled passive mode also indicates that the peer is xauth responder, and disabled passive mode - xauth initiator. When a passive mode is a disabled peer will try to establish not only phase1 but also phase2 automatically, if policies are configured or created during the phase1. port (integer:0.. ; Default: ) 65535 500Communication port used (when a router is an initiator) to connect to remote peer in cases if remote peer uses the non-default port. profile ( ; string Default: ) defaultName of the profile template that will be used during IKE negotiation. send-initial-contact ( ; Default: yes | no yes )Specifies whether to send "initial contact" IKE packet or wait for remote side, this packet should trigger the removal of old peer SAs for current source address. Usually, in road warrior setups clients are initiators and this parameter should be set to no. Initial contact is not sent if modecfg or xauth is enabled for ikev1. Read-only properties Property Description dynamic ( ) yes | no Whether this is a dynamically added entry by a different service (e.g L2TP). responder ( ) yes | no Whether this peer will act as a responder only (listen to incoming requests) and not initiate a connection. Profiles Profiles define a set of parameters that will be used for IKE negotiation during Phase 1. These parameters may be common with other peer configurations. Properties Property Description dh-group (modp768 | modp1024 | modp1536 | modp2048 | modp3072 | modp4096 | modp6144 | modp8192 | ; Default: ecp256 | ecp384 | ecp521 modp ) 1024,modp2048Diffie-Hellman group (cipher strength) dpd-interval ( ; Default: time | disable-dpd 8s)Dead peer detection interval. If set to disable-dpd, dead peer detection will not be used. dpd-maximum-failures ( ; integer: 1..100 Default: 4)Maximum count of failures until peer is considered to be dead. Applicable if DPD is enabled. enc-algorithm (3des | aes-128 | aes-192 | aes-256 | blowfish | camellia-128 | ; camellia-192 | camellia-256 | des Default: ) aes-128List of encryption algorithms that will be used by the peer. hash-algorithm (md5 | sha1 | sha256 | ; Default: ) sha512 sha1Hashing algorithm. SHA (Secure Hash Algorithm) is stronger, but slower. MD5 uses 128-bit key, sha1- 160bit key. lifebytes ( ; Integer: 0..4294967295 Default: )0Phase 1 lifebytes is used only as administrative value which is added to proposal. Used in cases if remote peer requires specific lifebytes value to establish phase 1. lifetime ( ; Default: ) time 1d Phase 1 lifetime: specifies how long the SA will be valid. name ( ; Default: ) string nat-traversal ( ; Default: ) yes | no yes Use Linux NAT-T mechanism to solve IPsec incompatibility with NAT routers between IPsec peers. This can only be used with ESP protocol (AH is not supported by design, as it signs the complete packet, including the IP header, which is changed by NAT, rendering AH signature invalid). The method encapsulates IPsec ESP traffic into UDP streams in order to overcome some minor issues that made ESP incompatible with NAT.

proposal-check (claim | exact | obey | ; Default: ) strict obeyPhase 2 lifetime check logic: claim - take shortest of proposed and configured lifetimes and notify initiator about it exact - require lifetimes to be the same obey - accept whatever is sent by an initiator strict - if the proposed lifetime is longer than the default then reject the proposal otherwise accept a proposed lifetime Identities Identities are configuration parameters that are specific to the remote peer. The main purpose of identity is to handle authentication and verify the peer's integrity. Properties Property Description auth-method (digital-signature | eap | eap-radius | pre-shared- key | pre-shared-key-xauth | ; rsa-key | rsa-signature-hybrid Default: ) pre-shared-keyAuthentication method: digital-signature - authenticate using a pair of RSA certificates; eap - IKEv2 EAP authentication for initiator (peer with a netmask of /32). Must be used together with eap- methods; eap-radius - IKEv2 EAP RADIUS passthrough authentication for the responder (RFC 3579). A server certificate in this case is required. If a server certificate is not specified then only clients supporting EAP-only (RFC 5998) will be able to connect. Note that the EAP method should be compatible with EAP-only; pre-shared-key - authenticate by a password (pre-shared secret) string shared between the peers (not recommended since an offline attack on the pre-shared key is possible); rsa-key - authenticate using an RSA key imported in keys menu. Only supported in IKEv1; pre-shared-key-xauth - authenticate by a password (pre-shared secret) string shared between the peers + XAuth username and password. Only supported in IKEv1; rsa-signature-hybrid - responder certificate authentication with initiator XAuth. Only supported in IKEv1. certificate ( ; Default: ) string Name of a certificate listed in System/Certificates (signing packets; the certificate must have the private key). Applicable if digital signature authentication method (auth-method=digital-signature) or EAP (auth-method=eap) is used. comment ( ; Default: ) string Short description of the identity. disabled ( ; Default: ) yes | no no Whether identity is used to match remote peers. eap-methods (eap-mschapv2 | ; eap-peap | eap-tls | eap-ttls Default: ) eap-tlsAll EAP methods requires whole certificate chain including intermediate and root CA certificates to be present in System/Certificates menu. Also, the username and password (if required by the authentication server) must be specified. Multiple EAP methods may be specified and will be used in a specified order. Currently supported EAP methods: eap-mschapv2; eap-peap - also known as PEAPv0/EAP-MSCHAPv2; eap-tls - requires additional client certificate specified under certificate parameter; eap-ttls. generate-policy (no | port- ; Default: ) override | port-strict noAllow this peer to establish SA for non-existing policies. Such policies are created dynamically for the lifetime of SA. Automatic policies allows, for example, to create IPsec secured L2TP tunnels, or any other setup where remote peer's IP address is not known at the configuration time. no - do not generate policies; port-override - generate policies and force policy to use port (old behavior);any port-strict - use ports from peer's proposal, which should match peer's policy. key ( ; Default: ) string Name of the private key from keys menu. Applicable if RSA key authentication method (auth-method=rsa-key) is used.

match-by (remote-id | ; Default: ) certificate remote-idDefines the logic used for peer's identity validation. remote-id - will verify the peer's ID according to remote-id setting. certificate will verify the peer's certificate with what is specified under remote-certificate setting. mode-config (none | *request- ; Default: ) only | string noneName of the configuration parameters from mode-config menu. When parameter is set mode-config is enabled. my-id (auto | address | fqdn | ; Default: ) user-fqdn | key-id autoOn initiator, this controls what ID_i is sent to the responder. On responder, this controls what ID_r is sent to the initiator. In IKEv2, responder also expects this ID in received ID_r from initiator. auto - tries to use correct ID automatically: IP for pre-shared key, SAN (DN if not present) for certificate based connections; address - IP address is used as ID; dn - the binary Distinguished Encoding Rules (DER) encoding of an ASN.1 X.500 Distinguished Name; fqdn - fully qualified domain name; key-id - use the specified key ID for the identity; user fqdn - specifies a fully-qualified username string, for example, "user@domain.com". notrack-chain ( ; Default: ) string Adds IP/Firewall/Raw rules matching IPsec policy to a specified chain. Use together with generate-policy. password ( ; Default: ) string XAuth or EAP password. Applicable if pre-shared key with XAuth authentication method (auth-method=pre-shared- key-xauth) or EAP (auth-method=eap) is used. peer ( ; Default: ) string Name of the peer on which the identity applies. policy-template-group (none | ; Default: ) string defaultIf generate-policy is enabled, traffic selectors are checked against templates from the same group. If none of the templates match, Phase 2 SA will not be established. remote-certificate ( ; string Default: )Name of a certificate (listed in System/Certificates) for authenticating the remote side (validating packets; no private key required). If a remote-certificate is not specified then the received certificate from a remote peer is used and checked against CA in the certificate menu. Proper CA must be imported in a certificate store. If remote-certificate and match-by=certificate is specified, only the specific client certificate will be matched. Applicable if digital signature authentication method (auth-method=digital-signature) is used. remote-id (auto | fqdn | user- ; Default: fqdn | key-id | ignore a )utoThis parameter controls what ID value to expect from the remote peer. Note that all types except for ignoring will verify remote peer's ID with a received certificate. In case when the peer sends the certificate name as its ID, it is checked against the certificate, else the ID is checked against Subject Alt. Name. auto - accept all ID's; address - IP address is used as ID; dn - the binary Distinguished Encoding Rules (DER) encoding of an ASN.1 X.500 Distinguished Name; fqdn - fully qualified domain name. Only supported in IKEv2; user fqdn - a fully-qualified username string, for example, "user@domain.com". Only supported in IKEv2; key-id - specific key ID for the identity. Only supported in IKEv2; ignore - do not verify received ID with certificate (dangerous). * Wildcard key ID matching is not supported , for example remote-id="key-id:CN=*. " domain .com remote-key ( ; Default: ) string Name of the public key from keys menu. Applicable if RSA key authentication method (auth-method=rsa-key) is used. secret ( ; Default: ) string Secret string. If it starts with '0x', it is parsed as a hexadecimal value. Applicable if pre-shared key authentication method (auth-method=pre-shared-key and auth-method=pre-shared-key-xauth) is used. username ( ; Default: ) string XAuth or EAP username. Applicable if pre-shared key with XAuth authentication method (auth-method=pre-shared- key-xauth) or EAP (auth-method=eap) is used. Read only properties Property Description dynamic ( ) yes | no Whether this is a dynamically added entry by a different service (e.g L2TP).

Active Peers This menu provides various statistics about remote peers that currently have established phase 1 connection. Read only properties Property Description dynamic-address (ip/ipv6 ) addressDynamically assigned an IP address by mode config last-seen ( )time Duration since the last message received by this peer. local-address ( ) ip/ipv6 address Local address on the router used by this peer. natt-peer ( ) yes | no Whether NAT-T is used for this peer. ph2-total ( ) integer The total amount of active IPsec security associations. remote-address (ip/ipv6 ) addressThe remote peer's ip/ipv6 address. responder ( ) yes | no Whether the connection is initiated by a remote peer. rx-bytes ( ) integer The total amount of bytes received from this peer. rx-packets ( ) integer The total amount of packets received from this peer. side ( ) initiator | responder Shows which side initiated the Phase1 negotiation. state ( ) string State of phase 1 negotiation with the peer. For example, when phase1 and phase 2 are negotiated it will show state "established". tx-bytes ( ) integer The total amount of bytes transmitted to this peer. tx-packets ( ) integer The total amount of packets transmitted to this peer. uptime ( )time How long peers are in an established state. Commands Property Description kill-connections () Manually disconnects all remote peers. Mode configs ISAKMP and IKEv2 configuration attributes are configured in this menu. Properties Property Description address ( ; Default: ) none | string Single IP address for the initiator instead of specifying a whole address pool. address-pool ( ; none | string Default: )Name of the address pool from which the responder will try to assign address if mode-config is enabled. address-prefix-length (integer ; Default: ) [1..32]Prefix length (netmask) of the assigned address from the pool. comment ( ; Default: ) string

name ( ; Default: ) string responder ( ; Default: ) yes | no no Specifies whether the configuration will work as an initiator (client) or responder (server). The initiator will request for mode-config parameters from the responder. split-dns List of DNS names that will be resolved using a system-dns=yes or static-dns= setting. split-include ( ; list of IP prefix Default: )List of subnets in CIDR format, which to tunnel. Subnets will be sent to the peer using the CISCO UNITY extension, a remote peer will create specific dynamic policies. src-address-list ( ; address list Default: )Specifying an address list will generate dynamic source NAT rules. This parameter is only available with responder=no. A roadWarrior client with NAT static-dns ( ; Default: ) list of IP Manually specified DNS server's IP address to be sent to the client. system-dns ( ; Default: ) yes | no When this option is enabled DNS addresses will be taken from . /ip dns Read-only properties Property Description default ( ) yes | no Whether this is a default system entry. Installed SAs This menu provides information about installed security associations including the keys. Read-only properties Property Description AH ( ) yes | no Whether AH protocol is used by this SA. ESP ( ) yes | no Whether ESP protocol is used by this SA. add-lifetime ( ) time/time Added lifetime for the SA in format soft/hard: soft - time period after which IKE will try to establish new SA; hard - time period after which SA is deleted. addtime ( )time Date and time when this SA was added. auth-algorithm ( ) md5 | null | sha1 | ... Currently used authentication algorithm. auth-key ( ) string Used authentication key. current-bytes ( ) 64-bit integer A number of bytes seen by this SA. dst-address ()IP The destination address of this SA. Not all IKE implementations support multiple split networks provided by the split-include option. If RouterOS client is initiator, it will always send CISCO UNITY extension, and RouterOS supports only split-include from this extension. Both attributes Cisco Unity Split DNS (attribute type 28675) and RFC8598 (attribute type 25) are supported, ROS will answer to these attributes but only as responder. It is not possible to use system-dns and static-dns at the same time, ROS can use only one DNS.

enc-algorithm ( ) des | 3des | aes-cbc | ... Currently used encryption algorithm. enc-key ( ) string Used encryption key. enc-key-size ( ) number Used encryption key length. expires-in ( ) yes | no Time left until rekeying. hw-aead ( ) yes | no Whether this SA is hardware accelerated. replay ( ) integer Size of replay window in bytes. spi ( ) string Security Parameter Index identification tag src-address ()IP The source address of this SA. state ( ) string Shows the current state of the SA ("mature", "dying" etc) Commands Property Description flush () Manually removes all installed security associations. Keys This menu lists all imported public and private keys, that can be used for peer authentication. Menu has several commands to work with keys. Properties Property Description name ( ; Default: ) string Read-only properties Property Description key-size ( ) 1024 | 2048 | 4096 Size of this key. private-key ( ) yes | no Whether this is a private key. rsa ( ) yes | no Whether this is an RSA key. Commands Property Description export-pub-key ( ) file-name; key Export public key to file from one of existing private keys. generate-key ( ) key-size; name Generate a private key. Takes two parameters, name of the newly generated key and key size 1024,2048 and 4096. import ( ) file-name; name Import key from file. Settings

Property Description accounting ( ; yes | no Default: )Whether to send RADIUS accounting requests to a RADIUS server. Applicable if EAP Radius (auth-method=eap-radius) or pre- shared key with XAuth authentication method (auth-method=pre-shared-key-xauth) is used. interim-update ( ;time Default: )The interval between each consecutive RADIUS accounting Interim update. Accounting must be enabled. xauth-use-radius (ye ; Default: ) s | noWhether to use Radius client for XAuth users or not. roperty is only applicable to peers using the exchange mode. P IKEv1 Application Guides RoadWarrior client with NAT Consider setup as illustrated below. RouterOS acts as a RoadWarrior client connected to Office allowing access to its internal resources. A tunnel is established, a local mode-config IP address is received and a set of dynamic policies are generated. [admin@mikrotik] > ip ipsec policy print Flags: T - template, X - disabled, D - dynamic, I - invalid, A - active, * - default 0 T * group=default src-address=::/0 dst-address=::/0 protocol=all proposal=default template=yes 1 DA src-address=192.168.77.254/32 src-port=any dst-address=10.5.8.0/24 dst-port=any protocol=all action=encrypt level=unique ipsec-protocols=esp tunnel=yes sa-src-address=10.155.107.8 sa-dst-address=10.155.107.9 proposal=default ph2-count=1 2 DA src-address=192.168.77.254/32 src-port=any dst-address=192.168.55.0/24 dst-port=any protocol=all action=encrypt level=unique ipsec-protocols=esp tunnel=yes sa-src-address=10.155.107.8 sa-dst-address=10.155.107.9 proposal=default ph2-count=1 Currently, only packets with a source address of 192.168.77.254/32 will match the IPsec policies. For a local network to be able to reach remote subnets, it is necessary to change the source address of local hosts to the dynamically assigned mode config IP address. It is possible to generate source NAT rules dynamically. This can be done by creating a new address list that contains all local networks that the NAT rule should be applied. In our case, it is 192.168.88.0/24.

/ip firewall address-list add address=192.168.88.0/24 list=local-RW By specifying the address list under the mode-config initiator configuration, a set of source NAT rules will be dynamically generated. /ip ipsec mode-config set [ find name="request-only" ] src-address-list=local-RW When the IPsec tunnel is established, we can see the dynamically created source NAT rules for each network. Now every host in 192.168.88.0/24 is able to access Office's internal resources. [admin@mikrotik] > ip firewall nat print Flags: X - disabled, I - invalid, D - dynamic 0 D ;;; ipsec mode-config chain=srcnat action=src-nat to-addresses=192.168.77.254 dst-address=192.168.55.0/24 src-address-list=local-RW 1 D ;;; ipsec mode-config chain=srcnat action=src-nat to-addresses=192.168.77.254 dst-address=10.5.8.0/24 src-address-list=local-RW Allow only IPsec encapsulated traffic There are some scenarios where for security reasons you would like to drop access from/to specific networks if incoming/outgoing packets are not encrypted. For example, if we have L2TP/IPsec setup we would want to drop nonencrypted L2TP connection attempts. There are several ways how to achieve this: Using IPsec policy matcher in firewall; Using generic IPsec policy with action set to and lower priority (can be used in Road Warrior setups where dynamic policies are generated); drop By setting DSCP or priority in mangle and matching the same values in firewall after decapsulation. IPsec policy matcher Let's set up an IPsec policy matcher to accept all packets that matched any of the IPsec policies and drop the rest: add chain=input comment="ipsec policy matcher" in-interface=WAN ipsec-policy=in,ipsec add action=drop chain=input comment="drop all" in-interface=WAN log=yes IPsec policy matcher takes two parameters direction, policy . We used incoming direction and IPsec policy. IPsec policy option allows us to inspect packets after decapsulation, so for example, if we want to allow only GRE encapsulated packet from a specific source address and drop the rest we could set up the following rules: add chain=input comment="ipsec policy matcher" in-interface=WAN ipsec-policy=in,ipsec protocol=gre src=address=192.168.33.1 add action=drop chain=input comment="drop all" in-interface=WAN log=yes For L2TP rule set would be: add chain=input comment="ipsec policy matcher" in-interface=WAN ipsec-policy=in,ipsec protocol=udp dst-port=1701 add action=drop chain=input protocol=udp dst-port=1701 comment="drop l2tp" in-interface=WAN log=yes Using generic IPsec policy The trick of this method is to add a default policy with an action drop. Let's assume we are running an L2TP/IPsec server on a public 1.1.1.1 address and we want to drop all nonencrypted L2TP: /ip ipsec policy add src-address=1.1.1.1 dst-address=0.0.0.0/0 sa-src-address=1.1.1.1 protocol=udp src-port=1701 tunnel=yes action=discard

Now router will drop any L2TP unencrypted incoming traffic, but after a successful L2TP/IPsec connection dynamic policy is created with higher priority than it is on default static rule, and packets matching that dynamic rule can be forwarded. [admin@rack2_10g1] /ip ipsec policy> print Flags: T - template, X - disabled, D - dynamic, I - inactive, * - default 0 T * group=default src-address=::/0 dst-address=::/0 protocol=all proposal=default template=yes 1 D src-address=1.1.1.1/32 src-port=1701 dst-address=10.5.130.71/32 dst-port=any protocol=udp action=encrypt level=require ipsec-protocols=esp tunnel=no sa-src-address=1.1.1.1 sa-dst-address=10.5.130.71 2 src-address=1.1.1.1/32 src-port=1701 dst-address=0.0.0.0/0 dst-port=any protocol=udp action=discard level=unique ipsec-protocols=esp tunnel=yes sa-src-address=1.1.1.1 sa-dst-address=0.0.0.0 proposal=default manual-sa=none Manually specifying local-address parameter under Peer configuration Using different routing table IPsec, as any other service in RouterOS, uses the main routing table regardless of what local-address parameter is used for Peer configuration. It is necessary to apply routing marks to both IKE and IPSec traffic. Consider the following example. There are two default routes - one in the main routing table and another in the routing table "backup". It is necessary to use the backup link for the IPsec site to site tunnel. [admin@pair_r1] > /ip route print detail Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit 0 A S dst-address=0.0.0.0/0 gateway=10.155.107.1 gateway-status=10.155.107.1 reachable via ether1 distance=1 scope=30 target-scope=10 routing-mark=backup 1 A S dst-address=0.0.0.0/0 gateway=172.22.2.115 gateway-status=172.22.2.115 reachable via ether2 distance=1 scope=30 target-scope=10 2 ADC dst-address=10.155.107.0/25 pref-src=10.155.107.8 gateway=ether1 gateway-status=ether1 reachable distance=0 scope=10 3 ADC dst-address=172.22.2.0/24 pref-src=172.22.2.114 gateway=ether2 gateway-status=ether2 reachable distance=0 scope=10 4 ADC dst-address=192.168.1.0/24 pref-src=192.168.1.1 gateway=bridge-local gateway-status=ether2 reachable distance=0 scope=10 [admin@pair_r1] > /ip firewall nat print Flags: X - disabled, I - invalid, D - dynamic 0 chain=srcnat action=masquerade out-interface=ether1 log=no log-prefix="" 1 chain=srcnat action=masquerade out-interface=ether2 log=no log-prefix="" IPsec peer and policy configurations are created using the backup link's source address, as well as the NAT bypass rule for IPsec tunnel traffic. Policy order is important! For this to work, make sure the static drop policy is below the dynamic policies. Move it below the policy template if necessary.

/ip ipsec peer add address=10.155.130.136/32 local-address=10.155.107.8 secret=test /ip ipsec policy add sa-src-address=10.155.107.8 src-address=192.168.1.0/24 dst-address=172.16.0.0/24 sa-dst-address=10. 155.130.136 tunnel=yes /ip firewall nat add action=accept chain=srcnat src-address=192.168.1.0/24 dst-address=172.16.0.0/24 place-before=0 Currently, we see "phase1 negotiation failed due to time up" errors in the log. It is because IPsec tries to reach the remote peer using the main routing table with an incorrect source address. It is necessary to mark UDP/500, UDP/4500, and ipsec-esp packets using Mangle: /ip firewall mangle add action=mark-connection chain=output connection-mark=no-mark dst-address=10.155.130.136 dst-port=500,4500 new-connection-mark=ipsec passthrough=yes protocol=udp add action=mark-connection chain=output connection-mark=no-mark dst-address=10.155.130.136 new-connection- mark=ipsec passthrough=yes protocol=ipsec-esp add action=mark-routing chain=output connection-mark=ipsec new-routing-mark=backup passthrough=no Using the same routing table with multiple IP addresses Consider the following example. There are multiple IP addresses from the same subnet on the public interface. Masquerade rule is configured on out- interface. It is necessary to use one of the IP addresses explicitly. [admin@pair_r1] > /ip address print Flags: X - disabled, I - invalid, D - dynamic # ADDRESS NETWORK INTERFACE 0 192.168.1.1/24 192.168.1.0 bridge-local 1 172.22.2.1/24 172.22.2.0 ether1 2 172.22.2.2/24 172.22.2.0 ether1 3 172.22.2.3/24 172.22.2.0 ether1 [admin@pair_r1] > /ip route print Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, B - blackhole, U - unreachable, P - prohibit # DST-ADDRESS PREF-SRC GATEWAY DISTANCE 1 A S 0.0.0.0/0 172.22.2.115 1 3 ADC 172.22.2.0/24 172.22.2.1 ether1 0 4 ADC 192.168.1.0/24 192.168.1.1 bridge-local 0 [admin@pair_r1] /ip firewall nat> print Flags: X - disabled, I - invalid, D - dynamic 0 chain=srcnat action=masquerade out-interface=ether1 log=no log-prefix="" IPsec peer and policy configuration is created using one of the public IP addresses. /ip ipsec peer add address=10.155.130.136/32 local-address=172.22.2.3 secret=test /ip ipsec policy add sa-src-address=172.22.2.3 src-address=192.168.1.0/24 dst-address=172.16.0.0/24 sa-dst-address=10. 155.130.136 tunnel=yes /ip firewall nat add action=accept chain=srcnat src-address=192.168.1.0/24 dst-address=172.16.0.0/24 place-before=0 Currently, the phase 1 connection uses a different source address than we specified, and "phase1 negotiation failed due to time up" errors are shown in the logs. This is because masquerade is changing the source address of the connection to match the pref-src address of the connected route. The solution is to exclude connections from the public IP address from being masqueraded. /ip firewall nat add action=accept chain=srcnat protocol=udp src-port=500,4500 place-before=0

Application examples Site to Site IPsec (IKEv1) tunnel Consider setup as illustrated below. Two remote office routers are connected to the internet and office workstations are behind NAT. Each office has its own local subnet, 10.1.202.0/24 for Office1 and 10.1.101.0/24 for Office2. Both remote offices need secure tunnels to local networks behind routers. Site 1 configuration profile proposal Start off by creating a new Phase 1 and Phase 2 entries using stronger or weaker encryption parameters that suit your needs. It is advised to create separate entries for each menu so that they are unique for each peer in case it is necessary to adjust any of the settings in the future. These parameters must match between the sites or else the connection will not establish. /ip ipsec profile add dh-group=modp2048 enc-algorithm=aes-128 name=ike1-site2 /ip ipsec proposal add enc-algorithms=aes-128-cbc name=ike1-site2 pfs-group=modp2048 Continue by configuring a peer address . Specify the of the remote router. This address should be reachable through UDP/500 and UDP/4500 ports, so name profile make sure appropriate actions are taken regarding the router's firewall. Specify the for this peer as well as the newly created . /ip ipsec peer add address=192.168.80.1/32 name=ike1-site2 profile=ike1-site2 The next step is to create an identity secret peer . For a basic pre-shared key secured tunnel, there is nothing much to set except for a strong and the to which this identity applies. /ip ipsec identity add peer=ike1-site2 secret=thisisnotasecurepsk If security matters, consider using IKEv2 and a different auth-method .

Lastly, create a policy that controls the networks/hosts between whom traffic should be encrypted. /ip ipsec policy add src-address=10.1.202.0/24 src-port=any dst-address=10.1.101.0/24 dst-port=any tunnel=yes action=encrypt proposal=ike1-site2 peer=ike1-site2 Site 2 configuration profile proposal Office 2 configuration is almost identical to Office 1 with proper IP address configuration. Start off by creating a new Phase 1 and Phase 2 e ntries: /ip ipsec profile add dh-group=modp2048 enc-algorithm=aes-128 name=ike1-site1 /ip ipsec proposal add enc-algorithms=aes-128-cbc name=ike1-site1 pfs-group=modp2048 Next is the peer identity:and /ip ipsec peer add address=192.168.90.1/32 name=ike1-site1 profile=ike1-site1 /ip ipsec identity add peer=ike1-site1 secret=thisisnotasecurepsk When it is done, create a policy : /ip ipsec policy add src-address=10.1.101.0/24 src-port=any dst-address=10.1.202.0/24 dst-port=any tunnel=yes action=encrypt proposal=ike1-site1 peer=ike1-site1 At this point, the tunnel should be established and two IPsec Security Associations should be created on both routers: /ip ipsec active-peers print installed-sa print NAT and Fasttrack Bypass At this point if you try to send traffic over the IPsec tunnel, it will not work, packets will be lost. This is because both routers have NAT rules (masquerade) that are changing source addresses before a packet is encrypted. A router is unable to encrypt the packet because the source address does not match the address specified in the policy configuration. For more information see IPsec packet flow example. the To fix this we need to set up IP/Firewall/NAT bypass rule. Office 1 router: /ip firewall nat add chain=srcnat action=accept place-before=0 src-address=10.1.202.0/24 dst-address=10.1.101.0/24 Office 2 router: /ip firewall nat add chain=srcnat action=accept place-before=0 src-address=10.1.101.0/24 dst-address=10.1.202.0/24

It is very important that the bypass rule is placed at the top of all other NAT rules. Another issue is if you have IP/Fasttrack enabled, the packet bypasses IPsec policies. So we need to add accept rule before FastTrack. /ip firewall filter add chain=forward action=accept place-before=1 src-address=10.1.101.0/24 dst-address=10.1.202.0/24 connection-state=established,related add chain=forward action=accept place-before=1 src-address=10.1.202.0/24 dst-address=10.1.101.0/24 connection-state=established,related However, this can add a significant load to the router's CPU if there is a fair amount of tunnels and significant traffic on each tunnel. The solution is to use IP/Firewall/Raw to bypass connection tracking, that way eliminating the need for filter rules listed above and reducing the load on CPU by approximately 30%. /ip firewall raw add action=notrack chain=prerouting src-address=10.1.101.0/24 dst-address=10.1.202.0/24 add action=notrack chain=prerouting src-address=10.1.202.0/24 dst-address=10.1.101.0/24 Site to Site GRE tunnel over IPsec (IKEv2) using DNS This example explains how it is possible to establish a secure and encrypted GRE tunnel between two RouterOS devices when one or both sites do not have a static IP address. Before making this configuration possible, it is necessary to have a DNS name assigned to one of the devices which will act as a IP/Cloud responder (server). For simplicity, we will use RouterOS built-in DDNS service . Site 1 (server) configuration This is the side that will listen to incoming connections and act as a responder. We will use mode config to provide an IP address for the second site, but first, create a loopback (blank) bridge and assign an IP address to it that will be used later for GRE tunnel establishment. If you previously tried to establish an IP connection before the NAT bypass rule was added, you have to clear the connection table from the existing connection or restart both routers.

/interface bridge add name=loopback /ip address add address=192.168.99.1 interface=loopback Continuing with the IPsec configuration, start off by creating a new Phase 1 profile proposal and Phase 2 entries using stronger or weaker encryption parameters that suit your needs. Note that this configuration example will listen to all incoming IKEv2 requests, meaning the profile configuration will be shared between all other configurations (e.g. RoadWarrior). /ip ipsec profile add dh-group=ecp256,modp2048,modp1024 enc-algorithm=aes-256,aes-192,aes-128 name=ike2 /ip ipsec proposal add auth-algorithms=null enc-algorithms=aes-128-gcm name=ike2-gre pfs-group=none Next, create a new mode config responder=yes entry with . This will provide an IP configuration for the other site as well as the host (loopback address) for policy generation. /ip ipsec mode-config add address=192.168.99.2 address-prefix-length=32 name=ike2-gre split-include=192.168.99.1/32 system-dns=no It is advised to create a new policy group to separate this configuration from any existing or future IPsec configuration. /ip ipsec policy group add name=ike2-gre Now it is time to set up a new policy template that will match the remote peers new dynamic address and the loopback address. /ip ipsec policy add dst-address=192.168.99.2/32 group=ike2-gre proposal=ike2-gre src-address=192.168.99.1/32 template=yes The next step is to create a peer configuration that will listen to all IKEv2 requests. If you already have such an entry, you can skip this step. /ip ipsec peer add exchange-mode=ike2 name=ike2 passive=yes profile=ike2 Lastly, set up an identity secret that will match our remote peer by pre-shared-key authentication with a specific . /ip ipsec identity add generate-policy=port-strict mode-config=ike2-gre peer=ike2 policy-template-group=ike2-gre secret=test The server side is now configured and listening to all IKEv2 requests. Please make sure the firewall is not blocking UDP/4500 port. The last step is to create the GRE interface itself. This can also be done later when an IPsec connection is established from the client-side. /interface gre add local-address=192.168.99.1 name=gre-tunnel1 remote-address=192.168.99.2 Configure IP address and route to remote network through GRE interface. /ip address add address=172.16.1.1/30 interface=gre-tunnel1 /ip route add dst-network=10.1.202.0/24 gateway=172.16.1.2 Site 2 (client) configuration

profile proposal Similarly to server configuration, start off by creating a new Phase 1 and Phase 2 configurations. Since this site will be the initiator, we can use a more specific profile configuration to control which exact encryption parameters are used, just make sure they overlap with what is configured on the server-side. /ip ipsec profile add dh-group=ecp256 enc-algorithm=aes-256 name=ike2-gre /ip ipsec proposal add auth-algorithms=null enc-algorithms=aes-128-gcm name=ike2-gre pfs-group=none Next, create a new mode config responder=no entry with . This will make sure the peer requests IP and split-network configuration from the server. /ip ipsec mode-config add name=ike2-gre responder=no It is also advised to create a new policy group to separate this configuration from any existing or future IPsec configuration. /ip ipsec policy group add name=ike2-gre Create a new policy template on the client-side as well. /ip ipsec policy add dst-address=192.168.99.1/32 group=ike2-gre proposal=ike2-gre src-address=192.168.99.2/32 template=yes Move on to peer address configuration. Now we can specify the DNS name for the server under the parameter. Obviously, you can use an IP address as well. /ip ipsec peer add address=n.mynetname.net exchange-mode=ike2 name=p1.ez profile=ike2-gre Lastly, create an identity for our newly created peers. /ip ipsec identity add generate-policy=port-strict mode-config=ike2-gre peer=p1.ez policy-template-group=ike2-gre secret=test If everything was done properly, there should be a new dynamic policy present. /ip ipsec policy print Flags: T - template, X - disabled, D - dynamic, I - invalid, A - active, * - default 0 T * group=default src-address=::/0 dst-address=::/0 protocol=all proposal=default template=yes 1 T group=ike2-gre src-address=192.168.99.2/32 dst-address=192.168.99.1/32 protocol=all proposal=ike2-gre template=yes 2 DA src-address=192.168.99.2/32 src-port=any dst-address=192.168.99.1/32 dst-port=any protocol=all action=encrypt level=unique ipsec-protocols=esp tunnel=yes sa-src-address=192.168.90.1 sa-dst-address=(current IP of n.mynetname.net) proposal=ike2-gre ph2- count=1 A secure tunnel is now established between both sites which will encrypt all traffic between 192.168.99.2 <=> 192.168.99.1 addresses. We can use these addresses to create a GRE tunnel. /interface gre add local-address=192.168.99.2 name=gre-tunnel1 remote-address=192.168.99.1 Configure IP address and route to remote network through GRE interface.

/ip address add address=172.16.1.2/30 interface=gre-tunnel1 /ip route add dst-network=10.1.101.0/24 gateway=172.16.1.1 Road Warrior setup using IKEv2 with RSA authentication This example explains how to establish a secure IPsec connection between a device connected to the Internet (road warrior client) and a device running RouterOS acting as a server. RouterOS server configuration Before configuring IPsec, it is required to set up certificates. It is possible to use a separate Certificate Authority for certificate management, however in this example, self-signed certificates are generated in RouterOS System/Certificates menu. Some certificate requirements should be met to connect various devices to the server: Common name should contain IP or DNS name of the server; SAN (subject alternative name) should have IP or DNS of the server; EKU (extended key usage) tls-server and tls-client are required. Considering all requirements above, generate CA and server certificates: /certificate add common-name=ca name=ca sign ca ca-crl-host=2.2.2.2 add common-name=2.2.2.2 subject-alt-name=IP:2.2.2.2 key-usage=tls-server name=server1 sign server1 ca=ca Now that valid certificates are created on the router, add a new Phase 1 profile proposal pfs-group=none: and Phase 2 entries with /ip ipsec profile add name=ike2 /ip ipsec proposal add name=ike2 pfs-group=none Mode config IP/Pools: is used for address distribution from

/ip pool add name=ike2-pool ranges=192.168.77.2-192.168.77.254 /ip ipsec mode-config add address-pool=ike2-pool address-prefix-length=32 name=ike2-conf Since that the policy template must be adjusted to allow only specific network policies group , it is advised to create a separate policy and template. /ip ipsec policy group add name=ike2-policies /ip ipsec policy add dst-address=192.168.77.0/24 group=ike2-policies proposal=ike2 src-address=0.0.0.0/0 template=yes Create a new IPsec peer entry that will listen to all incoming IKEv2 requests. /ip ipsec peer add exchange-mode=ike2 name=ike2 passive=yes profile=ike2 Identity configuration menu allows to match specific remote peers and assign different configurations for each one of them. First, create a default identity, that will The identity accept all peers, but will verify the peer's identity with its certificate. /ip ipsec identity add auth-method=digital-signature certificate=server1 generate-policy=port-strict mode-config=ike2-conf peer=ike2 policy-template-group=ike2-policies For example, we want to assign a different mode config for user "A", who uses certificate "rw-client1" to authenticate itself to the server. First of all, make sure a new mode config is created and ready to be applied for the specific user. /ip ipsec mode-config add address=192.168.66.2 address-prefix-length=32 name=usr_A split-include=192.168.55.0/24 system-dns=no It is possible to apply this configuration for user "A" by using the match-by=certificate remote-certificate parameter and specifying his certificate with . /ip ipsec identity add auth-method=digital-signature certificate=server1 generate-policy=port-strict match-by=certificate mode- config=usr_A peer=ike2 policy-template-group=ike2-policies remote-certificate=rw-client1 (Optional) Split tunnel configuration Split tunneling is a method that allows road warrior clients to only access a specific secured network and at the same time send the rest of the traffic based on their internal routing table (as opposed to sending all traffic over the tunnel). To configure split tunneling, changes to mode config parameters are needed. For example, we will allow our road warrior clients to only access the 10.5.8.0/24 network. /ip ipsec mode-conf set [find name="rw-conf"] split-include=10.5.8.0/24 It is also possible to send a specific DNS server for the client to use. By default, system-dns=yes is used, which sends DNS servers that are configured on IP/DNS static-dns the router itself in . We can force the client to use a different DNS server by using the parameter. If the peer's ID (ID_i) is not matching with the certificate it sends, the identity lookup will fail. See remote-id identities in the section.

/ip ipsec mode-conf set [find name="rw-conf"] system-dns=no static-dns=10.5.8.1 While it is possible to adjust the IPsec policy template to only allow road warrior clients to generate policies split-include to network configured by parameter known limitations , this can cause compatibility issues with different vendor implementations (see ). Instead of adjusting the policy template, allow access to IP/Firewall/Filter a secured network in and drop everything else. /ip firewall filter add action=drop chain=forward src-address=192.168.77.0/24 dst-address=!10.5.8.0/24 Generating client certificates To generate a new certificate for the client and sign it with a previously created CA. /certificate add common-name=rw-client1 name=rw-client1 key-usage=tls-client sign rw-client1 ca=ca PKCS12 format is accepted by most client implementations, so when exporting the certificate, make sure PKCS12 is specified. /certificate export-certificate rw-client1 export-passphrase=1234567890 type=pkcs12 A file named is now located in the routers System/File section. This file should be securely transported to the client's device. cert_export_rw-client1.p12 Typically PKCS12 bundle contains also a CA certificate, but some vendors may not install this CA, so a self-signed CA certificate must be exported separately using PEM format. /certificate export-certificate ca type=pem A file named is now located in the routers System/File section. This file should also be securely transported to the client's device. cert_export_ca.crt PEM is another certificate format for use in client software that does not support PKCS12. The principle is pretty much the same. /certificate export-certificate ca export-certificate rw-client1 export-passphrase=1234567890 Three files are now located in the routers Files section: cert_export_ca.crt , cert_export_rw-client1.crt and cert_export_rw-client1.key which should be securely transported to the client device. Known limitations Here is a list of known limitations by popular client software IKEv2 implementations. Windows will always ignore networks received by split-include and request policy with destination 0.0.0.0/0 (TSr). When IPsec-SA is generated, Windows requests DHCP option 249 to which RouterOS will respond with configured split-include networks automatically. Both Apple macOS and iOS will only accept the first split-include network. Both Apple macOS and iOS will use the DNS servers from system-dns andstatic-dns parameters only when 0.0.0.0/0 split-include is used. While some implementations can make use of different PFS group for phase 2, it is advised to use pfs-group=none under proposals to avoid any compatibility issues. Split networking is not a security measure. The client (initiator) can still request a different Phase 2 traffic selector.

RouterOS client configuration Import a PKCS12 format certificate in RouterOS. /certificate import file-name=cert_export_RouterOS_client.p12 passphrase=1234567890 There should now be the self-signed CA certificate and the client certificate in the Certificate menu. Find out the name of the client certificate. /certificate print cert_export_RouterOS_client.p12_0 is the client certificate. It is advised to create a separate Phase 1 profile and Phase 2 proposal configurations to not interfere with any existing IPsec configuration. /ip ipsec profile add name=ike2-rw /ip ipsec proposal add name=ike2-rw pfs-group=none While it is possible to use the default policy group template for policy generation, it is better to create a new policy and template to separate this configuration from any other IPsec configuration. /ip ipsec policy group add name=ike2-rw /ip ipsec policy add group=ike2-rw proposal=ike2-rw template=yes Create a new mode config responder=no entry with that will request configuration parameters from the server. /ip ipsec mode-config add name=ike2-rw responder=no Lastly, create peer identityand configurations. /ip ipsec peer add address=2.2.2.2/32 exchange-mode=ike2 name=ike2-rw-client /ip ipsec identity add auth-method=digital-signature certificate=cert_export_RouterOS_client.p12_0 generate-policy=port-strict mode-config=ike2-rw peer=ike2-rw-client policy-template-group=ike2-rw Verify that the connection is successfully established. /ip ipsec active-peers print installed-sa print Enabling dynamic source NAT rule generation If we look at the generated dynamic policies, we see that only traffic with a specific (received by mode config) source address will be sent through the tunnel. But a router in most cases will need to route a specific device or network through the tunnel. In such case, we can use source NAT to change the source address of packets to match the mode config address. Since the mode config address is dynamic, it is impossible to create a static source NAT rule. In RouterOS, it is possible to generate dynamic source NAT rules for mode config clients.

Currently, Windows 10 is compatible with the following Phase 1 ( profiles proposals ) and Phase 2 ( ) proposal sets: Phase 1 Hash Algorithm Encryption Algorithm DH Group SHA1 3DES modp1024 SHA256 3DES modp1024 SHA1 AES-128-CBC modp1024 SHA256 AES-128-CBC modp1024 SHA1 AES-192-CBC modp1024 SHA256 AES-192-CBC modp1024 SHA1 AES-256-CBC modp1024 SHA256 AES-256-CBC modp1024 SHA1 AES-128-GCM modp1024 SHA256 AES-128-GCM modp1024 SHA1 AES-256-GCM modp1024 SHA256 AES-256-GCM modp1024 Phase 2 Hash Algorithm Encryption Algorithm PFS Group SHA1 AES-256-CBC none SHA1 AES-128-CBC none SHA1 3DES none SHA1 DES none SHA1 none none macOS client configuration Open the PKCS12 format certificate file on the macOS computer and install the certificate in the "System" keychain. It is necessary to mark the CA certificate as trusted manually since it is self-signed. Locate the certificate macOS Keychain Access app under the System tab and mark it as Always Trust.

You can now proceed to System Preferences -> Network and add a new configuration by clicking the + button. Select Interface: VPN, VPN Type: IKEv2 and name your connection. Remote ID must be set equal to common-name or subjAltName of server's certificate. Local ID can be left blank. Under Authentication Settings select None and choose the client certificate. You can now test the connectivity. Currently, macOS is compatible with the following Phase 1 ( profiles) and Phase 2 ( proposals) proposal sets: Phase 1 Hash Algorithm Encryption Algorithm DH Group SHA256 AES-256-CBC modp2048 SHA256 AES-256-CBC ecp256 SHA256 AES-256-CBC modp1536 SHA1 AES-128-CBC modp1024 SHA1 3DES modp1024

Phase 2 Hash Algorithm Encryption Algorithm PFS Group SHA256 AES-256-CBC none SHA1 AES-128-CBC none SHA1 3DES none iOS client configuration Typically PKCS12 bundle contains also a CA certificate, but iOS does not install this CA, so a self-signed CA certificate must be installed separately using PEM format. Open these files on the iOS device and install both certificates by following the instructions. It is necessary to mark the self-signed CA certificate as trusted on the iOS device. This can be done in Settings -> General -> About -> Certificate Trust Settings menu. When it is done, check whether both certificates are marked as "verified" under the Settings -> General -> Profiles menu. You can now proceed to Settings -> General -> VPN menu and add a new configuration. Remote ID must be set equal to common-name or subjAltName of server's certificate. Local ID can be left blank.

Currently, iOS is compatible with the following Phase 1 ( profiles) and Phase 2 ( proposals) proposal sets: Phase 1 Hash Algorithm Encryption Algorithm DH Group SHA256 AES-256-CBC modp2048 SHA256 AES-256-CBC ecp256 SHA256 AES-256-CBC modp1536

SHA1 AES-128-CBC modp1024 SHA1 3DES modp1024 Phase 2 Hash Algorithm Encryption Algorithm PFS Group SHA256 AES-256-CBC none SHA1 AES-128-CBC none SHA1 3DES none Android (strongSwan) client configuration Currently, there is no IKEv2 native support in Android, however, it is possible to use strongSwan from Google Play Store which brings IKEv2 to Android. StrongSwan accepts PKCS12 format certificates, so before setting up the VPN connection in strongSwan, make sure you download the PKCS12 bundle to your Android device. When it is done, create a new VPN profile in strongSwan, type in the server IP, and choose "IKEv2 Certificate" as VPN Type. When selecting a User certificate, press Install and follow the certificate extract procedure by specifying the PKCS12 bundle. Save the profile and test the connection by pressing on the VPN profile. It is possible to specify custom encryption settings in strongSwan by ticking the "Show advanced settings" checkbox. Currently, strongSwan by default is compatible with the following Phase 1 ( profiles) and Phase 2 ( proposals) proposal sets: Phase 1 Hash Algorithm Encryption Algorithm DH Group SHA* AES-*-CBC modp2048 SHA* AES-*-CBC ecp256 SHA* AES-*-CBC ecp384 SHA* AES-*-CBC ecp521 SHA* AES-*-CBC modp3072 SHA* AES-*-CBC modp4096 SHA* AES-*-CBC modp6144 SHA* AES-*-CBC modp8192 SHA* AES-*-GCM modp2048 If you are connected to the VPN over WiFi, the iOS device can go into sleep mode and disconnect from the network.

SHA* AES-*-GCM ecp256 SHA* AES-*-GCM ecp384 SHA* AES-*-GCM ecp521 SHA* AES-*-GCM modp3072 SHA* AES-*-GCM modp4096 SHA* AES-*-GCM modp6144 SHA* AES-*-GCM modp8192 Phase 2 Hash Algorithm Encryption Algorithm PFS Group none AES-256-GCM none none AES-128-GCM none SHA256 AES-256-CBC none SHA512 AES-256-CBC none SHA1 AES-256-CBC none SHA256 AES-192-CBC none SHA512 AES-192-CBC none SHA1 AES-192-CBC none SHA256 AES-128-CBC none SHA512 AES-128-CBC none SHA1 AES-128-CBC none Linux (strongSwan) client configuration Download the PKCS12 certificate bundle and move it to /etc/ipsec.d/private directory. Add exported passphrase for the private key to /etc/ipsec.secrets file where "strongSwan_client.p12" is the file name and "1234567890" is the passphrase. : P12 strongSwan_client.p12 "1234567890" Add a new connection to /etc/ipsec.conf file conn "ikev2" keyexchange=ikev2 ike=aes128-sha1-modp2048 esp=aes128-sha1 leftsourceip=%modeconfig leftcert=strongSwan_client.p12 leftfirewall=yes right=2.2.2.2 rightid="CN=2.2.2.2" rightsubnet=0.0.0.0/0 auto=add You can now restart (or start) the ipsec daemon and initialize the connection

1. 2. 3. $ ipsec restart $ ipsec up ikev2 Road Warrior setup using IKEv2 with EAP-MSCHAPv2 authentication handled by User Manager (RouterOS v7) This example explains how to establish a secure IPsec connection between a device connected to the Internet (road warrior client) and a device running RouterOS acting as an IKEv2 server and User Manager. It is possible to run User Manager on a separate device in network, however in this example both User Manager and IKEv2 server will be configured on the same device (Office). RouterOS server configuration Requirements For this setup to work there are several prerequisites for the router: Router's IP address should have a valid public DNS record - IP Cloud could be used to achieve this. Router should be reachable through port TCP/80 over the Internet - if the server is behind NAT, port forwarding should be configured. User Manager package should be installed on the router. Generating Let's Encrypt certificate During the EAP-MSCHAPv2 authentication, TLS handshake has to take place, which means the server has to have a certificate that can be validated by the client. To simplify this step, we will use Let's Encrypt certificate which can be validated by most operating systems without any intervention by the user. To generate the certificate, simply enable SSL certificate under the Certificates menu. By default the command uses the dynamic DNS record provided by IP Cloud, however a custom DNS name can also be specified. Note that, the DNS record should point to the router. /certificate enable-ssl-certificate If the certificate generation succeeded, you should see the Let's Encrypt certificate installed under the Certificates menu. /certificate print detail where name~"letsencrypt" Configuring User Manager

First of all, allow receiving RADIUS requests from the localhost (the router itself): /user-manager router add address=127.0.0.1 comment=localhost name=local shared-secret=test Enable the User Manager and specify the Let's Encrypt certificate (replace the name of the certificate to the one installed on your device) that will be used to authenticate the users. /user-manager set certificate="letsencrypt_2021-04-09T07:10:55Z" enabled=yes Lastly add users and their credentials that clients will use to authenticate to the server. /user-manager user add name=user1 password=password Configuring RADIUS client For the router to use RADIUS server for user authentication, it is required to add a new RADIUS client that has the same shared secret that we already configured on User Manager. /radius add address=127.0.0.1 secret=test service=ipsec IPsec (IKEv2) server configuration Add a new Phase 1 profile proposal pfs-group=none: and Phase 2 entries with /ip ipsec profile add name=ike2 /ip ipsec proposal add name=ike2 pfs-group=none Mode config is used for address distribution from IP/Pools. /ip pool add name=ike2-pool ranges=192.168.77.2-192.168.77.254 /ip ipsec mode-config add address-pool=ike2-pool address-prefix-length=32 name=ike2-conf Since that the policy template must be adjusted to allow only specific network policies, it is advised to create a separate policy group and template. /ip ipsec policy group add name=ike2-policies /ip ipsec policy add dst-address=192.168.77.0/24 group=ike2-policies proposal=ike2 src-address=0.0.0.0/0 template=yes Create a new IPsec peer entry which will listen to all incoming IKEv2 requests. /ip ipsec peer add exchange-mode=ike2 name=ike2 passive=yes profile=ike2 Lastly create a new IPsec identity entry that will match all clients trying to authenticate with EAP. Note that generated Let's Encrypt certificate must be specified.

/ip ipsec identity add auth-method=eap-radius certificate="letsencrypt_2021-04-09T07:10:55Z" generate-policy=port-strict mode- config=ike2-conf peer=ike2 \ policy-template-group=ike2-policies (Optional) Split tunnel configuration Split tunneling is a method that allows road warrior clients to only access a specific secured network and at the same time send the rest of the traffic based on their internal routing table (as opposed to sending all traffic over the tunnel). To configure split tunneling, changes to mode config parameters are needed. For example, we will allow our road warrior clients to only access the 10.5.8.0/24 network. /ip ipsec mode-conf set [find name="rw-conf"] split-include=10.5.8.0/24 It is also possible to send a specific DNS server for the client to use. By default, system-dns=yes is used, which sends DNS servers that are configured on IP/DNS static-dns the router itself in . We can force the client to use a different DNS server by using the parameter. /ip ipsec mode-conf set [find name="rw-conf"] system-dns=no static-dns=10.5.8.1 (Optional) Assigning static IP address to user Static IP address to any user can be assigned by use of RADIUS Framed-IP-Address attribute. /user-manager user set [find name="user1"] attributes=Framed-IP-Address:192.168.77.100 shared-users=1 (Optional) Accounting configuration To keep track of every user's uptime, download and upload statistics, RADIUS accounting can be used. By default RADIUS accounting is already enabled for IPsec, but it is advised to configure Interim Update timer that sends statistic to the RADIUS server regularly. If the router will handle a lot of simultaneous sessions, it is advised to increase the update timer to avoid increased CPU usage. /ip ipsec settings set interim-update=1m Basic L2TP/IPsec setup This example demonstrates how to easily set up an L2TP/IPsec server on RouterOS for road warrior connections (works with Windows, Android, iOS, macOS, and other vendor L2TP/IPsec implementations). RouterOS server configuration The first step is to enable the L2TP server: Split networking is not a security measure. The client (initiator) can still request a different Phase 2 traffic selector. To avoid any conflicts, the static IP address should be excluded from the IP pool of other users, as well as shared-users should be set to 1 for the specific user.

Setting up the IPsec tunnel It is advised to create a separate Phase 1 profile and Phase 2 proposal configurations to not interfere with any existing or future IPsec configuration. /ip ipsec profile add name=NordVPN /ip ipsec proposal add name=NordVPN pfs-group=none While it is possible to use the default policy template for policy generation, it is better to create a new policy group and template to separate this configuration from any other IPsec configuration. /ip ipsec policy group add name=NordVPN /ip ipsec policy add dst-address=0.0.0.0/0 group=NordVPN proposal=NordVPN src-address=0.0.0.0/0 template=yes Create a new mode config entry with responder=no that will request configuration parameters from the server. /ip ipsec mode-config add name=NordVPN responder=no Lastly, create peer and identity configurations. Specify your NordVPN credentials in username and password parameters. /ip ipsec peer add address=lv20.nordvpn.com exchange-mode=ike2 name=NordVPN profile=NordVPN /ip ipsec identity add auth-method=eap certificate="" eap-methods=eap-mschapv2 generate-policy=port-strict mode-config=NordVPN peer=NordVPN policy-template-group=NordVPN username=support@mikrotik.com password=secret Verify that the connection is successfully established. /ip ipsec active-peers print installed-sa print Choosing what to send over the tunnel If we look at the generated dynamic policies, we see that only traffic with a specific (received by mode config) source address will be sent through the tunnel. But a router in most cases will need to route a specific device or network through the tunnel. In such a case, we can use source NAT to change the source address of packets to match the mode config address. Since the mode config address is dynamic, it is impossible to create a static source NAT rule. In RouterOS it is possible to generate dynamic source NAT rules for mode config clients. Option 1: Sending all traffic over the tunnel

L2TP Overview Layer Two Tunneling Protocol "L2TP" extends the PPP model by allowing the L2 and PPP endpoints to reside on different devices interconnected by a packet-switched network. L2TP includes PPP authentication and accounting for each L2TP connection. Full authentication and accounting of each connection may be done through a RADIUS client or locally. L2TP traffic uses UDP protocol for both control and data packets. UDP port 1701 is used only for link establishment, further traffic is using any available UDP port (which may or may not be 1701). This means that L2TP can be used with most firewalls and routers (even with NAT) by enabling UDP traffic to be routed through the firewall or router. standard is defined in L2TP RFC 2661 . The L2TPv3 support added in 7.1 version. Support IPv4, IPv6. Introduction It may be useful to use L2TP just as any other tunneling protocol with or without encryption. The L2TP standard says that the most secure way to encrypt data is using L2TP over IPsec (Note that it is the default mode for Microsoft L2TP client) as all L2TP control and data packets for a particular tunnel appear as homogeneous UDP/IP data packets to the IPsec system. Multilink PPP (MP) is supported in order to provide MRRU (the ability to transmit full-sized 1500 and larger packets) and bridging over PPP links (using Bridge Control Protocol (BCP) that allows sending raw Ethernet frames over PPP links). This way it is possible to setup bridging without EoIP. The bridge should either have an administratively set MAC address or an Ethernet-like interface in it, as PPP links do not have MAC addresses. L2TP Client Properties Property Description add-default-route ( ; Default: ) yes | no no Whether to add L2TP remote address as a default route. allow ( ; mschap2 | mschap1 | chap | pap Default: ) mschap2, mschap1, chap, papAllowed authentication methods. connect-to ( ; Default: ) IP|IPv6 Remote address of L2TP server (if the address is in VRF table, VRF should be specified) /interface l2tp-client add connect-to=192.168.88.1@vrf1 name=l2tp-out1 user=l2tp-client) comment ( ; Default: ) string Short description of the tunnel. default-route-distance ( ; Default: )byte Since v6.2, sets distance value applied to auto created default route, if add-default-route is also selected dial-on-demand ( ; Default: ) yes | no no connects only when outbound traffic is generated. If selected, then route with gateway address from 10.112.112.0/24 network will be added while connection is not established. disabled ( ; Default: ) yes | no yes Enables/disables tunnel. keepalive-timeout (integer [1.. ; Default: ) 4294967295] 60sSince v6.0rc13, tunnel keepalive timeout in seconds. max-mru ( ; Default: ) integer 1450 Maximum Receive Unit. Max packet size that L2TP interface will be able to receive without packet fragmentation. max-mtu ( ; Default: ) integer 1450 Maximum Transmission Unit. Max packet size that L2TP interface will be able to send without packet fragmentation. L2TP does not provide encryption mechanisms for tunneled traffic. IPsec can be used for additional security layers.

mrru ( ; Default: disabled | integer disabled )Maximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. name ( ; Default: ) string Descriptive name of the interface. password ( ; Default: ) string "" Password used for authentication. profile ( ; Default: ) name default-encryption Specifies which PPP profile configuration will be used when establishing the tunnel. user ( ; Default: ) string User name used for authentication. use-ipsec ( ; Default: ) yes | no no When this option is enabled, dynamic IPSec peer configuration and policy (transport mode) is added to encapsulate L2TP connection into IPSec tunnel. allow-fast-path ( ; Default: ) yes | no Allow to forward packets without additional processing in the Linux kernel. l2tp-proto-version ( l2tpv2 | l2tpv3-ip | ; Default: ) l2tpv3-udp | l2tpv l2tpv2Specify protocol version. l2tpv3-cookie-length ( 0 | 4-bytes | 8- ; Default: ) bytes 0Configures an L2TPv3 pseudowire static session cookie. l2tpv3-digest-hash ( ; md5 | none | sha1 Default: )md5Specifies which hash function to be used. use-peer-dns ( ; yes | no | exclusively Default: )noTo use peer dns. copy-from To copy created peer. src-address Specify source address. l2tpv3-circuit-id Set the virtual circuit identifier to bind the one end of the L2TPv3 control channel. ipsec-secret ( ; Default: ) string Preshared key used when use-ipsec is enabled. L2TP Server An interface is created for each tunnel established to the given server. There are two types of interfaces in the L2TP server's configuration Static interfaces are added administratively if there is a need to reference the particular interface name (in firewall rules or elsewhere) created for the particular user; Dynamic interfaces are added to this list automatically whenever a user is connected and its username does not match any existing static entry (or in case the entry is active already, as there can not be two separate tunnel interfaces referenced by the same name); Dynamic interfaces appear when a user connects and disappear once the user disconnects, so it is impossible to reference the tunnel created for that use in router configuration (for example, in firewall), so if you need persistent rules for that user, create a static entry for him/her. Otherwise, it is safe to use a dynamic configuration. Properties Property Description Multiple L2tp/ipsec clients behind the same NAT will not work in this mode. To achieve such scenario, disable use-ipsec and set static policies for clients with enabled tunnel=yes, level=unique settings. in both cases PPP users must be configured properly - static entries do not replace PPP configuration.

authentication (pap | chap | ; mschap1 | mschap2 Default: ) mschap1,mschap2Authentication methods that server will accept. default-profile ( ; name Default: ) default-encryptiondefault profile to use enabled ( ; Default: yes | no no )Defines whether L2TP server is enabled or not. max-mru ( ; Default: integer 1 )450Maximum Receive Unit. Max packet size that L2TP interface will be able to receive without packet fragmentation. keepalive-timeout ( ; integer Default: )30If server during keepalive-timeout period does not receive any packets, it will send keepalive packets every second, five times. If the server still does not receive any response from the client, then the client will be disconnected after 5 seconds. Logs will show 5x "LCP missed echo reply" messages and then disconnect. max-mtu ( ; Default: integer 1 )450Maximum Transmission Unit. Max packet size that L2TP interface will be able to send without packet fragmentation. use-ipsec ( ; no | yes | require Default: )noWhen this option is enabled, dynamic IPSec peer configuration is added to suite most of the L2TP road-warrior setups. When require is selected server will accept only those L2TP connection attempts that were encapsulated in the IPSec tunnel. ipsec-secret ( ; string Default: )Preshared key used when use-ipsec is enabled accept-proto-version ( all | l2tpv2 l2tpv3; Default: ) | all cli-onlySpecify protocol version. accept-pseudowire-type ( all ether ppp; Default: ) | | all Set the pseudowire signaling protocol for specific pseudowire type. allow-fast-path ( ; no | yes Default: )noTo forward packets without additional processing in the Linux kernel. caller-id-type ( ip-address | number; Default: ) ip-addressIf same source IP address is used for multiple clients set id type to number. max-sessions ( unlimited / number; Default: ) unlimitedSet number of needed sessions. one-session-per-host ( no | ; Default: ) yes | noTo allow one session per host. l2tpv3-circuit-id (Default: ) Set the virtual circuit identifier to bind the one end of the L2TPv3 control channel. l2tpv3-cookie-length (0 4-| bytes 8-bytes; Default: ) | 0 Configures an L2TP pseudowire static session cookie. l2tpv3-digest-hash ( md5 n| one sha1; Default: ) | md5Specifies which hash function to be used. l2tpv3-ether-interface-list (Default: )Set your interface list for example the default ones- all, dynamic, none, static. mrru ( ; disabled | integer Default: ) disabledMaximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. Quick Example

local-session-id ( string; Default: disabled)Set value for local-session-id, an integer required. remote-tunnel-id ( string; Default: di sabled)Set value for remote-tunnel-id, an integer required. remote-session-id ( string; Default: disabled)Set value for remote-session-id, an integer required. peer-cookie ( string; Default: disabl ed)Sets optional peer cookie. To enable cookie enter remote cookie value (8 or 16 character hex string value expected) to disable leave empty. send-cookie ( string; Default: disabled)Sets optional cookie. To enable cookie enter remote cookie value (8 or 16 character hex string value expected) to disable leave empty. mtu ( ; Default: ) auto 1420 Maximum Transmission Unit. Max packet size that L2TP interface will be able to send without packet fragmentation. name ( ; Default: ) string Descriptive name of the interface. local-address ( ; Default: IP address )Set local address for mode. unmanaged use-ipsec ( ; Default: ) yes | no no When this option is enabled, dynamic IPSec peer configuration and policy is added to encapsulate L2TP connection into IPSec tunnel. allow-fast-path ( ; Default: yes | no no )Allow to forward packets without additional processing in the Linux kernel. l2tp-proto-version ( l2tpv3-ip | ; Default: ) l2tpv3-udp | l2tpv3-udpSpecify protocol version. cookie-length ( 0 | 4-bytes | 8- ; Default: ) bytes 0Configures an L2TPv3 pseudowire static session cookie. digest-hash ( ; md5 | none | sha1 Default: )md5Specifies which hash function to be used. use-l2-specific-sublayer ( ; yes | no Default: )noSpecify source address. circuit-id Set the virtual circuit identifier to bind the one end of the L2TPv3 control channel, this works as identifier for each redundant pseudowire. ipsec-secret ( ; Default: ) string Preshared key used when use-ipsec is enabled.

LAC and LNS setup with Cisco as LAC Overview Configuration Client LAC LNS Status Check Session Establishment Overview LAC/LNS setup or otherwise known as Virtual Private DialUp Network (VPDN) allows long-distance point-to-point connection between remote dial-up users and private networks. Dial-up client uses PPPOE to connect to a L2TP access concentrator (LAC), LAC determines that session should be forwarded through a IP network to the L2TP Network Server (LNS), creates L2TP tunnel and forwards PPP frames to the server where client is authenticated and session established (see diagram below). At the time of writing this article RouterOS cannot be used in LAC role. For this reason article will demonstrate how to set up very basic network with RouterOS as LNS and Cisco router as LAC. Configuration We will be using simple configuration to demonstrate very basics of VPDN setup. Lets assume that LAC will forward to the LNS clients with FQDN name containing domain. mt.lv Client For the sake of simplicity lets assume that client is RouterOS router: /interface pppoe-client add interface=ether1 user=good_worker@mt.lv password=strongpass LAC Lets assume that client is connected to the GigabitEthernet1 port and IP address of the LNS server is 10.155.101.231

aaa new-model ! aaa authentication ppp default local ! vpdn enable vpdn aaa attribute nas-ip-address vpdn-nas vpdn search-order domain dnis ! vpdn-group LAC request-dialin protocol l2tp domain mt.lv initiate-to ip 10.155.101.231 source-ip 10.155.101.216 local name LAC l2tp tunnel password 0 tunnelpass ! bba-group pppoe MAIN-BBA virtual-template 1 ! interface GigabitEthernet1 pppoe enable group MAIN-BBA ! interface Virtual-Template1 description pppoe MAIN-BBA no ip address no peer default ip address ppp mtu adaptive ppp authentication chap ! Note that this setup does not authenticate client nor locally nor via RADIUS, does not actually check domain name, does not control L2 access for the sake of simplicity. If you want to use those features refer to Cisco configuration manuals. LNS On the LNS we need to enable L2TP server and set up method to authenticate the L2TP connection from the LAC. /interface l2tp-server server set enabled=yes /ppp l2tp-secret add address=10.155.101.216/32 secret=tunnelpass Now the actual user authentication. In this case we will be using local authentication method for the sake of simplicity. /ip pool add name=pool0 ranges=192.168.99.2-192.168.99.99 /ppp profile set default local-address=192.168.99.1 remote-address=pool0 /ppp secret add name=good_worker@mt.lv password=strongpass Status Check On the LNS you can see all successfully connected clients by checking l2tp server interfaces or checking active ppp connections:

[admin@CHR_v6_bgp] /interface l2tp-server> print Flags: X - disabled, D - dynamic, R - running # NAME USER MTU CLIENT-ADDRESS UPTIME ENCODING 0 DR <l2tp-... good_worker@mt.lv 1450 10.155.101.216 6h13m49s [admin@CHR_v6_bgp] /ppp active> print Flags: R - radius # NAME SERVICE CALLER-ID ADDRESS UPTIME ENCODING 0 good_worker@mt.lv l2tp 10.155.101.216 192.168.99.2 6h15m57s On the LAC we can also see active client sessions and active L2TP tunnel between LAC and LNS: csrLAC#show vpdn L2TP Tunnel and Session Information Total tunnels 1 sessions 1 LocTunID RemTunID Remote Name State Remote Address Sessn L2TP Class/ Count VPDN Group 26090 11 CHR_v6_bgp est 10.155.101.231 50 LAC LocID RemID TunID Username, Intf/ State Last Chg Uniq ID Vcid, Circuit 18521 16 26090 good_worker@mt.lv, Gi1 est 06:17:07 571 Session Establishment Lets look closely on how clients sessions gets authenticated and established over the LAC. Client initiates PPPoE call LAC and Client begins LCP negotiation after CHAP has been negotiated, LAC sends CHAP challenge Client sends CHAP response LAC checks whether client session should be forwarded to the LNS based on received domain name. Check can be done locally or using RADIUS server. Client also can be authenticated here before forwarding session. LAC brings up an L2TP tunnel LNS checks if the LAC is allowed to open a tunnel and run the authentication process. The Tunnel is up and ready to forward VPDN sessions. LAC forwards negotiated with the client LCP options, username and password to the LNS LNS authenticates the client locally or using RADIUS and sends CHAP response IP Control Protocol (IPCP) phase is performed, IP addresses and routes are installed. At this point sessions is considered established.

OpenVPN Overview Introduction Limitations OVPN Client Tls-crypt, tls-crypt v2 OVPN Server Server Configuration Properties Example Setup Overview Creating Certificates Server Config Client Config Push Route VRF support Overview The OpenVPN security model is based on SSL, the industry standard for secure communications via the internet. OpenVPN implements OSI layer 2 or 3 secure network extensions using the SSL/TLS protocol. Support IPv4, IPv6. Introduction OpenVPN has been ported to various platforms, including Linux and Windows, and its configuration is likewise on each of these systems, so it makes it easier to support and maintain. OpenVPN can run over User Datagram Protocol (UDP) or Transmission Control Protocol (TCP) transports, multiplexing created SSL tunnels on a single TCP/UDP port. OpenVPN is one of the few VPN protocols that can make use of a proxy, which might be handy sometimes. Limitations Currently, noteable unsupported OpenVPN features: LZO compression OpenVPN username is limited to 27 characters and the password to 233 characters. Password cap increased in 7.18_ab253 to 1000 characters. OVPN Client Property Description add-default-route ( |; Default: ) yes no no Whether to add OVPN remote address as a default route. auth ( | | | | ; Default: ) md5 sha1 null sha256 sha512 sha1 Allowed authentication methods. certificate ( | ; Default: ) string none none Name of the client certificate cipher ( | | | | | null aes128-cbc aes128-gcm aes192-cbc aes192-gcm | | ; Default: ) aes256-cbc aes256-gcm blowfish128 blowfish128Allowed ciphers. In order to use GCM type ciphers, the "auth" parameter must be set to "null", because GCM cipher is also responsible for "auth", if used. comment ( ; Default: ) string Descriptive name of an item connect-to ( ; Default: ) IP|IPv6 Remote address of the OVPN server. disabled ( |; Default: ) yes no yes Whether the interface is disabled or not. By default it is disabled. mac-address ( ; Default: ) MAC Mac address of OVPN interface. Will be automatically generated if not specified.

max-mtu ( ; Default: ) integer 1500 Maximum Transmission Unit. Max packet size that the OVPN interface will be able to send without packet fragmentation. mode (| ; Default: ) ip ethernet ip Layer3 or layer2 tunnel mode (alternatively tun, tap) name ( ; Default: ) string Descriptive name of the interface. password ( ; Default: ) string "" Password used for authentication. port ( ; Default: ) integer 1194 Port to connect to. profile ( ; Default: ) name default Specifies which PPP profile configuration will be used when establishing the tunnel. protocol ( | ; Default: ) tcp udp tcp indicates the protocol to use when connecting with the remote endpoint. verify-server-certificate ( |; Default: ) yes no no Checks the certificates CN or SAN against the "connect-to" parameter. The IP or hostname must be present in the server's certificate. tls-version ( | ; Default: ) any only-1.2 any Specifies which TLS versions to allow use-peer-dns ( |; Default: ) yes no no Whether to add DNS servers provided by the OVPN server to IP/DNS configuration. route-nopull ( |; Default: ) yes no no Specifies whether to allow the OVPN server to add routes to the OVPN client instance routing table. user ( ; Default: ) string User name used for authentication. Also, it is possible to import the OVPN client configuration from a .ovpn configuration file. Such a file usually is provided from the OVPN server side and already includes configuration so you need to worry only about a few parameters. /interface/ovpn-client/import-ovpn-configuration ovpn-password=securepassword \ key-passphrase=certificatekeypassphrase ovpn-user=myuserid skip-cert-import=no OVPN client supports tls authentication. The configuration of tls-auth can be added only by importing .ovpn configuration file. Using tls-auth requires that you generate a shared-secret key, this key should be added to the client configuration file .ovpn. Note* ROS client requires user name and password. Authentication is managed by server side, if its supports tls, then user name will be ignored. key-direction 1 <tls-auth> # # 2048 bit OpenVPN static key # -----BEGIN OpenVPN Static key V1----- -----END OpenVPN Static key V1----- </tls-auth> 7.17beta5 added support to allow non-null auth in gcm mode. Tls-crypt, tls-crypt v2 To improve TLS auth, Tls-crypt is added in version 7.17rc3. Tls-crypt, tls-crypt v2 is suppoorted only for ovpn client with following settings: “auth SHA256” and no key-direction in server configuration, “auth SHA256” and “key-direction 1” in client configuration is needed for authentication to work. Example configuration files: client-1.ovpn

server-1.conf OVPN Server /interface ovpn-server An interface is created for each tunnel established to the given server. There are two types of interfaces in the OVPN server's configuration Static interfaces are added administratively if there is a need to reference the particular interface name (in firewall rules or elsewhere) created for the particular user. Dynamic interfaces are added to this list automatically whenever a user is connected and its username does not match any existing static entry (or in case the entry is active already, as there can not be two separate tunnel interfaces referenced by the same name). Dynamic interfaces appear when a user connects and disappear once the user disconnects, so it is impossible to reference the tunnel created for that use in router configuration (for example, in the firewall), so if you need a persistent rule for that user, create a static entry for him/her. Otherwise, it is safe to use dynamic configuration. Server Configuration Properties Property Description auth ( | | | | ; Default: md5 sha1 null sha256 sha512 sh ) a1,md5,sha256,sha512Authentication methods that the server will accept. certificate ( | ; Default: ) name none none Name of the certificate that the OVPN server will use. cipher ( | | | null aes128-cbc aes128-gcm aes192-cbc | | | | aes192-gcm aes256-cbc aes256-gcm blowfish1 ; Default: ) 28 aes128-cbc,blowfish128Allowed ciphers. default-profile ( ; Default: ) name default Default profile to use. disabled ( |; Default: ) yes no yes Defines whether the OVPN server is enabled or not. protocol ( | ; Default: tcp) tcp udp Indicates the protocol to use when connecting with the remote endpoint. keepalive-timeout ( | ; Default: ) integer disabled 60 Defines the time period (in seconds) after which the router is starting to send keepalive packets every second. If no traffic and no keepalive responses have come for that period of time (i.e. 2 * keepalive-timeout), not responding client is proclaimed disconnected mac-address ( ; Default: ) MAC Automatically generated MAC address of the server. max-mtu ( ; Default: ) integer 1500 Maximum Transmission Unit. Max packet size that the OVPN interface will be able to send without packet fragmentation. mode (| ; Default: ) ip ethernet ip Layer3 or layer2 tunnel mode (alternatively tun, tap) name (string) Name of the server netmask ( ; Default: ) integer 24 Subnet mask to be applied to the client. port ( ; Default: ) integer 1194 Port to run the server on. require-client-certificate ( |; Default: ) yes no no If set to yes, then the server checks whether the client's certificate belongs to the same certificate chain. In both cases PPP users must be configured properly - static entries do not replace PPP configuration.

redirect-gateway ( | | Default: def1 disabled ipv6; disa ) bledSpecifies what kind of routes the OVPN client must add to the routing table. def1 – Use this flag to override the default gateway by using 0.0.0.0/1 and 128.0.0.0/1 rather than 0.0.0.0/0. This has the benefit of overriding but not wiping out the original default gateway. - Do not send redirect-gateway flags to the OVPN client. disabled - Redirect IPv6 routing into the tunnel on the client side. This works similarly to the def1 ipv6 flag, that is, more specific IPv6 routes are added (2000::/4 and 3000::/4), covering the whole IPv6 unicast space. enable-tun-ipv6 (y | Default: ) es no; no Specifies if IPv6 IP tunneling mode should be possible with this OVPN server. ipv6-prefix-len ( Default: ) integer; 64 Length of IPv6 prefix for IPv6 address which will be used when generating OVPN interface on the server side. reneg-sec ( Default: integer; 3600) Key renegotiate seconds, the time the server periodically renegotiates the secret key for the data channel. push-routes ( ; Default: ) string Push route support are added in 7.14, the maximum of possible input is limited to 1400 characters. tls-version (any | Default: ) only-1.2 ; any TLS protocol setting. tun-server-ipv6 ( Default: ) IPv6 prefix; :: IPv6 prefix address which will be used when generating the OVPN interface on the server side. user-auth-method ( ) mschap2 | pap ; Default pap By the default pap authentication method is used, if preferred server authentication with chap challenge set mschap2 in server settings. vrf () VRF in which listen for connection attempts Also, it is possible to prepare a .ovpn file for the OVPN client which can be easily imported on the end device. /interface/ovpn-server/server/export-client-configuration ca-certificate=myCa.crt \ client-certificate=client1.crt client-cert-key=client1.key server-address=192.168.88.1 server=myServerName Example Setup Overview It is very important that the date on the router is within the range of the installed certificate's date of expiration. To overcome any certificate verification problems, enable date synchronization on both the server and the client.NTP

Assume that Office public IP address is 2.2.2.2 and we want two remote OVPN clients to have access to 10.5.8.20 and 192.168.55.0/24 networks behind the office gateway. Creating Certificates All certificates can be created on the RouterOS server using the certificate manager. . See example >> For the simplest setup, you need only an OVPN server certificate. Server Config The first step is to create an IP pool from which client addresses will be assigned and some users. /ip pool add name=ovpn-pool range=192.168.77.2-192.168.77.254 /ppp profile add name=ovpn local-address=192.168.77.1 remote-address=ovpn-pool /ppp secret add name=client1 password=123 profile=ovpn add name=client2 password=234 profile=ovpn Assume that the server certificate is already created and named "server" /interface ovpn-server server add disabled=no certificate=server name=myServer Client Config Add manually which networks you want to access over the tunnel. /interface ovpn-client add name=ovpn-client1 connect-to=2.2.2.2 user=client1 password=123 disabled=no /ip route add dst-address=10.5.8.20 gateway=ovpn-client1 add dst-address=192.168.55.0/24 gateway=ovpn-client1 /ip firewall nat add chain=srcnat action=masquerade out-interface=ovpn-client1

Push Route Push route support are added in 7.14, the maximum of possible input is limited to characters. 1400 example: route network/IP [netmask] [gateway] [metric]. /interface ovpn-server server set myServer push-routes="192.168.102.0 255.255.255.0 192.168.109.1 9" VRF support Support starting from is added, and couple changes introduced in configuration, if you use latest version, please refer to this example: 7.17 version Server side configuration: /interface ovpn-server server add disabled=no certificate=yourcert auth=sha1 cipher=aes128-cbc require-client-certificate=yes protocol=tcp name=ovpn-server1 vrf=main

3. 4. 1. 2. 3. that the client received. If the initial packet had a blank "service-name" field filed, the client populates the "service-name" field of the DO PADI PADR packet with the first service name that had been returned in the packet. PADO PPPoE Active Discovery Session Confirmation (PADS) - When the is received, the Access Concentrator generates a unique session PADR identification (ID) for the Point-to-Point Protocol (PPP) session and returns this ID to the PPPoE client in the packet. This packet is sent to PADS the unicast address of the client. PPPoE session termination: PPPoE Active Discovery Terminate (PADT) - Can be sent anytime after a session is established to indicate that a PPPoE session terminated. It can be sent by either server or client. Session phase When the discovery stage is completed, both peers know and other peer's which together defines the PPPoE PPPoE Session ID Ethernet (MAC) address session. PPP frames are encapsulated in PPPoE session frames, which have Ethernet frame type . 0x8864 When a server sends confirmation and a client receives it, PPP Session is started that consists of the following stages: LCP negotiation stage Authentication (CHAP/PAP) stage IPCP negotiation stage - where the client is assigned an IP address. PPPoE server sends packets to the client to determine the state of the session, otherwise, the server will not be able to determine that Echo-Request session is terminated in cases when a client terminates session without sending packet. Terminate-Request MTU Typically, the largest Ethernet frame that can be transmitted without fragmentation is 1500 bytes. PPPoE adds another 6 bytes of overhead and the PPP field adds two more bytes, leaving 1492 bytes for IP datagram. Therefore max PPPoE MRU and MTU values must not be larger than 1492. TCP stacks try to avoid fragmentation, so they use an MSS (Maximum Segment Size). By default, MSS is chosen as MTU of the outgoing interface minus the usual size of the TCP and IP headers (40 bytes), which results in 1460 bytes for an Ethernet interface. Unfortunately, there may be intermediate links with lower MTU which will cause fragmentation. In such a case TCP stack performs path MTU discovery. Routers that cannot forward the datagram without fragmentation are supposed to drop the packet and send to originating host. When a host receives such an ICMP packet, it ICMP-Fragmentation-Required tries to lower the MTU. This should work in the ideal world, however in the real world many routers do not generate fragmentation-required datagrams, also many firewalls drop all ICMP datagrams. The workaround for this problem is to if it is too big. adjust MSS PPPoE Client Properties Property Description ac-name ( ; Default: ) string "" Access Concentrator name, this may be left blank and the client will connect to any access concentrator on the broadcast domain add-default-route ( ; Default: ) yes|no no Enable/Disable whether to add default route automatically allow ( ; mschap2|mschap1|chap|pap Default: ) mschap2,mschap1,chap,papallowed authentication methods, by default all methods are allowed default-route-distance ( ; byte [0..255] Default: )1sets distance value applied to auto created default route, if add-default-route is also selected dial-on-demand ( ; Default: ) yes|no no connects to AC only when outbound traffic is generated. If selected, then route with gateway address from 10.112.112.0/24 network will be added while connection is not established. If any process fails, the LCP negotiation establishment phase is started again.

interface ( ; Default: ) string interface name on which client will run keepalive-timeout ( ; Default: ) integer 60 Sets keepalive timeout in seconds. max-mru ( ; Default: ) integer 1460 Maximum Receive Unit max-mtu ( ; Default: ) integer 1460 Maximum Transmission Unit mrru ( ; integer: 512..65535|disabled Default: ) disabledmaximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. name ( ; Default: ) string pppoe-out[i] name of the PPPoE interface, generated by RouterOS if not specified password ( ; Default: ) string password used to authenticate profile ( ; Default: ) string default Specifies which PPP profile configuration will be used when establishing the tunnel. service-name ( ; Default: ) string "" specifies the service name set on the access concentrator, can be left blank to connect to any PPPoE server use-peer-dns ( ; Default: ) yes|no no enable/disable getting DNS settings from the peer user ( ; Default: ) string "" username used for authentication Status Command will display current PPPoE status. /interface pppoe-client monitor Available read only properties: Property Description ac-mac ( ) MAC address MAC address of the access concentrator (AC) the client is connected to ac-name ( ) string name of the Access Concentrator active-links ( ) integer Number of bonded MLPPP connections, ('1' if not using MLPPP) encoding ( ) string encryption and encoding (if asymmetric, separated with '/') being used in this connection local-address ( ) IP Address IP Address allocated to client remote-address ( ) IP Address Remote IP Address allocated to server (ie gateway address) mru ( ) integer effective MRU of the link mtu ( ) integer effective MTU of the link service-name ( ) string used service name status ( ) string current link status. Available values are: dialing, verifying password..., connected, disconnected. uptime ( )time connection time displayed in days, hours, minutes and seconds Scanner PPPoE Scanner allows scanning all active PPPoE servers in the layer2 broadcast domain. Command to run scanner is as follows: /interface pppoe-client scan [interface] Available read only properties:

IPv6 PD over PPP Summary Configuration Server Client Testing status Summary This example demonstrates how to set up PPPoE server and client to use IPv6 Prefix Delegation. IPv6 Prefixes can be delegated over PPP interfaces. When client connects, PPP will automatically add dynamic . This allows to run DHCPv6-PD server DHCPv6 client on PPP interfaces. Configuration Server dhcpv6-pd-pool parameter under PPP Profiles is used to enable PPP-PD. PPP will use specified to create a dynamic DHCP server. IPv6 pool So first step is to add IPv6 pool: /ipv6 pool add name=myPool prefix=2001:db8:7501:ff00::/60 prefix-length=62 Now we can configure PPP profile and add PPPoE server /ppp profile set default dhcpv6-pd-pool=myPool /interface pppoe-server server add service-name=test interface=ether1 Client On client side we need to set up PPPoE client interface and run DHCP client on it. /interface pppoe-client add name=client-test interface=ether1 user=a1 service-name=test /ipv6 dhcp-client add interface=client-test pool-name=ppp-test pool-prefix-length=64 Testing status On server side check if dynamic DHCP server is added and prefix is bound to specific client:

[admin@RB1100] /ipv6 dhcp-server> print Flags: D - dynamic, X - disabled, I - invalid # NAME INTERFACE ADDRESS-POOL LEASE-TIME 0 D <pppoe-a1> <pppoe-a1> myPool 3d [admin@RB1100] /ipv6 dhcp-server binding> print Flags: X - disabled, D - dynamic # ADDRESS DU IAID SER.. STATUS 1 D 2001:db8:7501:ff04::/62 247 <pp.. bound On client side, check if DHCP client is bound and pool is added: [admin@x86-test] /ipv6 dhcp-client> print Flags: D - dynamic, X - disabled, I - invalid # INTERFACE STATUS PREFIX EXPIRES-AFTER 0 client-test bound 2001:db8:7501:ff04::/62 2d23h18m17s [admin@x86-test] /ipv6 pool> print Flags: D - dynamic # NAME PREFIX PREFIX-LENGTH 0 D ppp-test 2001:db8:7501:ff04::/62 64

MLPPP over single and multiple links Summary MLPPP over single link Configuration Example MLPPP over multiple links Configuration Example Summary Standards: RFC 1990 Multi-Link Point to Point Protocol (MP, Multi-Link PPP, MultiPPP or MLPPP) is a method of splitting, recombining, and sequencing data across multiple logical data links. In a situation where we have multiple DSL links a pair of devices, performance by “widening the pipe” between two devices can be increased by using Multi-Link PPP, without going to a newer, more expensive technology. Large packets are actually split into bits and sent evenly over ALL logical data links. This is done instantaneously with NO loss of bandwidth. It is important to understand that other end of the link needs to use the same protocol to recombine your data. Multilink is based on an option negotiation that allows to indicate to its peer that it is capable of combining multiple physical links.LCP MLPPP over single link Typically size of the packet sent over PPP link is reduced due to overhead. MP can be used to transmit and receive full frame over single ppp link. To make it work the Multilink Protocol uses additional LCP configuration options Multilink Maximum Received Reconstructed Unit (MRRU) To enable Multi-link PPP over single link you must specify MRRU (Maximum Receive Reconstructed Unit) option. If both sides support this feature there are no need for MSS adjustment (in firewall mangle). Study shows that MRRU is less CPU expensive that 2 mangle rules per client. MRRU allows to divide packet to multiple channels therefore increasing possible MTU and MRU (up to 65535 bytes) Under Windows it can be enabled in Networking tag, Settings button, "Negotiate multi-link for single link connections". Their MRRU is hard coded to 1614. Configuration Example Let's configure pppoe server compatible with Windows clients and MRRU enabled. [admin@RB800] /interface pppoe-server server> add service-name=myPPP interface=ether1 mrru=1614 [admin@RB800] /interface pppoe-server server> print Flags: X - disabled 0 service-name="myPPP" interface=ether1 max-mtu=1480 max-mru=1480 mrru=1614 authentication=pap,chap,mschap1,mschap2 keepalive-timeout=10 one-session-per-host=no max-sessions=0 default-profile=default In short - standard PPP link - just specify MRRU in both sides. MLPPP over multiple links MLPPP over multiple links allow to create a single PPP link over multiple physical connections. All PPP links must come from the same server (server must have MLPPP over multiple links support) and all PPP links must have same user name and password. And to enable MLPPP you just need to create PPP client and specify multiple interfaces instead of single interface. RouterOS has MLPPP client support only. Presently there are no MLPPP server support available. MTU will be reduced by 4 bytes to work properly when MPPE encryption is enabled

Configuration Example ISP gives to its client two physical links (DSL lines) 1Mbps each. To get aggregated 2Mbps pipe we have to set up MLPPP. Consider ISP router is pre- configured to support MLPPP. Configuration on router (R1) is: /interface pppoe-client add service-name=ISP interface=ether1,ether2 user=xxx password=yyy disabled=no \ add-default-route=yes use-peer-dns=yes [admin@RB800] /interface pppoe-client> print Flags: X - disabled, R - running 0 name="pppoe-out1" max-mtu=1480 max-mru=1480 mrru=disabled interface=ether1,ether2 user="xxx" password="yyy" profile=default service-name="ISP" ac-name="" add-default-route=yes dial-on-demand=no use-peer-dns=yes allow=pap,chap,mschap1,mschap2 Now when PPPoE client is connected we can set up rest of configuration, local network address, enable DNS requests, set up masquerade and firewall /ip address add address=192.168.88.1/24 interface=local /ip dns set allow-remote-request=yes /ip firewall nat add chain=src-nat action=masquerade out-interface=pppoe-out1 /ip firewall filter add chain=input connection-state=invalid action=drop \ comment="Drop Invalid connections" add chain=input connection-state=established action=accept \ comment="Allow Established connections" add chain=input protocol=icmp action=accept \ comment="Allow ICMP" add chain=input src-address=192.168.88.0/24 action=accept \ in-interface=!pppoe-out1 add chain=input action=drop comment="Drop everything else" For more advanced router and customer protection check . firewall examples

PPTP Overview PPTP . However, this protocol is integrated into common operating systems, and it is has many known security issues and we do not recommend using it easy to set it up. PPTP can be useful in networks where security is not of concern. IPv6 is not supported on this protocol. PPTP traffic uses TCP port 1723 and IP protocol GRE (Generic Routing Encapsulation, IP protocol ID 47), as assigned by the Internet Assigned Numbers Authority (IANA). PPTP can be used with most firewalls and routers by enabling traffic destined for TCP port 1723 and protocol 47 traffic to be routed through the firewall or router. PPTP includes PPP authentication and accounting for each PPTP connection. Full authentication and accounting of each connection may be done through a RADIUS client or locally. PPTP Client Properties Property Description add-default-route ( ; Default: ) yes | no no Whether to add PPTP remote address as a default route. allow ( ; mschap2 | mschap1 | chap | pap Default: ) mschap2, mschap1, chap, papAllowed authentication methods. connect-to (; Default: )IP Remote address of PPTP server default-route-distance ( ; byte [0..255] Default: )1sets distance value applied to auto created default route, if add-default-route is also selected dial-on-demand ( ; Default: ) yes | no no connects to PPTP server only when outbound traffic is generated. If selected, then route with gateway address from 10.112.112.0/24 network will be added while connection is not established. disabled ( ; Default: ) yes | no yes Whether interface is disabled or not. By default it is disabled keepalive-timeout ( ; Default: ) integer 60 Sets keepalive timeout in seconds. max-mru ( ; Default: ) integer 1450 Maximum Receive Unit. Max packet size that PPTP interface will be able to receive without packet fragmentation. max-mtu ( ; Default: ) integer 1450 Maximum Transmission Unit. Max packet size that PPTP interface will be able to send without packet fragmentation. mrru ( ; Default: ) disabled | integer disabled Maximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. name ( ; Default: ) string Descriptive name of the interface. password ( ; Default: ) string "" Password used for authentication. profile ( ; Default: ) name default-encryption user ( ; Default: ) string User name used for authentication. PPTP Server /interface pptp-server An interface is created for each tunnel established to the given server. There are two types of interfaces in the PPTP server's configuration:

SSTP Client Properties authentication (chap, mschap1, ; Default: ) mschap2, pap "all"Allowed authentication methods, by default all methods are allowed. disabled ( ; Default: ) yes | no yes Enables/disables tunnel. add-default-route ( ; yes | no Default: ) noWhether to add L2TP remote address as a default route. default-route-distance ( ; byte Default: )Sets distance value applied to auto created default route, if add-default-route is also selected. mrru ( ; integer: 512..65535|disabled Default: ) disabledmaximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. proxy-port ( ; Default: ) string 443 Sets proxy port. add-sni ( ; Default: ) yes | no no Enables/disables service. dial-on-demand ( ; Default: yes | no )noConnects only when outbound traffic is generated. If selected, then route with gateway address from 10.112.112.0 /24 network will be added while connection is not established. name ( ; Default: ) string Descriptive name of the interface. tls-version ( | ; Default: any only-1.2 )anySpecifies which TLS version to allow. numbers ( ) integer; Sets number for an tunnel in ROS. user ( ; Default: ) string User name used for authentication. certificate ( | ; Default: string none n )oneName of the client certificate http-proxy ( ; Default: ) string Proxy address field. password ( ; Default: ) string "" Password used for authentication. verify-server-address-from- certificate ( yes|no ; Default: no)SSTP client will verify server address in certificate. verify-server-certificate ( yes|no ; Default: no)SSTP client will verify server certificate. ciphers (aes256-gcm-sha384 | aes256-sha ; Default: all)Allowed ciphers. keepalive-timeout ( ; Default: integer )60Sets keepalive timeout in seconds. pfs ( ; Default: ) yes | no | required no Specifies which TLS authentication to use. With pfs=yes, TLS will use ECDHE-RSA- and DHE-RSA-. For maximum security setting pfs=required will use only ECDHE. comment ( ; Default: ) string Short description of the tunnel. TLS SNI support has been added starting with 7.15beta10 version, Extension will be added to c lient hello packets if "Add SNI" checkbox is checked or set in CLI: interface/sstp-client/set add-sni=yes

max-mru ( ; Default: ) integer 1460 Maximum Receive Unit. max-mtu ( ; Default: ) integer 1460 Maximum Transmission Unit. port ( ; Default: ) integer 443 Port to connect to. connect-to ( ; Default: ) IP|IPv6 Remote address of the SSTP server. profile ( ; Default: ) name default Specifies which PPP profile configuration will be used when establishing the tunnel. SSTP Server Properties authentication (chap, mschap1, ; Default: ) mschap2, pap "all"Allowed authentication methods, by default all methods are allowed. keepalive-timeout ( ; Default: integer )60Sets keepalive timeout in seconds. port ( ; Default: ) string 443 Sets port used. certificate ( | ; Default: string none n )oneName of the certificate in use. max-mru ( ; Default: ) integer 1460 Maximum Receive Unit. max-mtu ( ; Default: ) integer 1460 Maximum Transmission Unit. tls-version ( | ; Default: any only-1.2 )anySpecifies which TLS version to allow. ciphers (aes256-gcm-sha384 | aes256-sha ; Default: all)Allowed ciphers. verify-client-certificate ( yes|no ; Default: no)SSTP server will verify client certificate. mrru ( ; integer: 512..65535|disabled Default: ) disabledmaximum packet size that can be received on the link. If a packet is bigger than tunnel MTU, it will be split into multiple packets, allowing full size IP or Ethernet packets to be sent over the tunnel. default-profile ( name ; Default: defa ult)Specifies which PPP profile configuration will be used when establishing the tunnel. enabled ( ; Default: ) yes | no no Enables/disables service. pfs ( ; Default: ) yes | no | required no Specifies which TLS authentication to use. With pfs=yes, TLS will use ECDHE-RSA- and DHE-RSA-. For maximum security setting pfs=required will use only ECDHE. Certificates To set up a secure SSTP tunnel, certificates are required. On the server, authentication is done only by and but on the client - the username password, server is authenticated using a server certificate. It is also used by the client to cryptographically bind SSL and PPP authentication, meaning - the clients send a special value over SSTP connection to the server, this value is derived from the key data that is generated during PPP authentication and server certificate, this allows the server to check if both channels are secure. If SSTP clients are on Windows PCs then the only way to set up a secure SSTP tunnel when using a self-signed certificate is by importing the "server" certificate on the SSTP server and on the Windows PC adding a CA certificate in the . trusted root

WireGuard Introduction Introduction Properties Read-only properties Peers Read-only properties Application examples Site to Site WireGuard tunnel WireGuard interface configuration Peer configuration IP and routing configuration Firewall considerations RoadWarrior WireGuard tunnel RouterOS configuration iOS configuration Windows 10 configuration WireGuard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more ® useful than IPsec while avoiding massive headaches. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general- purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable. Properties Property Description comment ( ; Default: ) string Short description of the tunnel. disabled ( ; Default: yes | no no )Enables/disables the tunnel. listen-port (integer; Default: ) 13231Port for WireGuard service to listen on for incoming sessions. mtu ( ; integer [0..65536] Default: ) 1420Layer3 Maximum transmission unit. name ( ; Default: ) string Name of the tunnel. private-key ( ; Default: ) string A base64 private key. If not specified, it will be automatically generated upon interface creation. Each network interface has a private key and a list of peers. Read-only properties Property Description public-key ( ) stringA base64 public key is calculated from the private key. Each peer has a public key. Public keys are used by peers to authenticate each other. They can be passed around for use in configuration files. running (ye ) s | noWhether the interface is running. Peers Property Description

allowed- address (I P/IPv6 ; prefix Def : )aultList of IP (v4 or v6) addresses with CIDR masks from which incoming traffic for this peer is allowed and to which outgoing traffic for this peer is directed. This IP address has to be in the same subnet as WireGuard interface set on ROS. If WireGuard interface is at 192.168.99.1/24, You have to input 192.168.99.2 to the client. By adding this IP under 'Allowed Address', you are saying that only this specific client (phone for example) is permitted to connect to this peer configuration. Allowed-address range cannot overlap on one interface, so you need to set own range for each peer. comment ( string; Default: )Short description of the peer. disabled ( yes | no; Default: no )Enables/disables the peer. endpoint- address (I P /Hostnam e; Default: )The IP address or hostname. It is used by WireGuard to establish a secure connection between two peers. endpoint- port (integ er:0.. 65535 ; ) Default: The Endpoint port is the UDP port on which a WireGuard peer listens for incoming traffic. interface ( string; ) Default: Name of the WireGuard interface the peer belongs to. persistent- keepalive (integer:0.. 65535; ) Default: 0A seconds interval, between 1 and 65535 inclusive, of how often to send an authenticated empty packet to the peer for the purpose of keeping a stateful firewall or NAT mapping valid persistently. For example, if the interface very rarely sends traffic, but it might at anytime receive traffic from a peer, and it is behind NAT, the interface might benefit from having a persistent keepalive interval of 25 seconds. preshared -key (strin g; ) Default: A base64 preshared key. Optional, and may be omitted. This option adds an additional layer of symmetric-key cryptography to be mixed into the already existing public-key cryptography, for post-quantum resistance. Also can be generated automatically or entered manually, when the key is provided by the system administrator. private- key (auto /none; Default: n )oneA base64 private key. public-key ( string; ) Default: A base64 public key is calculated from the private key. Each peer has a public key. Public keys are used by peers to authenticate each other. They can be passed around for use in configuration files. show- client- config ill show already created Peer configuration and generate a QR code for easier peer setup on a client device. Does not affect the W WireGuard Server. Used for the client-server setup scenario, when the configuration is imported using a qr code for a client, configuration details on tab with qrcode will appear once it has been set in the fields: client- address (I P/IPv6 prefix; Default: )When , then this address for the wg interface is set on that device. imported using a qr code for a client (for example, a phone)

client-dns (IP/IPv6 prefix; Default: )Specify when using WireGuard Server as a VPN gateway for peer traffic. client- endpoint (I P/IPv6 prefix; Default: )The IP address and port number of the WireGuard Server. client- keepalive ( integer:0.. 65535; ) Default: 0Same as but from peer side. persistent-keepalive client- listen-port ( integer:0.. 65535 ; ) Default: The local port upon which this WireGuard tunnel will listen for incoming traffic from peers, and the port from which it will source outgoing packets. name (stri ng; ) Default: Allows adding name to a peer. Name will be used as a reference for a peer in WireGuard logs. (Available from RouterOS version 7.15) responder (yes | no; Default: no )Specifies if peer is intended to be connection initiator or only responder. Should be used on WireGuard devices that are used as "servers" for other devices as clients to connect to. Otherwise router will all repeatedly try to connect "endpoint-address" or "current-endpoint- address". *AllowedIPs configuration that is provided to the client through WireGuard peer export (configuration file or QR code) can not be changed and will be "0.0.0.0/0, ::/0" at the moment. If it is necessary to change these values on remote end, then that is up to the remote peer software used for WireGuard connection. Read-only properties Property Description current-endpoint-address ( ) IP/IPv6 The most recent source IP address of correctly authenticated packets from the peer. current-endpoint-port ( ) integer The most recent source IP port of correctly authenticated packets from the peer. Minimum parameters must be specified for importing on the client device by QR-code/file. Example: interface : wireguard1 -key: v/oIzPyFm1FPHrqhytZgsKjU7mUToQHLrW+Tb5e601M= public -key: KMwxqe/iXAU8Jn9dd1o5pPdHep2blGxNWm9I944/I24= private allowed-address: 192.168.88.3/24 client-address: 192.168.88.3/32 client-endpoint: example.com:13231 When using interface/wireguard/wg-import file=, you may get Could not parse error, if Wireguard import file starts with #, use it clean as per example: [Interface] Address =192.168.88.3/24 ListenPort = 13533 PrivateKey = UBLqJEFZZf9wszZSUF2BPWa9dsMX99RbEcxlNfxWffk=

last-handshake (i ) nteger Time in seconds after the last successful handshake. rx ( ) integer The total amount of bytes received from the peer. tx ( ) integer The total amount of bytes transmitted to the peer. Application examples Site to Site WireGuard tunnel Consider setup as illustrated below. Two remote office routers are connected to the internet and office workstations are behind NAT. Each office has its own local subnet, 10.1.202.0/24 for Office1 and 10.1.101.0/24 for Office2. Both remote offices need secure tunnels to local networks behind routers. WireGuard interface configuration First of all, WireGuard interfaces must be configured on both sites to allow automatic private and public key generation. The command is the same for both routers: /interface/wireguard add listen-port=13231 name=wireguard1 Now when printing the interface details, both private and public keys should be visible to allow an exchange. Office1 When you encounter issues with reply traffic having the wrong source address, using NAT to translate packet source addresses to your loopback interface is a common workaround. This approach helps ensure that the source address is consistent and correct when packets are routed back through the network. Any private key will never be needed on the remote side device - hence the name private.

/interface/wireguard print Flags: X - disabled; R - running 0 R name="wireguard1" mtu=1420 listen-port=13231 private-key="yKt9NJ4e5qlaSgh48WnPCDCEkDmq+VsBTt/DDEBWfEo=" public-key="u7gYAg5tkioJDcm3hyS7pm79eADKPs/ZUGON6/fF3iI=" Office2 /interface/wireguard/print Flags: X - disabled; R - running 0 R name="wireguard1" mtu=1420 listen-port=13231 private-key="KMwxqe/iXAU8Jn9dd1o5pPdHep2blGxNWm9I944/I24=" public-key="v/oIzPyFm1FPHrqhytZgsKjU7mUToQHLrW+Tb5e601M=" Peer configuration Peer configuration defines who can use the WireGuard interface and what kind of traffic can be sent over it. To identify the remote peer, its public key must be specified together with the created WireGuard interface. Office1 /interface/wireguard/peers add allowed-address=10.1.101.0/24,10.255.255.1/32 endpoint-address=192.168.80.1 endpoint-port=13231 interface=wireguard1 \ public-key="v/oIzPyFm1FPHrqhytZgsKjU7mUToQHLrW+Tb5e601M=" Office2 /interface/wireguard/peers add allowed-address=10.1.202.0/24,10.255.255.2/32 endpoint-address=192.168.90.1 endpoint-port=13231 interface=wireguard1 \ public-key="u7gYAg5tkioJDcm3hyS7pm79eADKPs/ZUGON6/fF3iI=" IP and routing configuration Lastly, IP and routing information must be configured to allow traffic to be sent over the tunnel. Office1 /ip/address add address=10.255.255.1/30 interface=wireguard1 /ip/route add dst-address=10.1.101.0/24 gateway=wireguard1 Office2 /ip/address add address=10.255.255.2/30 interface=wireguard1 /ip/route add dst-address=10.1.202.0/24 gateway=wireguard1 Firewall considerations The default RouterOS firewall will block the tunnel from establishing properly. The traffic should be accepted in the "input" chain before any drop rules on both sites. Office1

/ip/firewall/filter add action=accept chain=input dst-port=13231 protocol=udp src-address=192.168.80.1 Office2 /ip/firewall/filter add action=accept chain=input dst-port=13231 protocol=udp src-address=192.168.90.1 Additionally, it is possible that the "forward" chain restricts the communication between the subnets as well, so such traffic should be accepted before any drop rules as well. Office1 /ip/firewall/filter add action=accept chain=forward dst-address=10.1.202.0/24 src-address=10.1.101.0/24 add action=accept chain=forward dst-address=10.1.101.0/24 src-address=10.1.202.0/24 Office2 /ip/firewall/filter add action=accept chain=forward dst-address=10.1.101.0/24 src-address=10.1.202.0/24 add action=accept chain=forward dst-address=10.1.202.0/24 src-address=10.1.101.0/24 RoadWarrior WireGuard tunnel RouterOS configuration Add a new WireGuard interface and assign an IP address to it. /interface wireguard add listen-port=13231 name=wireguard1 /ip address add address=192.168.100.1/24 interface=wireguard1 Adding a new WireGuard interface will automatically generate a pair of private and public keys. You will need to configure the public key on your remote devices. To obtain the public key value, simply print out the interface details. [admin@home] > /interface wireguard print Flags: X - disabled; R - running 0 R name="wireguard1" mtu=1420 listen-port=13231 private-key="cBPD6JNvbEQr73gJ7NmwepSrSPK3np381AWGvBk/QkU=" public-key="VmGMh+cwPdb8//NOhuf1i1VIThypkMQrKAO9Y55ghG8=" For the next steps, you will need to figure out the public key of the remote device. Once you have it, add a new peer by specifying the public key of the remote device and allowed addresses that will be allowed over the WireGuard tunnel. /interface wireguard peers add allowed-address=192.168.100.2/32 interface=wireguard1 public-key="<paste public key from remote device here>" Firewall considerations If you have default or strict firewall configured, you need to allow remote device to establish the WireGuard connection to your device.

/ip firewall filter add action=accept chain=input comment="allow WireGuard" dst-port=13231 protocol=udp place-before=1 To allow remote devices to connect to the RouterOS services (e.g. request DNS), allow the WireGuard subnet in input chain. /ip firewall filter add action=accept chain=input comment="allow WireGuard traffic" src-address=192.168.100.0/24 place-before=1 Or simply add the WireGuard interface to "LAN" interface list. /interface list member add interface=wireguard1 list=LAN iOS configuration Download the WireGuard application from the App Store. Open it up and create a new configuration from scratch.

First of all give your connection a "Name" and choose to generate a keypair. The generated public key is necessary for peer's configuration on RouterOS side.

Specify an IP address in "Addresses" field that is in the same subnet as configured on the server side. This address will be used for communication. For this example, we used 192.168.100.1/24 on the RouterOS side, you can use 192.168.100.2 here. If necessary, configure the DNS servers. If allow-remote-requests is set to yes under IP/DNS section on the RouterOS side, you can specify the remote WireGuard IP address here.

Click "Add peer" which reveals more parameters. The "Public key" value is the public key value that is generated on the WireGuard interface on RouterOS side. "Endpoint" is the IP or DNS with port number of the RouterOS device that the iOS device can communicate with over the Internet. "Allowed IPs" are set to 0.0.0.0/0 to allow all traffic to be sent over the WireGuard tunnel.

Save and Activate

1. 2. IPv6 is recommended and can greatly improve direct connection reliability if supported on both ends of a direct link. If present it should be implemented without NAT (NAT is wholly unnecessary with IPv6 and only adds complexity) and with a stateful firewall that permits bidirectional UDP conversations. Don't use "symmetric" NAT. Use "full cone" or "port restricted cone" NAT. Symmetric NAT is extremely hostile to peer-to-peer traffic and will degrade VoIP, video chat, games, WebRTC, and many other protocols as well as ZeroTier. No more than one layer of NAT should be present between ZeroTier endpoints and the Internet. Multiple layers of NAT introduce connection instability due to chaotic interactions between states and behaviors at different levels. No Double NAT. NATs should have a port mapping or connection timeout no shorter than 60 seconds. Place no more than about 16,000 devices behind each NAT-managed external IP address to ensure that each device can map a sufficient number of ports. Switches and wireless access points should allow direct local traffic between local devices. Turn off any "local isolation" features. Some switches might allow finer-grained control, and on these, it would be sufficient to allow local UDP traffic to/from 9993 (or in general). Configuration example By default, ZeroTier is designed to be zero-configuration. A user can start a new ZeroTier node without having to write configuration files or provide the IP addresses of other nodes. It’s also designed to be fast. Any two devices in the world should be able to locate each other and communicate almost instantly so the following example will enable ZeroTier on RouterOS device and connect one mobile phone using the ZeroTier application. Register on and , obtain the , in this example: ; my.zerotier.com Create A Network Network ID 1d71939404912b40

A common misunderstanding is to conflate network controllers with root servers (planet and moons). Root servers are connection facilitators that operate at the . Network controllers are configuration managers and certificate authorities that belong to the Generally, root servers don’t join or VL1 level . VL2 level control virtual networks and network controllers are not root servers, though it is possible to have a node do both. /zerotier/controller/ Every ZeroTier instance has a self-hosting network controller that can be used to host virtual networks. A controller is responsible for admitting members to Controllers can in theory host up to 2^24 networks and serve many millions the network, and issuing default configuration information including certificates. of devices (or more), but we recommend spreading large numbers of networks across many controllers for load balancing and fault tolerance reasons. Parameters Property Description broadcast ( yes | no; Default: )yesAllow receiving broadcast ( ) packets. FF:FF:FF:FF:FF:FF comment (stri ; Default: )ngDescriptive comment for the controller. copy-from (str ; Default: )ingCopies an existing item. It takes default values of a new item's properties from another item. If you do not want to make an exact copy, you can specify new values for some properties. When copying items that have names, you will usually have to give a new name to a copy. instance (string ; Default: zt1)ZeroTier instance name. (; ip-range IP Default: )IP range, for example, 172.16.16.1-172.16.16.254. ip6-6plane ( yes | no; Default: )noAn option gives every member a /80 within a /40 network but uses NDP emulation to route allIPs under that /80 to their owner. The 6pl ane mode is great for use cases like Docker since it allows every member to assign IPv6 addresses within its /80 that just work instantly and globally across the network. ip6-rfc4193 ( yes | no; Default: )noThe rfc4193 mode gives every member a /128 on a /88 network. ( ip6-range IPv6 ; Default: )IPv6 range, for example fd00:feed:feed:beef::-fd00:feed:feed:beef:ffff:ffff:ffff:ffff. mtu (integer; Default: ) 2800Network MTU. multicast-limit ( : integer Default: )32Maximum recipients for a multicast packet. ( ; name string Default: )A short name for this controller. ( network string ; Default)16-digit network ID. private ( yes | no; Default: y )esEnables access control. routes (IP@GW ; Default: )Push routes in the following format: Routes ::= Route[,Routes] Route ::= Dst[@Gw] Configuration example

In the following example, we will use RouterOS built-in ZeroTier controller to send our new network hosts appropriate certificates, credentials, and configuration information. The controller will operate from the "RouterOS Home" device and we will join in our network 3 units: mobile phone, laptop, RouterOS Office device, but theoretically, you can join up to 100 devices in one network. RouterOS Home First, we enable the default instance which operates at the level :VL1 [admin@Home] /zerotier> print Columns: NAME, PORT, IDENTITY.PUBLIC # NAME PORT IDENTITY. PUBLIC ;;; ZeroTier Central controller - https://my.zerotier.com/ 0 zt1 9993 879c0b5265:0: d5fd2d17805e011d9b93ce8779385e427c8f405e520eea9284809d8444de0335a817xxb21aa4ba153bfbc229ca34d94e08de96d925a4aaa1 9b252da546693a28 Now we create a new network via the controller section which will operate at the level. Each network has its own controller and each network ID is VL2 generated from the controller address and controller ID combination. Note that we use the option for a more secure network: private=yes [admin@Home] /zerotier> controller/add name=ZT-private instance=zt1 ip-range=172.27.27.10-172.27.27.20 private=yes routes=172.27.27.0/24 [admin@Home] /zerotier> controller/print Columns: INSTANCE, NAME, NETWORK, PRIVATE # INSTANCE NAME NETWORK PRIVATE 0 zt1 ZT-private 879c0b5265a99e4b yes

Add our new network under the interface section: [admin@Home] /zerotier> interface/add network=879c0b5265a99e4b name=myZeroTier instance=zt1 [admin@Home] /zerotier> interface/print interval=1 Columns: NAME, MAC-ADDRESS, NETWORK, STATUS # NAME MAC-ADDRESS NETWORK STATUS 0 myZeroTier 4A:19:35:6E:00:6E 879c0b5265a99e4b ACCESS_DENIED Each new peer asks for a controller to join the network, in this situation, we have status and we have to authorize a new peer, that is ACCESS_DENIED because we used the option. private=yes After authorization, each member in the network receives information from the controller about new peers and approval they can exchange packets with them: [admin@Home] /zerotier> controller/member/print Columns: NETWORK, ZT-ADDRESS # NETWORK ZT-ADDRESS 0 ZT-private 879a0b5265 [admin@Home] /zerotier> controller/member/set 0 authorized=yes Verify newly configured IP address and route: [admin@Home] /zerotier> /ip/address/print where interface~"Zero" Flags: D - DYNAMIC Columns: ADDRESS, NETWORK, INTERFACE # ADDRESS NETWORK INTERFACE 4 D 172.27.27.15/24 172.27.27.0 myZeroTier [admin@Home] /zerotier> /ip/route/pr where gateway~"Zero" Flags: D - DYNAMIC; A - ACTIVE; c, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAc 172.27.27.0/24 myZeroTier 0 RouterOS Office Configuration on the Office device. We will enable the default instance and ask a controller to join the network: 879c0b5265a99e4b [admin@office] /zerotier> interface/add network=879c0b5265a99e4b instance=zt1 name=ZT-interface [admin@office] /zerotier> interface/print interval=1 Columns: NAME, MAC-ADDRESS, NETWORK, STATUS # NAME MAC-ADDRESS NETWORK STATUS 0 ZT-interface 4A:40:1C:38:97:BA 879c0b5265a99e4b ACCESS_DENIED As previously, because our network is private, we have to authorize a new peer via "RouterOS home device". After that verify from controller received IP address and route: [admin@Home] /zerotier> controller/member/print Flags: A - AUTHORIZED Columns: NETWORK, ZT-ADDRESS, IP-ADDRESS, LAST-SEEN # NETWORK ZT-ADDRESS IP-ADDRESS LAST-SEEN 0 A ZT-private 879a0b5265 172.27.27.15 1 A ZT-private 554a914c7f 172.27.27.17 2 A ZT-private a83ac6032a 172.27.27.10 3 ZT-private deba5dc5b1 172.27.27.13 3s348ms [admin@Home] /zerotier> controller/member/set 3 authorized=yes [admin@Home] /zerotier> controller/member/print Flags: A - AUTHORIZED Columns: NETWORK, ZT-ADDRESS, IP-ADDRESS, LAST-SEEN # NETWORK ZT-ADDRESS IP-ADDRESS LAST-SEEN 0 A ZT-private 879a0b5265 172.27.27.15

1 A ZT-private 554a914c7f 172.27.27.17 2 A ZT-private a83ac6032a 172.27.27.10 3 A ZT-private deba5dc5b1 172.27.27.13 4s55ms Verify via ZeroTier obtained IP address and route: [admin@office] /zerotier> /ip/address/print where interface~"ZT" Flags: D - DYNAMIC Columns: ADDRESS, NETWORK, INTERFACE # ADDRESS NETWORK INTERFACE 0 D 172.27.27.13/24 172.27.27.0 ZT-interface [admin@office] /zerotier> /ip/route/print where gateway~"ZT" Flags: D - DYNAMIC; A - ACTIVE; c, y - COPY Columns: DST-ADDRESS, GATEWAY, DISTANCE DST-ADDRESS GATEWAY DISTANCE DAc 172.27.27.0/24 ZT-interface 0 Other devices Download the ZeroTier app for your mobile phone or computer and join your newly created network: 1) Via our Laptop ZeroTier application we join the network; 879c0b5265a99e4b 2) User Zerotier mobile app to join the network; 879c0b5265a99e4b Also all other new hosts you have to authorize under the section. /zerotier/controller/member/

Wired Connections In This Section:

1G-baseT-half 1G twisted-pair half-duplex 1G-baseT-full 1G twisted-pair full-duplex 1G-baseX 1G optical-fiber 2.5G-baseT 2.5G twisted-pair full-duplex 2.5G-baseX 2.5G optical-fiber 5G-baseT 5G twisted-pair full-duplex 10M-baseT-half 10M twisted-pair half-duplex 10M-baseT-full 10M twisted-pair full-duplex 10G-baseT 10G twisted-pair full-duplex 10G-baseCR 10G twinaxial-copper 10G-baseSR-LR 10G optical-fiber 25G-baseCR 25G twinaxial-copper 25G-baseSR-LR 25G optical-fiber 40G-baseCR4 4x10G twinaxial-copper 40G-baseSR4-LR4 4x10G optical-fiber 50G-baseCR2 2x25G twinaxial-copper 50G-baseSR2-LR2 2x25G optical-fiber 100M-baseT-half 100M twisted-pair half-duplex 100M-baseT-full 100M twisted-pair full-duplex 100G-baseCR4 4x25G twinaxial-copper 100G-baseSR4-LR4 4x25G optical-fiber Before manually configuring the bits for your interface, first determine which bits are supported by executing the command advertise /interface and checking the "supported" list. You can also view the bits supported by your transceiver under "sfp-supported" field. ethernet monitor advertise Additionally, the "advertising" will show the bits that RouterOS has automatically set. The list is generated by comparing the maximum available link mode values on your interface and transceiver and selecting the ones that match. Link Mode Naming Scheme Transmission Rates : The first number followed by 'M' or 'G' (e.g., 10M, 100M, 1G) represents the data transmission rates in megabits or gigabits per second. Interface Types : The symbols after "base" indicate the interface types: T: Stands for twisted pair cabling, followed by the duplex mode (either half or full). SR-LR : Stands for "short-range" and "long-range" optical modules, including other variants like LRM, ER, ZR, etc. These link modes should be used with optical modules. CR: Stands for twin-axial copper and is used with direct attach cable (DAC). For 1Gbps DAC, the appropriate link mode is 1G-baseX. Number of Lines : CR2: means two lines. CR4: means four lines.

FEC (Forward Error Correction) is a digital signal processing method that improves the bit error rate of SFP28, QSFP+, and QSFP28 links by adding information (parity bits) to the data at the transmitter side. The receiver side then uses this information to detect and correct errors that may have been introduced during transmission. To ensure a successful link, the same should be used on both ends of the link. RouterOS uses a disabled as the default setting, but it fec-mode fec-mode can be changed to (also known as FC-FEC) or (also known as RS-FEC). For more information on FEC mode options, refer to the fec74 fec91 property description. The table below shows the FEC modes supported for each link mode: Link Modes (for advertise and speed properties) Supported FEC modes 1G-baseT-half 1G-baseT-full 1G-baseX 2.5G-baseT 2.5G-baseX 5G-baseT 10M-baseT-half 10M-baseT-full 10G-baseT 10G-baseCR 10G-baseSR-LR 25G-baseCR fec74, fec91* 25G-baseSR-LR fec74, fec91* 40G-baseCR4 fec74 40G-baseSR4-LR4 fec74 50G-baseCR2 fec74, fec91 50G-baseSR2-LR2 fec74, fec91 100M-baseT-half 100M-baseT-full 100G-baseCR4 fec91 100G-baseSR4-LR4 fec91 Properties Sub-menu: /interface ethernet This section describes the Ethernet interface configuration options. Property Description Note : The CCR2004-1G-2XS-PCIe device does not support fec91 on SFP28 interfaces.

advertise (since RouterOS v7.12: 10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT-half | 1G-baseT-full | 1G-baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G- baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | Default: ) 50G-baseCR2 | 100G-baseSR4-LR4 | 100G-baseCR4; (older RouterOS: 10M-full | 10M-half | 100M-full | 100M-half | 1000M- ; Default: ) full | 1000M-half | 2500M-full | 5000M-full | 10000M-fullAdvertised link modes, only applies when auto-negotiation is enabled. Advertising higher speeds than the actual interface supported speed can result in undefined behavior. Multiple options are allowed. arp ( ; disabled | enabled | local-proxy-arp | proxy-arp | reply-only Default: ) enabledAddress Resolution Protocol mode: disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originated from matching IP address/MAC address combinations which are entered as static entries in the table. No dynamic entries will be automatically ARP stored in the ARP table. Therefore for communications to be successful, a valid static entry must already exist. arp-timeout ( ; Default: ) auto | integer auto How long the ARP record is kept in the ARP table after no packets are received from IP. Value equals to the value of inIP auto arp-timeout /Settings, default is 30s. auto-negotiation ( ; Default: ) yes | no yes When enabled, the interface "advertises" its maximum capabilities to achieve the best connection possible. Note1: Auto-negotiation should not be disabled on one end only, otherwise Ethernet Interfaces may not work properly. Note2: Gigabit Ethernet and NBASE-T Ethernet links cannot work with auto-negotiation disabled. bandwidth ( ; Default: ) integer/integer unlimited/unlimited Sets max rx/tx bandwidth in kbps that will be handled by an interface. TX limit is supported on all Atheros ports. RX limit is supported only on switch-chip Atheros8327/QCA8337 switch-chip ports. cable-setting ( ; Default: ) default | short | standard default Changes the cable length setting (only applicable to NS DP83815/6 cards) combo-mode ( ; Default: ) auto | copper | sfp auto When mode is selected, the port that was first connected will establish auto the link. In case this link fails, the other port will try to establish a new link. In case of a reboot, any of the two ports can be running, it depends on which port will successfully establish the link first. When mode is selected, the sfp interface will only work through SFP/SFP+ cage. When mode is copper selected, the interface will only work through RJ45 Ethernet port. comment ( ; Default: ) string Descriptive name of an item disable-running-check ( ; Default: ) yes | no yes Disable running check. If this value is set to 'no', the router automatically detects whether the NIC is connected with a device in the network or not. Default value is 'yes' because older NICs do not support it. (relevant only to CHR and x86)

fec-mode ( Default: ) auto | fec74 | fec91 | off; auto Changes Forward Error Correction (FEC) mode for SFP28, QSFP+ and QSFP28 interfaces. Same mode should be used on both link ends, otherwise FEC mismatch could result in non-working link or even false link-ups. It is recommended to enable FEC, particularly when creating link between CRS3xx, CRS5xx series switches. Some optical modules might rely on FEC functionality in MACs. auto - same as off fec74 - enables IEEE 802.3 clause 74 FEC (aka FC-FEC), can be used with 25Gbps, 40Gbps and 50Gbps link modes fec91 - enables IEEE 802.3 clause 91 FEC (aka RS-FEC), can be used with 25Gbps, 50Gbps and 100Gbps link modes off - disabled FEC. tx-flow-control ( ; Default: ) on | off | auto off When set to on, the port will generate pause frames to the upstream device to temporarily stop the packet transmission. Pause frames are only generated when some routers output interface is congested and packets cannot be transmitted anymore. is the same as except when auto- auto on negotiation=yes flow control status is resolved by taking into account what other end advertises. rx-flow-control ( ; Default: ) on | off | auto off When set to on, the port will process received pause frames and suspend transmission if required. is the same as except when auto- auto on negotiation=yes flow control status is resolved by taking into account what other end advertises. full-duplex ( ; Default: ) yes | no yes Defines whether the transmission of data appears in two directions simultaneously, only applies when auto-negotiation is disabled. Since RouterOS v7.12, the setting is replaced with new link modes. speed l2mtu ( ; Default: ) integer [0..65536] Layer2 Maximum transmission unit. . Read more mac-address ( ; Default: ) MAC Media Access Control number of an interface. mdix-enable ( ; Default: ) yes | no yes Whether the MDI/X auto cross over cable correction feature is enabled for the port (Hardware specific, e.g. ether1 on RB500 can be set to yes/no. Fixed to 'yes' on other hardware.) mtu ( ; Default: ) integer [0..65536] 1500 Layer3 Maximum transmission unit name ( ; Default: ) string Name of an interface orig-mac-address ( ; Default: ) read-only: MAC Original Media Access Control number of an interface. passthrough-interface ( ; Default: ) interface Sets an interface in passthrough mode on CCR2004-1G-2XS-PCIe device. By default, the PCIe interface will show up as four virtual Ethernet interfaces. Two interfaces in passthrough mode to the 25G SFP28 cages. The remaining two virtual Ethernet-PCIe interfaces are bridged with the Gigabit Ethernet port for management access. poe-out ( ; Default: ) auto-on | forced-on | off off Poe Out settings. Read more . poe-priority ( ; Default: ) integer [0..99] Poe Out settings. . Read more sfp-shutdown-temperature ( ; Default: | ) integer 9580 The temperature in Celsius at which the interface will be temporarily turned off due to too high detected SFP module temperature (introduced v6.48). The default value for SFP/SFP+/SFP28 interfaces is 95, and for QSFP+ /QSFP28 interfaces 80 (introduced v7.6). sfp-rate-select ( ; Default: ) high | low high Allows to control rate select pin for SFP ports.

speed (since RouterOS v7.12: 10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT-half | 1G-baseT-full | 1G-baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G- baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | Default: ) 50G-baseCR2 | 100G-baseSR4-LR4 | 100G-baseCR4; (older RouterOS: 10Mbps | 10Gbps | 100Mbps | 1Gbps | 2.5Gbps | ; Default: ) 5Gbps | 25Gbps | 40Gbps | 100GbpsSets interface data transmission speed which takes effect only when auto- is disabled. negotiation Setting higher speeds than the actual interface Single option is allowed. supported speed can result in undefined behavior. Read-only properties Property Description running ( ) yes | no Whether interface is running. Note that some interface does not have running check and they are always reported as "running". slave ( ) yes | no Whether interface is configured as a slave of another interface (for example or ) Bonding Bridge switch ( ) integer ID to which switch chip interface belongs to. Menu specific commands Property Description blink ( ) [id, name] Blink Ethernet leds monitor ( ) [id, name] Monitor ethernet status. . Read more reset-counters ( ) [id, name] Reset stats counters. . Read more reset-mac-address ( ) [id, name] Reset MAC address to manufacturers default. cable-test ( ) string Shows detected problems with cable pairs. . Read More Monitor To print out a current link rate and other Ethernet related properties or to see detailed diagnostics information for transceivers, use "/interface " command. The provided information can differ for different interface types (e.g. Ethernet over twisted pair or SFP interface) or for ethernet monitor different transceivers (e.g. SFP and QSFP). Properties Property Description advertising (since RouterOS v7.12: 10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT- half | 1G-baseT-full | 1G-baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G-baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | 50G-baseCR2 | 100G- baseSR4-LR4 | 100G-baseCR4 ) (older RouterOS: 10M-full | 10M-half | 100M-full | 100M-half | 1000M-full | 1000M-half | 2500M-full | 5000M-full | ) 10000M-fullAdvertised link modes, only applies when auto- is enabled negotiation

auto-negotiation ( ) disabled | done | failed | incomplete Current auto-negotiation status: disabled - negotiation disabled done - negotiation completed failed - negotiation failed incomplete - negotiation not completed yet default-cable-settings ( ) short | standard Default cable length setting (only applicable to NS DP83815/6 cards) short - support short cables standard - support standard cables fec ( ) fec74 | fec91 | off Currect FEC mode. full-duplex ( ) yes | no Whether transmission of data occurs in two directions simultaneously link-partner-advertising (since RouterOS v7.12: 10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT-half | 1G-baseT-full | 1G-baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G-baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | 50G- baseCR2 | 100G-baseSR4-LR4 | 100G-baseCR4 ) (older RouterOS: 10M-full | 10M-half | 100M-full | 100M-half | 1000M-full | 1000M-half | 2500M-full | 5000M-full | ) 10000M-fullLink partner advertised link modes, only applies when is auto-negotiation enabled rate ( ) 10Mbps | 100Mbps | 1Gbps | 2.5Gbps | 5Gbps | 10Gbps | 25Gbps | 40Gbps | 50Gbps | 100Gbps Actual data rate of the connection. status ( ) link-ok | no-link | unknown Current link status of an interface link-ok - the card is connected to the network no-link - the card is not connected to the network unknown - the connection is not recognized (if the card does not report connection status) tx-flow-control ( ) yes | no Whether TX flow control is used rx-flow-control ( ) yes | no Whether RX flow control is used combo-state ( ) copper | sfp Used combo-mode for combo interfaces sfp-module-present ( ) yes | no Whether a transceiver is in cage

sfp-rx-lose ( ) yes | no Whether a receiver signal is lost sfp-tx-fault ( ) yes | no Whether a transceiver transmitter is in fault state sfp-type ( ) SFP/SFP+/SFP28/SFP56 | DWDM-SFP/SFP+ | QSFP | QSFP+ | QSFP28/QSFP56 Used transceiver type sfp-connector-type (SC | LC | optical-pigtail | copper-pigtail | multifiber-parallel-optic-1x12 | no-separable-connector | ) RJ45Used transceiver connector type sfp-link-length-9um ()m Transceiver supported link length for single mode 9 /125um fiber sfp-link-length-50um ()m Transceiver supported link length for multi mode 50 /125um fiber (OM2) sfp-link-length-62um ()m Transceiver supported link length for multi mode 62.5 /125um fiber (OM1) sfp-link-length-copper ()m Supported link length of copper transceiver sfp-vendor-name ( ) string Transceiver manufacturer sfp-vendor-part-number ( ) string Transceiver part number sfp-vendor-revision ( ) string Transceiver revision number sfp-vendor-serial ( ) string Transceiver serial number sfp-manufacturing-date ( )date Transceiver manufacturing date sfp-wavelength ()nm Transceiver transmitter optical signal wavelength sfp-temperature ()C Transceiver temperature sfp-supply-voltage ()V Transceiver supply voltage sfp-tx-bias-current ()mA Transceiver Tx bias current sfp-tx-power ( )dBm Transceiver transmitted optical power sfp-rx-power ( )dBm Transceiver received optical power sfp-supported (10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT-half | 1G-baseT-full | 1G-baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G-baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | 50G-baseCR2 | 100G-baseSR4-LR4 | 100G- ) baseCR4Module supported link modes. This property only applies to certain devices. supported (10M-baseT-half | 10M-baseT-full| 100M-baseT-half | 100M-baseT-full | 1G-baseT-half | 1G-baseT-full | 1G- baseX | 2.5G-baseT | 2.5G-baseX | 5G-baseT | 10G-baseT | 10G-baseSR-LR | 10G-baseCR | 40G-baseSR4-LR4 | 40G-baseCR4 | 25G-baseSR-LR | 25G-baseCR | 50G-baseSR2-LR2 | 50G-baseCR2 | 100G-baseSR4-LR4 | 100G- ) baseCR4Shows the supported interface hardware link mode capabilities. eeprom-checksum ( ) good | bad Whether EEPROM checksum is correct eeprom ( ) hex dump Raw EEPROM of the transceiver

Detect Cable Problems A cable test can detect problems or measure the approximate cable length if the cable is unplugged on the other end and there is, therefore, "no-link". RouterOS will show: which cable pair is damaged the distance to the problem how exactly the cable is broken - short-circuited or open-circuited This also works if the other end is simply unplugged - in that case, the total cable length will be shown. Here is an example output: [admin@CCR] > interface ethernet cable-test ether2 name: ether2 status: no-link cable-pairs: open:4,open:4,open:4,open:4 In the above example, the cable is not shorted but “open” at 4 meters distance, all cable pairs are equally faulty at the same distance from the switch chip. Currently is implemented on the following devices: cable-test Devices CCR series devices RB952Ui-5ac2nD CRS1xx series devices RB962UiGS-5HacT2HnT CRS2xx series devices RB1100AHx2 OmniTIK series devices RB1100x4 RB450G series devices RBD52G-5HacD2HnD RB951 series devices RBcAPGi-5acD2nD RB2011 series devices RBmAP2n RB4011 series devices RBmAP2nD RB750Gr2 RBwsAP-5Hac2nD RB750UPr2 RB3011UiAS-RM RB751U-2HnD RBMetal 2SHPn RB850Gx2 RBDynaDishG-5HacD RB931-2nD RBLDFG-5acD RB941-2nD RBLHGG-5acD Stats Using " command, it is possible to see a wide range of Ethernet-related statistics. The list of statistics can differ /interface ethernet print stats " between RouterBoard devices due to different Ethernet drivers. The list below contains all available counters across all RouterBoard devices. Most of the Ethernet statistics can be remotely monitored using and MIKROTIK-MIB. SNMP Currently is not supported on Combo ports. cable-test

Property Description driver-rx-byte ( ) integer Total count of received bytes on device CPU driver-rx-packet ( ) integer Total count of received packets on device CPU driver-tx-byte ( ) integer Total count of transmitted bytes by device CPU driver-tx-packet ( ) integer Total count of transmitted packets by device CPU fc-fec-block-corrected ( ) integer Total count of FC-FEC corrected blocks. Applies only when mode is used. fec74 fc-fec-block-uncorrected (integ )erTotal count of FC-FEC uncorrected blocks. Applies only when mode is used. fec74 fc-fec-rx-block ( ) integer Total count of FC-FEC received blocks. Applies only when mode is used. fec74 rs-fec-corrected ( ) integer Total count of RS-FEC corrected codewords. Applies only when mode is used. fec91 rs-fec-symbol-error ( ) integer Total count of RS-FEC symbol errors. Applies only when mode is used. fec91 rs-fec-uncorrected ( ) integer Total count of RS-FEC uncorrected codewords. Applies only when mode is used. fec91 rx-64 ( ) integer Total count of received 64 byte frames rx-65-127 ( ) integer Total count of received 65 to 127 byte frames rx-128-255 ( ) integer Total count of received 128 to 255 byte frames rx-256-511 ( ) integer Total count of received 256 to 511 byte frames rx-512-1023 ( ) integer Total count of received 512 to 1023 byte frames rx-1024-1518 ( ) integer Total count of received 1024 to 1518 byte frames rx-1519-max ( ) integer Total count of received frames larger than 1519 bytes rx-align-error ( ) integer Total count of received align error events - packets where bits are not aligned along octet boundaries rx-broadcast ( ) integer Total count of received broadcast frames rx-bytes ( ) integer Total count of received bytes rx-carrier-error ( ) integer Total count of received frames with carrier sense error rx-code-error ( ) integer Total count of received frames with code error rx-control ( ) integer Total count of received control or pause frames rx-error-events ( ) integer Total count of received frames with the active error event rx-fcs-error ( ) integer Total count of received frames with incorrect checksum rx-fragment ( ) integer Total count of received fragmented frames (not related to IP fragmentation) rx-ip-header-checksum-error (i ) ntegerTotal count of received frames with IP header checksum error rx-jabber ( ) integer Total count of received jabbed packets - a packet that is transmitted longer than the maximum packet length rx-length-error ( ) integer Total count of received frames with frame length error rx-multicast ( ) integer Total count of received multicast frames rx-overflow ( ) integer Total count of received overflowed frames can be caused when device resources are insufficient to receive a certain frame rx-pause ( ) integer Total count of received pause frames rx-runt ( ) integer Total count of received frames shorter than the minimum 64 bytes, is usually caused by collisions rx-tcp-checksum-error ( ) integer Total count of received frames with TCP header checksum error

rx-too-long ( ) integer Total count of received frames that were larger than the maximum supported frame size by the network device, see themax-l2mtu property rx-too-short ( ) integer Total count of the received frame shorter than the minimum 64 bytes rx-udp-checksum-error ( ) integer Total count of received frames with UDP header checksum error rx-unicast ( ) integer Total count of received unicast frames rx-unknown-op ( ) integer Total count of received frames with unknown Ethernet protocol tx-64 ( ) integer Total count of transmitted 64 byte frames tx-65-127 ( ) integer Total count of transmitted 65 to 127 byte frames tx-128-255 ( ) integer Total count of transmitted 128 to 255 byte frames tx-256-511 ( ) integer Total count of transmitted 256 to 511 byte frames tx-512-1023 ( ) integer Total count of transmitted 512 to 1023 byte frames tx-1024-1518 ( ) integer Total count of transmitted 1024 to 1518 byte frames tx-1519-max ( ) integer Total count of transmitted frames larger than 1519 bytes tx-align-error ( ) integer Total count of transmitted align error events - packets where bits are not aligned along octet boundaries tx-broadcast ( ) integer Total count of transmitted broadcast frames tx-bytes ( ) integer Total count of transmitted bytes tx-collision ( ) integer Total count of transmitted frames that made collisions tx-control ( ) integer Total count of transmitted control or pause frames tx-deferred ( ) integer Total count of transmitted frames that were delayed on its first transmit attempt due to already busy medium tx-drop ( ) integer Total count of transmitted frames that were dropped due to the already full output queue tx-excessive-collision ( ) integer Total count of transmitted frames that already made multiple collisions and never got successfully transmitted tx-excessive-deferred ( ) integer Total count of transmitted frames that were deferred for an excessive period of time due to an already busy medium tx-fcs-error ( ) integer Total count of transmitted frames with incorrect checksum tx-fragment ( ) integer Total count of transmitted fragmented frames (not related to IP fragmentation) tx-carrier-sense-error ( ) integer Total count of transmitted frames with carrier sense error tx-late-collision ( ) integer Total count of transmitted frames that made collision after being already halfway transmitted tx-multicast ( ) integer Total count of transmitted multicast frames tx-multiple-collision ( ) integer Total count of transmitted frames that made more than one collision and subsequently transmitted successfully tx-overflow ( ) integer Total count of transmitted overflowed frames tx-pause ( ) integer Total count of transmitted pause frames tx-all-queue-drop-byte ( ) integer Total count of transmitted bytes dropped by all output queues tx-all-queue-drop-packet (integ )erTotal count of transmitted packets dropped by all output queues tx-queueX-byte ( ) integer Total count of transmitted bytes on a certain queue, the should be replaced with a queue number X tx-queueX-packet ( ) integer Total count of transmitted frames on a certain queue, the should be replaced with a queue number X tx-runt ( ) integer Total count of transmitted frames shorter than the minimum 64 bytes, is usually caused by collisions tx-too-short ( ) integer Total count of transmitted frames shorter than the minimum 64 bytes

CRS309-1G-8S+ + + + + + + + + + + CRS312-4C+8XG - + + + + + + + + + CRS318-1Fi-15Fr-2S + + + + + + + + + + CRS318-16P-2S+ + + + + + + + + + + CRS320-8P-8B-4S+ + + + + + + + + + + CRS326-4C+20G+2Q+ + + + + + + + + + + CRS326-24S+2Q+ + + + + + + + + + + CRS354-48G/P-4S+2Q+ + + + + + + + + + + CRS520-4XS-16XQ + + + + + + + + + + CRS518-16XS-2XQ + + + + + + + + + + CRS510-8XS-2XQ + + + + + + + + + + CSS/CRS326-24G-2S+ + + + + + + + + + + CRS317-1G-16S+ + + + + + + + + + + CRS328-4C-20S-4S+ + + + + + + + + + + CRS328-24P-4S+ + + + + + + + + + + CRS226-24G-2S+ - + 2 + 2 + 2 + 2 + 2 + + + + CRS212-1G-10S-1S+ + 1 + 1 + 1 + 1 + 1 + 1 + + + + CRS210-8G-2S+ - + 2 + 2 + 2 + 2 + 2 + + + + CRS112-8G/P-4S + + + + + + + + + + CRS109-8G-1S + + + + + + + + + + CRS106-1C-5S/FiberBox + + + + + + + + + + RB5009 + + + + + + + + + + RB4011 + + + + + + + + + + RB3011 + + + + + + + + + + RB2011 + + + + + + + + + + L009 + + + + + + + + 14 + 14 + 14 RB260/CSS106 + + + + + + + + + + RB922/921 + + + + + + + + + + RB953GS + + + + + + + + + + hAP AC + + + + + + + + + + hEX PoE/PowerBox Pro + + + + + + + + + + hEX S + + + + + + + + + + RBFTC11 + + 8 + 8 + 8 + 8 + 8 + 8 + 8 + 8 + 8 FTC11XG + + + + + + + + + + LHG XL 52 ac - + + + + + + + + + RBD22/D23 mANTBox 52 15s/NetMetal ac²- + + + + + + + + + L22/mANTBox ax 15s L23/NetMetal ax+ + 15 + 15 + 15 + 15 + 15 + 15 + 14 + 14 + 14 GPEN21 + + + + + + + + + + CSS610 + + + + + + + + + + CRS310-1G-5S-4S+/netFiber 9+ + + + + + + + + + CRS310-8G+2S+IN + + + + + + + + + + 10G SFP+/25G SFP28 Model S+RJ 10S+85DLC 03DS+31DLC 10DS+2332LC 10DSFP+ CWDMSFP+ / 1m3m DACS+AO0005 AOCQ+BC0003 -S+XQ+BC0003- XS+SFP28 / 1m3m DACSFP28 XS+31L C10DSFP28 XS+2733L C15DSFP28 XS+85L C01D CCR1072-1G-8S+ + + + + + + + + 5 + 5 + + + + CCR1036-12G-4S - + + + + + + - - + + + +

CCR1036-8G-2S+ + + + + + + + + 5 + 5 + + + + CCR1016-12S-1S+ + 10 + + + + + + + 1,5 + 1,5 + + + + CCR1009-7G-1C - + + + + + + - - + + + + CCR1009-8G-1S-1S+ + 10 + + + + + + + 5 + 5 + + + + CCR1009-7G-1C-1S+ + + + + + + + + 5 + 5 + + + + CCR2004-1G-2XS-PCIe + + + + + + + + 5 + 5 + + + + CCR2004-1G-12S+2XS + 11 + + + + + + + 5 + 5 + + + + CCR2004-16G-2S+ + + + + + + + + 5 + 5 + + + + CCR2116-12G-4S+ + + + + + + + + 5 + 5 + + + + CCR2216-1G-12XS- 2XQ+ + + + + + + + + + + + + CRS125-24G-1S - + + + + + + - - + + + + CRS305-1G-4S+ + 7 + + + + + + + 5 + 5 + + + + CRS309-1G-8S+ + 4 + + + + + + + 5 + 5 + + + + CRS312-4C+8XG + + + + + + + + 5 + 5 + + + + CRS318-1Fi-15Fr-2S - + + + + + + - - + + + + CRS318-16P-2S+ + + + + + + + + 5 + 5 + + + + CRS320-8P-8B-4S+ + + + + + + + + + + + + + CRS326-4C+20G+2Q+ + + + + + + + + + + + + + CRS326-24S+2Q+ + 6 + + + + + + + + + + + + CRS354-48G/P- 4S+2Q++ + + + + + + + + + + + + CRS520-4XS-16XQ + + + + + + + + + + + + + CRS518-16XS-2XQ + + + + + + + + + + + + + CRS510-8XS-2XQ + + + + + + + + + + + + + CSS/CRS326-24G-2S+ + + + + + + + + 5 + 5 + + 9 + 9 + CRS317-1G-16S+ + 3 + + + + + + + 5 + 5 + + + + CRS328-4C-20S-4S+ + 10 + + + + + + + 5 + 5 + + + + CRS328-24P-4S+ + + + + + + + + 5 + 5 + + 9 + 9 + CRS226-24G-2S+ + + + + + + + + 5 + 5 + + + + CRS212-1G-10S-1S+ + 10 + + + + + + + 5 + 5 + + + + CRS210-8G-2S+ + + + + + + + + 5 + 5 + + + + CRS112-8G/P-4S - + + + + + + - - + + + + CRS109-8G-1S - + + + + + + - - + + + + CRS106-1C-5S /FiberBox- + + + + + + - - + + + + RB5009 + + + + + + + + 5 + 5 + + + + RB4011 + + + + + + + + + + + + + RB3011 - + + + + + + - - + + + + RB2011 - + + + + + + - - + + + + L009 - + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 RB260/CSS106 - + + + + + + - - + + + + RB922/921 - + + + + + + - - + + + + RB953GS - + + + + + + - - + + + + hAP AC - + + + + + + - - + + + + hEX PoE/PowerBox Pro - + + + + + + - - + + + + hEX S - + + + + + + - - + + + + RBFTC11 - + 8 + 8 + 8 + 8 + 8 + 8 - - + 8 + 8 + 8 + 8 FTC11XG + + + + + + + + 5 + 5 + + + + LHG XL 52 ac - + + + + + + - - + + + + RBD22/D23 mANTBox 52 15s /NetMetal ac²- + + + + + + - - + + + + L22/mANTBox ax 15s L23/NetMetal ax- + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 + 14 CSS610 + + + + + + + + 5 + 5 + + + + CRS310-1G-5S-4S+ /netFiber 9+ 10 + + + + + + + 5 + 5 + + + + CRS310-8G+2S+IN + + + + + + + + 5 + 5 + + + +

40G QSFP+ Model QSFP+ Q+DA0001 Q+85MP01D Q+BC0003-S+ CRS326-4C+20G+2Q+ + + + CRS326-24S+2Q+ + + + CRS354-48G/P-4S+2Q+ + + + CRS504-4XQ-IN + + + CRS504-4XQ-OUT +13 + +13 CRS510-8XS-2XQ + + + CRS518-16XS-2XQ + + + CRS520-4XS-16XQ + + + CCR2216-1G-12XS-2XQ + + + 100G QSFP28 Model XQ+31LC10D XQ+31LC02D XQ+85MP01D XQ+DA0001 XQ+DA0003 XQ+BC0003-XS+ XQ+CM0000-XS+ CRS326-4C+20G+2Q+ - - + + + + + CRS326-24S+2Q+ - - + + + + + CRS354-48G/P-4S+2Q+ - - + + + + + CRS504-4XQ-IN + + + + + + + CRS504-4XQ-OUT + + + +13 +13 +13 + CRS510-8XS-2XQ + + + + + + + CRS518-16XS-2XQ + + + + + + + CRS520-4XS-16XQ + + + + + + + CCR2216-1G-12XS-2XQ + + + + + + + Legend Color codes: Not supported Check notes below

CSS/CRS309-1G-8S+ + + + CRS318-1Fi-15Fr-2S + + + CRS318-16P-2S+ + + + CSS/CRS326-24G-2S+ + + + CRS354 + + + CSS/CRS328-4C-20S-4S+ + + + CSS/CRS328-24P-4S+ + + + CSS/CRS317-1G-16S+ + + + CRS326-4C+20G+2Q+ + + + CRS326-24S+2Q+ + + + CSS610 + + + FTC11XG + + + CRS310-1G-5S-4S+/netFiber 9 + + + CRS310-8G+2S+IN + + + CCR1009 +/+ +/+ +/+ CCR1016-12S-1S+ + + + CCR1036-12G-4S + + + CCR1036-8G-2S+ + + + CCR1072-1G-8S+ + + + 10 Gigabit Ethernet S+RJ10 Use these modules only in 10G SFP+ ports with enabled, forced link speeds and configurable link speed advertisements are not auto-negotiation supported. They will negotiate to correct duplex and highest possible rate. For proper S+RJ10 module installation and recommended use case scenarios, please read . S+RJ10 General Guidance Speed Cable type S+RJ10 to Ethernet port 10BASE-T Cat5e/6 100m 100BASE-T Cat5e/6 100m 1000BASE-T Cat5e/6 100m 2.5GBASE-T Cat5e/6 UTP 100m 2.5GBASE-T Cat5e/6 STP 100m 5GBASE-T Cat5e/6 100m 10GBASE-T Cat6/7 30m Notes Rate works fine: + Rate does not work: - RB953: SFP1/SFP2 CCR1009: SFP+/SFP

The latest revision of S+RJ10 contains "/r2" by the end of serial number. It comes with following improvements: Jumbo frames up to 10218 Bytes at 2.5G, 5G and 10G speeds; Actual link speed reporting; DDM monitoring (Supply Voltage, Module temperature). Link Speed Max MTU 10Gbps 10218 5Gbps 10218 2.5Gbps 10218 1000Mbps 1504 100Mbps 1504 10Mbps 1504 CRS312-4C+8XG 10GE ports maximum supported cable length. Speed Cable type 10 Gigabit Ethernet ports 10BASE-T Cat5e/6 100m 100BASE-T Cat5e/6 100m 1000BASE-T Cat5e/6 100m 2.5GBASE-T Cat5e/6 100m 5GBASE-T Cat5e/6 100m 10GBASE-T Cat6/7 30m SFP interface compatibility with 100M optical transceivers SFP interface on the listed devices is compatible with links. fast ethernet fiber Compatible devices (interface): CCR1009-7G-1C (combo1) CCR1009-7G-1C-1S+ (combo1) CRS106-1C-5S (combo1) CRS328-4C-20S-4S+ (combo1 - combo4 and SFP1 - SFP20) LHG XL 52 ac The negotiated speed is highly dependent on the quality and length of the cables used. S+RJ10 to S+RJ10 will always negotiate to the highest possible rate. The negotiated speed is highly dependent on the quality and length of the cables used. 10GE ports do not support half-duplex mode with forced link speeds.

For RouterOS v7.12 and later: # QSFP+ - DAC /interface ethernet set qsfpplus1-1 auto-negotiation=no speed=10G-baseCR /interface ethernet set qsfpplus1-2 auto-negotiation=no speed=10G-baseCR /interface ethernet set qsfpplus1-3 auto-negotiation=no speed=10G-baseCR /interface ethernet set qsfpplus1-4 auto-negotiation=no speed=10G-baseCR # QSFP+ - Optical /interface ethernet set qsfpplus1-1 auto-negotiation=no speed=10G-baseSR-LR /interface ethernet set qsfpplus1-2 auto-negotiation=no speed=10G-baseSR-LR /interface ethernet set qsfpplus1-3 auto-negotiation=no speed=10G-baseSR-LR /interface ethernet set qsfpplus1-4 auto-negotiation=no speed=10G-baseSR-LR # QSFP28 - DAC /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=25G-baseCR /interface ethernet set qsfp28-1-2 auto-negotiation=no speed=25G-baseCR /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=25G-baseCR /interface ethernet set qsfp28-1-4 auto-negotiation=no speed=25G-baseCR # QSFP28 - Optical /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=25G-baseSR-LR /interface ethernet set qsfp28-1-2 auto-negotiation=no speed=25G-baseSR-LR /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=25G-baseSR-LR /interface ethernet set qsfp28-1-4 auto-negotiation=no speed=25G-baseSR-LR It is also possible to use QSFP28 to 2x50G QSFP28 Breakout Cables: # 2x50G - DAC /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=50G-baseCR2 /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=50G-baseCR2 # 2x50G - Optical /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=50G-baseSR2-LR2 /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=50G-baseSR2-LR2 Or to configure different speed rates for each QSFP+/QSFP28 sub-interfaces: # QSFP28 - DAC /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=25G-baseCR /interface ethernet set qsfp28-1-2 auto-negotiation=no speed=25G-baseCR /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=10G-baseCR /interface ethernet set qsfp28-1-4 auto-negotiation=no speed=10G-baseCR # QSFP28 - Optical /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=25G-baseSR-LR /interface ethernet set qsfp28-1-2 auto-negotiation=no speed=25G-baseSR-LR /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=10G-baseSR-LR /interface ethernet set qsfp28-1-4 auto-negotiation=no speed=10G-baseSR-LR For RouterOS versions earlier than v7.12: # QSFP+ - DAC/Optical /interface ethernet set qsfpplus1-1 auto-negotiation=no speed=10Gbps full-duplex=yes /interface ethernet set qsfpplus1-2 auto-negotiation=no speed=10Gbps full-duplex=yes /interface ethernet set qsfpplus1-3 auto-negotiation=no speed=10Gbps full-duplex=yes /interface ethernet set qsfpplus1-4 auto-negotiation=no speed=10Gbps full-duplex=yes # QSFP28 - DAC/Optical /interface ethernet set qsfp28-1-1 auto-negotiation=no speed=25Gbps full-duplex=yes /interface ethernet set qsfp28-1-2 auto-negotiation=no speed=25Gbps full-duplex=yes /interface ethernet set qsfp28-1-3 auto-negotiation=no speed=25Gbps full-duplex=yes /interface ethernet set qsfp28-1-4 auto-negotiation=no speed=25Gbps full-duplex=yes

PWR Line Summary The PWR-Line series devices allow Ethernet-like connectivity between supported devices over regular power lines. When plugged into the same electrical circuit, the PWR-Line devices will establish connectivity by using the HomePlug AV standard. Properties arp (disabled | enabled | proxy-arp | ; Default: reply-only e ) nabledAddress Resolution Protocol mode: disabled - the interface will not use ARP enabled - the interface will use ARP proxy-arp - the interface will use the ARP proxy feature reply-only - the interface will only reply to requests originating from matching IP address/MAC address combinations which are entered as static entries in the "/ip arp" table. No dynamic entries will be automatically stored in the ARP table. Therefore for communications to be successful, a valid static entry must already exist. bandwidth (integer ; Default: /integer unli ) mited/unlimitedSets max rx/tx bandwidth in kbps that will be handled by an interface. TX limit is supported on all Atheros ports. RX switch-chip limit is supported only on Atheros8327/QCA8337 switch-chip ports. comment ( ; string Default: )Descriptive name of an item l2mtu (integer [0.. ; Default: ) 65536]Layer2 Maximum transmission unit. MTU in RouterOS mac-address ( ; MAC Default: )Media Access Control number of an interface. mtu (integer [0.. ; Default: ) 65536] 1500Layer3 Maximum transmission unit name ( ; string Default: )Name of an interface orig-mac-address (M ; Default: )AC rx-flow-control (on | ; Default: ) off | auto offWhen set to on, the port will process received pause frames and suspend transmission if required. is the same as auto on except when auto-negotiation=yes flow control status is resolved by taking into account what the other end advertises. The feature is supported on AR724x, AR9xxx, and QCA9xxx CPU ports, all CCR ports, and all Atheros switch chip ports. tx-flow-control (on | ; Default: ) off | auto offWhen set to on, the port will send pause frames when specific buffer usage thresholds are met. is the same as except auto on when auto-negotiation=yes flow control status is resolved by taking into account what the other end advertises. The feature is supported on AR724x, AR9xxx, and QCA9xxx CPU ports, all CCR ports, and all Atheros switch chip ports. Menu specific commands Property Description configure () The command configures the attached PWR-Line device's network-key, network-password, plc-cco-selection-mode. join () Initiates the pairing sequence which will look for other PWR-Line devices in the same electrical circuit that is also in the pairing mode. This mode lasts for 60 seconds. leave () Initiates the leaving sequence which essentially randomizes the device's network-key. monitor () Outputs PWR-Line-related statuses in real-time.

plc-cco-selection-mode ( ; auto | always | never Default: )autoSets PWR-Line device mode: auto - PWR-Line will automatically decide what role to take depending on the situation upon joining a PWR-Line network. always - PWR-Line will always be forced to act as "central-coordinator" or master device. never - PWR-Line will always be forced to act as a slave device. Example: /interface pwr-line configure pwr-line1 plc-cco-selection-mode=auto /interface pwr-line configure pwr-line1 plc-cco-selection-mode=always /interface pwr-line configure pwr-line1 plc-cco-selection-mode=never Sync Button usage Hold 0.5 – 3 seconds to turn on sync mode. For 120 seconds will try to communicate with another PWR-LINE device. A blinking orange LED light indicates that it is in search mode. You have to also do the same on the other PWR-LINE device, so they can synchronize. Press the button again to cancel the search. You can also manually set the security keys in RouterOS settings. Hold 5 – 8 seconds to generate a new security key. This is needed to remove a PWR-LINE device from an existing PWR-LINE network. Hold 10 – 15 seconds to reset all PWR-LINE related settings. Supported Hardware The device is fully compatible with our PWR-LINE AP and the newest revisions of products that have a MicroUSB port, such as hAP lite, hAP lite tower, hAP mini, mAP, and mAP lite have a pwr-line interface. A simple software upgrade to v6.44+ enables this feature (supported by the mentioned devices with serial numbers that end with /9xx). PWR-LINE functionality is also supported by some previously manufactured units - if you have a unit with a serial number that ends with /8xx, upgrade to 6.44+ and see if the pwr-line interface shows up).

WiFi Overview WiFi Terminology Basic Configuration Configuration profiles Access List MAC address authentication Access rule examples Frequency scan Scan command Sniffer Spectral scan Spectral history WPS WPS client WPS server Radios Registration table De-authentication WiFi CAPsMAN Radio Provisioning CAPsMAN - CAP simple configuration example: CAPsMAN - CAP VLAN configuration example: CAPsMAN: CAP using "wifi-qcom" package: CAP using "wifi-qcom-ac" package: CAPsMAN - OWE configuration example: CAPsMAN: CAP: Advanced examples Replacing 'wireless' package Compatibility Benefits Lost features Property Reference AAA properties Channel properties Configuration properties Datapath properties Security Properties Security multi-passphrase properties Steering properties Miscellaneous properties Read-only properties Access List Frequency scan Flat-snoop Scan command Sniffer WPS Radios Registration table CAPsMAN Global Configuration CAPsMAN Provisioning CAP configuration Overview The 'WiFi' configuration menu, introduced in , is a RouterOS menu for managing Wi-Fi 5 wave2 and newer WiFi interfaces. RouterOS 7.13

/interface wifi access-list add action=accept disabled=no mac-address=22:F9:70:E5:D2:8E interface=wifi1 passphrase=StrongPassword Frequency scan The '/interface/wifi/frequency-scan wifi1' command provides information about RF conditions on available channels that can be obtained by running the frequency-scan command. Used to approximate the spectrum usage, it can be useful to find less crowded frequencies. Scan command The '/interface wifi scan' command will scan for access points and print out information about any APs it detects. It doesn't show the frequency usage, per channel, but it will reveal all access points that are transmitting. You can use the "connect" button, to initiate a connection to a specific AP. The scan command takes all the same parameters as the frequency-scan command. Running a frequency scan will disconnect all connected clients, or if the interface is in station mode, it will disconnect from AP.

Sniffer The sniffer command enables monitor mode on a wireless interface. This turns the interface into a passive receiver for all WiFi transmissions. The command continuously prints out information on received packets and can save them locally to a pcap file or stream them using the TZSP protocol. The sniffer will operate on whichever channel is configured for the chosen interface. Spectral scan The spectral scan can scan frequencies supported by your wifi interface, and plot them directly in the console. The spectral scan has been available since the 7.16beta1 version.

/interface/wifi/spectral-scan <wifiinterface name> range= Continuously monitors spectral data. This command uses the same data source as 'spectral-history', and shares many parameters. To use spectral scan, you must use the "range=" attribute. Each line displays one spectrogram bucket -- frequency, magnitude (dBm), peak, and a character graphic bar. A bar shows power value with ':' characters and average peak hold with '.' characters. data - min/max/avg, by default average is used for data. The average should be used in most scenarios, but in some cases "min" can be useful to check if there are any frequencies that have a constant signal output on them. Max represents the strongest signal that was detected during the interval of the scan, similar to the peak. - terminate command after a specified time. default is indefinite; duration - Time interval at which to update command output freeze-frame-interval - interval of how often to update the primary data values, not peak interval - avg/max/disabled - peak reflects the strongest signal over peak-hold-duration. By default "avg" is used, it is the average of max values over peak-mode "peak-hold-duration", if "max" is used, then the highest value will be shown until the next "peak-hold-duration" update. - changes the peak hold duration used by peak-mode, by default 5 seconds. peak-hold-duration - scan specific range, required;range - frequency step for spectral scan resolution - yes/no show-interference Possible types of classified interference: Microwave oven ( )MWO Continuous Wave ( )CW WLAN (Wideband) ( )WIFI Spectral scan is supported only by the wifi-qcom driver, it is not supported by the wifi-qcom-ac driver.

Cordless phone 2.4 ( ) CORDLESS24 Cordless phone 5 ( ) CORDLESS5 Bluetooth ( ) BLUETOOTH Frequency hopping spread spectrum ( )FHSS Spectral history /interface/wifi/spectral-history <wifi interface name> range= Plots spectrogram. Power values that fall in different ranges are printed as different colored characters with the same foreground and background color, so it is possible to copy and paste the terminal output of this command. data - min/max/avg, by default average is used for data. The average should be used in most scenarios, but in some cases "min" can be useful to check if there are any frequencies that have a constant signal output on them. Max will show the strongest signal that was detected, instead of the average signal. - interval of how often to update the data values; interv - interval at which spectrogram lines are printed; interval - terminate command after a specified time. default is indefinite; duration - scan specific range, required;range - frequency step; resolution - yes/no show-interference Possible types of classified interference: Microwave oven ( )O Continuous Wave ( )C WLAN (Wideband) ( )W Cordless phone 2.4 ( )T Cordless phone 5 ( )T Bluetooth ( )BB Frequency hopping spread spectrum ( )F WPS WPS client The wps-client command enables obtaining authentication information from a WPS-enabled AP. /interface/wifi/wps-client wifi1 WPS server An AP can be made to accept WPS authentication by a client device for 2 minutes by running the following command. /interface/wifi wps-push-button wifi1

Any RouterOS device, that supports the WiFi package, can be a controlled wireless access point (CAP) as long as it has at least a Level 4 RouterOS license. WiFi CAPsMAN server can be installed on any RouterOS device that supports the WiFi package, even if the device itself does not have a wireless interface Unlimited CAPs (access points) supported by CAPsMAN Radio Provisioning CAPsMAN distinguishes between actual wireless interfaces (radios) based on their built-in MAC address (radio-mac). This implies that it is impossible to manage two radios with the same MAC address on one CAPsMAN. Radios currently managed by CAPsMAN (provided by connected CAPs) are listed in / interface/wifi/radio menu, this list will also include the built-in wifi interfaces that are present on CAPsMAN itself if there are any: [admin@c52i] > interface/wifi/radio/print Flags: L - LOCAL Columns: CAP, RADIO-MAC, INTERFACE # CAP RADIO-MAC INTERFACE 0 L 18:FD:74:AF:F4:28 wifi1 1 L 18:FD:74:AF:F4:29 wifi2 2 hapAX3@192.168.88.30 48:A9:8A:0B:F7:4B cap1 When CAP connects, CAPsMAN at first tries to bind each CAP radio to CAPsMAN master interface based on radio-mac. If an appropriate interface is found, the radio gets set up using master interface configuration and configuration of slave interfaces that refer to a particular master interface. At this moment interfaces (both master and slaves) are considered bound to radio and radio is considered provisioned. This happens only if there were matching static entries already present under , typically if the entry was made previously either manually, or with provisioning rules that contain /interface/wifi action "create-enabled" or "create-disabled". If no matching master interface for radio is found, CAPsMAN executes 'provisioning rules', which are defined under . /interface/wifi/provisioning/ Provisioning rules is an ordered list of rules that contain settings that specify which radio to match and settings that determine what action to take if a radio matches. When CAP joins CAPsMAN, and there is no matching interface for it present under , provisioning rules will automatically be checked, /interface/wifi once a match is found, the CAP's wireless interface will appear under . Such an interface is "provisioned", provisioned in this context /interface/wifi means that there is a wifi interface present for the radio, and it has a configuration profile assigned to it. There is also an option to manually provision interfaces, which will make CAPsMAN start evaluating provisioning rules against the specific interface, and a new interface will be created upon match. If there was already an entry present for the radio under , that entry will be deleted and re- /interface/wifi/ created. Manual provisioning re-creates the interface and is , since provisioning rules are evaluated automatically, and if you change generally not needed the configuration profile associated with the provisioning rule, the changes will be applied to all wifi interfaces that use that configuration. If you manually provision interfaces, the interface ID or name can change, resulting in broken references to other objects, for example, bridge ports. Manual provision can be done under to provision all radios associated with specific CAPs, it /interface/wifi/capsman/remote-cap/provision can also be done under , to provision specific radios. /interface/wifi/radio/provision CAPsMAN cannot manage it's own wifi interfaces using , it is enough to just set the same configuration profile on configuration.manager=capsman local interfaces manually as you would with provisioning rules, and the end result will be the same as if they were CAPs. That being said, it is also possible to provision local interfaces via menu, it should be noted that to regain control of local interfaces after provisioning, you will /interface/wifi/radio need to disable the matching provisioning rules and press "provision" again, which will return local interfaces to an unconfigured state. CAPsMAN - CAP simple configuration example: WiFi CAPsMAN can only control WiFi interfaces, and WiFi CAPs can join only WiFi CAPsMAN, similarly, regular CAPsMAN only supports non- WiFi caps. The CAPs don't send traffic usage information to CAPsMAN. Provision must be done only initially, and is done automatically upon CAP joining if there are matching provisioning rules that are enabled. If you adjust any configuration profile that is linked to the provisioned interface, all changes will be "pushed" as soon as you apply changes to the profile, with no need to re-create the already existing interface. Provisioning itself is not for sending configuration, it is for essentially creating a new interface. In most cases, there is no reason to perform manual provisioning once you already have CAP interfaces running.

CAPsMAN in WiFi uses the same menu as a regular WiFi interface, meaning when you pass configuration to CAPs, you have to use the same configuration, security, channel configuration, etc. as you would for regular WiFi interfaces. CAPsMAN: #create a security profile /interface wifi security add authentication-types=wpa3-psk name=sec1 passphrase=HaveAg00dDay #create configuraiton profiles to use for provisioning /interface wifi configuration add country=Latvia name=5ghz security=sec1 ssid=CAPsMAN_5 add name=2ghz security=sec1 ssid=CAPsMAN2 add country=Latvia name=5ghz_v security=sec1 ssid=CAPsMAN5_v #configure provisioning rules, configure band matching as needed /interface wifi provisioning add action=create-dynamic-enabled master-configuration=5ghz slave-configurations=5ghz_v supported-bands=\ 5ghz-n add action=create-dynamic-enabled master-configuration=2ghz supported-bands=2ghz-n #enable CAPsMAN service /interface wifi capsman set ca-certificate=auto enabled=yes CAP: #enable CAP service, in this case CAPsMAN is on same LAN, but you can also specify "caps-man-addresses=x.x.x.x" here /interface/wifi/cap set enabled=yes #set configuration.manager= on the WiFi interface that should act as CAP /interface/wifi/set wifi1,wifi2 configuration.manager=capsman-or-local CAPsMAN - CAP VLAN configuration example: In this example, we will assign VLAN10 to our main SSID, and will add VLAN20 for the guest network, ether5 from CAPsMAN is connected to CAP. CAPsMAN: You can configure sub-configuration menus, directly under "/interface/wifi/configuration" or reference previously created profiles in the main configuration profile If the CAP is hAP ax or hAP ax , it is strongly recommended to enable RSTP in the bridge configuration, on the CAP2 3 configuration.manager should only be set on the CAP device itself, don't pass it to the CAP or configuration profile that you provision. The interface that should act as CAP needs additional configuration under "interface/wifi/set wifiX configuration.manager=" CAPs using "wifi-qcom" package can get "vlan-id" via Datapath from CAPsMAN, CAPs using "wifi-qcom-ac" package will need to use the configuration provided at the end of this example.

/interface bridge add name=br vlan-filtering=yes /interface vlan add interface=br name=MAIN vlan-id=10 add interface=br name=GUEST vlan-id=20 /interface wifi datapath add bridge=br name=MAIN vlan-id=10 add bridge=br name=GUEST vlan-id=20 /interface wifi security add authentication-types=wpa2-psk,wpa3-psk ft=yes ft-over-ds=yes name=Security_MAIN passphrase=HaveAg00dDay add authentication-types=wpa2-psk,wpa3-psk ft=yes ft-over-ds=yes name=Security_GUEST passphrase=HaveAg00dDay /interface wifi configuration add datapath=MAIN name=MAIN security=Security_MAIN ssid=MAIN_Network add datapath=GUEST name=GUEST security=Security_GUEST ssid=GUEST_Network /ip pool add name=dhcp_pool0 ranges=192.168.1.2-192.168.1.254 add name=dhcp_pool1 ranges=192.168.10.2-192.168.10.254 add name=dhcp_pool2 ranges=192.168.20.2-192.168.20.254 /ip dhcp-server add address-pool=dhcp_pool0 disabled=yes interface=br name=dhcp1 add address-pool=dhcp_pool1 interface=MAIN name=dhcp2 add address-pool=dhcp_pool2 interface=GUEST name=dhcp3 /interface bridge port add bridge=br interface=ether5 add bridge=br interface=ether4 add bridge=br interface=ether3 add bridge=br interface=ether2 /interface bridge vlan add bridge=br tagged=br,ether5,ether4,ether3,ether2 vlan-ids=20 add bridge=br tagged=br,ether5,ether4,ether3,ether2 vlan-ids=10 /interface wifi capsman set enabled=yes interfaces=br /interface wifi provisioning add action=create-dynamic-enabled master-configuration=MAIN slave-configurations=GUEST supported-bands=5ghz-ax add action=create-dynamic-enabled master-configuration=MAIN slave-configurations=GUEST supported-bands=2ghz-ax /ip address add address=192.168.1.1/24 interface=br network=192.168.1.0 add address=192.168.10.1/24 interface=MAIN network=192.168.10.0 add address=192.168.20.1/24 interface=GUEST network=192.168.20.0 /ip dhcp-server network add address=192.168.1.0/24 gateway=192.168.1.1 add address=192.168.10.0/24 gateway=192.168.10.1 add address=192.168.20.0/24 gateway=192.168.20.1 /system identity set name=cAP_Controller CAP using "wifi-qcom" package: /interface bridge add name=bridgeLocal /interface wifi datapath add bridge=bridgeLocal comment=defconf disabled=no name=capdp /interface wifi set [ find default-name=wifi1 ] configuration.manager=capsman datapath=capdp disabled=no set [ find default-name=wifi2 ] configuration.manager=capsman datapath=capdp disabled=no /interface bridge port add bridge=bridgeLocal comment=defconf interface=ether1 add bridge=bridgeLocal comment=defconf interface=ether2 add bridge=bridgeLocal comment=defconf interface=ether3 add bridge=bridgeLocal comment=defconf interface=ether4 add bridge=bridgeLocal comment=defconf interface=ether5 /interface wifi cap set discovery-interfaces=bridgeLocal enabled=yes slaves-datapath=capdp /ip dhcp-client add interface=bridgeLocal disabled=no

Character Interpretation a Hexadecimal character making up the MAC address of the client device in lowercase A Hexadecimal character making up the MAC address of the client device in upper case i Hexadecimal character making up the MAC address of the AP's interface in lowercase I (capital 'i') Hexadecimal character making up the MAC address of the AP's interface in upper case N The entire name of the AP's interface (e.g. 'wifi1') S The entire SSID All other characters are used without interpreting them in any way. For examples, see default values. Property Description called-format ( ; format-string Default: II-II- ) II-II-II-II:SFormat for the value of the Called-Station-Id RADIUS attribute, in AP's messages to RADIUS servers. calling-format ( ; format-string Default: AA: AA:AA:AA:AA:AA)Format for the value of the Calling-Station-Id RADIUS attribute, in AP's messages to RADIUS servers. interim-update (time interval; Default: 5m)Interval at which to send interim updates about traffic accounting to the RADIUS server. mac-caching ( time interval; Default: disabl )edLength of time to cache RADIUS server replies, when MAC address authentication is enabled. This resolves issues with client device authentication timing out due to (comparatively high latency of RADIUS server replies. name ( ; string Default: )no A unique name for the AAA profile. nas-identifier ( ) string Value of the NAS-Identifier attribute, in AP's messages to RADIUS servers. Defaults to the host name of the device (/system/identity). password-format ( ) format-string Format for value to use in calculating the value of the User-Password attribute in AP's messages to RADIUS servers when performing MAC address authentication. Default value: "" (an empty string). username-format ( ; format-string Default: A A:AA:AA:AA:AA:AA )Format for the value of the User-Name attribute in APs messages to RADIUS servers when performing MAC address authentication. Channel properties Properties in this category specify the desired radio channel. Property Description band ( | | 2ghz-g 2ghz-n 2ghz-ax | | | | 5ghz-a 5ghz-ac 5ghz-an 5g ) hz-axFrequency band and wireless standard that will be used by the AP. Defaults to newest supported standard. Note that band support is limited by radio capabilities.

frequency (list of integers or ) integer rangesFor an interface in AP mode, specifies frequencies (in MHz) to consider when picking control channel center frequency. For an interface in station mode, specifies frequencies on which to scan for APs. Leave unset (default) to consider all frequencies supported by the radio and permitted by the applicable regulatory profille. The parameter can contain 1 or more comma-separated values of integers or, optionally, ranges of integers denoted using the syntax RangeBeginning-RangeEnd:RangeStep Examples of valid channel.frequency values: 2412 2412,2432,2472 5180-5240:20,5500-5580:20 secondary-frequency (list of | 'disabled') integersFrequency (in MHz) to use for the center of the secondary part of a split 80+80MHz channel. Only (5210, 5290, 5530, 5610, 5690, 5775) are supported. official 80MHz channels Leave unset (default) for automatic selection of secondary channel frequency. skip-dfs-channels ( | 10min-cac | ) alldisabled; default: disabledWhether to avoid using channels, on which channel availability check (listening for presence of radar signals) is required. 10min-cac - interface will avoid using channels, on which 10 minute long CAC is required all - interface will avoid using all channels, on which CAC is required disabled - interface may select any supported channel, regardless of CAC requirements width ( | | 20mhz 20/40mhz 20 | | /40mhz-Ce 20/40mhz-eC 20 | | /40/80mhz 20/40/80+80mhz ) 20/40/80/160mhzWidth of radio channel. Defaults to widest channel supported by the radio hardware. reselect-interval (time interval; D ) efault: disabledSpecifies when the interface should rescan channel availability and select the most appropriate one to use. Specifying interval will allow the system to select this interval dynamically and randomly. This helps to avoid a situation when many APs at the same time scan the network, select the same channel, and prefer to use it at the same time. reselect-interval uses a background scan. The reselect process will choose the most suitable channel considering the number of networks in the channel, channel usage, and overlap with networks in adjacent channels. It can be used with a list of frequencies defined, or with not set - using all supported frequencies. frequency Configuration properties This section includes properties relating to the operation of the interface and the associated radio. Property Description antenna-gain (intege ) r 0..30Overrides the default antenna gain. The interface of each radio sets the antenna gain for every interface which uses the master same radio. This setting cannot override the antenna gain to be lower than the minimum antenna gain of a radio. No default value.

beacon-interval (time interval 100ms..1s; ) default: 100msInterval between beacon frames of an AP. chains (list of integer )0..7 Radio chains to use for receiving signals. Defaults to all chains available to the corresponding radio hardware. country (name of a country; default: Latv )iaDetermines, which regulatory domain restrictions are applied to an interface. distance () Maximum link distance in kilometers, needs to be set for long-range outdoor links. The value should reflect the distance to the AP or station that is furthest from the device. Unconfigured value allows usage of 2 km links. dtim-period (integer ) 1..255; default: 1Period at which to transmit multicast traffic, when there are client devices in power save mode connected to the AP. Expressed as a multiple of the beacon interval. Higher values enable client devices to save more energy, but increase network latency. hide-ssid (no | yes; ) default: no yes - AP does not include its SSID in beacon frames, and does not reply to probe requests that have broadcast SSID. no - AP includes its SSID in the beacon frames, and replies to probe requests that have broadcast SSID. manager ( capsman | | capsman-or-local lo cal; default: local)capsman - the interface will act as CAP only, this option should be passed via provisioning rules to the CAPnot capsman-or-local - the interface will get configuration via CAPsMAN or use its own, if /interface/wifi/cap is not enabled. local - interface won't contact CAPsMAN in order to get configuration. max-clients (integer 1..1000; default: 1000 )Maximum number of associated clients. mode ( | ) apstation Interface operation mode ap (default) - interface operates as an access point station - interface acts as a client device, scanning for access points advertising the configured SSID station-bridge - interface acts as a client device and enables support for a 4-address frame format, so that the interface can be used as a bridge port station-pseudobridge - the interface keeps track of outgoing IP connections and performs MAC address translation similarly to how IP masquerading works multicast-enhance (e | nabled disabled; ) default: disabledWith the multicast-enhance feature enabled, an AP will convert every multicast-addressed IP or IPv6 packet into multiple unicast- addressed frames for each connected station. This may improve link throughput and reliability since, unlike multicast frames, unicasts are acknowledged by stations and transmitted using a higher data rate. The 802.11 standard defines beacon interval in terms of (1 TU = 1.024 ms). The actual interval between time units beacons will be 1 TU for every 1 ms configured. Every AP running on the same radio (i.e. a master AP and all its 'virtual'/'slave' APs) must use the same beacon interval. It is important to set this value correctly to comply with local regulations and ensure interoperability with other devices. distance is not used by the wifi-qcom-ac package. Setting above the actual needed value can have distance detrimental effects on throughput and latency. The 'wifi' station-bridge mode, is incompatible with APs running the older 'wireless' package and vice versa.

qos-classifier (dscp- | high-3-bits priority; ) default: prioritydscp-high-3-bits - interface will transmit data packets using a WMM priority equal to the value of the 3 most significant bits of the IP DSCP field priority - interface will transmit data packets using a WMM priority equal to that set by IP firewall or bridge filter ssid (string; default: no )The name of the wireless network, aka the (E)SSID. station-roaming (no | yes; Default: )noWifi interface running in station or station-bridge mode will periodically scan for AP candidates to roam to, the weaker the signal to AP is, the more often the scan will be performed. If an AP with a better signal is found, the station will roam to it. FT is supported, and station will respond to BSS Transion Request if is enabled. steering.wnm tx-chains (list of ) integer 0..7Radio chains to use for transmitting signals. Defaults to all chains available to the corresponding radio hardware. tx-power (integer 0.. )40A limit on the transmit power (in dBm) of the interface. Can not be used to set power above limits imposed by the regulatory profile. Unset by default. Datapath properties Parameters relating to forwarding packets to and from wireless client devices. Property Description bridge ( ) bridge interface Bridge interface to add interface to, as a bridge port. Virtual ('slave') interfaces are by default added to the same bridge, if any, as the corresponding master interface. Master interfaces are not by default added to any bridge. bridge-cost (integer; default: 10 )Bridge port cost to use when adding as bridge port. bridge-horizon ( | none integer; default: ) noneBridge horizon to use when adding as bridge port. client-isolation ( | noyes; ) default: noDetermines whether client devices connecting to this interface are (by default) isolated from others or not. This policy can be overridden on a per-client basis using access list rules, so a an AP can have a mixture of isolated and non-isolated clients. Traffic from an isolated client will not be forwarded to other clients and unicast traffic from a non-isolated client will not be forwarded to an isolated one. interface-list (interface list; ) default: noList to which add the interface as a member. vlan-id (none | integer 1.. 4095; default: ) noneDefault VLAN ID to assign to client devices connecting to this interface (only relevant to interfaces in AP mode). When a client is assigned a VLAN ID, traffic coming from the client is automatically tagged with the ID and only packets tagged with with this ID are forwarded to the client. Security Properties Parameters relating to authentication. Property Description 802.11ac wireless chipsets do not support the dscp-high-3-bits classifier mode. For 802.11ac interfaces, please see D . SCP from priority 802.11ac chipsets do not support this type of VLAN tagging , but they can be as VLAN access configured ports in bridge settings.

authentication-types (list of wpa-psk, wpa2-psk, wpa-eap, wpa2-eap, wpa3-psk, ) owe, wpa3-eap, wpa3-eap-192Authentication types to enable on the interface. The default value is an empty list (no authentication, an open network). Configuring a passphrase adds to the default list the authentication method (if the interface is an wpa2-psk AP) or both and (if the interface is a station). wpa-psk wpa2-psk Configuring an and an adds to the default list eap-username eap-password wpa-eap and wpa2-eap authentication methods. connect-group ( ) string APs within the same connect group do not allow more than 1 client device with the same MAC address. This is to prevent malicious authorized users from intercepting traffic intended to other users ('MacStealer' attack) or performing a denial of service attack by spoofing the MAC address of a victim. Handling of new connections with duplicate MAC addresses depends on the connect-priority of AP interfaces involved. By default, all APs are assigned the same connect-group. connect-priority (accept-priority/hold- priority ( )) integersThese parameters determine, how a connection is handled if the MAC address of the client device is the same as that of another active connection to another AP. If (accept-priority of AP2) < (hold-priority of AP1), a connection to AP2 wil cause the client to be dropped from AP1. If (accept-priority of AP2) = (hold-priority of AP1), a connection to AP2 will be allowed only if the MAC address can no longer be reached via AP1. If (accept-priority of AP2) > (hold-priority of AP1), a connection to AP2 will not be accepted. If omitted, hold-priority is the same as accept-priority. By default, APs, which perform user authentication, have higher priority (lower integer value), than open APs. dh-groups ( ) list of 19, 20, 21 Identifiers of to use in SAE (WPA3) authentication. elliptic curve cryptography groups disable-pmkid ( | ) noyes; default: no For interfaces in AP mode, disables inclusion of a PMKID in EAPOL frames. Disabling PMKID can cause compatibility issues with client devices that make use of it. yes - Do not include PMKID in EAPOL frames. no - include PMKID in EAPOL frames. eap-accounting ( | ) noyes; default: no Send accounting information to RADIUS server for EAP-authenticated peers. eap-anonymous-identity (string; default: no )neOptional anonymous identity for EAP outer authentication. eap-certificate-mode (dont-verify-certificate | | | no-certificates verify-certificate verify- certificate-with-crl; default: dont-verify- ) certificatePolicy for handling the TLS certificate of the RADIUS server. verify-certificate - require server to have a valid certificate. Check that it is signed by a trusted certificate authority. dont-verify-certificate - Do not perform any checks on the certificate. no-certificates - Attempt to establish the TLS tunnel by performing anonymous Diffie-Hellman key exchange. To be used if the RADIUS server has no certificate at all. verify-certificate-with-crl - Same as but also checks if the certificate is valid by verify-certificate, checking the Certificate Revocation List. eap-methods ( ) list of peap, tls, ttls EAP methods to consider for authentication. Defaults to all supported methods. eap-password ( ) string; default: none Password to use, when the chosen EAP method requires one. eap-tls-certificate (certificate; ) default: none Name or id of a certificate in the device's certificate store to use, when the chosen EAP authentication method requires one. eap-username (string; ) default: none Username to use when the chosen EAP method requires one. Properties related to EAP, are only relevant to interfaces in station mode. APs delegate (passthrough) EAP authentication to the RADIUS server.

encryption (list of ccmp, ccmp-256, gcmp, ) gcmp-256, tkip; default: ccmpA list of ciphers to support for encrypting unicast traffic. Defaults to . ccmp ft ( ) no | yes: default: no Whether to enable 802.11r fast BSS transitions ( roaming). ft-mobility-domain (integer 0..65535; ) default: 44484 (0xADC4)The fast BSS transition mobility domain ID. ft-nas-identifier (string of 2..96 hex ) charactersFast BSS transition PMK-R0 key holder identifier. Default: MAC address of the interface. ft-over-ds ( | ) noyes; default: no Whether to enable fast BSS transitions over DS (distributed system). ft-preserve-vlanid (| ) no yes no - when a client connects to this AP via 802.11r fast BSS transition, it is assigned a VLAN ID according to the access and/or interface settings yes (default) - when a client connects to this AP via 802.11r fast BSS transition, it retains the VLAN ID, which it was assigned during initial authentication The default behavior is essential when relying on a RADIUS server to assign VLAN IDs to users, since a RADIUS server is only used for initial authentication. ft-r0-key-lifetime (time interval 1s.. ) 6w3d12h15m; Default: 600000s (~7 days)Lifetime of the fast BSS transition PMK-R0 encryption key. ft-reassociation-deadline (time interval 0.. ) 70s; default: 20sFast BSS transition reassociation deadline. group-encryption ( | | ccmp ccmp-256 gcmp | | ) gcmp-256 tkip; default: ccmpCipher to use for encrypting multicast traffic. group-key-update (time interval; default: 24 ) hoursThe interval at which the group temporal key (key for encrypting broadcast traffic) is renewed. management-encryption ( | cmac cmac-256 | | ) gmac gmac-256; default: cmacCipher to use for encrypting protected management frames. management-protection ( | allowed disabled | ) requiredWhether to use 802.11w management frame protection. Incompatible with management frame protection . in standard wireless package The default value depends on the value of the selected authentication type. WPA2 allows the use of management protection, WPA3 requires it. multi-passphrase-group ( ) string Name of group that will be used. Only a single /interface/wifi/security/multi-passphrase/ group can be defined under the security profile. owe-transition-interface ( ) interface Name or internal id of an interface whose MAC address and SSID to advertise as the matching AP when running in OWE transition mode. Required for setting up open APs that offer OWE, but also work with older devices that don't support the standard. See . configuration example below Take care when configuring encryption ciphers. All client devices MUST support the group encryption cipher used by the AP to connect, and some client devices (notably, Intel® 8260) will also fail to connect if the list of unicast ciphers includes any they don't support. Properties related to 802.11r fast BSS transition only apply to interfaces in AP mode. WiFi interfaces in station mode do not support 802.11r. For a client device to successfully roam between 2 APs, the APs need to be managed by the same instance of RouterOS. For information on how to centrally manage multiple APs, see CAPsMAN

passphrase ( ) string of up to 63 characters The passphrase to use for PSK authentication types. Defaults to an empty string - "". WPA-PSK and WPA2-PSK authentication requires a minimum of 8 chars, while WPA3-PSK does not have a minimum passphrase length. sae-anti-clogging-threshold ( | 'disabled' int ) eger; default: 5Due to SAE (WPA3) associations being CPU resource intensive, overwhelming an AP with bogus authentication requests makes for a feasible denial-of-service attack. This parameter provides a way to mitigate such attacks by specifying a threshold of in-progress SAE authentications, at which the AP will start requesting that client devices include a cookie bound to their MAC address in their authentication requests. It will then only process authentication requests that contain valid cookies. sae-max-failure-rate ( | 'disabled' integer; ) default: 40Rate of failed SAE (WPA3) associations per minute, at which the AP will stop processing new association requests. sae-pwe ( | | both hash-to-element hunting- ) and-pecking; default: bothMethods to support for deriving SAE password element. wps ( | disabled push-button; default: push- ) button push-button - AP will accept WPS authentication for 2 minutes after 'wps-push-button' command is called. Physical WPS button functionality not yet implemented. disabled - AP will not accept WPS authentication Security multi-passphrase properties /interface/wifi/security/multi-passphrase/ allows the use of PPSK - private pre-shared keys. Added in 7.17beta1. multi-passphrase It can be used by creating an access list entry and setting name, or by assigning the group to a security profile that the multi-passphrase-group interface uses. The total limit of supported passphrases is 10000, the limit is shared between all interfaces. When the interface has an associated multi-passphrase group, upon being enabled it will start caching all passphrases from the specified group, while caching is taking place, the authentication will be slower. Once caching is completed there will be no perceptible added delay due to the use of multi-passphrase group. If an access-list is used to apply , the caching will start upon the first match for the group, and will continue until a match for multi-passphrase-group the passphrase is found. If there are thousands of entries for possible passphrases under a single group - it might take a few minutes for caching to complete, depending on device configuration and model. group ( ) string assigning the group to a security profile or an access list, will enable use of all passphrases defined under it passphrase (string of up to 63 ) charactersThe passphrase to use for PSK authentication types. Multiple users can use the same passphrase. Not compatible with WPA3-PSK. vlan-id (integer 0.. ) 4095 ; Default: vlan-id that will be assigned to clients using this passphrase expires (date and ; "YYYY-MM-time DD HH:SS"The expiration date and time for passphrase specified in this entry, doesn't affect the whole group. Once the date is reached, existing clients using this passphrase will be disconnected, and new clients will not be able to connect using it. If not set, passphrase can be used indefinetly. multi-passphrase is not supported for the WPA3-PSK authentication type. Only supported on wifi-qcom interfaces, if wifi-qcom-ac AP has a client that uses a passphrase that has vlan-id associated with it, the client will not be able to join.

isolation ( | ; yes no Default: )noDetermines whether the client device using this passphrase is isolated from other clients on AP. Traffic from an isolated client will not be forwarded to other clients and unicast traffic from a non-isolated client will not be forwarded to an isolated one. disabled ( | ; yes no Default: )no Steering properties Properties in this category govern mechanisms for advertising potential roaming candidates to client devices. Property Description neighbor-group (string ) When sending neighbor reports and BSS transition management requests, an AP will list all other APs within its neighbor group as potential roaming candidates. By default, a dynamic neighbor group is created for each set of APs with the same SSID and authentication settings. APs operating in the 5GHz band are indicated to be preferable to ones operating in the 2.4GHz band. rrm ( | noyes; ) Default: yesEnables sending of 802.11k neighbor reports. wnm ( | noyes; ) Default: yesEnables sending of solicited 802.11v BSS transition management requests. Miscellaneous properties Property Description arp ( | | disabled enabled loca | | l-proxy-arp proxy-arp repl y-only; default: ) enabledAddress Resolution Protocol mode: disabled - the interface will not use ARP enabled - the interface will use ARP local-proxy-arp - the router performs proxy ARP on the interface and sends replies to the same interface proxy-arp - the router performs proxy ARP on the interface and sends replies to other interfaces reply-only - the interface will only reply to requests originated from matching IP address/MAC address combinations which are entered as static entries in the table. No dynamic entries will be automatically stored in the ARP ARP table. Therefore for communications to be successful, a valid static entry must already exist. arp-timeout ( | time interval 'a ) uto'; default: 30sDetermines how long a dynamically added ARP table entry is considered valid since the last packet was received from the respective IP address. Value equals to the value of in , which defaults to 30s. auto arp-timeout /ip settings disable-running-check | (no y ) es; default: no yes - interface's property will be true whenever the interface is not disabled running no - interface's property will only be true when it has established a link to another device running disabled (no | yes; default: y )es A dynamic neighbor group will not be created if EAP is used, it needs to be defined manually.

1. 2. 3. mac-address ( ) MAC MAC address (BSSID) to use for an interface. Hardware interfaces default to the MAC address of the associated radio interface. Default MAC addresses for virtual interfaces are generated by Taking the MAC address of the associated master interface Setting the second-least-significant bit of the first octet to 1, resulting in a locally administered MAC address If needed, increment the last octet of the address to ensure it doesn't overlap with the address of another interface on the device mtu (integer [32..2290] ; ) Default: 1500Layer 3 Maximum transmission unit. l2mtu (integer [32..2290] ; ) Default: 2290Layer 2 Maximum transmission unit. master-interface (interface; ) default: noneMultiple interface configurations can be run simultaneously on every wireless radio. Only one of them determines the radio's state (whether it is enabled, what frequency it's using, etc). This 'master' interface, is to a radio with the corresponding bound radio-mac. To create additional ('virtual') interface configurations on a radio, they need to be to the corresponding master bound interface. name ( ) string A name for the interface. Defaults to , where is the lowest integer that has not yet been used for naming an wifiN N interface. Read-only properties Property Description bound (boolean ) (B)True for interfaces that are currently available for WiFi manager. master True for a virtual interface (configurations linked to a master interface) when both the interface itself and its master interface are not disabled and the interface has a bound flag. master default-name ( ) stringThe default name for an interface. inactive (boole ) (I)anFalse for interfaces in AP mode when they've selected a channel for operation (i.e. configuration has been successfully applied). False for interfaces in station mode when they've connected to an AP (i.e. configuration has been successfully applied, and an AP with matching settings has been found). True otherwise. master (boolean ) (M)True for physical interfaces on the router itself or detected CAP if running as CAPsMAN. False for virtual interfaces. radio-mac (MAC )The MAC address of the associated radio. running (boole ) (R)anTrue, when an interface has established a link to another device. If is set to 'yes', true whenever the interface is not disabled. disable-running-check Access List Filtering parameters Parameter Description

interface ( | | interface interface-list ) any; default: anyMatch if connection takes place on the specified interface or interface belonging to a specified list. mac-address (MAC address; ) default: noneMatch if the client device has the specified MAC address. mac-address-mask ( ) MAC address Modifies the parameter to match if it is equal to the result of performing bit-wise AND operation on mac-address the client MAC address and the given address mask. Default: FF:FF:FF:FF:FF:FF (i.e. client's MAC address must match value of exactly) mac-address signal-range ( ) min..max Match if the strength of the received signal from the client device is within the given range. Allowed values: '-120.. 120' ssid-regexp ( ) regex Match if the given regular expression matches the SSID. time ( ) start-end,days Match during the specified time of day and (optionally) days of week. Allow values: 0s-1d multi-passphrase-group (string ) Name of group that will be used. Only single group can /interface/wifi/security/multi-passphrase/ be set under one access list entry. Action parameters Parameter Description allow-signal-out-of-range (time period | always; default: )0sThe length of time which a connected peer's signal strength is allowed to be outside the range required by the parameter, before it is disconnected. signal-range If the value is set to 'always', peer signal strength is only checked during association. action ( | | accept reject query-radius; ) default: acceptWhether to authorize a connection accept - connection is allowed reject - connection is not allowed query-radius - connection is allowed if MAC address authentication of the client's MAC address succeeds client-isolation ( | ) noyes; default: none Whether to the client from others connected to the same AP. isolate passphrase (string; ) default: none Override the default passphrase with given value. radius-accounting (|no yes; default: no )neOverride the default RADIUS accounting policy with given value. vlan-id ( | none integer 1..4095; default: ) noneAssign the given to matched clients. VLAN ID Frequency scan Information about RF conditions on available channels can be obtained by running the frequency-scan command. Command parameters Parameter Description duration (time interval; ) default: none Length of time to perform the scan for before exiting. Useful for non-interactive use. freeze-frame-interval (time interval; default: )1sTime interval at which to update command output. frequency (list of frequencies/ranges) Frequencies to perform the scan on. See above for more detail. Defaults to channel.frequency parameter syntax all supported frequencies. number (string ; ) default: none Either the name or internal id of the interface to perform the scan with. Required.

rounds (integer; ) default: none Number of times to go through list of scannable frequencies before exiting. Useful for non-interactive use. save-file (string ; ) default: none Name of file to save output to. Output parameters Parameter Description channel (integer) Frequency (in MHz) of the channel scanned. networks (integer) Number of access points detected on the channel. load (integer ) Percentage of time the channel was busy during the scan. nf (integer) Noise floor (in dBm) of the channel. max-signal ( ) integer Maximum signal strength (in dBm) of APs detected in the channel. min-signal ( ) integer Minimum signal strength (in dBm) of APs detected in the channel. primary ( ) (P) boolean Channel is in use as the primary (control) channel by an AP. secondary (boolean) (S) Channel is in use as a secondary (extension) channel by an AP. Flat-snoop The '/interface wifi flat-snoop' is a tool for surveying APs and stations. Monitors frequency usage, and displays which devices occupy each frequency. Provides more detailed infromation regarding nearby APs than scan, and offers easy overview of frequency usage by station/AP count. Output parameters Parameter Description duration (time interval ; ) default: none Length of time to perform the scan before exiting. Useful for non-interactive use. filter-type ( | | ) bsss frequency stas bsss - list of active APs and their parameters. frequency - list of station and AP count per scanned frequency stas - a detailed list of stations on each scanned frequency If filter-type is unspecified all types will be returned. freeze-frame-interval (time interval; default: )1s Time interval at which to update command output. Scan command The '/interface wifi scan' command will scan for access points and print out information about any APs it detects. The scan command takes all the same parameters as the frequency-scan command. Output parameters Parameter Description active ( ) (A) boolean This signifies that beacons from the AP have been received in the last 30 seconds. address ( ) MAC The MAC address (BSSID) of the AP. channel ( ) string The control channel frequency used by the AP, its supported wireless standards and control/extension channel layout. security ( ) string Authentication methods supported by the AP.

signal ( ) integer The signal strength of the AP's beacons (in dBm). ssid ( ) string The extended service set identifier of the AP. sta-count ( ) integer The number of client devices associated with the AP. Only available if the AP includes this information in its beacons. Sniffer Command parameters Parameter Description duration (time interval ; default: no )neAutomatically interrupt the sniffer after the specified time has passed. filter ( ) string A string that specifies a filter to apply to captured frames. Only frames matched by the filter expression will be displayed, saved or streamed. This works similarly to filter strings in libpcap, for example. The filter can match Address fields (addr1, addr2, addr3) Wireless frame type and subtype, including shortcuts such as 'beacon' (type == 0 && subtype == 8) Flags (to-ds, from-ds, retry, power, protected) A string can include the following operators: == (exact match) != (does not equal) && (logical AND) || (logical OR) () (for grouping filter expressions) number ( ) interface Interface to use for sniffing. pcap-file (string ) Save captured frames to a file with the given name. No default value (captured frames are not saved to a file by default). pcap-size-limit (integer ; default: n )oneFile size limit (in bytes) when storing captured frames locally. When this limit has been reached, no new frames are added to the capture file. stream-address (IP address ; defa ) ult: noneStream captured packets via the TZSP protocol to the given address. No default value (captured packets are not streamed anywhere by default). stream-rate ( ) integer Limit the rate (in packets per second) at which captured frames are streamed via TZSP. WPS interface/wifi/wps-client wifi Command parameters Parameter Description duration ( ) time interval Length of time after which the command will time out if no AP is found. Unlimited by default. interval ( ) time interval; default: 1s Time interval at which to update command output. Default: 1s. mac-address (MAC ; ) default: none Only attempt connecting to AP with the specified MAC (BSSID). number (string ; ) default: none Name or internal id of the interface with which to attempt a connection. ssid (string ; ) default: none Only attempt to connect to APs with the specified SSID.

Radios Information about the capabilities of each radio can be gained by running the `/interface/wifi/radio print detail` command. Property Description 2g-channels ( ) list of integers Frequencies supported in the 2.4GHz band. 5g-channels ( ) list of integers Frequencies supported in the 5GHz band. bands ( ) list of strings Supported frequency bands, wireless standards, and channel widths. ciphers ( ) list of strings Supported encryption ciphers. countries ( ) list of strings Regulatory domains supported by the interface. hw-caps ( ) list of strings Additional supported features (e.g. sniffer, qos-classifier-dscp). hw-type ( ) string Radio hardware model number. max-interfaces ( ) integer Maximum number of logical interfaces. max-peers ( ) integer Maximum number of associated peers (connected stations). max-station-interfaces ( ) integer Maximum number of logical interfaces in station mode. max-vlans ( ) integer Maximum number of different per-user VLANs. min-antenna-gain ( ) integer Minimum antenna gain permitted for the interface. phy-id ( ) string A unique identifier. radio-mac ( ) MAC MAC address of the radio interface. Can be used to match radios to interface configurations. rx-chains ( ) list of integers IDs for radio chains available for receiving radio signals. tx-chains ( ) list of integers IDs for radio chains available for transmitting radio signals. Registration table The registration table contains read-only information about associated wireless devices. Parameter Description authorized ( ) (A) boolean True when the peer has successfully authenticated. auth-type ( ) string Authentication type used for the particular client. band( ) string Band on which particular router is communication with the AP. bytes ( ) list of integers Number of bytes in packets transmitted to a peer and received from it. interface ( ) string Name of the interface, which was used to associate with the peer. last-activity (time) last interface data tx/rx activity mac-address ( ) MAC The MAC address of the peer. packets ( ) list of integers Number of packets transmitted to a peer and received from it. tx-bits-per-second ( integer) Rate of transmitted data to peer per second. rx-bits-per-second ( integer) Rate of received data from peer per second. rx-rate (string) Bitrate of received transmissions from peer. signal (integer) Strength of signal received from the peer (in dBm).

ssid (string) The SSID on which client is connected. tx-rate (string) Bitrate used for transmitting to the peer. uptime (time interval) Time since association. vlan-id ( integer) VLAN which is assigned by AP or RADIUS for particular peer traffic. CAPsMAN Global Configuration Menu: /interface/wifi/capsman Property Description ca-certificate (auto | certificate name )Device CA certificate, CAPsMAN server requires a certificate, certificate on CAP is optional. certificate (auto | certificate name | none ; Default: none )Device certificate enabled | ) (no yes Disable or enable CAPsMAN functionality package-path (string ) Folder location for the RouterOS packages. For example, use "/upgrade" to specify the upgrade folder from the files section. If an empty string is set, CAPsMAN can use built-in RouterOS packages, note that in this case only CAPs with the same architecture as CAPsMAN will be upgraded. require-peer-certificate (yes | no ; Default: no)Require all connecting CAPs to have a valid certificate upgrade-policy (none | require- same-version | suggest-same- upgrade ; Default: none )Upgrade policy options none - do not perform upgrade require-same-version - CAPsMAN suggests to upgrade the CAP RouterOS version and, if it fails it will not provision the CAP. (Manual provision is still possible) suggest-same-version - CAPsMAN suggests to upgrade the CAP RouterOS version and if it fails it will still be provisioned interfaces (all | interface name | none; ) Default: allInterfaces on which CAPsMAN will listen for layer 2 CAP connections CAPsMAN Provisioning Provisioning rules for matching radios are configured in menu: /interface/wifi/provisioning/ Property Description action (create-disabled | create-enabled | create- dynamic-enabled | none; Default: ) noneAction to take if rule matches are specified by the following settings: create-disabled - create disabled static interfaces for radio. I.e., the interfaces will be bound to the radio, but the radio will not be operational until the interface is manually enabled; create-enabled - create enabled static interfaces. I.e., the interfaces will be bound to the radio and the radio will be operational; create-dynamic-enabled - create enabled dynamic interfaces. I.e., the interfaces will be bound to the radio, and the radio will be operational; none - do nothing, leaves radio in the non-provisioned state; comment ( ) string Short description of the Provisioning rule common-name-regexp (st )ringRegular expression to match radios by common name. Each CAP's common name identifier can be found under "/interface /wifi/radio" as value "REMOTE-CAP-NAME"

supported-bands (2ghz- ax | 2ghz-g | 2ghz-n | 5ghz-a | 5ghz-ac | 5ghz- ;) ax | 5ghz-nMatch radios by supported wireless modes. identity-regexp ( ;) string Regular expression to match radios by router identity address-ranges (IpAddre ssRange[, IpAddressRanges] max ;) 100xMatch CAPs with IPs within the configured address range. Will only work for CAPs that joined CAPsMAN using IP, not MAC address. master-configuration (stri )ngIf specifies to create interfaces, then a new master interface with its configuration set to this configuration profile will action be created name-format ( ) string Base string to use when constructing names of provisioned interfaces. Each new interface will be created by taking the base string and appending a number to the end of it, a number will only be appended if the string is not unique. If included in the string, the character sequence will be replaced by the system identity of the cAP, will be replaced %I %C with the cAP's TLS certificate's Common Name, , or for lowercase, will be replaced with the CAP's radio MAC %R %r Default: "cap-wifi" slave-name-format ( ) string Base string to use when constructing names of virtual interfaces. Each new interface will be created by taking the base string and appending a number to the end of it, a number will only be appended if the string is not unique. If included in the string, the chraracter sequence will be replaced with "virtual", the chraracter sequence will be %v %m replaced with the name of master interface,if included in the string, the character sequence will be replaced by the %I system identity of the cAP, will be replaced with the cAP's TLS certificate's Common Name, , or for lowercase, %C %R %r will be replaced with the CAP's radio MAC Default: " -virtual" master-interface-name radio-mac ( ) MAC address MAC address of radio to be matched. No default value. slave-configurations (string ;)If specifies to create interfaces, then a new slave interface for each configuration profile in this list is created. the action disabled ( ;) yes| no Specifies if the provision rule is disabled. CAP configuration Menu: /interface/wifi/cap Property Description caps-man-addresses list of IP ( addresses ; Default: empty )List of Manager IP addresses that CAP will attempt to contact during discovery caps-man-names () An ordered list of CAPs Manager names that the CAP will connect to, if empty - CAP does not check Manager name discovery-interfaces (list of interfaces ;)List of interfaces over which CAP should attempt to discover Manager lock-to-caps-man (no | yes; Default: no)Sets, if CAP should lock to the first CAPsMAN it connects to slaves-static () Creates Static Virtual Interfaces, allows the possibility to assign IP configuration to those interfaces. MAC address is used to remember each static-interface when applying the configuration from the CAPsMAN. caps-man-certificate-common- names ()List of Manager certificate CommonNames that CAP will connect to, if empty - CAP does not check Manager certificate CommonName certificate () Certificate to use for authenticating enabled (yes | no ; Default: no) Disable or enable the CAP feature

current-caps-man-address () Shows currently used CAPsMAN address (available since 7.15) current-caps-man-identity () Shows currently used CAPsMAN identity (available since 7.15) slaves-datapath ()

Wireless Interface Overview General interface properties 802.11n wireless chipsets represent power per chain and the 802.11ac Basic and MCS Rate table Frame protection support (RTS/CTS) Nv2 Nv2 Troubleshooting Access List Properties Align Menu Specific Commands Connect List Properties Usage Restrict station connections only to specific access points Disallow connections to specific access points Select preferred access points Restrict WDS link establishment Info Manual TX Power Table Wireless hardware table Overview Hardware support Configuring Advanced Channels Using Advanced Channels frequency scan-list Nstreme Nstreme Dual Registration Table Security Profiles Basic properties WPA properties WPA EAP properties RADIUS properties WEP properties Management frame protection Operation details RADIUS MAC authentication Caching RADIUS EAP pass-through authentication Statically configured WEP keys WDS security configuration WDS and WPA/WPA2 WDS and WEP Security profile and access point matching in the connect list Virtual interfaces VirtualAP Virtual Clients Sniffer Packets Scan Snooper Settings Spectral scan WDS WPS WPS Server WPS Client Repeater Roaming

Station Roaming VLAN tagging Vlan tag override Winbox Interworking Realms setting Overview Package: wireless RouterOS wireless complies with IEEE 802.11 standards, it provides complete support for 802.11a, 802.11b, 802.11g, 802.11n and 802.11ac as long as additional features like WPA, WEP, AES encryption, Wireless Distribution System (WDS), Dynamic Frequency selection (DFS), Virtual Access Point, Nstreme and NV2 proprietary protocols and many more. compatibility table for different wireless protocols. Wireless features Wireless can operate in several modes: client (station), access point, wireless bridge etc. Client/station also can operate in different modes, a complete list of supported modes can be found . here General interface properties Sub-menu: /interface wireless Property Description adaptive-noise-immunity ( ; ap-and-client-mode | client-mode | none Default: ) noneThis property is only effective for cards based on Atheros chipset. allow-sharedkey ( ; Default: ) yes | no no Allow WEP Shared Key clients to connect. Note that no authentication is done for these clients (WEP Shared keys are not compared to anything) - they are just accepted at once (if access list allows that) ampdu-priorities ( ; Default: ) list of integer [0..7] 0 Frame priorities for which AMPDU sending (aggregating frames and sending using block acknowledgment) should get negotiated and used. Using AMPDUs will increase throughput, but may increase latency, therefore, may not be desirable for real-time traffic (voice, video). Due to this, by default AMPDUs are enabled only for best-effort traffic. amsdu-limit ( ; Default: ) integer [0..8192] 8192 Max AMSDU that device is allowed to prepare when negotiated. AMSDU aggregation may significantly increase throughput especially for small frames, but may increase latency in case of packet loss due to retransmission of aggregated frame. Sending and receiving AMSDUs will also increase CPU usage. amsdu-threshold ( ; Default: ) integer [0..8192] 8192 Max frame size to allow including in AMSDU. antenna-gain ( ; Default: ) integer [0..4294967295] 0 Antenna gain in dBi, used to calculate maximum transmit power according to co regulations. untry antenna-mode ( ; Default: ) ant-a | ant-b | rxa-txb | txa-rxb Select antenna to use for transmitting and for receiving ant-a - use only 'a' antenna ant-b - use only 'b' antenna txa-rxb - use antenna 'a' for transmitting, antenna 'b' for receiving rxa-txb - use antenna 'b' for transmitting, antenna 'a' for receiving area ( ; Default: ) string Identifies group of wireless networks. This value is announced by AP, and can be matched in by . This is a proprietary extension. connect-list area-prefix arp ( ; Default: ) disabled | enabled | proxy-arp | reply-only enabled Read more >> arp-timeout ( ; Default: ) auto | integer auto ARP timeout is time how long ARP record is kept in ARP table after no packets are received from IP. Value equals to the value of in auto arp-timeout /ip settings , default is 30s

band (2ghz-b | 2ghz-b/g | 2ghz-b/g/n | 2ghz-onlyg | 2ghz-onlyn | 5ghz- ; a | 5ghz-a/n | 5ghz-onlyn | 5ghz-a/n/ac | 5ghz-onlyac | 5ghz-n/ac Default: )Defines set of used data rates, channel frequencies and widths. basic-rates-a/g (12Mbps | 18Mbps | 24Mbps | 36Mbps | 48Mbps | ; Default: ) 54Mbps | 6Mbps | 9Mbps 6MbpsSimilar to the property, but used for 5ghz, 5ghz-10mhz, 5ghz- basic-rates-b 5mhz, 5ghz-turbo, 2.4ghz-b/g, 2.4ghz-onlyg, 2ghz-10mhz, 2ghz-5mhz and 2.4 ghz-g-turbo bands. basic-rates-b ( ; Default: ) 11Mbps | 1Mbps | 2Mbps | 5.5Mbps 1Mbps List of basic rates, used for 2.4ghz-b, 2.4ghz-b/g and 2.4ghz-onlyg bands. Client will connect to AP only if it supports all basic rates announced by the AP. AP will establish WDS link only if it supports all basic rates of the other AP. This property has effect only in AP modes, and when value of is rate-set configured. bridge-mode ( ; Default: ) disabled | enabled enabled Allows to use station-bridge mode. Read more >> burst-time ( ; Default: ) integer | disabled disabled Time in microseconds which will be used to send data without stopping. Note that no other wireless cards in that network will be able to transmit data during burst-time microseconds. This setting is available only for AR5000, AR5001X, and AR5001X+ chipset based cards. channel-width (20/40/80/160mhz-Ceeeeeee | 20/40/80/160mhz- XXXXXXXX | 20/40/80/160mhz-eCeeeeee | 20/40/80/160mhz- eeCeeeee | 20/40/80/160mhz-eeeCeeee | 20/40/80/160mhz- eeeeCeee | 20/40/80/160mhz-eeeeeCee | 20/40/80/160mhz- eeeeeeCe | 20/40/80/160mhz-eeeeeeeC | 20/40/80mhz-Ceee | 20/40 /80mhz-eCee | 20/40/80mhz-eeCe | 20/40/80mhz-eeeC | 20/40 /80mhz-XXXX | 20/40mhz-Ce | 20/40mhz-eC | 20/40mhz-XX | ; Default: ) 40mhz-turbo | 20mhz | 10mhz | 5mhz 20mhzUse of extension channels (e.g. Ce, eC etc) allows additional 20MHz extension channels and if it should be located below or above the control (main) channel. Extension channel allows 802.11n devices to use up to 40MHz (802.11ac up to 160MHz) of spectrum in total thus increasing max throughput. Channel widths with XX and XXXX extensions automatically scan for a less crowded control channel frequency based on the number of concurrent devices running in every frequency and chooses the “C” - Control channel frequency automatically. comment ( ; Default: ) string Short description of the interface compression ( ; Default: ) yes | no no Setting this property to will allow the use of the hardware compression. yes Wireless interface must have support for hardware compression. Connections with devices that do not use compression will still work. country ( ; Default: ) name of the country | no_country_set etsi Limits available bands, frequencies and maximum transmit power for each frequency. Also specifies default value of . Value is an scan-list no_country_set FCC compliant set of channels. default-ap-tx-limit ( ; Default: ) integer [0..4294967295] 0 This is the value of for clients that do not match any entry in the ap-tx-limit acces . 0 means no limit.s-list default-authentication ( ; Default: ) yes | no yes For AP mode, this is the value of for clients that do not match authentication any entry in the . For station mode, this is the value of for access-list connect APs that do not match any entry in the connect-list default-client-tx-limit ( ; Default: ) integer [0..4294967295] 0 This is the value of for clients that do not match any entry in the client-tx-limit ac . 0 means no limit cess-list default-forwarding ( ; Default: ) yes | no yes This is the value of for clients that do not match any entry in the forwarding acce ss-list disable-running-check ( ; Default: ) yes | no no When set to interface will always have running flag. If value is set to , the yes no' router determines whether the card is up and running - for AP one or more clients have to be registered to it, for station, it should be connected to an AP. disabled ( ; Default: ) yes | no yes Whether interface is disabled disconnect-timeout ( ; Default: ) time [0s..15s] 3s This interval is measured from third sending failure on the lowest data rate. At this point 3 * ( + 1) frame transmits on the lowest data rate had failed. hw-retries During packet transmission will be retried with disconnect-timeout on-fail-retry- interval. If no frame can be transmitted successfully during time disconnect- , the connection is closed, and this event is logged as "extensive data timeout loss". Successful frame transmission resets this timer.

distance ( ; Default: ) integer | dynamic | indoors dynamic How long to wait for confirmation of unicast frames ( ) before considering ACKs transmission unsuccessful, or in short . Distance value has these ACK-Timeout behaviors: Dynamic - causes AP to detect and use the smallest timeout that works with all connected clients. Indoor - uses the default ACK timeout value that the hardware chip manufacturer has set. Number - uses the input value in formula: ACK-timeout = (( * distance 1000) + 299) / 300 us; Acknowledgments are not used in Nstreme/NV2 protocols. frame-lifetime ( ; Default: ) integer [0..4294967295] 0 Discard frames that have been queued for sending longer than . frame-lifetime By default, when value of this property is , frames are discarded only after 0 connection is closed. frequency ( ; Default: ) integer [0..4294967295] Channel frequency value in MHz on which AP will operate. Allowed values depend on the selected band, and are restricted by country setting and wireless card capabilities. This setting has if interface is in no effect any of modes, or in mode, or if DFS is active. station wds-slave : If using mode "superchannel", any frequency supported by the card will Note be accepted, but on the RouterOS client, any non-standard frequency must be configured in the , otherwise it will not be scanning in non-standard scan-list range. In Winbox, scanlist frequencies are in , any other frequency means bold the clients will need scan-list configured. frequency-mode ( ; manual-txpower | regulatory-domain | superchannel Default: ) regulatory_domainThree frequency modes are available: regulatory-domain - Limit available channels and maximum transmit power for each channel according to the value of country manual-txpower - Same as above, but do not limit maximum transmit power. superchannel - Conformance Testing Mode. Allow all channels supported by the card. List of available channels for each band can be seen in /interface wireless info . This mode allows you to test wireless channels outside the allowed-channels default scan-list and/or regulatory domain. This mode should only be used in controlled environments, or if you have special permission to use it in your region. Before v4.3 this was called Custom Frequency Upgrade, or Superchannel. Since RouterOS v4.3 this mode is available without special key upgrades to all installations. frequency-offset ( ; Default: ) integer [-2147483648..2147483647] 0 Allows to specify offset if the used wireless card operates at a different frequency than is shown in RouterOS, in case a frequency converter is used in the card. So if your card works at 4000MHz but RouterOS shows 5000MHz, set offset to 1000MHz and it will be displayed correctly. The value is in MHz and can be positive or negative. guard-interval ( ; Default: ) any | long any Whether to allow use of short guard interval (refer to 802.11n MCS specification to see how this may affect throughput). "any" will use either short or long, depending on data rate, "long" will use long. hide-ssid ( ; Default: ) yes | no no yes - AP does not include SSID in the beacon frames, and does not reply to probe requests that have broadcast SSID. no - AP includes SSID in the beacon frames, and replies to probe requests that have broadcast SSID. This property has an effect only in AP mode. Setting it to can remove this yes network from the list of wireless networks that are shown by some client software. Changing this setting does not improve the security of the wireless network, because SSID is included in other frames sent by the AP.

ht-basic-mcs (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs-6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs-15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs-20 | mcs- ; Default: 21 | mcs-22 | mcs-23) mcs-0; mcs-1; mcs-2; mcs-3; mcs-4; ) mcs-5; mcs-6; mcs-7Modulation and Coding Schemes that every connecting client must support. Refer to 802.11n for MCS specification. ht-supported-mcs (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs-6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs-15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs- ; Default: 20 | mcs-21 | mcs-22 | mcs-23) mcs-0; mcs-1; mcs-2; mcs- 3; mcs-4; mcs-5; mcs-6; mcs-7; mcs-8; mcs-9; mcs-10; mcs-11; mcs- 12; mcs-13; mcs-14; mcs-15; mcs-16; mcs-17; mcs-18; mcs-19; mcs- ) 20; mcs-21; mcs-22; mcs-23Modulation and Coding Schemes that this device advertises as supported. Refer to 802.11n for MCS specification. hw-fragmentation-threshold ( ; Default: ) integer[256..3000] | disabled 0 Specifies maximum fragment size in bytes when transmitted over the wireless medium. 802.11 standard packet (MSDU in 802.11 terminologies) fragmentation allows packets to be fragmented before transmitting over a wireless medium to increase the probability of successful transmission (only fragments that did not transmit correctly are retransmitted). Note that transmission of a fragmented packet is less efficient than transmitting unfragmented packet because of protocol overhead and increased resource usage at both - transmitting and receiving party. hw-protection-mode ( ; Default: ) cts-to-self | none | rts-cts none Frame protection support property read more >> hw-protection-threshold ( ; Default: ) integer [0..65535] 0 Frame protection support property read more >> hw-retries ( ; Default: ) integer [0..15] 7 Number of times sending frame is retried without considering it a transmission failure. Data-rate is decreased upon failure and the frame is sent again. Three sequential failures on the lowest supported rate suspend transmission to this destination for the duration of . After that, the frame is sent on-fail-retry-time again. The frame is being retransmitted until transmission success, or until the client is disconnected after . The frame can be discarded disconnect-timeout during this time if is exceeded. frame-lifetime installation ( ; Default: ) any | indoor | outdoor any Adjusts scan-list to use indoor, outdoor or all frequencies for the country that is set. interworking-profile ( ; Default: ) enabled | disabled disabled keepalive-frames ( ; Default: ) enabled | disabled enabled Applies only if wireless interface is in mode= . If a client has not ap-bridge communicated for around 20 seconds, AP sends a "keepalive-frame". , disabling the feature can lead to "ghost" clients in registration-table. Note l2mtu ( ; Default: ) integer [0..65536] 1600 mac-address ( ; Default: ) MAC master-interface ( ; Default: ) string Name of wireless interface that has capability. Virtual AP interface will virtual-ap only work if master interface is in , , or mode. ap-bridge bridge station wds-slave This property is only for virtual AP interfaces. max-station-count ( ; Default: ) integer [1..2007] 2007 Maximum number of associated clients. WDS links also count toward this limit.

mode (station | station-wds | ap-bridge | bridge | alignment-only | nstreme-dual-slave | wds-slave | station-pseudobridge | station- ; Default: ) pseudobridge-clone | station-bridge stationSelection between different station and access point (AP) modes. Station modes : station - Basic station mode. Find and connect to acceptable AP. station-wds - Same as , but create WDS link with AP, using station proprietary extension. AP configuration has to allow WDS links with this device. Note that this mode does not use entries in wds. station-pseudobridge - Same as , but additionally perform MAC station address translation of all traffic. Allows interface to be bridged. station-pseudobridge-clone - Same as , but use station-pseudobridge statio address to connect to AP. n-bridge-clone-mac station-bridge - Provides support for transparent protocol-independent L2 bridging on the station device. RouterOS AP accepts clients in station- bridge mode when enabled using bridge-mode parameter. In this mode, the AP maintains a forwarding table with information on which MAC addresses are reachable over which station device. Only works with RouterOS APs. With station-bridge mode, it is not possible to connect to CAPsMAN controlled CAP. AP modes: ap-bridge - Basic access point mode. bridge - Same as , but limited to one associated client. ap-bridge wds-slave - Same as , but scan for AP with the same and ap-bridge ssid establishes WDS link. If this link is lost or cannot be established, then continue scanning. If is , then APs with enabled dfs-mode radar-detect hide- will not be found during scanning.ssid Special modes: alignment-only - Put the interface in a continuous transmit mode that is used for aiming the remote antenna. nstreme-dual-slave - allow this interface to be used in nstreme-dual setup. MAC address translation in pseudobridge modes works by inspecting packets and building a table of corresponding IP and MAC addresses. All packets are sent to AP with the MAC address used by pseudobridge, and MAC addresses of received packets are restored from the address translation table. There is a single entry in the address translation table for all non-IP packets, hence more than one host in the bridged network cannot reliably use non-IP protocols. Note: Currently IPv6 doesn't work over Pseudobridge mtu ( ; Default: ) integer [0..65536] 1500 multicast-buffering ( ; Default: ) disabled | enabled enabled For a client that has power saving, buffer multicast packets until next beacon time. A client should wake up to receive a beacon, by receiving beacon it sees that there are multicast packets pending, and it should wait for multicast packets to be sent. The 'wireless' station-bridge mode, is incompatible with APs running the newer 'wifi' package and vice versa.

multicast-helper ( ; Default: ) default | disabled | full default When set to , multicast packets will be sent with a unicast destination MAC full address, resolving on the wireless link. This option should be multicast problem enabled only on the access point, clients should be configured in station-bridge mode. Available starting from v5.15. disabled - disables the helper and sends multicast packets with multicast destination MAC addresses dhcp - dhcp packet mac addresses are changed to unicast mac addresses prior to sending them out full - all multicast packet mac address are changed to unicast mac addresses prior to sending them out default - default choice that currently is set to . Value can be changed dhcp in future releases. name ( ; Default: ) string name of the interface noise-floor-threshold ( ; Default: ) default | integer [-128..127] default For advanced use only, as it can badly affect the performance of the interface. It is possible to manually set noise floor threshold value. By default, it is dynamically calculated. This property also affects received signal strength. This property is only effective on non-AC chips. nv2-cell-radius ( ; Default: ) integer [10..200] 30 Setting affects the size of contention time slot that AP allocates for clients to initiate connection and also size of time slots used for estimating distance to client. When setting is too small, clients that are farther away may have trouble connecting and/or disconnect with "ranging timeout" error. Although during normal operation the effect of this setting should be negligible, in order to maintain maximum performance, it is advised to not increase this setting if not necessary, so AP is not reserving time that is actually never used, but instead allocates it for actual data transfer. on AP: distance to farthest client in km on station: no effect nv2-noise-floor-offset ( ; Default: ) default | integer [0..20] default nv2-preshared-key ( ; Default: ) string nv2-qos ( ; Default: ) default | frame-priority default Sets the packet priority mechanism, firstly data from high priority queue is sent, then lower queue priority data until 0 queue priority is reached. When link is full with high priority queue data, lower priority data is not sent. Use it very carefully, setting works on AP frame-priority - manual setting that can be tuned with Mangle rules. default - default setting where small packets receive priority for best latency nv2-queue-count ( ; Default: ) integer [2..8] 2 nv2-security ( ; Default: ) disabled | enabled disabled on-fail-retry-time ( ; Default: ) time [100ms..1s] 100ms After third sending failure on the lowest data rate, wait for specified time interval before retrying. periodic-calibration ( ; Default: ) default | disabled | enabled default Setting enables periodic calibration if default info default-periodic-calibration property is . Value of that property depends on the type of wireless enabled card. This property is only effective for cards based on Atheros chipset. periodic-calibration-interval ( ; Default: ) integer [1..10000] 60 This property is only effective for cards based on Atheros chipset.

wds-cost-range ( ; Default: ) start [-end] integer[1 ..200000000] 50-150 Bridge port cost of WDS links are automatically adjusted, depending on measured link throughput. Port cost is recalculated and adjusted every 5 seconds if it has changed by more than 10%, or if more than 20 seconds have passed since the last adjustment. Setting this property to disables automatic cost adjustment.0 Automatic adjustment does not work for WDS links that are manually configured as a bridge port. wds-default-bridge ( ; Default: ) string | none none When WDS link is established and status of the wds interface becomes , running it will be added as a bridge port to the bridge interface specified by this property. When WDS link is lost, wds interface is removed from the bridge. If wds interface is already included in a bridge setup when WDS link becomes active, it will not be added to bridge specified by , and will (needs editing) wds-default-cost ( ; Default: ) integer [1 ] ..200000000 100 Initial bridge port cost of the WDS links. wds-ignore-ssid ( ; Default: ) yes | no no By default, WDS link between two APs can be created only when they work on the same frequency and have the same SSID value. If this property is set to ,yes then SSID of the remote AP will not be checked. This property has no effect on connections from clients in mode. It also does not work if station-wds wds-mode is or . static-mesh dynamic-mesh wds-mode ( ; disabled | dynamic | dynamic-mesh | static | static-mesh Default: ) disabledControls how WDS links with other devices (APs and clients in station-wds mode) are established. disabled does not allow WDS links. static only allows WDS links that are manually configured in WDS dynamic also allows WDS links with devices that are not configured in WDS, by creating required entries dynamically. Such dynamic WDS entries are removed automatically after the connection with the other AP is lost. -mesh modes use different (better) method for establishing link between AP, that is not compatible with APs in non-mesh mode. This method avoids one- sided WDS links that are created only by one of the two APs. Such links cannot pass any data.When AP or station is establishing WDS connection with another AP, it uses connect-list to check whether this connection is allowed. If station in station-wds mode is establishing connection with AP, AP uses access-list to check whether this connection is allowed.If mode is station-wds, then this property has no effect. wireless-protocol (802.11 | any | nstreme | nv2 | nv2-nstreme | nv2- ; Default: ) nstreme-802.11 | unspecified anySpecifies protocol used on wireless interface; unspecified - protocol mode used on previous RouterOS versions (v3.x, v4. x). Nstreme is enabled by old enable-nstreme setting, Nv2 configuration is not possible. any : on AP - regular 802.11 Access Point or Nstreme Access Point; on station - selects Access Point without specific sequence, it could be changed by connect-list rules. nstreme - enables Nstreme protocol (the same as old enable-nstreme setting). nv2 - enables Nv2 protocol. nv2 nstreme : on AP - uses first wireless-protocol setting, always Nv2; on station - searches for Nv2 Access Point, then for Nstreme Access Point. nv2 nstreme 802.11 - on AP - uses first wireless-protocol setting, always Nv2; on station - searches for Nv2 Access Point, then for Nstreme Access Point, then for regular 802.11 Access Point. Nv2 doesn't have support for Virtual AP Warning! wmm-support ( ; Default: ) disabled | enabled | required disabled Specifies whether to enable . Only applies to bands B and G. Other WMM bands will have it enabled regardless of this setting wps-mode ( ; Default: disabled | push-button | push-button-virtual-only ) depending on the device modelRead more >>

802.11n wireless chipsets represent power per chain and the 802.11ac wireless chipsets represent the total power, for reference see the table below:Transmit Power representation on 802.11n and 802.11ac Wireless chipset signal level representation Wireless chipset Enabled Chains Power per Chain Total Power 802.11n 1 Equal to the selected Tx Power Equal to the selected Tx Power 802.11n 2 Equal to the selected Tx Power +3dBm 802.11n 3 Equal to the selected Tx Power +5dBm 802.11ac 1 Equal to the selected Tx Power Equal to the selected Tx Power 802.11ac 2 -3dBm Equal to the selected Tx Power 802.11ac 3 -5dBm Equal to the selected Tx Power 802.11ac 4 -6dBm Equal to the selected Tx Power Basic and MCS Rate table Default basic and supported rates, depending on selected band band basic rates basic-HT-mcs basic-VHT-mcs VHT-mcs HT-mcs supported rates 2.4ghz-b 1 - - - - 1-11 2.4ghz-onlyg 6 - - - - 1-11,6-54 2.4ghz-onlyn 6 0-7 - - 0-23 1-11,6-54 2.4ghz-b/g 1-11 - - - - 1-11,6-54 2.4ghz-b/g/n 1-11 none - - 0-23 1-11,6-54 2.4ghz-g/n 6 none - - 0-23 6-54 2.4ghz-g-turbo 6 - - - - 6-54 5ghz-a 6 - - - - 6-54 5ghz-a/n 6 none - - 0-23 6-54 5ghz-onlyn 6 0-7 - - 0-23 6-54 5ghz-a/n/ac 6 none none 0-9 0-23 6-54 5ghz-onlyac 6 none 0-7 0-9 0-23 6-54 Used settings when rate-set=configured band used settings 2.4ghz-b basic-b, supported-b 2.4ghz-b/g, 2.4ghz-onlyg basic-b, supported-b, basic-a/g, supported-a/g 2.4ghz-onlyn, 2.4ghz-b/g/n basic-b, supported-b, basic-a/g, supported-a/g, ht-basic-mcs, ht-supported-mcs 2.4ghz-g/n basic-a/g,supported-a/g,ht-basic-mcs,ht-supported-mcs 5ghz-a basic-a/g,supported-a/g 5ghz-a/n, 5ghz-onlyn basic-a/g,supported-a/g,ht-basic-mcs,ht-supported-mcs 5ghz-a/n/ac, 5ghz-onlyac basic-a/g,supported-a/g,ht-basic-mcs,ht-supported-mcs,vht-basic-mcs,vht-supported-mcs Settings independent from : rate-set

Access List Sub-menu: /interface wireless access-list Access list is used by access point to restrict allowed connections from other devices, and to control connection parameters. Access list rules are processed one by one until matching rule is found. Then the action in the matching rule is executed. If action specifies that client should be accepted, client is accepted, potentially overriding it's default connection parameters with ones specified in access list rule. There are the following parameters for access list rules: client matching parameters: address - MAC address of the client interface - optional interface to compare with the interface to which client actually connects to time - time of day and days when rule matches signal-range - range in which client signal must fit for the rule to match allow-signal-out-of-range - option which permits client's signal to be out of the range always or for some time interval connection parameters: ap-tx-limit - tx speed limit in direction to client client-tx-limit - tx speed limit in direction to AP (applies to RouterOS clients only) private-passphrase - PSK passphrase to use for this client if some PSK authentication algorithm is used vlan-mode - VLAN tagging mode specifies if traffic coming from client should get tagged (and untagged when going to client). vlan-id - VLAN ID to use if doing VLAN tagging Operation: Access list rules are checked sequentially. Disabled rules are always ignored. Only the first matching rule is applied. If there are no matching rules for the remote connection, then the default values from the wireless interface configuration are used. If remote device is matched by rule that has =value, the connection from that remote device is rejected. authentication no Warning: If there is no entry in ACL about client which connects to AP (wireless,debug wlan2: A0:0B:BA:D7:4D:B2 not in local ACL, by default accept), then ACL for this client is ignored during all connection time. For example, if client's signal during connection is -41 and we have ACL rule /interface/wireless/access-list add authentication=yes forwarding=yes interface=wlan2 signal-range=-55..0 Then the connection is matched to the ACL rule, but if signal drops below -55, client will not be disconnected. Please note that if "default-authentication=yes" is set on the wireless interface, clients will be able to join even if there are no matching access-list entries. To make it work correctly it is required that client is matched by any of ACL rules. If we modify ACL rules in the previous example to: /interface/wireless/access-list add interface=wlan2 signal-range=-55..0 add authentication=no forwarding=no interface=wlan2 signal-range=-120..-56 Then if signal drops to -56, client will be disconnected. Properties Property Description ap-tx-limit ( ; Default: ) integer [0..4294967295] 0 Limit rate of data transmission to this client. Value means no limit. Value is in bits per 0 second.

authentication ( ; Default: ) yes | no yes no - Client association will always fail. yes - Use authentication procedure that is specified in the of the security-profile interface. client-tx-limit ( ; Default: ) integer [0..4294967295] 0 Ask client to limit rate of data transmission. Value means no limit. 0 This is a proprietary extension that is supported by RouterOS clients. Value is in bits per second. comment ( ; Default: ) string Short description of an entry disabled ( ; Default: ) yes | no no forwarding ( ; Default: ) yes | no yes no - Client cannot send frames to other station that are connected to same access point. yes - Client can send frames to other stations on the same access point. interface ( ; Default: ) string | any | all any Rules with = are used for any wireless interface and the =defines interface any interface all “all” name. To make rule that applies only to one wireless interface, interface-list specify that interface as a value of this property. mac-address ( ; Default: ) MAC 00:00:00:00:00:00 Rule matches client with the specified MAC address. Value matches 00:00:00:00:00:00 always. management-protection-key ( ; Default: ) string "" private-algo (104bit-wep | 40bit-wep | aes-ccm | none | ; Default: ) tkip noneOnly for WEP modes. private-key ( ; Default: ) string "" Only for WEP modes. private-pre-shared-key ( ; Default: ) string "" Used in WPA PSK mode. signal-range (NUM..NUM - both NUM are numbers in the ; Default: ) range -120..120 -120..120Rule matches if signal strength of the station is within the range. If signal strength of the station will go out of the range that is specified in the rule, access point will disconnect that station. time (TIME-TIME,sun,mon,tue,wed,thu,fri,sat -TIME is time interval 0..86400 seconds; all day names are ; Default: ) optional; value can be unsetRule will match only during specified time. Station will be disconnected after specified time ends. Both start and end time is expressed as time since midnight, 00:00. Rule will match only during specified days of the week. Align Sub-menu: /interface wireless align Align tool is used to help in alignment devices running this tool. Property Description active-mode ( ; Default: ) yes | no yes If in active mode, will send out frames for align. audio-max ( ; Default: ) integer [-2147483648..2147483647] -20 Maxumum signal strength for beeper audio-min ( ; Default: ) integer [-2147483648..2147483647] -100 Minimum signal strength for beeper audio-monitor ( ; Default: ) MAC 00:00:00:00:00:00 Which MAC address to use for audio monitoring filter-mac ( ; Default: ) MAC 00:00:00:00:00:00 Filtered out MAC address that will be shown in monitor screen. frame-size ( ; Default: ) integer [200..1500] 300 Size of the frames used by monitor. frames-per-second ( ; Default: ) integer [1..100] 25 Frame transmit interval receive-all ( ; Default: ) yes | no no If set to "yes", monitor will find all available devices.

ssid-all ( ; Default: ) yes | no no Whether to show all SSIDs in the monitor or only one configured in wireless settings. Menu Specific Commands Property Description monitor ( ) interface name Start align monitoring test-audio ( ) integer [-2147483648..2147483647] Test the beeper Connect List Sub-menu: /interface wireless connect-list connect-list is used to assign priority and security settings to connections with remote access points, and to restrict allowed connections. connect-list is an ordered list of rules. Each rule in connect-list is attached to specific wireless interface, specified in the property of that rule (this is unlike interface access , where rules can apply to all interfaces). Rule can match MAC address of remote access point, it's signal strength and many other parameters.-list Operation: connect-list rules are always checked sequentially, starting from the first. disabled rules are always ignored. Only the first matching rule is applied. If SSID or exact wireless protocol is provided in the wireless interface configuration Connect List SSIDs or wireless protocols not covered by wireless interface configuration are ignored. If connect-list does not have any rule that matches remote access point, then the default values from the wireless interface configuration are used. If access point is matched by rule that has =value, connection with this access point will not be attempted. connect no If access point is matched by rule that has = value, connection with this access point will be attempted. connect yes In station mode, if several remote access points are matched by connect list rules with = value, connection will be attempted connect yes with access point that is matched by rule higher in the connect-list. If no remote access points are matched by connect-list rules with = value, then value of interface connect yes default-authentication property determines whether station will attempt to connect to any access point. If = , station will choose access default-authentication yes point with best signal and compatible security. In access point mode, connect-list is checked before establishing WDS link with remote device. If access point is not matched by any rule in the connect list, then the value of determines whether WDS link will be established. default-authentication Properties Property Description 3gpp ( ; Default: ) string area-prefix ( ; string Default: )Rule matches if area value of AP (a proprietary extension) begins with specified value. value is a proprietary extension. area comment ( ; string Default: )Short description of an entry connect ( ; yes | no Default: ) yesAvailable options: yes - Connect to access point that matches this rule. no - Do not connect to any access point that matches this rule. disabled ( ; yes | no Default: ) no mac-address ( ; MAC Default: 00:00:00:00: ) 00:00Rule matches only AP with the specified MAC address. Value matches always. 00:00:00:00:00:00

security-profile (string ; Default: ) | none noneName of that is used when connecting to matching access points, If value of this property is , then security profile none security profile specified in the interface configuration will be used. In station mode, rule will match only access points that can support specified security profile. Value will match access point that supports security profile that is specified in none the interface configuration. In access point mode value of this property will not be used to match remote devices. signal-range (NUM.. NUM - both NUM are numbers in the range ; Default: -120..120 -12 ) 0..120Rule matches if signal strength of the access point is within the range. If station establishes connection to access point that is matched by this rule, it will disconnect from that access point when signal strength goes out of the specified range. ssid ( ; Default: ) string "" Rule matches access points that have this SSID. Empty value matches any SSID. This property has effect only when station mode interface is empty, or when access point mode interface has = ssid wds-ignore-ssid yes wireless-protocol (802. 11 | any | nstreme | ; Default: ) tdma any interface ( ; string Default: )Each rule in connect list applies only to one wireless interface that is specified by this setting. Usage Restrict station connections only to specific access points Set value of interface property to . default-authentication no /interface wireless set station-wlan default-authentication=no Create rules that matches allowed access points. These rules must have = and equal to the name of station wireless connect yes interface interface. /interface wireless connect-list add interface=station-wlan connect=yes mac-address=00:11:22:33:00:01/interface wireless connect- list add interface=station-wlan connect=yes mac-address=00:11:22:33:00:02 Disallow connections to specific access points Set value of interface property to . default-authentication yes /interface wireless set station-wlan default-authentication=yes Create =rules that match those access points that station should not connect to. These rules must have =and equa connect no connect no interface l to the name of station wireless interface. /interface wireless connect-list add interface=station-wlan connect=no mac-address=00:11:22:33:44:55 Select preferred access points Create rules that match preferred access points. These rules must have = and equal to the name of station wireless interface. connect yes interface Put rules that match preferred access points higher in the connect-list, in the order of preference. Restrict WDS link establishment Place rules that match allowed access points at the top. Add deny-all rule at the end of connect list. Info Sub-menu: /interface wireless info Property Description

2ghz-10mhz-power-channels () 2ghz-11n-channels () 2ghz-5mhz-power-channels () 2ghz-b-channels () 2ghz-g-channels () 2ghz-g-turbo-channels () 5ghz-10mhz-power-channels () 5ghz-11n-channels () 5ghz-5mhz-power-channels () 5ghz-channels () 5ghz-turbo-channels () allowed-channels List of available channels for each band capabilities () country-info () Takes country name as argument, shows available bands, frequencies and maximum transmit power for each frequency. chip-info () default-periodic-calibration () firmware () ht-chains () interface-type () name () pci-info () supported-bands () Manual TX Power Table Sub-menu: /interface wireless manual-tx-power-table Property Description comment ( ; Default: ) string Short description of an entry manual-tx-powers (list of [Rate:TxPower]; Rate ::= 11Mbps | 12Mbps | 18Mbps | 1Mbps | 24Mbps | ... ; Default: ) TxPower ::= integer [-30..30] name ( ) string Name of the wireless interface to which tx powers will be applied. Wireless hardware table

Warning: You must follow to regulatory domain requirements in your country. If you are allowed to use other frequencies, note that Antenna Gain and Transmit Power may decrease depending on board and frequency. Devices are calibrated only for regulatory frequencies, use non standard frequencies at your own risk. The list only specifies frequencies accepted by the wireless chip, these frequencies might not always work due to antenna that is built into the product, device design, filters and other factors. USE STRICTLY AT YOUR OWN RISK It is possible to deduce supported channel width from the product page, to do so you need to check the following parameters: and the number of chains ma . Once you know these parameters, you need to check the modulation and coding scheme (MCS) table, for example, here: x data rate https://mcsindex. . com/ If we take hAP ac, as an example, we can see that number of chains is 3, and the max data rate is 1300 in the MCS table. In the MCS table we need to find entry for 3 spatial streams - chains, and the respective data rate, which in this case shows us that 80MHz is the maximum supported channel width. Integrated wireless interface frequency table Board name Wireless interfaces Frequency range [MHz] Supported channel widths [Mhz] 2011UAS-2HnD 1 2312-2732 20,40 751G-2HnD 1 2200-2700 20,40 and advanced channel support 751U-2HnD 1 2200-2700 20,40 and advanced channel support 911-2Hn 1 2312-2732 20,40 911-5HacD 1 4920-6100 20,40,80 911-5Hn 1 4920-6100 5,10,20,40 911-5HnD 1 4920-6100 20,40 911G-2HPnD 1 2312-2732 20,40 911G-5HPacDr2 /-NB /-QRT 1 4920-6100 5,10,20,40,80 911G-5HPnD /-QRT 1 4920-6100 5,10,20,40 912UAG-2HPnD /-OUT 1 2312-2732 20,40 912UAG-5HPnD /-OUT 1 4920-6100 5,10,20,40 912UAG-6HPnD /-OUT 1 5500-6500 and 20,40 921GS-5HPacD-15S /-19S 1 4920-6100 5,10,20,40,801 1 22UGS-5HPacD2HnD 2 4920-5925,2412-2482 20,40,80 and 20,40 921UAGS-5SHPacD-NM 1 4920-6100 20,40,80 921UAGS-5SHPacT-NM 1 4920-6100 20,40,80 922UAGS-5HPacD /-NM 1 4920-6100 20,40,80 922UAGS-5HPacT /-NM 1 4920-6100 20,40,80 941-2nD /-TC 1 2312-2732 20,40 951G-2HnD 1 2312-2732 20,40 951Ui-2HnD 1 2312-2732 20,40 951Ui-2nD 1 2312-2732 20,40 952Ui-5ac2nD /-TC 2 2312-2732,4920-6100 20,40 and 20,40,80 953GS-5HnT /-RP 1 4920-6100 5,10,20,40 962UiGS-5HacT2HnT 2 2312-2732,4920-6100 20,40 and 20,40,80 cAP2n 1 2312-2732 20,40 cAP2nD 1 2312-2732 20,40 cAPL-2nD 1 2312-2732 20,40 CRS109-8G-1S-2HnD-IN 1 2312-2732 20,40 CRS125-24G-1S-2HnD-IN 1 2312-2732 20,40

Disc-5nD 1 4920-6100 20,40 DynaDishG-5HacD 1 4920-6100 5,10,20,40,801 1 DynaDishG-6HnD 1 5500-6500 20,40 Groove52HPn 1 4920-6100,2312-2732 5,10,20,40 and 5,10,20,40 GrooveA-52HPn 1 4920-6100,2312-2732 5,10,20,40 and 5,10,20,40 GrooveG-52HPacn 1 4920-6100,2312-2732 20,40,80 and 20,40 GrooveGA-52HPacn 1 4920-6100,2312-2732 20,40,80 and 20,40 LDF-5nD 1 4920-6100 20,40 LHG-5nD 1 4920-6100 20,40 mAP2n 1 2312-2732 20,40 mAP2nD 1 2312-2732 20,40 mAPL-2nD 1 2312-2732 20,40 Metal2SHPn 1 2200-2700 20,40 and advanced channel support Metal5SHPn 1 4800-6100 5,10,20,40 and advanced channel support Metal9HPn 1 902-928 5,10,20 MetalG-52SHPacn 1 4920-6100,2312-2732 20,40,80 and 20,40 OmniTikG-5HacD 1 4920-6100 20,40,80 OmniTikPG-5HacD 1 4920-6100 20,40,80 OmniTIKU-5HnD 1 4800-6100 5,10,20,40 OmniTIKUPA-5HnD 1 4800-6100 5,10,20,40 QRTG-2SHPnD 1 2312-2732 20,40 SEXTANTG-5HPnD 1 4920-6100 20,40 SXT2nDr2 1 2312-2732 20,40 SXT5HacD2n 2 2312-2732,4920-6100 5,10,20,40 and 5 ,10,20,40,801 1 1 1 SXT5HPnDr2 1 4920-6100 20,40 SXT5nDr2 1 4920-6100 20,40 SXTG-2HnD 1 2200-2700 20,40 SXTG-2HnDr2 1 2300-2700 20,40 SXTG-5HPacD 1 4920-6100 5,10,20,40,801 1 SXTG-5HPacD-HG /-SA 1 4920-6100 5,10,20,40,801 1 SXTG-5HPnD-HGr2 /-SAr2 1 4920-6100 20,40 SXTG-6HPnD 1 5500-6500 20,40 SXTsq2nD 1 2312-2484 20,40 wAP2nD /-BE 1 2312-2732 20,40 wAPG-5HacT2HnD /-BE 2 2312-2732,4920-6100 20,40 and 20,40,80 R11e-2HnD 1 2312-2732 20,40 R11e-2HPnD 1 2312-2732 20,40 R11e-5HacD 1 4920-6100 20,40,80 R11e-5HacT 1 4920-6100 20,40,80 R11e-5HnD 1 4920-6100 20,40 R2SHPn 1 2200-2700 20,40 and advanced channel support R52H 1 4920-6100,2192-2507 20 and 20

Two radios in nstreme-dual-slave mode can be grouped together to make nstreme2 Point-to-Point connection. To put wireless interfaces into a nstreme2 group, you should set their mode to nstreme-dual-slave. Many parameters from /interface wireless menu are ignored, using the nstreme2, except: frequency-mode country antenna-gain tx-power tx-power-mode antenna-mode Property Description arp ( ; disabled | enabled | proxy-arp | reply-only Default: ) enabledRead more >> comment ( ; Default: ) string Short description of an entry disable-csma ( ; Default: ) yes | no no Disable CSMA/CA (better performance) disable-running-check ( ; Default: ) yes | no no Whether the interface should always be treated as running even if there is no connection to a remote peer disabled ( ; Default: ) yes | no yes framer-limit ( ; Default: ) integer [64..4000] 2560 Maximal frame size framer-policy ( ; Default: best-fit | exact-size | none ) noneThe method how to combine frames. A number of frames may be combined into one bigger one to reduce the amout of protocol overhead (and thus increase speed). The card are not waiting for frames, but in case a number packets are queued for transmitting, they can be combined. There are several methods of framing: none - do nothing special, do not combine packets best-fit - put as much packets as possible in one frame, until the framer-limit limit is met, but do not fragment packets exact-size - put as much packets as possible in one frame, until the framer-limit limit is met, even if fragmentation will be needed (best performance) ht-channel-width ( ; 2040mhz | 20mhz | 40mhz Default: ) 20mhz ht-guard-interval ( ; Default: ) both | long | short long ht-rates ( ; Default: list of rates [1,2,3,4,5,6,7,8] 1,2, ) 3,4,5,6,7,8 ht-streams ( ; Default: ) both | double | single single l2mtu ( ; Default: ) integer [0..65536] mtu ( ; Default: ) integer [0..65536] 1500 name ( ; Default: ) string Name of an entry rates-a/g (list of rates [6Mbps,9Mbps, 12Mbps, ; 18Mbps, 24Mbps, 36Mbps, 48Mbps, 54Mbps] Default: 6Mbps,9Mbps,12Mbps, 18Mbps, ) 24Mbps, 36Mbps, 48Mbps, 54MbpsRates to be supported in 802.11a or 802.11g standard rates-b (list of rates [1Mbps, 2Mbps, 5.5Mbps, ; Default: 11Mbps] 1Mbps, 2Mbps, 5.5Mbps, ) 11MbpsRates to be supported in 802.11b standard remote-mac ( ; Default: ) MAC 00:00:00:00:00:00 Which MAC address to connect to (this would be the remote receiver card's MAC address)

rx-band (2ghz-b | 2ghz-g | 2ghz-n | 5ghz-a | 5ghz- ; Default: )nOperating band of the receiving radio rx-channel-width ( ; Default: ) 10mhz 20mhz rx-frequency ( ; Default: ) integer [0..4294967295] RX card operation frequency in Mhz. rx-radio ( ; Default: ) string Name of the interface used for receive. tx-band (2ghz-b | 2ghz-g | 2ghz-n | 5ghz-a | 5ghz- ; Default: )nOperating band of the transmitting radio tx-channel-width ( ; Default: ) 10mhz 20mhz tx-frequency ( ; Default: ) integer [0..4294967295] TX card operation frequency in Mhz. tx-radio ( ; Default: ) string Name of the interface used for transmit. Warning: WDS cannot be used on Nstreme-dual links. Note: The difference between tx-freq and rx-freq should be about 200MHz (more is recommended) because of the interference that may occur! Note: You can use different bands for rx and tx links. For example, transmit in 2ghz-g and receive data, using 2ghz-b band. Registration Table Sub-menu: /interface wireless registration-table In the registration table, you can see various information about currently connected clients. It is used only for Access Points. All properties are read-only. Property Description 802.1x- port- enabled (y ) es | nowhether the data exchange is allowed with the peer (i.e., whether 802.1x authentication is completed, if needed) ack- timeout (in ) tegercurrent value of ack-timeout ap (yes | )noShows whether registered device is configured as access point. ap-tx-limit ( ) integertransmit rate limit on the AP, in bits per second authentica tion-type ()authentication method used for the peer bridge (ye ) s | no bytes (inte ger , ) integernumber of sent and received packet bytes

client-tx- limit (integ )ertransmit rate limit on the AP, in bits per second comment ( ) stringDescription of an entry. comment is taken from appropriate entry if specified. Access List compressi on (yes | )nowhether data compresson is used for this peer distance (i ) nteger encryption (aes-ccm ) | tkipunicast encryption algorithm used evm-ch0 () evm-ch1 () evm-ch2 () frame- bytes (inte ger, ) integernumber of sent and received data bytes excluding header information frames (int eger, ) integerNumber of frames that need to be sent over wireless link. This value can be compared to to check wireless retransmits. hw-frames Rea d more >> framing- current- size (integ )ercurrent size of combined frames framing- limit (integ )ermaximal size of combined frames framing- mode ()the method how to combine frames group- encryption ()group encryption algorithm used hw-frame- bytes (inte ger, ) integernumber of sent and received data bytes including header information hw-frames (integer, ) integerNumber of frames sent over wireless link by the driver. This value can be compared to to check wireless retransmits. frames Read more >> interface ( ) stringName of the wireless interface to which wireless client is associated last- activity (ti )melast interface data tx/rx activity last-ip (IP ) AddressIP address found in the last IP packet received from the registered client

mac- address ( ) MACMAC address of the registered client managem ent- protection ( ) yes | no nstreme (y ) es | noShows whether is enabled Nstreme p- throughput ( ) integerestimated approximate throughput that is expected to the given peer, taking into account the effective transmit rate and hardware retries. Calculated once in 5 seconds packed- bytes (inte ger, ) integernumber of bytes packed into larger frames for transmitting/receiving (framing) packed- frames (int eger, ) integernumber of frames packed into larger ones for transmitting/receiving (framing) packets (i nteger. ) integernumber of sent and received network layer packets radio- name (stri )ngradio name of the peer routeros- version (st )ringRouterOS version of the registered client rx-ccq () Client Connection Quality (CCQ) for receive. Read more >> rx-rate (int )egerreceive data rate signal- strength (i ) ntegeraverage strength of the client signal recevied by the AP signal- strength- ch0 () signal- strength- ch1 () signal- strength- ch2 () signal-to- noise () strength- at-rates ()signal strength level at different rates together with time how long were these rates used tdma-retx ()

tdma-rx- size () tdma- timing- offset ()tdma-timing-offset is proportional to and is approximately two times the propagation delay. AP measures this so that it can tell distance clients what offset to use for their transmissions - clients then subtract this offset from their target transmission time such that propagation delay is accounted for and transmission arrives at AP when expected. You may occasionally see small negative value (like few usecs) there for close range clients because of additional unaccounted delay that may be produced in transmitter or receiver hardware that varies from chipset to chipset. tdma-tx- size (integ )erValue in bytes that specifies the size of data unit whose loss can be detected (data unit over which CRC is calculated) sent by device. In general - the bigger the better, because overhead is less. On the other hand, small value in this setting can not always be considered a signal that connection is poor - if device does not have enough pending data that would enable it to use bigger data units (e.g. if you are just pinging over link), this value will not go up. tdma- windfull () tx-ccq () Client Connection Quality (CCQ) for transmit. Read more >> tx-evm- ch0 () tx-evm- ch1 () tx-evm- ch2 () tx-frames- timed-out () tx-rate () tx-signal- strength () tx-signal- strength- ch0 () tx-signal- strength- ch1 () tx-signal- strength- ch2 () uptime (ti )metime the client is associated with the access point wds (yes | )nowhether the connected client is using wds or not wmm- enabled (y ) es | noShows whether is enabled. WMM Security Profiles Sub-menu: /interface wireless security-profiles Security profiles are configured under the path in the console, or in the "Security Profiles" tab of the "Wireless" window /interface wireless security-profiles in the WinBox. Security profiles are referenced by the Wireless interface property and property of Connect Lists. security-profile security-profile

Basic properties Property Description mode (none | static-keys- optional | static-keys- ; required | dynamic-keys Default: ) noneEncryption mode for the security profile. none - Encryption is not used. Encrypted frames are not accepted. static-keys-required - WEP mode. Do not accept and do not send unencrypted frames. Station in static-keys- mode will not connect to an Access Point in mode. required static-keys-optional static-keys-optional - WEP mode. Support encryption and decryption, but allow also to receive and send unencrypted frames. Device will send unencrypted frames if encryption algorithm is specified as . Station in none st mode will not connect to an Access Point in mode. See also: atic-keys-optional static-keys-required static-sta- , . private-algo static-transmit-key dynamic-keys - WPA mode. name (; Default: )text Name of the security profile WPA properties These properties have effect only when is set to . mode dynamic-keys Property Description authentication-types (wpa- psk | wpa2-psk | wpa-eap | ; Default: ) wpa2-eapSet of supported authentication types, multiple values can be selected. Access Point will advertise supported authentication types, and client will connect to Access Point only if it supports any of the advertised authentication types. disable-pmkid ( ; no | yes Default: ) noWhether to include PMKID into the EAPOL frame sent out by the Access Point. Disabling PMKID can cause compatibility issues with devices that use the PMKID to connect to an Access Point. yes- removes PMKID from EAPOL frames (improves security, reduces compatibility). no- includes PMKID into EAPOL frames (reduces security, improves compatibility). This property only has effect on Access Points. unicast-ciphers (tkip | aes- ; Default: ) ccm aes-ccmAccess Point advertises that it supports specified ciphers, multiple values can be selected. Client attempts connection only to Access Points that supports at least one of the specified ciphers. One of the ciphers will be used to encrypt unicast frames that are sent between Access Point and Station. group-ciphers (tkip | aes- ; Default: ) ccm aes-ccmAccess Point advertises one of these ciphers, multiple values can be selected. Access Point uses it to encrypt all broadcast and multicast frames. Client attempts connection only to Access Points that use one of the specified group ciphers. tkip- Temporal Key Integrity Protocol - encryption protocol, compatible with legacy WEP equipment, but enhanced to correct some of the WEP flaws. aes-ccm - more secure WPA encryption protocol, based on the reliable AES (Advanced Encryption Standard). Networks free of WEP legacy should use only this cipher. group-key-update (time: ; Default: ) 30s..1d 5mControls how often Access Point updates the group key. This key is used to encrypt all broadcast and multicast frames. property only has effect for Access Points. wpa-pre-shared-key (; text Default: )WPA pre-shared key mode requires all devices in a BSS to have common secret key. Value of this key can be an arbitrary text. Commonly referred to as the network password for WPA mode. property only has effect when i wpa-psk s added to . authentication-types wpa2-pre-shared-key (; text Default: )WPA2 pre-shared key mode requires all devices in a BSS to have common secret key. Value of this key can be an arbitrary text. Commonly referred to as the network password for WPA2 mode. property only has effect when wpa2- is added to . psk authentication-types Note: RouterOS also allows to override pre-shared key value for specific clients, using either the property, or the private-pre-shared-key Mikrotik-Wireless- attribute in the RADIUS MAC authentication response. This is an extension.Psk

WPA EAP properties These properties have effect only when contains or , and is set to . authentication-types wpa-eap wpa2-eap mode dynamic-keys Property Description eap-methods (eap-tls | eap- ttls-mschapv2 | passthrough | ; Default: ) peap passthroughAllowed types of authentication methods, multiple values can be selected. This property only has effect on Access Points. eap-tls - Use built-in EAP TLS authentication. Both client and server certificates are supported. See description of and properties. tls-mode tls-certificate eap-ttls-mschapv2 - Use EAP-TTLS with MS-CHAPv2 authentication. passthrough - Access Point will relay authentication process to the RADIUS server. peap - Use Protected EAP authentication. supplicant-identity (; text Default: ) IdentityEAP identity that is sent by client at the beginning of EAP authentication. This value is used as a value for User- Name attribute in RADIUS messages sent by RADIUS EAP accounting and RADIUS EAP pass-through authentication. mschapv2-username (; text Default: )Username to use for authentication when or authentication method is being used. This eap-ttls-mschapv2 peap property only has effect on Stations. mschapv2-password (; text Default: )Password to use for authentication when or authentication method is being used. This eap-ttls-mschapv2 peap property only has effect on Stations. tls-mode (verify-certificate | dont-verify-certificate | no- certificates | verify-certificate- ; Default: with-crl no- ) certificatesThis property has effect only when contains . eap-methods eap-tls verify-certificate - Require remote device to have valid certificate. Check that it is signed by known certificate authority. No additional identity verification is done. Certificate may include information about time period during which it is valid. If router has incorrect time and date, it may reject valid certificate because router's clock is outside that period. See also the configuration. Certificates dont-verify-certificate - Do not check certificate of the remote device. Access Point will not require client to provide certificate. no-certificates - Do not use certificates. TLS session is established using 2048 bit anonymous Diffie-Hellman key exchange. verify-certificate-with-crl - Same as but also checks if the certificate is valid by checking the verify-certificate Certificate Revocation List. tls-certificate ( ; none | name Default: ) noneAccess Point always needs a certificate when configured when is set to , or is set to tls-mode verify-certificate dont- . Client needs a certificate only if Access Point is configured with set to . In verify-certificate tls-mode verify-certificate this case client needs a valid certificate that is signed by a CA known to the Access Point. This property only has effect when is not set to and contains . tls-mode no-certificates eap-methods eap-tls Note: The order of allowed authentication methods in is important, the same order is going to be used to send authentication method offers eap-methods to the Station. Example: Access Point uses security-profile where is set to , ; 1) Access Point offers EAP-TLS method to eap-methods eap-tls passthrough the client; 2) Client refuses; 3) Access Point starts relaying EAP communication to the radius server. Note: When the AP is used for passthrough it is not required to add certificates on the AP itself, the AP device works as a transparent bridge and forwards the EAP-TLS association data from RADIUS server to the end client. Note: When is using either or , then the remote device has to support one of the tls-mode verify-certificate dont-verify-certificate RC4- , or TLS cipher suites. When using mode, then the remote device must support "ADH-DES-CBC3- MD5 RC4-SHA DES-CBC3-SHA no-certificates SHA" cipher suite. RADIUS properties Property Description

radius-mac-authentication ( ; Default: ) yes | no no This property affects the way how Access Point processes clients that are not found in the . Access List no- allow or reject client authentication based on the value of default- property of the Wireless interface. authentication yes- Query RADIUS server using MAC address of client as user name. With this setting the value of has no effect. default-authentication radius-mac-accounting ( ; Default: ) yes | no no radius-eap-accounting ( ; Default: ) yes | no no radius-called-format ( ; Default: ) mac | mac:ssid | ssid mac:ssid interim-update ( ; Default: ) time 0 When RADIUS accounting is used, Access Point periodically sends accounting information updates to the RADIUS server. This property specifies default update interval that can be overridden by the RADIUS server using at Acct-Interim-Interval tribute. radius-mac-format (XX:XX:XX:XX:XX:XX | XXXX:XXXX:XXXX | XXXXXX:XXXXXX | XX-XX-XX-XX-XX-XX | XXXXXX- XXXXXX | XXXXXXXXXXXX | XX XX XX XX XX XX | lower Default: ) case; XX:XX:XX:XX:XX:XXControls how MAC address of the client is encoded by Access Point in the User- Name attribute of the MAC authentication and MAC accounting RADIUS requests. radius-mac-mode ( ; as-username | as-username-and-password Default: ) as-usernameBy default Access Point uses an empty password, when sending Access-Request during MAC authentication. When this property is set to as-username-and- , Access Point will use the same value for User-Password attribute as for password the User-Name attribute. radius-mac-caching ( ; Default: ) disabled | time disabled If this value is set to time interval, the Access Point will cache RADIUS MAC authentication responses for specified time, and will not contact RADIUS server if matching cache entry already exists. Value will disable cache, Access disabled Point will always contact RADIUS server. WEP properties These properties have effect only when is set to or . mode static-keys-required static-keys-optional Property Description static-key-0 | static-key-1 | static-key-2 | static-key-3 (h ; Default: )exHexadecimal representation of the key. Length of key must be appropriate for selected algorithm. See the Statically section. configured WEP keys static-algo-0 | static-algo-1 | static-algo-2 | static-algo-3 (none | 40bit-wep | 104bit- ; wep | tkip | aes-ccm Default: ) noneEncryption algorithm to use with the corresponding key. static-transmit-key (key-0 | ; key-1 | key-2 | key-3 Default: ) key-0Access Point will use the specified key to encrypt frames for clients that do not use private key. Access Point will also use this key to encrypt broadcast and multicast frames. Client will use the specified key to encrypt frames if static-sta- is set to . If corresponding property has value set to , then frame will be sent private-algo none static-algo-N none unencrypted (when is set to ) or will not be sent at all (when is set to mode static-keys-optional mode static-keys- ). required static-sta-private-key (; hex Default: )Length of key must be appropriate for selected algorithm, see the section. This Statically configured WEP keys property is used only on Stations. Access Point uses corresponding key either from property, or from private-key Mikro attribute. tik-Wireless-Enc-Key static-sta-private-algo (none | 40bit-wep | 104bit-wep | ; Default: tkip | aes-ccm none )Encryption algorithm to use with station private key. Value disables use of the private key. This property is only none used on Stations. Access Point has to get corresponding value either from property, or from private-algo Mikrotik- attribute. Station private key replaces key 0 for unicast frames. Station will not use private key to Wireless-Enc-Algo decrypt broadcast frames.

Management frame protection : Deauthentication attack prevention, MAC address cloning issue. Used for RouterOS implements proprietary management frame protection algorithm based on shared secret. Management frame protection means that RouterOS wireless device is able to verify source of management frame and confirm that particular frame is not malicious. This feature allows to withstand deauthentication and disassociation attacks on RouterOS based wireless devices. Management protection mode is configured in security-profile with setting. Possible values are: - management protection management-protection disabled is disabled (default), - use management protection if supported by remote party (for AP - allow both, non-management protection and allowed management protection clients, for client - connect both to APs with and without management protection), - establish association only with remote required devices that support management protection (for AP - accept only clients that support management protection, for client - connect only to APs that support management protection). Management protection shared secret is configured with security-profile setting. management-protection-key When interface is in AP mode, default management protection key (configured in security-profile) can be overridden by key specified in access-list or RADIUS attribute. [admin@mikrotik] /interface wireless security-profiles> print 0 name="default" mode=none authentication-types="" unicast-ciphers="" group-ciphers="" wpa-pre-shared-key="" wpa2-pre-shared-key="" supplicant-identity="n-str-p46" eap-methods=passthrough tls-mode=no-certificates tls-certificate=none static-algo-0=none static-key-0="" static-algo-1=none static-key-1="" static-algo-2=none static-key-2="" static-algo-3=none static-key-3="" static-transmit-key=key-0 static-sta-private-algo=none static-sta-private-key="" radius-mac-authentication=no radius-mac-accounting=no radius-eap-accounting=no interim-update=0s radius-mac-format=XX:XX:XX:XX:XX:XX radius-mac-mode=as-username radius-mac-caching=disabled group-key-update=5m management-protection=disabled management-protection-key="" [admin@mikrotik] /interface wireless security-profiles> set default management-protection= allowed disabled required

Operation details RADIUS MAC authentication Note: RAIDUS MAC authentication is used by access point for clients that are not found in the , similarly to the property of access-list default-authentication the wireless interface. It controls whether client is allowed to proceed with authentication, or is rejected immediately. When = , access point queries RADIUS server by sending Access-Request with the following attributes: radius-mac-authentication yes User-Name - Client MAC address. This is encoded as specified by the setting. Default encoding is "XX:XX:XX:XX:XX:XX". radius-mac-format Nas-Port-Id - of wireless interface. name User-Password - When = this is set to the same value as User-Name. Otherwise this attribute is radius-mac-mode as-username-and-password empty. Calling-Station-Id - Client MAC address, encoded as "XX-XX-XX-XX-XX-XX". Called-Station-Id - MAC address and SSID of the access point, encoded as "XX-XX-XX-XX-XX-XX:SSID" (minus separated pairs of MAC address digits, followed by colon, followed by SSID value). Acct-Session-Id - Added when = . radius-mac-accounting yes

When access point receives Access-Accept or Access-Reject response from the RADIUS server, it stores the response and either allows or rejects client. Access point uses following RADIUS attributes from the Access-Accept response: Ascend-Data-Rate Ascend-Xmit-Rate Mikrotik-Wireless-Forward - Same as . access-list forwarding Mikrotik-Wireless-Enc-Algo - Same as . access-list private-algo Mikrotik-Wireless-Enc-Key - Same as . access-list private-key Mikrotik-Wireless-Psk - Same as . access-list private-pre-shared-key Mikrotik-Wireless-Mpkey - Same as Management-protection-key in Access list Session-Timeout - Time, after which client will be disconnected. Acct-Interim-Interval - Overrides value of . interim-update Class - If present, value of this attribute is saved and included in Accounting-Request messages. Caching Caching of RADIUS MAC authentication was added to support RADIUS authentication for clients that require from the access point very quick response to the association request. Such clients time out before response from RADIUS server is received. Access point caches authentication response for some time and can immediately reply to the repeated association request from the same client. RADIUS EAP pass-through authentication When using WPA EAP authentication type, clients that have passed MAC authentication are required to perform EAP authentication before being authorized to pass data on wireless network. With pass-through EAP method the access point will relay authentication to RADIUS server, and use following attributes in the Access-Request RADIUS message: User-Name - EAP supplicant identity. This value is configured in the property of the client security profile. supplicant-identity Nas-Port-Id - of wireless interface. name Calling-Station-Id - Client MAC address, encoded as "XX-XX-XX-XX-XX-XX". Called-Station-Id - MAC address and SSID of the access point, encoded as "XX-XX-XX-XX-XX-XX:SSID" (pairs of MAC address digits separated by minus sign, followed by colon, followed by SSID value). Acct-Session-Id - Added when = . radius-eap-accounting yes Acct-Multi-Session-Id - MAC address of access point and client, and unique 8 byte value, that is shared for all accounting sessions that share single EAP authentication. Encoded as Added when radius-eap- AA-AA-AA-AA-AA-AA-CC-CC-CC-CC-CC-CC-XX-XX-XX-XX-XX-XX-XX-XX. accounting=yes. Access point uses following RADIUS attributes from the Access-Accept server response: Class - If present, value of this attribute is saved and included in Accounting-Request messages. Session-Timeout - Time, after which client will be disconnected. Additionally, access point will remember authentication result, and if during this time client reconnects, it will be authorized immediately, without repeating EAP authentication. Acct-Interim-Interval - Overrides value of . interim-update Statically configured WEP keys Different algorithms require different length of keys: 40bit-wep - 10 hexadecimal digits (40 bits). If key is longer, only first 40 bits are used. 104bit-wep - 26 hexadecimal digits (104 bits). If key is longer, only first 104 bits are used. tkip - At least 64 hexadecimal digits (256 bits). aes-ccm - At least 32 hexadecimal digits (128 bits). Key must contain even number of hexadecimal digits. WDS security configuration WDS links can use all available security features. However, they require careful configuration of security parameters. It is possible to use one security profile for all clients, and different security profiles for WDS links. Security profile for WDS link is specified in . connect-list Access point always checks connect list before establishing WDS link with another access point, and used security settings from matching connect list entry. WDS link will work when each access point will have connect list entry that matches the other device, has = and specifies compatible connect yes sec . urity-profile WDS and WPA/WPA2

If access point uses security profile with = , then encryption will be used for all WDS links. Since WPA authentication and key exchange mode dynamic-keys is not symmetrical, one of the access points will act as a client for the purpose of establishing secure connection. This is similar to how and static-mesh dyn WDS modes work. Some problems, like single sided WDS link between two incorrectly configured access points that use non mode, is amic-mesh -mesh not possible if WPA encryption is enabled. However, non modes with WPA still have other issues (like constant reconnection attempts in case of -mesh configuration mismatch) that are solved by use of the WDS modes. -mesh In general, WPA properties on both access points that establish WPA protected WDS link have to match. These properties are , authentication-types unicast , . For non WDS mode these properties need to have the same values on both devices. In WDS mode each access point -ciphers group-ciphers -mesh mesh has to support the other one as a client. Theoretically it is possible to use RADIUS MAC authentication and other RADIUS services with WDS links. However, only one access point will interact with the RADIUS server, the other access point will behave as a client. Implementation of EAP method in RouterOS is particularly well suited for WDS link encryption. = requires no additional eap-tls tls-mode no-certificates configuration, and provides very strong encryption. WDS and WEP mode , and parameters in the security profile assigned to the WDS link need to have the same values on both static-sta-private-key static-sta-private-algo access points that establish WDS link with WPA encryption. Security profile and access point matching in the connect list Client uses value of property to match only those access points that support necessary security. connect-list security-profile mode = and = matches only access points with the same in interface . static-keys-required mode static-keys-optional mode security-profile If = , then connect list entry matches if all of the , and contain at least one mode dynamic-keys authentication-types unicast-ciphers group-ciphers value that is advertised by access point. Virtual interfaces VirtualAP It is possible to create virtual access points using the command in the wireless menu. You must specify the which the virtual interface add master-interface will belong to. If "master-interface" mode is "station", Virtual AP will work only when "master-interface" will be active. The Virtual AP can have it's own SSID and Security Profile. Virtual AP interface will only work if master interface is in , , or wds-slave mode. It works only with 802.11 protocol, Nv2 is not ap-bridge bridge station supported. This feature is useful for separating access for different types of users. You can assign different bandwidth levels and passwords and instruct users to connect to the specific virtual network, it will appear to wireless clients as a different SSID or a different device. For example, when using QuickSet to configure a guest network, the VirtualAP feature is used in the background. To create a new virtual-ap: /interface> wireless add mode=ap-bridge master-interface=wlan1 ssid=guests security- profile=guests ( ) such security profile first needs to be created Note: you can create up to 127 virtual interfaces per physical interface. It is not recommended to create more 30, since the performance will start to degrade. Virtual Clients Note: Starting from 6.35 only in wireless-rep or wireless-cm2 package It is also possible to create virtual clients and have both an AP and a Client on the same physical interface. This allows to make a repeater setup with only using one hardware card. The process of configuration is exacly the same as above, but use mode : station To create a new virtual-client: /interface> wireless add mode=station master-interface=wlan1 ssid=where-to-connect security- profile=your-profile ( ) such security profile first needs to be created Note: Virtual interfaces will always use the Master interface wireless frequency. If the Master interface has 'auto' frequency enabled it will use the wireless frequency that the Master interface selected.

Sniffer Sub-menu: /interface wireless sniffer Wireless sniffer allows to capture frames including Radio header, 802.11 header and other wireless related information. Property Description channel-time (; Default: ) 200ms How long to sniff each channel. Used only if multiple-channels=yes file-limit ( ; Default: integer [10..4294967295] )10Allocated file size in bytes which will be used to store captured data. Applicable if is file-name specified. file-name ( ; Default: ) string Name of the file where to store captured data. memory-limit ( ; integer [10..4294967295] Default: ) 10Allocated memory buffer in kilobytes used to store captured data. multiple-channels ( ; Default: ) yes | no no Whether to sniff multiple channels or a single channel. means that all channel settings will be No taken from , /interface wireless means that all channel settings will be taken from under . Yes scan-list /interface wireless only-headers ( ; Default: ) yes | no no If set to yes, then sniffer will capture only information stored in frame headers. receive-errors ( ; Default: ) yes | no no Whether to process packets which have been received with errors judging by their FCS. streaming-enabled ( ; Default: ) yes | no no Whether to stream captured data to the specified streaming server streaming-max-rate (integer [0..4294967295] ; Default: ) 0Maximum packets per second allowed. equals unlimited0 streaming-server ( ; Default: ) IPv4 0.0.0.0 IP address of the streaming server. Packets Sub-menu: /interface wireless sniffer packet Sub-menu shows captured packets. Scan Scan command allows to see available AP in the frequency range defined in the scan-list. Using scan command the interface operation is disabled (wireless link is disconnected during the scan operation) Since RouterOS v6.35 (wireless-rep) background scan is supported which can be used during the wireless interface operation without disconnecting the wireless link. Background scan is supported only using 802.11 wireless protocol. Scan tool will continue scanning for AP until user stops the scan process. It is possible to use 'rounds' setting for the scan tool to do scan through the scan- list entries specific times. It is useful when running scan tool using scripts. Example of scan command for one round: /interface wireless scan wlan1 rounds=1 'save-file' option allows to do scripted/scheduled scans and save the results in file for future analysis. Also this feature together with rounds setting allows to get scan results from the remote wireless clients - executing that command will start the scan tool which disconnect the wireless link, does the scan through the scan-list frequencies and saves the results to file, exits the scan and connects the wireless link back. Example: /interface wireless scan wlan1 rounds=1 save-file=scan1 To use background wireless scan the 'background=yes' setting should be provided. Example: /interface wireless scan wlan1 background=yes Use the command to verify your defined under when using /interface wireless info scan-list scan-list /interface wireless channels multiple- channels=yes

Background scan feature is working in such conditions: Wireless interface should be enabled For wireless interface in AP mode - when it is operating in 802.11 protocol mode and is on fixed channel (that is - channel selection and initial radar checking is over) For wireless interface in Station mode - when it is connected to 802.11 protocol AP. Scan command is supported also on the Virtual wireless interfaces with such limitations: It is possible when virtual interface and its master is fixed on channel (master AP is running or master station is connected to AP). Scan is only performed in channel master interface is on. It does not matter if background=yes|no - on virtual interface scan does not disconnect clients/AP, so it is always "background". Snooper This tool monitors surrounding frequency usage, and displays which devices occupy each frequency. It's available both in console, and also in Winbox. Sn ooper will use frequencies from scan-list. Sub-menu: /interface wireless snooper

Settings Spectral scan See separate document Manual:Spectral_scan WDS Sub-menu: /interface wireless wds Properties: Property Description arp ( ; Default: ) disabled | enabled | proxy-arp | reply-only enabled comment ( ; Default: ) string disable-running-check ( ; Default: ) yes | no no

create-profile - creates wireless security profile with the specified name, configures it with security details received from the WPS AP, specifies the wireless interface to use the new created security profile ssid - get WPS information only from AP with specified SSID mac-address - get WPS information only from AP with specified mac-address Repeater Wireless repeater will allow to receive the signal from the AP and repeat the signal using the same physical interface locally for connecting other clients. This will allow to extend the wireless service for the wireless clients. Wireless repeater function will configure the wireless interface to connect to the AP with station-bridge or station-pseudobridge option, create a virtual AP interface, create a bridge interface and add both (main and the virtual) interfaces to the bridge ports. If your AP mode, you can use the automatic setup command: supports button-enabled WPS /interface wireless setup-repeater wlan1 The setup-repeater does the following steps: searches for WPS AP with button pushed acquires SSID, key, channel from AP resets main master interface config (same as reset-configuration) removes all bridge ports that were added for virtual interfaces added to this master (so there are no dangling invalid bridge ports later) removes all virtual interfaces added to this master creates security profile with name "<interfacename>-<ssid>-repeater", if such security profile already exists does not create new, just updates settings configures master interface, interface mode is selected like this: if AP supports bridge mode, use station-bridge, else if AP supports WDS, use station-wds, else use station-pseudobridge creates virtual AP interface with same SSID and security profile as master if master interface is not in some bridge, creates new bridge interface and adds master interface to it adds virtual AP interface to the same bridge master interface is in. If your AP , it is possible to specify the settings manually, using these parameters: does not support WPS address - MAC address of AP to setup repeater for (optional) ssid - SSID of AP to setup repeater for (optional) passphrase - key to use for AP - if this IS specified, command will just scan for AP and create security profile based on info in beacon and with this passphrase. If this IS NOT specified, command will do WPS to find out passphrase. Roaming Station Roaming Station Roaming feature is available only for 802.11 wireless protocol and only for station modes. When RouterOS wireless client is connected to the AP using 802.11 wireless protocol it will periodically perform the background scan with specific time intervals. When the background scan will find an AP with better signal it will try to roam to that AP. The time intervals between the background scans will become shorter when the wireless signal becomes worse and the background scan interval will become longer when the wireless client signal will get better. VLAN tagging Sub-menu: /interface wireless With VLAN tagging it is possible to separate Virtual AP traffic on Ethernet side of "locally forwarding" AP (the one on which wireless interfaces are bridged with Ethernet). This is necessary to separate e.g. "management" and "guest" network traffic of Ethernet side of APs. VLAN is assigned for wireless interface and as a result all data coming from wireless gets tagged with this tag and only data with this tag will send out over wireless. This works for all wireless protocols except that on Nv2 there's no Virtual AP support. You can configure your RADIUS authentication server to assign users or groups of users to a specific VLAN when they authenticate to the network. To use this option you will need to use . RADIUS attributes Note: In case to use this option you must enable wireless-fp or wireless-cm2 package for RouterOS version up to 6.37. Starting from RouterOS v6.37 you can do that with regular wireless package.

Property Description vlan-mode ( ; Default: ) no tag | user service tag | use tag no tag Three VLAN modes are available: no-tag - AP don't use VLAN tagging use-service-tag - VLAN ID use 802.1ad tag type use-tag - VLAN ID use 802.1q tag type vlan-id ( ; Default: ) integer [1..4095] 1 VLAN identification number Vlan tag override Per-interface VLAN tag can be overridden on per-client basis by means of access-list and RADIUS attributes (for both - regular wireless and wireless controller). This way traffic can be separated between wireless clients even on the same interface, but must be used with care - only "interface VLAN" broadcast /multicast traffic will be sent out. If working broadcast/multicast is necessary for other (overridden) VLANs as well, multicast-helper can be used for now (this changes every multicast packet to unicast and then it is only sent to clients with matching VLAN ids). Winbox Winbox is a small utility that allows the administration of Mikrotik RouterOS using a fast and simple GUI. Note: Current Tx Power gives you information about transmit power currently used at specific data rate. Currently not supported for Atheros 802.11ac chips (e.g. QCA98xx). Interworking Realms setting For more information about interworking-profiles see the . manual realms-raw - list of strings with hex values. Each string specifies contents of "NAI Realm Tuple", excluding "NAI Realm Data Field Length" field. Each hex encoded string must consist of the following fields: - NAI Realm Encoding (1 byte) - NAI Realm Length (1 byte) - NAI Realm (variable) - EAP Method Count (1 byte) - EAP Method Tuples (variable) For example, value "00045465737401020d00" decodes as: - NAI Realm Encoding: 0 (rfc4282) - NAI Realm Length: 4 - NAI Realm: Test - EAP Method Count: 1 - EAP Method Length: 2 - EAP Method Tuple: TLS, no EAP method parameters Note, that setting "realms-raw=00045465737401020d00" produces the same advertisement contents as setting "realms=Test:eap-tls". Refer to 802.11-2016, section 9.4.5.10 for full NAI Realm encoding.

W60G Summary General interface properties Scan Monitor Align Sniff Point to Multi Point setup example Point to Point GUI configuration example Troubleshooting and Recommendations Physical Properties Device RF characteristics Regions Connection issues SNMP OIDs for monitoring Configuration Reset For Wireless Wire kits Summary Packages: , system wireless 802.11ad implementation capable of providing Gigabit Ethernet speeds over wireless network. Extend your Gigabit network over a transparent AES encrypted wireless 60GHz link without usual wired or wireless network problems. General interface properties Sub-menu: /interface w60g Property Description arp ( ; disabled | enabled | proxy-arp | reply-only Default: ) enabledRead more >> arp-timeout ( ; Default: ) auto | integer auto ARP timeout is time how long ARP record is kept in ARP table after no packets are received from IP. Value equals to the value of in , default is 30s auto arp-timeout /ip settings comment ( ; Default: ) string Short description of the interface disabled ( ; Default: ) yes | no yes Whether interface is disabled frequency (58320 | 60480 | 62640 | 64800 | 66000 | ; Default: ) auto autoFrequency used in communication (Only active on bridge device) isolate-stations ( ; Default: ) yes | no yes Don't allow communication between connected clients (from RouterOS 6.41) l2mtu ( ; Default: ) integer [0..7882] 1600 Layer2 Maximum transmission unit mac-address ( ; Default: ) MAC MAC address of the radio interface Wireless Wire kit devices comes in pre-configured, connected pairs. Manual configuration is optional

mdmg-fix ( ; Default: ) yes | no no Experimental feature working only on wAP60Gx3 devices, providing better point to multi point stability in some cases mode ( ; ap-bridge | bridge | sniff | station-bridge Default: ) bridgeOperation mode mtu ( ; Default: ) integer [32..8192] 1500 Layer3 Maximum transmission unit name ( ; Default: ) string wlan60-1 Name of the interface password ( ; Default: ) string randomly generated Password used for AES encryption put-stations-in-bridge (; Default: ) Put newly created station device interfaces in this bridge region (asia | australia | canada | china | eu | japan | ; Default: ) no-region-set | usa no-region-setParameter to limit frequency use scan-list ( ; 58320,60480,62640,64800,66000 Default: ) 58320,60480,62640,64800Scan list to limit connectivity over frequencies in station mode ssid ( ; Default: string (0..32 chars) value of System ) IdentitySSID (service set identifier) is a name that identifies wireless network tx-sector ( ; Default: ) integer [0..63] | auto auto Disables beamforming and locks to selected radiation pattern Sub-menu: /interface w60g print stats Provides more detailed information about Beamforming occurrences and some debug information: /interface w60g print stats name: wlan60-1 beamforming-event: 310 tx-io-msdu: 0 tx-sw-msdu: 154 663 tx-fw-msdu: 102 tx-ppdu: 220 147 tx-ppdu-from-q: 40 327 tx-mpdu-new: 154 663 tx-mpdu-total: 184 759 tx-mpdu-retry: 30 096 rx-ppdu: 166 636 rx-mpdu-crc-err: 4 817 rx-mpdu-crc-ok: 285 649 Station interface properties Connected clients are treated as individual interfaces, after successful connection new station interface is created. After update default configuration still works - newly created station interface is moved to default bridge. Sub-menu: /interface w60g station Property Description parent ( ; Default: ) string wlan60-* Parent interface name put-in-bridge ( ; Default: ) none | parent | bridge-name parent Add station device interface to specific bridge remote-address ( ; Default: ) MAC matches bridge interface MAC MAC address of bridge interface, station is connecting to Scan ap-bridge device requires License level 4 to support more than one connected client (click for more information)

And Wireless Wire Dish Hardware wise wAP devices are identical, but there are some software limitations - wAP 60G AP is designed for Access Point usage in PtMP (Point to Multi Point) setups, but can be also used as PtP (Point to Point) or as Station device. It's already equipped with level4 license for more than one connected client support More about Licenses Wireless Wire kit , , and devices comes with level3 license. Wireless wire dish should be only used as Client Wireless Wire Dish SXTsq Lite60 wAP60G device due to it's narrow radiation pattern. License upgrade is needed to unlock more than one simultaneously connected client in Access Point mode, but devices can connect to Access Points as regular Station devices. Minimal configuration for transparent wireless link is matching SSID, correct mode (bridge || station-bridge) and Wireless and Ethernet interfaces put in same bridge. In current example we will look at usage case where is used as Access Point, and devices are used as Station wAP60G AP wAP60G Wireless Wire kit devices, forming 4 unit network. wAP60G AP units come pre-configured with WISP Bridge default configuration SSID and bridge between Wireless and Ethernet interfaces is already configured. It's recommended to set up Wireless password and change SSID. If device has been reset, you can also set correct mode and enable interface. One liner that does all previously mentioned steps: /interface w60g set wlan60-1 password="put_your_safe_password_here" ssid="put_your_new_ssid_here" disabled=no mode=ap-bridge Wireless Wire and wAP60G units come pre-configured with PTP Bridge default configuration. Wireless Wire devices have already randomly generated matching SSID and Wireless password. Bridge device (Bridge or Access point device with one connected client support) needs Wireless mode change to station-bridge. One liner that can be used to set devices in client mode: /interface w60g set wlan60-1 password="put_your_safe_password_here" ssid="put_your_new_ssid_here" disabled=no mode=station-bridge If configuration is done from empty configuration (reset without default configuration) - new bridge needs to be created containing Wireless and Ethernet interfaces and IP address for easy access should be added. Before configuration, make sure devices are running latest software versions: How to upgrade It's recommended to change default IP addresses to avoid connection issues to the devices

For main interfaces: 1.3.6.1.4.1.14988.1.1.1.8.1.2.1 integer Mode 1.3.6.1.4.1.14988.1.1.1.8.1.3.1 string SSID 1.3.6.1.4.1.14988.1.1.1.8.1.4.1 integer Connected status 1.3.6.1.4.1.14988.1.1.1.8.1.5.1 string Remote MAC 1.3.6.1.4.1.14988.1.1.1.8.1.6.1 integer Frequency 1.3.6.1.4.1.14988.1.1.1.8.1.7.1 integer MCS 1.3.6.1.4.1.14988.1.1.1.8.1.8.1 integer Signal quality 1.3.6.1.4.1.14988.1.1.1.8.1.9.1 integer tx-sector 1.3.6.1.4.1.14988.1.1.1.8.1.11.1 string Sector info 1.3.6.1.4.1.14988.1.1.1.8.1.12.1 integer RSSI 1.3.6.1.4.1.14988.1.1.1.8.1.13.1 gauge32 PHY rate station interfaces will be numbered under different table: 1.3.6.1.4.1.14988.1.1.1.9.1.2.(interfaceID) = integer Connected status 1.3.6.1.4.1.14988.1.1.1.9.1.3.(interfaceID) = Hex-STRING mac-address 1.3.6.1.4.1.14988.1.1.1.9.1.4.(interfaceID) = INTEGER: MCS 1.3.6.1.4.1.14988.1.1.1.9.1.5.(interfaceID) = INTEGER: Signal Quality Index 1.3.6.1.4.1.14988.1.1.1.9.1.6.(interfaceID) = INTEGER: tx-sector 1.3.6.1.4.1.14988.1.1.1.9.1.8.(interfaceID) = Gauge32: data-rate [Mbps] 1.3.6.1.4.1.14988.1.1.1.9.1.9.(interfaceID) = INTEGER: RSSI 1.3.6.1.4.1.14988.1.1.1.9.1.10.(interfaceID) = INTEGER: distance [cm] InterfaceID is added from 3 and increases by +1 for each connected station. More information about SNMP functionality and MIB files can be found in SNM P manual Configuration Reset For Wireless Wire kits Reset button has same functionality as on other devices, explained in detail here 5 second button hold on startup (USR LED light starts flashing) - resets to password protected state. 10 second button hold on startup (USR LED turns solid after flashing) - completely removes configuration. After complete removal of configuration, only connection may be established mac-telnet

Distance guide

For Point To Multi Point as device with license level 4 or higher is required.AP Product code License level Link to product description Cube-60ad 3 Cube Lite60 CubeG-5ac60ad 3 Cube 60G ac CubeG-5ac60adpair 3 Wireless Wire Cube LHG-60ad 3 LHG Lite60 LHGG-60ad 3 LHG 60G LHGG-60adkit 3 Wireless Wire Dish nRAYG-60adpair 3 Wireless Wire nRAY wAPG-60ad 3 wAP 60G wAPG-60adkit 3 Wireless Wire wAPG-60ad-A 4 wAP 60G AP wAPG-60ad-SA 4 wAP 60Gx3 AP CubeG-5ac60ay 4 Cube 60Pro ac CubeG-5ac60ay-SA 4 CubeSA 60Pro ac

1. 2. 3. 1. 2. 3. Fail-over PtP GUI example Summary This example shows how to configure automatic fail-over (bonding) 5Ghz link in combination with 60Ghz devices in GUI. When a connection between 60Ghz wireless is lost, it will automatically use the bonded interface. Example is done from empty configuration state with [ ] utility WinBox Connect to the device After configuration reset - only mac-telnet is possible. In main WinBox screen press on Neighbours, choose your devices MAC address and press Connect: Select correct device MAC Address; Login by default is " " and no password is set; admin Press Connect. Configure bridge Add new bridge. Open Bridge sub-menu; Press on "+" to add new bridge; Apply your changes.

1. 2. 3. 4. 5. 6. 7. Later in the instructions it requires to assign bridge members to it. This will allow to pass traffic from Ethernet to W60G interface without routing. Set up 60Ghz wireless connection All previously explained steps are identical to and devices. Different modes needs to be used when configuring wireless interfaces. bridge station Configure device as follows: bridge Open Interface menu; Double click on wlan60-1 interface; Press on Wireless sub-menu and set mode to or for PtmP); bridge ( ap-bridge Set SSID and password and region; Select previously created bridge under "Put Stations In Bridge"; Apply your changes; Press enable to start transmitting.

1. 2. 3. 4. 5. 6. Configure device as follows: station Open Interface menu; Double click on wlan60-1 interface; Press on Wireless sub-menu and set mode to station bridge; Set SSID and password; Apply your changes; Press enable to start transmitting.

1. 2. 3. 4. 5. Set up 5Ghz wireless connection Choose Security Profile for your devices - Choose menu Wireless Choose sub-menu Security Profiles Add new profile with " " sign+ Choose , , and a secure password. name mode authentication type Apply the configuration.

1. 2. 3. 4. 5. For bridge device - Open menu; Interfaces Double click on interface; wlan1 Press on sub-menu and set mode to (or for PtmP); Wireless bridge ap-bridge Set , and SSID password country. Press on Advanced Mode.

1. 2. 3. Choose your ; Security Profile Apply your changes; Press to start transmitting. enable

1. 2. 3. 4. 5. 6. 7. 8. For station device - Open menu; Interfaces Double click on interface; wlan1 Press on sub-menu and set mode to ; Wireless station-bridge Set , and ; SSID password country Press on mode ( similar to bridge device* ); advanced Choose ; Security Profile Apply your changes; Press to start transmitting. enable

1. 2. 3. 4. 5. 6. If everything is done correctly - running (R) flags should appear as shown in the screenshot - Configure bonding Configure bonding and assign slave interfaces in this setup it is selected as built in wlan1 interface, but it can be also ether interface in other kind of setups. For bridge device - Press on sub-menu; Bonding Add new member with " ";+ Add interface members ( and ) to interface as wlan1 wlan60-station-1 bonding Slaves; Add interface member as interface; wlan60-station-1 Primary Choose Mode as ; active backup Apply configuration.

1. 2. 3. 4. 5. 6. For station device - Press on sub-menu; Bonding Add new member with " ";+ Add interface members ( and ) to interface as wlan1 wlan60-1 bonding Slaves; Add interface member as interface; wlan60-1 Primary Choose Mode as ; active backup Apply configuration.

1. 2. 3. 4. Configure bridge Configuring bridge settings including the bonding interface is mandatory for the active-backup to work on used devices ( In this case bridge and station devices settings are the same ). Press on sub-menu; Bridge Add new member with " ";+ Add interface member as and Bridge member as ether1 bridge1; Apply configuration.

1. 2. 3. 4. Press on sub-menu; Bridge Add new member with " ";+ Add interface member as and Bridge member as bonding1 bridge1; Apply configuration.

Additional configuration Interfaces when enabled from greyed out will become active. Link should be established after all previously explained steps are done. It's recommended to set up administrator password on both devices.

1. 2. 3. PtP GUI example Summary This example shows how to configure transparent wireless bridge in GUI from one W60G device to another. Example is done from empty configuration state with [ ] utility WinBox Connect to the device After configuration reset - only mac-telnet is possible. In main WinBox screen press on Neighbours, choose your devices MAC address and press Connect: Configure bridge Add new bridge and assign bridge members to it. This will allow to pass traffic from from Ethernet to W60G interface without routing. Open Bridge sub-menu; Press on "+" to add new bridge; Apply your changes.

1. 2. 3. 4. Add interface members (ether1 and wlan60-1) to newly created bridge. Press on Ports sub-menu; Add new member with "+"; Select correct interfaces; Apply the settings.

1. 2. 3. 4. 5. 6. 7. 1. 2. 3. 4. 5. 6. Set up wireless connection All previously explained steps are identical to and devices. Different modes needs to be used when configuring wireless interfaces. bridge station Configure device as follows: bridge Open Interface menu; Double click on wlan60-1 interface; Press on Wireless sub-menu and set mode to bridge; Set SSID and password and region; Select previously created bridge under "Put Stations In Bridge"; Apply your changes; Press enable to start transmitting. Configure device as follows: station Open Interface menu; Double click on wlan60-1 interface; Press on Wireless sub-menu and set mode to station bridge; Set SSID and password; Apply your changes; Press enable to start transmitting.

Additional configuration Interfaces when enabled from greyed out will become active. Link should be established after all previously explained steps are done. It's recommended to set up administrator password on both devices. To create point to multi-point setup: On bridge device ap-bridge must be set and station-bridge for stations.

CAPsMAN CAPsMAN AAA Settings to configure CAPsMAN AAA functionality are found in menu: the /caps-man aaa Property Description mac-format ( ; Default: string X ) X:XX:XX:XX:XX:XXControls how the MAC address of the client is encoded by Access Point in the User-Name attribute of the MAC authentication and MAC accounting RADIUS requests. mac-mode (as-username | ; as-username-and-password Default: ) as usernameBy default Access Point uses an empty password, when sending Access-Request during MAC authentication. When this property is set to as-username-and-password, Access Point will use the same value for the User-Password attribute as for the User-Name attribute. mac-caching (disabled | time- ; Default: ) interval disabledIf this value is set to a time interval, the Access Point will cache RADIUS MAC authentication responses for a specified time, and will not contact the RADIUS server if matching cache entry already exists. The value disabled will disable the cache, Access Point will always contact the RADIUS server. interim-update (disabled | ; Default: time-interval disabled )When RADIUS accounting is used, Access Point periodically sends accounting information updates to the RADIUS server. This property specifies the default update interval that can be overridden by the RADIUS server using the Acc attribute. t-Interim-Interval called-format (mac | mac: ; Default: ) ssid | ssid mac:ssidFormat of how the "called-id" identifier will be passed to RADIUS. When configuring radius server clients, you can specify "called-id" in order to separate multiple entires. Example Assuming that rest of the settings are already configured and only the "Security" part has been left. Radius authentication with one server 1. Create CAPsMAN security configuration 2. Configure Radius server client 3. Assign the configuration to your master profile (or directly to CAP itself) /caps-man security add authentication-types=wpa2-eap eap-methods=passthrough encryption=aes-ccm group- encryption=aes-ccm name=radius /radius add address=x.x.x.x secret=SecretUserPass service=wireless /caps-man configuration set security=radius Radius authentication with different radius servers for each SSID 1. Create CAPsMAN security configuration 2. Configure AAA settings 3. Configure Radius server clients 4. Assign the configuration to your master profile (or directly to CAP itself) /caps-man security add authentication-types=wpa2-eap eap-methods=passthrough encryption=aes-ccm group- encryption=aes-ccm name=radius /caps-man aaa set called-format=ssid /radius add address=x.x.x.x secret=SecretUserPass service=wireless called-id=SSID1 /radius add address=y.y.y.y secret=SecretUserPass service=wireless called-id=SSID2 /caps-man configuration set security=radius

Now everyone connecting to CAP's with ssid= will have their radius authentication requests sent to and everyone connecting to CAP's with SSID1 x.x.x.x ssid= will have their radius authentication requests sent to SSID2 y.y.y.y CAPsMAN Access-list Access list on CAPsMAN is an ordered list of rules that is used to allow/deny clients to connect to any CAP under CAPsMAN control. When a client attempts to connect to a CAP that is controlled by CAPsMAN, CAP forwards that request to CAPsMAN. As a part of the registration process, CAPsMAN consults an access list to determine if a client should be allowed to connect. The default behavior of the access list is to allow a connection. Access list rules are processed one by one until a matching rule is found. Then the action in the matching rule is executed. If action specifies that the client should be accepted, the client is accepted, potentially overriding its default connection parameters with ones specified in access-list rule. An access list is configured in menu. There are the following parameters for access-list rules: the /caps-man access-list client matching parameters: address - MAC address of the client mask - MAC address mask to apply when comparing client address interface - optional interface to compare with an interface to which client actually connects to time - a time of day and days when rule matches signal-range - range in which client signal must fit for a rule to match allow-signal-out-of-range - an option that permits the client's signal to be out of the range always or for some time interval action parameter - specifies an action to take when client matches: accept - accept client reject - reject client query-radius - query RADIUS server if a particular client is allowed to connect connection parameters: ap-tx-limit - tx speed limit in direction to client client-tx-limit - tx speed limit in direction to AP (applies to RouterOS clients only) client-to-client-forwarding - specifies whether to allow forwarding data received from this client to other clients connected to the same interface private-passphrase - PSK passphrase to use for this client if some PSK authentication algorithm is used radius-accounting - specifies if RADIUS traffic accounting should be used if RADIUS authentication gets done for this client vlan-mode - VLAN tagging mode specifies if traffic coming from a client should get tagged (and untagged when going to a client). vlan-id - VLAN ID to use if doing VLAN tagging. CAPsMAN channel Channel group settings allow for the configuration of lists of radio channel related settings, such as radio band, frequency, Tx Power extension channel, and width. Channel group settings are configured in the Channels profile menu /caps-man channels Property Description band (2ghz-b | 2ghz-b/g | 2ghz-b/g/n | 2ghz- onlyg | 2ghz-onlyn | 5ghz-a | 5ghz-a/n | 5ghz- ; Default: ) onlynDefine operational radio frequency band and mode taken from hardware capability of wireless card comment ( ; Default: ) string Short description of the Channel Group profile extension-channel (Ce | Ceee | eC | eCee | ; Default: ) eeCe | eeeC | disabledExtension channel configuration. (E.g. Ce = extension channel is above Control channel, eC = extension channel is below Control channel) frequency ( ; Default: ) integer [0..4294967295] Channel frequency value in MHz on which AP will operate. name ( ; Default: ) string A descriptive name for the Channel Group Profile tx-power ( ; Default: ) integer [-30..40] TX Power for CAP interface (for the whole interface not for individual chains) in dBm. It is not possible to set higher than allowed by country regulations or interface. By default max allowed by country or interface is used. width (; Default: ) Sets Channel Width in MHz. (E.g. 20, 40)

save-selected (; Default: ) yes Saves selected channel for the CAP Radio - will select this channel after the CAP reconnects to CAPsMAN and use it till the channel Re-optimize is done for this CAP. CAPsMAN configuration Configuration profiles permit pre-defined 'top-level' master settings to be applied to CAP radios being provisioned. Configuration Profiles are configured in menu: /caps-man configuration Property Description channel (; Default: )list User defined list taken from Channel names ( ) /caps-man channels channel.band (2ghz-b | 2ghz-b/g | 2ghz-b/g/n | 2ghz-onlyg | 2ghz-onlyn | 5ghz- ; Default: ) a | 5ghz-a/n | 5ghz-onlyn | 5ghz-a/n/ac | 5ghz-only-acDefines set of used channels. channel.control-channel-width ( ; Default: 40mhz-turbo | 20mhz | 10mhz | 5mhz )Defines set of used channel widths. channel.extension-channel (Ce | Ceee | eC | eCee | eeCe | eeeC | xx | xxxx | ; Default: ) disabledExtension channel configuration. (E.g. Ce = extension channel is above Control channel, eC = extension channel is below Control channel) channel.frequency ( ; Default: ) integer [0..4294967295] Channel frequency value in MHz on which AP will operate. If left blank, CAPsMAN will automatically determine the best frequency that is least occupied. channel.reselect-interval ( ; Default: ) time [00:00:00]; [00:00:00..00:00:00] The interval after which the least occupied frequency is chosen, can be defined as a random interval, ex. as "30m..60m". Works only if ch is left blank. annel.frequency channel.save-selected ( ; Default: ) yes | no no If channel frequency is chosen automatically and channel.reselect- is used, then saves the last picked frequency. interval channel.secondary-frequency ( ; Default: ) integer [0..4294967295] auto Specifies the second frequency that will be used for 80+80MHz configuration. Set it to in order to disable 80+80MHz Disabled capability. channel.skip-dfs-channels ( ; Default: ) yes | no no If is left blank, the selection will skip DFS channel.frequency channels channel.tx-power ( ; Default: ) integer [-30..40] TX Power for CAP interface (for the whole interface not for individual chains) in dBm. It is not possible to set higher than allowed by country regulations or interface. By default max allowed by country or interface is used. channel.width (; Default: ) Sets Channel Width in MHz. comment ( ; Default: ) string Short description of the Configuration profile country ( ; Default: ) name of the country | no_country_set no_country_set Limits available bands, frequencies and maximum transmit power for each frequency. Also specifies default value of . Value scan-list n is an FCC compliant set of channels. o_country_set datapath (; Default: )list User defined list taken from Datapath names ( ) /caps-man datapath datapath.bridge (; Default: )list Bridge to which particular interface should be automatically added as port. Required only when local-forwarding is not used. datapath.bridge-cost ( ; Default: ) integer [1.. ] 200000000 bridge port cost to use when adding as bridge port datapath.bridge-horizon ( ; Default: ) integer [0..4294967295] bridge horizon to use when adding as bridge port

datapath.client-to-client-forwarding ( ; Default: ) yes | no no controls if client-to-client forwarding between wireless clients connected to interface should be allowed, in local forwarding mode this function is performed by CAP, otherwise it is performed by CAPsMAN datapath.interface-list (; Default: ) datapath.l2mtu (; Default: ) set Layer2 MTU size datapath.local-forwarding ( ; Default: ) yes | no no Controls forwarding mode. If disabled, all L2 and L3 data will be forwarded to CAPsMAN, and further forwarding decisions will be made only then. , if disabled, make sure that each CAP interface MAC Address Note that participates in the same broadcast domain is unique (including local MAC's, like Bridge-MAC). datapath.mtu (; Default: ) set MTU size datapath.openflow-switch (; Default: ) OpenFlow switch port (when enabled) to add interface to datapath.vlan-id ( ; Default: ) integer [1..4095] VLAN ID to assign to interface if vlan-mode enables use of VLAN tagging datapath.vlan-mode ( ; Default: ) use-service-tag | use-tag Enables and specifies the type of VLAN tag to be assigned to the interface (causes all received data to get tagged with VLAN tag and allows the interface to only send out data tagged with given tag) disconnect-timeout (; Default: ) distance (; Default: ) frame-lifetime (; Default: ) guard-interval ( ; Default: ) any | long any Whether to allow the use of short guard interval (refer to 802.11n MCS specification to see how this may affect throughput). "any" will use either short or long, depending on data rate, "long" will use long only. hide-ssid ( ; Default: ) yes | no yes - AP does not include SSID in the beacon frames and does not reply to probe requests that have broadcast SSID. no - AP includes SSID in the beacon frames and replies to probe requests that have broadcast SSID. This property has effect only in AP mode. Setting it to can yes remove this network from the list of wireless networks that are shown by some client software. Changing this setting does not improve the security of the wireless network, because SSID is included in other frames sent by the AP. hw-protection-mode (; Default: ) hw-retries (; Default: ) installation ( ; Default: ) any | indoor | outdoor any keepalive-frames ( ; Default: ) enabled | disabled enabled load-balancing-group ( ; Default: ) string Tags the interface to the load balancing group. For a client to connect to interface in this group, the interface should have the same number of already connected clients as all other interfaces in the group or smaller. Useful in setups where ranges of CAPs mostly overlap. max-sta-count ( ; Default: ) integer [1..2007] Maximum number of associated clients. mode (; Default: ) ap Set operational mode. Only ap currently supported.

multicast-helper ( ; Default: ) default | disabled | full default When set to full multicast packets will be sent with unicast destination MAC address, resolving on a wireless multicast problem link. This option should be enabled only on the access point, clients should be configured in mode. Available starting from station-bridge v5.15. disabled - disables the helper and sends multicast packets with multicast destination MAC addresses full - all multicast packet mac address are changed to unicast mac addresses prior sending them out default - default choice that currently is set to . Value disabled can be changed in future releases. name ( ; Default: ) string Descriptive name for the Configuration Profile rates (; Default: ) User defined list taken from Rates names ( ) /caps-man rates rates.basic (1Mbps | 2Mbps | 5.5Mbps | 6Mbps | 11Mbps | 11Mbps | 12Mbps | ; Default: ) 18Mbps | 24Mbps | 36Mbps | 48Mbps | 54Mbps rates.supported (1Mbps | 2Mbps | 5.5Mbps | 6Mbps | 11Mbps | 11Mbps | ; Default: ) 12Mbps | 18Mbps | 24Mbps | 36Mbps | 48Mbps | 54Mbps rates.ht-basic-mcs (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs-6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs-15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs-20 | mcs-21 | mcs-22 | ; Default: ) mcs-23) mcs-0; mcs-1; mcs-2; mcs-3; mcs-4; mcs-5; mcs-6; mcs-7Modulation and Coding Schemes that every connecting client must support. Refer to 802.11n for MCS specification. rates.ht-supported-mcs (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs-6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs-15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs-20 | mcs-21 | mcs-22 | ; Default: mcs-23) mcs-0; mcs-1; mcs-2; mcs-3; mcs-4; mcs-5; mcs-6; mcs-7; mcs-8; mcs-9; mcs-10; mcs-11; mcs-12; mcs-13; mcs-14; mcs-15; mcs-16; ) mcs-17; mcs-18; mcs-19; mcs-20; mcs-21; mcs-22; mcs-23Modulation and Coding Schemes that this device advertises as supported. Refer to 802.11n for MCS specification. rates.vht-basic-mcs ( ; Default: ) none | MCS 0-7 | MCS 0-8 | MCS 0-9 none Modulation and Coding Schemes that every connecting client must support. Refer to 802.11ac for MCS specification. You can set MCS interval for each of Spatial Stream none - will not use selected Spatial Stream MCS 0-7 - client must support MCS-0 to MCS-7 MCS 0-8 - client must support MCS-0 to MCS-8 MCS 0-9 - client must support MCS-0 to MCS-9 rates.vht-supported-mcs ( ; Default: ) none | MCS 0-7 | MCS 0-8 | MCS 0-9 none Modulation and Coding Schemes that this device advertises as supported. Refer to 802.11ac for MCS specification. You can set MCS interval for each of Spatial Stream none - will not use selected Spatial Stream MCS 0-7 - devices will advertise as supported MCS-0 to MCS-7 MCS 0-8 - devices will advertise as supported MCS-0 to MCS-8 MCS 0-9 - devices will advertise as supported MCS-0 to MCS-9 rx-chains ( ; Default: ) list of integer [0..3] 0 Which antennas to use for receive. security ( ; Default: ) string none Name of security configuration from /caps-man security security.authentication-types ( ; Default: ) list of string none Specify the type of Authentication from , , wpa-psk wpa2-psk wpa-eap or wpa2-eap security.disable-pmkid (; Default: )

security.eap-methods ( ; Default: ) eap-tls | passthrough none eap-tls - Use built-in EAP TLS authentication. passthrough - Access point will relay authentication process to the RADIUS server. security.eap-radius-accounting (; Default: ) specifies if RADIUS traffic accounting should be used if RADIUS authentication gets done for this client security.encryption ( ; Default: ) aes-ccm | tkip Set type of unicast encryption algorithm used security.group-encryption ( ; Default: ) aes-ccm | tkip aes-ccm Access Point advertises one of these ciphers, multiple values can be selected. Access Point uses it to encrypt all broadcast and multicast frames. Client attempts connection only to Access Points that use one of the specified group ciphers. tkip- Temporal Key Integrity Protocol - encryption protocol, compatible with legacy WEP equipment, but enhanced to correct some of the WEP flaws. aes-ccm - more secure WPA encryption protocol, based on the reliable AES (Advanced Encryption Standard). Networks free of WEP legacy should use only this cipher. security.group-key-update ( ; Default: ) time: 30s..1h 5m Controls how often Access Point updates the group key. This key is used to encrypt all broadcast and multicast frames. property only has effect for Access Points. security.passphrase ( ; Default: ) string WPA or WPA2 pre-shared key security.tls-certificate ( ; Default: ) none | name Access Point always needs a certificate when is security.tls-mode set to value other than . no-certificates security.tls-mode (verify-certificate | dont-verify-certificate | no-certificates | ; Default: ) verify-certificate-with-crlThis property has effect only when contains security.eap-methods e . ap-tls verify-certificate - Require remote device to have valid certificate. Check that it is signed by known certificate authority. No additional identity verification is done. Certificate may include information about time period during which it is valid. If router has incorrect time and date, it may reject valid certificate because router's clock is outside that period. See also the configuration. Certificates dont-verify-certificate - Do not check certificate of the remote device. Access Point will not require client to provide certificate. no-certificates - Do not use certificates. TLS session is established using 2048 bit anonymous Diffie-Hellman key exchange. verify-certificate-with-crl - Same as verify-certificate but also checks if the certificate is valid by checking the Certificate Revocation List. ssid ( ; Default: ) string (0..32 chars) SSID (service set identifier) is a name broadcast in the beacons that identifies wireless network. tx-chains ( ; Default: ) list of integer [0..3] 0 Which antennas to use for transmit. CAPsMAN datapath Datapath settings control data forwarding related aspects. On CAPsMAN datapath settings are configured in the datapath profile menu /caps-man datapath or directly in a configuration profile or interface menu as settings with prefix. datapath. There are 2 major forwarding modes: local forwarding mode, where CAP is locally forwarding data to and from wireless interface

manager forwarding mode, where CAP sends to CAPsMAN all data received over wireless and only sends out the wireless data received from CAPsMAN. In this mode, even client-to-client forwarding is controlled and performed by CAPsMAN. Forwarding mode is configured on a per-interface basis - so if one CAP provides 2 radio interfaces, one can be configured to operate in local forwarding mode and the other in manager forwarding mode. The same applies to Virtual-AP interfaces - each can have different forwarding mode from master interface or other Virtual-AP interfaces. Most of the datapath settings are used only when in manager forwarding mode, because in local forwarding mode CAPsMAN does not have control over data forwarding. There are the following datapath settings: bridge -- bridge interface to add interface to, as a bridge port, when enabled bridge-cost -- bridge port cost to use when adding as bridge port bridge-horizon -- bridge horizon to use when adding as bridge port client-to-client-forwarding -- controls if client-to-client forwarding between wireless clients connected to interface should be allowed, in local forwarding mode this function is performed by CAP, otherwise it is performed by CAPsMAN. local-forwarding -- controls forwarding mode openflow-switch -- OpenFlow switch to add interface to, as port when enabled vlan-id -- VLAN ID to assign to interface if vlan-mode enables use of VLAN tagging vlan-mode -- VLAN tagging mode specifies if VLAN tag should be assigned to interface (causes all received data to get tagged with VLAN tag and allows interface to only send out data tagged with given tag) CAPsMAN interface CAPsMAN interfaces are managed in menu: /caps-man interface [admin@CM] > /caps-man interface print Flags: M - master, D - dynamic, B - bound, X - disabled, I - inactive, R - running # NAME RADIO-MAC MASTER-INTERFACE 0 M BR cap2 00:0C:42:1B:4E:F5 none 1 B cap3 00:00:00:00:00:00 cap2 CAPsMAN manager Property Description enabled ( ; Default: ) yes | no no Disable or enable CAPsMAN functionality certificate (auto | certificate ; Default: ) name | none noneDevice certificate ca-certificate (auto | certificate ; Default: ) name | none noneDevice CA certificate require-peer-certificate ( ; yes | no Default: )noRequire all connecting CAPs to have a valid certificate package-path ( ; Default: ) string | Folder location for the RouterOS packages. For example, use "/upgrade" to specify the upgrade folder from the files section. If empty string is set, CAPsMAN can use built-in RouterOS packages, note that in this case only CAPs with the same architecture as CAPsMAN will be upgraded. upgrade-policy (none | require- same-version | suggest-same- ; Default: ) upgrade noneUpgrade policy options none - do not perform upgrade require-same-version - CAPsMAN suggest to upgrade the CAP RouterOS version and if it fails it will not provision the CAP. (Manual provision is still possible) suggest-same-version - CAPsMAN suggests to upgrade the CAP RouterOS version and if it fails it will still be provisioned

CAPsMAN provisioning CAPsMAN distinguishes between CAPs based on a common-name identifier. The identifier is generated based on the following rules: if CAP provided a certificate, the identifier is set to the Common Name field in the certificate otherwise, an identifier is based on Base-MAC provided by CAP in the form: '[XX:XX:XX:XX:XX:XX]'. When the DTLS connection with CAP is successfully established (which means that CAP identifier is known and valid), CAPsMAN makes sure there is no stale connection with CAP using the same identifier. Currently connected CAPs are listed in menu: /caps-man remote-cap [admin@CM] /caps-man> remote-cap print # ADDRESS IDENT STATE RADIOS 0 00:0C:42:00:C0:32/27044 MT-000C4200C032 Run 1 CAPsMAN distinguishes between actual wireless interfaces (radios) based on their built-in MAC address (radio-mac). This implies that it is impossible to manage two radios with the same MAC address on one CAPsMAN. Radios currently managed by CAPsMAN (provided by connected CAPs) are listed in /c menu: aps-man radio [admin@CM] /caps-man> radio print Flags: L - local, P - provisioned # RADIO-MAC INTERFACE REMOTE-AP-IDENT 0 P 00:03:7F:48:CC:07 cap1 MT-000C4200C032 When CAP connects, CAPsMAN at first tries to bind each CAP radio to CAPsMAN master interface based on radio-mac. If an appropriate interface is found, radio gets set up using master interface configuration and configuration of slave interfaces that refer to a particular master interface. At this moment interfaces (both master and slaves) are considered bound to radio and radio is considered provisioned. If no matching master interface for radio is found, CAPsMAN executes 'provisioning rules'. Provisioning rules is an ordered list of rules that contain settings that specify which radio to match and settings that specify what action to take if a radio matches. Provisioning rules for matching radios are configured in menu: /caps-man provisioning Property Description action (create-disabled | create-enabled | ; Default: ) create-dynamic-enabled | none noneAction to take if rule matches are specified by the following settings: create-disabled - create disabled static interfaces for radio. I.e., the interfaces will be bound to the radio, but the radio will not be operational until the interface is manually enabled; create-enabled - create enabled static interfaces. I.e., the interfaces will be bound to the radio and the radio will be operational; create-dynamic-enabled - create enabled dynamic interfaces. I.e., the interfaces will be bound to the radio, and the radio will be operational; none - do nothing, leaves radio in the non-provisioned state; comment ( ; Default: ) string Short description of the Provisioning rule common-name-regexp ( ; Default: ) string Regular expression to match radios by common name. Each CAP's common name identifier can be found under "/caps-man radio" as value "REMOTE-CAP-NAME" hw-supported-modes (a|a-turbo|ac|an|b|g|g- ; Default: ) turbo|gnMatch radios by supported wireless modes identity-regexp ( ; Default: ) string Regular expression to match radios by router identity ip-address-ranges (IpAddressRange[, ; Default: ) IpAddressRanges] max 100x ""Match CAPs with IPs within configured address range. master-configuration ( ; Default: ) string If specifies to create interfaces, then a new master interface with its configuration set to this action configuration profile will be created

name-format (cap | identity | prefix | prefix- ; Default: ) identity capspecify the syntax of the CAP interface name creation cap - default name identity - CAP boards system identity name prefix - name from the name-prefix value prefix-identity - name from the name-prefix value and the CAP boards system identity name name-prefix ( ; Default: ) string name prefix which can be used in the name-format for creating the CAP interface names radio-mac ( ; Default: MAC address 00:00:00:00: ) 00:00MAC address of radio to be matched, empty MAC (00:00:00:00:00:00) means match all MAC addresses slave-configurations ( ; Default: ) string If specifies to create interfaces, then a new slave interface for each configuration profile in action this list is created. To get the active provisioning matchers: [admin@CM] /caps-man provisioning> print Flags: X - disabled 0 radio-mac=00:00:00:00:00:00 action=create-enabled master-configuration=main-cfg slave-configurations=virtual-ap-cfg name-prefix="" For the user's convenience there are commands that allow the re-execution of the provisioning process for some radio or all radios provided by some AP: [admin@CM] > caps-man radio provision 0 and [admin@CM] > caps-man remote-cap provision 0 CAPsMAN radio see / caps-man provisioning CAPsMAN rates see / caps-man configuration CAPsMAN registration-table Registration table contains a list of clients that are connected to radios controlled by CAPsMAN and is available in menu: /caps-man registration-table [admin@CM] /caps-man> registration-table print # INTERFACE MAC-ADDRESS UPTIME RX-SIGNAL 0 cap1 00:03:7F:48:CC:0B 1h38m9s210ms -36 CAPsMAN remote-cap see / caps-man provisioning CAPsMAN security If no rule matches radio, then implicit default rule with action and no configurations set is executed. create-enabled

Example Assuming that rest of the settings are already configured and only the "Security" part has been left. Radius authentication with one server 1. Create CAPsMAN security configuration 2. Configure Radius server client 3. Assign the configuration to your master profile (or directly to CAP itself) /caps-man security add authentication-types=wpa2-eap eap-methods=passthrough encryption=aes-ccm group- encryption=aes-ccm name=radius /radius add address=x.x.x.x secret=SecretUserPass service=wireless /caps-man configuration set security=radius Radius authentication with different radius servers for each SSID 1. Create CAPsMAN security configuration 2. Configure AAA settings 3. Configure Radius server clients 4. Assign the configuration to your master profile (or directly to CAP itself) /caps-man security add authentication-types=wpa2-eap eap-methods=passthrough encryption=aes-ccm group- encryption=aes-ccm name=radius /caps-man aaa set called-format=ssid /radius add address=x.x.x.x secret=SecretUserPass service=wireless called-id=SSID1 /radius add address=y.y.y.y secret=SecretUserPass service=wireless called-id=SSID2 /caps-man configuration set security=radius Now everyone connecting to CAP's with ssid= will have their radius authentication requests sent to and everyone connecting to CAP's with SSID1 x.x.x.x ssid= will have their radius authentication requests sent to SSID2 y.y.y.y

1. add new configuration profile 2.

3. Then create a new "Provisioning" rule, which will assign the created configuration template to the CAP devices: 4. All that remains to do on the CAPsMAN, is to enable it:

only Manager is configured with certificate - CAP checks CAPsMAN certificate, but does not fail if it does not have appropriate trusted CA certificate, CAPsMAN must be configured with in order to establish connection with CAP that does not possess require-peer-certificate=no certificate CAP and CAPsMAN are configured with certificates - mutual authentication After DTLS connection is established, CAP can optionally check CommonName field of certificate provided by CAPsMAN. caps-man-certificate-common- parameter contains list of allowed CommonName values. If this list is not empty, CAPsMAN must be configured with certificate. If this list is empty, names CAP does not check CommonName field. If the CAPsMAN or CAP gets disconnected from the network, the loss of connection between CAP and CAPsMAN will be detected in approximately 10-20 seconds. CAP Auto Locking to CAPsMAN CAP can be configured to automatically lock to a particular CAPsMAN server. Locking is implemented by recording certificate CommonName of CAPsMAN that CAP is locked to and checking this CommonName for all subsequent connections. As this feature is implemented using certificate CommonName, use of certificates is mandatory for locking to work. Locking is enabled by the following command: [admin@CAP] > /interface wireless cap set lock-to-caps-man=yes Once CAP connects to suitable CAPsMAN and locks to it, it is reflected like this: [admin@wtp] > /interface wireless cap print ... locked-caps-man-common-name: CAPsMAN-000C424C30F3 From now on CAP will only connect to CAPsMAN with this CommonName, until locking requirement is cleared, by setting . This lock-to-caps-man=no approach needs to be used if it is necessary to force CAP to lock to another CAPsMAN - by at first setting followed by lock-to-caps-man=no lock-to-caps- . man=yes Note that CAP can be manually "locked" to CAPsMAN by setting . caps-man-certificate-common-names Auto Certificates To simplify CAPsMAN and CAP configuration when certificates are required (e.g. for automatic locking feature), CAPsMAN can be configured to generate necessary certificates automatically and CAP can be configured to request certificate from CAPsMAN. Automatic certificates do not provide full public key infrastructure and are provided for simple setups. If more complicated PKI is necessary - supporting proper certificate validity periods, multiple-level CA certificates, certificate renewal - other means must be used, such as manual certificate distribution or SCEP. CAPsMAN has the following certificate settings: certificate - this is CAPsMAN certificate, private key must be available for this certificate. If set to , CAPsMAN will operate in no-certificate none mode and none of certificate requiring features will work. If set to , CAPsMAN will attempt to issue certificate to itself using CA certificate (see auto description). Note that CommonName automatically issued certificate will be "CAPsMAN-<mac address>" and validity period for will ca-certificate be the same as for CA certificate. ca-certificate - this is CA certificate that CAPsMAN will use when issuing certificate for itself if necessary (see description) and when certificate signing certificate requests from CAPs. If set to , CAPsMAN will not be able to issue certificate to itself or sign certificate requests from none CAPs. If set to , CAPsMAN will generate self-signed CA certificate to use as CA certificate. CommonName for this certificate will take form auto "CAPsMAN-CA-<mac address>" and validity period will be from jan/01/1970 until jan/18/2038. When CAPsMAN will auto-generate certificates, this will be reflected like this: [admin@CM] /caps-man manager> pr enabled: yes certificate: auto ca-certificate: auto require-peer-certificate: no generated-certificate: CAPsMAN-000C424C30F3 generated-ca-certificate: CAPsMAN-CA-000C424C30F3 And certificates:

[admin@CM] /certificate> print detail Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted 0 K A T name="CAPsMAN-CA-000C424C30F3" common-name="CAPsMAN-CA-000C424C30F3" key-size=2048 days-valid=24854 trusted=yes key-usage=digital-signature,key-encipherment,data-encipherment,key-cert-sign,crl-sign serial-number="1" fingerprint="69d77bbb45c50afd2d6c1785c2a3d72596b8a5f6" invalid-before=jan/01/1970 00:00:01 invalid-after=jan/18/2038 03:14:07 1 K I name="CAPsMAN-000C424C30F3" common-name="CAPsMAN-000C424C30F3" key-size=2048 days-valid=24854 trusted=no key-usage=digital-signature,key-encipherment ca=CAPsMAN-CA-000C424C30F3 serial-number="1" fingerprint="e853ddb9d41fc139083a176ab164331bc24bc5ed" invalid-before=jan/01/1970 00:00:01 invalid-after=jan/18/2038 03:14:07 CAP can be configured to request certificate from CAPsMAN. In order for this to work, CAP must be configured with setting and certificate=request CAPsMAN must have CA certificate available (either specified in setting or auto-generated). ca-certificate CAP will initially generate private key and certificate request with CommonName of form "CAP-<mac address>". When CAP will establish connection with CAPsMAN, CAP will request CAPsMAN to sign its certificate request. If this will succeed, CAPsMAN will send CA certificate and newly issued certificate to CAP. CAP will import these certificates in its certificate store: [admin@CAP] > /interface wireless cap print ... requested-certificate: cert_2 locked-caps-man-common-name: CAPsMAN-000C424C30F3 [admin@CAP] > /certificate print detail Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted 0 T name="cert_1" issuer=CN=CAPsMAN-CA-000C424C30F3 common-name="CAPsMAN-CA-000C424C30F3" key-size=2048 days-valid=24837 trusted=yes key-usage=digital-signature,key-encipherment,data-encipherment,key-cert-sign,crl-sign serial-number="1" fingerprint="69d77bbb45c50afd2d6c1785c2a3d72596b8a5f6" invalid-before=jan/01/1970 00:00:01 invalid-after=jan/01/2038 03:14:07 1 K T name="cert_2" issuer=CN=CAPsMAN-CA-000C424C30F3 common-name="CAP-000C4200C032" key-size=2048 days-valid=24837 trusted=yes key-usage=digital-signature,key-encipherment serial-number="2" fingerprint="2c85bf2fbc9fc0832e47cd2773a6f4b6af35ef65" invalid-before=jan/01/1970 00:00:01 invalid-after=jan/01/2038 03:14:07 On subsequent connections to CAPsMAN, CAP will use generated certificate. CAP Configuration When an AP is configured to be controlled by CAPsMAN, configuration of the managed wireless interfaces on the AP is ignored (exceptions: antenna-gain, . Instead, AP accepts configuration for the managed interfaces from CAPsMAN. antenna-mode) CAP behavior of AP is configured in menu. From there you can: /interface wireless cap Disable or enable CAP feature on the device Set list of wireless interfaces to be controlled by Manager Set list of interfaces over which CAP should attempt to discover Manager Set list of Manager IP addresses that CAP will attempt to contact during discovery Set list of Manager names that CAP will attempt to connect Set list of Manager certificate CommonNames that CAP will connect to Set bridge to which interfaces should be added when local forwarding mode is used Each wireless interface on a CAP that is under CAPsMAN control appears as a virtual interface on the CAPsMAN. This provides maximum flexibility in data forwarding control using regular RouterOS features, such as routing, bridging, firewall, etc.CAPsMAN Configuration Concepts The CAP wireless interfaces that are managed by CAPsMAN and whose traffic is being forwarded to CAPsMAN (ie. they are not in local mode), are shown as , with the note . Those interfaces that are in mode (traffic is forwarding disabled Managed by CAPsMAN local forwarding locally managed by CAP, and only management is done by CAPsMAN) are not shown disabled, but the note is shown Managed by CAPsMAN

Many wireless interface settings are able to be grouped together into named groups ('profiles') that simplifies the reuse of configuration - for example, common configuration settings can be configured in a 'configuration profile' and multiple interfaces can then refer to that profile. At the same time any profile setting can be overridden directly in an interface configuration for maximum flexibility. Currently there are the following setting groups: channel - channel related settings, such as frequency and width datapath - data forwarding related settings, such as bridge to which particular interface should be automatically added as port security - security related settings, such as allowed authentication types or passphrase configuration - main wireless settings group, includes settings such as SSID, and additionally binds together other setting groups - that is, configuration profile can refer to channel, security, etc. named setting groups. Additionally any setting can be overridden directly in configuration profile. Interface settings bind together all setting groups, but additionally any setting can be overridden directly in interface settings. By means of setting groups, configuration is organized in hierarchical structure with interface (actual user of configuration) as the root. In order to figure out the effective value of some setting this structure is consulted in a fashion where a higher level setting value overrides a lower level value. For example, when WPA2 passphrase to be used by a particular interface needs to be found, the following places are consulted and the first place with WPA2 passphrase configured specifies effective passphrase. "->" denotes referring to setting profile (if configured): interface passphrase interface->security passphrase interface->configuration passphrase interface->configuration->security passphrase There are 2 types of interfaces on CAPsMAN - "master" and "slave". The master interface holds the configuration for an actual wireless interface (radio), while a slave interface links to the master interface and is intended to hold the configuration for a Virtual-AP (multiple SSID support). There are settings that are meaningful only for master interface, i.e. mainly hardware setup related settings such as radio channel settings. Note that in order for a radio to accept clients, it's master interface needs to be enabled. Slave interfaces will become operational only if enabled and the master interface is enabled. Interfaces on CAPsMAN can be static or dynamic. Static interfaces are stored in RouterOS configuration and will persist across reboots. Dynamic interfaces exist only while a particular CAP is connected to CAPsMAN. CAPsMAN Global Configuration Settings to enable CAPsMAN functionality are found in menu: /caps-man manager Property Description enabled ( ; Default: ) yes | no no Disable or enable CAPsMAN functionality certificate (auto | certificate ; Default: ) name | none noneDevice certificate ca-certificate (auto | certificate ; Default: ) name | none noneDevice CA certificate require-peer-certificate ( ; yes | no Default: )noRequire all connecting CAPs to have a valid certificate package-path ( ; Default: ) string | Folder location for the RouterOS packages. For example, use "/upgrade" to specify the upgrade folder from the files section. If empty string is set, CAPsMAN can use built-in RouterOS packages, note that in this case only CAPs with the same architecture as CAPsMAN will be upgraded. upgrade-policy (none | require- same-version | suggest-same- ; Default: ) upgrade noneUpgrade policy options none - do not perform upgrade require-same-version - CAPsMAN suggest to upgrade the CAP RouterOS version and if it fails it will not provision the CAP. (Manual provision is still possible) suggest-same-version - CAPsMAN suggests to upgrade the CAP RouterOS version and if it fails it will still be provisioned Radio Provisioning

CAPsMAN distinguishes between CAPs based on an identifier. The identifier is generated based on the following rules: if CAP provided a certificate, identifier is set to the Common Name field in the certificate otherwise identifier is based on Base-MAC provided by CAP in the form: '[XX:XX:XX:XX:XX:XX]'. When the DTLS connection with CAP is successfully established (which means that CAP identifier is known and valid), CAPsMAN makes sure there is no stale connection with CAP using the same identifier. Currently connected CAPs are listed in menu: /caps-man remote-cap [admin@CM] /caps-man> remote-cap print # ADDRESS IDENT STATE RADIOS 0 00:0C:42:00:C0:32/27044 MT-000C4200C032 Run 1 CAPsMAN distinguishes between actual wireless interfaces (radios) based on their builtin MAC address (radio-mac). This implies that it is impossible to manage two radios with the same MAC address on one CAPsMAN. Radios currently managed by CAPsMAN (provided by connected CAPs) are listed in /c menu: aps-man radio [admin@CM] /caps-man> radio print Flags: L - local, P - provisioned # RADIO-MAC INTERFACE REMOTE-AP-IDENT 0 P 00:03:7F:48:CC:07 cap1 MT-000C4200C032 When CAP connects, CAPsMAN at first tries to bind each CAP radio to CAPsMAN master interface based on radio-mac. If an appropriate interface is found, radio gets set up using master interface configuration and configuration of slave interfaces that refer to particular master interface. At this moment interfaces (both master and slaves) are considered bound to radio and radio is considered provisioned. If no matching master interface for radio is found, CAPsMAN executes 'provisioning rules'. Provisioning rules is an ordered list of rules that contain settings that specify which radio to match and settings that specify what action to take if a radio matches. Provisioning rules for matching radios are configured in menu: /caps-man provisioning Property Description action (create-disabled | create-enabled | ; Default: ) create-dynamic-enabled | none noneAction to take if rule matches are specified by the following settings: create-disabled - create disabled static interfaces for radio. I.e., the interfaces will be bound to the radio, but the radio will not be operational until the interface is manually enabled; create-enabled - create enabled static interfaces. I.e., the interfaces will be bound to the radio and the radio will be operational; create-dynamic-enabled - create enabled dynamic interfaces. I.e., the interfaces will be bound to the radio, and the radio will be operational; none - do nothing, leaves radio in non-provisioned state; comment ( ; Default: ) string Short description of the Provisioning rule common-name-regexp ( ; Default: ) string Regular expression to match radios by common name hw-supported-modes (a|a-turbo|ac|an|b|g|g- ; Default: ) turbo|gnMatch radios by supported wireless modes identity-regexp ( ; Default: ) string Regular expression to match radios by router identity ip-address-ranges (IpAddressRange[, ; Default: ) IpAddressRanges] max 100x ""Match CAPs with IPs within configured address range. master-configuration ( ; Default: ) string If specifies to create interfaces, then a new master interface with its configuration set to this action configuration profile will be created name-format (cap | identity | prefix | prefix- ; Default: ) identity capspecify the syntax of the CAP interface name creation cap - default name identity - CAP boards system identity name prefix - name from the name-prefix value prefix-identity - name from the name-prefix value and the CAP boards system identity name name-prefix ( ; Default: ) string name prefix which can be used in the name-format for creating the CAP interface names

radio-mac ( ; Default: MAC address 00:00:00:00: ) 00:00MAC address of radio to be matched, empty MAC (00:00:00:00:00:00) means match all MAC addresses slave-configurations ( ; Default: ) string If specifies to create interfaces, then a new slave interface for each configuration profile in this action list is created. To get the active provisioning matchers: [admin@CM] /caps-man provisioning> print Flags: X - disabled 0 radio-mac=00:00:00:00:00:00 action=create-enabled master-configuration=main-cfg slave-configurations=virtual-ap-cfg name-prefix="" For user's convenience there are commands that allow the re-execution of the provisioning process for some radio or all radios provided by some AP: [admin@CM] > caps-man radio provision 0 and [admin@CM] > caps-man remote-cap provision 0 Interface Configuration CAPsMAN interfaces are managed in menu: /caps-man interface [admin@CM] > /caps-man interface print Flags: M - master, D - dynamic, B - bound, X - disabled, I - inactive, R - running # NAME RADIO-MAC MASTER-INTERFACE 0 M BR cap2 00:0C:42:1B:4E:F5 none 1 B cap3 00:00:00:00:00:00 cap2 Master Configuration Profiles Configuration profiles permit pre-defined 'top level' master settings to be applied to CAP radios being provisioned. Configuration Profiles are configured in menu: /caps-man configuration Property Description channel (; Default: )list User defined list taken from Channel names ( ) /caps-man channels channel.band (2ghz-b | 2ghz-b/g | 2ghz-b/g/n | 2ghz-onlyg | 2ghz-onlyn | 5ghz- ; Default: ) a | 5ghz-a/n | 5ghz-onlyn | 5ghz-a/n/ac | 5ghz-only-acDefines set of used channels. channel.control-channel-width ( ; Default: ) 40mhz-turbo | 20mhz | 10mhz | 5mhz Defines set of used channel widths. channel.extension-channel (Ce | Ceee | eC | eCee | eeCe | eeeC | xx | xxxx | ; Default: ) disabledExtension channel configuration. (E.g. Ce = extension channel is above Control channel, eC = extension channel is below Control channel) channel.frequency ( ; Default: ) integer [0..4294967295] Channel frequency value in MHz on which AP will operate. If left blank, CAPsMAN will automatically determine the best frequency that is least occupied. channel.reselect-interval ( ; Default: ) time [00:00:00] [00:00:00..00:00:00]; The interval after which the least occupied frequency is chosen, can be defined as a random interval, ex. as "30m..60m". Works only if cha is left blank. nnel.frequency channel.save-selected ( ; Default: ) yes | no no If channel frequency is chosen automatically and channel.reselect- is used, then saves the last picked frequency. interval channel.secondary-frequency ( ; Default: ) integer [0..4294967295] auto Specifies the second frequency that will be used for 80+80MHz configuration. Set it to in order to disable 80+80MHz Disabled capability. If no rule matches radio, then implicit default rule with action and no configurations set is executed. create-enabled

channel.skip-dfs-channels ( ; Default: ) yes | no no If is left blank, the selection will skip DFS channels channel.frequency channel.tx-power ( ; Default: ) integer [-30..40] TX Power for CAP interface (for the whole interface not for individual chains) in dBm. It is not possible to set higher than allowed by country regulations or interface. By default max allowed by country or interface is used. channel.width (; Default: ) Sets Channel Width in MHz. comment ( ; Default: ) string Short description of the Configuration profile country ( ; Default: ) name of the country | no_country_set no_country_set Limits available bands, frequencies and maximum transmit power for each frequency. Also specifies default value of . Value scan-list no_co is an FCC compliant set of channels. untry_set datapath (; Default: )list User defined list taken from Datapath names ( ) /caps-man datapath datapath.bridge (; Default: )list Bridge to which particular interface should be automatically added as port datapath.bridge-cost ( ; Default: ) integer [1.. ] 200000000 bridge port cost to use when adding as bridge port datapath.bridge-horizon ( ; Default: ) integer [0..4294967295] bridge horizon to use when adding as bridge port datapath.client-to-client-forwarding ( ; Default: ) yes | no no controls if client-to-client forwarding between wireless clients connected to interface should be allowed, in local forwarding mode this function is performed by CAP, otherwise it is performed by CAPsMAN datapath.interface-list (; Default: ) datapath.l2mtu (; Default: ) set Layer2 MTU size datapath.local-forwarding ( ; Default: ) yes | no no controls forwarding mode datapath.mtu (; Default: ) set MTU size datapath.openflow-switch (; Default: ) OpenFlow switch port (when enabled) to add interface to datapath.vlan-id ( ; Default: ) integer [1..4095] VLAN ID to assign to interface if vlan-mode enables use of VLAN tagging datapath.vlan-mode ( ; Default: ) use-service-tag | use-tag Enables and specifies the type of VLAN tag to be assigned to the interface (causes all received data to get tagged with VLAN tag and allows the interface to only send out data tagged with given tag) disconnect-timeout (; Default: ) distance (; Default: ) frame-lifetime (; Default: ) guard-interval ( ; Default: ) any | long any Whether to allow the use of short guard interval (refer to 802.11n MCS specification to see how this may affect throughput). "any" will use either short or long, depending on data rate, "long" will use long only. hide-ssid ( ; Default: ) yes | no yes - AP does not include SSID in the beacon frames and does not reply to probe requests that have broadcast SSID. no - AP includes SSID in the beacon frames and replies to probe requests that have broadcast SSID. This property has effect only in AP mode. Setting it to can yes remove this network from the list of wireless networks that are shown by some client software. Changing this setting does not improve the security of the wireless network, because SSID is included in other frames sent by the AP. hw-protection-mode (; Default: )

hw-retries (; Default: ) installation ( ; Default: ) any | indoor | outdoor any keepalive-frames ( ; Default: ) enabled | disabled enabled load-balancing-group ( ; Default: ) string Tags the interface to the load balancing group. For a client to connect to interface in this group, the interface should have the same number of already connected clients as all other interfaces in the group or smaller. Useful in setups where ranges of CAPs mostly overlap. max-sta-count ( ; Default: ) integer [1..2007] Maximum number of associated clients. mode (; Default: )ap Set operational mode. Only ap currently supported. multicast-helper ( ; Default: ) default | disabled | full default When set to full multicast packets will be sent with unicast destination MAC address, resolving on a wireless link. This multicast problem option should be enabled only on the access point, clients should be configured in mode. Available starting from v5.15. station-bridge disabled - disables the helper and sends multicast packets with multicast destination MAC addresses full - all multicast packet mac address are changed to unicast mac addresses prior sending them out default - default choice that currently is set to . Value disabled can be changed in future releases. name ( ; Default: ) string Descriptive name for the Configuration Profile rates (; Default: ) User defined list taken from Rates names ( ) /caps-man rates rates.basic (1Mbps | 2Mbps | 5.5Mbps | 6Mbps | 11Mbps | 11Mbps | 12Mbps | ; Default: ) 18Mbps | 24Mbps | 36Mbps | 48Mbps | 54Mbps rates.supported (1Mbps | 2Mbps | 5.5Mbps | 6Mbps | 11Mbps | 11Mbps | ; Default: ) 12Mbps | 18Mbps | 24Mbps | 36Mbps | 48Mbps | 54Mbps -basic-mcs rates.ht (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs- 6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs- ; 15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs-20 | mcs-21 | mcs-22 | mcs-23) Default: ) mcs-0; mcs-1; mcs-2; mcs-3; mcs-4; mcs-5; mcs-6; mcs-7Modulation and Coding Schemes that every connecting client must support. Refer to 802.11n for MCS specification. -supported-mcs rates.ht (list of (mcs-0 | mcs-1 | mcs-2 | mcs-3 | mcs-4 | mcs-5 | mcs-6 | mcs-7 | mcs-8 | mcs-9 | mcs-10 | mcs-11 | mcs-12 | mcs-13 | mcs-14 | mcs-15 | mcs-16 | mcs-17 | mcs-18 | mcs-19 | mcs-20 | mcs-21 | mcs-22 | mcs- ; Default: 23) mcs-0; mcs-1; mcs-2; mcs-3; mcs-4; mcs-5; mcs-6; mcs-7; mcs-8; mcs-9; mcs-10; mcs-11; mcs-12; mcs-13; mcs-14; mcs-15; mcs-16; mcs-17; ) mcs-18; mcs-19; mcs-20; mcs-21; mcs-22; mcs-23Modulation and Coding Schemes that this device advertises as supported. Refer to 802.11n for MCS specification. rates.vht-basic-mcs ( ; Default: ) none | MCS 0-7 | MCS 0-8 | MCS 0-9 none Modulation and Coding Schemes that every connecting client must support. Refer to 802.11ac for MCS specification. You can set MCS interval for each of Spatial Stream none - will not use selected Spatial Stream MCS 0-7 - client must support MCS-0 to MCS-7 MCS 0-8 - client must support MCS-0 to MCS-8 MCS 0-9 - client must support MCS-0 to MCS-9

rates.vht-supported-mcs ( ; Default: ) none | MCS 0-7 | MCS 0-8 | MCS 0-9 none Modulation and Coding Schemes that this device advertises as supported. Refer to 802.11ac for MCS specification. You can set MCS interval for each of Spatial Stream none - will not use selected Spatial Stream MCS 0-7 - devices will advertise as supported MCS-0 to MCS-7 MCS 0-8 - devices will advertise as supported MCS-0 to MCS-8 MCS 0-9 - devices will advertise as supported MCS-0 to MCS-9 rx-chains ( ; Default: ) list of integer [0..2] 0 Which antennas to use for receive. security ( ; Default: ) string none Name of security configuration from /caps-man security security.authentication-types ( ; Default: ) list of string none Specify the type of Authentication from , , wpa-psk wpa2-psk wpa-eap or wpa2-eap security.disable-pmkid (; Default: ) security.eap-methods ( ; Default: ) eap-tls | passthrough none eap-tls - Use built-in EAP TLS authentication. passthrough - Access point will relay authentication process to the RADIUS server. security.eap-radius-accounting (; Default: ) security.encryption ( ; Default: ) aes-ccm | tkip aes-ccm Set type of unicast encryption algorithm used security.group-encryption ( ; Default: ) aes-ccm | tkip aes-ccm Access Point advertises one of these ciphers, multiple values can be selected. Access Point uses it to encrypt all broadcast and multicast frames. Client attempts connection only to Access Points that use one of the specified group ciphers. tkip - Temporal Key Integrity Protocol - encryption protocol, compatible with legacy WEP equipment, but enhanced to correct some of the WEP flaws. aes-ccm - more secure WPA encryption protocol, based on the reliable AES (Advanced Encryption Standard). Networks free of WEP legacy should use only this cipher. security.group-key-update ( ; Default: ) time: 30s..1h 5m Controls how often Access Point updates the group key. This key is used to encrypt all broadcast and multicast frames. property only has effect for Access Points. security.passphrase ( ; Default: ) string WPA or WPA2 pre-shared key security.tls-certificate ( ; Default: ) none | name Access Point always needs a certificate when configured when securit is set to , or is set to . y.tls-mode verify-certificate dont-verify-certificate security.tls-mode ( ; verify-certificate | dont-verify-certificate | no-certificates Default: )This property has effect only when contains security.eap-methods eap .-tls verify-certificate - Require remote device to have valid certificate. Check that it is signed by known certificate authority. No additional identity verification is done. Certificate may include information about time period during which it is valid. If router has incorrect time and date, it may reject valid certificate because router's clock is outside that period. See also the Certifi configuration. cates dont-verify-certificate - Do not check certificate of the remote device. Access Point will not require client to provide certificate. no-certificates - Do not use certificates. TLS session is established using 2048 bit anonymous Diffie-Hellman key exchange.

ssid ( ; Default: ) string (0..32 chars) SSID (service set identifier) is a name broadcast in the beacons that identifies wireless network. tx-chains ( ; Default: ) list of integer [0..2] 0 Which antennas to use for transmit. Channel Groups Channel group settings allows for the configuration of lists of radio channel related settings, such as radio band, frequency, Tx Power extension channel and width. Channel group settings are configured in the Channels profile menu /caps-man channels Property Description band (2ghz-b | 2ghz-b/g | 2ghz-b/g/n | 2ghz- onlyg | 2ghz-onlyn | 5ghz-a | 5ghz-a/n | 5ghz- ; Default: ) onlynDefine operational radio frequency band and mode taken from hardware capability of wireless card comment ( ; Default: ) string Short description of the Channel Group profile extension-channel (Ce | Ceee | eC | eCee | ; Default: ) eeCe | eeeC | disabledExtension channel configuration. (E.g. Ce = extension channel is above Control channel, eC = extension channel is below Control channel) frequency ( ; Default: ) integer [0..4294967295] Channel frequency value in MHz on which AP will operate. name ( ; Default: ) string Descriptive name for the Channel Group Profile tx-power ( ; Default: ) integer [-30..40] TX Power for CAP interface (for the whole interface not for individual chains) in dBm. It is not possible to set higher than allowed by country regulations or interface. By default max allowed by country or interface is used. width (; Default: ) Sets Channel Width in MHz. (E.g. 20, 40) save-selected (; Default: )yes Saves selected channel for the CAP Radio - will select this channel after the CAP reconnects to CAPsMAN and use it till the channel Re-optimize is done for this CAP. Datapath Configuration Datapath settings control data forwarding related aspects. On CAPsMAN datapath settings are configured in datapath profile menu or /caps-man datapath directly in a configuration profile or interface menu as settings with prefix. datapath. There are 2 major forwarding modes: local forwarding mode, where CAP is locally forwarding data to and from wireless interface manager forwarding mode, where CAP sends to CAPsMAN all data received over wireless and only sends out the wireless data received from CAPsMAN. In this mode even client-to-client forwarding is controlled and performed by CAPsMAN. Forwarding mode is configured on a per-interface basis - so if one CAP provides 2 radio interfaces, one can be configured to operate in local forwarding mode and the other in manager forwarding mode. The same applies to Virtual-AP interfaces - each can have different forwarding mode from master interface or other Virtual-AP interfaces. Most of the datapath settings are used only when in manager forwarding mode, because in local forwarding mode CAPsMAN does not have control over data forwarding. There are the following datapath settings: bridge -- bridge interface to add interface to, as a bridge port, when enabled bridge-cost -- bridge port cost to use when adding as bridge port bridge-horizon -- bridge horizon to use when adding as bridge port client-to-client-forwarding -- controls if client-to-client forwarding between wireless clients connected to interface should be allowed, in local forwarding mode this function is performed by CAP, otherwise it is performed by CAPsMAN. local-forwarding -- controls forwarding mode openflow-switch -- OpenFlow switch to add interface to, as port when enabled vlan-id -- VLAN ID to assign to interface if vlan-mode enables use of VLAN tagging vlan-mode -- VLAN tagging mode specifies if VLAN tag should be assigned to interface (causes all received data to get tagged with VLAN tag and allows interface to only send out data tagged with given tag)

Local Forwarding Mode In this mode wireless interface on CAP behaves as a normal interface and takes part in normal data forwarding. Wireless interface will accept/pass data to networking stack on CAP. CAPsMAN will not participate in data forwarding and will not process any of data frames, it will only control interface configuration and client association process. Wireless interface on CAP will change its configuration to 'enabled' and its state and some relevant parameters (e.g. mac-address, arp, mtu) will reflect that of the interface on CAPsMAN. Note that wireless related configuration reflect actual interface configuration as applied by CAPsMAN: will not [admin@CAP] /interface wireless> pr Flags: X - disabled, R - running 0 R ;;; managed by CAPsMAN ;;; channel: 5180/20-Ceee/ac, SSID: master, local forwarding name="wlan2" mtu=1500 mac-address=00:03:7F:48:CC:07 arp=enabled interface-type=Atheros AR9888 mode=ap-bridge ssid="merlin" frequency=5240 band=5ghz-a/n channel-width=20/40mhz-eC scan-list=default ... Virtual-AP interfaces in local forwarding mode will appear as enabled and dynamic Virtual-AP interfaces: [admin@CAP] /interface> pr Flags: D - dynamic, X - disabled, R - running, S - slave # NAME TYPE MTU L2MTU MAX-L2MTU ... 2 RS ;;; managed by CAPsMAN ;;; channel: 5180/20-Ceee/ac, SSID: master, local forwarding wlan2 wlan 1500 1600 3 DRS ;;; managed by CAPsMAN ;;; SSID: slave, local forwarding wlan6 wlan 1500 1600 ... [admin@CAP] /interface> wireless pr Flags: X - disabled, R - running ... 2 R ;;; managed by CAPsMAN ;;; SSID: slave, local forwarding name="wlan6" mtu=1500 mac-address=00:00:00:00:00:00 arp=enabled interface-type=virtual-AP master-interface=wlan2 The fact that Virtual-AP interfaces are added as dynamic, somewhat limits static configuration possibilities on CAP for data forwarding, such as assigning addresses to Virtual-AP interface. This does not apply to master wireless interface. To overcome this it is possible to use the static-virtual setting on the CAP which will create Static Virtual Interfaces instead of Dynamic and allows the possibility to assign IP configuration to those interfaces. MAC address is used to remember each static-interface when applying the configuration from the CAPsMAN. If two or more static interfaces will have the same MAC address the configuration could be applied in random order. To facilitate data forwarding configuration, CAP can be configured with bridge to which interfaces are automatically added as ports when interfaces are enabled by CAPsMAN. This can be done in menu. /interface wireless cap Manager Forwarding Mode In this mode CAP sends all data received over wireless to CAPsMAN and only sends out over wireless, data received from CAPsMAN. CAPsMAN has full control over data forwarding including client-to-client forwarding. Wireless interface on CAP is disabled and does not participate in networking: ... 1 X ;;; managed by CAPsMAN ;;; channel: 5180/20-Ceee/ac, SSID: master, manager forwarding name="wlan2" mtu=1500 mac-address=00:03:7F:48:CC:07 arp=enabled interface-type=Atheros AR9888 mode=ap-bridge ssid="merlin" ... Virtual-AP interfaces are also created as 'disabled' and do not take part in data forwarding on CAP. Access List Access list on CAPsMAN is an ordered list of rules that is used to allow/deny clients to connect to any CAP under CAPsMAN control. When client attempts to connect to a CAP that is controlled by CAPsMAN, CAP forwards that request to CAPsMAN. As a part of registration process, CAPsMAN consults access list to determine if client should be allowed to connect. The default behaviour of the access list is to allow connection. Access list rules are processed one by one until matching rule is found. Then the action in the matching rule is executed. If action specifies that client should be accepted, client is accepted, potentially overriding it's default connection parameters with ones specified in access list rule.

Access list is configured in menu. There are the following parameters for access list rules: /caps-man access-list client matching parameters: address - MAC address of client (or, if mask is specified, only those parts will be checked as per the mask, so to match vendor D8 from "D8:1C:79:6E:1E:FE", simply enter a bogus entry, such as "D8:00:00:00:00" and then use the mask as per next line) mask - MAC address mask to apply when comparing client address. For example, use FF:00:00:00:00:00 to match only the first octet of the specified MAC address. In above example, regardless of entered MAC, it will match only first octet. Similarly, entering 00:00:00:00: FF will only match the last octet (FE) of a hypotetical MAC "D8:1C:79:6E:1E:FE"). So in the mac line, you could just enter 00:00:00:00:00: FE, if you would use such a mask. interface - optional interface to compare with interface to which client actually connects to time - time of day and days when rule matches signal-range - range in which client signal must fit for rule to match action parameter - specifies action to take when client matches: accept - accept client reject - reject client query-radius - query RADIUS server if particular client is allowed to connect connection parameters: ap-tx-limit - tx speed limit in direction to client client-tx-limit - tx speed limit in direction to AP (applies to RouterOS clients only) client-to-client-forwarding - specifies whether to allow forwarding data received from this client to other clients connected to the same interface private-passphrase - PSK passphrase to use for this client if some PSK authentication algorithm is used radius-accounting - specifies if RADIUS traffic accounting should be used if RADIUS authentication gets done for this client vlan-mode - VLAN tagging mode specifies if traffic coming from client should get tagged (and untagged when going to client). vlan-id - VLAN ID to use if doing VLAN tagging. Registration Table Registration table contains a list of clients that are connected to radios controlled by CAPsMAN and is available in menu: /caps-man registration-table [admin@CM] /caps-man> registration-table print # INTERFACE MAC-ADDRESS UPTIME RX-SIGNAL 0 cap1 00:03:7F:48:CC:0B 1h38m9s210ms -36 Examples Basic configuration with master and slave interface Create security profile for WPA2 PSK, without specifying passphrase: [admin@CM] /caps-man security>add name="wpa2psk" authentication-types=wpa2-psk encryption=aes-ccm Create configuration profile to be used by master interface specify WPA2 passphrase in configuration specify channel settings in configuration: [admin@CM] /caps-man configuration> add name=master-cfg ssid=master security=wpa2psk security.passphrase=12345678 channel.frequency=5180 channel.width=20 channel.band=5ghz-a Create configuration profile to be used by virtual AP interface specify different WPA2 passphrase in configuration: [admin@CM] /caps-man configuration> add name=slave-cfg ssid=slave security=wpa2psk security.passphrase=87654321 Create provisioning rule that matches any radio and creates dynamic interfaces using master-cfg and slave-cfg: [admin@CM] /caps-man provisioning> add action=create-dynamic-enabled master-configuration=master-cfg slave-configurations=slave-cfg Now when AP connects and is provisioned 2 dynamic interfaces (one master and one slave) will get created:

[admin@CM] /caps-man interface> print detail Flags: M - master, D - dynamic, B - bound, X - disabled, I - inactive, R - running 0 MDB name="cap1" mtu=1500 l2mtu=2300 radio-mac=00:0C:42:1B:4E:F5 master-interface=none configuration=master-cfg 1 DB name="cap2" mtu=1500 l2mtu=2300 radio-mac=00:00:00:00:00:00 master-interface=cap1 configuration=slave-cfg Consider an AP, that does not support configured frequency connects and can not become operational: [admin@CM] /caps-man interface> pr Flags: M - master, D - dynamic, B - bound, X - disabled, I - inactive, R - running # NAME RADIO-MAC MASTER-INTERFACE 0 MDB ;;; unsupported band or channel cap3 00:0C:42:1B:4E:FF none ... We can override channel settings for this particular radio in interface settings, without affecting master-cfg profile: [admin@CM] /caps-man interface> set cap3 channel.frequency=2142 channel.band=2ghz-b/g Allow Specific MAC address range to match the Access-list, for example, match all the Apple devices: [admin@CM] /caps-man access-list> add mac-address=18:34:51:00:00:00 mac-address-mask=FF:FF:FF:00:00:00 action=accept Configuring DHCP Server Option 138 for setting the CAPsMAN address on the CAP boards [admin@CM] /ip dhcp-server network set <network-id> caps-manager=<capsman-server-ip> DHCP client this CAPsMAN IP will see in "/ip dhcp-client print detail" Configuration with certificates You would want to configure certificates in your CAPsMAN to use options as and . These options increase Require Peer Certificate Lock To Caps Man security and in some cases stability of your CAPsMAN network. CAPs won't connect to CAPsMAN without a specific certificate and vice versa. Fast and easy configuration This is a basic configuration for using certificates in your CAPsMAN setup. This example assumes that you already have basic configuration on your CAPsMAN and CAP. It is best to use this configuration in CAPsMAN networks which are not constantly growing. For more details read about CAP to . CAPsMAN Connection CAPsMAN device: In CAPsMAN Manager menu set and to : Certificate CA Certificate auto /caps-man manager set ca-certificate=auto certificate=auto Print output: [admin@CAPsMAN] /caps-man manager print enabled: yes certificate: auto ca-certificate: auto package-path: upgrade-policy: none require-peer-certificate: no generated-certificate: CAPsMAN-D4CA6D987C26 generated-ca-certificate: CAPsMAN-CA-D4CA6D987C26 CAPsMAN device first will generate and then it will generate which depends on . CA-Certificate Certificate CA-Certificate CAP device: Set in CAP configuration to certificate: request /interface wireless cap set certificate=request CAP will connect to CAPsMAN and request certificate. CAP will receive form CAPsMAN and another certificate will be created for use on CA-Certificate CAP. In Result

On CAP device in CAP menu is set: Requested Certificate [admin@CAP] /interface wireless cap print enabled: yes interfaces: wlan1 certificate: request lock-to-caps-man: no discovery-interfaces: ether1 caps-man-addresses: caps-man-names: caps-man-certificate-common-names: bridge: none static-virtual: no --> requested-certificate: CAP-D4CA6D7F45BA <-- Also, two certificates are gained and are seen in menu: Certificate [admin@CAP] > /certificate print Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted # NAME COMMON-NAME SUBJECT-ALT-NAME FINGERPRINT 0 A T _0 CAPsMAN-CA-D4CA6D987C26 383e63d7b... 1 K CAP-D4CA6D7F45BA CAP-D4CA6D7F45BA d495d1a94... On CAPsMAN device in Certificate menu three certificates are created. CAPsMAN and CAPsMAN-CA certificates, as well as a certificate which is issued to CAP: [admin@CAPsMAN] > /certificate print Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted # NAME COMMON-NAME SUBJECT-ALT-NAME FINGERPRINT 0 K A T CAPsMAN-CA-D4CA6D987C26 CAPsMAN-CA-D4CA6D987C26 383e63d7b... 1 K I CAPsMAN-D4CA6D987C26 CAPsMAN-D4CA6D987C26 02b0f7ff4... 2 I issued_1 CAP-D4CA6D7F45BA d495d1a94... Additionally If you want to allow only CAPs with a valid certificate to connect to this CAPsMAN you can set to on CAPsMAN device: Require Peer Certificate yes /caps-man manager set require-peer-certificate=yes However, when you will want to add new CAP devices to your CAPsMAN network you will have to set this option to and then back to after CAP has no yes gained certificates. Every time you change this option CAPsMAN will drop all dynamic interfaces and CAPs will try to connect again. If you want to lock CAP to specific CAPsMAN and be sure it won't connect to other CAPsMANs you should set option to . Lock To CAPsMAN yes Additionally, you can specify CAPsMAN to lock to by setting on CAP device: CAPsMAN Certificate Common Names /interface wireless cap set lock-to-caps-man=yes set caps-man-certificate-common-names=CAPsMAN-D4CA6D987C26 Manual certificates and issuing with SCEP With this example, you can create your own certificates for CAPsMAN and take control over issuing certificates to CAPs. This configuration can be useful in big, growing CAPsMAN networks. Many segments of this example can be done differently depending on your situation and needs. At this point, some knowledge about and their can be useful. Certificates application CAPsMAN device: In menu add certificate templates for CA certificate and CAPsMAN server certificate: Certificate /certificate add name=CA-temp common-name=CA add name=CAPsMAN-temp common-name=CAPsMAN Now the certifiace templates. First the CA certificate and use CAPsMAN device IP as : Sign Sign CA CRL Host /certificate sign CA-temp ca-crl-host=10.5.138.157 name=CA sign CAPsMAN-temp ca=CA name=CAPsMAN

Alternatively, previous two steps can be done with auto setting in and option in CAPsMAN Manager menu, see the Certificate CA-Certificate Fast and easy . configuration Export CA certificate. You will have to it on CAP device. You can use to CAP device, in this example command is Import Download -> Drag&Drop fetch used later from CAP device. Using long passphrase is advisable - longer passphrase will take longer to crack if it gets into the wrong hands: /certificate export-certificate CA export-passphrase=thelongerthebetterpassphrase Create which will be used to issue and grant certificates to CAP devices: SCEP server /certificate scep-server add ca-cert=CA path=/scep/CAPsMAN Set certificates in CAPsMAN Manager menu and set to yes: Require Peer Certificate /caps-man manager set ca-certificate=CA certificate=CAPsMAN set require-peer-certificate=yes At this point, only CAPs with a valid certificate will be able to connect. CAP device Download export of CA certificate from CAPsMAN device to CAP device. In this example is used, however, there are multiple other ways: fetch /tool fetch address=10.5.138.157 src-path=cert_export_CA.crt user=admin password="123" mode=ftp Import CA certificate from CAPsMAN device in menu: Certificate /certificate> import file-name=cert_export_CA.crt passphrase=thelongerthebetterpassphrase Add certificate template for CAP: /certificate add name=CAP1 common-name=CAP1 Ask CAPsMAN device to grant this certificate with a key using SCEP: /certificate add-scep template=CAP1 scep-url="https://10.5.138.157/scep/CAPsMAN" You will have to return to CAPsMAN device to grant key to this certificate. In CAP menu set just created certificate: /interface wireless cap set certificate=CAP1 CAPsMAN device: Return to CAPsMAN device to grant a key to CAP certificate in menu: Certificate Request /certificate scep-server requests grant numbers=0 In Result Now CAP should be able to connect to CAPsMAN, see in if it connects. In CAPsMAN device menu three certificates can CAPsMAN interfaces Certificate be seen: CA, CAPsMAN, and the one which is issued to CAP: [admin@CAPsMAN] /certificate print Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted # NAME COMMON-NAME SUBJECT-ALT-NAME FINGERPRINT 0 K L A T CA CA 752775b457a37... 1 K A CAPsMAN CAPsMAN 12911ba445b3b... 2 I issued_1 CAP1 5b9a52b6ce3fb... In CAP devices menu two acquired certificates can be seen: Certificate [admin@CAP1] /interface wireless> /certificate print Flags: K - private-key, D - dsa, L - crl, C - smart-card-key, A - authority, I - issued, R - revoked, E - expired, T - trusted # NAME COMMON-NAME SUBJECT-ALT-NAME FINGERPRINT 0 L A T cert_exp... CA 752775b457a37... 1 K T CAP1 CAP1 5b9a52b6ce3fb...

mesh-portal ( ; boolean Default: )noWhether this interface is a portal in the mesh network mtu ( ; Default: ) number 1500 Maximum transmission unit size name ( ; Default: ) string Interface name reoptimize-paths ( ; boolean Default: )noWhether to send out periodic PREQ messages asking for known MAC addresses. Turning on this setting is useful if the network topology is changing often. Note that if no reply is received to a re-optimization PREQ, the existing path is kept anyway (until it timeouts itself) Port Property Description active-port-type (read-only: wireless | WDS | ethernet-mesh ; Default: ) | ethernet-bridge | ethernet-mixedport type and state actually used hello-interval ( ; Default: ) time 10s the maximum interval between sending out HWMP+ Hello messages. Used only for Ethernet type ports interface ( ; Default: ) interface name interface name, which is to be included in a mesh mesh ( ; Default: ) interface name mesh interface this port belongs to path-cost ( ; Default: ) integer: 0..65535 10 path cost to the interface, used by routing protocol to determine the 'best' path port-type ( ; Default: ) WDS | auto | ethernet | wireless port type to use auto - port type is determined automatically based on the underlying interface's type WDS - a Wireless Distribution System interface. Remote MAC address is learned from wireless connection data ethernet - Remote MAC addresses are learned either from HWMP+ Hello messages or from source MAC addresses in received or forwarded traffic wireless - Remote MAC addresses are learned from wireless connection data FDB Status Property Description mac-address ( ) MAC address MAC address corresponding for this FDB entry seq-number ( ) integer sequence number used in routing protocol to avoid loops type ( ) integer sequence number used in routing protocol to avoid loops interface (local | outsider | direct | mesh | ) neighbor | larval | unknowntype of this FDB entry local -- MAC address belongs to the local router itself outsider -- MAC address belongs to a device external to the mesh network direct -- MAC address belongs to a wireless client on an interface that is in the mesh network mesh -- MAC address belongs to a device reachable over the mesh network; it can be either internal or external to the mesh network neighbor -- MAC address belongs to a mesh router that is a direct neighbor to this router larval -- MAC address belongs to an unknown device that is reachable over the mesh network unknown -- MAC address belongs to an unknown device mesh ( ) interface name the mesh interface this FDB entry belongs to on-interface ( ) interface name mesh port used for traffic forwarding, kind of a next-hop value lifetime ( )time time remaining to live if this entry is not used for traffic forwarding

age ( )time age of this FDB entry metric ( ) integer a metric value used by routing protocol to determine the 'best' path Example This example uses static WDS links that are dynamically added as mesh ports when they become active. Two different frequencies are used: one for AP interconnections, and one for client connections to APs, so the AP must have at least two wireless interfaces. Of course, the same frequency for all connections also could be used, but that might not work as well because of potential interference issues. Repeat this configuration on all APs: /interface mesh add disabled=no /interface mesh port add interface=wlan1 mesh=mesh1 /interface mesh port add interface=wlan2 mesh=mesh1 # interface used for AP interconnections /interface wireless set wlan1 disabled=no ssid=mesh frequency=2437 band=2ghz-b/g/n mode=ap-bridge \ wds-mode=static-mesh wds-default-bridge=mesh1 # interface used for client connections /interface wireless set wlan2 disabled=no ssid=mesh-clients frequency=5180 band=5ghz-a/n/ac mode=ap-bridge # a static WDS interface for each AP you want to connect to /interface wireless wds add disabled=no master-interface=wlan1 name=<descriptive name of remote end> \ wds-address=<MAC address of remote end>

Here WDS interface is added manually because static WDS mode is used. If you are using = , all WDS interfaces will be created wds-mode dynamic-mesh automatically. The and parameters are specified here only to produce valid example configuration; mesh protocol operations are by no frequency band means limited to or optimized for, these particular values. In real-world setups you also should take care of securing the wireless connections, using . For simplicity, that /interface wireless security-profile configuration is not shown here. Results on router A (there is one client connected to wlan2): [admin@A] > /interface mesh print Flags: X - disabled, R - running 0 R name="mesh1" mtu=1500 arp=enabled mac-address=00:0C:42:0C:B5:A4 auto-mac=yes admin-mac=00:00:00:00:00:00 mesh-portal=no hwmp-default-hoplimit=32 hwmp-preq-waiting-time=4s hwmp-preq-retries=2 hwmp-preq-destination-only=yes hwmp-preq-reply-and-forward=yes hwmp-prep-lifetime=5m hwmp-rann-interval=10s hwmp-rann-propagation-delay=1s hwmp-rann-lifetime=22s [admin@A] > /interface mesh port print detail Flags: X - disabled, I - inactive, D - dynamic 0 interface=wlan1 mesh=mesh1 path-cost=10 hello-interval=10s port-type=auto port-type-used=wireless 1 interface=wlan2 mesh=mesh1 path-cost=10 hello-interval=10s port-type=auto port-type-used=wireless 2 D interface=router_B mesh=mesh1 path-cost=105 hello-interval=10s port-type=auto port-type-used=WDS 3 D interface=router_D mesh=mesh1 path-cost=76 hello-interval=10s port-type=auto port-type-used=WDS The FDB (Forwarding Database) at the moment contains information only about local MAC addresses, non-mesh nodes reachable through a local interface, and direct mesh neighbors: [admin@A] /interface mesh fdb print Flags: A - active, R - root MESH TYPE MAC-ADDRESS ON-INTERFACE LIFETIME AGE A mesh1 local 00:0C:42:00:00:AA 3m17s A mesh1 neighbor 00:0C:42:00:00:BB router_B 1m2s A mesh1 neighbor 00:0C:42:00:00:DD router_D 3m16s A mesh1 direct 00:0C:42:0C:7A:2B wlan2 2m56s A mesh1 local 00:0C:42:0C:B5:A4 2m56s [admin@A] /interface mesh fdb print detail Flags: A - active, R - root A mac-address=00:0C:42:00:00:AA type=local age=3m21s mesh=mesh1 metric=0 seqnum=4294967196 A mac-address=00:0C:42:00:00:BB type=neighbor on-interface=router_B age=1m6s mesh=mesh1 metric=132 seqnum=4294967196 A mac-address=00:0C:42:00:00:DD type=neighbor on-interface=router_D age=3m20s mesh=mesh1 metric=79 seqnum=4294967196 A mac-address=00:0C:42:0C:7A:2B type=direct on-interface=wlan2 age=3m mesh=mesh1 metric=10 seqnum=0 A mac-address=00:0C:42:0C:B5:A4 type=local age=3m mesh=mesh1 metric=0 seqnum=0 Test if ping works: [admin@A] > /ping 00:0C:42:00:00:CC 00:0C:42:00:00:CC 64 byte ping time=108 ms 00:0C:42:00:00:CC 64 byte ping time=51 ms 00:0C:42:00:00:CC 64 byte ping time=39 ms 00:0C:42:00:00:CC 64 byte ping time=43 ms 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 39/60.2/108 ms Router A had to discover a path to Router C first, hence the slightly larger time for the first ping. Now the FDB also contains an entry for 00:0C:42:00:00: CC, with type "mesh". You may want to increase wireless interface option to make the protocol more stable. the disconnect-timeout

Also, test that ARP resolving works and so does IP level ping: [admin@A] > /ping 10.4.0.3 10.4.0.3 64 byte ping: ttl=64 time=163 ms 10.4.0.3 64 byte ping: ttl=64 time=46 ms 10.4.0.3 64 byte ping: ttl=64 time=48 ms 3 packets transmitted, 3 packets received, 0% packet loss round-trip min/avg/max = 46/85.6/163 ms Mesh traceroute There is also a mesh traceroute command, that can help you to determine which paths are used for routing. For example, for this network: [admin@1] /interface mesh fdb print Flags: A - active, R - root MESH TYPE MAC-ADDRESS ON-INTERFACE LIFETIME AGE A mesh1 local 00:0C:42:00:00:01 7m1s A mesh1 mesh 00:0C:42:00:00:02 wds4 17s 4s A mesh1 mesh 00:0C:42:00:00:12 wds4 4m58s 1s A mesh1 mesh 00:0C:42:00:00:13 wds4 19s 2s A mesh1 neighbor 00:0C:42:00:00:16 wds4 7m1s A mesh1 mesh 00:0C:42:00:00:24 wds4 18s 3s Traceroute to 00:0C:42:00:00:12 shows: [admin@1] /interface mesh traceroute mesh1 00:0C:42:00:00:12 ADDRESS TIME STATUS 00:0C:42:00:00:16 1ms ttl-exceeded 00:0C:42:00:00:02 2ms ttl-exceeded 00:0C:42:00:00:24 4ms ttl-exceeded 00:0C:42:00:00:13 6ms ttl-exceeded 00:0C:42:00:00:12 6ms success Protocol description Reactive mode

Router A wants to discover a path to C Router C sends a unicast response to A In reactive mode, HWMP+ is very much like AODV (Ad-hoc On-demand Distance Vector). All paths are discovered on-demand, by flooding Path Request (PREQ) message in the network. The destination node or some router that has a path to the destination will reply with a Path Response (PREP). Note that if the destination address belongs to a client, the AP this client is connected to will serve as a proxy for him (i.e. reply to PREQs on his behalf). This mode is best suited for mobile networks, and/or when most of the communication happens between intra-mesh nodes. Proactive mode

The root announces itself by flooding RANN Internal nodes respond with PREGs In proactive mode, there are some routers configured as portals. In general, being a portal means that the router has interfaces to some other network, i.e. it is an entry/exit point to the mesh network. The portals will announce their presence by flooding the Root Announcement (RANN) message in the network. Internal nodes will reply with a Path Registration (PREG) message. The result of this process will be routing trees with roots in the portal. Routes to portals will serve as a kind of default route. If an internal router does not know the path to a particular destination, it will forward all data to its closest portal. The portal will then discover the path on behalf of the router if needed. The data afterward will flow through the portal. This may lead to sub- optimal routing unless the data is addressed to the portal itself or some external network the portals have interfaces to. A proactive mode is best suited when most of the traffic goes between internal mesh nodes and a few portal nodes. Topology change detection

Data flow path After the link disappears, an error is propagated upstream HWMP+ uses Path Error (PERR) message to notify that a link has disappeared. The message is propagated to all upstream nodes up to the data source. The source on PERR reception restarts the path discovery process. FAQ Q. How is this better than RSTP? A. It gives you optimal routing. RSTP is only for loop prevention. Q. How the route selection is done? A. The route with the best metric is always selected after the discovery process. There is also a configuration option to periodically reoptimize already known routes. Route metric is calculated as the sum of individual link metrics. Link metric is calculated in the same way as for (R)STP protocols: For Ethernet links the metric is configured statically (same as for OSPF, for example). For WDS links the metric is updated dynamically depending on actual link bandwidth, which in turn is influenced by wireless signal strength, and the selected data transfer rate. Currently, the protocol does not take into account the amount of bandwidth being used on a link, but that might be also used in the future. Q. How is this better than OSPF/RIP/layer-3 routing in general? A. WDS networks usually are bridged, not routed. The ability to self-configure is important for mesh networks, and routing generally requires much more configuration than bridging. Of course, you can always run any L3 routing protocol over a bridged network, but for mesh networks that usually makes little sense.

Q. What about performance/CPU requirements? A. The protocol itself, when properly configured, will take much fewer resources than OSPF (for example) would. Data forwarding performance on an individual router should be close to that of bridging. Q. How does it work together with existing mesh setups that are using RSTP? A. The internal structure of an RSTP network is transparent to the mesh protocol (because mesh hello packets are forwarded inside the RSTP network). The mesh will see the path between two entry points in the RSTP network as a single segment. On the other hand, a mesh network is not transparent to the RSTP, since RSTP hello packets are not be forwarded inside the mesh network. (This is the behavior since v3.26) Note that if you have a WDS link between two access points, then both ends must have the same configuration (either as ports in a mesh on both ends or as ports in a bridge interface on both ends). You can also put a bridge interface as a mesh port (to be able to use a bridge firewall, for example). Q. Can I have multiple entry/exit points to the network? A. If the entry/exit points are configured as portals (i.e. proactive mode is used), each router inside the mesh network will select its closest portal and forward all data to it. The portal will then discover a path on behalf of the router if needed. Q. How to control or filter mesh traffic? A. At the moment the only way is to use a bridge firewall. Create a bridge interface, put the WDS interfaces and/or Ethernets in that bridge, and put that bridge in a mesh interface. Then configure bridge firewall rules. To match MAC protocol used for mesh traffic encapsulation, use MAC protocol number 0x9AAA, and to match mesh routing traffic, use MAC protocol number 0x9AAB. Example: interface bridge settings set use-ip-firewall=yes interface bridge filter add chain=input action=log mac-protocol=0x9aaa interface bridge filter add chain=input action=log mac-protocol=0x9aab Advanced topics We all know that it's easy to make problematic layer-2 bridging or routing setups and it can be hard to debug them. (Compared to layer-3 routing setups.) So here are a few bad configuration examples that could create problems for you. Avoid them! Problematic example 1: Ethernet switch inside a mesh Since optimized layer-2 multicast forwarding is not included in the mesh protocol, it is better to avoid forwarding any multicast traffic (including OSPF) over meshed networks. If you need OSPF, then you have to configure neighbors that use unicast mode instead. OSPF NBMA Routing loops are possible if a mesh network is attached to an RSTP network in two or more points! It is perfectly possible to create mixed mesh/bridge setups that will not work (e.g. with bridge instead of a switch). The Problematic example 1 recommended fail-safe way that will always work is to create a separate bridge interface per each of the physical interfaces; then add all these bridge interfaces as mesh ports.

1. 2. Router A is outside the mesh, all the rest of the routers are inside. For routers B, C, D all interfaces are added as mesh ports. Router A will not be able to communicate reliably with router C. The problem manifests itself when D is the designated router for Ethernet; if B takes this role, everything is OK. The main cause of the problem is MAC address learning on Ethernet switch. Consider what happens when router A wants to send something to C. We suppose router A either knows or floods data to all interfaces. Either way, data arrives at the switch. The switch, not knowing anything about the destination's MAC address, forwards the data to both B and D. What happens now: B receives the packet on a mesh interface. Since the MAC address is not local for B and B knows that he is not the designated router for the Ethernet network, he simply ignores the packet. D receives the packet on a mesh interface. Since the MAC address is not local for B and D is the designated router for the Ethernet network, he initiates the path discovery process to C. After path discovery is completed, D has information that C is reachable over B. Now D encapsulates the packet and forwards it back to the Ethernet network. The encapsulated packet is forwarded by the switch, received and forwarded by B, and received by C. So far everything is good. Now C is likely to respond to the packet. Since B already knows where A is, he will decapsulate and forward the reply packet. But now the switch will learn that the MAC address of C is reachable through B! That means, next time when something arrives from A addressed to C, the switch will forward data t only o B (and B, of course, will silently ignore the packet)! In contrast, if B took up the role of a designated router, everything would be OK, because traffic would not have to go through the Ethernet switch twice. Troubleshooting : either avoid such setup or disable MAC address learning on the switch. Note that on many switches that is not possible. Also note that there will be no problem, if either: router A supports and is configured to use HWMP+; or Ethernet switch is replaced with a router that supports HWMP+ and has Ethernet interfaces added as mesh ports. Problematic example 2: wireless modes Consider this (invalid) setup example :

1. 2. Routers A and B are inside the mesh, router C: outside. For routers A and B all interfaces are added as mesh ports. It is not possible to bridge wlan1 and wlan2 on router B now. The reason for this is pretty obvious if you understand how WDS works. For WDS communications four address frames are used. This is because for wireless multihop forwarding you need to know both the addresses of the intermediate hops, as well as the original sender and final receiver. In contrast, non-WDS 802.11 communication includes only three MAC addresses in a frame. That's why it's not possible to do multi-hop forwarding in station mode. Troubleshooting : depends on what you want to achieve: If you want router C to act as a repeater either for wireless or Ethernet traffic, configure the WDS link between router B and router C, and run mesh routing protocol on all nodes. In other cases configure wlan2 on router B in AP mode and WLAN on router C in station mode.

Nv2 protocol is not compatible to or based on any other available wireless protocols or implementations, either TDMA based or any other kind. This implies that . only Nv2 supporting and enabled devices can participate in Nv2 network Regular 802.11 devices will not recognize and will not be able to connect to Nv2 AP. RouterOS devices that have Nv2 support (that is - have RouterOS version 5.0rc1 or higher) will see Nv2 APs when issuing scan command, but will only connect to Nv2 AP if properly configured. As Nv2 does not use CSMA technology it may disturb any other network in the same channel. In the same way other networks may disturb Nv2 network, because every other signal is considered noise. The key points regarding compatibility and coexistence: only RouterOS devices will be able to participate in Nv2 network only RouterOS devices will see Nv2 AP when scanning Nv2 network will disturb other networks in the same channel Nv2 network may be affected by any (Nv2 or not) other networks in the same channel Nv2 enabled device will not connect to any other TDMA based network How Nv2 compares with Nstreme and 802.11 Nv2 vs 802.11 The key differences between Nv2 and 802.11: Media access is scheduled by AP - this eliminates hidden node problem and allows to implement centralized media access policy - AP controls how much time is used by every client and can assign time to clients according to some policy instead of every device contending for media access. Reduced propagation delay overhead - There are no per-frame ACKs in Nv2 - this significantly improves throughput, especially on long-distance links where data frame and following ACK frame propagation delay significantly reduces the effectiveness of media usage. Reduced per frame overhead - Nv2 implements frame aggregation and fragmentation to maximize assigned media usage and reduce per-frame overhead (interframe spaces, preambles). Nv2 vs Nstreme The key differences between Nv2 and Nstreme: Reduced polling overhead - instead of polling each client, Nv2 AP broadcasts an uplink schedule that assigns time to multiple clients, this can be considered "group polling" - no time is wasted for polling each client individually, leaving more time for actual data transmission. This improves throughput, especially in PtMP configurations. Reduced propagation delay overhead - Nv2 must not poll each client individually, this allows to create uplink schedule based on estimated distance (propagation delay) to clients such that media usage is most effective. This improves throughput, especially in PtMP configurations. More control over latency - reduced overhead, adjustable period size and QoS features allows for more control over latency in the network. Configuring Nv2 wireless-protocol setting controls which wireless protocol selects and uses. Note that the meaning of this setting depends on the interface role (either it is AP or client) that depends on interface setting. Find possible values of and their meaning in table below. mode wireless-protocol value AP client unspecified establish nstreme or 802.11 network based on old nstreme settingconnect to nstreme or 802.11 network based on old setting nstreme any same as unspecified scan for all matching networks, no matter what protocol, connect using protocol of chosen network 802.11 establish 802.11 network connect to 802.11 networks only nstreme establish Nstreme network connect to Nstreme networks only Nv2 establish Nv2 network connect to Nv2 networks only

Nv2- nstreme- 802.11establish Nv2 network scan for Nv2 networks, if suitable network found - connect, otherwise scan for Nstreme networks, if suitable network found - connect, otherwise scan for 802.11 network and if suitable network found - connect. Nv2- nstremeestablish Nv2 network scan for Nv2 networks, if suitable network found - connect, otherwise scan for Nstreme networks and if suitable network found - connect Note that values and specify some hybrid or special kind of protocol - these values are wireless-protocol Nv2-nstreme-802.11 Nv2-nstreme DO NOT implemented to simplify client configuration when protocol of network that client must connect to can change. Using these values can help in migrating network to Nv2 protocol. Most of Nv2 settings are significant only to Nv2 AP - Nv2 client automatically adapts necessary settings from AP. The following settings are relevant to Nv2 AP: Nv2-queue-count - specifies how many priority queues are used in Nv2 network. For more details see QoS in Nv2 network Nv2-qos - controls frame to priority queue mapping policy. For more details see QoS in Nv2 network Nv2-cell-radius - specifies distance to farthest client in Nv2 network in km. This setting affects the size of contention time slot that AP allocates for clients to initiate connection and also size of time slots used for estimating distance to client. If this setting is too small, clients that are farther away may have trouble connecting and/or disconnect with "ranging timeout" error. Although during normal operation the effect of this setting should be negligible, in order to maintain maximum performance, it is advised to not increase this setting if not necessary, so AP is not reserving time that is actually never used, but instead allocates it for actual data transfer. tdma-period-size - specifies size in ms of time periods that Nv2 AP uses for media access scheduling. Smaller period can potentially decrease latency (because AP can assign time for client sooner), but will increase protocol overhead and therefore decrease throughput. On the other hand - increasing period will increase throughput but also increase latency. It may be required to increase this value for especially long links to get acceptable throughput. This necessity can be caused by the fact that there is "propagation gap" between downlink (from AP to clients) and uplink (from clients to AP) data during which no data transfer is happening. This gap is necessary because client must receive last frame from AP - this happens after propagation delay after AP's transmission, and only then client can transmit - as a result frame from client arrives at AP after propagation delay after client's transmission (so the gap is propagation delay times two). The longer the distance, the bigger is necessary propagation gap in every period. If propagation gap takes significant portion of period, actual throughput may become unacceptable and period size should get increased at the expense of increased latency. Basically value of this setting must be carefully chosen to maximize throughput but also to keep latency at acceptable levels. Nv2-mode - specifies to use dynamic or fixed downlink/uplink ratio. Default value is "dynamic-downlink"; "sync-master" - works as nv2-mode=fixed-downlink (so uses nv2-downlink-ratio), but allows slaves to sync to this master; "sync-slave" - tries to sync to master (or already synced slave) and adapt period-size and downlink ratio settings from master. Nv2-downlink-ratio - specifies the Nv2 downlink ratio. Uplink ratio is automatically calculated from the downlink-ratio value. When using dynamic- downlink mode the downlink-ratio is also used when link get fully saturated. Minimum value is 20 and maximum 80. Default value is 50. The follwing settings are significant on both - Nv2 AP and Nv2 client: Nv2-security - specifies Nv2 security mode, for more details see Security in Nv2 network Nv2-preshared-key - specifies preshared key to be used, for more details see Security in Nv2 network nv2-sync-secret - specifies secret key for use in the Nv2 synchronization. Secret should match on Master and Slave devices in order to establish the synced state. Migrating to Nv2 Using setting aids in migration or evaluating Nv2 protocol in existing networks really simple and reduce downtime as much as possible. wireless-protocol These are the recommended steps: upgrade AP to version that supports Nv2, but do not enable Nv2 on AP yet. upgrade clients to version that supports Nv2 configure all clients with . Clients will still connect to AP using protocol that was used previously, because wireless-protocol=Nv2-nstreme-802.11 AP is not changed over to Nv2 yet configure Nv2 related settings on AP if it is necessary to use data encryption and secure authentication, configure Nv2 security related settings on AP and clients (refer to Security in ). Nv2 network set on AP. This will make AP to change to Nv2 protocol. Clients should now connect using Nv2 protocol. wireless-protocol=Nv2 in case of some trouble you can easily switch back to previous protocol by simply changing it back to whatever was used before on AP. fine tune Nv2 related settings to get acceptable latency and throughput implement QoS policy for maximum performance. The basic troubleshooting guide:

QoS in Nv2 is implemented by means of variable number of priority queues. Queue is considered for transmission based on rule recommended by 802.1D- 2004 - only if all higher priority queues are empty. In practice this means that at first all frames from queue with higher priority will be sent, and only then next queue is considered. Therefore QoS policy must be designed with care so that higher priority queues do not make lower priority queues starve. QoS policy in Nv2 network is controlled by AP, clients adapt policy from AP. On AP QoS policy is configured with and Nv2-queue-count Nv2-qos parameters. parameter specifies number of priority queues used. Mapping of frames to queues is controlled by parameter. Nv2-queue-count Nv2-qos Nv2-qos=default In this mode outgoing frame at first is inspected by built-in QoS policy algorithm that selects queue based on packet type and size. If built-in rules do not match, queue is selected based on frame priority field, as in mode. Nv2-qos=frame-priority Nv2-qos=frame-priority In this mode QoS queue is selected based on frame priority field. Note that frame priority field is not some field in headers and therefore it is valid only while packet is processed by given device. Frame priority field must be set either explicitly by firewall rules or implicitly from ingress priority by frame forwarding process, for example, from MPLS EXP bits. For more information on frame priority field see: EXP bit and MPLS Queuing WMM and VLAN priority Queue is selected based on frame priority according to 802.1D recommended user priority to traffic class mapping. Mapping depends on number of available queues ( parameter). For example, if number of queues is 4, mapping is as follows (pay attention how this mapping resembles Nv2-queue-count mapping used by WMM): priority 0,3 -> queue 0 priority 1,2 -> queue 1 priority 4,5 -> queue 2 priority 6,7 -> queue 3 If number of queues is 2 (default), mapping is as follows: priority 0,1,2,3 -> queue 0 priority 4,5,6,7 -> queue 1 If number of queues is 8 (maximum possible), mapping is as follows: priority 1 -> queue 0 priority 2 -> queue 1 priority 0 -> queue 2 priority 3 -> queue 3 priority 4 -> queue 4 priority 5 -> queue 5 priority 6 -> queue 6 priority 7 -> queue 7 For other mappings, discussion on rationale for these mappings and recommended practices please see 802.1D-2004. Security in Nv2 network Nv2 security implementation has the following features: hardware accelerated data encryption using AES-CCM with 128 bit keys; 4-way handshake for key management (similar to that of 802.11i); preshared key authentication method (similar to that of 802.11i); periodically updated group keys (used for broadcast and multicast data). Being proprietary protocol Nv2 does not use security mechanisms of 802.11, therefore security configuration is different. Interface using Nv2 protocol ignores setting. Instead, security is configured by the following interface settings: security-profile Nv2-security - this setting enables/disables use of security in Nv2 network. Note that when security is enabled on AP, it will not accept clients with disabled security. In the same way clients with enabled security will not connect to unsecure APs.

Nv2-preshared-key - preshared key to use for authentication. Data encryption keys are derived from preshared key during 4-way handshake. Preshared key must be the same in order for 2 devices to establish connection. If preshared key will differ, connection will time out because remote party will not be able to correctly interpret key exchange messages.

Interworking Profiles Interworking Hotspot 2.0 Configuration Properties Information elements in beacon and probe response ANQP elements Realms raw Hotspot 2.0 ANQP elements Other Properties Configuration guide using native RadSec and Orion Wifi: Configuration guide using RadSec proxy and Orion Wifi: Troubleshooting Interworking Interworking is the occurrence of two or more things working together. For a better Wireless network experience information about the network must be exchanged between Access Points and Wireless client devices, the information that can be found in basic Wireless beacons and probe requests is limited. For this reason, the IEEE 802.11u™-2011 (Interworking with External Networks) standard was created, that specifies how devices should exchange information between each other. Network discovery and Access Point selection process can be enhanced with the interworking service. Wireless client devices can have more criteria upon which they can choose the network with which to associate. Hotspot 2.0 Hotspot 2.0 is a specification developed and owned by the Wi-Fi Alliance. It was designed to enable a more cellular-like experience when connecting to Wi- Fi networks. In the attempt to increase Wireless network security Hotspot 2.0 access points use mandatory WPA2 authentication. Hotspot 2.0 relies on Interworking as well as adds some of its own properties and procedures. Interworking profiles are implemented according to IEEE 802.11u and Hotspot 2.0 Release 1 specifications. Configuration Properties Sub-menu: /interface wireless interworking-profiles Information elements in beacon and probe response Some information can be added to beacon and probe response packets with a Interworking element. Following parameters of a Interworking element can be configured: Property Description asra ( ; Default: ) yes | no no Additional Steps Required for Access. Set to , if a user should take additional steps to access the internet, yes like the walled garden. esr ( ; Default: ) yes | no no Emergency services reachable (ESR). Set to in order to indicate that emergency services are reachable yes through the access point. hessid ( ; Default: ) MAC address Homogenous extended service set identifier (HESSID). Devices that provide access to same external networks are in one homogenous extended service set. This service set can be identified by HESSID that is the same on all access points in this set. 6-byte value of HESSID is represented as MAC address. It should be globally unique, therefore it is advised to use one of the MAC address of access point in the service set. This manual page describes the configuration of the regular wireless package, the same parameters are available in the WifiWave2 package as well.

internet ( ; Default: ) yes | no yes Whether the internet is available through this connection or not. This information is included in the Interworking element. network-type (emergency-only | personal-device | private | private- with-guest | public-chargeable | ; Default: public-free | test | wildcard ) wildcardInformation about network access type. emergency-only - a network dedicated and limited to accessing emergency services; personal-device - a network of personal devices. An example of this type of network is a camera that is attached to a printer, thereby forming a network for the purpose of printing pictures; private - network for users with user accounts. Usually used in enterprises for employees, not guests; private-with-guest - same as private, but guest accounts are available; public-chargeable - a network that is available to anyone willing to pay. For example, a subscription to Hotspot 2.0 service or in-room internet access in a hotel; public-free - network is available to anyone without any fee. For example, municipal network in city or airport Hotspot; test - network used for testing and experimental uses. Not used in production; wildcard - is used on Wireless clients. Sending probe request with a wildcard as network type value will make all Interworking Access Points respond despite their actual network-type setting. A client sends a probe request frame with network-type set to value it is interested in. It will receive replies only from access points with the same value (except the case of wildcard). uesa ( ; Default: ) yes | no no Unauthenticated emergency service accessible (UESA). no - indicates that no unauthenticated emergency services are reachable through this Access Point; yes - indicates that higher layer unauthenticated emergency services are reachable through this Access Point. venue ( ; Default: ) venue unspecified Specify the venue in which the Access Point is located. Choose the value from available ones. Some examples: venue=business-bank venue=mercantile-shopping-mall venue=educational-university-or-college ANQP elements Access network query protocol (ANQP). Not all necessary information is included in probe response and beacon frames. For client device to get more information before choosing access point to associate with ANQP is used. The Access Point can have stored information in multiple ANQP elements. Client device will use ANQP to query only for the information it is interested in. This reduces the time needed before association. Property Description 3gpp-raw ( ; Default: ) octet string in hex Cellular network advertisement information - country and network codes. This helps Hotspot 2.0 clients in the selection of an Access Point to access 3GPP network. Please see 3GPP TS 24.302. (Annex H) for a format of this field. This value is sent ANQP response if queried. 3gpp-info ( ; Default: ) number/number Cellular network advertisement information - country and network codes. This helps Hotspot 2.0 clients in the selection of an Access Point to access 3GPP network. Written as "mcc /mnc". Usage is identical to "3gpp-raw", but without using hex. Multiple mcc/mnc pairs can be defined, by separating them with a comma. authentication-types (dns-redirection: | https-url redirection: | online-enrollment: | terms- url url ; Default: ) and-conditions:urlThis property is only effective when asra is set to . Value of is optional and not yes url needed if or is selected. To set the value of to dns-redirection online-enrollment url empty string use double quotes. For example: authentication-types=online-enrollment:""

connection-capabilities (number:number: ; Default: ) closed|open|unknownThis option allows to provide information about the allowed IP protocols and ports. This information can be provided in ANQP response. The first number represents the IP protocol number, the second number represents a port number. closed - set if protocol and port combination is not allowed; open - set if protocol and port combination is allowed; unknown - set if protocol and port combination is either open or closed. Example: connection-capabilities=6:80:open,17:5060:closed Setting such a value on an Access Point informs the Wireless client, which is connecting to the Access Point, that HTTP (6 - TCP, 80 - HTTP) is allowed and VoIP (17 - UDP; 5060 - VoIP) is not allowed. This property does not restrict or allow usage of these protocols and ports, it only gives information to station device which is connecting to Access Point. domain-names ( ; Default: ) list of strings None or more fully qualified domain names (FQDN) that indicate the entity operating the Hotspot. A station that is connecting to the Access Point can request this AQNP property and check if there is a suffix match with any of the domain names it has credentials to. ipv4-availability (double-nated | not-available | port- restricted | port-restricted-double-nated | port- restricted-single-nated | public | single-nated | ; Default: ) unknown not-availableInformation about what IPv4 address and access are available. not-available - Address type not available; public - public IPv4 address available; port-restricted - port-restricted IPv4 address available; single-nated - single NATed private IPv4 address available; double-nated - double NATed private IPv4 address available; port-restricted-single-nated -port-restricted IPv4 address and single NATed IPv4 address available; port-restricted-double-nated - port-restricted IPv4 address and double NATed IPv4 address available; unknown - availability of the address type is not known. ipv6-availability (available | not-available | unknown ; Default: ) not-availableInformation about what IPv6 address and access are available. not-available - Address type not available; available - address type available; unknown - availability of the address type is not known. realms (string:eap-sim|eap-aka|eap-tls|not- ; Default: ) specifiedInformation about supported realms and the corresponding EAP method. realms=example.com:eap-tls,foo.ba:not-specified realms-raw ( ; Default: ) octet string in hex Set NAI Realm ANQP-element manually. roaming-ois ( ; Default: ) octet string in hex Organization identifier (OI) usually are 24-bit is unique identifiers like organizationally unique identifier (OUI) or company identifier (CID). In some cases, OI is longer for example OUI-36. A subscription service provider (SSP) can be specified by its OI. roaming-ois property can contain zero or more SSPs OIs whose networks are accessible via this AP. Length of OI should be specified before OI itself. For example, to set E4-8D-8C and 6C-3B-6B: roaming-ois=03E48D8C036C3B6B venue-names ( ; Default: ) string:lang Venue name can be used to provide additional info on the venue. It can help the client to choose a proper Access Point. Venue-names parameter consists of zero or more duple that contain Venue Name and Language Code: venue-names=CoffeeShop:eng,TiendaDeCafe:es The Language Code field value is a two or three-character 8 language code selected from ISO-639. Realms raw

realms-raw - list of strings with hex values. Each string specifies contents of "NAI Realm Tuple", excluding "NAI Realm Data Field Length" field. Each hex encoded string must consist of the following fields: - NAI Realm Encoding (1 byte) - NAI Realm Length (1 byte) - NAI Realm (variable) - EAP Method Count (1 byte) - EAP Method Tuples (variable) For example, value "00045465737401020d00" decodes as: - NAI Realm Encoding: 0 (rfc4282) - NAI Realm Length: 4 - NAI Realm: Test - EAP Method Count: 1 - EAP Method Length: 2 - EAP Method Tuple: TLS, no EAP method parameters Note, that setting "realms-raw=00045465737401020d00" produces the same advertisement contents as setting "realms=Test:eap-tls". Refer to 802.11-2016, section 9.4.5.10 for full NAI Realm encoding. Hotspot 2.0 ANQP elements Hotspot 2.0 specification introduced some additional ANQP elements. These elements use an ANQP vendor specific element ID. Here are available properties to change these elements. Property Description hotspot20 ( ; Default: ) yes | no yes Indicate Hotspot 2.0 capability of the Access Point. hotspot20-dgaf ( ; Default: ) yes | no yes Downstream Group-Addressed Forwarding (DGAF). Sets value of DGAF bit to indicate whether multicast and broadcast frames to clients are disabled or enabled. yes - multicast and broadcast frames to clients are enabled; no - multicast and broadcast frames to clients are disabled. To disable multicast and broadcast frames set . multicast-helper=full operational-classes ( ; list of numbers Default: )Information about other available bands of the same ESS. operator-names ( ; Default: string:lang )Set operator name. Language must be specified for each operator name entry. Operator-names parameter consists of zero or more duple that contain Operator Name and Language Code: operator-names=BestOperator:eng,MejorOperador:es The Language Code field value is a two or three-character 8 language code selected from ISO-639. wan-at-capacity ( ; Default: ) yes | no no Whether the Access Point or the network is at its max capacity. If set to no additional mobile devices yes will be permitted to associate to the AP. wan-downlink ( ; Default: ) number 0 The downlink speed of the WAN connection set in kbps. If the downlink speed is not known, set to 0. wan-downlink-load ( ; Default: number 0 )The downlink load of the WAN connection measured over . Values from 0 wan-measurement-duration to 255. 0 - unknown; 255 - 100%. wan-measurement-duration ( ; number Default: ) 0Duration during which wan-downlink-load and are measured. Value is a numeric value wan-uplink-load from 0 to 65535 representing tenths of seconds. 0 - not measured; 10 - 1 second; 65535 - 1 hour 49 minutes or more.

Once certificates are imported, they should look like this: 2) Configure the Radius client

Command line equivalent: "/radius add address=216.239.32.91 certificate=cert.pem_0 protocol=radsec service=wireless timeout=1s500ms" 3) Create a wireless security profile that would perform 802.1x authentication

Command line equivalent is “/interface wireless security-profiles add authentication-types=wpa2-eap management-protection=allowed mode=dynamic- “. keys name=dot1x_profile supplicant-identity="" radius-eap-accounting=yes eap-methods=passthrough 4) The next step is configuring the wireless interface and assigning the created security profile. Press “Advanced mode” to see all the options.

Command line equivalent is: " ". /interface wireless set [ find default-name=wlan1 ] mode=ap-bridge security-profile=dot1x_profile wps-mode=disabled Make sure the correct country profile is configured. In this example, we are using “wlan1”, but the same command would work with other interfaces, or as “ /i ”. nterface wireless set wlan1 5) Configure interworking settings (hotspot 2.0 ).

Command line equivalent is ” “/radius add address=192.168.88.233 secret=yourSecret service=wireless timeout=1s500ms The secret should match the one configured on the radsecproxy, in this example “192.168.88.233” is a virtual machine running the proxy. 2) Create a wireless security profile that would perform 802.1x authentication

Command line equivalent is “/interface wireless security-profiles add authentication-types=wpa2-eap management-protection=allowed mode=dynamic- “. keys name=dot1x_profile supplicant-identity="" radius-eap-accounting=yes eap-methods=passthrough 3) The next step is configuring the wireless interface and assigning the created security profile. Press “Advanced mode” to see all the options.

Command line equivalent is: " ". /interface wireless set [ find default-name=wlan1 ] mode=ap-bridge security-profile=dot1x_profile wps-mode=disabled Make sure the correct country profile is configured. In this example, we are using “wlan1”, but the same command would work with other interfaces, or as “ /i ”. nterface wireless set wlan1 4) Configure interworking settings (hotspot 2.0 ).

Wireless Case Studies In This Section

Commands executed on device running User Manager # Generating a Certificate Authority /certificate add name=radius-ca common-name="RADIUS CA" key-size=secp384r1 digest-algorithm=sha384 days-valid=1825 key- usage=key-cert-sign,crl-sign sign radius-ca ca-crl-host=radius.mikrotik.test # Generating a server certificate for User Manager add name=userman-cert common-name=radius.mikrotik.test subject-alt-name=DNS:radius.mikrotik.test key- size=secp384r1 digest-algorithm=sha384 days-valid=800 key-usage=tls-server sign userman-cert ca=radius-ca # Generating a client certificate add name=maija-client-cert common-name=maija@mikrotik.test key-usage=tls-client days-valid=800 key- size=secp384r1 digest-algorithm=sha384 sign maija-client-cert ca=radius-ca # Exporting the public key of the CA as well as the generated client private key and certificate for distribution to client devices export-certificate radius-ca file-name=radius-ca # A passphrase is needed for the export to include the private key export-certificate maija-client-cert type=pkcs12 export-passphrase="true zebra capacitor ziptie" Configuring User Manager Commands executed on device running User Manager # Enabling User Manager and specifying, which certificate to use /user-manager set enabled=yes certificate=userman-cert # Enabling CRL checking to avoid accepting revoked user certificates /certificate settings set crl-download=yes crl-use=yes # Adding access points /user-manager router add name=ap1 address=10.0.0.11 shared-secret="Use a secure password generator for this" add name=ap2 address=10.0.0.12 shared-secret="Use a secure password generator for this too" # Limiting allowed authentication methods /user-manager user group set [find where name=default] outer-auths=eap-tls,eap-peap add name=certificate-authenticated outer-auths=eap-tls # Adding users /user-manager user add name=maija@mikrotik.test group=certificate-authenticated add name=paija@mikrotik.test group=default password="right mule accumulator nail" Configuring access points AP running regular wireless package

Commands executed on ap1 # Configuring radius client /radius add address=10.0.0.10 secret="Use a secure password generator for this" service=wireless timeout=1s /radius incoming set accept=yes # Adding a security profile and applying it to wireless interfaces /interface/wireless/security-profile add name=radius mode=dynamic-keys authentication-types=wpa2-eap /interface/wireless set [find] security-profile=radius AP running wifiwave2 package Commands executed on ap2 # Configuring radius client /radius add address=10.0.0.10 secret="Use a secure password generator for this too" service=wireless timeout=1s /radius incoming set accept=yes # Configuring enabled authentication types. Can also be done via a security profile, but note that interface properties, if specified, override profile properties /interface/wifiwave2 set [find] security.authentication-types=wpa2-eap,wpa3-eap A wifiwave2 AP can also be configured to use the extra secure wpa3-eap-192 mode, but note that it requires that all client devices support the GCMP-256 cipher and use EAP-TLS authentication. Notes on client device configuration Windows When manually installing a CA in Windows, make sure to explicitly place it in the 'Trusted Root Certification Authorities' certificate store. It will not be placed there automatically. Android When connecting to a network with EAP authentication, Android devices ask the user to specify a 'domain'. This refers to the expected domain of the host name included in the RADIUS server's TLS certificate ( 'mikrotik.test' in our example). By default, Android devices use the device's built-in root CA list for validating the RADIUS server's certificate. When using your own CA, it needs to be selected in the appropriate dropdown menu. iOS Apple iOS does not appear to actually trust a manually imported CA to authenticate RADIUS servers. The server certificate is marked as 'Not Trusted' unless the CA was imported using Apple's proprietary 'Configurator' utility or an approved third party MDM tool.

VLANs on Wireless Summary VLANs provide the possibility to isolate devices into different Layer2 segments while still using the same Layer1 medium. This is very useful in setups where you want to separate different types of devices of users. This feature is also very useful for Wireless setups since you can isolate different Virtual APs and restricting access to certain services or networks by using Firewall. Below is an example with a setup with two Access Points on the same device that isolates them into saparate VLANs. This kind of scenario is very common when you have a and . Guest AP Work AP Example Bridge VLAN Filtering since RouterOS v6.41 provides VLAN aware Layer2 forwarding and VLAN tag modifications within the bridge. R1: Add necessary VLAN interfaces on ethernet interface to make it a VLAN trunk port. Add ip addresses on VLAN interfaces. [admin@R1] > /interface vlan add interface=ether1 name=vlan111 vlan-id=111 add interface=ether1 name=vlan222 vlan-id=222 /ip address add address=192.168.1.1/24 interface=vlan111 add address=192.168.2.1/24 interface=vlan222 R2: Add VirtualAP under wlan1 interface and create wireless security-profiles for wlan1 and wlan2 [admin@R2] > /interface wireless set [ find default-name=wlan1 ] disabled=no mode=ap-bridge security-profile=vlan111 ssid=vlan111 vlan-id=111 vlan-mode=use-tag add disabled=no master-interface=wlan1 name=wlan2 security-profile=vlan222 ssid=vlan222 vlan-id=222 vlan- mode=use-tag

Create bridge with vlan-filtering=yes Add necessary bridge ports Add interfaces under section with correct tagged interface bridge vlan vlan-ids [admin@R2] > /interface bridge add fast-forward=no name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=wlan1 add bridge=bridge1 interface=wlan2 /interface bridge vlan add bridge=bridge1 tagged=ether2,wlan1 vlan-ids=111 add bridge=bridge1 tagged=ether2,wlan2 vlan-ids=222 R3: Add IP address on wlan1 interface. Create wireless security-profile compatible with R2 wlan1. [admin@R3] > /ip address add address=192.168.1.3/24 interface=wlan1 /interface wireless set [ find default-name=wlan1 ] disabled=no security-profile=vlan111 R4: Add IP address on wlan1 interface. Create wireless security-profile compatible with R2 wlan2. [admin@R4] > /ip address add address=192.168.2.4/24 interface=wlan1 /interface wireless set [ find default-name=wlan1 ] disabled=no security-profile=vlan222 It is important to set wlan1,wlan2 vlan-mode to "use-tag". Some devices have a built-in switch chip that can switch packets between Ethernet ports with wire-speed performance. Bridge VLAN filtering disables hardware offloading (except on CRS3xx series switches), which will prevent packets from being switched, this does not affect Wireless interfaces as traffic through them cannot be offloaded to the switch chip either way. VLAN filtering is not required in this setup, but is highly recommended due to security reasons. Without VLAN filtering it is possible to forward unknown VLAN IDs in certain scenarios. Disabling VLAN filtering does have performance benefits.

Wireless Station Modes Overview 802.11 limitations for L2 bridging Applicability Matrix Mode station Mode station-wds Mode station-pseudobridge Mode station-pseudobridge-clone Mode station-bridge Overview Wireless interface in any of modes will search for acceptable access point (AP) and connect to it. The connection between station and AP will station behave in slightly different way depending on type of mode used, so correct mode must be chosen for given application and equipment. This article station attempts to describe differences between available modes. station Primary difference between modes is in how L2 addresses are processed and forwarded across wireless link. This directly affects the ability of station wireless link to be part of L2 bridged infrastructure. If L2 bridging over wireless link is not necessary - as in case of routed or MPLS switched network, basic setup is suggested and will provide mode=station highest efficiency. Availability of particular mode depends on that is used in wireless network. Please refer to for information on station wireless-protocol applicability matrix mode support in protocols. It is possible that connection between station and AP will be established even if particular mode is not supported for given protocol. Beware that such connection will not behave as expected with respect to L2 bridging. 802.11 limitations for L2 bridging Historically 802.11 AP devices were supposed to be able to bridge frames between wired network segment and wireless, but station device was not supposed to do L2 bridging. Consider the following network: [X]---[AP]-( )-[STA]---[Y] where X-to-AP and STA-to-Y are ethernet links, but AP-to-STA are connected wirelessly. According to 802.11, AP can transparently bridge traffic between X and STA, but it is not possible to bridge traffic between AP and Y, or X and Y. 802.11 standard specifies that frames between station and AP device must be transmitted in so called frame format, meaning that header of 3 address frame contains 3 MAC addresses. Frame transmitted from AP to station has the following addresses: destination address - address of station device, also radio receiver address radio transmitter address - address of AP source address - address of originator of particular frame Frame transmitted from station to AP has the following addresses: radio receiver address - address of AP source address - address of station device, also radio transmitter address destination address Considering that every frame must include radio transmitter and receiver address, it is clear that frame format is not suitable for transparent L2 3 address bridging over station, because station can not send frame with source address different from its address - e.g. frame from Y, and at the same time AP can not format frame in a way that would include address of Y. 802.11 includes additional frame format, so called frame format, intended for "wireless distribution system" (WDS) - a system to interconnect 4 address APs wirelessly. In this format additional address is added, producing header that contains the following addresses: radio receiver address radio transmitter address destination address source address

This frame format includes all necessary information for transparent L2 bridging over wireless link. Unluckily 802.11 does not specify how WDS connections should be established and managed, therefore any usage of frame format (and WDS) is implementation specific. 4 address Different modes attempt to solve shortcomings of standard station mode to provide support for L2 bridging. station Applicability Matrix The following matrix specifies modes available for each . Note that there are 2 columns for 802.11 protocol: specifies station wireless-protocol 802.11 availability of mode in "pure" 802.11 network (when connecting to any vendor AP) and specifies availability of mode when connecting to ROS 802.11 RouterOS AP that implements necessary proprietary extensions for mode to work. Table applies to RouterOS v5rc11 and above: 802.11 ROS 802.11 nstreme nv2 station V V V V station-wds V V V station-pseudobridge V V V station-pseudobridge-clone V V V station-bridge V V V Mode station This is standard mode that does not support L2 bridging on station - attempts to put wireless interface in bridge will not produce expected results. On the other hand this mode can be considered the most efficient and therefore should be used if L2 bridging on station is not necessary - as in case of routed or MPLS switched network. This mode is supported for all wireless protocols. Mode station-wds This mode works only with RouterOS APs. As a result of negotiating connection, separate WDS interface is created on AP for given station. This interface can be thought of point-to-point connection between AP and given station - whatever is sent out WDS interface is delivered to station (and only to particular station) and whatever station sends to AP is received from WDS interface (and not subject to forwarding between AP clients), preserving L2 addresses. This mode is supported for all wireless protocols except when 802.11 protocol is used in connection to non-RouterOS device. Mode uses frame 4 address format when used with 802.11 protocol, for other protocols (such as nstreme or nv2), protocol internal means are used. This mode is safe to use for L2 bridging and gives most administrative control on AP by means of separate WDS interface, for example use of bridge firewall, RSTP for loop detection and avoidance, etc. With station-wds mode, it is not possible to connect to CAPsMAN controlled CAP. Mode station-pseudobridge From the wireless connection point of view, this mode is the same as standard station mode. It has limited support for L2 bridging by means of some services implemented in station: MAC address translation for IPv4 packets - station maintains IPv4-to-MAC mapping table and replaces source MAC address with its own address when sending frame to AP (in order to be able to use frame format), and replaces destination MAC address with address from mapping 3 address table for frames received from AP. IPv4-to-MAC mappings are built also for VLAN encapsulated frames. single MAC address translation for the rest of protocols - station learns source MAC address from first forwarded non-IPv4 frame and uses it as default for reverse translation - this MAC address is used to replace destination MAC address for frames received from AP if IPv4-to-MAC mapping can not be performed (e.g. - non-IPv4 frame or missing mapping). This mode is limited to complete L2 bridging of data to single device connected to station (by means of single MAC address translation) and some support for IPv4 frame bridging - bridging of non-IP protocols to more than one device will not work. Also MAC address translation limits access to station device from AP side to IPv4 based access - the rest of protocols will be translated by single MAC address translation and will not be received by station itself.

Entered TKIP countermeasures state, this means that Station will disconnect from AP and keep silence for 60s. AP MODE <DEV>: radar detected on <FREQ> Radar detected on frequency <FREQ>, AP will look for other channel <DEV>: data from unknown device <MAC>, sent deauth [(XXX events suppressed, YYY deauths suppressed)] Data frame from unknown device (read - not registered to this AP) with mac address <MAC> received, AP sent deauthentication frame to it (as per 802.11). XXX is number of events that are not logged so that the log does not become too large (logs are limited to 1 entry per 5s after first 5 entries), YYY is the number of deauthentication frames that should have been sent, but were not sent, so that resources are not wasted sending too many deauthentication frames (only 10 deauth frames per second are allowed). The likely cause of such a message is that the Station previously connected to the AP, which does not yet know it has been dropped from AP registration table, sending data to AP. Deauthentication message tells the Station that it is no longer connected. <DEV>: denying assoc to <MAC>, failed to setup compression Failed to initialize compression on AP, most likely because there are too many clients attempting to connect and use compression. <DEV>: <MAC> is new WDS master WDS slave has established connection to WDS master, this means that WDS slave starts accepting clients and acting as AP. <DEV>: <MAC> was WDS master This message appears after connection with <MAC> is lost, means that WDS slave will disconnect all clients and start scanning to find new WDS master. <MAC>@<DEV>: connected [, is AP][, wants WDS] Station with address <MAC> connected. if "is AP" present - remote device is AP, if "is WDS" presents, remote device wants to establish WDS link. <MAC>@<DEV>: disconnected, <REASON> Connection with Station with address <MAC> terminated due to <REASON> <DEV>: TKIP countermeasures over, resuming TKIP countermeasures (60s silence period) over, AP resumes acting as AP. <DEV>: starting TKIP countermeasures Entering TKIP countermeasures state (60s silence period), all clients will be lost. <REASON> "joining failed" - can only happen on Prism cards in station mode, failed to connect to AP due to some reason "join timeout" - happens on Station, failed to synchronize to AP (receive first beacon frame). Most likely weak signal, remote turned off, strong interference, some other RF related issue that makes communication impossible. "no beacons" - no beacons received from remote end of WDS link. Most likely weak signal, remote turned off, strong interference, some other RF related issue that makes communication impossible. "extensive data loss" - local interface decided to drop connection to remote device because of inability to send data to remote after multiple failures at lowest possible rate. Possible causes - too weak signal, remote device turned off, strong interference, some other RF related issue that makes communication impossible.

"decided to deauth, <802.11 reason>" - local interface decided do deauthenticate remote device using 802.11 reason <802.11 reason>. "inactivity" - remote device was inactive for too long "device disabled" - local interface got disabled "got deauth, <802.11 reason>" - received deauthentication frame from remote device, 802.11 reason code is reported in <802.11 reason> "got disassoc, <802.11 reason>" - received disassociation frame from remote device, 802.11 reason code is reported in <802.11 reason> "auth frame from AP" - authentication frame from remote device that is known to be AP, most likely mode changes on remote device from AP to Station. "bad ssid" - bad ssid for WDS link "beacon from non AP" - received beacon frame from remote device that is known to be non-AP node, most likely mode changes on remote device from Station to AP. "no WDS support" - does not report WDS support "failed to confirm SSID" - failed to confirm SSID of other end of WDS link. "hardware failure" - some hardware failure or unexpected behavior. Not likely to be seen. "lost connection" - can only happen on Prism cards in station mode, connection to AP lost due to some reason. "auth failed <802.11 status>" - happens on Station, AP denies authentication, 802.11 status code is reported in <802.11 status>. "assoc failed <802.11 status>" - happens on Station, AP denies association, 802.11 status code is reported in <802.11 status>. "auth timeout" - happens on Station, Station does not receive response to authentication frames, either bad link or AP is ignoring this Station for some reason. "assoc timeout" - happens on Station, Station does not receive response to association frames, either bad link or AP is ignoring this Station for some reason. "reassociating" - happens on AP: connection assumed to be lost, because Station that is considered already associated attempts to associate again. All connection related information must be deleted, because during association process connection parameters are negotiated (therefore "disconnected"). The reason why Station reassociates must be looked for on Station (most likely cause is that Station for some reason dropped connection without telling AP - e. g. data loss, configuration changes). "compression setup failure" - connection impossible, because not enough resources to do compression (too many stations that want to use compression already connected) "control frame timeout" - AP was unable to transmit to the client (similar to error message that you see in the 802.11 protocol - extensive data loss) <802.11 reason> and <802.11 status> These are numeric reason/status codes encoded into 802.11 management messages. Log messages include numeric code and textual description from appropriate standard in 802.11 standards group. Although these are intended to be as descriptive as possible, it must be taken into account that actual reason/status code that appears in management frames depends solely on equipment or software manufacturer - where one device sends 802.11 management frame including proper reason/status code for situation that caused the frame, other may send frame with "unspecified" reason/status code. Therefore reason/status code should only be considered informational. As 802.11 standards evolve, RouterOS may miss textual descriptions for reason/status codes that some devices use. In such case numeric value should be used to lookup meaning in 802.11 standards. In order to properly interpret reason/status code, good understanding of 802.11 group standards is necessary. Most of the textual descriptions are self- explaining. Explanation for some of most commonly seen reson/status codes follows. class 2 frame received (6) - device received "class 2" frame (association/reassociation management frame) before completing 802.11 authentication process; class 3 frame received (7) - device received "class 3" frame (data frame) before completing association process; Wireless FAQ

Number of times sending frame is retried without considering it a transmission failure. The data rate is decreased upon failure and frame is sent again. Three sequential failures on lowest supported rate suspend transmission to this destination for the duration of . After that, the frame is sent on-fail-retry-time again. The frame is being retransmitted until transmission success, or until the client is disconnected after . The frame can be discarded disconnect-timeout during this time if is exceeded. In case of Nstreme "on-fail-retry-time", "disconnect-timeout" and "frame-lifetime" settings are not used. So frame-lifetime after three sequential failures on the lowest supported rate, the wireless link is disconnected with "extensive data loss" message. What is disconnect-timeout setting? This interval is measured from the third sending failure on the lowest data rate. At this point 3 * ( + 1) frame transmits on the lowest data rate had hw-retries failed. During packet transmission will be retried with interval. If no frame can be transmitted successfully during disconnect-timeout on-fail-retry-time discon , the connection is closed, and this event is logged as "extensive data loss". Successful frame transmission resets this timer. nect-timeout What is adaptive-noise-immunity setting? Adaptive Noise Immunity (ANI) adjusts various receiver parameters dynamically to minimize interference and noise effect on the signal quality. This setting is added in the wireless driver for Atheros AR5212 and newer chipset cards How does wireless device measure signal strength, when access-list or connect-list are used ? The reported signal level is exponentially weighted moving average with a smoothing factor of 50%. What error correction methods are supported in the RouterOS wireless? ARQ method is supported in nstreme protocols. Regular 802.11 standard does not include ARQ - retransmission of corrupt frames is based on acknowledgment protocol. RouterOS supports forward error correction coding (convolutional coding) with coding rates: 1/2, 2/3, or 3/4. Configuring RouterOS device for 160MHz use If the RouterOS device supports 4x4 transmission, additionally to setting 160MHz channel width, make sure to set "rate-set=default" on the wireless interface so all streams are available If the client does not support Extended NSS and can only perform 2x2 transmission, set "vht-supported-mcs=mcs0-9,mcs0-9,none" Setups Will an amplifier improve the speed on my link? It depends on your signal quality and noise. Remember that you can probably get a better link with low output power setting, and a good antenna. An amplifier increases the noise and will only cause problems with the link. The amplifier gets a boost on both the transmitted received signal. Thus, in "silent" areas, where you are alone or with very few "noise" or and "competition", you might get excellent results. On the other side, in crowded areas, with lots of wireless activity, you will also increase signal received from every other competitor or noise source, which may dramatically lower the overall quality of the link. Also, take in account the EIRP to see if your link remains in legal limits. You could also get a better signal on "11b only" radios, which see most of 802.11g as "noise", thus filtering better the usable signal. How to fine-tune the wireless link with hw-retries? You should understand that for 802.11 devices there is a really limited amount of information (or "feedback" from the environment) that devices can use to tune their behavior: signal strength, which could be used to figure out best transmit rate knowing receiver sensitivity. Sill this is not reliable taking into account that sensitivity for different receivers varies (e.g. changes over time), path conditions are not symmetric (and device can only measure signal strength it receives), etc. by receiving/not receiving acknowledgment for frame sent. Taking into account that using signal strength is not reliable, 802.11 devices are essentially left with only one "feedback" to tune its operation - success /failure of transmission. When transmission fails (ACK not received in time), there is no way how sender can figure out why it failed - either because of noise, multipath, direct interference (and whether that disturbed actual data frame or the ACK itself) - frame just did not make it and in general it does not matter "why". All that matters is the packet error rate. Therefore RouterOS implements an algorithm to try to use medium most efficiently in any environment by using only this limited information, giving users the ability to control how the algorithm works and describing the algorithm. And there are only a few usage guidelines, not a set of values you should use in a particular situation.

In general - the larger , the better "feedback" device gets about medium ability to deliver frame at particular rate (e.g. if sending frame with rate hw-retries 54mbps fails 16 times, it is telling you more than if it fails with 2 retries) and the better it can figure out optimal transmit rate, at the expense of latency it can introduce in network - because during all those failing retries, other devices in this channel cannot send. So can be suggested for ptp bigger hw-retries backbone links - where it is known that link must be always on. make rate selection adapt faster at the expense of some accuracy (going Less hw-retries below 2 is not reasonable in most cases), this can be suggested for ptmp links, where it is normal for links to connect/disconnect and keeping latency down is important. on-fail-retry-time and controls how hard device will try to consider remote party "connected". Larger will make the disconnect-timeout disconnect-timeout device not "disconnect" other party, even if there are lots of loss at the smallest possible transmission rate. This again is most useful for "weak" links that are known that they "must" be established (e.g. backbone links). In ptmp networks large will again increase latency in the network disconnect-timeout during the time e.g. AP will attempt to send data to some client that has just been disabled (AP will try to do this for the whole ). disconnect-timeout frame-lifetime allows to tune for how long AP is attempting to use frame for transmitting before considering that it is not worth delivering it (for example, if sending frame fails at lowest possible rate, timer is enabled, if during this timer expires, particular frame is dropped and the on-fail-retry-time frame-lifetime next transmission attempt will happen with the next frame. Disabled means that wireless will ensure in order delivery of "all" data frames, no frame-lifetime matter how long it takes, "or" will drop the connection if everything fails). This allows optimizing for different types of traffic e.g. for real-time traffic - if the primary use of the wireless network is e.g. voip, then it can be reasonable to limit , because voip tolerates small loss better than high latency. frame-lifetime Is it possible to use the wireless repeater only with one radio interface? This setup it possible by using WDS on the wireless interface which is running in ap-bridge mode. And in newer RouterOS versions it is possible to configure wireless repeater mode. Nv2 wireless link disconnects very often When Nv2 wireless link experiences disconnections and in log section most of the messages are 'control frame timeout', you can try to lower the transmit output power of the wireless cards if the signal of the link is strong. We suggest using tx-power-mode=card-rates for lowering the tx-power of the wireless card. If the problem continues to try to use a different wireless frequency that might have less interference. If that also didn't help, please contact support@ with a support output file from the affected AP and the Station which are made after those disconnections. mikrotik.com

CAPsMAN with VLANs Summary Using Local Forwarding Mode CAPsMAN Router: Switch: CAPs: Using CAPsMAN Forwarding Mode CAPsMAN router: CAPs: Case studies Without Virtual APs Summary It is possible to create a centralized Access Point management setup for a home or office environment that is scalable to many Access Points, such a setup is quite easy to configure and has been explained in the guide, but for more complex setups VLANs might be required. Simple CAPsMAN setup CAPsMAN has the functionality to assign a certain VLAN ID under certain conditions. This guide will provide an example on how to assign a VLAN ID to Wireless packets based on the AP, to which a wireless client connects to. CAPsMAN with VLANs can be achieved either by using Local Forwarding Mode or , the Local Forwarding Mode will provide the possibility to use a switch between your APs and CAPsMAN router to switch CAPsMAN Forwarding Mode packets (to achieve larger throughput), while CAPsMAN Forwarding Mode should be used when all traffic should always be forwarded to the CAPsMAN router (in most cases to filter packets). In this example, we are going to assign all our Wireless clients to , if they connect to , and going to assign Wireless clients to , VLAN10 WiFi_WORK VLAN20 if they connect to . We are going to use Virtual APs along with CAPsMAN to create multiple SSIDs for our Wireless clients to connect to while WiFi_GUEST using a single physical device. An example of how to use a single SSID for a single physical device will also be shown by using CAPsMAN provisioning rules. Using Local Forwarding Mode

In Local Forwarding Mode, the CAPsMAN router is distributing the configuration across all CAPs that are being provisioned by the CAPsMAN router. In Local Forwarding Mode traffic is not required to be sent to the CAPsMAN router, rather it can be sent to a different router without involving the CAPsMAN router when forwarding traffic. This mode allows you to tag traffic to a certain VLAN ID before it is sent to your network from your Wireless client, which adds the possibility to use a switch to limit certain VLAN IDs to certain ports. In Local Forwarding Mode traffic is not encapsulated with a special CAPsMAN header, which can only be removed by a CAPsMAN router. CAPsMAN Router: Create appropriate CAP configurations for each VLAN /caps-man configuration add country=latvia datapath.local-forwarding=yes datapath.vlan-id=10 datapath.vlan-mode=use-tag name=Config_WORK security.authentication-types=wpa-psk,wpa2-psk \ security.passphrase=secret_work_password ssid=WiFi_WORK add country=latvia datapath.local-forwarding=yes datapath.vlan-id=20 datapath.vlan-mode=use-tag name=Config_GUEST security.authentication-types=\ wpa-psk,wpa2-psk security.passphrase=secret_guest_password ssid=WiFi_GUEST We are going to create a single CAPsMAN provisioning rule to create the and the SSIDs on a single device, each WiFi_WORK WiFi_GUEST connected CAP is going to create these SSIDs automatically /caps-man provisioning add action=create-dynamic-enabled master-configuration=Config_WORK slave-configurations=Config_GUEST For security reasons, limit the CAPsMAN to a single interface /caps-man manager interface set [ find default=yes ] forbid=yes add disabled=no interface=ether1 Enable the CAPsMAN manager /caps-man manager set enabled=yes Setup DHCP Server for each VLAN /interface vlan add interface=ether1 name=VLAN10 vlan-id=10 add interface=ether1 name=VLAN20 vlan-id=20 /ip address add address=192.168.10.1/24 interface=VLAN10 add address=192.168.20.1/24 interface=VLAN20 /ip pool add name=dhcp_pool10 ranges=192.168.10.2-192.168.10.254 add name=dhcp_pool20 ranges=192.168.20.2-192.168.20.254 /ip dhcp-server add address-pool=dhcp_pool10 disabled=no interface=VLAN10 name=dhcp10 add address-pool=dhcp_pool20 disabled=no interface=VLAN20 name=dhcp20 /ip dhcp-server network add address=192.168.10.0/24 dns-server=8.8.8.8 gateway=192.168.10.1 add address=192.168.20.0/24 dns-server=8.8.8.8 gateway=192.168.20.1 Switch: In this example, we are going to be using to filter unknown VLANs and to assign other devices to the same networks. Some devices Bridge VLAN Filtering are capable of offloading this to the built-in switch chip, check guide to see how to configure it on different types of devices. Basic VLAN switching Setup Bridge VLAN Filtering You can create even more Virtual APs by adding multiple slave-configurations . That requires multiple CAPsMAN configurations that were created earlier.

/interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 add bridge=bridge1 interface=ether2 add bridge=bridge1 interface=ether3 add bridge=bridge1 interface=ether4 pvid=10 add bridge=bridge1 interface=ether5 pvid=20 /interface bridge vlan add bridge=bridge1 tagged=ether1,ether2,ether3 untagged=ether4 vlan-ids=10 add bridge=bridge1 tagged=ether1,ether2,ether3 untagged=ether5 vlan-ids=20 CAPs: Create a bridge and assign a port to it, that is connected to the CAPsMAN Router /interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=ether1 Enable CAP mode on the AP, and make sure you specify to use the newly created bridge /interface wireless cap set bridge=bridge1 discovery-interfaces=bridge1 enabled=yes interfaces=wlan1 After CAPs are successfully connected to the CAPsMAN Router, the wlan1 (SSID ) and a newly created virtual wlan5 (SSID WiFi_WORK WiFi_GU ) interfaces get dynamically added as bridge ports. The VLAN is assigned for a wireless interface and as a result, all data coming from EST wireless gets tagged and only data with this tag will be sent out over wireless. A bridge vlan-filtering can be disabled if additional VLAN managing and controlling is not needed. The associated VLAN can be seen with a port VLAN ID (PVID) property. [admin@CAP_1] /interface bridge port pr Flags: X - disabled, I - inactive, D - dynamic, H - hw-offload # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH- COST HORIZON 0 H ether1 bridge1 yes 1 0x80 10 10 none 1 D wlan1 bridge1 10 0x80 10 10 none 2 D wlan5 bridge1 20 0x80 10 10 none That is it! Connect Wireless clients to your APs and check connectivity. Using CAPsMAN Forwarding Mode In this example, untagged traffic is going to be used to communicate between CAPs and CAPsMAN Router. By default, if PVID is not changed, untagged traffic is going to be forwarded between ports that have the same PVID value set (including the default PVID).

In CAPsMAN Forwarding Mode all traffic that is coming from a CAP is encapsulated with a special CAPsMAN header, which can only be removed by a CAPsMAN router, this means that a switch will not be able to distinguish the VLAN ID set by the CAP since the VLAN tag is also going to be encapsulated. This mode limits the possibility to divert traffic in Layer2 networks, but gives you the possibility to forward traffic from each CAP over Layer3 networks for a distant CAPsMAN router to process the traffic, this mode is useful when you want to control multiple CAPs in remote locations, but want to use a central gateway. CAPsMAN router: Setup Bridge VLAN filtering to limit interfaces to appropriate VLANs /interface bridge add name=bridge1 vlan-filtering=yes /interface bridge port add bridge=bridge1 interface=ether1 pvid=10 add bridge=bridge1 interface=ether2 pvid=20 /interface bridge vlan add bridge=bridge1 tagged=bridge1 untagged=ether1 vlan-ids=10 add bridge=bridge1 tagged=bridge1 untagged=ether2 vlan-ids=20 Note: CAPsMAN will attach CAP interfaces to the bridge and automatically will add appropriate entries to the bridge VLAN table. This feature is available starting with RouterOS v6.43 Create appropriate CAP configurations for each VLAN CAPsMAN will attach CAP interfaces to the bridge and automatically will add appropriate entries to the bridge VLAN table

/caps-man configuration add country=latvia datapath.bridge=bridge1 datapath.vlan-id=10 datapath.vlan-mode=use-tag name=Config_WORK security.authentication-types=wpa-psk,wpa2-psk \ security.passphrase=secret_work_password ssid=WiFi_WORK add country=latvia datapath.bridge=bridge1 datapath.vlan-id=20 datapath.vlan-mode=use-tag name=Config_GUEST security.authentication-types=wpa-psk,wpa2-psk \ security.passphrase=secret_guest_password ssid=WiFi_GUEST We are going to create a single CAPsMAN provisioning rule to create the and the SSIDs on a single device, each WiFi_WORK WiFi_GUEST connect CAP is going to create these SSIDs automatically /caps-man provisioning add action=create-dynamic-enabled master-configuration=Config_WORK slave-configurations=Config_GUEST For security reasons, limit the CAPsMAN to interfaces. to which CAPs are going to be connected /caps-man manager interface set [ find default=yes ] forbid=yes add disabled=no interface=ether3 add disabled=no interface=ether4 Enable the CAPsMAN manager /caps-man manager set enabled=yes Setup DHCP Server for each VLAN /interface vlan add interface=bridge1 name=VLAN10 vlan-id=10 add interface=bridge1 name=VLAN20 vlan-id=20 /ip address add address=192.168.10.1/24 interface=VLAN10 add address=192.168.20.1/24 interface=VLAN20 /ip pool add name=dhcp_pool10 ranges=192.168.10.2-192.168.10.254 add name=dhcp_pool20 ranges=192.168.20.2-192.168.20.254 /ip dhcp-server add address-pool=dhcp_pool10 disabled=no interface=VLAN10 name=dhcp10 add address-pool=dhcp_pool20 disabled=no interface=VLAN20 name=dhcp20 /ip dhcp-server network add address=192.168.10.0/24 dns-server=8.8.8.8 gateway=192.168.10.1 add address=192.168.20.0/24 dns-server=8.8.8.8 gateway=192.168.20.1 CAPs: Enable CAP mode on each AP, specify which interface is connected to the CAPsMAN router /interface wireless cap set discovery-interfaces=ether1 enabled=yes interfaces=wlan1 After CAPs are successfully connected to the CAPsMAN Router, two CAP interfaces will be dynamically created on the CAPsMAN Router. Both of these interfaces will get dynamically added as bridge ports on the same CAPsMAN Router due to explicitly selecting the bridge interface with da tapath.bridge=bridge1 and using the default CAPsMAN Forwarding Mode datapath.local-forwarding=no. Because of using a bridge with enabled vl an-filtering, both CAP interfaces will also show up in a bridge VLAN table. You can create even more Virtual APs by adding multiple slave-configurations. That requires multiple CAPsMAN configurations that were created earlier.

[admin@CAPsMAN_Router] /interface bridge port print Flags: X - disabled, I - inactive, D - dynamic, H - hw-offload # INTERFACE BRIDGE HW PVID PRIORITY PATH-COST INTERNAL-PATH- COST HORIZON 0 ether1 bridge1 yes 10 0x80 10 10 none 1 ether2 bridge1 yes 20 0x80 10 10 none 2 D cap16 bridge1 10 0x80 10 10 none 3 D cap17 bridge1 20 0x80 10 10 none [admin@CAPsMAN_Router] /interface bridge vlan print Flags: X - disabled, D - dynamic # BRIDGE VLAN-IDS CURRENT-TAGGED CURRENT- UNTAGGED 0 D bridge1 1 bridge1 1 bridge1 10 cap16 ether1 2 bridge1 20 cap17 ether2 That is it! Connect Wireless clients to your APs and check connectivity. Case studies Without Virtual APs Not everyone wants to create Virtual APs since that does decrease the total throughput. If you want to use multiple devices to create multiple SSIDs, then it is possible to assign a certain configuration on a CAP based on its identity. To achieve this you should use CAPsMAN provisioning rules along with RegEx expressions. In this example we are going to assign the configuration to CAPs that have identity set to "' " and we are Config_WORK AP_WORK_* going to assign the configuration to CAPs that have identity set to " ". To do this, you simply need to change the CAPsMAN Config_GUEST AP_GUEST_* provisioning rules. Remove any existing provisioning rules /caps-man provisioning remove [f] Create new provisioning rules that will assign appropriate configuration on a CAP based on its identity /caps-man provisioning add action=create-dynamic-enabled identity-regexp=^AP_GUEST_ master-configuration=Config_GUEST add action=create-dynamic-enabled identity-regexp=^AP_WORK_ master-configuration=Config_WORK Don't forget to set a proper identity on the CAPs since CAPsMAN is going to assign appropriate configuration on the APs based on it's identity.

WifiWave2 Troubleshooting(viewing restricted) Overview Terminology Wireless logs Station mode AP mode SA query timeout Overview This article explains common WifiWave2 log messages, and possible issues and misconfiguration. Terminology AP - access point Station - wireless client Association - Authentication - Wireless logs Station mode AP mode SA query timeout

In short - this means that the client left the router range, AP sent an information request in order to check, if the client is still present and did not receive an answer. Thus - the client has left the range. Completely normal debug log message - this is not an error or warning. Just an informational message. In greater detail: SA Query Timeout is a normal part of wireless behavior. It is a security feature. SA Query is triggered in the following scenario: 1) On AP there is a valid security association for the station 2) AP receives an Association request from an already associated station 3) AP responds with Association request rejected - "Association Comeback interval" Status Code:30. - this is done in order for AP to understand if the association request came from an attacker, or if it came from a station that got out of range, and was not able to disassociate beforehand. 4) AP sends SA Query Request to the station. Using original encryption that was used with the client beforehand. If the client sends SA Query Response, it will mean that the initial association request came from Attacker. 5) If the Client doesn't give SA Query response, it means that the real client got disconnected, or rather was out of range, and didn't disassociate from AP properly, and restarted association to AP - no attacker is present in this case. And at this point, you will see SA Query Timeout in the log. Unless you see excessive amounts of this message in the log, it is not a problem, and even if you do, it does not necessarily mean that there is a bug in RouterOS, it can appear due to external factors as well.

Spectral scan Introduction Console Spectral History Spectral Scan The Dude Introduction The spectral scan can scan all frequencies supported by your wireless card, and plot them directly in the console. The exact frequency span depends on the card. Allowed ranges on r52n: [4790; 6085], [2182; 2549]. A wireless card can generate 4us long spectral snapshots for any 20mhz wide channel. This is considered a single spectral sample. To improve data quality spectrum is scanned with 10mhz frequency increments, which means doubled sample coverage at each specific frequency (considering 20mhz wide samples). Console Spectral History /interface wireless spectral-history <wireless interface name> Plots spectrogram. Legend and frequency ruler is printed every 24 lines. Numbers in the ruler correspond to the value at their leftmost character position. Power values that fall in different ranges are printed as different colored characters with the same foreground and background color, so it is possible to copy and paste the terminal output of this command. value -- select value that is plotted on the output. 'interference' is special as it shows detected interference sources (affected by the 'classify- samples' parameter) instead of power readings, and cannot be made audible; interval -- interval at which spectrogram lines are printed; duration -- terminate command after a specified time. default is indefinite; buckets -- how many values to show in each line of a spectrogram. This value is limited by the number of columns in the terminal. It is useful to reduce this value if using 'audible'; average-samples -- Number of 4us spectral snapshots to take at each frequency, and calculate average and maximum energy over them. (default 10); Currently, is NOT supported for Atheros 802.11ac chips (e.g. QCA98xx, IPQ-4018). See determine the wireless https://mikrotik.com/products chip on your device.

classify-samples -- Number of spectral snapshots taken at each frequency and processed by the interference classification algorithm. Generally, more samples give more chance to spot certain types of interference (default 50); range -- 2.4ghz - scan the whole 2.4ghz band; 5ghz - scan the whole 5ghz band; current-channel - scan current channel only (20 or 40 MHz wide); range - scan specific range; audible=yes -- play each line as it is printed. There is a short silence between the lines. Each line is played from left to right, with higher frequencies corresponding to higher values in the spectrogram. Spectral Scan /interface wireless spectral-scan <wireless interface name> Continuously monitor spectral data. This command uses the same data source as 'spectral-history', and thus shares many parameters. Each line displays one spectrogram bucket -- frequency, the numeric value of power average, and a character graphic bar. A bar shows average power value with ':' characters and average peak hold with '.' characters. Maximum is displayed as a lone floating ':' character. show-interference -- add a column that shows detected interference sources; Types of possibly classified interference: Bluetooth-headset Bluetooth-stereo cordless-phone microwave-oven

Internet of Things In This Section:

Bluetooth Summary Configuration Devices Advertisers AD structures Connections Scanners Advertising reports Whitelist Peripheral Devices Decode-ad Summary Bluetooth is a short-range wireless technology that allows broadcasting the data over specific Bluetooth channels. There are 40 unique bands (channels) and each band has a 2 MHz separation. 37, 38, and 39 channels are used for primary advertising, and 0-36 are used for data transmission. During the advertising process, the BLE advertising packet is broadcasted. This packet contains the Preamble, Access Address, PDU and CRS fields. The Preamble and Access Address fields help the receiver detect frames. CRS field is used to check errors. PDU consists of PDU Header and PDU Payload. PDU defines the packet itself. PDU Header contains information about the PDU type. Based on the type, the payload fields may differ. For example, when PDU type is ADV_NONCONN_IND → PDU Payload consists of "AdvA" (a field that contains information about the advertiser's address) and "AdvData" (a field that contains data information) fields: 1 octet = 1 byte = 8 bits Preamble 1 octet Access-Address 4 octets PDU PDU Header = 2 octets PDU Payload = AdvA (6 octets)+AdvData (0...31 octets) CRS 3 octets There are different PDU types: ADV_IND (where payload consists of AdvA [6octets] + AdvData [0-31 octets] and which is used for connectable, scannable undirected advertising); ADV_NOCONN_IND (where payload consists of AdvA [6octets] + AdvData [0-31 octets] and which is used for non-connectable, non-scannable undirected advertising); ADV_SCAN_IND (where payload consists of AdvA [6octets] + AdvData [0-31 octets] and which is used for scannable, undirected advertising); SCAN_REQ (where payload consists of ScanA [6octets] + AdvA [6octets], where ScanA field contains scanner's address and AdvA contains advertiser's address, and which is used for requesting SCAN_RSP response); SCAN_RSP (where payload consists of AdvA [6octets] + ScanRspData [0-31 octets], where ScanRspData can contain any data from the advertiser's host and which is used to respond to a SCAN_REQ request); ADV_DIRECT_IND (where payload consists of AdvA [6octets] + TargetA [6octets], where TargetA is the device address field to which the PDU is addressed, and which is used for connectable, directed advertising); etc You can find more information about the packet structure over (Bluetooth specifications).here The main application for the Bluetooth interface in RouterOS is to monitor Bluetooth advertising packets (scanner feature) that are broadcasted by other devices (like for example, ) or broadcast advertising packets (advertiser feature). Bluetooth tags

Configuration Sub-menu: /iot bluetooth : note iot package is required. : note Check your device's specifications page to make sure that the Bluetooth is supported by the unit. IoT package is available with RouterOS version 6.48.3. You can get it from our - under "Extra packages". download page Devices In this menu you can check and set general Bluetooth chip parameters: /iot bluetooth print Columns: NAME, PUBLIC-ADDRESS, RANDOM-STATIC-ADDRESS, ANTENNA # NAM PUBLIC-ADDRESS RANDOM-STATIC-ADD ANTENNA 0 bt1 00:00:00:00:00:00 F4:4E:E8:04:77:3A internal /iot bluetooth set : note Public address is the IEEE registered, permanent address. This address can not be changed. In the "print" example above, the device does not have a public address assigned (all octets are set to 0). Configurable settings are shown below: Property Description antenna ( ; Default: internal) string Choose whether to use an internal or an external Bluetooth antenna name ( ; Default: ) string Descriptive name of Bluetooth chip/interface random-static-address ( ; Default: ) MAC address A user-configurable address for the Bluetooth chip You can monitor chip stats with the command: /iot bluetooth print stats Columns: NAME, RX-BYTES, TX-BYTES, RX-ERRORS, TX-ERRORS, RX-EVT, TX-CMD, RX-ACL, TX-ACL # NAM RX-BYTE TX- R T RX-EV TX R T 0 bt1 1857835 235 0 0 46677 45 0 0 Advertisers In this menu, it is possible to set up the Bluetooth chip to broadcast advertising packets. You can check and set advertiser settings with the commands: /iot bluetooth advertisers print Flags: X - DISABLED Columns: DEVICE, MIN-INTERVAL, MAX-INTERVAL, OWN-ADDRESS-TYPE, CHANNEL-MAP, AD-SIZE # DEVICE MIN-INTERVAL MAX-INTERVAL OWN-ADDRESS-TYPE CHANNEL-MAP AD-SIZE 0 X bt1 1280ms 2560ms random-static 37 0 38 39 /iot bluetooth advertisers set Configurable settings are shown below: Property Description ad-structures ( ; Default: ) string Choose a pre-configured structure for the advertisement packets. For more information see the "AD structures" section. channel-map ( ; Default: 37, 38, 39) 37 | 38 | 39 Channels used for advertising.

disabled ( ; Default: ) yes | no yes An option to disable or enable the Bluetooth chip to broadcast advertising packets. max-interval ( Default: integer: 20..10240; 2560 )msThe maximal interval for broadcasting advertising packets. min-interval ( Default: ) integer: 20..10240; 1280 ms The minimal interval for broadcasting advertising packets. own-address-type (public | random-static | rpa- ; fallback-to-public | rpa-fallback-to-random Default: ) random-staticThe MAC address that is going to be used in the advertising packet's payload: public → To use the IEEE registered, permanent address. random-static → To use user-configurable address (will be changed on the next power-cycle). rpa-fallback-to-public → To use Resolvable Random Private Address (RPA) that can only be resolved if the receiver has our Identity Resolving Key (IRK). If RPA can not be generated, the public address will be used instead. rpa-fallback-to-random → Same as "rpa-fallback-to-public" but if RPA can not be generated, the random-static address will be used instead. : note Advertising packets will be broadcasted each <= <= milliseconds. min-interval X max-interval AD structures This section allows you to define the payload for the advertising packets that are going to be broadcasted by the Bluetooth chip. Currently, only 4 types are supported: 0x08 "Shortened Local Name"; 0x09 "Complete Local Name"; 0xFF "Manufacturer Specific Data"; "Service Data" You can check and set "AD structures" settings with the commands: /iot bluetooth advertisers ad-structures print Columns: NAME, TYPE, DATA # NAME TYPE DATA 0 test short-local-name TEST /iot bluetooth advertisers ad-structures set Configurable properties are shown below: Property Description data ( ; Default: ) string Define advertising packet's AdvData part of the payload name ( ; Default: ) string Descriptive name of AD structure type (complete-local-name | manufacturer-data | short-local-name | service-data; Default: ) An option to set AD structure's type: 0x08 "Shortened Local Name" 0x09 "Complete Local Name" 0xFF "Manufacturer Specific Data" 0x20 "Service Data 32-bit" If, for example, the "Shortened Local Name" type is chosen and the "data" field is configured with "TEST" → AdvData part of the payload is going to look like this: 05 08 54 45 53 54 (hexadecimal format) , where the first octet (05) shows the number of bytes to follow (5 bytes) and the second octet (08) shows the type (Shortened Local Name). 3d, 4th, 5th and 6th (and etc) octets are the "data" [54 (hex)= (ASCII), 45 (hex)= (ASCII), 53 (hex)= (ASCII), 54 (hex)= (ASCII)]. T E S T The same applies to the "Complete Local Name" type. Only the second octet in the AdvData payload is going to differ and will be set to 09. For the "Manufacturer Specific Data" type, you will need to configure the "data" field in the hexadecimal format. The second octet for this type is going to be set to FF. Connections

Currenetly, only " " role is supported. " " role, "p " and " " options are not supported. central Pheriperal device airing encryption Availible sections are: Section Description async-data used to view subscribed data. characteristics used to view all supported characteristics of the device. connect used to connect to the device that is in the state. connactable disconnect used to disconnect from the device. read used to read characteristics values. write used to write characteristics values. subscribe used to subscribe to a charasteristic value. unsubscribe used to unsubscribe from a charasteristic value. In order to connect to a Bluetooth device that is in the state, use the command (where is the device address): connactable pdev /iot bluetooth connections connect pdev=DC:2C:6E:0F:C0:3D To view an already established connection: /iot bluetooth connections print To view device characteristics: /iot bluetooth connections characteristics print Columns: PDEV, NAME, UUID # PDEV NAME UUID 0 DC:2C:6E:0F:C0:3D Service Changed 2a05 1 DC:2C:6E:0F:C0:3D Database Hash 2b2a 2 DC:2C:6E:0F:C0:3D Client Supported Features 2b29 3 DC:2C:6E:0F:C0:3D Device Name 2a00 4 DC:2C:6E:0F:C0:3D Appearance 2a01 ... ... ... To read a specific characteristic, specify the address and the : pdev uuid /iot bluetooth connections read pdev=DC:2C:6E:0F:C0:3D uuid=2a00 Scanners In this menu, you can set up the scanner settings for the Bluetooth chip. When disabled, the device is no longer able to receive advertising reports. When enabled, you can monitor advertising reports in the "Advertising reports" tab (which will be explained later in the guide). You can check and set scanner settings with the commands: Availible starting with v . 7.12beta9 To connect to TG-BT5-IN/OUT tags, make sure to put it into the state by applying a magnet to the magnetic switch. connactable

/iot bluetooth scanners print Flags: X - DISABLED Columns: DEVICE, TYPE, INTERVAL, WINDOW, OWN-ADDRESS-TYPE, FILTER-POLICY, FILTER-DUPL ICATES # DEVICE TYPE INTERVAL WINDOW OWN-ADDRESS-TYPE FILTER-POLICY FIL 0 X bt1 passive 10ms 10ms random-static default off /iot bluetooth scanners set Configurable properties are shown below: Property Description disabled ( ; Default: ) yes | no no An option to disable or enable the Bluetooth chip to receive advertising reports. filter-duplicates (keep-newest | keep-oldest | keep-unique | off; Default: )offAn option to discard duplicate advertisements from the same advertiser: keep-newest → Keeps the newest report (discards the oldest). Only the newest PDU from a single AdvA will be kept. keep-oldest → Keeps the oldest report (discards the newest). Only the oldest PDU from a single AdvA will be kept. This type of PDU filtering happens at the controller level and as such it's the most efficient (energy /bandwidth-wise) method of duplicate filtering. keep-unique → Only displays advertisements that have a unique payload. Meaning, if 1+ identical payloads (AdvData) are found, only the first payload is going to be displayed, while the "clones" are discarded/ignored. off → Duplicates are not discarded. All PDUs with the same AdvA will be kept. filter-policy (default | whitelist | ; Default: ) no defaultAn option to set up a filtering policy (controller-level advertisement filtering): default → When this policy is enabled, the scanner will only accept ADV_IND, ADV_NOCONN_IND, ADV_SCAN_IND, SCAN_RSP, and ADV_DIRECT_IND (where TargetA is the scanner's own Bluetooth address) PDU types. whitelist → When this policy is enabled, the scanner will only accept ADV_IND, ADV_NOCONN_IND, ADV_SCAN_IND, SCAN_RSP PDU types that are broadcasted by the advertiser, whose address is configured in the "Whitelist" section, and ADV_DIRECT_IND type PDU (where TargetA is the scanner's own Bluetooth address). interval ( integer:3..10240 ; Default: ) 10 msTime after which scanner will start scanning the next advertisement channel. own-address-type (public | random-static | rpa-fallback-to- ; public | rpa-fallback-to-random Default: ) random-staticAddress type used in scan requests (if active scanning type is used): public → To use the IEEE registered, permanent address. random-static → To use user-configurable address (will be changed on the next power-cycle). rpa-fallback-to-public → To use Resolvable Random Private Address (RPA) that can only be resolved with our Identity Resolving Key (IRK). If RPA can not be generated, the public address will be used instead. rpa-fallback-to-random → Same as "rpa-fallback-to-public" but if RPA can not be generated, the random-static address will be used instead. A advertising report is an advertising report sent from the same duplicate device address. The actual data ("AdvData" part of the payload) may change/differ and it is not considered significant when determining du advertising reports. Meaning that, for example, if the Bluetooth interface receives 10 payloads plicate (payload after payload with a 1-second interval) from the same tag: if you are using the "keep-oldest" setting → Bluetooth interface will only display the first payload received (9 follow-up payloads will be filtered out) from that tag. if you are using the "keep-newest" setting → Bluetooth interface will only display the last payload received (each follow-up payload will rewrite the previous one) from that tag.

type ( Default: active | passive; p ) assiveDefines the scanner's type: active → Scanner can send scan requests if it receives a scannable advertisement. The scanner can send a SCAN_REQ in order to acquire a SCAN_RSP response. passive → Scanner will only listen for advertisements, no data (e.g. scan requests) will be sent. window ( Defau integer:3..10240; lt: ) 10 msThe time that the scanner will spend scanning a single advertisement channel. For example, if the scanner interval is set to 20ms, it means that only after 20ms, the device will begin scanning the next channel in line. If the scanner window is set to 10ms, it means that the device will scan each channel only during that 10ms window. Meaning, it will scan channel 37 for 10ms (window time) and begin scanning the next channel after 10 more ms (20ms[interval]-10ms[window]). It will take 10ms to scan channel 38, and after 10 more ms, the device will begin scanning channel 39. Advertising reports In this section, it is possible to monitor Bluetooth advertising reports (from the nearby broadcasters). The list is limited to 1024 entries (if the list gets full with 1024 entries, each new payload received will overwrite the "oldest" one). You can monitor advertising reports with the command: /iot bluetooth scanners advertisements print Columns: DEVICE, PDU-TYPE, TIME, ADDRESS-TYPE, ADDRESS, RSSI # DEV PDU-TYPE TIME ADDRES ADDRESS RSSI 0 bt1 adv-noconn-ind jul/28/2021 09:30:56 public 2C:C8:1B:93:16:49 -24dBm 1 bt1 adv-noconn-ind jul/28/2021 09:30:56 random 0B:16:17:9E:7B:EF -60dBm It is possible to set up a filter for the reports with the command: /iot bluetooth scanners advertisements print where For example, to print reports that are broadcasted by a specific Bluetooth address, use the command: /iot bluetooth scanners advertisements print where address=XX:XX:XX:XX:XX:XX # DEVICE PDU-TYPE TIME ADD... ADDRESS RSSI LENGTH DATA 79 bt1 adv-noconn-ind jul/28/2021 09:46:38 public XX:XX:XX:XX:XX:XX -70dBm 30 02010... 80 bt1 adv-noconn-ind jul/28/2021 09:46:43 public XX:XX:XX:XX:XX:XX -67dBm 30 02010... 81 bt1 adv-noconn-ind jul/28/2021 09:46:44 public XX:XX:XX:XX:XX:XX -70dBm 28 1bff0... 82 bt1 adv-noconn-ind jul/28/2021 09:46:48 public XX:XX:XX:XX:XX:XX -75dBm 30 02010... To show only advertising reports that have RSSI stronger than -30 dBm, use the command: /iot bluetooth scanners advertisements print where rssi > -30 # DEVICE PDU-TYPE TIME ADDRESS-TYPE ADDRESS RSSI LENGTH DATA 307 bt1 adv-noconn-ind jul/29/2021 10:11:31 public 2C:C8:1B:93:16:49 -24dBm 22 15ff4f09.> 308 bt1 adv-noconn-ind jul/29/2021 10:11:31 public 2C:C8:1B:93:16:49 -26dBm 22 15ff4f09.> Possible filters (you can filter the list of advertising reports with the help of the following parameters): Filter Description address Bluetooth advertisers address address-type Advertisers address type (for example, public or random) data Advertisement data in hex format (AdvData payload)

device Bluetooth chip/interface name epoch Milliseconds since Unix Epoch filter-comment Comment of the matching whitelist filter length Advertisement data length pdu-type Advertisement PDU type rssi Signal strength time Time of the advertisement packet reception Whitelist In this tab, it is possible to configure a whitelist that is going to be used in the filter policy in the "Scanners" section. In other words, an option to specify which Bluetooth addresses are going to be scanned (displayed in the "Advertising reports"). You can view the whitelisted entries with the command: /iot bluetooth whitelist print Columns: DEVICE, ADDRESS-TYPE, ADDRESS # DEVICE ADDRESS-TYPE ADDRESS 0 bt1 any *:*:*:*:*:* You can add a new whitelist entry with the command: /iot bluetooth whitelist add Configurable properties: Property Description address ( ; Default: ) MAC address Advertiser's address address-type ( ; Default: ) any | public | random Advertiser's address type comment ( ; Default: ) string Short description of the whitelisted entry copy-from An option to copy an entry - for more information check the console documentation device (; Default: )bt1 Select the Bluetooth interface/chip name disabled ( ; Default: ) yes | no An option to disable or to enable the entry If, for example, you want to whitelist all MAC addresses that begin with "DC:2C:..." octets, add an entry using wildcard asterisk characters: /iot bluetooth whitelist add address=DC:2C:*:*:*:* Wildcard asterisk can not be used in-between specific octets, like " " (it is an invaldi entry). AA:*:*:BB:*:* Valid entries would be: AA:BB:CC:DD:*:* AA:BB:CC:DD:EE:* AA:*:*:*:*:* Only 8 whitelisted entries can be added prior to version. 7.14beta8 Starting with version, whitelist is no longer limited to 8 entries and address field supports asterisk wildcards. 7.14beta8

/iot bluetooth decode-ad data=0201060303AAFE1116AAFE20000B6E158402353AF20238576B type: eddystone-tlm version: 0 battery-voltage: 2.926V temperature: 21.515C packet-count: 37042930 uptime: 3724682.7s /iot bluetooth decode-ad data=15FF4F090100032E0100FFFF00004F17C1E80F000064 type: mikrotik version: 1 encrypted: no acc-x: 0.003G acc-y: -0.003G acc-z: 0G temperature: 23.308C uptime: 1042625s flags: battery: 100%

With the help of RouterOS and , we can make the KNOT automatically-periodically scan the payload list and, in case, a specific scripting scheduling payload or a specific tag's MAC address is found on the list, we can make the KNOT structure an MQTT message (out of the printed information shown in the example above) and send it to the configured server via , or post. Script examples will be shown later on in the guide. MQTT e-mail HTTP As the title suggests, the goal is to implement a and the idea is quite simple. (KNOT-A and KNOT- Bluetooth tag-tracking solution When you have 2 KNOTs B), running the same script on a scheduler, , the data on it was and the tag moves between their Bluetooth operating ranges the server will indicate whether that tag's . That will help you figure out the proximity of the tag. Whether the tag is broadcasting payloads in the KNOT-A or KNOT-B have sent the payload KNOT-A zone, or in the KNOT-B zone. You will need a server where the data is going to be stored and visualized. In this guide, we will showcase a server called and how to ThingsBoard communicate with it using the MQTT protocol. ThingsBoard has a cloud solution and different local installation options (on different OS). Since we've added a feature, it became possible to container also run the platform within RouterOS. In order to do that, you will need a RouterOS device that has at least 2 GB RAM to spare or 1 GB RAM to spare with minimal load, has the option to increase storage (for example, an additional USB port), and is either ARM64 or AMD64 architecture. Consider using C machine, as it could be a good fit.HR Setup requirements: a running ThingsBoard server; 2+ s with access to the server's network via ethernet, Wi-Fi, or cellular connection (the amount of the units required depends on the size of KNOT the area that needs to be covered); 1+ Bluetooth and/or tags (depending on how many assets you need to track - 1 tag per asset). TG-BT5-IN TG-BT5-OUT Scenario explanation Let's take a look at a basic example first. We have two KNOTs (KNOT-A and KNOT-B). We've tested Bluetooth ranges in our environment and could verify that both KNOTs are able to capture the tag at a 70-meter distance. If we install KNOT-A and KNOT-B 140 meters apart, their Bluetooth ranges will not overlap or overlap just slightly. When the tag moves into the KNOT-A range → the payload from the monitored tag will appear under the Bluetooth scanner list → the script will be initiated on a set schedule → an MQTT message with a report is going to be sent to the server → and, finally, the server will display that the tag is in the KNOT-A zone. When the tag moves into the KNOT-B range, the same happens, and the server will display that the tag is inside the KNOT-B zone. The actual Bluetooth operating distance can vary from site to site because a lot of different factors can impact it, like 2.4 GHz interference or the surrounding materials used. For example, in line of sight, with no interference, the distance at which the KNOT is able to capture the tag's broadcasted payload, can be up to 180 meters (KNOT — ~180 meters — TG-BT5-OUT). But you also have to keep in mind that with further distance, more packets will be lost on the way. In the office environment, the range can go down to 30-100 meters. Logically, if the Bluetooth operating ranges overlap and the tag is within the overlapped area (at the same time within KNOT-A and KNOT-B Bluetooth ranges), both KNOTs will send the data and the server is going to show that the tag is reported by both devices at the same time. Surely, there will be zones where two or more KNOT's Bluetooth ranges overlap and you can use it to your advantage . Basically, you will have information that the tag, right now, is on the edges of the Bluetooth ranges in-between specific KNOT zones. In other words, when the asset moves into the overlapped area, you will have information on the server that the asset is somewhere between the two KNOT operating ranges, which is useful information to have . as it gives more precision Additionally, . Meaning, that even if the tag's payloads are broadcasted way too far and the tag's output power can be reduced using parameter Tx power they are caught by other KNOTs that are not supposed to see those payloads (at longer distances) → you can reduce the output power of the tag, which will reduce the distance at which the KNOT is able to capture it. That way, you can "tweak" the "range" of reception and also avoid "interfering" with the signal in other zones. When testing locally to see how many payloads can the KNOT handle, we've achieved the following results → with 300 tags (in factory settings), scattered around the KNOT and using a Bluetooth filter "keep-newest" (which overwrites previously received payloads for each unique MAC address with the newest one, so that the Bluetooth list would display 1 payload per 1 unique tag's MAC address at all times), all 300 MAC addresses appeared in the KNOT's range after 30-40 seconds. This is where you need to keep in mind that all 300 tags broadcasting over the same channels at the same time will cause interference (delay in the reception). When we "cleared" the Bluetooth payload list, each second the list got 20 new entries and after about ~15 seconds, the list had 250-290 payloads. Then after ~15 seconds more, the list displayed all 300 unique tag payloads. The actual number of tags your KNOT is able to handle is heavily dependent on the environment, so it is better to test it on sight.

The scripts we've prepared also allows you to set up a filter (that will be shown later on), which will make the KNOT ignore the payloads that the scanner captures unless the signal strength (RSSI) is stronger than the specified value. In the Bluetooth scanner example print shown above under the " Introduction " section, we can see that the KNOT sees one of the tags with an signal strength of (tag with a MAC address " ") and RSSI -51 dBm DC:2C:6E:0F:C0:3D the other one with an signal strength of (tag with a MAC address " "). So, apply a filter to the script to all RSSI -49 dBm 2C:C8:1B:4B:BB:0A if we ignore payloads that are received with signal strength ( ) , our RSSI weaker than -50 dBm KNOT would report that only tag "2C:C8:1B:4B:BB:0A" is within the , because its RSSI is -49 dBm, and the second tag (with RSSI -51 dBm) will be ignored. What this means, essentially, it is a second way of Bluetooth range "tweaking" the "range" of reception. The actual signal strength will vary between different locations (as mentioned before, because of interference and surrounding materials), so it needs to be tested on sight. Example #1 One of the use cases is shown in the topology below: We have a warehouse area and (pallets) that we are interested in tracking. also : zone , where newly arrived pallets we have 3 assets We have 3 zones A are stored; zone , where our assets are relocated to be inspected; and zone , where assets are moved after inspection. To achieve Bluetooth asset- B C tracking, just install x1 KNOT per zone and x1 tag per asset. If TAG 1 and TAG 2 (pallets) arrive in the "arrival" zone A, KNOT A will report to the server that both assets are within its Bluetooth range. If TAG 3 gets moved to zone C, the server will indicate it is within the KNOT C range. If TAG 1 and TAG 2 move toward the B zone, and stay on the edges between A and B zones, the server will show that it is in the overlapped area (at the same time within KNOT-A and KNOT-B ranges). If the tags move to the middle of the warehouse, the server will indicate that they are in all 3 zones at once, in the overlapping area. Configuration In this example, we will showcase a basic topology, when two KNOTs are used and we just want to know whether the tag is located in one part of the building or the other one (whether it is inside zone A or zone B). ThingsBoard preparation The scale of objects and Bluetooth operating ranges are just shown as an example, to help visually understand and imagine the topology!

Check the guide over to understand how the ThingsBoard and the RouterOS can be set up to utilize MQTT communication.here Create 2 KNOTs under the ThingsBoard GUI and make them "gateways". Go to the "Devices" section, click on "+" button and "Add new device": Name the device and checkbox the "Is gateway" option: Do that for each KNOT that you have: Set up a unique access token (unique credentials) for each KNOT under the device you've just created, under the "Manage credentials" tab: This example will showcase scenario for simplicity reasons, but you can use other available options as well. For the production access-token environment, it is suggested to use SSL-MQTT, as non-SSL-MQTT can be easily packet captured and inspected. To understand how to implement SSL-MQTT communication on the instance that is run with the . Check the guide linked ( container here Enablin section). g HTTPS and SSL MQTT

RouterOS configuration Preparation Before we proceed, we need to confirm that our Bluetooth tag actually appears in the KNOT's Bluetooth range and that the KNOT detects them. To do that, you can issue the command " ": /iot bluetooth scanners advertisements print /iot bluetooth scanners advertisements print # DEVICE PDU-TYPE TIME ADDRESS-TYPE ADDRESS RSSI LENGTH DATA 0 bt1 adv-noconn-ind mar/08/2023 12:35:15 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f090100b0110100ffff00000019d68d2300005d 1 bt1 adv-noconn-ind mar/08/2023 12:35:16 public DC:2C:6E:0F:C0:3D -39dBm 22 15ff4f0901008f3cfcfffbfffaff301783c22c000064 2 bt1 adv-noconn-ind mar/08/2023 12:35:35 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f09010084d500000400ffff0319ea8d2300005d 3 bt1 adv-noconn-ind mar/08/2023 12:35:45 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f090100e607faffffff03000319f48d2300005d Or you can check it using or under the IoT>Bluetooth>Advertising reports tab. Webfig Winbox The list can be chaotic. Random payloads can appear on the list as the scanner captures everything around it. To help reduce the list, you can filter it using the tag's MAC address " ": /iot bluetooth scanners advertisements print where address=DC:2C:6E:0F:C0:3D /iot bluetooth scanners advertisements print where address=DC:2C:6E:0F:C0:3D # DEVICE PDU-TYPE TIME ADDRESS-TYPE ADDRESS RSSI LENGTH DATA 0 bt1 adv-noconn-ind mar/08/2023 12:41:06 public DC:2C:6E:0F:C0:3D -49dBm 22 15ff4f0901005ab20100fdfffdff4017e1c32c000064 1 bt1 adv-noconn-ind mar/08/2023 12:41:26 public DC:2C:6E:0F:C0:3D -40dBm 22 15ff4f090100349704000000fcff4017f5c32c000064 2 bt1 adv-noconn-ind mar/08/2023 12:41:36 public DC:2C:6E:0F:C0:3D -49dBm 22 15ff4f09010073fb0000000000003017ffc32c000064 3 bt1 adv-noconn-ind mar/08/2023 12:41:46 public DC:2C:6E:0F:C0:3D -43dBm 22 15ff4f090100b88cffffffffffff401709c42c000064 To figure out how to decypher the payload, please check the guide .here MQTT broker On each KNOT setup MQTT broker. For KNOT A: /iot/mqtt/brokers/add name=tb address=x.x.x.x port=1883 username=knot-A_access_token

Where: name is the name that you wish to give to the broker and this name will be used later in the script; address is the IP address of the broker/ThingsBoard server; port is the TCP port that the broker is listening for → for non-SSL it is typically TCP 1883; username is dictated by the MQTT broker and, in our case, it is an "access token" that was generated in the ThingsBoard management portal. For KNOT B → Do the same step. Just change to the respective access token that was generated for the KNOT B device (gateway). username Script Import the script shown below to each KNOT. To do that, just copy the below shown "code" and paste it into a new terminal window and press "ENTER": /system script add dont-require-permissions=no name=tracking owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="# Requ\ ired packages: iot\r\ \n\r\ \n################################ Configuration ##############################\ ##\r\ \n# Name of an existing MQTT broker that should be used for publishing\r\ \n:local broker \"tb\"\r\ \n\r\ \n# MQTT topic where the message should be published\r\ \n:local topic \"v1/gateway/telemetry\"\r\ \n\r\ \n# POSIX regex for filtering advertisement Bluetooth addresses. E.g. \"^BC:33:\ AC\"\r\ \n# would only include addresses which start with those 3 octets.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local addressRegex \"\"\r\ \n\r\ \n# POSIX regex for filtering Bluetooth advertisements based on their data. Sam\ e\r\ \n# usage as with 'addressRegex'.\r\ \n:local advertisingDataRegex \"\"\r\ \n\r\ \n# Signal strength filter. E.g. -40 would only include Bluetooth advertisement\ s\r\ \n# whose signal strength is stronger than -40dBm.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local rssiThreshold \"\"\r\ \n\r\ \n#Name the KNOT. Identity of the unit that will be senting the message. This n\ ame will be reported to the MQTT broker.\r\ \n:local gwName \"KNOT_A\"\r\ \n\r\ \n################################## Bluetooth ################################\ ##\r\ \n:put (\"[*] Gathering Bluetooth info...\")\r\ \n\r\ \n:global makeRecord do={\r\ \n :local jsonStr \"{\\\"ts\\\":\$ts,\\\"values\\\":{\\\"reporter\\\":\\\"\$\ gwName\\\",\\\"rssi\\\":\$rssi}}\"\r\ \n :return \$jsonStr\r\ \n} \r\ \n\r\ \n# array of record strings collected for each advertising MAC address\r\ \n:global macRecords [:toarray \"\"]\r\ \n\r\ \n# process advertisements and update macRecords\r\ \n:local advertisements [/iot bluetooth scanners advertisements print detail as\ -value where \\\r\ \naddress ~ \$addressRegex and \\\r\ \ndata ~ \$advertisingDataRegex and \\\r\ \nrssi > \$rssiThreshold]\r\ \n\r\ \n/iot/bluetooth/scanners/advertisements clear\r\ \n\r\ \n:foreach adv in=\$advertisements do={\r\

KNOT identifier line. You will need to change it for each unique KNOT. For example, name your first KNOT → KNOT_A and your second KNOT → KNOT_B: :local gwName "KNOT_A" The rest of the script does not need to be changed/altered How does the script work when you run it? The script "inspects" the "Advertising reports" tab (payload list tab) using the filters applied and structures a JSON message. An example of the JSON message would be: { "2C:C8:1B:4B:BB:0A": [ { "ts": 1678967250600, "values": { "reporter": "KNOT_A", "rssi": -47 } } ], "DC:2C:6E:0F:C0:3D": [ { "ts": 1678967247850, "values": { "reporter": "KNOT_A", "rssi": -59 } }, { "ts": 1678967257849, "values": { "reporter": "KNOT_A", "rssi": -67 } } ] } The data is structured per the , where " " and " " are MAC addresses of tags that appeared ThingsBoard guide 2C:C8:1B:4B:BB:0A DC:2C:6E:0F:C0:3D in the KNOT's range, " " is unix timestamp of each payload broadcasted by the tag in milliseconds, " " indicates which specific KNOT has sent ts reporter the message and " " is the signal strength of each payload broadcasted by the tag in dBm.rssi After the payload list is "searched" and the JSON message is structured, the Bluetooth interface payload list gets "cleaned" (or "flashed"), and the previously structured JSON message is sent to the ThingsBoard MQTT broker. To run the script, use the command: /system script run tracking Scheduler Apply a scheduler to the script, so that RouterOS periodically initiates the script by itself: /system/scheduler/add name=bluetoothscheduler interval=30s on-event="/system/script/run tracking" You can set up shorter and longer intervals. If you want to send data more often, so that the data is "fresher" → set up shorter time intervals (10-15 seconds). If you want to send fewer messages, less often → you can set up longer time intervals (30min+). The JSON message structured using the script has a " " value (timestamp) assigned for each payload received. Meaning that , for ts when the script is run example, , 1 tag is used and 1 payload every 10 seconds (that is ) → ThingsBoard data (GUI) will be every minute the tag broadcasts 6 payloads per minute updated every minute, and every minute, 6 new entries will appear (each entry will indicate that it was received 10 seconds after the previous one). And if you send the message every 15 minutes when using 1 tag that is broadcasting a payload every 10 seconds (that is 6*15=90 payloads per 15 minutes) → ThingsBoard data (GUI) will be updated every 15 minutes but 90 entries will appear. ThingsBoard data visualization and result verification After you run the script with or via a scheduler and refresh the GUI portal → all MAC addresses (tags) that are found /system script run tracking in the JSON message, will be made into new devices under the ThingsBoard GUI:

To help you visualize the data, you can use the built-in or create your own one. widgets Select the tag's MAC address from the list of devices, go to the "Latest telemetry" section, checkbox the "reporter" parameter, and click on the "Show on widget" button: Select a widget that you wish to use, for example under the "Cards" bundle, "Timeseries table" and click on "Add to dashboard":

Create a new dashboard and name it, however, you like. Click on "Add": Do the same steps for your other tags that appeared under the "Devices" tab. Create a new widget for each unique tag under the same dashboard. Change the widget's "Timewindow" from "Realtime-last minute" (which is used by default) to "Realtime-current day": As a result, if both tags are inside the , the dashboard would show: KNOT A range

If they move to the , it would show: KNOT B range If the tags move to the , inside both ranges, both reporters (KNOT_A and KNOT_B) should show up within a few seconds after each other, overlapped area depending on the interval used in the scheduler:

Example #2 In the second example, we will showcase another topology:

We have a few warehouses, a few company delivery vehicles, and 3 assets that we are interested in tracking. Our assets are pallets that hold cargo and our goals are to know: in which specific warehouse (equipped with the KNOT) the asset (equipped with the tag) is currently in and how much time it spent inside the specific warehouse; whether the asset (equipped with the tag) is on the road, traveling between warehouses, and how much time it spent inside the vehicle (equipped with the KNOT); (optionally) if tags are used TG-BT5-OUT , what was the temperature during all this time? You can also/instead monitor other parameters that you can get out of the advertised , like for example acceleration; payload (optionally) find out the KNOT's GPS location. To achieve Bluetooth asset-tracking, just install x1 KNOT per warehouse, x1 KNOT per vehicle, and x1 tag per asset. We can see that TAG 1 is inside the vehicle, and this vehicle just parked near the warehouse. Both KNOT 1 and KNOT 4 will report to the server that the asset is inside their ranges. This will tell you that the asset is parked but not being transported yet. We can see that TAG 2 is traveling between the warehouses and is only inside the KNOT 5 Bluetooth range. In this case, KNOT 5 will be the only reporter and the result that is displayed on the server would mean that the asset is getting transported. We can see that TAG 3 is inside the warehouse. The server will indicate just that. The data on the server will show the timestamps of each report sent by the KNOT, which will tell you for how long did the asset stay inside the specific device's Bluetooth range. Configuration In this example, we will showcase a basic topology with 2 warehouses, 1 vehicle/truck traveling between them, and 1 asset/pallet/tag. ThingsBoard preparation Check the guide over to understand how the ThingsBoard and the RouterOS can be set up to utilize MQTT communication.here Create 3 KNOTs under the ThingsBoard GUI and make them "gateways". Go to the "Devices" section, click on "+" button and "Add new device": Name the device and checkbox the "Is gateway" option: This example will showcase scenario for simplicity reasons, but you can use other available options as well. For the production access-token environment, it is suggested to use SSL-MQTT, as non-SSL-MQTT can be easily packet captured and inspected. To understand how to implement SSL-MQTT communication on the instance that is run with the . Check the guide linked ( container here Enablin section). g HTTPS and SSL MQTT

Do that for each KNOT that you have: Set up a unique access token (unique credentials) for each KNOT under the device you've just created, under the "Manage credentials" tab: RouterOS configuration Preparation Before we proceed, we need to confirm that our Bluetooth tag actually appears in the KNOT's Bluetooth range and that the KNOT detects them. To do that, you can issue the command " ": /iot bluetooth scanners advertisements print

/iot bluetooth scanners advertisements print # DEVICE PDU-TYPE TIME ADDRESS-TYPE ADDRESS RSSI LENGTH DATA 0 bt1 adv-noconn-ind mar/08/2023 12:35:15 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f090100b0110100ffff00000019d68d2300005d 1 bt1 adv-noconn-ind mar/08/2023 12:35:16 public DC:2C:6E:0F:C0:3D -39dBm 22 15ff4f0901008f3cfcfffbfffaff301783c22c000064 2 bt1 adv-noconn-ind mar/08/2023 12:35:35 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f09010084d500000400ffff0319ea8d2300005d 3 bt1 adv-noconn-ind mar/08/2023 12:35:45 public 2C:C8:1B:4B:BB:0A -50dBm 22 15ff4f090100e607faffffff03000319f48d2300005d Or you can check it using or under the IoT>Bluetooth>Advertising reports tab. Webfig Winbox The list can be chaotic. Random payloads can appear on the list as the scanner captures everything around it. To help reduce the list, you can filter it using the tag's MAC address " ": /iot bluetooth scanners advertisements print where address=DC:2C:6E:0F:C0:3D /iot bluetooth scanners advertisements print where address=DC:2C:6E:0F:C0:3D # DEVICE PDU-TYPE TIME ADDRESS-TYPE ADDRESS RSSI LENGTH DATA 0 bt1 adv-noconn-ind mar/08/2023 12:41:06 public DC:2C:6E:0F:C0:3D -49dBm 22 15ff4f0901005ab20100fdfffdff4017e1c32c000064 1 bt1 adv-noconn-ind mar/08/2023 12:41:26 public DC:2C:6E:0F:C0:3D -40dBm 22 15ff4f090100349704000000fcff4017f5c32c000064 2 bt1 adv-noconn-ind mar/08/2023 12:41:36 public DC:2C:6E:0F:C0:3D -49dBm 22 15ff4f09010073fb0000000000003017ffc32c000064 3 bt1 adv-noconn-ind mar/08/2023 12:41:46 public DC:2C:6E:0F:C0:3D -43dBm 22 15ff4f090100b88cffffffffffff401709c42c000064 To figure out how to decypher the payload, please check the guide .here MQTT broker On each KNOT setup MQTT broker. For KNOT_1: /iot/mqtt/brokers/add name=tb address=x.x.x.x port=1883 username=knot-1_access_token Where: name is the name that you wish to give to the broker and this name will be used later in the script; address is the IP address of the broker/ThingsBoard server; port is the TCP port that the broker is listening for → for non-SSL it is typically TCP 1883; username is dictated by the MQTT broker and, in our case, it is an "access token" that was generated in the ThingsBoard management portal. For KNOT_2 and KNOT_3 → Do the same steps. Just change to the respective access token that was generated. username Script Import the script shown below to each KNOT. To do that, just copy the below shown "code" and paste it into a new terminal window and press "ENTER": /system script add dont-require-permissions=no name=tracking owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="# Required package\ s: iot\r\ \n\r\ \n################################ Configuration ################################\r\ \n# Name of an existing MQTT broker that should be used for publishing\r\ \n:local broker \"tb\"\r\ \n\r\ \n# MQTT topic where the message should be published\r\ \n:local topic \"v1/gateway/telemetry\"\r\ \n\r\ \n# POSIX regex for filtering advertisement Bluetooth addresses. E.g. \"^BC:33:AC\"\r\

\n# would only include addresses which start with those 3 octets.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local addressRegex \"\"\r\ \n\r\ \n# POSIX regex for filtering Bluetooth advertisements based on their data. Same\r\ \n# usage as with 'addressRegex'.\r\ \n:local advertisingDataRegex \"\"\r\ \n\r\ \n# Signal strength filter. E.g. -40 would only include Bluetooth advertisements\r\ \n# whose signal strength is stronger than -40dBm.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local rssiThreshold \"\"\r\ \n\r\ \n#Name the KNOT. Identity of the unit that will be senting the message. This name will be \ reported to the MQTT broker.\r\ \n:local gwName \"1\"\r\ \n\r\ \n################################## Bluetooth ##################################\r\ \n:put (\"[*] Gathering Bluetooth info...\")\r\ \n\r\ \n:global makeRecord do={\r\ \n :local jsonStr \"{\\\"ts\\\":\$ts,\\\"values\\\":{\\\"KNOT_\$gwName\\\":\\\"\$gwName\ \\\",\\\"rssi\\\":\$rssi}}\"\r\ \n :return \$jsonStr\r\ \n} \r\ \n\r\ \n# array of record strings collected for each advertising MAC address\r\ \n:global macRecords [:toarray \"\"]\r\ \n\r\ \n# process advertisements and update macRecords\r\ \n:local advertisements [/iot bluetooth scanners advertisements print detail as-value where\ \_\\\r\ \naddress ~ \$addressRegex and \\\r\ \ndata ~ \$advertisingDataRegex and \\\r\ \nrssi > \$rssiThreshold]\r\ \n\r\ \n/iot/bluetooth/scanners/advertisements clear\r\ \n\r\ \n:foreach adv in=\$advertisements do={\r\ \n:local address (\$adv->\"address\")\r\ \n:local rssi (\$adv->\"rssi\")\r\ \n:local epoch (\$adv->\"epoch\")\r\ \n \r\ \n:local recordStr [\$makeRecord ts=\$epoch gwName=\$gwName rssi=\$rssi]\r\ \n\r\ \n:if ([:len (\$macRecords->\$address)] > 0) do={\r\ \n:local str (\$macRecords->\$address)\r\ \n:local newStr \"\$str,\$recordStr\"\r\ \n:set (\$macRecords->\$address) \$newStr} else={:set (\$macRecords->\$address) \$recordStr\ }}\r\ \n\r\ \n# TODO: add some logic to decide when we want to send data\r\ \n:local sendData true\r\ \n\r\ \n:if (\$sendData) do={\r\ \n:local jsonStr \"{\"\r\ \n\r\ \n:foreach addr,advRec in=\$macRecords do={\r\ \n:set jsonStr \"\$jsonStr\\\"\$addr\\\":[\$advRec],\"}\r\ \n\r\ \n:local payloadlength\r\ \n:set payloadlength [:len (\$jsonStr)]\r\ \n:local remcom\r\ \n:set remcom [:pick \$jsonStr 0 (\$payloadlength-1)]\r\ \n:set jsonStr \"\$remcom}\"\r\ \n:local message\r\ \n:set message \"\$jsonStr\"\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Message structured: \$message\")\r\ \n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message to MQTT broker...\")\r\

{ "2C:C8:1B:4B:BB:0A": [ { "ts": 1680526087729, "values": { "KNOT_1": "1", "rssi": -47 } } ], "DC:2C:6E:0F:C0:3D": [ { "ts": 1680526065000, "values": { "KNOT_1": "1", "rssi": -49 } }, { "ts": 1680526075001, "values": { "KNOT_1": "1", "rssi": -50 } } ] } The data is structured per the , where " " and " " are MAC addresses of tags that appeared ThingsBoard guide 2C:C8:1B:4B:BB:0A DC:2C:6E:0F:C0:3D in the KNOT's range, " " is unix timestamp of each payload broadcasted by the tag in milliseconds, " " indicates which specific KNOT has sent the ts KNOT_X message and " " is the signal strength of each payload broadcasted by the tag in dBm.rssi After the payload list is "searched" and the JSON message is structured, the Bluetooth interface payload list gets "cleaned" (or "flashed"), and the previously structured JSON message is sent to the ThingsBoard MQTT broker. To run the script, use the command: /system script run tracking Script that includes temperature data (optional) In case you wish to add temperature reports to the structured message, use the script below: /system script add dont-require-permissions=no name=tracking+temp owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="# Required package\ s: iot\r\ \n\r\ \n################################ Configuration ################################\r\ \n# Name of an existing MQTT broker that should be used for publishing\r\ \n:local broker \"tb\"\r\ \n\r\ \n# MQTT topic where the message should be published\r\ \n:local topic \"v1/gateway/telemetry\"\r\ \n\r\ \n# POSIX regex for filtering advertisement Bluetooth addresses. E.g. \"^BC:33:AC\"\r\ \n# would only include addresses which start with those 3 octets.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local addressRegex \"\"\r\ \n\r\ \n# POSIX regex for filtering Bluetooth advertisements based on their data. Same\r\ \n# usage as with 'addressRegex'.\r\ \n:local advertisingDataRegex \"\"\r\ \n\r\ \n# Signal strength filter. E.g. -40 would only include Bluetooth advertisements\r\ \n# whose signal strength is stronger than -40dBm.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local rssiThreshold \"\"\r\ \n\r\ \n#Name the KNOT. Identity of the unit that will be senting the message. This name will be \ reported to the MQTT broker.\r\ \n:local gwName \"1\"\r\ \n\r\

\n################################## Bluetooth ##################################\r\ \n:global invertU16 do={\r\ \n :local inverted 0\r\ \n :for idx from=0 to=15 step=1 do={\r\ \n :local mask (1 << \$idx)\r\ \n :if (\$1 & \$mask = 0) do={\r\ \n :set \$inverted (\$inverted | \$mask)\r\ \n }\r\ \n }\r\ \n return \$inverted\r\ \n}\r\ \n\r\ \n:global le16ToHost do={\r\ \n :local lsb [:pick \$1 0 2]\r\ \n :local msb [:pick \$1 2 4]\r\ \n\r\ \n :return [:tonum \"0x\$msb\$lsb\"]\r\ \n}\r\ \n:local from88 do={\r\ \n :global invertU16\r\ \n :global le16ToHost\r\ \n :local num [\$le16ToHost \$1]\r\ \n\r\ \n # Handle negative numbers\r\ \n :if (\$num & 0x8000) do={\r\ \n :set num (-1 * ([\$invertU16 \$num] + 1))\r\ \n }\r\ \n\r\ \n # Convert from 8.8. Scale by 1000 since floating point is not supported\r\ \n :return ((\$num * 125) / 32)\r\ \n}\r\ \n:put (\"[*] Gathering Bluetooth info...\")\r\ \n\r\ \n:global makeRecord do={\r\ \n :local jsonStr \"{\\\"ts\\\":\$ts,\\\"values\\\":{\\\"KNOT_\$gwName\\\":\\\"\$gwName\ \\\",\\\"temp\\\":\$temp}}\"\r\ \n :return \$jsonStr\r\ \n} \r\ \n\r\ \n# array of record strings collected for each advertising MAC address\r\ \n:global macRecords [:toarray \"\"]\r\ \n\r\ \n# process advertisements and update macRecords\r\ \n:local advertisements [/iot bluetooth scanners advertisements print detail as-value where\ \_\\\r\ \naddress ~ \$addressRegex and \\\r\ \ndata ~ \$advertisingDataRegex and \\\r\ \nrssi > \$rssiThreshold]\r\ \n\r\ \n/iot/bluetooth/scanners/advertisements clear\r\ \n\r\ \n:foreach adv in=\$advertisements do={\r\ \n:local address (\$adv->\"address\")\r\ \n:local ad (\$adv->\"data\")\r\ \n:local rssi (\$adv->\"rssi\")\r\ \n:local epoch (\$adv->\"epoch\")\r\ \n:local temp [\$from88 [:pick \$ad 28 32]]\r\ \n \r\ \n:local recordStr [\$makeRecord ts=\$epoch gwName=\$gwName temp=\$temp]\r\ \n\r\ \n:if ([:len (\$macRecords->\$address)] > 0) do={\r\ \n:local str (\$macRecords->\$address)\r\ \n:local newStr \"\$str,\$recordStr\"\r\ \n:set (\$macRecords->\$address) \$newStr} else={:set (\$macRecords->\$address) \$recordStr\ }}\r\ \n\r\ \n# TODO: add some logic to decide when we want to send data\r\ \n:local sendData true\r\ \n\r\ \n:if (\$sendData) do={\r\ \n:local jsonStr \"{\"\r\

\n\r\ \n:foreach addr,advRec in=\$macRecords do={\r\ \n:set jsonStr \"\$jsonStr\\\"\$addr\\\":[\$advRec],\"}\r\ \n\r\ \n:local payloadlength\r\ \n:set payloadlength [:len (\$jsonStr)]\r\ \n:local remcom\r\ \n:set remcom [:pick \$jsonStr 0 (\$payloadlength-1)]\r\ \n:set jsonStr \"\$remcom}\"\r\ \n:local message\r\ \n:set message \"\$jsonStr\"\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Message structured: \$message\")\r\ \n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message to MQTT broker...\")\r\ \n/iot mqtt publish broker=\"\$broker\" topic=\"\$topic\" message=\$message}" In this case, the JSON message would look like this: { "2C:C8:1B:4B:BB:0A": [ { "ts": 1680527467840, "values": { "KNOT_1": "1", "temp": 26460 } } ], "DC:2C:6E:0F:C0:3D": [ { "ts": 1680527464996, "values": { "KNOT_1": "1", "temp": 24750 } }, { "ts": 1680527474996, "values": { "KNOT_1": "1", "temp": 24750 } } ] } Script that includes GPS data (optional) In case you also wish to include GPS data (longitude and latitude values from the KNOTs), use the script shown below: /system script add dont-require-permissions=no name=tracking+gps+temp owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="# Required package\ s: iot\r\ \n\r\ \n################################ Configuration ################################\r\ \n# Name of an existing MQTT broker that should be used for publishing\r\ \n:local broker \"tb\"\r\ \n\r\ \n# MQTT topic where the message should be published\r\ \n:local topic \"v1/gateway/telemetry\"\r\ \n:local gwtopic \"v1/devices/me/telemetry\"\r\ \n\r\ \n# POSIX regex for filtering advertisement Bluetooth addresses. E.g. \"^BC:33:AC\"\r\ \n# would only include addresses which start with those 3 octets.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local addressRegex \"\"\r\ Because of the fact that floating point is not supported → every calculation behind a decimal point will be "rounded up" to a whole number. This is why the script will calculate the temperature and acceleration values (multiplied by ). scaled by 1000 1000 So, if you see the temperature as , the real temperature is . To add a decimal point, you will need to do an additional result temp=24750 24.750 C "translation" on the server side or with additional scripting on the RouterOS side, which will increase the CPU usage of the device.

\n\r\ \n# POSIX regex for filtering Bluetooth advertisements based on their data. Same\r\ \n# usage as with 'addressRegex'.\r\ \n:local advertisingDataRegex \"15ff\"\r\ \n\r\ \n# Signal strength filter. E.g. -40 would only include Bluetooth advertisements\r\ \n# whose signal strength is stronger than -40dBm.\r\ \n# To disable this filter, set it to \"\"\r\ \n:local rssiThreshold \"\"\r\ \n\r\ \n#Name the KNOT. Identity of the unit that will be senting the message. This name will be \ reported to the MQTT broker.\r\ \n:local gwName \"2\"\r\ \n\r\ \n###########GPS#############\r\ \n:global lat\r\ \n:global lon\r\ \n\r\ \n/interface ppp-client set ppp-out1 disabled=yes\r\ \n:log info (\"disabling WWAN to get GPS coordinates\")\r\ \n\r\ \n/interface ppp-client at-chat ppp-out1 input=\"AT+QGPSCFG=\\\"priority\\\",0\"\r\ \n:log info (\"enabling priority for GPS\")\r\ \n\r\ \n###the time in the delay below is the time that the device will wait for to get the coord\ inate fix\r\ \n:delay 32000ms\r\ \n:log info (\"reading GPS coordinates\")\r\ \n/system gps monitor once do={\r\ \n:set \$lat \$(\"latitude\")\r\ \n:set \$lon \$(\"longitude\")\r\ \n}\r\ \n:if (\$lat != \"none\") do={\\\r\ \n:log info (\"enabling priority back to WWAN\")\r\ \n/interface ppp-client at-chat ppp-out1 input=\"AT+QGPSCFG=\\\"priority\\\",1\"\r\ \n:log info (\"enabling WWAN\")\r\ \n/interface ppp-client set ppp-out1 disabled=no\r\ \n:delay 1000ms\r\ \n###if dial on demand is enabled\r\ \n/ping 1.1.1.1 count=1\r\ \n\r\ \n#the delay below waits for 5 seconds for the ppp connection to get established - this tim\ e can differ based on the signal strength\r\ \n:delay 5000ms\r\ \n:log info (\"posting coordinates via mqtt\")\r\ \n:local gpsmessage \\\r\ \n \"{\\\"latitude\\\":\$lat,\\\r\ \n \\\"longitude\\\":\$lon}\"\r\ \n/iot mqtt publish broker=\$broker topic=\$gwtopic message=\$gpsmessage} else={\\\r\ \n:log info (\"could not read GPS coordinates...enabling back WWAN\")\r\ \n/interface ppp-client at-chat ppp-out1 input=\"AT+QGPSCFG=\\\"priority\\\",1\"\r\ \n/interface ppp-client set ppp-out1 disabled=no\r\ \n:delay 1000ms\r\ \n###if dial on demand is enabled\r\ \n/ping 1.1.1.1 count=1\r\ \n:delay 5000ms\r\ \n}\r\ \n\r\ \n##################################Bluetooth##################################\r\ \n:global invertU16 do={\r\ \n :local inverted 0\r\ \n :for idx from=0 to=15 step=1 do={\r\ \n :local mask (1 << \$idx)\r\ \n :if (\$1 & \$mask = 0) do={\r\ \n :set \$inverted (\$inverted | \$mask)\r\ \n }\r\ \n }\r\ \n return \$inverted\r\ \n}\r\ \n\r\ \n:global le16ToHost do={\r\

\n :local lsb [:pick \$1 0 2]\r\ \n :local msb [:pick \$1 2 4]\r\ \n\r\ \n :return [:tonum \"0x\$msb\$lsb\"]\r\ \n}\r\ \n:local from88 do={\r\ \n :global invertU16\r\ \n :global le16ToHost\r\ \n :local num [\$le16ToHost \$1]\r\ \n\r\ \n # Handle negative numbers\r\ \n :if (\$num & 0x8000) do={\r\ \n :set num (-1 * ([\$invertU16 \$num] + 1))\r\ \n }\r\ \n\r\ \n # Convert from 8.8. Scale by 1000 since floating point is not supported\r\ \n :return ((\$num * 125) / 32)\r\ \n}\r\ \n:put (\"[*] Gathering Bluetooth info...\")\r\ \n\r\ \n:global makeRecord do={\r\ \n :local jsonStr \"{\\\"ts\\\":\$ts,\\\"values\\\":{\\\"KNOT_\$gwName\\\":\\\"\$gwName\ \\\",\\\"temp\\\":\$temp}}\"\r\ \n :return \$jsonStr\r\ \n} \r\ \n\r\ \n# array of record strings collected for each advertising MAC address\r\ \n:global macRecords [:toarray \"\"]\r\ \n\r\ \n# process advertisements and update macRecords\r\ \n:local advertisements [/iot bluetooth scanners advertisements print detail as-value where\ \_\\\r\ \naddress ~ \$addressRegex and \\\r\ \ndata ~ \$advertisingDataRegex and \\\r\ \nrssi > \$rssiThreshold]\r\ \n\r\ \n/iot/bluetooth/scanners/advertisements clear\r\ \n\r\ \n:foreach adv in=\$advertisements do={\r\ \n:local address (\$adv->\"address\")\r\ \n:local ad (\$adv->\"data\")\r\ \n:local rssi (\$adv->\"rssi\")\r\ \n:local epoch (\$adv->\"epoch\")\r\ \n:local temp [\$from88 [:pick \$ad 28 32]]\r\ \n \r\ \n:local recordStr [\$makeRecord ts=\$epoch gwName=\$gwName temp=\$temp]\r\ \n\r\ \n:if ([:len (\$macRecords->\$address)] > 0) do={\r\ \n:local str (\$macRecords->\$address)\r\ \n:local newStr \"\$str,\$recordStr\"\r\ \n:set (\$macRecords->\$address) \$newStr} else={:set (\$macRecords->\$address) \$recordStr\ }}\r\ \n\r\ \n# TODO: add some logic to decide when we want to send data\r\ \n:local sendData true\r\ \n\r\ \n:if (\$sendData) do={\r\ \n:local jsonStr \"{\"\r\ \n\r\ \n:foreach addr,advRec in=\$macRecords do={\r\ \n:set jsonStr \"\$jsonStr\\\"\$addr\\\":[\$advRec],\"}\r\ \n\r\ \n:local payloadlength\r\ \n:set payloadlength [:len (\$jsonStr)]\r\ \n:local remcom\r\ \n:set remcom [:pick \$jsonStr 0 (\$payloadlength-1)]\r\ \n:set jsonStr \"\$remcom}\"\r\ \n:local message\r\ \n:set message \"\$jsonStr\"\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Message structured: \$message\")\r\

\n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message to MQTT broker...\")\r\ \n/iot mqtt publish broker=\"\$broker\" topic=\"\$topic\" message=\$message}" This is where you need to keep in mind the → BG77 cellular modem (used in the KNOT) can not be used to have a cellular CAT-M BG77 modem behavior /NB-IoT ongoing connection and to obtain GPS coordinates at the same time. When the script is run: PPP interface is disabled and the highest priority is set for GPS reception (while the cellular PPP interface is down) for 32 seconds (this time can be altered in the script); (a) If the device managed to obtain GPS latitude value during the configured 32 seconds (if the value obtained equals anything other than "none"), the script will structure a JSON message with captured latitude and longitude values, the script will set the highest priority for WWAN (change the priority from GPS to WWAN) and enable PPP interface back (for internet access). After that, the script will send GPS data JSON message via the first MQTT publish and, the script will run the Bluetooth part, where the Bluetooth data JSON message is structured and sent via the second MQTT publish (x2 MQTT messages are sent → GPS data MQTT message and Bluetooth data MQTT message); (b) If the device fails to obtain GPS latitude value during the 32-second interval (if the value obtained equals "none"), the script sets the highest priority for WWAN (changes the priority from GPS to WWAN), enables PPP interface back (for internet access) and just processes the Bluetooth part, where the Bluetooth data JSON message is structured and sent via MQTT publish (basically, if GPS data could not be obtained, x1 MQTT message with Bluetooth data is sent). Scheduler Apply a scheduler to the script, so that RouterOS periodically initiates the script by itself: /system/scheduler/add name=bluetoothscheduler interval=50s on-event="/system/script/run tracking" You can set up shorter and longer intervals. If you want to send data more often, so that the data is "fresher" → set up shorter time intervals (10-15 seconds). If you want to send fewer messages, less often → you can set up longer time intervals (30min+). The JSON message structured using the script has a " " value (timestamp) assigned for each payload received. Meaning that , for ts when the script is run example, , 1 tag is used and 1 payload every 10 seconds (that is ) → ThingsBoard data (GUI) will be every minute the tag broadcasts 6 payloads per minute updated every minute, and every minute, 6 new entries will appear (each entry will indicate that it was received 10 seconds after the previous one). And if you send the message every 15 minutes when using 1 tag that is broadcasting a payload every 10 seconds (that is 6*15=90 payloads per 15 minutes) → ThingsBoard data (GUI) will be updated every 15 minutes but 90 entries will appear. ThingsBoard data visualization and result verification After you run the script with or via a scheduler and refresh the GUI portal → all MAC addresses (tags) that are found /system script run tracking in the JSON message, will be made into new devices under the ThingsBoard GUI: To help you visualize the data, you can use the built-in or create your own one. widgets Select the tag's MAC address from the list of devices, go to the "Latest telemetry" section, checkbox KNOT IDs that you wish to monitor, and click on the "Show on widget" button:

Select a widget that you wish to use, for example under the "Charts" bundle, "Timeseries Bar Chart" and click on "Add to dashboard": Create a new dashboard and name it, however, you like. Click on "Add": Change the widget's "Timewindow" from "Realtime-last minute" (which is used by default) to "Realtime-last 5 hours" and disable "data aggregation function" (select "none"):

To help you better visualize the result, edit the widget and then edit each "KNOT_X" parameter/key. Enable the "Show points" checkbox for each key: Check the ThingsBoard widget for more options that you have. guide The end result would look like this:

Per the dashboard, we can tell that: from ~11:00 to ~11:30, our asset was inside KNOT_1 Bluetooth range (inside warehouse #1); from ~11:30 to ~11:35, our asset was relocated to the vehicle (KNOT_2) that was parked near the warehouse (the tag was inside both KNOT's ranges); from ~11:35 to ~12:00, the tag was inside the truck (KNOT_2) - traveling to another warehouse; from ~12:00 to ~12:05, the asset was parked outside of warehouse #2, and it was inside both KNOT_2 and KNOT_3 ranges at the same time; from ~12:05 to 12:30, our asset was stored inside warehouse #2 (KNOT_3); from ~12.:30 onwards, the tag was on the road again, inside the truck (KNOT_2). Temperature visualization (optional) Select the tag's MAC address from the list of devices, go to the "Latest telemetry" section, checkbox " " parameter, and click on the "Show on widget" temp button: Select a widget that you wish to use, for example under the "Charts" bundle, "Timeseries Line Chart". Click on "Add to dashboard", and choose the dashboard where you want to add the widget. The result would look like this:

Now you have an additional graph that indicates how the tag's temperature changes during different time intervals. GPS coordinate visualization (optional) Per the script in the section, the script sends x2 MQTT messages. Each message is sent to a different MQTT topic. GPS Script that includes GPS data coordinate message will be posted to a topic named "1/devices/me/telemetry", while Bluetooth data will be posted to a topic named "v1/gateway /telemetry". Coordinates will be available to you under the ThingsBoard device list, under the specific gateway: Checkbox both "latitude" and "longitude" parameters, click on the "Show on widget button", select "Current bundle" to "Maps", and choose the "Route Map - OpenStreetMap" widget:

To finish things up, click on the "Add to dashboard" button and choose the dashboard where you want the widget to be shown. After adding 3 widgets into 1 dashboard (temperature line chart, Bluetooth reporter bar chart, and GPS coordinates map), you would get something similar to this: You will have a graph showing temperature changes (the tag's surrounding temperature); You will have the chart that indicates which specific KNOT has sent the report, that tells you in which KNOT's Bluetooth range the tag is currently in; You will have a map that shows the GPS position of the KNOT.

1. 2. 3. GPIO RouterOS configuration /iot gpio analog /iot gpio digital Different scenarios Controlling relays Monitoring input signal Monitoring voltage : In order to access GPIO settings, make sure that is installed beforehand. note iotpackage You can find more information about GPIO following the .link GPIO stands for General-Purpose Input/Output. It is a digital signal pin/pins on the routerboard that allows you to send/receive the signal. It can be useful in different scenarios, like: Measuring voltage through ADC input Reading 0 and 1 signal received from another device - "dry contact" Controlling connected relays by sending logical 0 or 1 signal to the pin RouterOS configuration :note GPIO settings are available only using CLI. Sub-menu: /iot gpio GPIO settings are divided into: analog (/iot gpio analog) digital (/iot gpio digital) :note in our examples, we are using as a reference device. Other devices may have a different pinout but the same principles apply. KNOT /iot gpio analog :note please check on a product page whether your hardware supports analog input or not. In the "analog" setting you can measure voltages on the analog input/ADC input pins: [admin@device] /iot gpio analog> print # NAME VALUE OFFSET 0 pin2 0mV 0mV 1 pin3 32mV 0mV "OFFSET" can be used to manually compensate voltage drop on the wires. "VALUE" is measured with: value = adc_input + offset , where adc_input is the voltage on the pin. "OFFSET" configuration example is shown below: Please note that long-term (6.47.10) and stable (6.48.3) versions, you have to use "/system gpio", command structure remains the same as in " /iot gpio" examples, aside from "analog" and "digital" sub-menus, which were added in later versions. Versions 6.49beta54+ and RouterOS v7, use "/iot gpio" sub-menu.

[admin@device] /iot gpio analog> set pin2 offset Offset ::= [-]Num[mV] Num ::= -2147483648..2147483647 (integer number) [admin@device] /iot gpio analog> set pin2 offset 2 [admin@device] /iot gpio analog> print # NAME VALUE OFFSET 0 pin2 2mV 2mV 1 pin3 0mV 0mV /iot gpio digital In the "digital" section you can send/receive a logical 0 or 1 signal using the digital output/input pins (output pins are "open drain"): [admin@device] /iot gpio digital> print Flags: X - disabled # NAME DIRECTION OUTPUT INPUT SCRIPT 0 pin5 input 0 0 1 pin4 output 0 2 pin6 output 0 "DIRECTION" for the pin can be either "input" (a pin that can receive the signal) or "output" (a pin that can send the signal). When the pin's direction is set to "output", you can configure the "OUTPUT" value. Changing the "OUTPUT" value sends the signal to the pin. [admin@device] /iot gpio digital> set pin4 output= Output ::= 0 | 1 [admin@device] /iot gpio digital> set pin4 output=1 [admin@device] /iot gpio digital> print Flags: X - disabled # NAME DIRECTION OUTPUT INPUT SCRIPT 0 pin5 input 0 0 1 pin4 output 1 2 pin6 output 0 The "SCRIPT" field allows you to configure a script, that will be initiated whenever the "INPUT" or "OUTPUT" value changes (from 0 to 1 or from 1 to 0). KNOT pin's "DIRECTION" for pin4 and pin6 can not be changed. Both pins are meant to be used only as "output" pins.

[admin@device] /iot gpio digital> set pin4 script=script1 [admin@device] /iot gpio digital> set pin5 script="/system .." [admin@device] /iot gpio digital> print Flags: X - disabled # NAME DIRECTION OUTPUT INPUT SCRIPT 0 pin5 input 0 0 /system .. 1 pin4 output 1 script1 2 pin6 output 0 Different scenarios Controlling relays One of the scenarios for the GPIO implementation is "controlling other relays" using digital output pins. Basically, sending "0" or "1" signal to the unit that is connected to the pin. To automate the process, you can use a , which will run the script at specific times. scheduler For example, you can add the first (a single line shown below) and name it "output=0": script /iot gpio digital set pin4 output=0 Then add a second script (a single line shown below) and name it "output=1": /iot gpio digital set pin4 output=1 Having both scripts, you can configure a schedule: [admin@device] /system scheduler> add name=run-30s interval=30s on-event="output=0" The schedule configuration shown above will run the script with the name "output=0", every 30 seconds. [admin@device] /system scheduler> add name=run-45s interval=45s on-event="output=1" The schedule configuration shown above will run the script with the name "output=1", every 45 seconds. As a result, the device will automatically send a signal to the 4th pin (digital output pin) with output value=0 every 30 seconds and a signal with output value=1 every 45 seconds. You can change the scheduled time as you see fit (depending on the requirements). Monitoring input signal Another scenario is to "monitor input signal" using the digital input pins. You need a script that will initiate e-mail notification or MQTT/HTTPS (fetch) publish whenever the "INPUT" value changes for the pin with the direction="input" (whenever the RouterOS device receives a signal "0 or 1" from another device connected to the pin). E-mail notification script: /tool e-mail send to=config@ subject=[/system identity get name] body="$[/iot gpio digital get pin5 input]" mydomain.com After creating a script, apply/set it to the "input" pin:

[admin@device] /iot gpio digital> set pin5 script=script1 [admin@device] /iot gpio digital> print Flags: X - disabled # NAME DIRECTION OUTPUT INPUT SCRIPT 0 pin5 input 0 0 script1 1 pin4 output 0 script1 2 pin6 output 0 In the example above, the e-mail notification script is named "script1". As a result, whenever the input value changes (from 0 to 1 or from 1 to 0), the script automatically initiates an e-mail notification that will display the input value in the e-mail body. Do not forget to change the script line and configure the e-mail settings ( ) accordingly: /tool e-mail /tool e-mail send to="config@ " subject="[/system identity get name]" body="$[/iot gpio digital get pin5 input]" mydomain.com Configure the actual e-mail address that you use. You can also change the subject and the body for the mail as you see fit. MQTT publish script: :local broker "name" :local topic "topic" :local message "{\"inputVALUE\":$[/iot gpio digital get pin5 input]}" /iot mqtt publish broker=$broker topic=$topic message=$message This script works the same way as the " " script, only when the input value changes the script initiates MQTT publish (instead of e-mail e-mail notification notification) and sends the input value received on the pin in the JSON format. Do not forget to set up MQTT broker ( ) and alter a few script lines beforehand: /iot mqtt brokers add .. :local broker "name" The broker's "name" should be changed accordingly (you can check all created brokers and their names using CLI command / ). iot mqtt brokers print :local topic "topic" The topic should be changed as well. The topic itself is configured on the server-side, so make sure that the correct topic is used. Do not forget to apply/set the script to pin5 (/iot gpio digital set pin5 script=script_name), as shown in the "email notification" example above. If the mechanical switch is used to send the signal to the GPIO pin, it is suggested to use the following script instead (in case the script is initiated more than once when the signal is received on the pin): :global gpioscriptrunning; if (!$gpioscriptrunning) do={:set $gpioscriptrunning true; :log info "script started - GPIO changed"; :do {if ([/iot gpio digital get pin5 input] = "0") do={/tool e-mail send to="config@ " subject=[/system identity get name] mydomain.com body="pin5 received logical 0"} else {/tool e-mail send to="config@ " subject=[/system identity get name] body="pin5 mydomain.com received logical 1"}; :delay 1s; :set $gpioscriptrunning false} on-error={:set $gpioscriptrunning false; :log info "e-mail error, resetting script state..."}}

If the GPIO pin state changes more than once within mili/microseconds - the script above is going to make sure that e-mail notification is not sent more than once. Monitoring voltage Last but not least - is to "monitor voltage" using the analog pins. You need a script that will read/monitor voltage on schedule and then send the data via e- mail, MQTT or HTTPS (fetch). Create a script, as shown below. In this example, we will be using MQTT publish (but you can create a similar script with "/tool e-mail .." to use e-mail notifications): :local broker "name" :local topic "topic" :local message "{\"voltage(mV)\":$[/iot gpio analog get pin3 value]}" /iot mqtt publish broker=$broker topic=$topic message=$message The script will read/measure the voltage on pin3 and publish the data to the MQTT broker. Do not forget to set up MQTT broker ( ) and alter a few script lines beforehand: /iot mqtt brokers add .. :local broker "name" The broker's "name" should be changed accordingly (you can check all created brokers and their names using CLI command / ). iot mqtt brokers print :local topic "topic" The topic should be changed as well. The topic itself is configured on the server-side, so make sure that the correct topic is used. Save the script and name it, for example, "voltagepublish". To automate the process, you can use the . scheduler [admin@device] /system scheduler> add name=run-45s interval=45s on-event="voltagepublish" The schedule configuration shown above will run the script every 45 seconds.

General Properties Properties Channels Join EUI Network ID Servers Traffic Debugging Every RouterBOARD with a miniPCI-e slot which supports LTE modems can also be used as a LoRaWAN gateway by installing or R11e-LoRa8 R11e- card. Both UDP and LNS (starting with testing version) protocols are supported. LoRa9 v7.12rc1 In order to work with Lora, IoT package should be installed. You can find the package for your device architecture in extra packages archive on the download page. Properties This menu is used to apply settings to the LoRa interface. Sub-menu: /iot lora Property Description antenna-gain ( ; integer [-128..127] Default: )0Antenna gain in dBi. This value should be equal to minus . Using 6.5 dBi setup-antenna-gain cable-loss antenna, 6.5 is the value to be configured (not taking into account cable loss). Output power of the gateway is dictated by the server. The gateway will calculate its actual output power by subtracting setting from (value received in the downlink message). antenna-gain server_value channel-plan (as-923 | au-915 | custom | eu-868 | in-865 | kr-920 | ru-864 | ru-864-mid | us-915-1 | ; Default: ) us-915-2 eu-868Frequency plans for various regions. disabled ( ; Default: ) yes | no yes Whether LoRaWAN gateway is disabled. forward (ccrc-validtaion | dev- addr-validtaion | proprietary-traffic ; Default: ) crc-validtaionDefines what kind of packets should be forwarded to Network server: crc-validtaion - Forward valid packets with correct CRC. dev-addr-validtaion - Checks if DevAddr of the packet corresponds to the NetID and if not, drops the packet. The following sequence happens: 1) Dev. Addr value gets "obtained" from the received LoRa packet; 2) Dev. Addr is "compared" against list; 3) If there is no Net ID for the Dev. Addr, the packet is not "valid" Net IDs forwarded; 4) If Net ID is valid, Dev. Addr range is valid, the packet is forwarded. proprietary-traffic - Checks the content of the LoRa packet and if the "type" of the frame is "proprietary", the packet is not forwarded. gateway-id (string) Gateway ID or Gateway EUI, is used when registering the gateway with the server. lbt-enabled ( ; Default: ) yes | no no Whether gateway should use LBT (Listen Before Talk) protocol. Starting with v (stable), LoRa functionality is moved into the that is available on the 7.11 IoT package download page under extra packages. A separate Lora package is still available for download. When using IoT package, LoRa functionality will move to a sub-menu. When using LoRa package, LoRa functionality will be /iot lora possible via sub-menu./lora LoRa package is not obligatory anymore and is left only for compatibility reasons. : note RouterOS does not support 3rd party LoRaWAN gateway cards.

listen-time (integer [0us.. ; Default: ) 4294967295us] 5000usTime in microseconds to track RSSI before TX (used when ). lbt-enabled=yes name ( ; Default: ) string Name of LoRaWAN gateway. network ( ; Default: private | public ) publicWhether sync word should (network=private) or should not (network=public) be used. rssi-threshold (integer [-32,768 .. ; Default: ) 32,767] -65dBRSSI value to determine whether forwarder may use specific channel to talk. If RSSI value is below , rssi-threshold channel could be used (used when ). lbt-enabled=yes servers ( ; Default: ) list of string Name of the server from the section. /iot lora servers src-address (; Default: )IP Specifies uplink packet source address if necessary (address should match an address configured on the RB). spoof-gps ( ; Default: ) string Set custom GPS location: Latitude [-90..90] Longitude [-180..180] Altitude( ) [-2147483648..2147483647]m Channels This section is used to alter channel/frequency related settings. Sub-menu: /iot lora channels Property Description bandwidth (7.8_kHz | 15.6_kHz | 31.2_kHz | 62.5_kHz | ; Default: ) 125_kHz | 250_kHz | 500_kHz 125_kHzBandwidth of specific channel, predefined when any of channel-plan preset is used, but could be manually changed when channel-plan is set to custom. disabled ( ; Default: ) yes | no no Disable or enable the channel. freq-off ( ) [-400000..400000]; Default: integer Channel frequency offset against radio central frequency, it makes possible to adjust channel frequencies so that channels does not overlap. radio ( ; Default: ) radio0 | radio1 Defines which radio uses selected channel. spread-factor ( ; SF7 | SF8 | SF9 | SF10 | SF11 | SF12 Default: )Defines the Spread Factor for a channel with type=LoRa. Lower Spread Factor means higher data rate. To view current channels, issue the command : /iot lora cannels print /iot lora channels print Columns: NAME, TYPE, RADIO, FREQ-OFF, BANDWIDTH, FREQ, SPREAD-FACTOR, DATARATE # NAME TYPE RADIO FREQ-OFF BANDWIDTH FREQ SPREAD-FACTOR DATARATE 0 gateway-0 MSF radio1 -400000 125_kHz 868.1 1 gateway-0 MSF radio1 -200000 125_kHz 868.3 2 gateway-0 MSF radio1 0 125_kHz 868.5 3 gateway-0 MSF radio0 -400000 125_kHz 867.1 4 gateway-0 MSF radio0 -200000 125_kHz 867.3 5 gateway-0 MSF radio0 0 125_kHz 867.5 6 gateway-0 MSF radio0 200000 125_kHz 867.7 7 gateway-0 MSF radio0 400000 125_kHz 867.9 8 gateway-0 LoRa radio1 -200000 250_kHz 868.3 SF7 9 gateway-0 FSK radio1 300000 125_kHz 868.8 50000 Once the server is selected and LoRa interface is enabled using command, the device will start operating as a /iot lora enable [find] LoRaWAN gateway. It will start forwarding LoRa payloads from the tab to the configured server. /iot lora traffic

Channels are created using and radio's frequencies. To view center frequencies use the command freq-off center-freq radios /iot lora . radios print To understand how each channel's frequency is calculated, check the example below: # NAME TYPE RADIO FREQ-OFF BANDWIDTH FREQ SPREAD-FACTOR DATARATE 0 gateway-0 MSF radio1 -400000 125_kHz 868.1 radio1 is selected to be used for channel #0 and it is configured with (868500000 Hz or 868.5 MHz). center-freq=868500000 By using frequency offset, (-400000 Hz or -0.4 MHz), we define channel #0 to be Hz or 868.1 freq-off=-400000 868500000-400000=868100000 MHz. Join EUI The gateway will forward to the server every single LoRaWAN payload it receives. That includes neighboring LoRaWAN node's payloads as well. It might not be ideal to forward everything, as, for example, it can increase the data amount used (and directly impact ISP plan cost). The Join EUI menu allows you to specify a range of Join EUI's that the gateway will forward. After adding the range, make sure to apply it to the server settings. If the Join EUI of the packet does not match the configuration, the packet is not forwarded to the server. You can find the Join EUI used by your node with the help of RouterOS GUI. Go to the "LoRa" section and to the "Traffic" sub-menu (which is only available using the graphical interface). After you power your LoRaWAN node, the node should send a "Join-request" packet. Double-click on it to inspect it: Sub-menu: /iot lora joineui Property Description joineui ( ; Default: ) string Define a range of Join EUI's. logging ( ; Default: no) yes | no Enables additional logging for the filter feature. name ( ; Default: ) string Define the name for the range. To configure custom channels, select "custom" channel profle with the help of the command: /iot lora set [find] channel-plan=custom

An example of Join EUI would look like this . It consists of 8 octets in HEX format. E0 E1 E2 01 02 03 04 05 To add a range that allows Join EUI, add a filter like this: every possible /iot lora joineui add name=ALL joineuis=0000000000000000-ffffffffffffffff To add a range that allows "nothing" (basically "restrict" all Join EUI's), add a filter like this: /iot lora joineui add name=NONE joineuis=0000000000000000-0000000000000000 For a specific single Join EUI, add a filter like this: /iot lora joineui add name=SINGLE joineuis=E0E1E20102030405-E0E1E20102030405 Network ID The gateway will forward to the server every single LoRaWAN payload it receives. That includes neighboring LoRaWAN node's payloads as well. It might not be ideal to forward everything, as, for example, it can increase the data amount used (and directly impact ISP plan cost). The NetID menu allows you to specify a list of NetIDs that the gateway will forward. After adding the list, make sure to apply it to the settings. server If the NetID (DevAddr range) of the packet does not match the configuration, the packet is not forwarded to the server. NetIDs define the ranges of Device Addresses (DevAddr) that were assigned to different operators/servers by the LoRaWAN Alliance. A list with most ranges can be found in the . TTN guide DevAddr is assigned to the LoRaWAN node by the LoRaWAN server after the communication with the server takes place. For example, will assign TTN your node an address from within the range 26000000 - 27FFFFFF. You can find it under the LoRaWAN server dashboard or using RouterOS GUI, under the "Traffic" sub-menu (after "join-request" and "join-accept" communication takes place) in the Dev Addr column/field. Let's say TTN assigned Dev Addr to your node. Based on the , it falls under the 26000000 - 27FFFFFF DevAddr range and it 26 1B D8 D1 TTN guide belongs to the . 000013 NetID Sub-menu: /iot lora netid Property Description netids ( ; Default: ) string Define the NetIDs logging ( ; Default: no) yes | no Enables additional logging for the filter feature. name ( ; Default: ) string Define the name for the ID. To add a filter for a specific NetId, use the command (you can add more than one using a "comma" separator): /iot lora netids add name=TTN netids=000013 Servers This section is used to add new or alter current server settings. Sub-menu: /iot lora servers There are a few predefined servers that can be used (it requires to make an account to use them): The Things Network

13:50:33 lora,info gateway-0 forwarder started 13:50:38 lora,info [LNS] connecting to wss://eu1.cloud.thethings.network:8887/router-info 13:50:39 lora,info [LNS] eu1.cloud.thethings.network discovered 13:50:39 lora,info [LNS] eu1.cloud.thethings.network disconnected 13:50:39 lora,info [LNS] connecting to wss://eu1.cloud.thethings.network:8887/traffic/eui-xxxx 13:50:39 lora,info [LNS] eu1.cloud.thethings.network configured 13:50:52 lora,info gateway-0 forwarder is ready More logging information can be found in our guide.Log

Setup Step by step installation AWS LoRaWAN configuration The Things Network The Things Stack

AWS LoRaWAN configuration AWS - Registering the gateway Step 1 - add gateway Step 2 - configure your gateway RouterOS - Connecting the gateway Uploading and importing certificates Server configuration LNS scenario CUPS scenario Connection verification Before we proceed with the settings, you need to create an account in the AWS system. You can find more information on how to do that following this .link After you are logged-in, go to section on the portal. Services>IoT Core AWS - Registering the gateway The first step is to register the LoRaWAN gateway. Navigate to the section (under ). Gateways LPWAN devices Click on the " " button. Add gateway Step 1 - add gateway Input the gateway's EUI; Select device's frequency band; Configure optional fields if required; This scenario will work starting with RouterOS version . 7.14beta8

Finish the step by clicking on the " " once again. Add gateway In RouterOS settings, gateway's EUI and frequency plan can be checked under tab: IoT>LoRa>Devices Step 2 - configure your gateway Generate a gateway certificate (" " button), and download the certificate file and private key files (" " Create certificate Download certificate files button); Copy CUPS and LNS endpoints and download server trust certificates (" " button); Download server trust certificates Add suggested gateway permissions;

Finish the step by clicking on " ". Submit You will be redirected to the page where your newly created gateway should appear. RouterOS - Connecting the gateway Uploading and importing certificates Before we proceed with the setup, you need to download and upload it, together with the gateway certificate file and its key, into the Amazon Root CA RouerOS file list menu:

After the files were uploaded, import the certificates, one by one (under ): System>Certificates Make sure to upload the gateway certificate first and then its key (so that the gateway certificate has both K-key and T-trusted flags present). In the end, you should have all 3 file imported, like so:

Server configuration LNS scenario Navigate to the tab and add a new server: IoT>LoRa>Servers Name the server; Input LNS endpoint address (without " " and " "); wss:// :443 Select LNS protocol; Change port to "443"; Enable SSL checkbox; Select gateway certificate. Make sure to apply newly configured server under tab: IoT>LoRa>Devices

And then, the LoRa interface. enable CUPS scenario Navigate to the tab and add a new server: IoT>LoRa>Servers Name the server; Input CUPS endpoint address (without " " and " "); https:// :443 Select CUPS protocol; Change port to "443"; Enable SSL checkbox; Select gateway certificate. Make sure to apply newly configured server under tab: IoT>LoRa>Devices

And then, the LoRa interface. enable Connection verification If everything is configured correctly, you should see "connected" status on the AWS portal:

Step by step installation LoRa card installation LtAP LTE kit will be used as example in this section. Open your routers case. Once you have removed all the screws carefully move the upper case to the left side, as the LTE antennas are attached to the inner side of it. Insert R11e-LoRa card into the mini-PCIe slot and apply two screws to the threaded inserts.

Attach antenna to the card (UFL connector) In this case UFL → SMA cable is also used, as the LtAP's case has a specific slot for it. Once the previous steps are done, you can close the routers case and move on to configuration.

Configuration GUI setup Connect to your router via Winbox or WebFig. Winbox can be downloaded in the link given below: https://mikrotik.com/download It is Highly recommended to upgrade your RouterOS version to the latest available. Installing the version will perform a reboot:

If your device does not have menu, download " " specifically for your routers architecture and rOS version. You can see the type IoT>LoRa Extra packages of your routers architecture at the top of Winbox window or in System → Resources → Architecture Name. https://mikrotik.com/download

Once the package is downloaded and extracted, upload the package to your router. It can be done via drag & drop as well. It should appear in the files IoT folder after the upload is complete, reboot your router (System → Reboot) to install the package:

After the reboot, the package should be visible in the Package list:

Check if the LoRa gateway has initialized under . If it is LtAP model, make sure to set USB Type to Mini-PCIe: IoT>LoRa>Devices

Once the gateway has shown up (under ) select it, choose Network Servers from the default ones or add your own (under IoT>LoRa>Devices IoT>LoRa>Se ) and enable it: rvers Navigate to Traffic tab to monitor the surrounding nodes sending requests:

This concludes basic installation and configuration of LoRa mini-PCIe cards. For additional settings check: General Properties

The Things Network Once you have installed the lora package on your router and created an account on you can set up a running gateway The Things Network Login into your account and go to Console and select Gateways Select and fill in the blank spaces. Gateway EUI can be found in your lora interface register gateway You will have to manually add the Network Servers, or you can upgrade your router to the stable version and these servers will be added 6.48.2 automatically (highly recommended) https://wiki.mikrotik.com/wiki/Manual:Upgrading_RouterOS

/lora servers add address=eu1.cloud.thethings.industries down-port=1700 name="TTS Cloud (eu1)" up-port=1700 add address=nam1.cloud.thethings.industries down-port=1700 name="TTS Cloud (nam1)" up-port=1700 add address=au1.cloud.thethings.industries down-port=1700 name="TTS Cloud (au1)" up-port=1700 After everything is filled press Register Gateway at the bottom of the page. If you have set everything accordingly to the previous steps you should see that your lora gateway is now connected At this point everything is set and you have a working lora gateway. You can monitor incoming packets in Traffic section

*Later this year, The Things Network will be migrating to a new version of network server, called . The Things Stack

The Things Stack Selecting a region Registering gateway UDP protocol gateway registration UDP scenario RouterOS settings LNS and CUPS protocol gateway registration LNS scenario RouterOS settings CUPS scenario RouterOS settings Verification Selecting a region The Things Stack is a new version of The Things network. Choose your region and login with The Things network account or other credentials. Registering gateway Once logged in, navigate to "Go to gateways":

Register a gateway by clicking on the " " button: + Register gateway UDP protocol gateway registration Fill in the blank spaces. Input . Make sure to select a correct frequency plan. Do not enable " " option (it is Gateway EUI Require authenticated connection used for LNS and CUPS)!

In RouterOS, value can be found under " "): Gateway EUI IoT>LoRa>Devices>Gateway ID For additional information check their . documentation page UDP scenario RouterOS settings Double-check that the correct TTN server is selected by the LoRa device (in RouterOS) and that the server setting uses "UDP" protocol:

LNS and CUPS protocol gateway registration Fill in the blank spaces. Input . Make sure to select a correct frequency plan. Enable " " and the follow-up (for Gateway EUI Require authenticated connection LNS) " " and (for CUPS) " " options: Generate API key for LNS Generate API key for CUPS

In RouterOS, value can be found under " ": Gateway EUI IoT>LoRa>Devices>Gateway ID After clicking on " " button, you should be prompted to download the keys. Download them. Register gateway To view LNS and CUPS keys, inspect download files. LNS key should also be visible under the " " field: LoRa Basics Station LNS authentication Key

For additional information check their . documentation page LNS scenario RouterOS settings Make sure that the correct TTN server is selected, that the correct port is configured (TTN expects LNS over 8887), that LNS protocol is chosen, that the LNS key (from the " " field) is input and that " " checkbox is enabled: LoRa Basics Station LNS authentication Key SSL

The last step is to download and import . The page has links to the required file. Root Certificates After the certificate file was downloaded, drag and drop it into the RouterOS file menu and import the certificate list:

This should make the certificate list trusted: CUPS scenario RouterOS settings Make sure that the correct TTN server is selected, that the correct port is configured (TTN expects CUPS over 443), that CUPS protocol is chosen, that the CUPS key is input and that " " checkbox is enabled:SSL

The last step is to download and import . The page has links to the required file. Root Certificates After the certificate file was downloaded, drag and drop it into the RouterOS file menu and import the certificate list:

This should make the certificate list trusted: Verification If everything is configured in correctly, right after you enable the LoRa interface in RouterOS (" "): IoT>LoRa>Devices>Enable

You should see the gateway connection "Live data" update:

MQTT Summary Configuration Brokers Connect Disconnect Publish Subscribe Subscriptions Unsubscribe Publishing RouterOS statistics using scripts Summary MQTT is an open OASIS and ISO standard lightweight, publish-subscribe network protocol that transports messages between devices. A typical MQTT communication topology consists of: an MQTT publisher → a device that sends information to the server; an MQTT broker → a server where the data is stored; an MQTT subscriber → a device that reads/monitors the data published on the server. RouterOS can act as an MQTT publisher and subscriber (starting with ). You can also run an MQTT broker/server via the feature. For 7.11beta2 container Mosquitto MQTT broker configuration visit the . link here You can find application examples for MQTT publish scenarios below: a) MQTT/HTTPS example with AWS cloud platform b) MQTT example with Azure cloud platform c) MQTT and ThingsBoard configuration Please note that AWS and Azure examples (scripts) showcase publishing Bluetooth tag data. Currently, only the has a Bluetooth chip built-in. KNOT Configuration Sub-menu: /iot mqtt : note iot package is required. IoT package is available with RouterOS version 6.48.3. You can get it from our - under "Extra packages". download page Property Description brokers A list of configured MQTT brokers. connect A command that specifies, which broker to connect to. disconnect A command that specifies, which broker to disconnect from. publish A command that defines the MQTT message that needs to be published. subscribe A command that defines MQTT topics to subscribe to. subscriptions A list of subscribed topics and received messages. unsubscribe A command that specifies, which topic to unsubscribe from. Brokers To add a new MQTT broker (or an MQTT server), run the following command:

/iot mqtt brokers add Configurable properties are shown below: Property Description address ( ; IP|hostname Default: )IP address or hostname of the broker. auto-connect ( ; yes | no Default: )noWhen enabled, after the connection with the MQTT broker goes down/gets interrupted, RouterOS will try to re-establish the connection over and over again. certificate ( ; Default: string )The certificate that is going to be used for the SSL connection. client-id ( ; Default: ) string A unique ID used for the connection. The broker uses this ID to identify the client. keep-alive (integer:30.. ; Default: ) 64800 60A parameter that defines the time (in seconds), after which the client should "ping" the MQTT broker that it is "alive", to ensure the connection stays ongoing. This value should be set according to MQTT broker settings. name ( ; Default: ) string Descriptive name of the broker. parallel-scripts-limit (integ Default: off) er:3..1000; A parameter that defines how many scripts the feature for this broker is allowed to run at the exact same time. on-message Can be useful to reduce CPU, in cases when a large number of messages are constantly published. password ( ; Default: string )Password for the broker (if required by the broker). port (integer: 0.. ; Default: 4294967295 1883 )Network port used by the broker. ssl ( ; Default: ) yes | no no Secure Socket Layer configuration. username ( ; string Default: )Username for the broker (if required by the broker). An example of adding a broker: /iot mqtt brokers add name="broker" address="192.168.88.33" port=1883 ssl=no client-id="test-client" auto- connect=no keep-alive=60 The result: /iot mqtt brokers print 0 name="broker" address="192.168.88.33" port=1883 ssl=no client-id="test-client" auto-connect=no keep-alive=60 connected=no Connect To connect to the pre-configured MQTT broker, issue the command: /iot mqtt connect broker="broker" If the connection is successful, the " " parameter should change to " ": connected yes /iot mqtt brokers print 0 name="broker" address="192.168.88.33" port=1883 ssl=no client-id="test-client" auto-connect=no keep-alive=60 connected=yes

Disconnect To disconnect from the MQTT broker, issue the command: /iot mqtt disconnect broker="broker" To confirm that the broker was disconnected, issue the command below and it should indicate " ": connected=no /iot mqtt brokers print 0 name="broker" address="192.168.88.33" port=1883 ssl=no client-id="test-client" auto-connect=no keep-alive=60 connected=no Publish Publish menu is used to send MQTT messages to the MQTT broker. Property Description broker (string ; Default: )Select the broker, where to publish the message. disconnect- after (yes | ; Default: no )noParameter, that ensures that the connection with the broker will be automatically disconnected after the publish message is sent. force (yes | ; Default: no )yesIf set to "yes", when the connection with the broker is not yet established (" "), and the message is attempted to be connected=no published, RouterOS will try to establish an MQTT connection with the specified broker first and then publish the message. If set to "no", RouterOS will not be able to send the message, unless the connection is already established beforehand (" "). connected=yes message (st ; ring Default: )The message that you wish to publish to the broker. qos (integer: 0.. 4294967295 ; Default: )0Quality of service parameter, as defined by the broker. retain (yes | ; Default: no )noWhether to retain the message or to discard it if no one is subscribed to the topic. This parameter is defined by the broker. topic ( ; string Default: )Topic, as defined by the broker. An example of publishing the message: /iot mqtt publish message="test-message" broker="broker" topic="my/test/topic" Subscribe This menu is used to subscribe to MQTT topics from the broker. Property Description Please remember that if you have an on-going connection with the broker (the connection is in the " " status) and you subscribe connected=yes to the topic via that broker, you have to re-establish the connection!

broker (string ; Default: )Select the broker, where to subscribe to. force (yes | ; Default: no )yesIf set to "yes", when the connection with the broker is not yet established (" "), and subscription is attempted, RouterOS will connected=no try to establish an MQTT connection with the specified broker first and then subscribe to the topic. If set to "no", RouterOS will not be able to subscribe to the topic, unless the connection is already established beforehand (" "). connected=yes qos (integer: 0.. 4294967295 ; Default: )0Quality of service parameter, as defined by the broker. topic ( ; string Default: )Topic, as defined by the broker, where to subscribe to. An example of a subscription: /iot mqtt subscribe broker="broker" topic="my/test/topic" Wildcard (single level " " and multi-level " ") subscriptions are also supported (RouterOS to wildcard topics + # does not allow publishing but allows subscribing to them): /iot mqtt subscribe broker="broker" topic="my/test/#" /iot mqtt subscribe broker="broker" topic="my/test/+" This means that if you subscribe to , you will be able to receive messages published to any topic that begins with the pattern before topic="my/test/#" the wildcard symbol "#" (e.g., , ). "my/test/topic" "my/test/topic/something" And, if you subscribe to , you will be able to receive messages published on the topic +1 level (e.g., , topic="my/test/+" "my/test/topic" "my/test ). /something" Subscriptions This section is used to manage already-added subscriptions (that were previously added via the section). Subscribe It has the same properties as the section. Subscribe Property Description on-message ( ; Default: ) string Configure a that will be automatically initiated/run whenever a new message is received in the subscribed topic. script To check already subscribed topics, issue the command: /iot mqtt subscriptions print 0 broker=broker topic="my/test/topic" qos=0 After you publish a test message as shown in the section above: Publish /iot mqtt publish message="test-message" broker="broker" topic="my/test/topic" You should be able to check the received message under: /iot mqtt subscriptions recv print 0 broker=broker topic="my/test/topic" data="test-message" time=2023-05-22 16:57:00 Starting with , this menu allows you to add the " " setting to your subscriptions. v7.12beta9 on-message

1. 2. 3. To clear stored messages, issue the command: /iot mqtt subscriptions recv clear To run a (for example, a basic "log" script) whenever any new message appears in the subscribed topic, you can use the feature: script on-message /iot mqtt subscriptions set on-message={:log info "Got data {$msgData} from topic {$msgTopic}"} broker=broker 0 The script can use and variables. defines the MQTT message that was published and defines the MQTT $msgData $msgTopic $msgData $msgTopic topic, where the message was published. Both variables are automatically generated when a new message appears. After you publish a new MQTT message to the subscribed topic, a new log entry should appear: /log print 10:19:15 script,info Got data {test-message} from topic {my/test/topic} A second example shows how to run a script whenever a specific message (keywords from the message) appears. To achieve a scenario, where we want to run a script only when the MQTT message has specific content or a keyword, we can utilize the : if condition statement /iot mqtt subscriptions set 0 on-messag={:if ($msgData~"\\{\"test\":\"123\"\\}") do={:log info "Got data {$msgData} from topic {$msgTopic}"}} Or: /iot mqtt subscriptions set 0 on-messag={:if ($msgData~"test") do={:log info "Got data {$msgData} from topic {$msgTopic}"}} As a result, on every received MQTT message, the script will check whether the if condition is true. If it is true (if contains the JSON string $msgData {"test": or if contains the string " "), the log entry will be generated. Otherwise, nothing will happen. "123"} $msgData test Meaning, the script will be run only when you publish a message like this: /iot mqtt publish broker=broker topic="my/test/topic" message="{\"test\":\"123\"}" When you receive a message from a topic that falls under multiple subscriptions with configuration, only script will be run. on-message x1on-message RouterOS will choose which script to run using the following logic/priority: on-meesage If the topic configured for the subscription is an exact match → first priority; If the topic name is not an exact match (wildcard is used) → the second priority is for single 1v1 wildcard topics; If the topic does not fall under the single 1v1 wildcard category → the third priority is for multi-level wildcard topics based on the topic level. An example: Received message list is limited to 1024 entries. After which, older entries will get overwritten with the new ones. $msgData and variables will not work when used in the " " section created scripts, meaning, they will not $msgTopic System>Script work inside "/iot mqtt subscriptions set " added scripts. Both variables will work only when they are on-message={/system script run x} used inside the " " written script, like, for example, " on-message={} on-message={:log info "Got data {$msgData} from topic ". {$msgTopic}"} The same applies to variable usage. If there are global variables that are "generated" using other scripts (variables that appear global under System>Script>Environment section), they will not work inside the "on-message" script.

/iot mqtt subscriptions print 0 broker=broker topic="some/sort/of/topic" qos=0 on-message="/system script run script1" 1 broker=broker topic="some/#" qos=0 on-message="/system script run script2" 2 broker=broker topic="some/sort/of/+" qos=0 on-message="/system script run script3" 3 broker=broker topic="some/thing/#" qos=0 on-message="/system script run script4" When you publish the data to , script1 will be initiated → because the topic is an exact match. some/sort/of/topic When you publish the data to , scrtip3 will be initiated → because it falls under the single 1v1 wildcard topic name. some/sort/of/thing When you publish the data to , script2 will be initiated → because it falls under the multi-level wildcard topic name. some/name When you publish the data to , script 4 will be initiated → because it falls under the multi-level wildcard topic name (even though it is some/thing/else also matched by wildcard, it is a level closer to entry). some/# some/thing/# Unsubscribe Property Description broker ( ; Default: ) string Select the broker to unsubscribe from. topic ( ; Default: ) string Select a topic, as defined by the broker, to unsubscribe from. An example of unsubscribing from the broker and the topic is shown below: /iot mqtt unsubscribe broker="broker" topic="my/test/topic" Publishing RouterOS statistics using scripts You can also use to structure MQTT messages that contain RouterOS statistics. Then, you can apply the to run the script whenever you scripts scheduler like. For example, you can run a script like (copy the content of the RouterOS code shown below into a new terminal and press "enter"):this

/system script add dont-require-permissions=no name=mqttpublish owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="#\ \_Required packages: iot\r\ \n\r\ \n################################ Configuration #########################\ #######\r\ \n# Name of an existing MQTT broker that should be used for publishing\r\ \n:local broker \"broker\"\r\ \n\r\ \n# MQTT topic where the message should be published\r\ \n:local topic \"my/test/topic\"\r\ \n\r\ \n#################################### System ############################\ #######\r\ \n:put (\"[*] Gathering system info...\")\r\ \n:local cpuLoad [/system resource get cpu-load]\r\ \n:local freeMemory [/system resource get free-memory]\r\ \n:local usedMemory ([/system resource get total-memory] - \$freeMemory)\r\ \n:local rosVersion [/system package get value-name=version \\\r\ \n\A0 \A0 [/system package find where name ~ \"^routeros\"]]\r\ \n:local model [/system routerboard get value-name=model]\r\ \n:local serialNumber [/system routerboard get value-name=serial-number]\r\ \n:local upTime [/system resource get uptime]\r\ \n\r\ \n#################################### MQTT ##############################\ #######\r\ \n:local message \\\r\ \n\A0 \A0 \"{\\\"model\\\":\\\"\$model\\\",\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"sn\\\":\\\"\$serialNumber\\\",\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"ros\\\":\\\"\$rosVersion\\\",\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"cpu\\\":\$cpuLoad,\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"umem\\\":\$usedMemory,\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"fmem\\\":\$freeMemory,\\\r\ \n\A0 \A0 \A0 \A0 \A0 \A0 \A0 \A0 \\\"uptime\\\":\\\"\$upTime\\\"}\"\r\ \n\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message to MQTT broker...\")\r\ \n/iot mqtt publish broker=\$broker topic=\$topic message=\$message\r\ \n:put (\"[*] Done\")" The script collects the data from the RouterOS (model name, serial number, RouterOS version, current CPU, used memory, free memory, and uptime) and publishes the message (the data) to the broker in the JSON format: /system script run mqttpublish [*] Gathering system info... [*] Total message size: 125 bytes [*] Sending message to MQTT broker... [*] Done You can subscribe to the topic to check the results: /iot mqtt subscriptions recv print 0 broker=broker topic="my/test/topic" data="{"model":"RB924i-2nD-BT5&BG77","sn":"E9C80EAEXXXX","ros":"7.9"," cpu":13,"umem":47476736, "fmem":19632128,"uptime":"02:21:18"}" time=2023-05-22 17:03:52 Do not forget to change the "Configuration" part of the script (topic and the broker) based on your settings.

b) Create a device, under " ", by clicking on the " " button, name it, and " " it: Home>Device management>Devices Add device Create Input your own "Endpoint token" or let the system auto-generate one for you. Make sure to "save" it (because you will not be able to access it again). All that is left is to connect our router to the server using MQTT or HTTP, post some data and customize our first dashboard to easier visualize it. RouterOS configuration First thing first, the device should have internet access. Check our guide. First Time Configuration Once you have internet up and running, if you are planning to use protocol, make sure you have package installed. You can download it from our MQTT iot , under the "Extra packages" file (for your device's respective architecture). Unzip the "Extra packages" file and upload package to the " download page iot Fil " (reboot the device after that). If you are planning on only using , there is no need for iot package installation. es HTTP posting

Before going further, visit Kaa IoT and device API guides. MQTT HTTP Using HTTP to post the data To post a basic JSON message: {"test":"data"} Simply run the command: /tool fetch url="https://next.kaaiot.com/kpc/kp1/<app-version>/epmx/<token>/update/keys" http-method=post http- header-field="Content-Type: application/json" http-data="{\"test\":\"data\"}" output=user mode=https , where you should change (that you can check under the " " tab) and <app-version> Home>Devices management>Devices>Specific device <token> (that you've generated after creating a device on the platform) to your respective values. You should be able to see that a new "Metadata" value appeared under " " tab or check Home>Device management>Devices>Specific device>Overview logs under " tab. Home>Device management>Devices>Specific device>Data logs" To collect information and post it, we can use scripting. Copy and paste the content of the script show below into the /system resource print command line: /system script add dont-require-permissions=no name=systeminfo owner=admin policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="#####################\ ############### System ###################################\r\ \n:put (\"[*] Gathering system info...\")\r\ \n:local cpuLoad [/system resource get cpu-load];\r\ \n:local freeMemory [/system resource get free-memory];\r\ \n:local usedMemory ([/system resource get total-memory] - \$freeMemory);\r\ \n:local rosVersion [/system package get value-name=version \\\r\ \n[/system package find where name ~ \"^routeros\"]];\r\ \n:local model [/system routerboard get value-name=model];\r\ \n:local serialNumber [/system routerboard get value-name=serial-number];\r\ \n:local upTime [/system resource get uptime];\r\ \n\r\ \n#################################### message #####################################\r\ \n:local message \\\r\ \n\"{\\\"model\\\":\\\"\$model\\\",\\\r\ \n\\\"sn\\\":\\\"\$serialNumber\\\",\\\r\ \n\\\"ros\\\":\\\"\$rosVersion\\\",\\\r\ \n\\\"cpu\\\":\\\"\$cpuLoad\\\",\\\r\ \n\\\"umem\\\":\\\"\$usedMemory\\\",\\\r\ \n\\\"fmem\\\":\\\"\$freeMemory\\\",\\\r\ \n\\\"uptime\\\":\\\"\$upTime\\\"}\"\r\ \n\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message...\")\r\ \n/tool fetch url=\"https://next.kaaiot.com/kpc/kp1/<app-version>/epmx/<token>/up\ date/keys\" http-method=post http-header-field=\"Content-Type: application/json\" http-data=\ \"\$message\" output=user mode=https\r\ \n:put (\"[*] Done\")" Change the URL's and values. Then, run the script using: <app-version> <token> /system script run systeminfo The JSON message will look like this:

{ "model": "RB924iR-2nD-BT5&BG77", "sn": "XXXXXXX", "ros": "7.99", "cpu": "7", "umem": "45113344", "fmem": "21995520", "uptime": "4d22:16:08" } Using MQTT to post the data In order to use a one-way SSL MQTT scenario, get the root certificate from " " by clicking on the " Home>Device management>Credentials Get root " button. More info can be found . certificate here Upload ca.pem certificate file to the RouterOS and import it using: /certificate/import file-name=ca.pem passphrase="" Add a new MQTT broker: /iot mqtt brokers add address=mqtt.next.kaaiot.com name=kaaiot port=8883 ssl=yes Connect to the broker and check whether the connection is ongoing with the help of the "print" command (" " should be present): connected=yes /iot mqtt connect broker=kaaiot /iot mqtt brokers print 0 name="kaaiot" address="mqtt.next.kaaiot.com" port=8883 ssl=yes auto-connect=no keep-alive=60 parallel-scripts- limit=off connected=yes To post a basic JSON message: {"test":"data"} Simply run the command: /iot mqtt publish broker=kaaiot message="{\"test\":\"data\"}" topic="kp1/<app-version>/epmx/<token>/update/keys /88" , where you should change (that you can check under the " " tab) and <app-version> Home>Devices management>Devices>Specific device <token> (that you've generated after creating a device on the platform) to your respective values. You should be able to see that a new "Metadata" value appeared under " " tab or check Home>Device management>Devices>Specific device>Overview logs under " tab. Home>Device management>Devices>Specific device>Data logs" To collect information and post it, we can use scripting. Copy and paste the content of the script show below into the /system resource print command line:

/system script add dont-require-permissions=no name=systeminfo owner=admin policy=ftp,reboot,read,write,policy,test,password, sniff,sensitive,romon source="#####\ ############################### System ###################################\r\ \n:put (\"[*] Gathering system info...\")\r\ \n:local cpuLoad [/system resource get cpu-load];\r\ \n:local freeMemory [/system resource get free-memory];\r\ \n:local usedMemory ([/system resource get total-memory] - \$freeMemory);\r\ \n:local rosVersion [/system package get value-name=version \\\r\ \n[/system package find where name ~ \"^routeros\"]];\r\ \n:local model [/system routerboard get value-name=model];\r\ \n:local serialNumber [/system routerboard get value-name=serial-number];\r\ \n:local upTime [/system resource get uptime];\r\ \n\r\ \n#################################### message #####################################\r\ \n:local message \\\r\ \n\"{\\\"model\\\":\\\"\$model\\\",\\\r\ \n\\\"sn\\\":\\\"\$serialNumber\\\",\\\r\ \n\\\"ros\\\":\\\"\$rosVersion\\\",\\\r\ \n\\\"cpu\\\":\\\"\$cpuLoad\\\",\\\r\ \n\\\"umem\\\":\\\"\$usedMemory\\\",\\\r\ \n\\\"fmem\\\":\\\"\$freeMemory\\\",\\\r\ \n\\\"uptime\\\":\\\"\$upTime\\\"}\"\r\ \n\r\ \n:log info \"\$message\";\r\ \n:put (\"[*] Total message size: \$[:len \$message] bytes\")\r\ \n:put (\"[*] Sending message...\")\r\ \n/iot mqtt publish broker=kaaiot message=\$message topic=\"kp1/<app-version>/epmx/<token>/update/keys/88\" \r\ \n:put (\"[*] Done\")" Change the topic's and values. Then, run the script using: <app-version> <token> /system script run systeminfo The JSON message will look like this: { "model": "RB924iR-2nD-BT5&BG77", "sn": "XXXXXXX", "ros": "7.99", "cpu": "7", "umem": "45113344", "fmem": "21995520", "uptime": "4d22:16:08" } Data visualization using dashboards To visualize previously posted data, go to " " and click on " ": Home>Solutions>Your_Solution>Dashboards>Your_Dasboard Add widget

Select a widget type (we will use " "), and a pre-set widget (we will use " "). Device management Endpoint metadata " " the widget and choose your "Endpoint ID" under " ". From here, you can customize the dashboard further: Edit Data source>Endpoint ID And so! you can create your own scripts that collect information that is important to you instead, and then just apply a to run the script with an scheduler interval of your choice. Maybe you want to collect GPS coordinates from your and visualize them using the "map" widget? It is only up to you! LTAP

MQTT and ThingsBoard configuration Introduction Thingsboard configuration Access token scenario MQTT Basic scenario One-way SSL communication scenario X.509 (two-way SSL communication) scenario RouterOS configuration MQTT Broker Access token scenario MQTT Basic scenario One-way SSL communication scenario X.509 (two-way SSL communication) scenario MQTT Publish Verification Introduction One of the many cloud services that you can use to monitor information that is sent by an MQTT publisher is . This article will demonstrate Thingsboard how to configure both Thingsboard and RouterOS to publish the data using the MQTT protocol. RouterOS, in this scenario, is going to act as a gateway and publish the data from the RouterBoard to the Thingsboard's server. Thingsboard, in this scenario, will act as an MQTT broker (server, where data will be posted). Before we proceed with the settings, you need to either: a) Create an account in the Thingsboard's system. You can do so by following this . This will allow you to use the ThingsBoard cloud solution link for free for a limited/test time period. b) Set up your own server by following the . There is a community edition that can be installed and used free of charge. guides Thingsboard configuration Access the login page via your browser and log in. Go to the " " menu. Devices Create a new device by clicking on the add button "+" and "Add new device": Enter the name of the device and click on "Add": Please consider using , instead of non-SSL MQTT (TCP port 1883). If you use non-SSL MQTT, the SSL MQTT (TCP port 8883 and certificates) communication between the client (MQTT publisher) and the server (MQTT broker) can be easily sniffed/packet captured, and that will compromise authentication data (such as client-ids, usernames and passwords). In this guide, we will showcase local instance/server installation configuration, but the same principles apply to the cloud option.

By default, access token authentication is selected for the newly created device. Access token scenario You can change the token by clicking on the created device and entering the " " settings (in the " " section): Manage Credentials Details This token will be used as a "username" for the MQTT publisher (in RouterOS settings). You can find more information by following the .link MQTT Basic scenario You can change the credentials type in the " " section for the specific device: Device Credentials

MQTT Basic scenario allows you to specify the Client ID, Username, and Password for the MQTT authentication. You can find more information by following the .link One-way SSL communication scenario The configuration will be the same as shown in the and shown above. So choose either one. Access token MQTT Basic scenarios The only difference, in this case, is the communication between the device and the server (you will only have to slightly change MQTT broker configuration in RouterOS settings which will be shown later on). When using this scenario, the communication is going to be encrypted (using SSL) . X.509 (two-way SSL communication) scenario You can change the credentials type in the " " section for the specific device: Device Credentials Recommended scenario to use! This type of authentication requires you to use a server certificate for SSL communication. A server certificate must be generated and uploaded to the ThingsBoard instance. To generate a server certificate, use as a reference → generate the certificate (for example, using OPENSSL tool), install/upload it this guide into the correct folder, and enable MQTT SSL in the ThingsBoard configuration file. This type of authentication requires you to use a server certificate and a client certificate for SSL communication. A server certificate must be generated and uploaded to the ThingsBoard instance. To generate a server certificate, use as a reference → generate the certificate (for example, using OPENSSL tool), install/upload it this guide into the correct folder, and enable MQTT SSL in the ThingsBoard configuration file. To generate a client certificate, use as a reference. this guide

X.509 scenario uses a client certificate for authentication. Once the certificate is generated (for example, using OPEN SSL), copy the RSA public key into the field and click on the "Save" button. RouterOS configuration : In order to configure MQTT, make sure that is installed beforehand. note iotpackage MQTT Broker Access token scenario Add an MQTT broker as shown below: /iot/mqtt/brokers/add name=tb address=x.x.x.x port=1883 username=access_token Change the " " to the actual IP/domain address of your ThingsBoard server; address Change the " " to the access token that you've used in the ThingsBoard settings. username MQTT Basic scenario Add an MQTT broker as shown below: /iot/mqtt/brokers/add name=tb address=x.x.x.x client-id=clientid password=password username=username Change " " to the actual IP/domain address of your ThingsBoard server; address Change the " ", " " and " " to the actual values that you've used in the ThingsBoard settings. username password client-id One-way SSL communication scenario In this scenario, RouterOS needs to have a server certificate imported into its system. Drag-and-drop server certificate, that was installed into the ThingsBoard, into the router's "File List" menu: Recommended scenario to use!

Import server certificate: /certificate/import file-name=mqttserver.pem passphrase="" When using and an , add an MQTT broker as shown below: SSL one-way communication access token scenario /iot/mqtt/brokers/add name=tb address=x.x.x.x port=8883 username=access_token ssl=yes Change the " " to the actual IP/domain address of your ThingsBoard server; address Change the " " to the access token that you've used in the ThingsBoard settings; username Make sure to use " " (the MQTT SSL port that the server is listening to); port=8883 Make sure to enable " ". ssl=yes When using and an , add an MQTT broker as shown below: SSL one-way communication MQTT Basic scenario /iot/mqtt/brokers/add name=tb address=x.x.x.x port=8883 client-id=clientid password=password username=username ssl=yes Change the " " to the actual IP/domain address of your ThingsBoard server; address Change the " ", " " and " " to the actual values that you've used in the ThingsBoard settings; username password client-id Make sure to use " " (the MQTT SSL port that the server is listening to); port=8883 Make sure to enable " ". ssl=yes X.509 (two-way SSL communication) scenario Drag-and-drop the certificates into the router's "Files/File List" menu → server certificate, client certificate, and its private key. Import certificates one by one:

/certificate/import file-name=mqttserver.pem passphrase="" /certificate/import file-name=cert.pem passphrase="" /certificate/import file-name=key.pem passphrase="" Add an MQTT broker as shown below: /iot/mqtt/brokers/add name=tb address=x.x.x.x port=8883 certificate=cert.pem_0 ssl=yes Change the " " to the actual IP/domain address of your ThingsBoard server; address Change the " " selected to the actual client certificate name that you've imported; certificate Make sure to use " " (the MQTT SSL port that the server is listening to); port=8883 Make sure to enable " ". ssl=yes MQTT Publish a) A quick MQTT publish test with a static value: /iot/mqtt/publish broker="tb" topic="v1/devices/me/telemetry" message="{\"cpu\":\"7\"}" b) In order to publish relevant data from the RouterOS to the Thingsboard, you can use the script shown below as a reference. The script collects the data from the RouterOS device (model name, serial number, RouterOS version, current CPU, used memory, free memory, and uptime) and publishes the message (the data) to the broker in the JSON format: # Required packages: iot ################################ Configuration ################################ # Name of an existing MQTT broker that should be used for publishing :local broker "tb" # MQTT topic where the message should be published :local topic "v1/devices/me/telemetry" #################################### System ################################### :put ("[*] Gathering system info...") :local cpuLoad [/system resource get cpu-load] :local freeMemory [/system resource get free-memory] :local usedMemory ([/system resource get total-memory] - $freeMemory) :local rosVersion [/system package get value-name=version \ [/system package find where name ~ "^routeros"]] :local model [/system routerboard get value-name=model] :local serialNumber [/system routerboard get value-name=serial-number] :local upTime [/system resource get uptime] #################################### MQTT ##################################### :local message \ "{\"model\":\"$model\",\ \"sn\":\"$serialNumber\",\ \"ros\":\"$rosVersion\",\ \"cpu\":$cpuLoad,\ \"umem\":$usedMemory,\ \"fmem\":$freeMemory,\ \"uptime\":\"$upTime\"}" :log info "$message"; :put ("[*] Total message size: $[:len $message] bytes") :put ("[*] Sending message to MQTT broker...") /iot mqtt publish broker=$broker topic=$topic message=$message :put ("[*] Done") 2 script lines should be taken into account.

:local broker "tb" line, where you should specify the broker's name within the quotation marks "". :local topic "v1/devices/me/telemetry" line, where you should specify the correct topic within the quotation marks "" (check Thingsboard's for the exact topic that needs to be documentation used). The rest of the script configuration depends on the overall requirements. Copy and paste the above script into a notepad, and re-copy it again. Navigate to System>Scripts menu, add a new script there, and paste the script that is shown above. Name it, for example, script1. To run the script, you can use the command line: /system script run script1 Verification You can check the received/published data for the device under the "Latest telemetry" section:

Hardware In This Section:

Disks Summary Properties Flags Settings Examples Formatting attached storage unit - Simple Formatting attached storage unit - Detailed Web-Proxy cache configuration example Log on disk configuration example Allocate RAM to folder Test disk performance Summary Sub-menu: /disk This menu will list all attached storage devices, presuming that they are supported and in working condition. This is especially useful for RouterBOARD devices with SD/CF/USB/SATA/NVMe slots and x86 systems with additional dedicated storage drives - as the built-in storage is quite small, an external drive comes in very handy when you want a big User Manager database, proxy cache or possibly SMB shares on your router. You can add as many external or secondary drives as you want, and select any number of them for each of the mentioned feature usages. For example, User Manager could be used on 3 disks, one of them would be the active database, and the rest would be backups. You can then add a fourth disk, copy the active data to it - unmount - unplug it - and move to another server, to keep using the actual database. This means migration and backup are made easy! Disks carry names where they are physically connected. Properties Property Description eject-drive () Safely unmounts (ejects) drive of your selection by using "slot" that is assigned to it. After issuing this command it can be removed from host device. format-drive ()Command to initiate disk formatting process. Contains additional properties of its own. Such as "file-system" and "label". select disk (slot) that should be formatted file-system ('exfat', 'ext4', 'fat32' or 'wipe') - Format disk with type ExFAT, FAT32 or EXT4 or securely wipe all data label mbr-partition-table - make mbr partition table reset- countersResets disk (slot) statistics monitor- trafficCheck real time disk performance and health stats - ROSE-storage-old package adds additional enterprise data center functionality to RouterOS. Current manual page does not include additional features included in ROSE-storage-old package.

test allows performing performance tests of selected device (Available from RouterOS 7.16) disk - device or devices for test direction - ('read','write') duration - (int) pattern - ('random', 'sequential') thread-count - (int) block-size - size of block to be used for testing type - ('device', 'filesystem') Flags Property Description X - disabledDisabled device E - empty Empty slot B - BLOCK- DEVICEThe "B - BLOCK-DEVICE"- Flag means that this device works using blocks for input/output operations. In the context of RouterOS, its distinction is crucial, as it helps determine whether a device is functioning as a data carrier or simply providing information about the disk layout structure. This difference becomes important when considering the extender with the device behind it. If a device is marked with the letter "B", this indicates its ability to be used as storage or memory. In contrast, devices that do not have a "B" mark are designed primarily to understand the structure of the disk. This allows to quickly recognize the presence of a PCIe or SAS expander, as well as detect the presence of drives in the first expander. In addition, it allows you to estimate the speed of the connection to which each device is connected. However, the most notable benefit of the "B" flag is its ability to instantly indicate whether a device can be formatted or used for RAID purposes. M - mountedMounted partition F - formattingThe device is currently in the formatting process p - partitionThe device has a partition f - raid- member- failed These options are used with the package. ROSEr - raid- member c - encrypted g - guid- partition- table t - nvme- tcp-export i - iscsi- export s - smb- export n - nfs- export

1. 2. Grounding Introduction Shielded RJ45 Port vs Unshielded RJ45 Port PoE injector with shielded connectors: RouterBOARD grounding wire attachment points: Introduction Shielded cable installation infrastructure (towers and masts), as well as antennas and the router itself, must be properly grounded. Lightning arresters must be installed on all external antenna cables (near the antennas or on the antennas themselves) to prevent equipment damage and human injury. Note that lightning arresters will not be effective if they are not properly grounded. Use 1 AWG (7 mm in diameter) wire with corrosion-resistant connectors for grounding. Ensure that the grounding infrastructure you use is fully functional (not merely decorative, as seen in some installations). For shielded connectors, please use shielded cables as they provide better immunity. The grounding wire should be connected to the RouterBOARD grounding wire attachment point if such is provided. This wire should then be connected to the base of the tower, ensuring the connection meets grounding standards. The antenna's grounding wire should be connected near the RouterBOARD outdoor case and can be joined with the same grounding wire used for the RouterBOARD. Shielded RJ45 Port vs Unshielded RJ45 Port Device with Shielded Ports: Device with Unshielded Ports: PoE injector with shielded connectors:

LCD Touchscreen Summary Configuration LCD Touchscreen Calibration Take LCD Screenshot LCD Interfaces All Interface Graph Screen LCD Informative Screens LCD PIN Code LCD screens/modes Startup Interfaces Stats All Interface Graph Screen Stat Slideshow Informative Slideshow Log Reboot and Reset Configuration Summary RouterBOARD 2011U and CCR series devices are equipped with a resistive touchscreen, for quick access to device stats and simple configuration options. Touchscreen requires pressure against the surface to register a touch, therefore light swipes and quick/short taps might not get registered (as opposed to a capacitive touchscreen commonly found on phones). If you find trouble operating the screen with your finger, you can also try a stylus, or opposite end of a pen. Configuration /lcdSub-menu: Property Description backlight-timeout ( ; Default: ) time interval: 5m..2h | never 30m Time after which LCD touchscreen is turned off color-scheme ( ; Default: depends on RouterBoard model) dark | light Changes to color scheme with a dark or light background. default-screen (informative-slideshow|interfaces|log|main- ; Default: ) menu|stat-slideshow|stats|stats-all main-menuDefault screen that is showed after startup. enabled ( ; Default: ) yes | no yes Turns LCD touchscreen on/off. When off, it stops and resets statistics gathering and closes the LCD program. read-only-mode ( ; Default: ) yes | no yes Enables or disables Read-Only mode. If Read-Only mode is enabled, then menus which can be used to change configuration are hidden. time-interval ( ; Default: ) min | hour | daily | weekly min Time interval of displayed interface statistics in Stats screen touch-screen ( , Default: ) enabled | disabled enabled Enable/disable touch screen input. Available functions: backlight - Turns on/off LCD touchscreen backlight, LCD program remains working; recalibrate - Starts LCD Touchscreen Calibration process; show - Set the screen which is displayed on the LCD; take-screenshot - Creates image of currently displayed LCD screen. LCD Touchscreen Calibration Before the LCD touchscreen can be used, it needs to be calibrated at least once. After the first successful calibration, data is stored on the router. If no calibration values are present, calibration process will start automatically.

timeout ( ; Default: ) time interval: 1s..1m 10s Time of displaying informative slide LCD PIN Code Sub-menu: /lcd pin PIN code number allows to protect sensitive menus on the LCD screen. The PIN number will be asked if Read-Only mode is disabled and you add an IP address, reset or reboot the router. Default PIN is 1234 Property Description pin-number ( ; Default: ) number 1234 PIN protection code hide-pin-number ( ; Default: ) yes | no no Whether to show the typed digits on the LCD screen or hide them with asterisks LCD screens/modes Since v6.0, LCD has a menu structure. Menu screens consist of buttons that are used to navigate the menus. A scrollbar is shown on the right side of the screen if it does not fit on the actual display. The screen can be dragged up or down to access more options if they are available. At the top of each menu screen is a "Back" button that jumps to the previous screen. Startup If the router has default configuration - user named "admin" with no password, then a warning on LCD will appear. This screen shows IP's assigned to the interfaces which could be used to connect to the router. Otherwise the Main menu screen is displayed after booting up. Interfaces Interfaces menu displays all the Ethernet and Wireless interfaces. Bandwidth usage is shown similar to the All interface graph screen. From the Interfaces screen you can choose a specific interface to look at. The following options are available: Info (only for physical interfaces) - menu which shows information about the interface; Registration Table (only for wireless) - menu which shows all the registered clients for the wireless interface and their respective signal strengths; Addresses - menu which lists all the addresses assigned to the interface; Stats - menu which allows to jump to the selected interface in the "Stats" screen. You can directly choose to show Bandwidth or Packets.

Info Registration Table Addresses Stats selection Stats Stats screen shows single interface graphs for RX and TX. Values are updated from right to left (newest to oldest). Info that is shown: RX/TX rate and packets. Interface name is shown at the top right, it is trimmed if it's too long (last characters are cut off). The top right corner shows the time interval for the values. Following time values are available: Min (Minute) - shows values for the last minute. Unit = second. Vertical line separates first 30 seconds. Total values: 30 + 24; Hour - shows values for the last hours. Unit = 5 minutes. Vertical lines separate 1 hour. Total values: 12 + 12 + 3; Daily - shows values for the last days. Unit = hour. Vertical lines separate 1 day. Total values: 12 + 12 + 3; Weekly - shows values for the last weeks. Unit = day. Vertical lines separate 1 week. Total values: 7 + 7 + 4; Motions: Tap - tapping the finger against the touch screen without moving it too much. If a tap lands into the top right corner of the screen (square box 1/4 of the screen height), info time interval is changed: Min -> Hour -> Daily -> Weekly -> Min... Otherwise a tap cycles through graph info: rate -> packets -> rate... Swipe/Drag - while holding the finger down, move in any direction. The changes should be highlighted during the drag. Up - Go to Main menu Down - Select All Interface graph screen Left - Next interface Right - Previous interface All Interface Graph Screen All interface graph screen shows the RX/TX bandwidth usage about all interfaces. The max values are calculated like this - for Ethernet interfaces it's the negotiated rate or set speed. For wireless interfaces it's calculated from used band, channel-width and chain count using the theoretical values. The goal of this screen is to see how values are related to each other for a single interface.

Motions: Swipe/drag. Up - Back (to Stats screen). Left - Next page. Right - Previous page. Stat Slideshow Stat Slideshow screen is similar to the "Stats" screen, but the interfaces are switched after they timeout. Settings for slideshow are stored in RouterOS submenu /lcd interface Informative Slideshow Submenu /lcd screen Informative Slideshow screen cycles through screens with various system information: Aggregate traffic; Aggregate packets; Resources; System; Health; Date & time. System Resources Health Log The Log screen shows 5 last log entries where log action=echo. Reboot and Reset Configuration These screens are only available when Read-Only mode is disabled. To access any of the screens, the Pin number must be entered. If the Pin authentication is successful, the user must confirm the desired action by pressing the "Yes" button, or cancel by pressing - "No".

type (align-down | align-left | align-right | align-up | ap-cap | fan-fault | flash-access | interface-activity | interface-receive | interface-speed | interface-speed-1G | interface-speed-25G | interface-status | interface-transmit | modem-signal | modem-technology | off | on | poe-fault | poe-out | wireless-signal- ; Default: ) strength | wireless-statusType of the status: align-down - light the led if the w60g device needs to be aligned downwards for the best signal quality align-left - light the led if the w60g device needs to be aligned to the left align-right - light the led if the w60g device needs to be aligned to the right align-up - light the led if the w60g device needs to be aligned upwards ap-cap - blink on CAP initializing with CAPsMAN, steady on once connected fan-fault - light the led when any of the devices controlled fans stop working flash-access - blink the led on flash access interface-activity - blink the led on interface (traffic) activity interface-receive - blink the led on interface received a traffic interface-speed - light the led when interface works in 10Gbit rate interface-speed-1G - light the led when interface works in 1Gbit rate interface-speed-25G - light the led when interface works in 25Gbit rate interface-speed-100G - light the led when interface works in 100Gbit rate interface-status - light the led on interface status change interface-transmit - blink the led on interface transmitted traffic modem-signal - blink the led on 3G modem signal (either USB or miniPCIe) modem-technology - turns on LEDs in order of modem technology generation: GSM; 3G; LTE; single led turns on only when LTE is active. off- turn off the led on- turn on the led poe-fault - light the led when PoE out budget is close to the maximum supported limit poe-out - light the led when interface PoE out turns on wireless-signal-strength - light the leds displaying wireless signal (requires more than one led) wireless-status - light the led on wireless status change. LED Settings Global settings are stored in LEDs Setting menu. Sub-menu: /system leds setting Property Description

all-leds-off ( ; Default: ) after-1h | after-1min | immediate | never never Whether and when all LEDs of a router can be turned off The listed devices support turning off their LEDs (LED dark mode), however, some LEDs still cannot be turned off due to the device design factors. Indoor devices RouterBoard LED description CRS305-1G-4S+; CRS309-1G-8S+ Turns off all LEDs except Ethernet LED and Power LED RB5009UG+S+IN; RB5009UPr+S+ Turns off all LEDs L009UiGS-RM; L009UiGS-2HaxD-IN Turns off PWR, USR and Ether1 LEDs L41G-2axD; L41G-2axD&FG621-EA (hAP ax lite series) Turns off all LEDs except Ethernet LEDs RB760iGS (hEX S) Turns off Power LED and SFP LED E50UG Turns off all LEDs except Ethernet1 LED RB924i-2nD-BT5&BG77; RB924iR-2nD-BT5&BG77 (KNOT series) Turns off all LEDs RB951Ui-2HnD Turns off all LEDs except Power LED RB951Ui-2nD (hAP); RB952Ui-5ac2nD (hAP ac lite); RB952Ui-5ac2nD-TC (hAP ac lite TC) Turns off all LEDs except Power LED RB962UiGS-5HacT2HnT (hAP ac) Turns off all LEDs except Port5 PoE LED RBcAP2n; RBcAP2nD (cAP) Turns off all LEDs RBcAPGi-5acD2nD (cAP ac); RBcAPGi-5acD2nD-XL (cAP XL ac) Turns off all LEDs cAPGi-5HaxD2HaxD (cAP ax) Turns off all LEDs RBD25G/RB25GR-5HPacQD2HPnD (Audience) Turns off all LEDs except Ethernet LEDs RBD52G-5HacD2HnD-TC (hAP ac^2) Turns off all LEDs RBD53iG-5HacD2HnD (hAP ac^3) Turns off all LEDs RBD53G-5HacD2HnD-TC (Chateau series) Turns off all LEDs RBwsAP5Hac2nD (wsAP ac lite) Turns off all LEDs C52iG-5HaxD2HaxD-TC (hAP ax^2) Turns off all LEDs except Ethernet LEDs C53UiG+5HPaxD2HPaxD (hAP ax^3) Turns off all LEDs except Ethernet LEDs S53UG+5HaxD2HaxD-TC (Chateau ax series) Turns off all LEDs except Ethernet LEDs Wireless Systems RouterBoard LED description CME22-2n-BG77 (CME Gateway) Turns off all LEDs CubeG-5ac60ay (Cube 60Pro ac); CubeG-5ac60ay-SA (CubeSA 60Pro ac) Turns off all LEDs CubeG-5ac60ad (Cube 60G ac) Turns off all LEDs RB912R-2nD-LTm (ltAP mini / ltAP mini LTE kit) Turns off all LEDs RB912UAG-6HPnD (BaseBox 6) Turns off all LEDs RBD23UGS-5HPacD2HnD (NetMetal ac^2) Turns off all LEDs

L11UG-5HaxD; L11UG-5HaxD-NB (NetBox 5 ax) Turns off all LEDs L22UGS-5HaxD2HaxD-15S (mANTBox ax 15s) Turns off all LEDs L23UGSR-5HaxD2HaxD; L23UGSR-5HaxD2HaxD-NM (NetMetal ax) Turns off all LEDs RBLDF-2nD (LDF 2); RBLDF-5nD (LDF 5); RBLHGR Turns off all LEDs RBLDFG-5acD (LDF 5 ac) Turns off all LEDs except Ethernet LED RBLHG2nD (LHG 2); RBLHG2nD-XL (LHG XL 2) Turns off all LEDs RBLHG5nD (LHG 5); RBLHG5HPnD (LHG HP5); RBLHG5HPnD-XL (LHG XL HP5) Turns off all LEDs RBLHGG-5acD (LHG 5 ac); RBLHGG-5acD-XL (LHG XL 5 ac); RBLHGG-5HPacD2HPnD (LHG XL 52 ac); RBSXTsqG-5acD (SXTsq 5 ac)Turns off all LEDs except Ethernet LED RBLHGG-60ad (Wireless Wire Dish) Turns off all LEDs LHGGM&EG18-EA (LHG LTE18 kit); ATLGM&EG18-EA (ATL LTE18 kit) Turns off all LEDs RBLtAP-2HnD (LtAP) Turns off all LEDs except Ethernet LEDs RBSXTsq-60ad (SXTsq Lite60); RBCube-60ad (Cube Lite60) Turns off all LEDs RBwAPG-60ad (Wireless Wire) Turns off all LEDs RBwAPGR-5HacD2HnD (wAP ac) Turns off all LEDs except Ethernet LED Examples Basic example LED control via CLI commands for scripting purposes: #add led entry with specific type "on" or "off" to leds menu /system leds add leds=led1 type=off #to control led /system leds set [find where leds="led1"] type=on or /system leds set [find where leds="led1"] type=off Enable the User ACT LED to show current CAP status on an RB951 /system leds add leds=user-led type=ap-cap Modem Signal Strength example The whole modem-signal strength range is [-113..-51] and the modem-signal-threshold increases the weakest signal limit to -91 so the signal range for LED indication is [-91..-51]. That range is divided into equal parts depending on number of LEDs configured for modem-signal LED trigger. The first LED turns on when signal is above -91 and the last LED turns on when signal reaches -51. /system leds add interface=lte1 leds=led1,led2,led3,led4,led5 modem-signal-treshold=-91 type=modem-signal

Modem Access Technology example These LED trigger examples turn on LEDs in order of modem technology generation: GSM; 3G; LTE. 1 LED: led1 turns on when LTE is active; /system leds add interface=lte1 leds=led1 modem-type=modem-technology 2 LEDs: led1 - 3G; led2 - LTE; /system leds add interface=lte1 leds=led1,led2 modem-type=modem-technology 3 LEDs: led1 - GSM; led2 - 3G; led3 - LTE /system leds add interface=lte1 leds=led1,led2,led3 modem-type=modem-technology

MTU in RouterOS Introduction Maximum Transmission Unit Full frame MTU MAC/Layer-2/L2 MTU MPLS/Layer-2.5/L2.5 MTU MPLS Switching IP ingress VPLS ingress Setup Examples Simple Routing Routing with VLAN Encap Simple MPLS with Tags VPLS Tunnel Advanced Setup Examples Introduction It is the sole responsibility of administrators to configure the Maximum Transmission Unit (MTU) such that intended services and applications can be successfully implemented in the network. In other words - administrators must make sure that MTUs are configured in a way that packet sizes do not exceed the capabilities of network equipment. Originally MTU was introduced because of the high error rates and low speed of communications. Fragmentation of the data stream gives the ability to correct corruption errors only by resending corrupted fragments, not the whole stream. Also on low-speed connections such as modems, it can take too much time to send a big fragment, so in this case, communication is possible only with smaller fragments. But in the present day we have much lower error rates and higher speed of communication, this opens a possibility to increase the value of MTU. By increasing the value of MTU we will result in less protocol overhead and reduce CPU utilization mostly due to interrupt reduction. This way some non- standard frames started to emerge: Giant or frames - frames that are bigger than standard (IEEE) Ethernet MTU; Jumbo Baby Giant or frames - frames that are just slightly bigger than standard (IEEE) Ethernet MTU; Baby Jumbo It is common now for Ethernet interfaces to support physical MTU above standard, but this can not be taken for granted. Abilities of other network equipment must be taken into account as well - for example, if 2 routers with Ethernet interfaces supporting physical MTU 1526 are connected through an Ethernet switch, in order to successfully implement some application that will produce these big Ethernet frames, the switch must also support forwarding such frames. Maximum Transmission Unit Mikrotik RouterOS recognizes several types of MTU: IP/Layer-3/L3 MTU MPLS/Layer-2.5/L2.5 MTU MAC/Layer-2/L2 MTU Full frame MTU Full frame MTU Full frame MTU indicates the actual size of the frame that is sent by a particular interface. Frame Checksum is not included as it is removed by an ethernet driver as soon as it reaches its destination.

MAC/Layer-2/L2 MTU L2MTU indicates the maximum size of the frame without the MAC header that can be sent by this interface. In RouterOS L2MTU values can be seen in the "/interface" menu. L2MTU support is added for all Routerboard related Ethernet interfaces, VLANs, Bridge, VPLS, and wireless interfaces. Some of them support the configuration of the L2MTU value. All other Ethernet interfaces might indicate L2MTU only if the chipset is the same as Routerboard Ethernets. This will allow users to check if the desired setup is possible. Users will be able to utilize additional bytes for VLAN and MPLS tags, or simply increase interface MTU to get rid of some unnecessary fragmentation. This table shows supported by Mikrotik RouterBoards (available in the "/interface print" menu as the value of the read-only "max-l2mtu" option): max-l2mtu Model name MTU description RB SXT series, RB LHG, RB LDF, PL6411-2nD, PL7411-2nD, RB711 series, wAP R-2nD, RB912R- 2nD-LTm (LtAP mini), RB Metal series, RB SXT Lite series, RB Groove series, Cube Lite60, LHG Lite60ether1:2028 RB SXT G series, RB DynaDish, wAP ac, RB QRT series, RB711G series, RB911G, RB912UAG ether1:4076 RB OmniTik series, RB750, RB750UP, RB751U-2HnD, RB951-2n ether1:4076; ether2-ether5:2028 RB OmniTik ac series, RB750GL, RB750Gr2 ether1-ether5:4074 RB mAP, RB mAP lite, RB cAP, RB wAP ether1-ether2:2028 RB750r2, RB750P-PBr2, RB750UPr2, RB941-2nD, RB951Ui/RB952Ui series ether1-ether5:2028 RB750Gr3 ether1-ether5:2026 RB751G-2HnD, RB951G-2HnD ether1-ether5:4074 RB962UiGS, RB960PGS ether1-ether5:4074; sfp1:4076 RB LHGG series ether1:9214 LHG XL 52 ac ether1:9214; sfp1:9214 RB1100Hx2, RB1100AHx2 ether1-ether10:9498; ether11:9500; ether12- ether13:9116 RB4011iGS+ series ether1-ether10:9578; sfp-sfpplus1:9982 CCR1009 series ether1-ether4:10224; ether5-ether8:10226; sfp1: 10226; sfp-sfpplus1:10226 CCR1016 series ether1-ether12:10226; sfp1-sfp12:10226; sfp- sfpplus1:10226 CCR1036 series ether1-ether12:10226; sfp1-sfp4:10226; sfp- sfpplus1-sfp-sfpplus2:10226 CCR1072 series ether1:9116; sfp-sfpplus1-sfp-sfpplus8:10226 CCR2004-1G-12S+2XS ether1:9586; sfp-sfpplus1-sfp-sfpplus12:9578; sfp28-1 - sfp28-2:9578 CCR2004-16G-2S+ ether1-ether16:9582; sfp-sfpplus1-sfp-sfpplus2: 9586 CCR2116-12G-4S+ ether1-ether12:9570; ether13:9586; sfp-sfpplus1- sfp-sfpplus4:9570 CCR2216-1G-12XS-2XQ ether1:9586; sfp28-1 - sfp28-12:9570; qsfp28-1- 1 - qsfp28-2-4:9570 CRS109-8G-1S ether1-ether8:4064; sfp1:4064 CRS125-24G-1S ether1-ether24:4064; sfp1:4064

CRS112-8G-4S, CRS112-8P-4S ether1-ether8:9204; sfp9-sfp12:9204 CRS106-1C-5S sfp1-sfp5:9204; combo1:9204 CRS210-8G-2S+ ether1-ether8:9204; sfp-sfpplus1:9204; sfpplus2: 9204 CRS212-1G-10S-1S+ ether1:9204; sfp1-sfp10:9204; sfpplus1:9204 CRS226-24G-2S+ ether1-ether24:9204; sfp-sfpplus1:9204; sfpplus2:9204 CRS326-24G-2S+, CSS326-24G-2S+ ether1-ether24:10218; sfp-sfpplus1:10218; sfpplus2:10218 CRS317-1G-16S+ ether1:10218; sfp-sfpplus1-sfp-sfpplus16:10218 CRS328-24P-4S+ ether1-ether24:10218; sfp-sfpplus1-sfp-sfpplus4: 10218 CRS328-4C-20S-4S+ combo1-combo4:10218; sfp1-sfp20:10218; sfp- sfpplus1-sfp-sfpplus4:10218 CRS305-1G-4S+ ether1:10218; sfp-sfpplus1-sfp-sfpplus4:10218 CRS309-1G-8S+ ether1:10218; sfp-sfpplus1-sfp-sfpplus8:10218 netFiber 9/IN (CRS310-1G-5S-4S+) sfp1-sfp5:10218; sfp-sfpplus1-sfp-sfpplus4:10218 CRS310-8G+2S+IN ether1-ether8:10218; sfp-sfpplus1-sfp-sfpplus2: 10218 CRS312-4C+8XG combo1-combo4:10218; ether1-ether8:10218; ether9:2028 netPower 15FR (CRS318-1Fi-15Fr-2S) ether1-ether16:10218; sfp1-sfp2:10218 netPower 16P (CRS318-16P-2S+) ether1-ether16:10218; sfp-sfpplus1-sfp-sfpplus2: 10218 CRS326-4C+20G+2Q+ combo1-combo4:10218; ether1-ether20:10218; qsfpplus1-1-qsfpplus2-4:10218; ether21:2028 CRS326-24S+2Q+ sfp-sfpplus1-sfp-sfpplus24:10218; qsfpplus1-1- qsfpplus2-4:10218; ether1:2028 CRS354-48G-4S+2Q+, CRS354-48P-4S+2Q+ sfp-sfpplus1-sfp-sfpplus4:10218; qsfpplus1-1- qsfpplus2-4:10218; ether1-ether48:10218; ether49:2028 CRS504-4XQ-IN ether1:2028; qsfp28-1-1 - qsfp28-4-4:10218 CRS510-8XS-2XQ-IN ether1:2028; sfp28-1 - sfp28-8:10218; qsfp28-1- 1 - qsfp28-2-4:10218 CRS518-16XS-2XQ ether1:2028; sfp28-1 - sfp28-16:10218; qsfp28-1- 1 - qsfp28-2-4:10218 CSS610-8G-2S+, CSS610-8P-2S+ ether1-ether8:10218; sfp-sfpplus1-sfp-sfpplus2: 10218 D52G-5HacD2HnD (hAP ac²) ether1-ether5:9124 C52iG-5HaxD2HaxD (hAP ax )2 ether1-ether5:9214 C53UiG+5HPaxD2HPaxD (hAP ax )3 ether1-ether5:9214 L41G-2axD (hAP ax lite) ether1-ether4:2026 cAP ac ether1-ether2:9124

GPEN21 ether1-ether2:10222; sfp1: 10222 wAP60G, LHG60G ether1:9124 RB260GS series, CSS106-5G-1S, CSS106-1G-4P-1S ether1-ether5:9198; sfp1:9198 RBFTC11 ether1:4046; sfp1:4046 RBM33G ether1-ether3:2026 RBM11G ether1:2026 RB760iGS ether1-ether5:2026; sfp1:2026 E50UG ether1:2048; ether2-ether5:2026 RB411 series ether1:1526 RB433 series, RB450, RB493 series ether1:1526; ether2-ether3:1522 RB450Gx4 ether1-ether5:9214 RB411GL ether1:1520 RB433GL, RB435G , RB450G, RB493G ether1-ether3:1520 RB800 ether1-ether2:9500; ether3:9116 RB850Gx2 ether1-ether5:1580 RB921UAGS, RB922UAGS ether1:4076; sfp1:4076 D23UGS-5HPacD2HnD (NetMetal ac²) ether1:9214 ; sfp1:9214 RB953GS ether1-ether2:4074; sfp1:4074; sfp2:4076 RB2011 series ether1-ether5:4074; ether6-ether10:2028; sfp1: 4074 RB3011 series ether1-ether5:8156; ether6-ether10:8156; sfp1: 8158 RB5009 series ether1-ether8: 9796; sfp-sfpplus1: 9796 L009 series ether1: 8158; ether2-ether8: 8154; sfp1: 8154 RB44Ge ether1-ether4:9116 All wireless interfaces in RouterOS (including Nstreme2) support 2290 byte L2MTU. MPLS/Layer-2.5/L2.5 MTU Configured in the "/mpls interface" menu, specifies the maximal size of the packet, including MPLS labels, that is allowed to send out by the particular interface. Make sure that MPLS MTU is smaller or equal to L2MTU. MPLS MTU affects packets depending on what action the MPLS router is performing. It is strongly recommended that MPLS MTU is configured to the same value on all routers forming the MPLS cloud because of the effects MPLS MTU has on MPLS switched packets. This requirement means that all interfaces participating in the MPLS cloud must be configured to the smallest MPLS MTU values among participating interfaces, therefore care must be taken to properly select the hardware to be used. You can read more about MPLS MTU here. MPLS Switching If the packet with labels included is bigger than MPLS MTU, MPLS tries to guess the protocol that is carried inside the MPLS frame: L2MTU configuration changes evoke all interface reloads (link down/link up) due to necessary internal processes. It is recommended to configure L2MTU with caution by keeping in mind that it can cause short interruption with connected devices.

If this is an IP packet, MPLS produces an ICMP Need Fragment error. This behavior mimics IP protocol behavior. Note that this ICMP error is not routed back to the originator of a packet but is switched towards the end of LSP so that the egress router can route it back. If this is not an IP packet, MPLS simply drops it, because it does not know how to interpret the contents of the packet. This feature is very important in situations where MPLS applications such as VPLS are used (where frames that are MPLS tagged are not IP packets, but e.g. encapsulated Ethernet frames as in the case of VPLS) - if somewhere along the LSP MPLS MTU will be less than packet size prepared by ingress router, frames will simply get dropped. IP ingress When a router first introduces a label (or labels) on an IP packet, and the resulting packet size including MPLS labels exceeds MPLS MTU, the router behaves as if interface MTU was exceeded - either fragment packet in fragments that do not exceed MPLS MTU when labels are attached (if IP Don't Fragment is not set) or generate ICMP Need Fragmentation error that is sent back to the originator. VPLS ingress When the router encapsulates the Ethernet frame for forwarding over VPLS pseudowire, it checks if packet size with VPLS Control Word (4 bytes) and any necessary labels (usually 2 labels - 8 bytes), exceeds MPLS MTU of the outgoing interface. If it does, VPLS fragments packets so that it honors the MPLS MTU of the outgoing interface. A packet is defragmented at the egress point of the VPLS pseudowire. Setup Examples In these examples, we will take a look at frames entering and leaving the router via Ethernet interfaces. Simple Routing The image shows the packet MTU size for simple routing, packets size is not modified. Routing with VLAN Encap Each VLAN tag is 4 bytes long, the VLAN tag is added by a router. L2-MTU is increased by 4 bytes.

Simple MPLS with Tags When MPLS is used as a plain replacement for IP routing, only one label is attached to every packet, therefore packet size increases by 4 bytes, we have the situation with two MPLS labels. In order to be able to forward standard size (1500 bytes) IP packets without fragmentation, MPLS MTU must be set to at least 1508 for two MPLS labels. VPLS Tunnel Two MPLS labels are present when a remote endpoint is not directly attached. One MPLS label is used to get to a remote endpoint, the second label is used to identify the VPLS tunnel. Advanced Setup Examples In this example, we will take a closer look at the required L2MTU of all Ethernet-like interfaces including Bridge, VLAN, and VPLS interfaces. In this setup we will have 3 routers: Q-in-Q router - this router will receive a standard 1500 byte Ethernet frame and will add two VLAN tags to the packet. Then packet will be sent out via an Ethernet network to the second router VPLS router - this router will remove the outer VLAN tag and will bridge the packet with the remaining VLAN tag with the VPLS tunnel. VPLS tunnel will take a packet through the MPLS network to the third router. MPLS Edge router - will remove VPLS and VLAN tags and bridge packet to the client Ethernet network.

Dell DW5821e- eSIM0x413c 0x81e0 7.11 and higherMBIM driver. FW: T77W968.F1.0.0.5.2.GC.013. "at-chat" support added M.2 DELL T99W1750x05c6 0x90d5 7.16 and higherMBIM driver. FW: T99W175.F0.1.0.0.9.GC.004. "at-chat" support added M.2 Dell Wireless 5530 HSPAv6.1 and higherData channel 0, Info channel 0, init: AT+CFUN=1 (needs manualy change profile by command AT*ENAP=1,1)MiniPCI-e Ericsson F5521gwv6.x and higherMiniPCI-e Fibocom FM150-AE /FM150-NA0x2cb7 0x0111 v7.1beta5 MBIM driver. Revision: 89603.1000.00.01.01.03 M.2 Fibocom NL- 952-EAUv7.1beta5 MBIM driver. Revision: 19600.7000.00.04.01.05 M.2 Marvell PXA1802 based modems0x1286 0x4e31 v7.2.2 mini-PCIe Huawei E153 v6.31< and higherUSB Huawei E171 v6.xx Works! ppp interface, vendorid=0x12d1 deviceid=0x140c USB Huawei e3131 v6.xx and higherppp interface USB Huawei E3372h, E5576h, E8372h0x12d1 0x14db v6.8 Config-less LTE interface for modems with vendor-id="0x12d1" device-id="0x14db" Models with suffixes -320 and -608 will not work with RouterOS v6, please use v7 instead Models with suffixes -325 works only with arm cpuUSB Huawei E3276- 150v6.xx ppp interface USB Huawei E3351 v6.24 and higherUSB Huawei E3531 v6.24 or 6.40 RC25There are different versions of this modem E3531-6 works from version 6.40RC25 as ppp, mbim supported only from RouterOS V7USB Huawei e398 v6.xx and higherppp interface USB Huawei E5377 v6.36.1 MIFI unit. No serial support, but works with IP on LTE interface USB Huawei E5673s-609v6.xx LTE interface USB Huawei K5160 v6.37 v7.0beta6v6 and v7 - config-less LTE interface v7 - by default will try to use modem in MBIM modeUSB Huawei K5161 v6.47 Config-less LTE interface USB Huawei ME909s-120v6.28 Recommended modem firmware version 11.617.24.00.00 To reduce LTE interface IP subnet mask to /32 configure modem with at-chat command: /interface lte at-chat [find] input="AT^CUSTFEATURE=3,1"MiniPCI-e Huawei ME909u-521v6.11 MiniPCI-e Huawei MU609 v6.11 MiniPCI-e Huawei MU709s-2v6.28 MiniPCI-e Huawei MS2372h-517v7.12beta3 ppp/serial interface USB Jaton MT421e v6.40RC32 LTE interface with Ethernet emulation (no configuration possible), LTE supported bands 42/43 MiniPCI-e Netgear Unite Explore 815Sv6.41 MIFI unit. No serial support, but works with IP on LTE interface. USB

Novatel USB730Lv6.41RC6 LTE interface USB Olivetti Olicard 500v6.41RC11 ppp interface USB Quectel EC20 /EC21v6.xx ppp interface, there is page in wiki about Quectel: article MiniPCI-e Quectel BG77 0x2c7c 0x0700 v6.47 Serial/PPP interface, single AT/modem channel OEM module Quectel BG95- M3v6.47 Serial/PPP interface, single AT/modem channel Will not work in wAP R ac boards.mini-PCIe Quectel BG96 v6.45 Serial/PPP interface, 2x AT/modem channels mini-PCIe Quectel EC25- EU0x2c7c 0x0125 v6.42 ppp/LTE interface, there is page in wiki about Quectel ppp mode: article RouterOS v6 CDC-ECM mode - LTE interface receive address in modems internal network. RouterOS v7 MBIM mode - LTE interface uses APN IP address.MiniPCI-e Quectel EG25- G0x2c7c 0x0125 6.48.3 RouterOS v6 CDC-ECM mode - LTE interface receive address in modems internal network. RouterOS v7 MBIM mode - LTE interface uses APN IP address. In some boards may be required to disable SIM hot plug detection: /interface lte set [find] modem-init="AT+QSIMDET=0,1"MiniPCI-e Quectel EM12- G0x2c7c 0x0512 v7.1beta5 MBIM driver m.2 Quectel EP06 v6.42 ppp/LTE interface, there is page in wiki about Quectel: article MiniPCI-e Quectel RM500Q-GL0x2c7c 0x0800 v7.1beta6 MBIM driver m.2 Quectel RM500Q-AE0x2c7c 0x0800 v7.1beta6 MBIM driver m.2 Quectel RM502Q-AE0x2c7c 0x0800 v7.1beta5 MBIM driver m.2 Quectel RM510Q-GL0x2c7c 0x0800 7.9 MBIM driver m.2 Quectel UC15 v6.xx Works, ppp interface MiniPCI-e Quectel UC20 v6.xx Works, ppp interface MiniPCI-e R11e-4G 0x2cd2 0x0003 v6.42 LTE interface. Supports multiple APN passthrough. MiniPCI-e R11e-LTE6 0x2cd2 0x0004 v6.39.2 LTE interface. Supports multiple APN passthrough. MiniPCI-e R11e-LTE 0x2cd2 0x0001 v6.39.2 LTE interface. Supports multiple APN passthrough. MiniPCI-e Sierra Netgear AirCard 320U6.41 Customer tested the modem with firmware 03.05.23 USB Sierra wireless MC73xxv6.xx(ppp) v7.xx (LTE)Works! PPP interface. And starting with v7.xx it will support LTE interface with modem switched to expose the MBIM interface. MC7304 tested with firmware SWI9X15C_05.05.67.00MiniPCI-e Sierra Wireless MC7430v6.xx and higherData channel 2, Info channel 2, Modem init: AT+CGATT=0, Dial-command: AT+CGATT=1;D*99#, also needs 3.0 pins isolated (PINS:23,25,27,31,33)MiniPCI-e Sierra Wireless MC74xxv7.1 Basic functionality support for modems with MBIM interface/USB composition mini-PCIe Sierra Wireless MC7455v7.3beta37 MBIM mode with extended support for USB compositions: 1009 - diag,modem,mbim 100D - diag,nmea,modem,mbimmini-PCIe

Sierra Wireless MC7710 /MC7700 /MC7750v5.25, v6.0 and 6.40 RC43If modem uses firmware 3.5 it should be upgraded to 3.5.23.2 firmware release in order to work in RouterOS correctly again.MiniPCI-e SIMcom SIM5360v6.xx Works! Using PPP interface, vendor-id="0x05c6" device-id="0x9000" MiniPCI- e / USB w/ converter SIMcom SIM71000x1e0e 0x9001 v6.xx(ppp) v7.xx (LTE)Works! PPP interface. And starting with v7.xx it will support LTE interface. MiniPCI- e / USB w/ converter SIMCom SIM8202G-M.2v7.11 MBIM driver supported: AT+CUSBCFG=usbid,1e0e,901e m.2 SXT LTE v6 LTE interface. Old version of SXT LTE Built-in Tele2.ru LTE- D402v6.47 Config-less LTE interface Telecom NZ T- Stick ZTE MF- 181v6.0rc13 Data Channel=2, Info Channel=2, APN , PHONE=*99#. Tested ok for both internet.telecom.co.nz data and SMS on CCR1016-12GUSB Telit FN980m v7.5 AT#USBCFG=2 m.2 Telit LE910 0x1bc7 0x1201 v6.xx ppp interface MiniPCI-e Telit LE910C1 v6.46 Non-configurable from RouterOS MiniPCI-e Telit LM940 v6.44 LTE interface in some cases needs 3.0 pins isolated (PINS:23,25,27,29,31,33) MiniPCI-e Telit LM960 v6.46 LTE interface in some cases needs 3.0 pins isolated (PINS:23,25,27,29,31,33) MiniPCI-e TPS (Turning Point Solution) GCT450v6.48 Config-less LTE interface MiniPCI-e Vodafone (Huawei) K4203v7.xx Not supported in ROS v6, but as this modem supports MBIM drivers support will be possible in ROS v7.USB Vodafone K4201-Zv6.8 Some settings are ignored. LTE interface. USB Vodafone K4305v6.7 Some settings are ignored. USB Vodafone K5160v6.37 Some settings are ignored. USB Yota LU150 v5.22 and v6. 4Some settings are ignored. USB Yota wifi modemv6.7 Some settings are ignored. USB Yota WLTUBA- 107v6.0 Some settings are ignored. USB ZTE 821D v6.x Set Info channel = 1, Data channel = 3, Dial command=ATDT USB ZTE AC5730 v6.x USB ZTE ME3630- Ev6.40RC26 ppp and LTE interface MiniPCI-e ZTE MF110 v6.28 and higherSet info channel = 2, data channel = 2, Dial command=ATM1L3DT USB ZTE MF823 v6.8 Some settings are ignored. For some devices it's needed to enter in FACTORY mode to change operating state.USB ZTE MF825A v6.xx Some settings are ignored. USB

Unica GP-3124-L2CD-C 1,25G Dual LC, MM 1310nm RB2011LS-IN Works! Cisco GLC-T 1.25G RJ45, Cat6 N/A RB2011LS-IN Works! Cisco GLC-SX-MM 1000BASE-SX SFP transceiver module for MMF, 1.25GDual LC, MM 850nm RB2011LS-IN Works! Cisco SFP-GE-L 1000BASE-LX/LH SFP transceiver module for SMF, 1.25GDual LC, SM 1300nm Various MT hardware Works! 6COM 6C-SFP-T 10/100/1000 RJ45, Cat6 N/A RB2011LS-IN Works! 6COM 6C-WDM-0210BSD 1,25G BiDi SC, SM Tx:1550nm/Rx: 1310nmRB2011LS-IN Works! 6COM 6C-WDM-0210ASD 1,25G BiDi SC, SM Tx:1310nm/Rx: 1550nmRB2011LS-IN Works! 6COM 6C-SFP-0310D 1,25G Dual LC, MM 1310nm RB2011LS-IN Works! 6COM 6C-SFP-0301D 1,25G Dual LC, MM 850nm RB2011LS-IN Works! Ingellen INSP-T(10/100 /1000)10/100/1000 RJ45, Cat6 N/A RB2011LS-IN Works! Ingellen INSPL-53-BX 1,25G BiDi LC, MM 1550/1310 RB2011LS-IN Works! Ingellen INSPL-35-BX 1,25G BiDi LC, MM 1310/1550 RB2011LS-IN Works! Ingellen INSP-LX-SM 1,25G Dual LC, SM 1310nm RB2011LS-IN Works! Ingellen INSP-SX-MM 1,25G Dual LC, MM 850nm RB2011LS-IN Works! AXCEN AXGT-R1T4-05I1 10/100/1000 RJ45, Cat6 N/A RB2011LS-IN Works! AXCEN AXGD-37А4-0531 1,25G BiDi LC, MM Tx:1550nm/Rx: 1310nmRB2011LS-IN Works! AXCEN AXGD-16А4-0531 1,25G BiDi LC, MM Tx:1310nm/Rx: 1550nmRB2011LS-IN Works! AXCEN AXGD-1354-0531 1,25G Dual LC, MM 1310nm RB2011LS-IN Works! AXCEN AXGD-5854-0511 1,25G Dual LC, MM 850nm RB2011LS-IN Works! TP-Link TL-SM311LS 1,25G Dual LC, SM 1310nm RB2011LS-IN Works! TP-Link TL-SM311LM 1,25G Dual LC, MM 850nm CCR1036 12G-4S Works! OPTIC OPTIC-SFP-3524S- 02-SC1,25G BiDi SC, SM Tx:1310nm/Rx: 1550nmRB2011UAS-RM, RB260GS Works! OPTIC OPTIC-SFP-5324S- 02-SC1,25G BiDi SC, SM Tx:1550nm/Rx: 1310nmRB2011UAS-RM, RB260GS Works! OPTIC OPTIC-SFP-S1203- L3302-LC1,25G BiDi LC, SM Tx:1310nm/Rx: 1550nmRB2011UAS-RM, RB260GS Works! OPTIC OPTIC-SFP-S1205- L3302-LC1,25G BiDi LC, SM Tx:1550nm/Rx: 1310nmRB2011UAS-RM, RB260GS Works! ROBOFiber SFP-7120-55 1,25G Dual LC, SM 1550nm CCR1036-12G-4S, RB2011 Works! ROBOFiber SFP-7120-WA 1,25G BiDi LC, MM Tx:1490nm/Rx: 1550nmCCR, RB2011 Works! ROBOFiber SFP-7120-WB 1,25G BiDi LC, MM Tx:1550nm/Rx: 1490nmCCR, RB2011 Works! Enguity SFP-3647603KM. b1310 XT1,25G BiDi LC, SM Tx:1310nm/Rx: 1550nmCCR, RB2011, RB260GS Works! Enguity SFP-3647603KM. b1550 XT1,25G BiDi LC, SM Tx:1550nm/Rx: 1310nmCCR, RB2011, RB260GS Works! Enguity SFP-3647610KM. b1490 XT1,25G BiDi LC, SM Tx:1490nm/Rx: 1550nmCCR, RB2011, RB260GS Works! Enguity SFP-3647610KM. b1550 XT1,25G BiDi LC, SM Tx:1550nm/Rx: 1490nmCCR, RB2011, RB260GS Works!

PD uses a second power source which has a higher voltage than PSE, so all current is taken from the second DC source, not PSE PoE- Out port; off - all detection and power is turned off for this port; power_reset - PSE controller resetting the power, for example, when executing the power cycle command or when pings fail (power-cycle-ping); controller_init - PSE controller initialization; controller_upgrade - PSE controller is being upgraded; controller_error - PSE controller does not respond. poe-out- voltage ()Displays PoE Voltage which is applied to the PD. poe-out- current ()Displays port current (mA) which is drawn by the PD. poe-out- power ()Displays PD power consumption If feature is used, will show additional fields: power-cycle-ping /interface ethernet poe monitor [find] SNMP It is possible to monitor PoE-Out values using SNMP protocol, this requires enabled SNMP on PSE. SNMP Wiki SNMP OID tables: 1.3.6.1.4.1.14988.1.1.15.1.1.1 - interface-id 1.3.6.1.4.1.14988.1.1.15.1.1.2 - interface names 1.3.6.1.4.1.14988.1.1.15.1.1.4 - voltage in dV (decivolt) 1.3.6.1.4.1.14988.1.1.15.1.1.5 - current in mA 1.3.6.1.4.1.14988.1.1.15.1.1.6 - power usage in dW (deviwatt) SNMP values can be requested also from the RouterOS, for example, will print current mA from all available PoE-Out ports: snmp-walk To get very specific OID value, use tool (displays current mA on ether3 interface): snmp-get PoE-Out notifications PoE-Out LEDs Models with dependant voltage output PoE-Out LED behavior can differ between models, but most of them will indicate PoE-Out state on one additional LED. Devices with one voltage output will light: Red color LED - PoE-Out port state is (auto or forced-on mode). powered-on Blinking Red color LED - PoE-Out port state is short-circuit Models with selectable voltage output power-cycle-host-alive: <YES/NO> (Shows if monitored host is reachable) power-cycle-after:<TIME> (Shows time, after which the port will be power-cycled) /tool snmp-walk address=10.155.149.252 oid=1.3.6.1.4.1.14988.1.1.15.1.1.5 tool snmp-get address=10.155.149.252 oid=1.3.6.1.4.1.14988.1.1.15.1.1.5.3

Models with multiple voltage options can indicate additional information: Green color triangle LED - PoE-Out port state is (auto or forced-on mode), PD uses low voltage. powered-on Red color triangle LED - PoE-Out port state is (auto or forced-on mode), PD uses high voltage (af/at or passive). powered-on Blinking Green color triangle LED - PoE-Out port state (low voltage) is or short-circuit overload Blinking Red color triangle LED - PoE-Out port state (high voltage) is or short-circuit overload Model-specific LED behavior CRS112-8P-4S-IN - All PoE LEDs flashing: wrong voltage PSU plugged into one of the ports. netPower 16P - All PoE LEDs flashing: wrong voltage PSU plugged into one of the ports. CRS328-24P-4S+RM - indicates an exceeded overall max PoE output limit. Port PoE-Out priorities will work in 3 independent sections (8 ports each) and overload will happen in any section that breaches 150W consumption. CRS320-8P-8B-4S+RM - Purple color triangle LED - PoE-Out port state is powered-on (auto or forced-on mode), PD uses high voltage (802.3bt). Blinking Purple color triangle LED - PoE-Out port state (802.3bt high voltage) is short-circuit or overload PoE-Out Logs By default PoE-Out, event is enabled and uses "warning" and "info" topics to notify the user about PoE-Out state changes. Log entries will be logging added to each PoE-Out state change. Important logs will be added with a "warning" topic, informative logs will be added with the "info" topic. When PoE LLDP is enabled, LLDP status updates are available in the device logs, for example: Possible denial reasons: To avoid unnecessary logging in cases when PD is not powered because of current-too-low, RouterOS will filter such events, and add one log per every 512 current-too-low events. Logs can be disabled if necessary: PoE-Out Warnings in GUI/CLI To notify a user about important PoE-Out related problems, messages will be shown in Winbox / WebFig and CLI interface fields: WebFig and Winbox will notify user under interfaces: 06:56:50 poe-out,debug ether4 LLDP TLV 25.0W request denied : hw-limit budget - requested power exceeds the total PSE budget. hw-limit - requested power is more than hardware supports (PSU affects this). low-voltage - LLDP request made to low-voltage port. off - port is shut down. class-limit - LLDP requires more than the class can provide. cmd-failed - RouterOS could not make a request to the controller. /system logging set [find topics~"info"] topics=info,!poe-out /system logging set [find topics~"warning"] topics=warning,!poe-out 1 RS ;;; poe-out status: overload ether1 ether 1500 1588 9204 64:D1:54:61:D5:E0

How it works PoE-Out Modes auto-on mode If auto-on is selected on PoE-Out interface, then port operates in this strict order: PSE with low voltage checks for resistance on the connected port. If the detected resistance range is between (3kΩ to 26.5kΩ) power is turned on; When power is applied, the PSE continuously checks if the overload limit is not reached or short circuit detected If the cable is unplugged, the port returns in detection state and will remain off until suitable PD is detected forced-on mode If forced-on is selected then port operates in this strict order: PSE disables resistance check on the port, and apply power on pins 4,5 (+) and 7,8 (-), even if no cable is attached When power is applied, PSE still continuously checks if an overload or short circuit is not detected After the cable is unplugged, the power still remains enabled on the port. off mode If off mode is used, PoE-Out on the port will be turned off, no detection will take place, and the interface will behave like a simple Ethernet port. PoE-Out limitations It is important to check PoE-Out specification to find out hardware limitations because it can differ between models PoE-Out port limitation PoE-Out ports are limited with max amp values which are supported in particular voltage, usually max current will differ for low voltage devices (up to 30 V), and for high voltage devices (31 to 57 V). PoE-Out total limitation PSE has also a total PoE-Out current limitation which can't be exceeded, even if the individual port limit allows it. PoE Out polarity

Ports Summary General Properties Remote Access Properties Summary There are many ways how to use ports on the routers. Most obvious one is to use serial port for initial RouterOS configuration after installation (by default serial0 is used by serial-terminal). Serial and USB ports can also be used to: connect 3G modems; connect to another device through a serial cable access device connected to serial cable remotely. General Sub-menu: /port Menu lists all available serial and USB ports on the router and allows to configure port parameters, like baud-rate, flow-control, etc. Below you can see default port configuration on LtAP. [admin@LtAP] > /port/print Columns: DEVICE, NAME, CHANNELS, USED-BY, BAUD-RATE # DEVICE NAME CHANNELS USED-BY BAUD-RATE 0 serial0 1 Serial Console(#0) auto 1 gps 1 GPS(#0) 115200 Properties Property Description baud-rate ( ; integer | auto Default: )autoBaud rate (speed) used by the port. If set to , then RouterOS tries to detect baud rate automatically.auto data-bits ( ; Default: )7 | 8 The number of data bits in each character. 7 - true ASCII 8 - any data (matches the size of a byte) dtr ( ; Default: ) on | off Whether to enable RS-232 DTR signal circuit used by flow control. flow-control (hardware | none | ; Default: ) xon-xoffmethod of flow control to pause and resume the transmission of data. name ( ; Default: ) string Name of the port. parity ( ; even | none | odd Default: )Error detection method. If enabled, extra bit is sent to detect the communication errors. In most cases parity is set to n and errors are handled by the communication protocol.one List of the ports are maintained automatically by the RouterOS.

rts ( ; Default: ) on | off Whether to enable RS-232 RTS signal circuit used by flow control. stop-bits ( ; Default: )1 | 2 Stop bits sent after each character. Electronic devices usually uses 1 stop bit. Read-only properties Property Description channels ( ) integer Number of channels supported by the port. inactive ( ) yes | no Shows current port state, - device with port previous was connected, but currently is not present inactive=yes line-state () used-by ( ) string Shows who is currently are using port and channel (#). For example, by default is used by serial-console. Serial0 Remote Access Sub-menu: /port remote-access If you want to access serial device that can only talk to COM ports and is located somewhere else behind router, then you can use remote-access. As defined in RFC 2217 RouterOS can transfer data from/to a serial device over TCP connection. Enabling remote access on RouterOS is very easy: /port remote-access add port=serial0 protocol=rfc2217 tcp-port=9999 Properties Property Description allowed-addresses ( ; Default: IP address range ) 0.0.0.0/0Range of IP addresses allowed to access port remotely. channel ( ; Default: ) integer [0..4294967295] 0 Port channel that will be used. If port has only one channel then channel number should always be .0 disabled ( ; Default: ) yes | no no local-address ( ; Default: ) IP address IP address used as source address. log-file ( ; Default: ) string "" Name of the file, where communication will be logged. By default logging is disabled. port ( ; Default: ) string Name of the port from Port list. protocol ( ; Default: ) raw | rfc2217 rfc2217 RFC 2217 defines a protocol to transfer data from/to a serial device over TCP. If set to , then data raw is sent to serial as is. tcp-port ( ; Default: ) integer [1..65535] 0 TCP port on which to listen for incoming connections. Read-only properties Property Description active ( ) yes | no Whether remote access is active and ready to accept connection. busy ( ) yes | no Whether port is currently busy. inactive ( ) yes | no By default serial0 is used by serial-terminal. Without releasing the port, it cannot be used by remote-access or other services

logging-active ( ) yes | no Whether logging to file is currently running remote-address ( ) IP address IP address of remote location that is currently connected.

If the board has built-in wireless, then all its features are represented in the following format: <band><power_per_chain><protocol><number_of_chains> band 5 - 5Ghz 2 - 2.4Ghz 52 - dual-band 5Ghz and 2.4Ghz power per chain (not used) - "Normal" - <23dBm at 6Mbps 802.11a; <24dBm at 6Mbps 802.11g H - "High" - 23-24dBm at 6Mbps 802.11a; 24-27dBm at 6Mbps 802.11g HP - "High Power" - 25-26dBm 6Mbps 802.11a; 28-29dBm at 6Mbps 802.11g SHP - "Super High Power" - 27+dBm at 6Mbps 802.11a; 30+dBm at 6Mbps 802.11g protocol (not used) - for cards with only 802.11a/b/g support n - for cards with 802.11n support ac - for cards with 802.11ac support ax - for cards with 802.11ax support number_of_chains (not used) - single chain D - dual chain T - triple chain connector type (not used) - only one connector option on the model MMCX - MMCX connector type u.FL - u.FL connector type Enclosu re type (not used) - the main type of enclosure for a product BU - board unit (no enclosure) - for a situation when a board-only option is required, but the main product already comes in the case RM - rack-mount enclosure IN - indoor enclosure EM - extended memory LM - lite memory BE - black edition case TC - Tower (vertical) case PC - PassiveCooling enclosure (for CCR) TC - Tower (vertical) Case enclosure (for hEX, hAP and other home routers.) OUT - outdoor enclosure More Specific types OUT enclosures are: SA - sector antenna enclosure (for SXT) HG - high gain antenna enclosure (for SXT) BB - Basebox enclosure (for RB911) NB - NetBox enclosure (for RB911) NM - NetMetal enclosure (for RB911) QRT - QRT enclosure (for RB911) SX - Sextant enclosure (for RB911,RB711) SXTsq - SXTsq enclosure PB - PowerBOX enclosure (for RB750P, RB950P) XL - extra large enclosure (bigger size LHG for example) LTm - LtAP mini case, LT - LtAP case KN - KNOT case Example #1 decode naming: RB912UAG-5HPnD

RB (RouterBOARD) 912 - 9th series board with 1 wired (ethernet) interface and two wireless interfaces (built-in and mini PCIe) UAG - has a USB port, more memory, and gigabit ethernet port 5HPnD - has built-in 5GHz high power dual chain wireless card with 802.11n support. #2 decode naming: RBD52G-5HacD2HnD-TC RouterBOARD (deprecated in new) D - Dakota series CPU 5 - wired interfaces 2 - wireless interfaces G - gigabit 5HacD - has built-in 5GHz high power dual chain wireless card with 802.11ac support. 2HnD - has built-in 2.4GHz high power dual chain wireless card with 802.11n support. TC - tower case #3 decode naming: C52iG-5HaxD2HaxD-TC C - Cypress series CPU 5 - wired interfaces 2 - wireless interfaces i - single port power injector without controller G - gigabit 5HaxD - has built-in 5GHz high power dual chain wireless card with 802.11ax support. 2HaxD - has built-in 2.4GHz high power dual chain wireless card with 802.11ax support. TC - tower case CloudCoreRouter naming details CloudCoreRouter (short version CCR) naming consists of: <4 digit number>-<list of ports>-<enclosure type> 4 digit number 1st digit stands for series 2nd (reserved) 3rd-4th digit indicates the number of total CPU cores on the device list of ports -<n> number of 1G Ethernet portsG -<n> number of 1G Ethernet ports with PoE-outP -<n> number of combo 1G Ethernet/SFP portsC -<n> number of 1G SFP portsS -<n> number of 2.5G Ethernet portsG+ -<n> number of 2.5G Ethernet ports with PoE-outP+ -<n> number of combo 10G Ethernet/SFP+ portsC+ -<n> number of 10G SFP+ portsS+ -<n> number of 5G/10G Ethernet portsXG -<n> number of 5G/10G Ethernet ports with PoE-outXP -<n> number of combo 10G/25G SFP+ portsXC -<n> number of 25G SFP+ portsXS -<n> number of 40G QSFP+ portsQ+ -<n> number of 100G QSFP+ portsXQ enclosure type - same as for RouterBOARD products. CloudRouterSwitch and CloudSmartSwitch naming details CloudRouterSwitch (short version CRS, RouterOS device) CloudSmartSwitch (short version CSS, SwOS device) naming consists of: <3 digit number>-<list of ports>-<built-in wireless card>-<enclosure type> 3 digit number 1st digit stands for series

2nd-3rd digit - total number of wired interfaces (Ethernet, SFP, SFP+) list of ports -<n> number of 100M Ethernet portsF -<n> number of 100M Ethernet ports with PoE-out injectorFi -<n> number of 100M Ethernet ports with controlled PoE-outFp -<n> number of 100M Ethernet ports with Reverse PoE (PoE-in)Fr -<n> number of 1G Ethernet portsG -<n> number of 1G Ethernet ports with PoE-outP -<n> number of combo 1G Ethernet/SFP portsC -<n> number of 1G SFP portsS -<n> number of 2.5G Ethernet portsG+ -<n> number of 2.5G Ethernet ports with PoE-outP+ -<n> number of combo 10G Ethernet/SFP portsC+ -<n> number of 10G SFP+ portsS+ -<n> number of 5G/10G Ethernet portsXG -<n> number of 5G/10G Ethernet ports with PoE-outXP -<n> number of combo 10G/25G SFP+ portsXC -<n> number of 25G SFP+ portsXS -<n> number of 40G QSFP+ portsQ+ -<n> number of 100G QSFP+ portsXQ built-in wireless card - same as for RouterBOARD products. enclosure type - same as for RouterBOARD products.

memory-frequency (dep ; Default: ends on model ) depends on modelThis option allows changing the memory frequency of the device. Values depend on the model, to see available options, hit the [?] button in RouterOS version 6 or the [F1] button in button on the keyboard at this prompt RouterOS version 7 memory-data-rate (dep ; ends on the model Default: depends on ) modelThis option allows changing the memory data rate of the device. Values depend on the model, to see available options, hit the [?] button in RouterOS version 6 or the [F1] button in button on the keyboard at this prompt RouterOS version 7 preboot-etherboot (time ; out interval 1s..30s Default: ) disabledEnables , which runs before the regular boot device. It works the same as , but preboot etherboot boot-device=etherboot has an additional timeout value. If an IP address is not received from the Netinstall server before the timeout expires, the regular booting process will start. preboot-etherboot- server ( : IP address, any Default: )anySets to accept IP address only from the specified Netinstall server IP address. By enabling this feature, preboot-etherboot unintentional etherboot from other BOOTP/DHCP servers can be prevented. regulatory-domain-ce (y ; Default: ) es | no noEnables extra-low TX power for high antenna gain devices (requires a reboot) silent-boot ( ; yes | no Default: ) noThis option disables output on the serial console and beeping sounds during booting, to avoid the text output interrupting a connected device. Useful if you have some temperature monitor or modem connected to the serial port yes- no output on the serial console and no booting beeps (does not disable the RouterOS: beep command) no- regular info and options menu on a serial console Preboot etherboot preboot-etherboot is a feature that instructs RouterOS device to search for a Netinstall server on every boot for specified amount of time, before starting the regular booting process (e.g., RouterOS). This feature is particularly useful for remote reinstall, as it allows the device to attempt etherboot on every startup. preboot-etherboot-server specifies that the booter should look only for a Netinstall server with a specific IP address. Since by default, preboot-etherboot etherboot accepts address from any BOOTP/DHCP server, with this feature, you can specify to accept the address only from a particular Netinstall server, meaning that the device can be reinstalled without removing it from the network. With both features enabled, any device can be reinstalled remotely without accessing RouterOS or holding the reset button. One example of starting a remote reinstall process would be to simply power cycle RouterOS device from a PoE switch or another power controller. After installation, disable your Netinstall server and simply power cycle the installed device. To enable and : preboot-etherboot preboot-etherboot-server 1) Install RouterOS version 7.9+ 2) Upgrade RouterBOOT with "/system routerboard upgrade" 3) Reboot The feature can be set with command: Note The preboot-etherboot configuration is stored in the BIOS, downgrading RouterOS to older versions will not disable it. This feature can be disabled from the RouterOS menu or by resetting the BIOS. Since etherboot accepts IP addresses from any BOOTP/DHCP server, use preboot-etherboot-server to start etherboot only when address is received from specified Netinstall server. If the CPU or memory is overclocked and that is the reason why the router is not performing as suspected, then this is not considered a warranty case and you should return both frequencies to a nominal value.

system/routerboard/settings/set preboot-etherboot=9s preboot-etherboot-server=10.155.115.199 On every next reboot/power cycle, this device will try to receive IP address from Netinstall server with IP 10.155.115.199, for 9 seconds. If there will be no such server, regular boot process will start. Protected bootloader The feature allows the protection of RouterOS configuration and files from a physical attacker by disabling etherboot. It is called "Protected RouterBOOT". This feature can be enabled and disabled only from within RouterOS after login, i.e., there is no RouterBOOT setting to enable/disable this feature. These extra options appear only under certain conditions. When this setting is enabled - both the reset button and the reset pin-hole are disabled. RouterBOOT menu is also disabled. The only ability to change boot mode or enable the RouterBOOT settings menu is through RouterOS. If you do not know the RouterOS password - only a complete format is possible. A special package is provided to upgrade the backup RouterBOOT ( ). Newer devices will have this new backup loader already installed at DANGEROUS the factory. If your RouterOS is , your version is lower than and your device displays the message → v7 factory-firmware 7.6 The "protected routerboot" ← when trying to enable the feature, do the following: feature requires a backup-routerboot upgrade a) upgrade or downgrade the device specifically to the release (from our or ). 7.6 download page archive b) upgrade your current RouterBOOT version with "/system routerboard upgrade" then reboot the device, so that the RouterBOOT version ( current- version when checking "/system routerboard print") is the same as the firmware version ("/system resource print") installed, which should be 7.6. firmware c) drag and drop the into the device's file system then reboot the device again. This will make your v7 universal package for all architectures factory- version 7.6, where you are allowed to enable the feature. After this step, you can upgrade the device to a newer release. firmware If your RouterOS version is and you get the same prompt, follow the same steps mentioned above, but only update/downgrade/compare your device v6 version to specifically instead and use 6.49.7 v6 universal package for all architectures . For example, when setting protected-routeboard enabled, you will be given 60 seconds to confirm by pressing the reset button, otherwise, this setting won't be enabled. [admin@450] > system/routerboard/settings/set protected-routerboot=enabled [admin@450] > system/routerboard/settings/print ;;; press button within 60 seconds to confirm protected routerboot enable auto-upgrade: no baud-rate: 115200 boot-delay: 2s enter-setup-on: any-key boot-device: nand-if-fail-then-ethernet cpu-frequency: auto boot-protocol: bootp enable-jumper-reset: yes force-backup-booter: no silent-boot: yes protected-routerboot: enabled reformat-hold-button: 20s reformat-hold-button-max: 10m Property Description In case if the preboot-etherboot is set to boot from any IP (preboot-etherboot-server is not specified), the device will enter etherboot mode from any Netinstall/DHCP server-provided IP address and will wait for the reinstall process. Also, note that RouterOS reinstall does not affect BIOS settings, and preboot-etherboot would still be enabled and would try to enter etherboot. To avoid this scenario without accessing RouterOS, simply disable any attached Netinstall/DHCP server. Starting from the v7 version, when enabling or making any changes to the protected-routerboard feature the reset or mode button must be pressed for confirmation.

enabled ( ; Default: ) no | yes no Disable or enable the operation of the button hold-time ( ; time interval Min..Max Default: )HoldTime:= Button functionality can be called if a button is pressed for a certain period of time: Min..Max: Min -- 0s..1m (time interval), Max -- 0s..1m (time interval) (available only starting from RouterOS 6.47beta60) on-event ( ; Default: ) string Name of the script that will be run upon pressing the button. The script must be defined and named in the " /system scripts" menu Example for mode button: /system script add name=test-mode-button source={:log info message=("mode button pressed");} /system routerboard mode-button set on-event=test-mode-button enabled=yes Upon pressing the button, the message "mode button pressed" will be logged in the system log. Examples for RouterOS version newer than 6.47: /system script add name=test-mode-button source={:log info message=("mode button pressed");} /system routerboard mode-button set on-event=test-mode-button hold-time=3..5 enabled=yes The reset button works in the same way, but the menu is moved under : the : /system routerboard reset-button /system script add name=test-reset-button source={:log info message=("reset button pressed");} /system routerboard reset-button set on-event=test-reset-button hold-time=0..10 enabled=yes LED dark mode control with the mode button: /system script add name=dark-mode source={ :if ([system leds settings get all-leds-off] = "never") do={ /system leds settings set all-leds-off=immediate } else={ /system leds settings set all-leds-off=never } } /system routerboard mode-button set enabled=yes on-event=dark-mode The C53, S53 and cAP ax series RouterBoards have configurable WPS button. It also works in the same way as reset button and mode button and executes a script. /system script add name=test-wps-button source={:log info message=("wps button pressed");} /system routerboard wps-button set on-event=test-wps-button hold-time=0..10 enabled=yes WPS accept control with the WPS button: /system script add name=wps-accept source={ :foreach iface in=[/interface/wifiwave2 find where configuration.mode="ap"] do={ /interface/wifiwave2 wps-push-button $iface } } /system routerboard wps-button set enabled=yes on-event=wps-accept Starting from RouterOS 6.47 reset-button functionality and a hold-time option have been added

USB Port Mode RB2011 series, CRS1xx series, and mAP have micro USB port which operates in host mode when USB device is attached through USB OTG cable. Some vendor cables require forced host mode to recognize connected device. Available properties: usb-mode ( ; Default: "automatic") - Defines USB port mode. automatic | force-host RouterBoard USB Port Limitations Some RouterBoard devices have notable USB port limitations. * RB mAP 2n - does not support USB Power Reset * RB750UP - does not support USB Power Reset * RB751U-2HnD - does not support USB Power Reset * RB751G-2HnD - does not support USB Power Reset * RB411U - does not support USB Power Reset * RB411UAHR - does not support USB Power Reset and USB Powering ( is required) USB power injector * RB433UAH - does not support USB Power Reset * RB435G - does not support USB Power Reset * RB493G - does not support USB Power Reset and USB Powering ( is required) USB power injector The miniPCIe slot closer to Ethernet ports on the RB953GS board is the one which is shared with USB port and has configurable RB953GS: US , its USB bus number is 1. Depending on the power reset is done on USB port or miniPCIe slot. The other miniPCIe B port type USB port type slot closer to SFP slots has independent bus - 2. Warning On RB2011 and CRS1xx series boards USB devices may not work first time they are plugged in. In such cases power cycle (not reboot) is required. RouterOS does not support memory slot from USB modems.

Diagnostics, monitoring and troubleshooting In This Section:

Detect Internet Introduction Detect Internet is a tool that categorizes monitored interfaces into the following states - , , , , and . Internet WAN LAN unknown no-link State This submenu displays status of all monitored interfaces defined by the parameter: detect-interface-list interface/detect-internet/state/print LAN All layer 2 interfaces initially have this state. WAN Any L3 tunnel and LTE interfaces will initially have this state. Layer 2 interfaces can obtain this state if the following conditions are met: an interface has an active route to 8.8.8.8 in main routing table. an interface can obtain (dynamic DHCP client is created) or has obtained an address from DHCP (does not apply if DHCP server is also running Detect Internet on the DHCP server interface). Internet WAN interfaces that can reach cloud.mikrotik.com using UDP protocol port 30000 can obtain this state. Reachability is checked every minute. If a cloud is not reached for 3 minutes, the state falls back to . WAN Configuration /interface detect-internet Property Description detect-interface-list ( ; Default: ) interface list none All interfaces in the list will be monitored by Detect Internet internet-interface-list ( ; Default: ) interface list none Interfaces with state Internet will be dynamically added to this list lan-interface-list ( ; Default: ) interface list none Interfaces with state Lan will be dynamically added to this list wan-interface-list ( ; Default: ) interface list none Interfaces with state Wan will be dynamically added to this list Note that Detect Internet can install DHCP clients, default routes, DNS servers and affect other facilities. Use with precaution, and after enabling the service, check how it interferes with your other configuration. WAN interface can fall back to LAN state only when link status changes. LAN interfaces get locked to LAN after 1h and then change only when link status changes.

Graphing Summary Configuration General Interface graphing Queue graphing Resource graphing Graphing in WinBox Summary Graphing is a tool to monitor various RouterOS parameters over time and put collected data in graphs. Watch our . video about this feature The Graphing tool can display graphics for: Resource usage (CPU, Memory, and Disk usage) Traffic which is passed through an interface Traffic which is passed through a simple queue Graphing consists of two parts - the first part collects information and the other part displays data on a Web page. To access the graphics, type http:// [Router_IP_address]/graphs/ and choose a graphic to display in your Web browser. Alternatively, look for the menu (triple bar sign) in the top right corner of the WebFig interface, allowing you to find "graphs":≡ Example of memory graphs: We suggest not storing graphs on disk for devices with small built-in memory.

Configuration General The configuration is done under "/tool graphing" menu, by default, graphing is disabled. You can configure graphing for interfaces, resources, and simple queues in their respective submenus. Sub-menu: /tool graphing Property Description store-every ( ; Default: ) 24hours | 5min | hour 5min How often to write collected data to system drive. page-refresh ( ; Default: ) integer | never 300 How often graph page is refreshed Interface graphing Sub-menu allows configuration for which interface graphing will collect bandwidth usage data. Sub-menu: /tool graphing interface Property Description allow-address ( ; Default: ) IP/IPv6 prefix 0.0.0.0/0 IP address range from which is allowed to access graphing information comment ( ; Default: ) string Description of current entry disabled ( ; Default: ) yes | no no Defines whether item is used interface ( ; Default: ) all | interface name all Defines which interface will be monitored. means that all interfaces on router will be monitored. all

store-on-disk ( ; Default: ) yes | no yes Defines whether to store collected information on system drive. Queue graphing Sub-menu allows configuration for which simple queue graphing will collect bandwidth usage data. Sub-menu: /tool graphing queue Property Description allow-address ( ; Default: ) IP/IPv6 prefix 0.0.0.0/0 IP address range from which is allowed to access graphing information allow-target ( ; Default: ) yes | no yes Whether to allow access to graphs from queue's target-address comment ( ; Default: ) string Description of current entry disabled ( ; Default: ) yes | no no Defines whether item is used simple-queue ( ; Default: ) all | queue name all Defines which queues will be monitored. means that all queues on router will be monitored. all store-on-disk ( ; Default: ) yes | no yes Defines whether to store collected information on system drive. Resource graphing Sub-menu allows to enable graphing of system resources. Graphing collects data of: CPU usage Memory usage Disk usage Sub-menu: /tool graphing resource Property Description allow-address ( ; Default: ) IP/IPv6 prefix 0.0.0.0/0 IP address range from which is allowed to access graphing information comment ( ; Default: ) string Description of current entry disabled ( ; Default: ) yes | no no Defines whether item is used store-on-disk ( ; Default: ) yes | no yes Defines whether to store collected information on system drive Graphing in WinBox Winbox allows viewing the same collected information as on the web page. Open window. Double click on the entry of which you want to Tools->Graphing see graphs. The image below shows WinBox graphs of memory usage: If simple queue has target-address set to 0.0.0.0/0 everyone will be able to access queue graphs even if allow address is set to specific address. This happens because by default queue graphs are accessible also from the target address.

Routers that support temperature monitoring will display temperature reading. In CLI/Winbox it will display degrees Celsius. Using scripts/API/SNMP this value will be shown in CLI/Winbox multiplied by 10. There are various temperature sensors depending on the device. These sensors may refer to: cpu- temperature, pcb-temperature, sfp-temperature. Device tested ambient temperature range you can find in specification description at . Tested mikrotik.com ambient temperature range is temperature in which device can be physically located. It is the same as temperature which reports system health not monitor! Fan control and behavior /system health set Using this menu users will be able to control fan behaviour on TILE architecture . devices Note: Improved FAN stability starting from version 6.45.5. There are three parameters that may affect fan behaviour: PoE-out consumption, SFP temperature and CPU temperature. As soon as one of the parameters exceeds the optimal value the, fans are started. PoE-out consumption If a device has PoE-out, then the fan RPM will change as described below: PoE-out load RPM % of max FAN speed 0%..24% FAN speed 0% 25%..46% FAN speed 25% 47%..70% FAN speed 50% 71%..92% FAN speed 75% 93%.. FAN speed 100% For devices with fans, the speed will linearly increase or decrease from 9..88% (note: below 100W the fan RPM=0) PWM Limited manual fan-control option Starting from RouterOS version 7.9 limited manual fan-control options have been added for CRS3xx, CRS5xx and CCR2xxx devices. Note: Starting from RouterOS version 7.14 limited manual fan-control is available for the CCR1036-8G-2S+-r2, CCR1036-12G-4S-r2 and CCR1016-12S- Note: 1S+-r2 devices. Fan behavior can be manipulated using the settings section of system health: /system health settings set Available properties are described below: Property Description fan-full-speed-temp ( Def integer [-273..65]; ault: )65Sets the temperature value upon which the fan speed will be increased to the maximum possible rpm. Reads temperature from CPU, PHY, SWITCH and SFP and adjusts fan speed based on the component with the highest temperature. fan-target-temp ( Default: integer [-273..65]; )58Sets the target temperature for the hottest component. Based on this setting adjusts fan behavior to hold temperatures in target range. fan-min-speed-percent ( De integer [0..100]; fault: ) depends on FAN controllerSets the minimum percentage of fan speed thus not allowing fans to have a lower rpm than this value. the default value may vary based on FAN controller chip and/or specific model requirements. *NOTE: From RouterOS verson 7.14 default value is set to all previous versions have 12, 0.

fan-control-interval ( Default: integer [5..30]; )30Sets the actual temperature data read interval to get temperature values from CPU, PHY, SWITCH and SFP. *NOTE: THIS SETTING DIRECTLY AFFECTS CPU USAGE Brief description of the fan-control If at least one of the internal measured (CPU, SFP, Switch, Board etc.) temperatures exceed , the fans will start to spin. The higher the fan-target-temp temperature, the faster the fans will spin. For devices with PWM fans, as the internal measured temperatures exceed , the fans will linearly fan-target-temp increase their RPM to try to keep the temperature at if possible and will get to their Max RPM when the temperature is equal or exceeds fan-target-temp fan . For devices with DC fans, as the internal measured temperatures exceed , the fans will start spinning but at a higher -full-speed-temp fan-target-temp minimum RPM by default. This may result in cooling the device to the point where the fans turn-off completely if is set to , while fan-min-speed-percent 0% with the default value of fans will never go to a full stop therefore reducing the noise and On/Off peaks that may occur. The temperature then may 12% slowly increase to and the fans will turn on again. Currently, there is one exception. The S+RJ10 modules have a temperature threshold of fan-target-temp 65C before they trigger the fans. Since it's a higher temperature threshold, the fans will start spinning at a higher initial speed to cool the device. All the above mentioned functionality is directly related to the parameter value as it will determine how often FAN controller monitors all sensor fan-control-interval data and triggers changes in fan-control. Note: All readings are approximate and may not be 100% precise. Their purpose is to ~inform users about possible/upcoming failures. Note: PWM and DC fans react to fan-control differently. While PWM fans will increase/decrease their RPM in a linear way the DC fans have only few possible speed ratings at which they may operate.

disk-stop-on-full ( ; Default: ) yes|no no whether to stop to save log messages to disk after the specified disk- lines-per-file and disk-file-count number is reached, applicable only if action=disk email-start-tls ( ; Default: ) yes | no no Whether to use tls when sending email, applicable only if action=email email-to ( ; Default: ) string email address where logs are sent, applicable only if action=email memory-lines ( ; Default: ) integer [1..65535] 1000 number of records in local memory buffer, applicable only if action=memory memory-stop-on-full ( ; Default: ) yes|no no whether to stop to save log messages in local buffer after the specified memory-lines number is reached name ( ; Default: ) string name of an action remember ( ; Default: ) yes|no whether to keep log messages, which have not yet been displayed in console, applicable if action=echo remote ( ; Default: ) IP/IPv6 Address[:Port] 0.0.0.0:514 remote logging server's IP/IPv6 address and UDP port, applicable if action=remote src-address ( ; Default: ) IP address 0.0.0.0 source address used when sending packets to remote server syslog-facility (auth, authpriv, cron, daemon, ftp, kern, local0, local1, local2, ; local3, local4, local5, local6, local7, lpr, mail, news, ntp, syslog, user, uucp Default: ) daemon syslog-severity (alert, auto, critical, debug, emergency, error, info, notice, ; Default: ) warning autoSeverity level indicator defined in RFC 3164: Emergency: system is unusable Alert: action must be taken immediately Critical: critical conditions Error: error conditions Warning: warning conditions Notice: normal but significant condition Informational: informational messages Debug: debug-level messages target ( ; Default: ) disk, echo, email, memory, remote memory storage facility or target of log messages disk - logs are saved to the hard drive echo - logs are displayed on the console screen email - logs are sent by email memory - logs are stored in local memory buffer remote - logs are sent to remote host Topics Each log entry have topic which describes the origin of log message. There can be more than one topic assigned to log message. For example, OSPF debug logs have four different topics: route, ospf, debug and raw. 11:11:43 route,ospf,debug SEND: Hello Packet 10.255.255.1 -> 224.0.0.5 on lo0 11:11:43 route,ospf,debug,raw PACKET: 11:11:43 route,ospf,debug,raw 02 01 00 2C 0A FF FF 03 00 00 00 00 E7 9B 00 00 11:11:43 route,ospf,debug,raw 00 00 00 00 00 00 00 00 FF FF FF FF 00 0A 02 01 11:11:43 route,ospf,debug,raw 00 00 00 28 0A FF FF 01 00 00 00 00 List of Facility independent topics Topic Description critical Log entries marked as critical, these log entries are printed to console each time you log in.

debug Debug log entries error Error messages info Informative log entry packet Log entry that shows contents from received/sent packet raw Log entry that shows raw contents of received/sent packet warning Warning message. Topics used by various RouterOS facilities Topic Description account Log messages generated by accounting facility. async Log messages generated by asynchronous devices backup Log messages generated by backup creation facility. bfd Log messages generated by BFD protocol bgp Log messages generated by BGP protocol calc Routing calculation log messages. caps CAPsMAN wireless device management certificate Security certificate clock Log messages generated by Clock, IP Cloud time changes. dns Name server lookup related information ddns Log messages generated by Dynamic DNS tool dude Messages related to the Dude server package The Dude tool dhcp DHCP client, server and relay log messages e-mail Messages generated by e-mail tool. event Log message generated at routing event. For example, new route have been installed in routing table. firewall Firewall log messages generated when is set in firewall rule action=log gsm Log messages generated by GSM devices hotspot Hotspot related log entries igmp-proxy IGMP Proxy related log entries ipsec IPSec log entries iscsi isdn interface kvm Messages related to the KVM virtual machine functionality l2tp Log entries generated by L2TP client and server lte Messages related to the LTE/4G modem configuration ldp LDP protocol related messages

manager User Manager log messages. mme MME routing protocol messages mpls MPLS messages ntp sNTP client generated log entries ospf OSPF routing protocol messages ovpn OpenVPN tunnel messages pim Multicast PIM-SM related messages ppp ppp facility messages pppoe PPPoE server/client related messages pptp PPTP server/client related messages radius Log entries generated by RADIUS Client radvd IPv6 radv daemon log messages. read SMS tool messages rip RIP routing protocol messages route Routing facility log entries rsvp Resource Reservation Protocol generated messages. script Log entries generated from scripts sertcp Log messages related to facility responsible for "/port remote-access" simulator state DHCP Client and routing state messages. store Log entries generated by Store facility smb Messages related to the SMB file sharing system snmp Messages related to Simple network management protocol (SNMP) configuration system Generic system messages telephony Obsolete! Previously used by the IP telephony package tftp TFTP server generated messages timer Log messages that are related to timers used in RouterOS. For example bgp keepalive logs 12:41:40 route,bgp,debug,timer KeepaliveTimer expired 12:41:40 route,bgp,debug,timer RemoteAddress=2001:470:1f09:131::1 ups Messages generated by UPS monitoring tool vrrp Messages generated VRRP watchdog Watchdog generated log entries web-proxy Log messages generated by web proxy wireless Wireless log entries. write SMS tool messages. Examples

Logging to file To log everything to file, add new log action: /system logging action add name=file target=disk disk-file-name=log and then make everything log using this new action: /system logging add action=file You can log only errors there by issuing command: /system logging add topics=error action=file This will log into files and . log.0.txt log.1.txt You can specify maximum size of file in lines by specifying . is active file were new logs are going to be appended and once it disk-lines-per-file <file>.0.txt size will reach maximum it will become , and new empty will be created. <file>.1.txt <file>.0.txt You can log into USB flashes or into (on Routerboards) by specifying it's directory name before file name. For example, if you have accessible MicroSD/CF usb flash as directory under , you should issue following command: usb1 /files /system logging action add name=usb target=disk disk-file-name=usb1/log Logging entries from files will be stored back in the memory after reboot.

Syslog with Elasticsearch Introduction Prerequisites Setup Elastic RouterOS Using Kibana Introduction Elasticsearch is a popular NoSQL database that can be used to store a wide range of data, including Syslog data. Alongside with Kibana you can create a powerful tool to analyze Syslog data from your RouterOS devices. This guide will rely on Elasticsearch integrations and for it to work you need to have a working Elasticsearch setup. This guide will not cover setup instructions for Elasticsearch and Kibana, but will cover the relevant steps to setup Syslog data collection and analysis. There are many possible configurations that can be made with Elasticsearch, but for the sake of this guide we will use the following principle: A RouterOS (10.0.0.1) device sends out NetFlow data to a server (10.0.0.2) running Custom UDP logs The server (10.0.0.2) running Custom UDP logs integration ingests Syslog data, processes the data and sends it to a (10.0.0.3) Fleet Server A Fleet Server (10.0.0.3) stores the data in (10.0.0.4) Elasticsearch Kibana (10.0.0.5) retrieves data from Elasticsearch (10.0.0.4), analyzes it and allows you to search the data Prerequisites Setup Elasticsearch Setup kibana Setup Fleet Server Setup The setup instructions are divided into two parts: Elastic (configuration regarding Elasticsearch, Kibana and Fleet Server) and RouterOS (configuration that is relevant to your RouterOS device). This guide will not use as a part of analyzing Syslog data, it has been replaced by a Fleet Server. Logstash It is possible to install Elasticsearch, Kibana, Fleet Server and NetFlow Records integration on the same device. Elasticsearch is widely supported on many platforms. It is recommended to setup a cluster of Elasticsearch nodes. Kibana can be installed on the same device on which you installed Elasticsearch, but it can also be installed on a separate device for performance reasons. While it is possible to analyze Syslog data without Kibana, it requires writing your own API requests, Kibana is very easy to use and has a wide range of features. It is possible to setup Fleet Server on the same device on which you installed Elasticsearch and/or Kibana. It is recommended to install Fleet Server on a different device. Refer to Elasticsearch manual for recommendations on hardware and topology requirements.

1. 2. 3. 4. 5. 6. 7. 8. 9. 10. 11. 12. 13. 14. 15. 16. Elastic Log into your Kibana Open the section under the main menu Fleet Open the " " section Agent policies Press "Create agent policy" button to create a new Agent Policy Give the policy a name, for example, "Syslog policy", adjust advance settings if required, create the policy. Or you can use the API request below: sads POST kbn:/api/fleet/agent_policies { "name": "Syslog policy", "description": "", "namespace": "default", "monitoring_enabled": [ "logs", "metrics" ], "inactivity_timeout": 1209600, "is_protected": false } Open your newly created policy by clicking on it's name Press " " Add integration Search for " " and press "Add Custom UDP logs" Custom UDP logs Adjust configuration, make sure: - Specify "Listen Address" to the IP address of your server that is going to run the Custom UDP logs integration , in this example the address should be "10.0.0.2" - Set "Listen Port" to "5514" - Set" Dataset name" to "routeros" - Set "Ingest Pipeline" to "logs-routeros@custom" - Set "Syslog Parsing" to "Yes" Save the integration Press the " " button Add Elastic Agent to your host Follow the instructions on how to add Elastic Agent to your host Go to "Stack Management" on the main menu, then open " " Ingest Pipelines Create a new Ingest Pipeline by pressing " " then "New pipeline" Create pipeline Set "Name" to "logs-routeros@custom" Press "Import processors" and paste the following processors: [ { "grok": { "field": "message", "patterns": [ "^first L2TP UDP packet received from %{IP:source.ip}$", "^login failure for user %{USERNAME:user.name} from %{IP:source.ip} via %{DATA:service.name}$", "^%{USERNAME:user.name} logged in, %{IP:client.ip} from %{IP:source.ip}$", "^dhcp alert on %{DATA}: discovered unknown dhcp server, mac %{MAC:source.mac}, ip %{IP:source. ip}$", "in:%{DATA} out:%{DATA}, ?(connection-state:%{DATA},|)?(src-mac %{MAC:source.mac},|) proto % {DATA:network.transport} \\(%{DATA}\\), %{IP:source.ip}:?(%{INT:source.port}|)->%{IP:destination.ip}:?(% {INT:destination.port}|), len %{INT:network.bytes}$", "in:%{DATA} out:%{DATA}, ?(connection-state:%{DATA},|)?(src-mac %{MAC:source.mac},|) proto % {DATA:network.transport}, %{IP:source.ip}:?(%{INT:source.port}|)->%{IP:destination.ip}:?(%{INT: destination.port}|), len %{INT:network.bytes}$", "^%{DATA:network.name} (deassigned|assigned) %{IP:client.ip} for %{MAC:client.mac} %{DATA}$", Some steps might change over time, refer to Elastic's manual to find the most up-to-date steps. Official Elastic's manual recommends installing the Elastic Agent as Fleet-managed. Consider following the recommendation since managing the agents is easier when they are Fleet-managed.

16. "^%{DATA:user.name} logged out, %{INT:event.duration} %{INT} %{INT} %{INT} %{INT} from %{IP: client.ip}$", "^user %{DATA:user.name} logged out from %{IP:source.ip} via %{DATA:service.name}$", "^user %{DATA:user.name} logged in from %{IP:source.ip} via %{DATA:service.name}$", "^%{DATA:network.name} client %{MAC:client.mac} declines IP address %{IP:client.ip}$", "^%{DATA:network.name} link up \\(speed %{DATA}\\)$", "^%{DATA:network.name} link down$", "^user %{DATA:user.name} authentication failed$", "^%{DATA:network.name} fcs error on link$", "^phase1 negotiation failed due to time up %{IP:source.ip}\\[%{INT:source.port}\\]<=>%{IP: destination.ip}\\[%{INT:destination.port}\\] %{DATA}:%{DATA}$", "^%{DATA:network.name} (learning|forwarding)$", "^user %{DATA:user.name} is already active$", "^%{GREEDYDATA}$" ] } }, { "lowercase": { "field": "network.transport", "ignore_missing": true } }, { "append": { "field": "event.category", "value": [ "authentication" ], "allow_duplicates": false, "if": "ctx.message =~ /(login failure for user|logged in from|logged in,)/", "ignore_failure": true, "description": "Enrich logon events" } }, { "append": { "field": "event.outcome", "value": [ "success" ], "allow_duplicates": false, "if": "ctx.message =~ /(logged in from|logged in,)/", "ignore_failure": true, "description": "Enrich successful login events" } }, { "append": { "field": "event.outcome", "value": [ "failure" ], "allow_duplicates": false, "if": "ctx.message =~ /(login failure for user)/", "ignore_failure": true, "description": "Enrich failed login events" } }, { "append": { "field": "event.category", "value": [ "network" ], "allow_duplicates": false, "if": "ctx.message =~ /( fcs error on link| link down| link up)/", "ignore_failure": true, "description": "Enrich network events" } },

16. { "append": { "field": "event.outcome", "value": [ "failure" ], "allow_duplicates": false, "if": "ctx.message =~ /( fcs error on link)/", "ignore_failure": true, "description": "Enrich network failures" } }, { "append": { "field": "event.category", "value": [ "session" ], "allow_duplicates": false, "if": "ctx.message =~ /(logged out)/", "ignore_failure": true } }, { "append": { "field": "event.category", "value": [ "threat" ], "allow_duplicates": false, "if": "ctx.message =~ /(from address that has not seen before)/", "ignore_failure": true } }, { "append": { "field": "service.name", "value": [ "l2tp" ], "if": "ctx.message =~ /(^L2TP\\/IPsec VPN)/", "ignore_failure": true } }, { "geoip": { "field": "source.ip", "target_field": "source.geo", "ignore_missing": true, "ignore_failure": true } }, { "geoip": { "field": "destination.ip", "target_field": "destination.geo", "ignore_missing": true, "ignore_failure": true } }, { "geoip": { "field": "client.ip", "target_field": "client.geo", "ignore_missing": true, "ignore_failure": true } } ]

17. 18. 19. 20. 21. 22. Press "Save pipeline" Go to "Stack Management" on the main menu, then select "Index Management" and then select "Component templates" Create a new template by pressing "Create component template". Set the "Name" to "logs-routeros@custom" Under "Index settings" section, paste the following: { "index": { "lifecycle": { "name": "logs" }, "default_pipeline": "logs-routeros@custom" } } Under "Mappings" section, press "Load JSON" and paste the following: { "dynamic_templates": [], "properties": { "service": { "type": "object", "properties": { "name": { "type": "keyword" } } }, "destination": { "type": "object", "properties": { "port": { "type": "long" }, "ip": { "type": "ip" } } }, "host": { "type": "object", "properties": { "ip": { "type": "ip" } } }, "client": { "type": "object", "properties": { "ip": { "type": "ip" }, "mac": { "type": "keyword" } } }, "source": { "type": "object", "properties": { "geo": { "type": "object", "properties": { Change the ILM policy to your required policy name. The "logs" is the default policy that might be in use for other logs.

22. "continent_name": { "ignore_above": 1024, "type": "keyword" }, "region_iso_code": { "ignore_above": 1024, "type": "keyword" }, "city_name": { "ignore_above": 1024, "type": "keyword" }, "country_iso_code": { "ignore_above": 1024, "type": "keyword" }, "country_name": { "ignore_above": 1024, "type": "keyword" }, "location": { "type": "geo_point" }, "region_name": { "ignore_above": 1024, "type": "keyword" } } }, "as": { "type": "object", "properties": { "number": { "type": "long" }, "organization": { "type": "object", "properties": { "name": { "ignore_above": 1024, "type": "keyword", "fields": { "text": { "type": "match_only_text" } } } } } } }, "address": { "ignore_above": 1024, "type": "keyword" }, "port": { "type": "long" }, "domain": { "ignore_above": 1024, "type": "keyword" }, "ip": { "type": "ip" }, "mac": { "type": "keyword" } } }, "event": {

22. 23. 24. 25. 26. 27. 28. 29. 30. 31. "type": "object", "properties": { "duration": { "type": "long" }, "category": { "type": "keyword" }, "outcome": { "type": "keyword" } } }, "message": { "type": "match_only_text" }, "user": { "type": "object", "properties": { "name": { "type": "keyword" } } }, "network": { "type": "object", "properties": { "bytes": { "type": "long" }, "name": { "type": "keyword" }, "transport": { "type": "keyword" } } }, "tags": { "ignore_above": 1024, "type": "keyword" } } } Press "Next" and then press "Save component template" Go to "Stack Management" on the main menu, then select "Index Management" and then select "Index templates" Create a new template by pressing "Create template" Set the "Name" to "logs-routeros" Set "Index patterns" to " logs-routeros-*" Under "Component templates" section add the following templates to your new Index template: logs@settings logs-routeros@custom ecs@mappings Press "Next" and then "Save template" Make sure you have opened the 5514/UDP port on your host and elsewhere in the path from your RouterOS device (10.0.0.1). Your Elastic Agent is now ready to receive Syslog data! RouterOS If a component template exists with such a name, then edit the existing one instead.

1. 2. 3. 4. 1. 2. 3. 4. 5. 6. 7. Configure settings on your RouterOS Device (10.0.0.1): Logging action /system logging action set [find where name="remote"] bsd-syslog=yes remote=10.0.0.2 remote-port=5514 syslog-facility=syslog Add that you wish to receive from RouterOS device (10.0.0.1), for example: Topics /system logging add action=remote topics=info add action=remote topics=error add action=remote topics=critical add action=remote topics=warning add action=remote topics=bridge,stp You should now start to see Syslog data being ingested! Continue the guide to start using Kibana Using Kibana Kibana allows you to search the ingested Syslog data, to see ingested logs do the following: Log into your Kibana Open "Discover" from the main menu Add a filter , use the following parameters: Select a field: data_stream.dataset Select operator: IS Select a value: routeros For simplicity we recommend in the Discover menu and searching for "message", then adding the field to the view searching for fields We also recommend searching for " log.syslog.hostname" field and adding to the view as well. Consider for easier access later saving the search Done! While searching for logs can be useful, you are more likely looking for a way to create for certain activities and create to send alerts connectors alerts e-mail, webhooks, chats and other options. Consider enabling the rule to alert for excessive failed login Spike in failed logon events attempts. You can also create a and set it to alert after fixed amount of failed logins. threshold rule

Netwatch Summary Properties Type-specific options ICMP probe options TCP-CONNECT TCP-CONNECT pass-fail criteria HTTP-GET probe options HTTPS-GET probe options HTTP-GET/HTTPS-GET probe pass/fail criteria DNS probe options Probe statistics/variables Generic: ICMP: TCP: HTTP: HTTPS: DNS: Logs Status Quick Example Summary Netwatch monitors the state of hosts on the network. Monitoring can be done with the following probe types: 1) ICMP - pings to a specified IP address - hosts, with an option to adjust threshold values 2) Simple - uses ping, without use of advanced metrics 3) TCP conn, to test the TCP connection 4) HTTP GET/HTTPS GET, request against a server you are monitoring 5) DNS - sends DNS query to DNS server and checks for response. For each entry in the Netwatch table, you can specify an IP address, ping interval, and console scripts. The main advantage of Netwatch is its ability to issue arbitrary console commands on host state changes. Properties Sub-menu: /tool/netwatch Property Description host (Default:"") The IP address of the server to be probed. Formats: - ipv4 - ipv4@vrf - ipv6 - ipv6@vrf - ipv6-linklocal %interface - domain name (for type=dns) Since 7.4, Netwatch functionality has been expanded, prior versions only support simple ICMP probes. While upgrading to the new version, old Netwatch entries will be unchanged, reporting probe type "simple" - preserving the same functionality. Default Netwatch values are always used - by the user. Make sure to check the "status" page of the probe to see even if they were not defined if the default thresholds are appropriate for your use case. Default threshold values can be found under the "probe options" section on this page.

type (icmp | tcp-conn | http-get | s http-get | dns | Default: ) imple; simpleType of the probe: - - (ping-style) series of ICMP request-response with statistics icmp - - test TCP connection (3-way handshake) to a server specified by IP and port tcp-conn - - do an HTTP Get request and test for a range of correct replies http-get - - do an HTTP Get request and test for a range of correct replies https-get - - do a specified DNS query for domain namedns - simple - simplified ICMP probe, with fewer options than "ICMP" type, used for backward compatibility with the older Netwatch version interval (Default: ) 10s The time interval between probe tests timeout (Default: )3s Max time limit to wait for a response src-address (Default: )"" Source IP address which the Netwatch will try to use in order to reach the host. If address is not present, then the host will be considered as "down". start-delay (Default: ) 3s Time to wait before starting probe (on add, enable, or system start) startup-delay (Default: )5m Time to wait until starting Netwatch probe after system startup up-script (Default:"") Script to execute on the event of probe state change 'fail' --> 'OK' down-script (Default:"") Script to execute on the event of probe state change 'OK' --> 'fail' test-script (Default:"") Script to execute at the end of every probe test Netwatch executes scripts as *sys user, so any defined global variable in the Netwatch script will not be readable by for an example a scheduler or other users It is possible to disable permission checking for RouterOS scripts under menu. This is useful when Netwatch does not have enough /system/scripts permissions to execute a script, though this decreases overall security. It is recommended to assign proper permissions to a script instead. Type-specific options All config options specific to one probe type (e.g. icmp's packet-interval) are ignored for other probe types. ICMP probe options Property Description packet-interval (Default: ) 50ms The time between ICMP-request packet send packet-count (Default: )10 Total count of ICMP packets to send out within a single test packet-size (Default: (IPv4) or (IPv6)) 54 54 The total size of the IP ICMP packet thr-rtt-max (Default ): 1s Fail threshold for rtt-max (a value above thr-max is a probe fail) thr-rtt-avg (Default: ) 100ms Fail threshold for rtt-avg thr-rtt-stdev (Default: ) 250ms Fail threshold for rtt-stdev thr-rtt-jitter (Default: ) 1s Fail threshold for rtt-jitter thr-loss-percent (Default: ) 85.0% Fail threshold for loss-percent thr-loss-count (Default: (max)) 4294967295 Fail threshold for loss-count ttl (Default; )255 Manually set time to live value for ICMP packet accept-icmp-time-exceeded ( | ; Default ) yes no no If the ICMP "time exceeded" message should be considered a valid response Netwatch is limited to script policies. If the owner of the script does not have enough permissions to execute a certain read,write,test,reboot command in the script, then the script will not be executed. If the script has greater policies than - then the script will not read,write,test,reboot be executed as well, make sure your scripts do not exceed the mentioned policies.

TCP-CONNECT Property Description port (Default: )80 TCP port (for both tcp-conn and http-get probes) TCP-CONNECT pass-fail criteria Property Description thr-tcp-conn-time (Default: 0 ) 0:05...00:30Fail threshold for tcp-connect-time, the configuration uses microseconds, if the time unit is not specified (s/m/h), log and status pages display the same value in milliseconds. HTTP-GET probe options Property Description port (Default: )80 TCP port (for both tcp-conn and http-get probes) HTTPS-GET probe options Property Description port (Default: )443 TCP port (for both tcp-conn and http-get probes) certificate (Default:"") Certificate from local store that should be used for host verification. check-certificate ( | ; Default ) yes no no Enables trust chain validation from local certificate store. HTTP-GET/HTTPS-GET probe pass/fail criteria Property Description thr-http-time (Default: )10s Fail threshold for http-resp-time http-code-min (Default: 1 ) 00OK/fail criteria for HTTP response code. accept-icmp-time-exceeded=yes can be used together with a manually set low value to monitor Internet connectivity, without relying ttl on a specific endpoint. For example, you can monitor a public IP address, but that address can filter your ICMP request, or just become unreachable itself, if the Netwatch probe is using this address to monitor Internet connectivity this would cause a false alarm. To make sure you can reach the Internet, it's generally enough to make sure you can reach a device a few routing hops away. Low time to live value will expire in transit to the specified host you want to monitor - each router passing the ICMP packet will subtract "1" from TTL value, upon TTL reaching 0, ICMP "time exceeded" packet will be generated, and sent back to the Netwatch probe. If all other fail thresholds are not broken, this response will be considered a success. Simple, ICMP, HTTP, and TCP-connect probes are sent with the "don't fragment" flag set. With an ICMP probe, you can set , packet-size which in combination with the DF flag, can be used to aid with path MTU discovery

http-code-max (Default: 2 )99Response in the range [ http-code-min , http-code-max ] is a probe pass/OK; outside - a probe fail. See mozilla-http- status or rfc7231 DNS probe options Property Description host (Default:"") DNS name that should be resolved. record-type ( | | | ; Default: AAAAA MX NS A )Record type that will be used for DNS probe. dns-server The DNS server that the probe should send its requests to, if not specified it will use the value from " /ip ".dns Probe statistics/variables You can view statistics and use these variables in scripting, keep in mind that variables containing "-" must be written like this, for example, "done-tests" would be $"done-tests" Generic: Property Description name user added name for the Netwatch entry comment user added comment host host that was probed type probe type interval interval timeout timeout since The last time the status change happened status The current status of probe done-tests total count of probe tests already done so far failed-tests count of failed probe tests ICMP: Property Description sent-count ICMP packets sent out response-count Matching/valid ICMP packet responses received loss-count number of lost packets loss-percent number of lost packets in percent rtt-avg mean value of rtt (packet roundtrip time) rtt-min min rtt rtt-max max rtt

rtt-jitter jitter ( = max - min) of rtt rtt-stdev standard deviation of rtt TCP: Property Description tcp-connect-time time taken to establish a TCP connection HTTP: Property Description http-status-code HTTP response status code (200 OK, 404 Not Found, etc.). See or mozilla-http-status RFC7231 HTTPS: Property Description http-status-code HTTP response status code (200 OK, 404 Not Found, etc.). See or mozilla-http-status RFC7231 DNS: Property Description ip IP address - the result of A record-type probe ip6 IPv6 address - the result of AAAA record-type probe mail-servers Mail servers along with their priority - the result of record-type probeMX name-servers Name servers - the result of record-type probeNS Logs On each probe's OK/fail state change: probe identification info and OK->fail or fail->OK is printed to info level detailed probe stats and config is printed to debug level Status Command will show the current status of Netwatch and properties: /tool/netwatch/print read-only since - Indicates when a state of the host changed last time; status - Shows the current status of the host; host - address being monitored Quick Example Here we will use a simple ICMP check to host with IP 8.8.8.8:

Sub-menu: /tool sniffer Property Description file-limit ( ; Default: integer 10..4294967295[KiB] 10 ) 00KiBFile size limit. Sniffer will stop when a limit is reached. file-name ( ; Default: ) string Name of the file where sniffed packets will be saved. filter-cpu ( ; Default: ) integer CPU core used as a filter. filter-ip-address ( ; ip/mask[,ip/mask] (max 16 items) Default: ) Up to 16 IP addresses used as a filter. filter-dst-ip-address (ip/mask[,ip/mask] (max 16 ; Default: ) items) Up to 16 IP destination addresses used as a filter. filter-src-ip-address (ip/mask[,ip/mask] (max 16 ; Default: ) items) Up to 16 IP source addresses used as a filter. filter-ipv6-address (ipv6/mask[,ipv6/mask] (max 16 ; Default: ) items) Up to 16 IPv6 addresses used as a filter. filter-dst-ipv6-address (ipv6/mask[,ipv6/mask] ; Default: ) (max 16 items) Up to 16 IPv6 destination addresses used as a filter. filter-src-ipv6-address (ipv6/mask[,ipv6/mask] ; Default: ) (max 16 items) Up to 16 IPv6 source addresses used as a filter. filter-mac-address (mac/mask[,mac/mask] (max ; Default: ) 16 items) Up to 16 MAC addresses and MAC address masks used as a filter. filter-dst-mac-address (mac/mask[,mac/mask] ; Default: ) (max 16 items) Up to 16 MAC destination addresses and MAC address masks used as a filter. filter-src-mac-address (mac/mask[,mac/mask] ; Default: ) (max 16 items) Up to 16 MAC source addresses and MAC address masks used as a filter. filter-port ( ; Default: ) [!]port[,port] (max 16 items) Up to 16 comma-separated ports used as a filter. A list of predefined port names is also available, like ssh and telnet. filter-dst-port ( ; Default: ) [!]port[,port] (max 16 items) Up to 16 comma-separated destination ports used as a filter. A list of predefined port names is also available, like ssh and telnet. filter-src-port ( ; Default: ) [!]port[,port] (max 16 items) Up to 16 comma-separated source ports used as a filter. A list of predefined port names is also available, like ssh and telnet. Please note that sniffed packets will be available for 10 minutes, if you need them permanently, set a "file-name" to save them directly or issue a "save" command as described previously.

filter-ip-protocol ([!]protocol[,protocol] (max 16 ; Default: ) items) Up to 16 comma-separated IP/IPv6 protocols used as a filter. IP protocols (instead of protocol names, protocol numbers can be used): ipsec-ah - IPsec AH protocol ipsec-esp - IPsec ESP protocol ddp - datagram delivery protocol egp - exterior gateway protocol ggp - gateway-gateway protocol gre - general routing encapsulation hmp - host monitoring protocol idpr-cmtp - idpr control message transport icmp - internet control message protocol icmpv6 - internet control message protocol v6 igmp - internet group management protocol ipencap - ip encapsulated in ip ipip - ip encapsulation encap - ip encapsulation iso-tp4 - iso transport protocol class 4 ospf - open shortest path first pup - parc universal packet protocol pim - protocol independent multicast rspf - radio shortest path first rdp - reliable datagram protocol st - st datagram mode tcp - transmission control protocol udp - user datagram protocol vmtp - versatile message transport vrrp - virtual router redundancy protocol xns-idp - xerox xns idp xtp - xpress transfer protocol filter-mac-protocol ([!]protocol[,protocol] (max 16 ; Default: ) items) Up to 16 comma separated entries used as a filter. Mac protocols (instead of protocol names, protocol number can be used): 802.2 - 802.2 Frames (0x0004) arp - Address Resolution Protocol (0x0806) capsman - CAPsMAN to CAP MAC layer connection ( ) 0x88BB dot1x - EAPoL IEEE 802.1X ( ) 0x888E homeplug-av - HomePlug AV MME (0x88E1) ip - Internet Protocol version 4 (0x0800) ipv6 - Internet Protocol Version 6 (0x86DD) ipx - Internetwork Packet Exchange (0x8137) lacp - Link Aggregation Control Protocol ( ) 0x8809 lldp - Link Layer Discovery Protocol (0x88CC) loop-protect - Loop Protect Protocol (0x9003) macsec - MAC security IEEE 802.1AE (0x88E5) mpls-multicast - MPLS multicast (0x8848) mpls-unicast - MPLS unicast (0x8847) packing-compr - Encapsulated packets with compressed (0x9001) IP packing packing-simple - Encapsulated packets with simple (0x9000) IP packing pppoe - PPPoE Session Stage (0x8864) pppoe-discovery - PPPoE Discovery Stage (0x8863) rarp - Reverse Address Resolution Protocol (0x8035) romon - Router Management Overlay Network RoMON ( ) 0x88BF service-vlan - Provider Bridging (IEEE 802.1ad) & Shortest Path Bridging IEEE 802.1aq (0x88A8) vlan - VLAN-tagged frame (IEEE 802.1Q) and Shortest Path Bridging IEEE 802.1aq with NNI compatibility (0x8100) filter-stream ( ; Default: ) yes | no yes Sniffed packets that are devised for the sniffer server are ignored. filter-size (integer[-integer]:0..65535 ; Default: ) Filters packets of specified size or size range in bytes. filter-direction ( ; Default: ) any | rx | tx Specifies which direction filtering will be applied.

console Console container combined container usage dhcp DHCP-Server and DHCP-Client services disk storage-related services dns DNS-related services dude The Dude package services e-mail e-mail tool encrypting encrypting processes eoip EoIP ethernet Ethernet-related properties like link speed, auto-negotiation, duplex mode, monitor a transceiver diagnostic information, etc. fetcher Fetch tool firewall Firewall-related processes firewall-mgmt Firewall Management: Filtering, NAT, Mangle flash storage-related services ftp FTP Service gps GPS Service graphing Graphing tool gre GRE health system monitoring, workd health hotspot Hotspot service idle Free CPU resources igmp-proxy IGMP Proxy service internet-detect Detect Internet tool ip-pool IP Pool service ipsec IPsec service: xfrm - set of statistics showing numbers of packets dropped by the transformation code and why. drivers/crypto - drivers that provide access to the hardware cryptographic accelerators. ipsec - processes that relate to the Internet Key Exchange (IKE) protocols, Authentication Header (AH), Encapsulating Security Payload (ESP). kvm KVM virtual machine functionality l7-matcher L7 matcher lcd LCD Interfaces system ldp Label Distribution Protocol (LDP) logging Logging system management different subsystems: scheduler, networking, file management, etc. mpls MPLS-related features neighbour- discoveryNeighbour discovery service networking common set of services included in the networking

ntp NTP service ospf OSPF service ovpn OVPN service pim Protocol Independent Multicast profiling Profiler service queue-mgmt Queues: Simple queues, Queue tree, Queue types queuing Intermediate Queuing radius RADIUS service radv IPv6 radv daemon log messages service remote-access accessing the device directly without logging into RouterOS rip Routing Information Protocol routing Routing-related services serial serial console and terminal tool sniffing packet Sniffer tool snmp SNMP socks Socket Secure spi storage-related services ssh SSH Server ssl SSL supout.rif supout.rif file generation telnet Telnet service tftp TFTP service traffic-accounting Traffic-Flow log system traffic-flow Traffic-Flow system unclassified processes or services that are not defined by this classifier upnp UPnP protocol usb USB features user-manager User Manager service vrrp VRRP web-proxy Web Proxy winbox Winbox wireguard Wireguard wireless common set of services using Wireless systems www Webfig HTTP service zerotier ZeroTier

total-memory ( ) string Amount of installed RAM uptime ( )time Time interval passed since boot-up version ( ) string Installed RouterOS version number write-sect-since-reboot ( ) integer A number of sector writes in HDD or NAND since the router was last time rebooted write-sect-total ( ) integer A number of sector writes in total CPU /system resource cpu This submenu shows per-cpu usage, as long as IRQ and Disk usage. [admin@RB1100test] /system resource cpu> print CPU LOAD IRQ DISK 0 5% 0% 0% [admin@RB1100test] /system resource cpu> Properties Read-only properties Property Description cpu ( ) integer Identification number of CPU which usage is shown. load ( ) percent CPU usage in percents irq ( ) percent IRQ usage in percents disk ( ) percent Disk usage in percents IRQ /system resource irq The menu shows all used IRQs on the router. It is possible to set up on multicore systems by assigning IRQ to a specific core. IRQ IRQ load balancing assignments are done by hardware and cannot be changed from RouterOS. For example, if all Ethernets are assigned to one IRQ, then you have to deal with hardware: upgrade motherboards BIOS, reassign IRQs manually in BIOS, if none of the above helps then change the hardware. Properties Property Description cpu ( ; Default: ) auto | integer Specifies which CPU is assigned to the IRQ. auto - pick CPU based on a number of interrupts. Uses to optimize interrupts. NAPI Read-only properties Property Description active-cpu ( ) integer Shows active CPU in multicore systems.

Properties All properties are read-only Property Description category ( ) string PCI device type, for example, ethernet controller device ( ) string device-id ()hex Hexadecimal device ID io ( ) hex-hex I/O memory range irq ( ) integer IRQ assigned to the device memory ( ) hex-hex Memory range name ( ) string Descriptive name of the device retrieved from the driver vendor ( ) string Device manufacturer's name. vendor-id ()hex Hexadecimal vendor ID

SNMP Overview Quick Configuration General Properties Community Properties Properties Management information base (MIB) Object identifiers (OID) Traps SNMP write System Identity Reboot Run Script Running scripts with GET Overview Simple Network Management Protocol (SNMP) is an Internet-standard protocol for managing devices on IP networks. SNMP can be used to graph various data with tools such as CACTI, MRTG, or The Dude. SNMP write support is only available for some OIDs. For supported OIDs SNMP v1, v2 or v3 write is supported. Quick Configuration To enable SNMP in RouterOS: SNMP will respond to the query on the interface SNMP request was received from forcing responses to have same source address as request destination sent to the router SNMP tool collects data from different services running on the system. If, for some reason, communication between SNMP and some service is taking longer time than expected (30 seconds per service, 5 minutes for routing service), you will see a warning in the log stating "timeout while waiting for program" or "SNMP did not get OID data within expected time, ignoring OID". After that, this service will deny SNMP requests for a while before even trying to get requested data again. This error has nothing to do with SNMP service itself. In most cases, such an error is printed when some slow or busy service is monitored through SNMP, and quite often, it is a service that should not be monitored through SNMP, and proper solution in such cases is to skip such OIDs on your monitoring tool.

/system identity set identity=New_Identity Reboot It's possible to reboot the router with SNMP set command, you need to set the value for reboot SNMP settings, which is not equal to 0. $ snmpset -c public -v 1 192.168.0.0 1.3.6.1.4.1.14988.1.1.7.1.0 s 1 1.3.6.1.4.1.14988.1.1.7.1.0 , SNMP value for the router reboot; s 1, snmpset command to set value, value should not be equal to 0; Reboot SNMPset command is equal to the RouterOS command: /system reboot Run Script SNMP write allows running scripts on the router from the menu when you need to set value for the SNMP setting of the script. system script $ snmpset -c public -v 1 192.168.0.0 1.3.6.1.4.1.14988.1.1.8.1.1.3.X s 1 X, script number, numeration starts from 1; s 1, snmpset command to set value, the value should not be equal to 0; The same command on RouterOS: /system script> print Flags: I - invalid 0 name="test" owner="admin" policy=ftp,reboot,read,write,policy, test,winbox,password,sniff last-started=jan/01/1970 01:31:57 run-count=23 source=:beep /system script run 0 Running scripts with GET It is possible to run via SNMP GET request of the script OID (since 6.37). For this to work SNMP community with write permission is /system scripts required. OIDs for scripts can be retrieved via the SNMPWALK command as the table is dynamic. Add script: /system script add name=script1 owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=" /sy reboot " add name=script2 owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="[: put output]" Get the script OID table $ snmpwalk -v2c -cpublic 192.168.88.1 1.3.6.1.4.1.14988.1.1.8 iso.3.6.1.4.1.14988.1.1.8.1.1.2.1 = STRING: "script1" iso.3.6.1.4.1.14988.1.1.8.1.1.2.2 = STRING: "script2" iso.3.6.1.4.1.14988.1.1.8.1.1.3.1 = INTEGER: 0 iso.3.6.1.4.1.14988.1.1.8.1.1.3.2 = INTEGER: 0

To run the script use table 18 $ snmpget -v2c -cpublic 192.168.88.1 1.3.6.1.4.1.14988.1.1.18.1.1.2.2 iso.3.6.1.4.1.14988.1.1.18.1.1.2.2 = STRING: "output"

) UDP receive ) UDP send

Recommended S+RJ10 placement It is not recommended to place transceivers side by side Devices that come with 4 or 8-block SFP+ cages are not exceptions. It is recommended to use one S+RJ10 transceiver per 4xSFP+ cage block and avoid placing them side by side. Keep at least one vertical row empty(without S+RJ10) after plugging the S+RJ10 transceiver. Recommended S+RJ10 placement We do not recommend to place transceivers side by side Using the S+RJ10 Side by Side or with passive cooling devices There might be situations when it is not possible to use the recommended layout of the transceivers. In such cases where two or more S+RJ10 transceivers are plugged in beside one another or modules are used in passive cooling devices, the network administrator has to ensure additional cooling. The airflow around the device should be increased or the overall ambient temperature should be lowered to keep the temperature of the transceivers within the recommended range.

In the following example: /ip/traffic-flow/set packet-sampling=yes sampling-interval=2222 sampling-space=1111 2222 packet consecutive packets will be sampled and then 1111 will be omitted. Then the sampling cycle repeats in such a manner. Targets Sub-menu: /ip traffic-flow target With Traffic-Flow targets we specify those hosts which will gather the Traffic-Flow information from the router. Property Description src-address (IP ; Default: ) IP address used as source when sending Traffic-Flow statistics dst- address (; Default: )IP IP address of the host which receives Traffic-Flow statistic packets from the router. Port (Port; Default:2055) Port (UDP) of the host which receives Traffic-Flow statistic packets from the router. v9-template-refresh ( ; Default: ) integer 20 Number of packets after which the template is sent to the receiving host (only for NetFlow version 9 and IPFIX) v9-template-timeout ( ; Default: )time After how long to send the template, if it has not been sent. (only for NetFlow version 9 and IPFIX) version ( ; Default: ) 1 | 5 | 9 | IPFIX Which version format of NetFlow to use IPFIX Sub-menu: /ip traffic-flow ipfix Allows to customize flow records Property Description bytes Total number of bytes processed in the flow. ip-total-lenght Length of the IP packet in bytes. src-address The source IP address of the flow. dst-address The destination IP address of the flow. ipv6-flow-label Label field from an IPv6 header, used to classify flows. src-address-mask Network mask for the source address, useful in summarizing data. dst-address-mask Network mask for the destination address. is-multicast Indicates whether the flow is a multicast flow. src-mac-address Source MAC address. dst-mac-address Destination MAC address. last-forwarded Timestamp of the last packet forwarded in a flow. info Packet sampling is available in RouterOS v7.

src-port Source port number. dst-port Destination port number. nat-dst-address Translated destination IP address by NAT. sys-init-time System initialization time, can be used for timing analysis. first-forwarded Timestamp of the first packet forwarded in a flow. nat-dst-port Translated destination port number by NAT. tcp-ack-num Acknowledgment number in a TCP connection. gateway IP address of the gateway through which the flow was routed. nat-events Events related to Network Address Translation for the flow. tcp-flags Flags from the TCP header (e.g., SYN, ACK). icmp-code ICMP code for error messaging and operational information. nat-src-address Translated source IP address by NAT. icmp-type Type of ICMP message, important for diagnostic messages. nat-src-port Translated source port number by NAT. tcp-seq-num Sequence number in a TCP connection. tcp-window-size Window size in a TCP connection, indicating the scale of received data buffering. igmp-type Type of Internet Group Management Protocol operation. out-interface Interface through which packets of the flow are sent out. in-interface Interface through which packets of the flow are received. packets Number of packets processed in the flow. ip-header-length Length of the IP header. protocol Protocol number (e.g., TCP, UDP, ICMP). tos Type of Service field in the IP header, indicating priority and handling of the packet. ttl Time To Live for the packet, decremented by each router to prevent infinite loops. udp-length Length of the UDP payload. Notes By looking at the you can see that traffic flow is at the end of the input, forward, and output chain stack. It means that traffic flow will packet flow diagram count only traffic that reaches one of those chains. For example, you set up a mirror port on a switch, connect the mirror port to a router, and set traffic flow to count mirrored packets. Unfortunately, such a setup will not work, because mirrored packets are dropped before they reach the input chain. Other interfaces will appear in the report if traffic is passing through them and the monitoring interface. Examples This example shows how to configure Traffic-Flow on a router Enable Traffic-Flow on the router:

NetFlow analysis with Elasticsearch Introduction Prerequisites Setup Elastic RouterOS Using Kibana Log retation Use a different ILM policy Introduction Elasticsearch is a popular NoSQL database that can be used to store a wide range of data, including NetFlow logs. Alongside with Kibana you can create a powerful tool to analyze NetFlow data from your RouterOS devices. This guide will rely on Elasticsearch integrations and for it to work you need to have a working Elasticsearch setup. This guide will not cover setup instructions for Elasticsearch and Kibana, but will cover the relevant steps to setup NetFlow log collection and analysis. There are many possible configurations that can be made with Elasticsearch, but for the sake of this guide we will use the following principle: A RouterOS (10.0.0.1) device sends out NetFlow data to a server (10.0.0.2) running NetFlow integration The server (10.0.0.2) running NetFlow integration ingests NetFlow data, processes the data and sends it to a (10.0.0.3) Fleet Server A Fleet Server (10.0.0.3) stores the data in (10.0.0.4) Elasticsearch Kibana (10.0.0.5) retrieves data from Elasticsearch (10.0.0.4), analyzes it and allows you to search the data Prerequisites Setup Elasticsearch Setup kibana This guide will not use as a part of analyzing NetFlow data, it has been replaced by a Fleet Server. Logstash It is possible to install Elasticsearch, Kibana, Fleet Server and NetFlow Records integration on the same device. Elasticsearch is widely supported on many platforms. It is recommended to setup a cluster of Elasticsearch nodes.

1. 2. 3. 4. 5. 6. 7. 8. 9. 10. 11. 12. 13. 14. 1. 2. Setup Fleet Server Setup The setup instructions are divided into two parts: Elastic (configuration regarding Elasticsearch, Kibana and Fleet Server) and RouterOS (configuration that is relevant to your RouterOS device). Elastic Log into your Kibana Open the section under the main menu Fleet Open the " " section Agent policies Press "Create agent policy" button to create a new Agent Policy Give the policy a name, for example, "NetFlow policy", adjust advance settings if required, create the policy Open your newly created policy by clicking on it's name Press " " Add integration Search for " " and press "Add NetFlow Records" NetfFlow Records Adjust configuration, make sure: - Specify "UDP host to listen on" to the IP address of your server that is going to run the NetFlow Records integration , in this example the address should be "10.0.0.2" Save the integration Press the " " button Add Elastic Agent to your host Follow the instructions on how to add Elastic Agent to your host Make sure you have opened the NetFlow port on your host and elsewhere in the path from your RouterOS device (10.0.0.1), the default destination port is 2055/UDP. Your Elastic Agent is now ready to receive NetFlow data! RouterOS (optional) Create an (for example, "NetFlow_interfaces") and add interface that need NetFlow data analysis Interface list /interface list add name=NetFlow_interfaces /interface list member add interface=VLAN3000 list=NetFlow_interfaces Configure to send NetFlow data to your Elastic Agent (10.0.0.2) Traffic-flow Kibana can be installed on the same device on which you installed Elasticsearch, but it can also be installed on a separate device for performance reasons. While it is possible to analyze NetFlow data without Kibana, it requires writing your own API requests, Kibana is very easy to use and has a wide range of features. It is possible to setup Fleet Server on the same device on which you installed Elasticsearch and/or Kibana. It is recommended to install Fleet Server on a different device. Refer to Elasticsearch manual for recommendations on hardware and topology requirements. Some steps might change over time, refer to Elastic's manual to find the most up-to-date steps. Official Elastic's manual recommends installing the Elastic Agent as Fleet-managed. Consider following the recommendation since managing the agents is easier when they are Fleet-managed.

2. 3. 4. 1. 2. 3. /ip traffic-flow enabled=yes interfaces=NetFlow_interfaces /ip traffic-flow target add dst-address=10.0.0.2 You should now start to see NetFlow data being ingested! Continue the guide to start using Kibana Using Kibana The NetFlow Records integration provides some useful assets that can be used to analyze NetFlow data. Make sure you first before install the assets continuing. The following section will give you some basic ways how to see NetFlow data. Log into your Kibana Open the " " menu in the main menu Dashboards Search the Dashboards and find "NetFlow" You should now see multiple NetFlow Dashboards. For example, try opening the " [Logs Netflow] Overview". If your NetFlow data is properly ingested, then you should now see graphs that summarizes your traffic. Another useful Dashboard is the " [Logs Netflow] Flow records", which shows you exact NetFlow records. A very useful feature is the filtering option (the + button on top), that allows you add filters to NetFlow data, for example, you can filter the records to show only a single IP address: There are other options such as searching for a specific time range. You should read more about to understand the possibilities better. Discover For quick reference, these are the fields that you are most likely going to want to use for searching NEtFlow data: source.ip source.port destination.ip destination.port network.transport If you want to examine a single record, it is recommended to use the view. NetFlow data can be found as "data_stream.dataset: netflow.log". Discover Log retation Depending on your local laws you might be required to store NetFlow data for a specified period of time. Be aware that busy networks can generated a lot of NetFlow data, even terabytes per day. You are most likely going to want to adjust . By default the NetFlow data should go under the LIfecycle Policy "logs" policy. If you have multiple Elasticsearch nodes, you can utilize " ", which allows you to store data on different types of storage media, but if phases you only have a single Elasticsearch node, your options are limited and you will most likely want to old data. For example, if you want to delete data delete after 6 months, then you can simply change the ILM policy to delete data after 6 months or use this API request: Some steps might change over time, refer to Elastic's manual to find the most up-to-date steps.

1. PUT _ilm/policy/logs { "policy": { "phases": { "hot": { "min_age": "0ms", "actions": { "rollover": { "max_age": "30d", "max_primary_shard_size": "50gb" }, "set_priority": { "priority": 101 } } }, "delete": { "min_age": "180d", "actions": { "delete": { "delete_searchable_snapshot": true } } } } } } Use a different ILM policy If you want your NetFlow data to have a different retention period, then you need to do the following steps: Create a new ILM policy, give it a new name and set the desired period for the delete phase, or use this API request: PUT _ilm/policy/netflow-logs { "policy": { "phases": { "hot": { "min_age": "0ms", "actions": { "rollover": { "max_age": "30d", "max_primary_shard_size": "50gb" }, "set_priority": { "priority": 101 } } }, "delete": { "min_age": "1000d", "actions": { "delete": { "delete_searchable_snapshot": true } } } } } } If you change the "logs" policy, this will apply to ALL your logs, not just NetFlow data. If you need a different retention period for other logs, then it is better to create a new ILM policy and specify the NetFlow integration to use the newly created ILM policy.

2. 3. 4. 5. 6. Goto Kibana, open "Stack Management", then go to "Index Management" and then "Component Templates" Search for "logs-netflow.log@custom", open it and edit it Go to the "Index settings" section Paste in the following: { "index": { "lifecycle": { "name": "netflow-logs" } } } Press "Next" and then "Save component template"

Traffic Generator Summary General Packet Template Port Configuration Stats Latency Distribution Stream Stats Port Stats Raw Stats Streams Configuration Examples IPsec tunnel performance test Summary Traffic Generator is a tool that allows evaluating the performance of DUT (Device Under Test) or SUT (System Under Test). The tool can generate and send RAW packets over specific ports. It also collects latency and jitter values, TX/RX rates, counts lost packets, and detects Out-of-Order (OOO) packets. Traffic Generator can be used similar to tool as well as generate packets that will be routed back to packet generator for advanced status bandwidth test collection. General /tool traffic-generator This menu allows to set general traffic generator properties and contains commands to quickly start and stop the tool. Properties Property Description latency-distribution- max ( ; Default: time 10 )0usMaximal latency range for latency distribution measurements. Based on this value, RouterOS will decide what latency range to use as the latency-distribution-measure-interval property measure-out-of-order ( ; Default: ) yes | noWhether to measure Out-of-Order packets. The default value is based on CPU type (multi-core CPU default ; single-core no CPU default ). When the property is enabled on the multi-core device, a single stream will utilize only a single CPU coreyes stats-samples-to-keep ( ; Default: ) integer 100How many data examples to collect test-id (integer [0..255] ; Default: )0 Read-Only Properties In a device, which generates packets, it will not be possible to capture packets generated by the traffic-generator with a sniffer tool, torch, or firewall on the outgoing interface. Since this tool could be used maliciously, it is possible to lock this functionality by entering the command '/system device-mode update traffic- gen=no' and holding the reset button afterwards.

Property Description latency-distribution-samples ( ) integer Shows how many individual time periods the latency-distribution-measure-interval is divided into latency-distribution-measure-interval ( )time Shows total latency measurement range running ( ) yes | no Shows whether the traffic generator tool is started. Commands Property Description quick () This command allows to quickly start the packet generator and print the stats output to the terminal. Command also accepts several parameters that override settings in packet template and stream settings. Accepted parameters are duration, entries-to-show, freeze-frame- interval, id, interface, mbps, measure-out-of-order, packet-count, packet-size, port, pps, stream, test-id, tx-template tx-template - packet templates to generate traffic (max 16 templates) duration - how long to run the test entries-to-show - how many status lines print to the terminal freeze-frame-interval - how often to update the status to the terminal The rest of the parameters are not command-specific and are described elsewhere. Parameters specified when running quick command override configured values. In case if a parameter is specified only for one header then the value is multiplied for all the other headers (if required). start () Commands start the traffic generator tool in the background. It accepts one parameter test-id stop () Command stops the started traffic generator tool by command.start inject () Inject raw data into the interface. inject- pcap ()Inject raw data directly from pcap file. Packet Template /tool traffic-generator packet-template This sub-menu allows building packets based on provided parameters. Based on parameters you can build IP packets with VLAN tags and set UDP ports. A raw packet template is generated based on provided parameters. If you require more low-level packets or take full advantage of the traffic generator, then please use a raw-packet-template builder to build the packet. If the same type of header is present in the packet more than once then header field values are passed as a comma-separated list. (For example, if there are two IP headers then source addresses are given like "IP-src=1.1.1.1,2.2.2.2"). For quicker header construction many of the header field values are assumed. For example, if the header stack is "mac, IP" then the traffic generator can assume that the mac-protocol value is "IP". Or if the "port" or "interface" setting is specified traffic generator can assume "mac-src" to be the MAC address of the interface). Assumed values have distinct names that start with "assumed-" and are read-only. Manually specified values override assumed ones. Properties Property Description comment ( ; Default: ) string Short description of the packet you are building. Assumed values are not automatically updated. New values are assumed after template edit. "packet-template set 0" is enough to trigger new assumed values

compute-checksum-from- offset (no-checksum | ; integer[0..4294967295] Default: )specifies the byte offset from where in the packet 2-byte checksum will be calculated (Example: set to 14, to skip packets Ethernet header when calculating checksum) data (incrementing | random | specific-byte | ; Default: uninitialized uninitia )lizedSpecifies how packet payload will be filled: uninitialized - packets data (after the header) is uninitialized, but not zero. Fastest. specific-byte - works together with setting data-byte incrementing - packets data filled with "00 01 02 03" and so on random - packets data filled with random bytes. Slowest. data-byte ( ; hex [0..FF]] Default: )0A byte will be used to fill the packet payload. interface ( ; Default: ) string Optional parameter of packet template. This is mutually exclusive with the "port" setting. Specifying "interface" allows users not to create a port entry for interface in the port menu. In fact, a port entry is created dynamically. This is useful for running quick tests. ip-dscp (list of integer[0.. ; 255] (max 16 times) Default: )Single or list of DS Fields that will be set in IP header (DS Field contains DSCP value and the ECN value) ip-dst (list of IP/Netmask ; Default: ) (max 16 times)List of destination IP addresses that will be used when generating IP headers. ip-frag-off (list of integer[0.. ; 65535] (max 16 times) Default: )List of fragmentation offsets in IP header. ip-gateway (; Default: )IP In situations when sender and receiver are the same devices, it is impossible to determine next-hop automatically from ip- . If ip-gateway is specified packet template will assume the destination mac address based on resolved ip-gateway.dst ip-id (list of integer [0.. ; Default: ) 65535] ip-protocol (list of IP ; protocols (max 16 times) Default: ) ip-src (list of IP/Mask (max ; Default: ) 16 times) ip-ttl (list of integer [0..255] ; Default: ) (max 16 times) mac-dst (list of MAC/MASK ; Default: ) (max 16 times) mac-protocol (list of mac ; protocols (max 16 times) Default: ) mac-src (list of MAC/MASK ; Default: ) (max 16 times) name ( ; Default: ) string Descriptive name of the template. port ( ; Default: ) string Optional parameter of packet template. This suggests a port through which packets generated using this template should be sent out. Port can also be specified in other places such as in stream settings. This is mutually exclusive with interface setting. raw-header (string (max 16 ; Default: ) times)Raw packet header as string in hexadecimal format. udp-dst-port (list of port [0.. 65535]/mask [0..FFFF] ; Default: ) (max 16 times)

udp-src-port (list of port [0.. 65535]/mask [0..FFFF] ; Default: ) (max 16 times) vlan-id (; Default: ) vlan-priority (; Default: ) vlan-protocol (; Default: ) header-stack (list of ip | mac | raw | udp | vlan (max ; Default: ) 16 times) ipA sequence of headers that a generated packet should have. Currently supports: mac - Ethernet header (14 bytes) vlan - Ethernet VLAN tag (4 bytes) ip - IPv4 header (20 bytes) udp - UDP header (8 bytes) raw - arbitrary bytes specified as a hex string Most header types can be present in the header multiple times. There can be only 2 IP headers and 1 UDP header per packet. Some limitations are imposed on possible sequences of headers based on our practical experience with network protocols (for example VLAN header can follow only a mac header or other VLAN header). The traffic generator suggests the first header for a packet template (in the port menu). But it is not enforced. Port Configuration /tool traffic-generator port This menu allows configuring ports that will be associated with a specific interface and will be used to receive/send generated packets. Properties Property Description disabled ( ; Default: ) yes | no no Whether the port is disabled and does not participate in receiving/sending the packets name ( ; Default: ) string Descriptive name of the port interface ( ; Default: ) string Name of the interface associated with the port. Read-Only Properties Property Description dynamic ( ) yes | no Whether the port configuration is generated automatically. first-header (ip | mac | raw | ) udp | vlanShows suggested the first header for packets to be sent out of the specified interface. This information can be used when creating packet templates. inactive ( ) yes | no Whether the port is inactive and can't participate in tx/rx of the packets. Stats /tool traffic-generator stats If the traffic generator is not running in mode then all statistics about the test is stored in this menu. quick

Latency Distribution /tool traffic-generator stats latency-distribution This sub-menu shows how many packets are received in a specific latency range. Latency range can be viewed by streams or by sequences (for example, , ) print stream-num=3 print seq=10 Here is an example output of the latency graph:

[admin@test-host] /tool traffic-generator stats latency-distribution> print # LATENCY COUNT SHARE GRAPH 0 0-15.5us 0 0% 1 15.5us-31us 0 0% 2 31us-46.5us 0 0% 3 46.5us-62.1us 0 0% 4 62.1us-77.6us 0 0% 5 77.6us-93.1us 0 0% 6 93.1us-109us 0 0% 7 109us-124us 0 0% 8 124us-140us 0 0% 9 140us-155us 0 0% 10 155us-171us 0 0% 11 171us-186us 4 0% * 12 186us-202us 29 0% * 13 202us-217us 90 0.001% * 14 217us-233us 302 0.004% * 15 233us-248us 630 0.009% * 16 248us-264us 789 0.011% * 17 264us-279us 1 384 0.021% -* 18 279us-295us 1 990 0.03% --* 19 295us-310us 2 966 0.045% ---* 20 310us-326us 4 089 0.062% -----* 21 326us-341us 4 958 0.075% ------* 22 341us-357us 6 059 0.091% -------* 23 357us-372us 6 660 0.101% --------* 24 372us-388us 8 320 0.126% ----------* 25 388us-403us 9 988 0.151% -------------* 26 403us-419us 11 781 0.178% ---------------* 27 419us-434us 12 512 0.189% ----------------* 28 434us-450us 13 836 0.21% -----------------* 29 450us-465us 15 681 0.238% --------------------* 30 465us-481us 17 740 0.269% ----------------------* 31 481us-496us 19 913 0.302% --------------------------* 32 496us-512us 21 106 0.32% ---------------------------* 33 512us-528us 22 848 0.346% -----------------------------* 34 528us-543us 25 059 0.38% --------------------------------* 35 543us-559us 26 593 0.403% ----------------------------------* 36 559us-574us 27 663 0.419% -----------------------------------* 37 574us-590us 29 351 0.445% -------------------------------------* 38 590us-605us 31 265 0.474% ----------------------------------------* 39 605us-621us 33 224 0.504% -------------------------------------------* 40 621us-636us 34 464 0.523% --------------------------------------------* 41 636us-652us 35 630 0.54% ----------------------------------------------* 42 652us-667us 37 245 0.565% ------------------------------------------------* 43 667us-683us 38 158 0.579% -------------------------------------------------* 44 683us-698us 38 626 0.586% --------------------------------------------------* 45 698us-714us 38 985 0.591% --------------------------------------------------* 46 714us-729us 39 061 0.592% --------------------------------------------------* 47 729us-745us 39 750 0.603% ---------------------------------------------------* 48 745us-760us 39 145 0.594% --------------------------------------------------* 49 760us-776us 39 162 0.594% --------------------------------------------------* 50 776us-791us 38 197 0.579% -------------------------------------------------* 51 791us-807us 37 811 0.573% -------------------------------------------------* 52 807us-822us 37 364 0.567% ------------------------------------------------* 53 822us-838us 36 770 0.558% -----------------------------------------------* 54 838us-853us 35 831 0.543% ----------------------------------------------* 55 853us-869us 35 380 0.536% ----------------------------------------------* 56 869us-884us 34 472 0.523% --------------------------------------------* 57 884us-900us 33 672 0.511% -------------------------------------------* 58 900us-915us 33 799 0.513% --------------------------------------------* 59 915us-931us 32 754 0.497% ------------------------------------------* 60 931us-946us 32 339 0.49% ------------------------------------------* 61 946us-962us 32 419 0.492% ------------------------------------------* 62 962us-977us 32 107 0.487% -----------------------------------------* 63 977us-993us 31 552 0.478% -----------------------------------------* 64 0-993us 1 221 523 18.54%

Properties Property Description count (inte )gerNumber of packets in the current latency range graph (stri )nggraphical representation of share latency (st )ringlatency range share (per )centPercentage of packets falling in this latency range. Stream Stats /tool traffic-generator stats stream This sub-menu stores statistics sorted by streams. Output is the same as in mode. quick [admin@test-host] /tool traffic-generator stats stream> print # SEQ NUM TX-PACKET TX-RATE RX-PACKET RX-RATE LOST-PACKET LOST-RATE 0 1 3 43 064 499.5Mbps 25 180 292.0Mbps 17 884 207.4Mbps 1 1 4 43 062 499.5Mbps 39 946 463.3Mbps 3 116 36.1Mbps 2 1 TOT 86 126 999.0Mbps 65 126 755.4Mbps 21 000 243.6Mbps 3 2 3 43 544 505.1Mbps 30 449 353.2Mbps 13 095 151.9Mbps 4 2 4 43 543 505.0Mbps 42 982 498.5Mbps 561 6.5Mbps 5 2 TOT 87 087 1010.2... 73 431 851.7Mbps 13 656 158.4Mbps ... 59 20 TOT 87 277 1012.4... 73 755 855.5Mbps 13 522 156.8Mbps 60 21 3 43 546 505.1Mbps 30 605 355.0Mbps 12 941 150.1Mbps 61 21 4 43 546 505.1Mbps 42 682 495.1Mbps 864 10.0Mbps 62 21 TOT 87 092 1010.2... 73 287 850.1Mbps 13 805 160.1Mbps 63 TOT 3 913 942 504.8Mbps 629 210 347.5Mbps 284 732 157.2Mbps 64 TOT 4 913 939 504.8Mbps 898 374 496.2Mbps 15 565 8.5Mbps 65 TOT TOT 1 827 881 1009.6... 1 527 584 843.8Mbps 300 297 165.8Mbps Port Stats /tool traffic-generator stats port This sub-menu stores statistics sorted by rx/tx ports. [admin@test-host] /tool traffic-generator stats port> print # SEQ PORT RX-UNK-PACKET RX-UNK-BYTE RX-UNK... TX-PACKET TX-RATE RX-PACKET 0 1 port0:et... 0 0 0bps 43 064 499.5Mbps 39 946 1 1 port1:et... 0 0 0bps 43 062 499.5Mbps 25 180 2 1 TOT 0 0 0bps 86 126 999.0Mbps 65 126 3 2 port0:et... 0 0 0bps 43 544 505.1Mbps 42 982 4 2 port1:et... 0 0 0bps 43 543 505.0Mbps 30 449 5 2 TOT 0 0 0bps 87 087 1010.2... 73 431 6 3 port0:et... 0 0 0bps 43 540 505.0Mbps 42 615 7 3 port1:et... 0 0 0bps 43 540 505.0Mbps 30 191 8 3 TOT 0 0 0bps 87 080 1010.1... 72 806

Raw Stats /tool traffic-generator stats raw This sub-menu stores raw statistics data. [admin@test-host] /tool traffic-generator stats raw> print # SEQ PORT NUM TX-PACKET TX-RATE RX-PACKET RX-RATE LOST-PACKET LOST-RATE 0 1 port0:e... 3 43 064 499.5Mbps 0 0bps 43 064 499.5Mbps 1 1 port1:e... 3 0 0bps 25 180 292.0Mbps -25 180 292.0Mbps 2 1 TOT 3 43 064 499.5Mbps 25 180 292.0Mbps 17 884 207.4Mbps 3 1 port0:e... 4 0 0bps 39 946 463.3Mbps -39 946 463.3Mbps 4 1 port1:e... 4 43 062 499.5Mbps 0 0bps 43 062 499.5Mbps 5 1 TOT 4 43 062 499.5Mbps 39 946 463.3Mbps 3 116 36.1Mbps 6 1 port0:e... TOT 43 064 499.5Mbps 39 946 463.3Mbps 3 118 36.1Mbps 7 1 port1:e... TOT 43 062 499.5Mbps 25 180 292.0Mbps 17 882 207.4Mbps 8 2 port0:e... 3 43 544 505.1Mbps 0 0bps 43 544 505.1Mbps 9 2 port1:e... 3 0 0bps 30 449 353.2Mbps -30 449 353.2Mbps 10 2 TOT 3 43 544 505.1Mbps 30 449 353.2Mbps 13 095 151.9Mbps Streams Properties Property Description disabled ( ; Default: ) yes | no no Whether the stream is disabled mbps ( ; Default: ) integer [0..4294967295] 0 Value in Megabits per second that stream will try to generate. name ( ; Default: ) string Descriptive name of the stream. num ( ; Default: ) integer [0..15] 0 packet-size ( ; integer[1..65535] [-integer[1..65535]] Default: )0Generated the size of the packets in bytes. Can be set as the range for random packet size generation. port ( ; Default: ) string Name of the port from the Port menu that will be used to transmit packets. pps ( ; Default: ) integer [0..4294967295] 0 Packets per second that stream will try to generate. tx-template ( ; Default: ) string Name of the packet template from packet-template or raw-packet-template menus used as the packet content source. Configuration Examples IPsec tunnel performance test Consider following test setup

System Under Test (SUT) consists of two routers connected to a traffic generator server. The connection between both SUT routers is IPSec encrypted. The traffic generator will run two streams: in a direction from 1.1.1.0/24 network to 2.2.2.0/24 network in a direction from 2.2.2.0/24 network to 1.1.1.0/24 network. R1 routing and IPsec setup /ip address add address=192.168.33.1/30 interface=ether1 add address=1.1.1.2/24 interface=ether2 /ip route add dst-address=2.2.2.0/24 gateway=192.168.33.2 /ip ipsec proposal set default enc-algorithms=aes-128 /ip ipsec peer add address=192.168.33.2 secret=123 /ip ipsec policy add sa-src-address=192.168.33.1 sa-dst-address=192.168.33.2 \ src-address=1.1.1.0/24 dst-address=2.2.2.0/24 tunnel=yes R2 routing and IPsec setup

/ip address add address=192.168.33.2/30 interface=ether1 add address=2.2.2.2/24 interface=ether2 /ip route add dst-address=1.1.1.0/24 gateway=192.168.33.1 /ip ipsec proposal set default enc-algorithms=aes-128 /ip ipsec peer add address=192.168.33.1 secret=123 /ip ipsec policy add sa-src-address=192.168.33.2 sa-dst-address=192.168.33.1 \ src-address=2.2.2.0/24 dst-address=1.1.1.0/24 tunnel=yes Traffic generator server setup /ip address add address=1.1.1.1/24 interface=ether2 add address=2.2.2.1/24 interface=ether3 First, we will define which ports will be used as traffic generator tx/rx ports /tool traffic-generator port add disabled=no interface=ether2 name=port0 add disabled=no interface=ether3 name=port1 To construct the actual packet that will be generated, packet-template is used. /tool traffic-generator packet-template add header-stack=mac,ip,udp ip-dst=2.2.2.1/32 ip-gateway=1.1.1.2 ip-src=1.1.1.1/32 \ name=routing-1 port=port0 add header-stack=mac,ip,udp ip-dst=1.1.1.1/25 ip-gateway=2.2.2.2 ip-src=2.2.2.1/32 \ name=routing-2 port=port1 Notice that mac addresses were not specified since the template generator can assume the next-hop mac address automatically by sending ARP messages. Since we are doing routing and destination IP is not directly reachable, we have set parameter to determine the next-hop mac- the ip-gateway address. When running you can see all assumed (detected) values including mac addresses.print [admin@test-host] /tool traffic-generator packet-template> print 0 name="routing-1" header-stack=mac,ip,udp port=port0 assumed-mac-dst=00:0C:42:00:38:9D assumed-mac-src=00:0C:42:40:94:25 assumed-mac-protocol=ip assumed-ip-dscp=0 assumed-ip-id=0 assumed-ip-frag-off=0 assumed-ip-ttl=64 assumed-ip-protocol=udp ip-src=1.1.1.1/32 ip-dst=2.2.2.1/32 assumed-udp-src-port=100 assumed-udp-dst-port=200 ip-gateway=1.1.1.2 data=uninitialized data-byte=0 1 name="routing-2" header-stack=mac,ip,udp port=port1 assumed-mac-dst=00:0C:42:00:38:D1 assumed-mac-src=00:0C:42:40:94:26 assumed-mac-protocol=ip assumed-ip-dscp=0 assumed-ip-id=0 assumed-ip-frag-off=0 assumed-ip-ttl=64 assumed-ip-protocol=udp ip-src=2.2.2.1/32 ip-dst=1.1.1.1/32 assumed-udp-src-port=100 assumed-udp-dst-port=200 ip-gateway=2.2.2.2 data=uninitialized data-byte=0 For example, if any router in SUT were to change, assumed mac-addresses would not be updated automatically. To update packet templates simply issue command:

/tool traffic-generator packet-template set [find] The last part is to configure streams /tool traffic-generator stream add disabled=no mbps=500 name=str1 id=3 packet-size=1450 port=port0 pps=0 \ tx-template=routing-1 add disabled=no mbps=500 name=str3 id=4 packet-size=1450 port=port1 pps=0 \ tx-template=routing-2 Notice that each stream has a unique value. This value identifies stream packets, otherwise, the traffic generator will not work.id Now we are ready to run the test. In this case, mode will be used: quick [admin@test-host] /tool traffic-generator> quick mbps=450 SEQ NUM TX-PACKET TX-RATE RX-PACKET RX-RATE RX-OOO LOST-PACKET LOST-RATE 37 4 39 488 458.0Mbps 39 270 455.5Mbps 15 509 218 2.5Mbps 37 TOT 78 976 916.1Mbps 76 485 887.2Mbps 22 529 2 491 28.8Mbps 38 3 38 957 451.9Mbps 37 657 436.8Mbps 7 078 1 300 15.0Mbps 38 4 38 958 451.9Mbps 38 402 445.4Mbps 14 763 556 6.4Mbps 38 TOT 77 915 903.8Mbps 76 059 882.2Mbps 21 841 1 856 21.5Mbps 39 3 38 816 450.2Mbps 37 893 439.5Mbps 7 307 923 10.7Mbps 39 4 38 815 450.2Mbps 38 642 448.2Mbps 15 110 173 2.0Mbps 39 TOT 77 631 900.5Mbps 76 535 887.8Mbps 22 417 1 096 12.7Mbps 40 3 39 779 461.4Mbps 37 415 434.0Mbps 7 136 2 364 27.4Mbps 40 4 39 780 461.4Mbps 39 567 458.9Mbps 15 908 213 2.4Mbps 40 TOT 79 559 922.8Mbps 76 982 892.9Mbps 23 044 2 577 29.8Mbps 41 3 39 218 454.9Mbps 37 089 430.2Mbps 7 075 2 129 24.6Mbps 41 4 39 218 454.9Mbps 38 663 448.4Mbps 15 752 555 6.4Mbps 41 TOT 78 436 909.8Mbps 75 752 878.7Mbps 22 827 2 684 31.1Mbps 42 3 39 188 454.5Mbps 37 906 439.7Mbps 6 729 1 282 14.8Mbps 42 4 39 187 454.5Mbps 38 954 451.8Mbps 15 565 233 2.7Mbps 42 TOT 78 375 909.1Mbps 76 860 891.5Mbps 22 294 1 515 17.5Mbps TOT 3 1 645 468 454.4Mbps 1 568 201 433.1Mbps 280 174 77 267 21.3Mbps TOT 4 1 645 464 454.4Mbps 1 626 896 449.3Mbps 627 480 18 568 5.1Mbps TOT TOT 3 290 932 908.9Mbps 3 195 097 882.4Mbps 907 654 95 835 26.4Mbps Stats show throughput of each stream and total throughput of both streams, Out-of-order packet count, Lost rate, latency, and jitter.

Watchdog Summary Properties Quick Example Summary Sub-menu: /system watchdog This menu allows the configuring system to reboot, when a specific IP address does not respond, or when it detects, that the software has locked up. The detection is done in two ways: Software watchdog timer (mostly caused by hardware malfunction) device can recover itself with a reboot; Ping watchdog can monitor connectivity to a specific IP address and trigger the reboot function. Properties Property Description auto-send-supout (yes ; Default: ) | no noAfter the support output file is automatically generated, it can be sent by email. automatic-supout (yes ; Default: ) | no yesWhen software failure happens, a file named "autosupout.rif" is generated automatically. The previous "autosupout.rif" file is renamed to "autosupout.old.rif". no-ping-delay ( ; time Default: 5m)Specifies how long will it wait before trying to reach the watch-address. ping-timeout ( ; time Default: 60s)Specifies the time interval in which the device will be pinged 6 times (after "no-ping-delay"). send-email-from (string ; Default: )The e-mail address to send the support output file from. If not set, the value set in /tool e-mail is used. send-email-to ( ; string Default: )The e-mail address to send the support output file to. send-smtp-server (string ; Default: )SMTP server address to send the support output file through. If not set, the value set in /tool e-mail is used. watch-address (; IP Default: )The system will reboot, in case 6 sequential pings to the given IP address will fail. If set to none this feature is disabled. By default, the router will reboot every 6 minutes if the watch-address is set and not reachable. watchdog-timer (yes | ; Default: ) no yesWhether to reboot if a system is unresponsive for a minute. Quick Example To make system generate a support output file and sent it automatically to support@example.com through the 192.0.2.1in case of a software crash: Note: These are two different Watchdog features and both have their own settings. By default software Watchdog is enabled and ping Watchdog is disabled. You can enable ping Watchdog by specifying an IP address and you can disable the software Watchdog by unsetting the Watchdog Timer option. Note: Watchdog reboot is not a system failure. Such reboot also will not generate autosupout file. Watchdog reboot is "/system reboot" automatically triggered by operating system when some service is not responding as fast as it should. Reasons for that can vary between damaged hardware, slow software implementation for some service, DDoS attack, bad configuration and others.

Extended features In This Section:

Tap "Create new" Provide your router credentials Connection established Allow VPN to be added Sharing the BTH connection with another phone user It is possible to create Guest tunnels for your friends and family. You can even specify if you want these people to access your local network as well, or if they should be restricted to only use the internet via your router. Once you create shared tunnels, you can send Invitation links via any chat application in your phone, or show a QR code to your friend in person (in both these cases, the friend will have to also install the BTH app). If you want to connect to your router via the WireGuard(TM) app from another phone or from a computer, it is possible as well. Just select the share WireGuard(TM) config file, and open this file in the WireGuard(TM) app. Manage shares Connect to your tunnel first Once connected, Create shares Provide a name and access levelShare sheet opens To share your tunnel with somebody: As the owner, connect to your BTH tunnel

1. 2. Click the "..." icon next to your tunnel and click "Manage shares" Enter the administration password for the router, since you will be modifying the router config Tap "Create" in the Shares manager Enter your friends name in the "Tunnel name", since a new tunnel will be made for them Specify expiry date of this new Guest tunnel Specify if the user will need to access your intenal network of your home. Do not check this if they only want to use this tunnel for internet access Once "Create tunnel" has been pressed, phone Share Sheet opens. Select method how to send the invite link Once the other person clicks on this link, he will either be directed to install the BTH app, or the BTH app will open and will allow to set up this new Guest tunnel in their phone Sharing the BTH tunnel with a computer via the WireGuard(TM) app Since there is no BTH app for PCs, you can use to connect to the shared tunnel. You can even share your connection with yourself, WireGuard(TM) app by "inviting" your computer to connect. Let's make a new share, this time for yourself, for using from the PC. Create Specify name and access level You have two shares now Click "..." to send invite Pick "Share WireGuard config file" Install the WireGuard app in your computer and click "Import Tunnel from file" Configuring BTH manually in RouterOS (optional, if no smartphone is available to you) Connect to router Important notice It is important to note, . Simply use the BTH app (see above section) to NOTHING has to be configured in RouterOS to use Back to Home enable it. The whole point of Back to Home is to avoid using Winbox or command line. Below instructions are only for debugging or seasoned administrators.

vpn-private-key ( ) read-only: string Private key for BTH vpn-public-key ( ) read-only: string Public key for BTH vpn-peer-private-key ( ) read-only: string Peer private key vpn-peer-public-key ( ) read-only: string Peer public key vpn-prefer-relay-code ( ) string; You can enter relay code that will be preferred for BTH connection, if not set, relay with smallest RTT will be chosen. vpn-interface ( ) read-only: string Name of the created interface for Back to Home WireGuard tunnel.® vpn-wireguard-client-config (read-only: ) stringConfiguration that can be entered in your preferred WireGuard® client. Only one client at a time will be available to use this config. vpn-wireguard-client-config-qrcode (read- )onlyScannable QR Code for your preferred WireGuard® client. Only one client at a time will be available to use this config. Back to Home users Sub-menu: /ip/cloud/back-to-home-users/ Since RouterOS 7.14 there is a new back to home specific user manager available in the menu where you can see /ip/cloud/back-to-home-users> all the users that are added by the Back to Home mobile app, change their firewall preference and also add new ones. [boss@mikrotik-ax] /ip/cloud/back-to-home-users> print detail Flags: X - disabled; A - active 0 A name="user1" slot=3 expires=never client-address=192.168.216.3/32,fc00:0:0:216::3/128 allow-lan=no private-key="OHqR2BZXJp0N6//3JzzoJhBJVb0rrSxV0dxQL/2UdXY=" public-key=" Na7oEq9XLdeK8ouCUX+tC4FIM51vEnZ7mLiFqG9xiUQ=" [boss@mikrotik-ax] /ip/cloud/back-to-home-users> When adding users in this menu, you can view their Wireguard config and QR code with this command /interface/wireguard/peers/show- client-config user1 Allow-lan=no will add the users into a firewall address list, that only allows internet access, but blocks the user from accessing your internal network. Note that expiry date can't be changed, once a user has been added. Property Description name ( ) string Informative name of BTH user expires (string; never | date: "YYYY-MM-DD HH:MM:SS"; Default: never )Expiration time and date for user, cannot be changed once user is created client-addresss (string: IPv4 | IPv6) Client address, if not specified one will be made automatically allow-lan (string: yes | no; Default: )no Will add the user into a firewall address list, that only allows internet access, but blocks the user from accessing your internal network private-key (string;) Private key for user, if not set manually, it will be generated by the system public-key (string;) Public key for user, if not set manually, it will be generated by the system When using vpn-wireguard-client-config or vpn-wireguard-client-config-qrcode, both options are equal, you only need to import one of these into your WireGuard client device.

/container Properties Property Description cmd (string; Default: )The main purpose of a CMD is to provide defaults for an executing container. These defaults can include an executable, or they can omit the executable, in which case you must specify an ENTRYPOINT instruction as well. comment ( ; string Default: )Short description dns (string; Default: ) domain-name (str ing; Default: ) entrypoint ( string; Default: )An ENTRYPOINT allows to specify executable to run when starting container. Example: /bin/sh envlist ( ; string Default: )list of environmental variables (configured under ) to be used with container /container envs file (string; ) Default: container *tar.gz tarball if the container is imported from a file hostname (string; ) Default: interface (string; ) Default: veth interface to be used with the container logging (string; ) Default: if set to yes, all container-generated output will be shown in the RouterOS log mounts (string; ) Default: mounts from /container/mounts/ sub-menu to be used with this container remote-image (str ) ing; Default: the container image name to be installed if an external registry is used (configured under /container/config set registry-url=...) root-dir (string; ) Default: used to save container store outside main memory stop-signal (string ) ; Default: External disk is highly recommended Container package needs to be installed For devices with EN7562CT CPU, only container images are supported. arm32v5

a. b. c. workdir ( ; string Default: )the working directory for cmd entrypoint Container configuration /container/config/ Property Description registry-url external registry url from where the container will be downloaded tmpdir container extraction directory ram-high RAM usage limit. ( 0 for unlimited) username Specifies the username for authentication ( starting from ROS 7.8) password Specifies the password for authentication ( starting from ROS 7.8) Container use example Prerequisites: RouterOS device with RouterOS v7.4beta or later and installed Container package Physical access to a device to enable container mode Attached hard drive or USB drive for storage - formatted as ext3/ext4 Enable Container mode enable container mode /system/device-mode/update container=yes You will need to confirm the device-mode with a press of the reset button, or a cold reboot, if using container on X86. Create network Add veth interface for the container: /interface/veth/add name=veth1 address=172.17.0.2/24 gateway=172.17.0.1 Create a bridge for containers and add veth to it: /interface/bridge/add name=containers /ip/address/add address=172.17.0.1/24 interface=containers /interface/bridge/port add bridge=containers interface=veth1 Setup NAT for outgoing traffic: Device-mode limits container use by default, before granting container mode access - make sure your device is fully secured.

/ip/firewall/nat/add chain=srcnat action=masquerade src-address=172.17.0.0/24 Add environment variables and mounts (optional) Create environment variables for container(optional): /container/envs/add name=pihole_envs key=TZ value="Europe/Riga" /container/envs/add name=pihole_envs key=WEBPASSWORD value="mysecurepassword" /container/envs/add name=pihole_envs key=DNSMASQ_USER value="root" Define mounts (optional): /container/mounts/add name=etc_pihole src=disk1/etc dst=/etc/pihole /container/mounts/add name=dnsmasq_pihole src=disk1/etc-dnsmasq.d dst=/etc/dnsmasq.d Add container image If You wish to see container output in log - add when creating a container, root-dir should point to an external drive formatted in ext3 or logging=yes ext4. It's not recommended to use internal storage for containers. There are multiple ways to add containers: a) get an image from an external library Set registry-url (for downloading containers from Docker registry) and set extract directory (tmpdir) to attached USB media: /container/config/set registry-url=https://registry-1.docker.io tmpdir=disk1/pull pull image: /container/add remote-image=pihole/pihole:latest interface=veth1 root-dir=disk1/pihole mounts=dnsmasq_pihole, etc_pihole envlist=pihole_envs The image will be automatically pulled and extracted to root-dir, status can be checked by using /container/print b) import image from PC These links are as of latest 16th of June, 2022 . Please make sure to download the right version that matches Your RouterOS device's architecture. Update sha256 sum from docker hub to get the latest image files src= points to RouterOS location (could also be if, for example, You decide to put configuration files on external src=disk1/etc_pihole USB media), points to defined location (consult containers manual/wiki/github for information on where to point). If directory does not dst= src exist on first time use then it will be populated with whatever container have in location.dst

arm64: docker pull pihole/pihole:latest@sha256:4cef8a7b32d318ba218c080a3673b56f396d2e2c74d375bef537ff5e41fc4638 docker save pihole/pihole > pihole.tar arm docker pull pihole/pihole:latest@sha256:684c59c7c057b2829d19d08179265c79a9ddabf03145c1e2fad2fae3d9c36a94 docker save pihole/pihole > pihole.tar amd64 docker pull pihole/pihole:latest@sha256:f56885979dcffeb902d2ca51828c92118199222ffb8f6644505e7881e11eeb85 docker save pihole/pihole > pihole.tar After the file has been downloaded and extracted - upload it to Your RouterOS device. Create a container from tar image /container/add file=pihole.tar interface=veth1 envlist=pihole_envs root-dir=disk1/pihole mounts=dnsmasq_pihole, etc_pihole hostname=PiHole c) build an image on PC Steps for Linux systems To use Dockerfile and make your own docker package - docker needs to be installed as well as buildx or other builder toolkit. Easiest way is to download and install Docker Engine: https://docs.docker.com/engine/install/ After install check if extra architectures are available: docker buildx ls should return: NAME/NODE DRIVER/ENDPOINT STATUS PLATFORMS default * docker default default running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux /386, linux/arm/v7, linux/arm/v6 If not - install extra architectures: docker run --privileged --rm tonistiigi/binfmt --install all pull or create your project with Dockerfile included and build, extract image (adjust --platform if needed): git clone https://github.com/pi-hole/docker-pi-hole.git cd docker-pi-hole docker buildx build --no-cache --platform arm64 --output=type=docker -t pihole . docker save pihole > pihole.tar Upload to Your RouterOS device. pihole.tar Images and objects on the Linux system can be pruned Create a container from the tar image /container/add file=pihole.tar interface=veth1 envlist=pihole_envs mounts=dnsmasq_pihole,etc_pihole hostname=PiHole

Start container Make sure container has been added and by using status=stopped /container/print /container/start 0 You should be able to access the PiHole web panel by navigating to in your web browser. http://172.17.0.2/admin/ Forward ports to internal container Ports can be forwarded using dst-nat (where 192.168.88.1 routers IP address): /ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.88.1 dst-port=80 protocol=tcp to-addresses=172.17.0.2 to- ports=80 For Pihole container - set DNS server to containers veth interface IP address - /ip dns set servers=172.17.0.2 or change DHCP servers settings to serve Pihole DNS Tips and tricks Containers use up a lot of disk space, USB/SATA,NVMe attached media is highly recommended. For devices with USB ports - USB to SATA adapters can be used with 2.5" drives - for extra storage and faster file operations. RAM usage can be limited by using: /container/config/set ram-high=200M this will soft limit RAM usage - if a RAM usage goes over the high boundary, the processes of the cgroup are throttled and put under heavy reclaim pressure. For starting containers after router reboot use start-on-boot option (starting from 7.6beta6) /container/print 0 name="2e679415-2edd-4300-8fab-a779ec267058" tag="test_arm64:latest" os="linux" arch="arm" interface=veth2 root-dir=disk1/alpine mounts="" dns="" logging=yes start-on-boot=yes status=running /container/set 0 start-on-boot=yes It is possible to get to container shell: running /container/shell 0 Enable logging to get output from container: /container/set 0 logging=yes Starting from 7.11beta5 version multiple addresses and ipv6 addresses can be added:

interface/veth add address=172.17.0.3/16,fd8d:5ad2:24:2::2/64 gateway=172.17.0.1 gateway6=fd8d:5ad2:24: 2::1

Container - freeradius server Introduction Summary Configuration Container mode Networking Getting image Starting the container Altering the server's configuration files Result verification Introduction The introduction of the container feature into the RouterOS made it possible to run all kinds of servers for all sorts of tasks inside the router. This is especially relevant for people, who want to reduce the number of devices in their network. Instead of running a server on a separate device/machine, why not run it inside the router? Radius is short for Remote Authentication Dial-In User Service. RouterOS has a RADIUS client feature supported that can authenticate for HotSpot, , PPP P , , , and ISDN connections. Basically, this feature allows you to connect RouterOS to a Radius Server, and then, utilize the user database PPoE PPTP L2TP from the server for client authentication. In our example, we will showcase image installation. freeradius/freeradius-server Summary Sub-menu: /container : note container package is required. Make sure to study our guide before proceeding with the configuration. Make sure to check the and sections to container disclaimer requirements understand all the risks and necessary steps you might be required to do. At the time, when the guide was published, the image was available for linux/ OS/architecture . Meaning, you are not able to run this scenario amd64 only on our arm32-bit and arm64-bit architecture RouterOS devices. For arm64, arm you will need to make your own container from . FreeRADIUS source You can only run it on Cloud Hosted Router, CHR , or x86 installation. To help you set up a CHR in a , please check our , or . Virtual Box youtube tutorial Make your own x86 router Configuration Container mode Enable container mode: /system/device-mode/update container=yes You will need to confirm the device-mode with a cold reboot if using the container on X86. Networking Add veth interface for the container: This guide demonstrates a basic example! The tests were performed in a local environment! This guide is meant for basic RADIUS "testing" purposes! Not all "freeradius" features were tested!

/interface/veth/add name=veth3 address=172.17.0.2/24 gateway=172.17.0.1 Create a bridge for the container, assign an IP network to it, and add veth to the bridge: /interface/bridge/add name=dockerfreeradius /ip/address/add address=172.17.0.1/24 interface=dockerfreeradius /interface/bridge/port add bridge=dockerfreeradius interface=veth3 Setup NAT for outgoing traffic if required: /ip/firewall/nat/add chain=srcnat action=masquerade src-address=172.17.0.0/24 Getting image To simplify the configuration, we will get the image from an external library but you can also import it via the file..tar Make sure that you have "Registry URL" set accordingly, limit RAM usage (if necessary), and set up a directory for the image: /container/config/set registry-url=https://registry-1.docker.io tmpdir=pull Pull image with the help of the command: /container/add remote-image=freeradius/freeradius-server:latest interface=veth3 root-dir=freeradius logging=yes cmd="-X" where enables debug logging (per the "freeradius" documentation). cmd="-X" After running the command, RouterOS should start "extracting" the package. Check "File System" for newly created folders and monitor container status with the command . /container/print Starting the container After you make sure that the container has been added and the status changed to after using → you can initiate it: status=stopped /container/print /container/start 0 Altering the server's configuration files To access the server's configuration files ( and ), we will need to use SFTP (file transfer over SSH) protocol, so make sure that SSH clients.conf authorize se is enabled. rvice Open your command terminal ("CMD", as Administrator, for Windows users, or "Linux Shell or Command Terminal" for Linux users) and navigate it to the directory where you want to download the configuration files. For example, to "radius" folder on your "Desktop": C:\WINDOWS\system32>cd C:\Users\Administrator\Desktop\radius C:\Users\Administrator\Desktop\radius> Initiate SFTP to the device's IP address:

C:\Users\DenissPC\Desktop\radius>sftp admin@10.55.8.53 admin@10.55.8.53's password: Connected to 10.55.8.53. sftp> Go to the server's configuration file folder (use or command to see the content of the folder you are in and command to go to the folder of our dir ls cd choice). The first file, "clients.conf" allows you to define RADIUS clients. Per the "freeradius" documentation, it should be under the "/etc/freeradius" directory...so, navigate there and use command to download it:get sftp> dir freeradius pub pull skins sftp> cd freeradius/etc/freeradius sftp> dir README.rst certs clients.conf dictionary experimental.conf hints huntgroups mods-available mods-config mods-enabled panic.gdb policy. d proxy.conf radiusd.conf sites-available sites-enabled templates.conf trigger. conf users sftp> get clients.conf Fetching /freeradius/etc/freeradius/clients.conf to clients.conf /freeradius/etc/freeradius/clients.conf 100% 8323 1.2MB/s 00:00 Open " " via your preferred text editor (notepad or any other). You can study the file to see all the options that you have (additionally, check clients.conf freer ). This example shows a basic setup, so, we will just overwrite the whole file with the lines shown below: adius.org client new { ipaddr = 0.0.0.0/0 secret = client_password } where we indicate, that our radius client can connect using any possible IP address ( ensures that, but you also can change it to the actual ipaddr=0.0.0.0/0 ip address/mask of your radius client if you require to do so) and that our secret is "client_password" (you can change it to any other secret). Save the file/overwrite it. The second file, "authorize" allows you to set up users. Per the "freeradius" documentation, it should be under "/etc/freeradius/mods-config/files". Go there and the file:get sftp> dir freeradius pub pull skins sftp> cd freeradius/etc/freeradius/mods-config/files sftp> dir accounting authorize dhcp pre-proxy sftp> get authorize Fetching /freeradius/etc/freeradius/mods-config/files/authorize to authorize /freeradius/etc/freeradius/mods-config/files/authorize 100% 6594 1.1MB/s 00:00 Open " " via your preferred text editor (notepad or any other). This example shows a basic setup, so, we will just uncomment (remove the "#" authorize symbol from) the line shown below (leave the rest of the configuration/lines as they are): bob Cleartext-Password := "hello"

Container - HomeAssistant Introduction Summary Container configuration Container mode Networking Environment variables and mounts Getting image Starting the container Home-Assistant setup Resources Introduction The introduction of the container feature into the RouterOS made it possible to run all kinds of servers for all sorts of tasks inside the router. This is especially relevant for people, who want to reduce the number of devices in their network. Instead of running a server on a separate device/machine, why not run it inside the router? In this guide, we will showcase how to install and host server on RouterOS. Home-Assistant Home-Assistant is a very popular platform that is used to collect statistics from different sensors and supports different . integrations Summary Make sure to study our guide before proceeding with the configuration. Make sure to check the and sections to container disclaimer requirements understand all the risks and necessary steps you might be required to do. You can find supported architectures by following the .link At the time, when the guide was published, image was available for ARM32, ARM64, and AMD64 (CHR and x86) devices. home-assistant Based on the information from their , recommended minimal requirements are:site 2 GB RAM 32 GB Storage Recommended does not mean set in stone, and we will be running this on that has 512 MB RAM and a USB slot for the required storage. It is L009UiGS advised using recommended hardware specifications, but for testing, and low amounts of data, you can get by with 512+ MB RAM. Container configuration Sub-menu: /container : note container package is required. Container mode Enable container mode: /system/device-mode/update container=yes You will need to confirm the device-mode with a press of the reset button, or a cold reboot, if using container on X86. Networking Add veth interface:

/interface/veth/add name=veth2 address=172.19.0.2/24 gateway=172.19.0.1 Create a bridge for both containers and add veth interfaces to it: /interface/bridge/add name=ha /ip/address/add address=172.19.0.1/24 interface=ha /interface/bridge/port add bridge=ha interface=veth2 Forward TCP 8123 for home-assistant management (where 192.168.88.1 is the device's LAN IP address) if NAT is required (optional): /ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.88.1 dst-port=8123 protocol=tcp to- addresses=172.19.0.2 to-ports=8123 Environment variables and mounts Per the home-assist documentation, define mounts for the configuration files (where, is our external USB storage folder):/usb1 /container mounts add dst=/config name=ha_config src=/usb1/ha_config Create an environmental variable for home-assistant: /container envs add key=TZ name=ha_env value=America/Los_Angeles Getting image To simplify the configuration, we will get the images from an external library. Make sure that you have "Registry URL" set accordingly, limit RAM usage (if necessary), and set up a directory for the images: /container/config/set registry-url=https://registry-1.docker.io tmpdir=/usb1/pull Pull home-assistant image and wait for it to be extracted: /container/add remote-image=homeassistant/home-assistant:latest interface=veth2 root-dir=/usb1/ha mounts=ha_config envlist=ha_env logging=yes After running the command, RouterOS should start "extracting" the package. Check "File System" for newly created folders and monitor container status with the command . /container/print Starting the container After you make sure that the container has been added and the status changed to after using → you can initiate it: status=stopped /container/print /container/start 0 Home-Assistant setup Open your preferred web browser and access the Home-Assistant management portal by specifying management port ":8123":

Proceed with the setup. More information is explained in the . Home-Assistant onboarding guide Resources Just running the on L009 (without any load/traffic) takes up ~300 MB of RAM: Home Assistant /system resource print uptime: 4m27s version: 7.13.3 (stable) build-time: Jan/24/2024 13:16:46 factory-software: 7.10 free-memory: 143.0MiB total-memory: 448.0MiB cpu: ARM With the load, it will increase, but for testing, on this specific board, it should be enough.

Container - mosquitto MQTT server Introduction Summary Container configuration Container mode Networking Environment variables and mounts Getting image Setting up mosquitto configuration file Starting the container MQTT publish and subscribe SSL MQTT Server configuration Testing the connection Introduction The introduction of the container feature into the RouterOS made it possible to run all kinds of servers for all sorts of tasks inside the router. This is especially relevant for people, who want to reduce the number of devices in their network. Instead of running a server on a separate device/machine, why not run it inside the router? In this guide, we will showcase how to install a basic MQTT broker (or in other words, server) called . MQTT protocol is a very popular eclipse-mosquitto choice, especially in IoT topologies. It is an open OASIS and ISO standard lightweight, publish-subscribe network protocol that transports messages between devices. A typical topology consists of an MQTT publisher (a device that sends information), an MQTT broker (a server where the data is stored), and an MQTT subscriber (a device that listens to the data published on the server). RouterOS supports feature, and, now, we can also run the MQTT broker as well. MQTT publish, subscribe The image that we are going to use, can be found by following the hub.docker .link Summary Make sure to study our guide before proceeding with the configuration. Make sure to check the and sections to container disclaimer requirements understand all the risks and necessary steps you might be required to do. You can find supported architectures by following the .link At the time, when the guide was published, image was available for ARM32, ARM64, and AMD64 (CHR and x86) devices. In this eclipse-mosquitto example, we will run it on an ARM32 architecture device → . RB1100AHx4 Container configuration Sub-menu: /container : note container package is required. Container mode Enable container mode: A very basic and configuration will be shown. Make sure to check page for more information about additional quick mosquitto documentation options and settings you can implement. If you want to use it for production, please in any way possible: make sure to harden the security Firewall , so that access to the container is allowed only from your trusted IP addresses; Increasing security from the mosquitto broker/server-side → use strong passwords, non-standard ports ...etc; Use SSL MQTT.

/system/device-mode/update container=yes You will need to confirm the device-mode with a press of the reset button, or a cold reboot, if using container on X86. Networking Add veth interface for the container: /interface/veth/add name=veth2 address=172.19.0.2/24 gateway=172.19.0.1 Create a bridge for containers and add veth to it: /interface/bridge/add name=msqt /ip/address/add address=172.19.0.1/24 interface=msqt /interface/bridge/port add bridge=msqt interface=veth2 Forward TCP 1883 for non-SSL MQTT (where 192.168.88.1 is the device's LAN IP address) for testing purposes if NAT is required (optional): /ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.88.1 dst-port=1883 protocol=tcp to- addresses=172.19.0.2 to-ports=1883 Environment variables and mounts Per the eclipse-mosquitto docker hub, define a mount for the configuration file. We will mount not just the configuration file, but the whole folder, because, for SSL MQTT, we will need to upload certificates into the folder as well: /container mounts add src=/mosquitto_mounted dst=/mosquitto/config name=msqt_config Getting image To simplify the configuration, we will get the image from an external library but you can also import it via the file..tar In this example, we will use the device's own storage. RB1100AHx4 has 128 MB disk space and a basic mosquitto installation should not take up more than ~15 MB. Make sure that you have "Registry URL" set accordingly, limit RAM usage (if necessary), and set up a directory for the image: /container/config/set registry-url=https://registry-1.docker.io tmpdir=pull Pull image: /container/add remote-image=eclipse-mosquitto:latest interface=veth2 root-dir=mosquitto mounts=msqt_config logging=yes After running the command, RouterOS should start "extracting" the package. Check "File System" for newly created folders and monitor container status with the command . /container/print Setting up mosquitto configuration file To get the file, we will need to use SFTP (file transfer over SSH) protocol, so make sure that SSH is enabled. You can also use FTP. mosquttio.conf service Open your command terminal ("CMD", as Administrator, for Windows users, or "Linux Shell or Command Terminal" for Linux users) and navigate it to the directory where you want to download the configuration file. For example, to the "Container" folder on your "Desktop":

C:\WINDOWS\system32>cd C:\Users\Administrator\Desktop\Container C:\Users\Administrator\Desktop\Container> Initiate SFTP to the device's IP address: C:\Users\Administrator\Desktop\Container>sftp admin@192.168.88.1 The authenticity of host '192.168.88.1 (192.168.88.1)' can't be established. RSA key fingerprint is SHA256:lfxxs+xMrXlvP7hiHi9ZAEZlPi6/c5US+r6J7ljhkaA. Are you sure you want to continue connecting (yes/no/[fingerprint])?yes Warning: Permanently added '192.168.88.1' (RSA) to the list of known hosts. Connected to 192.168.88.1. sftp> Go to the mosquitto configuration file folder (use or command to see the content of the folder you are in and command to go to the folder of our dir ls cd choice). By default, the configuration is loaded from the "/mosquitto/config/mosquitto.conf", so, navigate there and use command to download it:get sftp> cd mosquitto/mosquitto/config sftp> dir mosquitto.conf sftp> get mosquitto.conf Fetching /mosquitto/mosquitto/config/mosquitto.conf to mosquitto.conf /mosquitto/mosquitto/config/mosquitto.conf Open " " via your preferred text editor (notepad or any other), and just overwrite it with two lines shown below: mosquitto.conf listener 1883 allow_anonymous true The first line, , will make the installation listen for incoming network connection on the specified port. listener 1883 The second line, , determines whether clients that connect without providing a username are allowed to connect. allow_anonymous true Overwrite the file using the same name. mosquitto.conf After you have created your own custom configuration file, upload it into the mounted directory/folder " ". If you have not run the mosquitto_mounted container yet, you will not have the " " folder and you can create it manually. If you did run it ( ), it should have mosquitto_mounted /container start 0 been created automatically: sftp> dir mosquitto mosquitto_mounted pub pull skins Use SFTP from the directory where the edited mosquitto.conf file is located and it into the mounted directory:put In this section, we will configure a basic non-SSL MQTT setup for testing purposes. Non-SSL MQTT is not secure for a production environment unless you are certain the required security/restrictions are in place. For a production environment, topologies where the MQTT traffic can be captured/sniffed and/or topologies where the MQTT traffic is routed directly via the internet (not locally), use SSL MQTT. Check the for more information. SSL MQTT section

/iot/mqtt/publish broker="mosquitto" topic="test/topic" message="{\"test\":\"123\"}" Check subscriptions for received messages: /iot/mqtt/subscriptions/recv/print 0 broker=mosquitto topic="test/topic" data="{"test":"123"}" time=2023-07-12 10:01:40 You can also check the container logs (if enabled), to confirm the mosquitto is operational: 12:47:28 container,info,debug 1675421248: New connection from 172.19.0.1:42240 on port 1883. 12:47:28 container,info,debug 1675421248: New client connected from 172.19.0.1:42240 as MTD8580EC793C4 (p2, c1, k60, u'test'). 12:47:38 container,info,debug 1675421258: Client MTD8580EC793C4 disconnected. SSL MQTT Using for a production environment . One can easily the packet exchange between the broker and the publisher non-SSL MQTT is not secure capture/sniff and, as a result, will be able to obtain user credentials and other sensitive information. To increase security, use SSL MQTT. The first step is to generate the certificates. In this example, we will use a simple Root CA scenario (with no device/client certificate requirement). Use the official for the step-by-step. mosquitto-tls user guide Server configuration You should have generated ca.crt (Certificate Authority file), server.crt (server certificate) and server.key (server's key): C:\Users\Administrator\Desktop\Container>dir Directory of C:\Users\Administrator\Desktop\Container 07/12/2023 10:58 AM <DIR> . 07/12/2023 10:58 AM <DIR> .. 07/12/2023 10:56 AM 1,322 ca.crt 07/12/2023 10:56 AM 1,854 ca.key 07/12/2023 09:57 AM 35 mosquitto.conf 07/12/2023 10:58 AM 1,164 server.crt 07/12/2023 10:57 AM 960 server.csr 07/12/2023 10:56 AM 1,704 server.key 6 File(s) 7,039 bytes 2 Dir(s) 52,401,184,768 bytes free Open mounted " " via your preferred text editor (notepad or any other), and just overwrite it with the lines shown below: mosquitto.conf tls_version tlsv1.2 port 8883 allow_anonymous true cafile /mosquitto/config/ca.crt keyfile /mosquitto/config/server.key certfile /mosquitto/config/server.crt tls_version line sets minimal TLS version; listener 8883 , will make the installation listen for incoming network connection on the specified port; allow_anonymous true , determines whether clients that connect without providing a username are allowed to connect;

Import the certificate: /certificate/import file-name=ca.crt passphrase="" Add MQTT broker for SSL connection: /iot/mqtt/brokers/add name=mosquittoSSL username=test address=172.19.0.2 port=8883 ssl=yes Subscribe to the MQTT broker and the required topic: /iot/mqtt/subscribe broker=mosquittoSSL topic=test/topic Publish a static MQTT message: /iot/mqtt/publish broker="mosquittoSSL" topic="test/topic" message="{\"test\":\"123\"}" Check subscriptions for received messages: /iot/mqtt/subscriptions/recv/print 0 broker=mosquittoSSL topic="test/topic" data="{"test":"123"}" time=2023-07-12 10:20:40

Container - ThingsBoard MQTT/HTTP server Introduction Summary Configuration Container mode Networking Environment variables and mounts Getting image Starting the container Verification Management access MQTT test Enabling HTTPS and SSL MQTT Create certificates Download the ThingsBoard's configuration file Alter the ThingsBoard's settings Upload altered ThingsBoard configuration file Confirm HTTPS access Confirm SSL MQTT connection Testing with the device that is running the container Testing with another device Introduction The introduction of the container feature into the RouterOS made it possible to run all kinds of servers for all sorts of tasks inside the router. This is especially relevant for people, who want to reduce the number of devices in their network. Instead of running a server on a separate device/machine, why not run it inside the router? A lot of users need a server that is able to gather the data, store it and display it in a way it is easy to understand. This is where a platform like ThingsBoard can come into play. It is primarily positioned as an IoT platform and you can find all sorts of use cases for it that they demonstrate in the .link The most appealing part, from the RouterOS user standpoint, is that it can be used as an MQTT server (MQTT broker) or an HTTP server. Meaning, you can use or to post the data. You can find ThingsBoard MQTT API guide by using the link and HTTP API by using the link MQTT publish HTTP post here he .re In short, you can utilize to collect RouterOS statistics (like uptime, GPS coordinates, packet statistics, and almost anything else that you print into scripting the terminal), then store this information into variables and structure a JSON message out of those. You can, then send this message using MQTT or HTTP post to the ThingsBoard via a (that will run this script whenever you need it). You can find an example of a basic script that does it in scheduler this . guide ThingsBoard will store and display the data with the help of , which can be used to help you set up dashboards that visualize the data in graphs, widgets tables, maps, and other ways. There are 3 versions of the ThingsBoard instances available and each of them uses a different database: thingsboard/tb-postgres thingsboard/tb-cassandra thingsboard/tb You can find more information in the ThingsBoard/docker documentation. In our example, we will showcase - a single instance of ThingsBoard with PostgreSQL database. tb-postgres Summary Sub-menu: /container : note container package is required. RouterOS versions that are older than v7.8 will not be able to run this scenario.

Make sure to study our guide before proceeding with the configuration. Make sure to check the and sections to container disclaimer requirements understand all the risks and necessary steps you might be required to do. In this example, we will run it on a device. To help you set it up in a , please check our . Cloud Hosted Router, CHR Virtual Box youtube tutorial At the time, when the guide was published, image was available for linux/ and linux/ OS/architectures . Meaning, thingsboard/tb-postgres arm64 amd64 only you are not able to run this scenario on our arm32-bit architecture RouterOS devices. There are a couple of parameters to keep in mind: You need to understand that it is a and that you will need to have additional space for the data that is stored there and the image itself. In server our tests, 8 GB of disk space was plenty enough but! you might want to consider adding more for real-life applications, especially if you are planning on running more containers. Just remember → it might be better to have a reserve. Same as with disk space, RAM memory is also important. Per the ThingsBoard documentation, when using a single instance of ThingsBoard with a PostgreSQL database, it is recommended to allocate at least 1GB of RAM and use a minimum load (a few messages per second). 2-4GB RAM is recommended. In other words, if you want to run it on a RouterBoard device, please understand, that you might not be able to achieve it on devices that have less than 1 GB RAM. That is why → consider having a device with more RAM memory to spare. Go to the section to understand how to limit RAM. tips and tricks Configuration Container mode Enable container mode: /system/device-mode/update container=yes You will need to confirm the device-mode with a press of the reset button, or a cold reboot, if using container on X86. Networking Add veth interface for the container: /interface/veth/add name=veth1 address=172.18.0.2/24 gateway=172.18.0.1 Create a bridge for the container, assign an IP network to it, and add veth to the bridge: /interface/bridge/add name=dockertb /ip/address/add address=172.18.0.1/24 interface=dockertb /interface/bridge/port add bridge=dockertb interface=veth1 Setup NAT for outgoing traffic: /ip/firewall/nat/add chain=srcnat action=masquerade src-address=172.18.0.0/24 Forward TCP 9090 for HTTP management (the default HTTP port per ThingsBoard documentation): /ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.88.1 dst-port=9090 protocol=tcp to- addresses=172.18.0.2 to-ports=9090 We suggest using HTTP access only when testing locally or through a VPN (when you are certain that the local network is safe). When you want to access container WEB management from the internet (from the public network/WAN), please, instead, consider using . HTTPS

In the field shown in DNAT (dst-nat) rule above, we use the device's local IP address. First, (local access) dst-address use local IPs toset everything up . andconfirm that everything is working Forward TCP 1883 for non-SSL MQTT (the default MQTT port used per ThingsBoard documentation): /ip firewall nat add action=dst-nat chain=dstnat dst-address=192.168.88.1 dst-port=1883 protocol=tcp to- addresses=172.18.0.2 to-ports=1883 Same as with HTTP access, in the field shown in DNAT (dst-nat) rule above, we use the device's local IP address. First, (local dst-address use local IPs access) . toset everything up andconfirm that everything is working Environment variables and mounts Check documentation for exact mounts and variables that need to be added. docker-thingsboard Environment variables: /container/envs/add name=tb_envs key=TB_QUEUE_TYPE value="in-memory" Mounts: /container/mounts/add name=mytb-data src=tb/mytb-data dst=/data /container/mounts/add name=mytb-logs src=tb/mytb-logs dst=/var/log/thingsboard After going through the rest of the steps shown in this guide and verifying that the ThingsBoard management portal works locally → further : secure the setup (a) make sure that all default ThingsBoard user credentials were changed/removed and strong passwords were implemented (reference ThingsBoard documentation); (b) (the steps will be explained later on in the guide); enable HTTPS (c) preferably change HTTPS port to a non-standard one (reference ThingsBoard documentation). Only when you increase the security and only then → you can consider enabling remote access from WAN (by using your public IP address in the field instead of the local IP used in the example above). Additionally, to further increase security, use or dst-address src-address src- parameter, where you can input your trusted public source IP addresses (a list of known/trusted addresses that, for example, address-list belong to your branch office from where you also want to have access to the server). Please understand that only you are responsible for the security. If you leave a door open, someone may exploit it. You need to have networking knowledge and understand the risks when setting up such scenarios. We suggest using non-SSL MQTT (TCP 1883) communication only when testing locally or through a VPN (when you are certain that the local network is safe). Please consider using , instead of non-SSL MQTT (TCP port 1883), for real-life applications, when it comes down to SSL MQTT (TCP port 8883) access from the internet (from the public network). If you use non-SSL MQTT, the communication between the client (MQTT publisher) and the server (MQTT broker) can be easily sniffed/packet captured, and that will compromise authentication data (such as client-ids, usernames and passwords). After going through the rest of the steps shown in this guide and verifying that the ThingsBoard non-SSL MQTT communication works locally → f : urther secure the setup (a) consider removing template devices from the ThingsBoard installation; (b) (the steps will be explained later on in the guide); enable SSL MQTT (c) preferably change MQTT port to a non-standard one (reference ThingsBoard documentation). When you enable SSL MQTT, you can consider opening TCP 8883 (which is the default SSL MQTT port) from WAN (by using your public IP address in the field instead of the local IP, and changing and from 1883 to 8883). Additionally, to further dst-address dst-port to-ports increase security, use or parameters, where you can set up your trusted public IP address list. As a result, src-address src-address-list only configured trusted IPs will be able to establish an MQTT connection with the ThingsBoard broker.

Getting image To simplify the configuration, we will get the image from an external library but you can also import it via the file..tar Make sure that you have "Registry URL" set accordingly, limit RAM usage (if necessary), and set up a directory for the image. /container/config/set registry-url=https://registry-1.docker.io tmpdir=pull ram-high=2048.0MiB Pull image: /container/add remote-image=thingsboard/tb-postgres:latest interface=veth1 root-dir=ThingsBoard mounts=mytb- data,mytb-logs envlist=tb_envs logging=yes After running the command, RouterOS should start "extracting" the package. Check "File System" for newly created folders and monitor container status with the command . /container/print Starting the container After you make sure that the container has been added and the status changed to after using → you can initiate it: status=stopped /container/print /container/start 0 Wait for a couple of minutes for the container to fully load. Verification Management access After the container is started and installed, access it using any browser, by going to → (where the IP address is the address used http://192.168.88.1:9090 in the DNAT rule):

By default, credentials are (Username/Password): Systen Administrator : sysadmin@thingsboard.org / sysadmin Tenant Administrator : tenant@thingsboard.org / tenant The login prompt should confirm that the server is running. MQTT test Log in with the and create a new device. Go to the " " menu, click on the " " (Add Device) button and choose the " " option: tenant Devices + Add new device Name it, however, you like, and click on " ":Add

Check your device access token by clicking on the device you've just created and selecting the " " setting (copy the access token Manage credentials generated or type in your own → "YOUR_TOKEN"): After these steps, go to the RouterOS settings (back to CHR settings) and create a new ( beca MQTT broker make sure that you have IoT package installed use otherwise, you will not have this menu): /iot/mqtt/brokers/add name=tb address=172.18.0.2 port=1883 username=YOUR_TOKEN Publish a static test MQTT message in the JSON format: /iot/mqtt/publish broker="tb" topic="v1/devices/me/telemetry" message="{\"test\":\"123\"}" Confirm that the message was posted:

1. 2. 3. 4. 5. 1. 2. 3. 4. 5. 6. sftp> get thingsboard.yml Fetching /ThingsBoard/usr/share/thingsboard/conf/thingsboard.yml to thingsboard.yml /ThingsBoard/usr/share/thingsboard/conf/thingsboard.yml 100% 67KB 2.0MB/s 00:00 sftp> quit c:\Users\Admin\Desktop\ThingsBoard>dir Directory of c:\Users\Admin\Desktop\ThingsBoard 30.01.2023 10:59 <DIR> . 30.01.2023 10:59 <DIR> .. 27.01.2023 15:09 2 448 keystore.p12 27.01.2023 15:36 2 434 mqttserver.p12 30.01.2023 10:59 68 846 thingsboard.yml 3 File(s) 73 728 bytes 2 Dir(s) 50 901 626 880 bytes free Alter the ThingsBoard's settings Open " " via your preferred text editor (notepad or any other), and alter a few lines. You can backup this file and save it with a different thingsboard.yml name to have a copy of the default settings, in case, of misconfiguration. HTTPS-related settings: Enable SSL → Change "SSL_ENABLED: " to "SSL_ENABLED: "; false true Change credentials type → from "SSL_CREDENTIALS_TYPE: " to "SSL_CREDENTIALS_TYPE: "; PEM KEYSTORE Change the path → from "SSL_KEY_STORE: " to "SSL_KEY_STORE: " (optional); classpath:keystore/keystore.p12 keystore.p12 Disable key alias setting → comment it → just put the " " symbol in front of the line; # key_alias: "${SSL_KEY_ALIAS:tomcat}" Input your own certificate password that was used in RouterOS → from "SSL_KEY_STORE_PASSWORD: " to thingsboard "SSL_KEY_STORE_PASSWORD: " and from "SSL_KEY_PASSWORD: " to "SSL_KEY_PASSWORD: thingsboard_cert_password thingsboard things ". board_cert_password ssl: # Enable/disable SSL support enabled: "${SSL_ENABLED:true}" # Server SSL credentials credentials: # Server credentials type (PEM - pem certificate file; KEYSTORE - java keystore) type: "${SSL_CREDENTIALS_TYPE:KEYSTORE}" # Keystore server credentials keystore: # Type of the key store (JKS or PKCS12) type: "${SSL_KEY_STORE_TYPE:PKCS12}" # Path to the key store that holds the SSL certificate store_file: "${SSL_KEY_STORE:keystore.p12}" # Password used to access the key store store_password: "${SSL_KEY_STORE_PASSWORD:thingsboard_cert_password}" # Key alias #key_alias: "${SSL_KEY_ALIAS:tomcat}" # Password used to access the key key_password: "${SSL_KEY_PASSWORD:thingsboard_cert_password}" MQTT-related settings: Enable SSL → Change "MQTT_SSL_ENABLED: " to "MQTT_SSL_ENABLED: "; false true Change credentials type → from "MQTT_SSL_CREDENTIALS_TYPE: " to "MQTT_SSL_CREDENTIALS_TYPE: "; PEM KEYSTORE Change type of key → from "MQTT_SSL_KEY_STORE_TYPE: " to "MQTT_SSL_KEY_STORE_TYPE: "; JKS PKCS12 Change the path (extension) → from "MQTT_SSL_KEY_STORE:mqttserver " to "MQTT_SSL_KEY_STORE:mqttserver "; .jks .p12 Disable key alias setting → comment it → just put the " " symbol in front of the line; # key_alias: "${MQTT_SSL_KEY_ALIAS:}" Input your own certificate password that was used in RouterOS → from "MQTT_SSL_KEY_STORE_PASSWORD: " to server_ks_password "MQTT_SSL_KEY_STORE_PASSWORD: " and from "MQTT_SSL_KEY_PASSWORD: " to thingsboard_mqttcert_password server_key_password "MQTT_SSL_KEY_PASSWORD: ". thingsboard_mqttcert_password

ssl: # Enable/disable SSL support enabled: "${MQTT_SSL_ENABLED:true}" # Server SSL credentials credentials: # Server credentials type (PEM - pem certificate file; KEYSTORE - java keystore) type: "${MQTT_SSL_CREDENTIALS_TYPE:KEYSTORE}" # Keystore server credentials keystore: # Type of the key store (JKS or PKCS12) type: "${MQTT_SSL_KEY_STORE_TYPE:PKCS12}" # Path to the key store that holds the SSL certificate store_file: "${MQTT_SSL_KEY_STORE:mqttserver.p12}" # Password used to access the key store store_password: "${MQTT_SSL_KEY_STORE_PASSWORD:thingsboard_mqttcert_password}" # Optional alias of the private key; If not set, the platform will load the first private key from the keystore; #key_alias: "${MQTT_SSL_KEY_ALIAS:}" # Optional password to access the private key. If not set, the platform will attempt to load the private keys that are not protected with the password; key_password: "${MQTT_SSL_KEY_PASSWORD:thingsboard_mqttcert_password}" Apply the changes to the " " file (re-save it after editing). thingsboard.yml Upload altered ThingsBoard configuration file All that is left is to overwrite the current configuration file with an altered file and upload both certificates. Once again, make sure your terminal is pointing to the right folder (where 3 files are located → both certificates and an altered "thingsboard.yml" file), and, from there, SFTP into the container's configuration file directory: c:\Users\Admin\Desktop\ThingsBoard>dir Directory of c:\Users\Admin\Desktop\ThingsBoard 30.01.2023 10:59 <DIR> . 30.01.2023 10:59 <DIR> .. 27.01.2023 15:09 2 448 keystore.p12 27.01.2023 15:36 2 434 mqttserver.p12 30.01.2023 10:59 68 846 thingsboard.yml 3 File(s) 73 728 bytes 2 Dir(s) 50 901 626 880 bytes free c:\Users\Admin\Desktop\ThingsBoard>sftp admin@192.168.88.1 admin@192.168.88.1's password: Connected to 192.168.88.1. sftp> cd ThingsBoard\usr\share\thingsboard\conf sftp> dir banner.txt i18n logback.xml templates thingsboard.conf thingsboard. yml Upload these files with the help of command:put Leave the rest of the settings at default values. Do not delete/change lines that are not shown in the examples above unless you know what you are doing.

Confirm SSL MQTT connection In this example, we will test a . one-way SSL communication access token scenario Testing with the device that is running the container Add MQTT broker: /iot/mqtt/brokers/add name=tbssl address=172.18.0.2 port=8883 username=YOUR_TOKEN ssl=yes Publish a static test MQTT message in the JSON format: /iot/mqtt/publish broker="tbssl" topic="v1/devices/me/telemetry" message="{\"test\":\"123\"}" Confirm that it was received by the MQTT broker: Testing with another device When you have two RouterOS devices, one that is running the container (and, in our example, is the same device that generated the certificate) and the other one that you wish to test the MQTT connection from (let's say, an or any other RouterOS device with IoT package installed) → you will need to LTAP import the certificate to the second device. Drag and drop the exported certificate ( ) into the device's "File List": mqttserver.p12 [admin@LTAP] > /file/print Columns: NAME, TYPE, SIZE, CREATION-TIME # NAME TYPE SIZE CREATION-TIME 0 mqttserver.p12 .p12 file 2438 jan/30/2023 13:28:11 1 flash disk jul/06/2021 14:51:53 2 flash/pub directory jul/06/2021 14:51:53 3 flash/skins directory jan/01/1970 02:00:07 [admin@LTAP] > Import the certificate: [admin@LTAP] > /certificate/import file-name=mqttserver.p12 passphrase=thingsboard_mqttcert_password Do not forget to alter the port forwarding rule that is shown in the "Networking" section by changing and from 1883 dst-portto-ports (standard non-SSL MQTT port) ( ). to 8883 SSL MQTT port MQTT certificate should already be installed into the device's system (because it is the device that generated it).

Add MQTT broker, where the address is the IP address " " that is used in the TCP 8883 port-forwarding rule on the ThingsBoard-container dst-address router: /iot/mqtt/brokers/add name=tbssl address=192.168.88.1 port=8883 username=YOUR_TOKEN ssl=yes Publish a static test MQTT message in the JSON format: /iot/mqtt/publish broker="tbssl" topic="v1/devices/me/telemetry" message="{\"test\":\"123\"}" And confirm that the broker received it → under the "Latest Telemetry" section on the ThingsBoard.

DLNA Media server DLNA is a set of protocols that enables networked devices to share digital media, including videos, photos, and music. Central to the operation of DLNA is the UPnP (Universal Plug and Play) architecture, which facilitates the discovery and control of network devices. DLNA and UPnP work in tandem to provide a seamless media sharing experience. UPnP supports device discovery and control on the network through protocols like the Simple Service Discovery Protocol (SSDP) and others such as SOAP (Simple Object Access Protocol) for control messages and XML for device and service descriptions. In the context of DLNA, UPnP serves as the foundation, allowing various devices like TVs, computers, and mobile devices to connect and share media content efficiently. In RouterOS, enable the media server and share movies or music with your household media devices, such as TVs or player apps in your PC, such as the popular VLC. Server settings Property Description allowed-hostname To restrict access to specific hostnames. allowed-ip To limit access to specified IP addresses friendly-name The name that will be displayed for the DLNA server on the network. interface Specifies the network interface that the DLNA server will use path The file path where the media content is stored and will be served from. disabled Specifies if entry is disabled Configuration examples Creating a DLNA server /ip media add friendly-name=Mikrotik interface=bridge1 path=usb1 Creating multiple DLNA servers with limitations. Usage example - Limit children's TV access only to child-friendly media, located in folder "usb1/kids" /ip media add friendly-name=adults interface=bridge1 path=usb1/adults allowed-hostname=ADULTS_TV /ip media add friendly-name=kids interface=bridge1 path=usb1/kids allowed-hostname=KIDS_TV Media (DLNA) is not supported on SMIPS devices

ROSE-storage ROSE (RouterOS Enterprise) package adds data center functionality to RouterOS - for supporting disk monitoring, improved formatting, RAIDs, rsync, iSCSI ,NVMe over TCP, NFS. This functionality currently is supported on arm, arm64, x86 and tileplatforms. Storage Type Crypted Properties Configuration example: iSCSI Properties Configuration example NFS Properties Configuration example NVME over TCP Properties Configuration example Ramdisk Properties Configuration example SMB Properties Configuration example Tmpfs Properties Configuration example RAID Properties Configuration example (RAID6): RAID 0 RAID 1 RAID 4 RAID 5 RAID 6 RAID Linear Nested RAID Configuration example RSYNC Properties Configuration example Self-Encryption Drives Storage Type Crypted Drive or device used together with type=crypted to make "dm_crypt" encrypted storage. is a transparent disk encryption subsystem designed to dm-crypt provide encryption of block devices. Properties Property Description slot Default: ) (string; Name of the file system encryption-key Default: ) (string; key used to decrypt crypted-backend (string; Default: ) Drive or partition to encrypt

Configuration example: To create a crypted file-system: add crypted-backend=usb1 encryption-key=strong_key slot=crypted-usb1 type=crypted After it's created format the file system and it's ready to go. disk format-drive crypted-usb1 file-system=btrfs iSCSI iSCSI allows accessing storage over an IP-based network. On initiator iSCSI device will appear as block device. RouterOS supports both target and initiator modes. Properties Property Description iscasi- address IP address of the iSCSI target. (Host device IP) iscasi- exportDisables/enables iSCASI on the host device iscasi-iqn unique identifier used to name iSCSI target. (In ROS the iqn is the same as slot name, can't be changed and needs to be configured only on the client device) iscasi-port network port used by the iSCSI target to listen for incoming connections from initiators. The default port for iSCSI traffic is 3260. Configuration example Host /disk set pcie1-nvme1 iscsi-export=yes Client /disk add type=iscsi iscsi-address=192.168.1.1 iscsi-iqn=pcie1-nvme1 NFS NFS allows sharing local directories over network. RouterOS currently supports NFS v4 only mode. Properties Property Description nfs-address IP address of the NFS target. (host device IP) nfs-share Specify the folder to mount (client parameter) NFS uses port TCP/2049. If the port is not available in disk print detail you will see the state stuck at nfs-state="mounting"

nfs-sharing Disable/enable NFS on the host device Configuration example Host /disk set pcie1-nvme1 nfs-sharing=yes Client /disk add type=nfs nfs-address=192.168.1.1 Linux client mkdir /mnt/files mount -t nfs 192.168.1.1:/ /mnt/files NVME over TCP nvme-tcp allows accessing storage over network as NVMe block device on initiator side. On target side this device can be hdd/ssd/nvme or even raid array. Properties Property Description nvme-tcp-address IP address of the NVME over TCP target. (host device IP) nvme-tcp-export Disable/enable NVME over TCP on the host device nvme-tcp-host-name This property specifies the hostname of the NVMe over TCP initiator. It can be used for identification and authentication purposes nvme-tcp-name This property specifies the name of the NVMe over TCP target or the connection name for reference purposes (needs to be the same as host slot name) nvme-tcp-password his property is used to specify the password for authenticating the NVMe over TCP connection, ensuring secure access. nvme-tcp-port This property specifies the network port used by the NVMe over TCP target to listen for incoming connections from initiators. The default port for NVMe over TCP traffic is 4420. nvme-tcp-server-allow- host-nameThis property specifies whether the NVMe over TCP server allows connections from specific hostnames, providing a mechanism for host-based access control. nvme-tcp-server- password This property specifies the password for the NVMe over TCP server, used for authenticating initiators connecting to the target. nvme-tcp-server-port This property specifies the network port used by the NVMe over TCP server to accept connections from initiators. Configuration example Host /disk set pcie1-nvme2 nvme-tcp-export=yes nvme-tcp-port=4420 Client

/disk add type=nvme-tcp nvme-tcp-address=192.168.1.1 nvme-tcp-name=pcie1-nvme1 Linux client Load kernel module modprobe nvme_tcp Discover available nvme-tcp targets nvme discover -t tcp -a 192.168.1.1 -s 4420 ``` Discovery Log Number of Records 1, Generation counter 2 =====Discovery Log Entry 0====== trtype: tcp adrfam: ipv4 subtype: nvme subsystem treq: not specified, sq flow control disable supported portid: 4420 trsvcid: 4420 subnqn: pcie1-nvme1 traddr: 10.155.166.7 sectype: none subnqn should match the slot name and will be used as -n parameter: nvme connect -t tcp -a 192.168.1.1 -s 4420 -n pcie1-nvme1 Block devices now should be available: ls /dev/nvme* ``` /dev/nvme0 /dev/nvme0n1 /dev/nvme-fabrics To disconnect: nvme disconnect -d /dev/nvme0 where /dev/nvme0 previously mounted device, or disconnect all: nvme disconnect-all Ramdisk RAMdisk - allows using part of RAM as attached device (block device). If compared to tmpfs - this allows using RAM as part of raid, or any other configuration where device instead of folder is required. Properties RAMdisk will be cleared on reboot or power loss

Property Description ramdisk-size Size of the block device you want to create Configuration example /disk disk add type=ramdisk ramdisk-size=500M SMB SMB is a popular file-sharing protocol. ROSE package currently supports SMB2.1 SMB3.0, SMB3.1.1 dialects (SMB1 is not supported due to security vulnerabilities) Properties Property Description smb-address IP address of the SMB server smb-password SMB password smb-share Name of the share you want to connect to smb-user SMB user Configuration example Client add smb-address=10.155.145.11 smb-share=share1 smb-user=user smb-password=password type=smb Server-side configuration can be found - SMB Tmpfs TMPFS - allows using part of RAM as filesystem (can't be used as block device) Properties Property Description tmpfs-max-size Size of the block device you want to create Configuration example add type=tmpfs tmpfs-max-size=10G RAID Tmpfs will be cleared on reboot or power loss

RAID (Redundant Array of Independent Disks) technology allows storing data on multiple drives - improving data transfer performance, data protection or both by combining them into logical units. Properties Property Description raid-type RAID type used (levels 0,1,4,5,6,linear and nested RAID.) raid-chunk-size The size of the chunks or stripes used in the RAID array. raid-device-count The number of devices (disks) included in the RAID array. raid-master Created RAID master block device the disks are added to. raid-max-component-size The maximum size of an individual component or disk in the RAID array. raid-member-failed Sets the drive in a failed state in RAID array. Used if there is a need to change a non-failed drive raid-role Defines the role of each device within the RAID array. Configuration example (RAID6): This is an example on how to configure RAID, it will be the same procedure in most of RAID types Create the RAID block device (In this example, RAID 6) add raid-device-count=20 raid-type=6 slot=raid1 type=raid Add drives to this raid set nvme1 raid-master=raid1 raid-role=0 set nvme2 raid-master=raid1 raid-role=1 set nvme3 raid-master=raid1 raid-role=2 set nvme4 raid-master=raid1 raid-role=3 set nvme5 raid-master=raid1 raid-role=4 set nvme6 raid-master=raid1 raid-role=5 set nvme7 raid-master=raid1 raid-role=6 set nvme8 raid-master=raid1 raid-role=7 set nvme9 raid-master=raid1 raid-role=8 set nvme10 raid-master=raid1 raid-role=9 set nvme11 raid-master=raid1 raid-role=10 set nvme12 raid-master=raid1 raid-role=11 set nvme13 raid-master=raid1 raid-role=12 set nvme14 raid-master=raid1 raid-role=13 set nvme15 raid-master=raid1 raid-role=14 set nvme16 raid-master=raid1 raid-role=15 set nvme17 raid-master=raid1 raid-role=16 set nvme18 raid-master=raid1 raid-role=17 set nvme19 raid-master=raid1 raid-role=18 set nvme20 raid-master=raid1 raid-role=19 Format the RAID block device disk> format-drive raid1 file-system=btrfs And the result should look similar to this RouterOS supports software RAID levels 0,1,4,5,6,linear and nested RAID.

21 BM type=raid slot="raid1" slot-default="" parent=none uuid="f457bc79-7408-489b-8850-85923e900452" fs=btrfs model="RAID6 2-parity-disks" size=17 283 541 893 120 free=17 283 538 190 336 raid-type=6 raid-device-count=20 raid-max- component-size=none raid-chunk-size=1M raid-master=none raid-state="clean" nvme-tcp-export=no iscsi-export=no nfs-sharing=no smb-sharing=no media- sharing=no media-interface=none RAID 0 All data is written evenly over all disks in this RAID, this configuration does not provide any fault tolerance but provides best performance. RAID 1 Same data is written in all drives (data is mirrored), this configuration provides best fault tolerance, but performance wise write speeds will be equal to slowest disk used in array. RAID 4 Block-level data is striped to a dedicated disk where parity bits are stored. Performance will be limited to a parity writing speed.

RAID 5 Block-level data is striped evenly over the available disks. Can be recovered from 1 disk failure. RAID 6 Block-level data is striped evenly over the available disks. Can be recovered from 2 disk failures.

RAID Linear Data is appended over multiple disks combining them into single large disk. Provides no redundancy and is limited to single disk read/write speed. Nested RAID Combination of multiple RAID configurations into other RAID. For example RAID 10 (RAID 1+0) combines disk mirroring (RAID 1) and disk striping (RAID 0) Configuration example In this example I'm using 20 SSD drives and configuring in RAID (RAID 1+0) Create a RAID 1 block add raid-device-count=2 raid-type=1 slot=raid10 type=raid Crete two RAID 0 blocks and add them to set the master-raid the previously created RAID 1 block (name=raid10) add raid-device-count=10 raid-master=raid10 raid-role=0 raid-type=0 slot=raid0 type=raid add raid-device-count=10 raid-master=raid10 raid-role=1 raid-type=0 slot=raid1 type=raid Add drives to each RAID block

set nvme1 raid-master=raid1 raid-role=0 set nvme2 raid-master=raid1 raid-role=1 set nvme3 raid-master=raid1 raid-role=2 set nvme4 raid-master=raid1 raid-role=3 set nvme5 raid-master=raid1 raid-role=4 set nvme6 raid-master=raid1 raid-role=5 set nvme7 raid-master=raid1 raid-role=6 set nvme8 raid-master=raid1 raid-role=7 set nvme9 raid-master=raid1 raid-role=8 set nvme10 raid-master=raid1 raid-role=9 set nvme11 raid-master=raid0 raid-role=0 set nvme12 raid-master=raid0 raid-role=1 set nvme13 raid-master=raid0 raid-role=2 set nvme14 raid-master=raid0 raid-role=3 set nvme15 raid-master=raid0 raid-role=4 set nvme16 raid-master=raid0 raid-role=5 set nvme17 raid-master=raid0 raid-role=6 set nvme18 raid-master=raid0 raid-role=7 set nvme19 raid-master=raid0 raid-role=8 set nvme20 raid-master=raid0 raid-role=9 After this format, the raid10 block format-drive raid10 file-system=btrfs After formating you should see the free space and use the block 23 BM type=raid slot="raid10" slot-default="" parent=none uuid="ec3344f4-1662-49ab-b899-db1aaa217b0f" fs=btrfs model="RAID1 mirrored" size=9 601 967 652 864 free=9 597 901 369 344 raid-type=1 raid-device-count=2 raid-max-component-size=none raid- master=none raid-state="clean" nvme-tcp-export=no iscsi-export=no nfs-sharing=no smb-sharing=no media-sharing=no media-interface=none RSYNC (Remote Sync) is a powerful file synchronization and file transfer program used in Unix-based systems. It allows for efficient transfer and rsync synchronization of files and directories between different systems or within the same system. If you make changes in a file only changes to files are transferred, reducing data transfer volume. RouterOS RSYNC implementation uses ipsec for data transfer (if password is set). When configured you will see dynamic ipsec entries. Rsync settings can be found in file/sync menu IPSec dynamic entry example: Port TCP/8291 is used for the control connection (if not open in the status ( ) you will be stuck at making control connection to file sync print 192.1 ) 68.88.2 Port UDP/500 and protocol 50 (ipsec-esp) is used to create a secure connection and start the transfer (if not open in the status ( ) file sync print you will be stuck at initializing transfer)

/disk print Flags: B - BLOCK-DEVICE; M, F - FORMATTING; o - TCG-OPAL-SELF-ENCRYPTION-SUPPORTED Columns: SLOT, MODEL, SERIAL, INTERFACE, SIZE, FREE, FS, RAID-MASTER # SLOT MODEL SERIAL INTERFACE SIZE FREE FS RAID 0 BMo sata1 Samsung SSD 860 2.5in S3Z9NX0N414510L SATA 6.0 Gbps 1 000 204 886 016 983 351 111 680 ext4 none 1 BMo sata2 Samsung SSD 860 S5GENG0N307602J SATA 6.0 Gbps 1 000 204 886 016 983 351 128 064 ext4 none 2 BMO sata3 Samsung SSD 860 S5GENG0N307604H SATA 6.0 Gbps 1 000 204 886 016 983 351 128 064 ext4 none 3 BMO sata4 Samsung SSD 860 2.5in S4CSNX0N838150B SATA 6.0 Gbps 1 000 204 886 016 983 351 128 064 ext4 none To set TCG-OPAL-SELF-ENCRYPTION: /disk disk set sata1 self-encryption-password=securepassword to unset: /disk disk unset sata1 self-encryption-password or /disk disk set sata1 !self-encryption-password

SMB Summary Sub-menu: /ip smb Packages required: system SMB server provides file sharing access to configured folders of the router. Server settings Property Description comment ( ; Default: string Mi ) krotikSMBSet comment for the server domain ( ; Default: string MS ) HOMEName of Windows Workgroup enabled ( yes | no | auto Def ault: auto)The default value is 'auto.' This means that the SMB server will automatically be enabled when the first non-disabled SMB share is configured under '/ip smb share' interface ( ; Default: ) string all List of interfaces on which SMB service will be running. all - SMB will be available on all interfaces. Share settings Sub-menu: /ip smb shares Allows configuring share names and directories that will be accessible by SMB. If the directory provided in the configuration does not exist it will be created automatically. Property Description comment ( ; string Default: ) default shareSet a comment for the share disabled ( ; yes | no Default: )noIf disabled, the share will not be accessible. valid-users (list of strings ; | Default:)Specifies which users are allowed to access the Samba share. If it is left empty, all users will be able to access the share, once user or users are defined here, only they will be able to access the share invalid-users (list of strin ; | Default: )gsUsed to specify users who are explicitly denied access to the Samba share. require-encryption ( |yes ; Default: ) no noEnforces the use of encryption for all connections to a particular Samba share name ( ; Default: ) string Name of the SMB share RouterOS only supports S MB2.1 SMB3.0, SMB3.1.1. SMB1 is not supported due to security vulnerabilities. SMB is not supported on SMIPS devices Starting from version 7.14, the 'allow-guest' option has been replaced by a default guest user located in 'ip/smb/users'. This default guest user can now be disabled or enabled in this section.

directory ( ; string Default: )Directory on router assigned to SMB share. If left empty value of the argument will be used from the root folder. name User setup Sub-menu: /ip smb user Set up users that can access SMB shares of the router. Property Description comment ( ; Default: ) string Set a description for the user disabled ( ; Default: ) yes | no no Defines whether the user is enabled or disabled name ( ; Default: ) string Login name of the SMB service user password ( ; Default: ) string Password for SMB user to connect to SMB service read-only ( ; Default: ) yes | no yes Sets if the user has only read-only rights when accessing shares or full access rights. Example To make RouterOS folder available through SMB service follow these steps: create user: /ip/smb/users/add read-only=no name=mtuser password=mtpasswd add shared folder: /ip/smb/shares/add directory=backup name=backup enable SMB service: #this step is optional, as the default is "enabled=auto" /ip/smb/set enabled=yes Now check for results: Check general service settings: /ip/smb/print enabled: yes domain: MSHOME comment: MikrotikSMB interfaces: all SMB user settings: /ip smb/users/print Flags: X - DISABLED; * - DEFAULT; r - READ-ONLY Columns: NAME, PASSWORD # NAME PASSWORD 0 X*r guest 1 mtuser mtpasswd And finally SMB shares settings:

/ip/smb/shares/print Flags: X - DISABLED; * - DEFAULT Columns: NAME, DIRECTORY, REQUIRE-ENCRYPTION # NAME DIRECTORY REQUIRE-ENCRYPTION ;;; default share 0 X* pub /pub no 1 backup backup no Now, additional configuration changes can be done, like disabling the default user and share, etc.

The rtc command causes the UPS to start a run time calibration until less than 25% of full battery capacity is reached. This command calibrates the returned run time value. Monitoring Command: /system ups monitor <id> Property Description battery-charge () the UPS's remaining battery capacity as a percent of the fully charged condition battery-voltage () the UPS's present battery voltage. The typical accuracy of this measurement is ±5% of the maximum value (depending on the UPS's nominal battery voltage) frequency () when operating on-line, the UPS's internal operating frequency is synchronized to the line within variations of 3 Hz of the nominal 50 or 60 Hz. The typical accuracy of this measurement is ±1% of the full scale value of 63 Hz line-voltage () the in-line utility power voltage load () the UPS's output load as a percentage of full rated load in Watts. The typical accuracy of this measurement is ±3% of the maximum of 105% low-battery (yes | )noonly shown when the UPS reports this status on-battery (yes | )noWhether UPS battery is supplying power on-line ( ) yes | no whether power is being provided by the external utility (power company) output-voltage () the UPS's output voltage overloaded-output ( ) yes | noonly shown when the UPS reports this status replace-battery (ye ) s | noonly shown when the UPS reports this status runtime- calibration-running ( ) yes | noonly shown when the UPS reports this status runtime-left ( )time the UPS's estimated remaining run time in minutes. You can query the UPS when it is operating in the on-line, bypass, or on- battery modes of operation. The UPS's remaining run time reply is based on available battery capacity and output load smart-boost-mode ( ) yes | noonly shown when the UPS reports this status smart-ssdd-mode ()only shown when the UPS reports this status transfer-cause (stri )ngthe reason for the most recent transfer to on-battery operation (only shown when the unit is on-battery) Example When running on utility power: Note: The test begins only if the battery capacity is 100%.

Wake on LAN Introduction Sub-menu: /tool wol The Wake on LAN tool can send a . UDP Magic Packet to the Broadcast address with a selected MAC address embedded in it If the target device supports Wake on LAN (a target computer has specific hardware and software requirements for the Wake on LAN feature to work), it should wake up from sleep or shutdown state. Currently, secure WoL is not supported. Property Description Property Description interface ( ) string; Default: Interface through which the Magic Packet will be sent mac ( ; Default: ) MAC MAC address of a target computer Application Example The command requires a MAC address parameter and interface. /tool wol mac=FE:4B:71:05:EA:8B interface=ether1 If an interface is not specified, A Magic Packet will be sent as an IP broadcast from a default gateway interface.

IP packing Overview IP Packing provides packet packaging service on network links. It allows simple packet aggregation into larger packets and compression of the contents of packets. Requirements Packet packing is part of the system package and has to have a discovery protocol enabled on an interface. Configuration /ip packing It required to have a configuration in two places, both routers should be set up symmetrically: /ip packing - to enable packet aggregation and/or compression on an interface /ip neighbor discovery - to enable discovery protocol on the interface Packing configuration Property Description aggregated-size ( ) 20 .. 16384 default: 1500 size of an aggregated packet that packing will try to achieve before sending a packet over the network disabled ( ) yes|no state of packing rule, if a value is it will be ignored and will not be part of the active configuration yes interface ( ) interface name packing will try to aggregate and/or compress packets from this interface packing ( simple|compress-all|compress- ) headers|nonethe action it should perform when a packet is leaving the interface packing rule is configured: simple - do just aggregate packets compress-all - do aggregation and attempt to compress headers and payload of a packet compress-headers - do aggregation and attempt to compress headers and leave the payload of a packet as is none - send packets as is unpacking ( simple|compress-all|compress- ) headers|nonethe action should be performed when a packet is received on the interface packing rule is configured on: simple - unpack received packets from aggregated packets received from the interface compress-all - unpack aggregated packet and uncompress headers and payload of a packet compress-headers - unpack aggregated packets and decompress headers of a packet none - do nothing with a received packet Example The router should be seen as a neighbor of the router over the interface you want to enable packing on. If in the neighbor list there is no entry indicating packing, packing is not working! Packing may increase latency on the link it is configured on.

Router-A and Router-B are connected with cable with interface ether1 on Router-A and ether3 on Router-B. This example will aggregate packets coming from Router-A, but will leave packets from Router-B intact On Router-A: Make sure discovery is enabled: /ip neighbor discovery set ether1 discover=yes Add packing rule for the interface: /ip packing add interface=ether1 aggregated-size=1500 packing=simple unpacking=none On Router-B: Make sure discovery is enabled: /ip neighbor discovery set ether3 discover=yes Add packing rule for the interface: /ip packing add interface=ether3 aggregated-size=1500 packing=none unpacking=simple

