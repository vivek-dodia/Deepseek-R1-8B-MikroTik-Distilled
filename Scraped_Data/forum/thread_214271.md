---
title: Thread-214271
url: https://forum.mikrotik.com/viewtopic.php?t=214271&sid=49f92a630bc7970d8ca50523be880e8f
thread_id: 214271
section: RouterOS
post_count: 4
date_crawled: 2025-02-03T13:22:25.320547
---

### Post 1
Author: Unknown
Date: Unknown

I am trying to connect from a vps to my Mikrotik server over L2TP/IPSec with preshared key.Both the mikrotik and my vps have public addresses. I have tried both with windows (default vpn client) and ubuntu (using nmcli). ports 500,4500 and 1701 are enabled on the server.The ipsec sessions seems to succeed but than immediately closes. when packet sniffing on the client i see the the ISAKMP Session start successfully but then when my client sends ESP packets he gets no response from the l2tp server. What could be the issue with the l2tp server?here is my l2tp serverCode:Select allinterface/l2tp-server/server/printenabled:yes
                 max-mtu:1400max-mru:1400mrru:disabled
          authentication:chap,mschap2
       keepalive-timeout:30max-sessions:unlimiteddefault-profile:vpn_profileuse-ipsec:yes
            ipsec-secret:<secret>caller-id-type:ip-address
    one-session-per-host:noallow-fast-path:nol2tpv3-circuit-id:l2tpv3-cookie-length:0l2tpv3-digest-hash:md5
  accept-pseudowire-type:all
    accept-proto-version:allIv'e attached some logs for reference.Code:Select all14:08:11ipsec,debug type=EncryptionAlgorithm,flag=0x8000,lorv=3DES-CBC[142/1872]14:08:11ipsec,debug type=HashAlgorithm,flag=0x8000,lorv=SHA14:08:11ipsec,debug hash(sha1)14:08:11ipsec,debug type=GroupDescription,flag=0x8000,lorv=2048-bit MODPgroup14:08:11ipsec,debug dh(modp2048)14:08:11ipsec,debug type=AuthenticationMethod,flag=0x8000,lorv=pre-shared key14:08:11ipsec,debug type=LifeType,flag=0x8000,lorv=seconds14:08:11ipsec,debug type=LifeDuration,flag=0x0000,lorv=414:08:11ipsec,debug transform#5 len=3614:08:11ipsec,debug type=EncryptionAlgorithm,flag=0x8000,lorv=3DES-CBC14:08:11ipsec,debug type=HashAlgorithm,flag=0x8000,lorv=SHA14:08:11ipsec,debug authmethod=pre-shared key:pre-shared key14:08:11ipsec,debug dh_group=1024-bit MODPgroup:256-bit random ECPgroup14:08:11ipsec,debug-compare proposal#3: Local:Peer14:08:11ipsec,debug(lifetime=86400:28800)14:08:11ipsec,debug(lifebyte=0:0)14:08:11ipsec,debug enctype=3DES-CBC:AES-CBC14:08:11ipsec,debug(encklen=0:128)14:08:11ipsec,debug hashtype=SHA:SHA14:08:11ipsec,debug authmethod=pre-shared key:pre-shared key14:08:11ipsec,debug dh_group=2048-bit MODPgroup:256-bit random ECPgroup14:08:11ipsec,debug-compare proposal#4: Local:Peer14:08:11ipsec,debug authmethod=pre-shared key:pre-shared key14:08:11ipsec,debug dh_group=2048-bit MODPgroup:2048-bit MODPgroup14:08:11ipsec,debug-an acceptable proposal found-14:08:11ipsec,debug-agreed on pre-shared key auth-14:08:11ipsec,debug===14:08:11ipsec,debugnewcookie:14:08:11ipsec,debug<cookie>14:08:11ipsec,debugaddpayloadoflen52,nexttype1314:08:11ipsec,debugaddpayloadoflen16,nexttype1314:08:11ipsec,debugaddpayloadoflen16,nexttype1314:08:11ipsec,debugaddpayloadoflen20,nexttype014:08:11ipsec,debug seen nptype=20(nat-d)len=2414:08:11ipsec,debug succeed.14:08:11ipsec,debug<l2tp_server>Hashing<l2tp_server>[500]withalgo#214:08:11ipsec,debug hash(sha1)14:08:11ipsec,debug NAT-D payload#0 verified14:08:11ipsec,debug<my_server>Hashing<my_server>[500]withalgo#214:08:11ipsec,debug hash(sha1)14:08:11ipsec,debug NAT-D payload#1 verified14:08:11ipsec NATnotdetected14:08:11ipsec,debug===14:08:11ipsec,debug010000004126782614:08:11ipsec,debug===14:08:11ipsec,debuguseID typeofIPv4_address14:08:11ipsec,debug generate HASH_R14:08:11ipsec,debugaddpayloadoflen8,nexttype814:08:11ipsec,debugaddpayloadoflen20,nexttype014:08:11ipsec,debug68bytesfrom<l2tp_server>[500]to<my_server>[500]14:08:11ipsec,debug1timesof68bytes message will be sent to<my_server>[500][92/1872]14:08:11ipsec,info ISAKMP-SA established<l2tp_server>[500]-<my_server>[500]spi:<spi>:<cookie>14:08:11ipsec,debug===14:08:11ipsec,debug type=SALifeType,flag=0x8000,lorv=seconds14:08:11ipsec,debug type=SALifeDuration,flag=0x0000,lorv=414:08:11ipsec,debug type=SALifeType,flag=0x8000,lorv=kilobytes14:08:11ipsec,debug type=SALifeDuration,flag=0x0000,lorv=414:08:11ipsec,debug proposal#5 len=5214:08:11ipsec,debugbegin.14:08:11ipsec,debug seen nptype=3(trns)len=4014:08:11ipsec,debug succeed.14:08:11ipsec,debug transform#1 len=4014:08:11ipsec,debug type=EncryptionMode,flag=0x8000,lorv=Transport14:08:11ipsec,debug type=AuthenticationAlgorithm,flag=0x8000,lorv=hmac-sha114:08:11ipsec,debug type=AuthenticationAlgorithm,flag=0x8000,lorv=hmac-sha114:08:11ipsec,debug type=SALifeType,flag=0x8000,lorv=seconds14:08:11ipsec,debug type=SALifeDuration,flag=0x0000,lorv=414:08:11ipsec,debug type=SALifeType,flag=0x8000,lorv=kilobytes14:08:11ipsec,debug type=SALifeDuration,flag=0x0000,lorv=414:08:11ipsec,debug pair1:14:08:11ipsec,debug0x81d7260:next=0tnext=014:08:11ipsec,debug proposal#1: 1 transform14:08:11ipsec,debugaddpayloadoflen64,nexttype1014:08:11ipsec,debugaddpayloadoflen24,nexttype514:08:11ipsec,debugaddpayloadoflen8,nexttype514:08:11ipsec,debug encryption(aes-cbc)14:08:11ipsec,debug hmac(sha1)14:08:11ipsec,debug call pfkey_send_update_nat14:08:11ipsecIPsec-SA established:ESP/Transport<my_server>[500]-><l2tp_server>[500]spi=0xbd594d114:08:11ipsec,debug pfkey update sent.14:08:11ipsec,debug encryption(aes-cbc)14:08:11ipsec,debug hmac(sha1)14:08:11ipsec,debug call pfkey_send_add_nat14:08:11ipsecIPsec-SA established:ESP/Transport<l2tp_server>[500]-><my_server>[500]spi=0x6ba1141c14:08:11ipsec,debug pfkeyaddsent.14:08:47ipsec,debug hash validated.14:08:47ipsec,debugbegin.14:08:47ipsec,debug seen nptype=8(hash)len=2414:08:47ipsec,debug seen nptype=12(delete)len=2814:08:47ipsec,debug succeed.14:08:47ipsec,debug<my_server>deletepayloadforprotocol ISAKMP14:08:47ipsec,info purging ISAKMP-SA<l2tp_server>[500]<=><my_server>[500]spi=<spi>:<cookie>.14:08:47ipsec purged ISAKMP-SA<l2tp_server>[500]<=><my_server>[500]spi=<spi>:<cookie>.14:08:47ipsec,debug purgedSAs.14:08:47ipsec,info ISAKMP-SA deleted<l2tp_server>[500]-<my_server>[500]spi:<spi>:<cookie>rekey:1

---
### Post 2
Author: Unknown
Date: Unknown

Just a guess, but check this out:viewtopic.php?t=175528

---
### Post 3
Author: Unknown
Date: Unknown

Just a guess, but check this out:viewtopic.php?t=175528tried setting this for windows.HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgentAssumeUDPEncapsulationContextOnSendRuleboth linux and windows fail at the same stage

---
### Post 4
Author: Unknown
Date: Unknown

Okay, if the VPS is running some kind of Windows, did you restart it after changing the AssumeUDPEncapsulationContextOnSendRule settings?Here are a few more ideas:- Even if the ISAKMP session is established, a firewall or NAT might be blocking the ESP packets between the client and server. Double-check that the required ports (500, 4500, and 1701 for L2TP) are open at both ends.- The log says "NAT not detected," but the issue could still be related to NAT traversal (NAT-T) if there's some unknown intermediate NAT device between the client and server. NAT-T uses port 4500 to get ESP packets through NAT devices.- Make sure the IPsec settings (encryption, hash, DH group, lifetime, etc.) match on both ends. The logs show some differences in the negotiation, like 3DES-CBC vs AES-CBC.

---
