---
title: Thread-213448
url: https://forum.mikrotik.com/viewtopic.php?t=213448&sid=49f92a630bc7970d8ca50523be880e8f
thread_id: 213448
section: RouterOS
post_count: 9
date_crawled: 2025-02-03T14:14:40.313403
---

### Post 1
Author: Unknown
Date: Unknown

@sindy I would like to ask a few questions please,1. If I understood correctly, there should be two "entities" capable of switching, the switch chip and the switching functional block in the cpu?2. Also when you specify a bridge in the tagged or untagged parameter in /interface bridge vlan does that apply for therouter-facing port of the switchor theswitch-facing interface of the router, or both?Code:Select all/interfacebridgeaddname=bridge1/interfacebridge portaddbridge=bridge1interface=ether2/interfacebridge portaddbridge=bridge1interface=ether3/interfacebridge portaddbridge=bridge1interface=ether4/interfacevlanaddvlan-id=10interface=bridge13. And after I issued these command it should look like the image below?(excluding switch chip because I still didn't understand that yet)4. I drew the bridge as another seperate "entity" running inside the switch functional block because I think that the switch functional block is always there and is only used when the bridge is created. Is this correct?

---
### Post 2
Author: Unknown
Date: Unknown

Conceptually: physical port (e.g. ether1) is a port. When you add L3 configuration (e.g. IP address) to it, it becomes interface. If you want to work with tagged frames, coming in and leaving out of, you have to create appropriate VLAN ports, anchored to physical port. Adding IP addresses to those VLAN ports makes them VLAN interfaces (VLAN ports can be used as bridge ports when creating per-VLAN bridge in a pre-6.42 fashion).So if I issue my Router these commandCode:Select all/ipaddaddinterface=ether2 address=192.168.1.254/interfacevlanaddvlan-id=10interface=ether2Say I have a switch connected to my Router that sends tagged frames with vlan id 10, when my router receives the frames and sends the reply to the switch, does my router tags the frame it about to send to the switch with vlan id 10 or is it the switch's duty to tag the reply coming from my router?

---
### Post 3
Author: Unknown
Date: Unknown

When port is used as stand-alone, then switch-chip passes frames to CPU (via cpu-facing bridge port) as they are ... then CPU does VLAN header manipulations (via VLAN interfaces attached to such stand alone port). So in this case no L2HW offload.It's rather similar when bridge is used ... and L2HW offload works. CPU still does VLAN tag manipulations for traffic, passing between CPU and cpu-facing bridge port if the later is anything but access port with PVID set ...So in short: offloaded to switch chip is only what's configured under/interface/bridge(or on devices eligible anything configured under/interface/ethernet/switch).

---
### Post 4
Author: Unknown
Date: Unknown

1. As @mkx has already kindly explained, the switch chip is integrated into the operation of the software bridge as seamlessly as was possible, so the overall functionality does not depend on whether the switch chip is present or not and whether hardware forwarding is enabled on a particular port or not. If you want to know the fine details, most switch chips that Mikrotik uses support also proprietary tags that indicate the ingress port of frames they forward to the CPU and allow the CPU to specify which egress port to use for frames it sends. So if ether2 is not configured as a member port of any bridge, the frames the CPU wishes to send via ether2 are still forwarded by the switch chip, but bypassing its local forwarding decision it would otherwise make using its MAC address table. The same thing happens if ether2 is a member port of a bridge but hardware forwarding is disabled for it. The switch chip itself is only allowed to forward traffic among all the member ports of the same bridge on which hardware forwarding is active. But even in such case, all what I wrote in my original posting remains valid, because most of it deals with the communication between the "virtual switch" and "virtual router", i.e. not with the external ports.2. referencing thebridgein theuntaggedortaggedlist on a row in/interface bridge vlanonlycontrols the behavior on therouter-facing port of the switch.3. if you want frames belonging to VLAN 10 to make it tagged to the router, therouter-facing port of the switchmust be on thetaggedlist on the row whosevlan-idsincludes10. In the router, you attach an/interface vlanwithvlan-id=10to theswitch-facing interface of the routerto provide the routing stack with access to untagged frames that belong to VLAN 10.So assuming thatether1 and therouter-facing port of the switchare access ports to VLAN 1,ether5 is an access port to VLAN 10,therouter-facing port of the switchis a trunk port of VLAN 10,/interface vlan vlan-ids=10 name=bridge.vlan10is attached to theswitch-facing interface of the router,the following happens:an untagged frame that arrives to ether1 gets tagged with VID 1 as it enters the virtual switch and untagged again as it egresses towards the router via therouter-facing port of the switch;in the router, the untagged frame carrying an IP packet arrives to theswitch-facing interface of the routerso the IP stack can see it there.an untagged frame that arrives to ether5 gets tagged with VID 10 as it enters the virtual switch and stays tagged as it egresses towards the router via therouter-facing port of the switch;in the router, the IP stack ignores the frame on theswitch-facing interface of the routerbecause it is tagged, but the/interface vlanwithvlan-ids=10that is attached to theswitch-facing interface of the routertakes the frame, untags it, and offers the untagged one to the IP stack at its untagged end.4. as explained above, on your drawing, the/interface vlanis on a wrong place and with a wrong orientation. There is a plain "wire" between therouter-facing port of the switchand theswitch-facing interface of the router- all tagging and untagging takes place in the virtual router and in the virtual switch. As explained "even more above", if something, then a switch chip is a functional block inside the software bridge rather than the other way round, as the hardware switch provides just part of the overall functionality of the bridge.(5.) So if I issue my Router these commandCode:Select all/ipaddaddinterface=ether2 address=192.168.1.254/interfacevlanaddvlan-id=10interface=ether2Say I have a switch connected to my Router that sends tagged frames with vlan id 10, when my router receives the frames and sends the reply to the switch, does my router tags the frame it about to send to the switch with vlan id 10 or is it the switch's duty to tag the reply coming from my router?In this example, the/interface vlanis attached directly to ether2, which therefore must not be a member port of any bridge to avoid unexpected behavior. If the router replies from an IP address 192.168.1.254, which is attached to ether2 itself, it encapsulates the IP packet into an untagged frame that then leaves via ether2 to the external switch. But if e.g. an IP address 192.168.97.5 was attached to the/interface vlanwithvlan-id=10and the router was responding from that address, the/interface vlanwould get the IP packet encapsulated in a untagged frame from the IP stack and tag it with VID 10 prior to sending it out via ether2 to the external switch.

---
### Post 5
Author: Unknown
Date: Unknown

In the router, you attach an /interface vlan with vlan-id=10 to the switch-facing interface of the router to provide the routing stack with access to untagged frames that belong to VLAN 10.And to attach a vlan interface to theswitch-facing interface of the routeris to attach the vlan interface to the bridge right?Code:Select all/interfacevlanaddvlan-id=10name=vlan10interface=<bridge-name-here>an untagged frame that arrives to ether1 gets tagged with VID 1 as it enters the virtual switch and untagged again as it egresses towards the router via the router-facing port of the switchThis means that Ether1 and Ether5 has to be a part of a bridge in order to work with vlan?So assuming Ether1 is a part of a bridge, then when a frame enters Ether1 it gets tagged with vlan id 1, but therouter-facing port of the switchis a trunk port with vlan id 10, so why is it able to egress a frame that doesn't have vlan id 10?ether1 and the router-facing port of the switch are access ports to VLAN 1the router-facing port of the switch is a trunk port of VLAN 10Is it because you said that therouter-facing port of the switchis an access port with vlan id 1? So in this case is therouter-facing port of the switcha hybrid port?In this example, the /interface vlan is attached directly to ether2, which therefore must not be a member port of any bridge to avoid unexpected behavior. If the router replies from an IP address 192.168.1.254, which is attached to ether2 itself, it encapsulates the IP packet into an untagged frame that then leaves via ether2 to the external switch. But if e.g. an IP address 192.168.97.5 was attached to the /interface vlan with vlan-id=10 and the router was responding from that address, the /interface vlan would get the IP packet encapsulated in a untagged frame from the IP stack and tag it with VID 10 prior to sending it out via ether2 to the external switch.So if a ping packet is coming with a destination of 192.168.1.254, I think it will reach the destination and the reply will be sent without any vlan tagsIf another ping packet comes with a destination of 192.168.97.5 and encapsulated with vlan header with vlan tag of 10, I think it will also reach the destination and the reply will be sent with a vlan tag of id 10But if another ping packet comes with a destination of 192.168.1.254 but this time also encapsulated with vlan header with vlan tag of 10, would it still be able to reach the destination? If so, would the reply be sent with vlan tag 10?

---
### Post 6
Author: Unknown
Date: Unknown

@HeptaZ, did you read through excellentUsing RouterOS to VLAN your networktutorial?Because most of discussion in this thread is about VLANs and they are explained pretty well in the tutorial I linked above.

---
### Post 7
Author: Unknown
Date: Unknown

And to attach a vlan interface to theswitch-facing interface of the routeris to attach the vlan interface to the bridge right?Right.This means that Ether1 and Ether5 has to be a part of a bridge in order to work with vlan?To be able to work with VLAN - no, to conform to the example - yes. Any L2 interface can physically pass both tagged and untagged frames, the question is the internal configuration - whether an/interface vlanand/or IP configuration are attached to that L2 interface directly or whether the L2 interface is configured as a member port of a virtual switch and what are the VLAN settings relevant for that port in the bridge configuration (intentionally leaving bonding aside). But the rule is - no IP configuration and no VLAN interfaces can be directly attached to an L2 interface that is a member port of a bridge or of a bond.So assuming Ether1 is a part of a bridge, then when a frame enters Ether1 it gets tagged with vlan id 1, but therouter-facing port of the switchis a trunk port with vlan id 10, so why is it able to egress a frame that doesn't have vlan id 10?Different vendors name the port roles with regard to VLANs differently - some use the "hybrid port" name, some don't. So "access port for VLAN x" means to me that frames that belong to VLAN x are untagged on the wired side of such a port and tagged on the silicon side (i.e. they get tagged on ingress, wire->silicon, and untagged on egress, silicon->wire), whereas "trunk port for VLAN y" means that the frames that belong to VLAN y are tagged both at the wired side and at the silicon side (no tagging or untagging takes place). So indeed, in the example, therouter-facing port of the switchis hybrid (access for VLAN 1 and trunk for VLAN 10) - and, if you want to put it that way, so is theswitch-facing interface of the router.But if another ping packet comes with a destination of 192.168.1.254 but this time also encapsulated with vlan header with vlan tag of 10, would it still be able to reach the destination? If so, would the reply be sent with vlan tag 10?OK, so apparently I have oversimplified the previous answer. The router will respond a ping to any of its own addresses, no matter how it came in, provided that the IP stack could see it in an untagged form. So if a packet for 192.168.1.254 arrives encapsulated in a frame tagged with VID 10 through interface Xandthere is an/interface vlanwithvlan-id=10attached to interface Xandthere is some IP address attached to that/interface vlan, making it an IP interface of the router,andif the address 192.168.1.254 is attached toanyinterface of the router (intentionally omitting VRF), the router will receive the packet. However, unless you take quite a lot of configuration effort, which interface the router will use to send the response to that request packet has nothing to do with how exactly that request got in - the routing normally does not even know that the packet it is told to find a route for is a response to some other packet. So the response will take the route that has been statically or dynamically configured towards the source address of the request, because what the responding application has asked the routing to do was "send this packet to this address". If that route uses an IP address in the same subnet like the 192.168.1.254 as a gateway, the response will be sent from ether2 untagged; if that that route uses an IP address in the same subnet like the 192.168.97.5 as a gateway, the IP stack will use the/interface vlanto which 192.168.97.5 is attached to send the packet, so the frame carrying it will get tagged with VID 10 prior to being sent out via ether2.

---
### Post 8
Author: Unknown
Date: Unknown

@HeptaZ, did you read through excellentUsing RouterOS to VLAN your networktutorial?I did, but I just wanted to make sure that I didn't miss anything and in the documentation above, there isn't really much reasoning as to why you would issue certain commands.

---
### Post 9
Author: Unknown
Date: Unknown

@sindy Thank you for answering!

---
